head	1.20;
access;
symbols
	BuildSys-7_30:1.20
	BuildSys-7_29:1.20
	BuildSys-7_28:1.20
	BuildSys-7_27:1.20
	BuildSys-7_26:1.20
	BuildSys-7_25:1.20
	BuildSys-7_24:1.20
	BuildSys-7_23:1.19
	BuildSys-7_22:1.19
	BuildSys-7_21:1.19
	BuildSys-7_20:1.19
	BuildSys-7_19:1.19
	BuildSys-7_18:1.19
	BuildSys-7_17:1.19
	BuildSys-7_16:1.19
	BuildSys-7_15:1.19
	BuildSys-7_14:1.19
	BuildSys-7_13:1.19
	BuildSys-7_12:1.19
	BuildSys-7_11:1.19
	BuildSys-7_10:1.19
	BuildSys-7_09:1.19
	BuildSys-6_00-1_142_2_10:1.9.2.4
	BuildSys-7_08:1.19
	BuildSys-7_07:1.19
	BuildSys-7_06:1.19
	BuildSys-7_05:1.19
	BuildSys-6_00-1_142_2_9:1.9.2.4
	BuildSys-7_04:1.19
	BuildSys-7_03:1.19
	BuildSys-7_02:1.19
	BuildSys-7_01:1.19
	BuildSys-7_00:1.19
	BuildSys-6_99:1.19
	BuildSys-6_98:1.19
	BuildSys-6_97:1.19
	BuildSys-6_96:1.19
	BuildSys-6_95:1.19
	BuildSys-6_94:1.19
	BuildSys-6_93:1.19
	BuildSys-6_92:1.19
	BuildSys-6_91:1.19
	BuildSys-6_90:1.18
	BuildSys-6_89:1.18
	BuildSys-6_81-1:1.18
	BuildSys-6_88:1.18
	BuildSys-6_87:1.18
	BuildSys-6_86:1.18
	BuildSys-6_85:1.18
	BuildSys-6_84:1.18
	BuildSys-6_83:1.18
	BuildSys-6_82:1.18
	BuildSys-6_81:1.18
	BuildSys-6_80:1.18
	BuildSys-6_79:1.18
	BuildSys-6_78:1.18
	BuildSys-6_77:1.18
	BuildSys-6_76:1.18
	BuildSys-6_75:1.18
	BuildSys-6_74:1.18
	BuildSys-6_73:1.18
	BuildSys-6_72:1.18
	BuildSys-6_71:1.18
	BuildSys-6_70:1.18
	BuildSys-6_69:1.16
	BuildSys-6_68:1.16
	BuildSys-6_67:1.16
	BuildSys-6_66-1:1.16
	BuildSys-6_66:1.16
	BuildSys-6_65:1.16
	BuildSys-6_00-1_142_2_8:1.9.2.3
	BuildSys-6_00-1_142_2_7:1.9.2.3
	BuildSys-6_00-1_142_2_6:1.9.2.3
	BuildSys-6_64:1.16
	BuildSys-6_63:1.16
	BuildSys-6_62:1.16
	BuildSys-6_61:1.16
	BuildSys-6_60:1.16
	BuildSys-6_59:1.15
	BuildSys-6_58:1.15
	BuildSys-6_57:1.14
	BuildSys-6_56:1.13
	BuildSys-6_55:1.13
	BuildSys-6_54:1.13
	BuildSys-6_53:1.13
	BuildSys-6_00-1_142_2_5:1.9.2.2
	BuildSys-6_52:1.13
	BuildSys-6_51:1.13
	BuildSys-6_50:1.13
	BuildSys-6_49:1.11
	BuildSys-6_48:1.11
	BuildSys-6_47:1.10
	BuildSys-6_46:1.10
	BuildSys-6_45:1.10
	BuildSys-6_44:1.10
	BuildSys-6_43:1.10
	BuildSys-6_42:1.10
	BuildSys-6_41:1.10
	BuildSys-6_40:1.10
	BuildSys-6_39:1.10
	BuildSys-6_38:1.10
	BuildSys-6_00-1_142_2_4:1.9.2.1
	BuildSys-6_37:1.10
	BuildSys-6_36:1.10
	BuildSys-6_35:1.10
	BuildSys-6_34:1.10
	BuildSys-6_33:1.10
	BuildSys-6_32:1.10
	BuildSys-6_31:1.9
	BuildSys-6_30:1.9
	BuildSys-6_29:1.9
	BuildSys-6_28:1.9
	BuildSys-6_27:1.9
	BuildSys-6_26:1.9
	BuildSys-6_25:1.9
	BuildSys-6_24:1.9
	BuildSys-6_23:1.9
	BuildSys-6_22:1.9
	BuildSys-6_21:1.9
	BuildSys-6_20:1.9
	BuildSys-6_00-1_142_2_3:1.9
	BuildSys-6_19:1.9
	BuildSys-6_18:1.9
	BuildSys-6_17:1.9
	BuildSys-6_16:1.9
	BuildSys-6_15:1.9
	BuildSys-6_14:1.9
	BuildSys-6_13:1.9
	BuildSys-6_12:1.9
	BuildSys-6_00-1_142_2_2:1.9
	BuildSys-6_11:1.9
	BuildSys-6_10:1.9
	BuildSys-6_09:1.9
	BuildSys-6_08:1.9
	BuildSys-6_07:1.9
	BuildSys-6_06:1.9
	BuildSys-6_05:1.9
	BuildSys-6_04:1.9
	BuildSys-6_03:1.9
	BuildSys-6_02:1.9
	BuildSys-6_01:1.9
	BuildSys-6_00-1_142_2_1:1.9
	RPiFreeze:1.9.0.2
	BuildSys-6_00:1.9
	BuildSys-5_99:1.9
	BuildSys-5_98:1.9
	BuildSys-5_97:1.9
	BuildSys-5_96:1.9
	BuildSys-5_95:1.9
	BuildSys-5_94:1.9
	BuildSys-5_93:1.9
	BuildSys-5_92:1.9
	BuildSys-5_91:1.9
	BuildSys-5_90:1.9
	BuildSys-5_89:1.9
	BuildSys-5_88:1.9
	BuildSys-5_87:1.9
	BuildSys-5_86:1.8
	BuildSys-5_85:1.8
	BuildSys-5_84:1.8
	BuildSys-5_83:1.8
	BuildSys-5_82:1.8
	BuildSys-5_81:1.8
	BuildSys-5_80:1.8
	BuildSys-5_79:1.8
	BuildSys-5_78:1.8
	BuildSys-5_77:1.8
	BuildSys-5_76:1.8
	BuildSys-5_75:1.8
	BuildSys-5_74:1.8
	BuildSys-5_73:1.8
	BuildSys-5_72:1.8
	BuildSys-5_71:1.8
	BuildSys-5_70:1.8
	BuildSys-5_69:1.8
	BuildSys-5_68:1.8
	BuildSys-5_67:1.8
	BuildSys-5_66:1.8
	BuildSys-5_65:1.8
	BuildSys-5_64:1.8
	BuildSys-5_63:1.8
	BuildSys-5_62:1.8
	BuildSys-5_61:1.8
	BuildSys-5_60:1.8
	BuildSys-5_59:1.8
	BuildSys-5_58:1.8
	BuildSys-5_57:1.8
	BuildSys-5_56:1.8
	BuildSys-5_55:1.8
	BuildSys-5_54:1.8
	BuildSys-5_53:1.8
	BuildSys-5_52:1.8
	BuildSys-5_51:1.8
	BuildSys-5_50:1.8
	BuildSys-5_49:1.8
	BuildSys-5_48:1.8
	BuildSys-5_47:1.8
	BuildSys-5_46:1.8
	BuildSys-5_45:1.8
	BuildSys-5_44:1.8
	BuildSys-5_43:1.8
	BuildSys-5_42:1.8
	BuildSys-5_41:1.7
	BuildSys-5_40:1.7
	BuildSys-5_39:1.7
	BuildSys-5_38:1.6
	BuildSys-5_37:1.6
	BuildSys-5_36:1.6
	BuildSys-5_35:1.6
	BuildSys-5_34:1.6
	BuildSys-5_33:1.6
	BuildSys-5_32:1.6
	BuildSys-5_31:1.6
	BuildSys-5_30:1.6
	BuildSys-5_29:1.6
	BuildSys-5_28:1.6
	BuildSys-5_27:1.6
	BuildSys-5_26:1.6
	BuildSys-5_25:1.6
	BuildSys-5_24:1.6
	BuildSys-5_23:1.6
	BuildSys-5_22:1.6
	BuildSys-5_21:1.6
	BuildSys-5_20:1.6
	BuildSys-5_19:1.6
	BuildSys-5_18:1.6
	BuildSys-5_17:1.6
	BuildSys-5_16:1.6
	BuildSys-5_15:1.6
	BuildSys-5_14:1.6
	BuildSys-5_13:1.6
	BuildSys-5_12:1.5
	BuildSys-5_11:1.4
	BuildSys-5_10:1.4
	BuildSys-5_09:1.4
	BuildSys-5_08:1.4
	BuildSys-5_07:1.4
	BuildSys-5_06:1.4
	BuildSys-5_05:1.4
	BuildSys-5_04:1.4
	BuildSys-5_03:1.4
	BuildSys-5_02:1.4
	BuildSys-5_01:1.4
	BuildSys-5_00:1.4
	BuildSys-4_99:1.4
	BuildSys-4_98:1.4
	BuildSys-4_97:1.4
	BuildSys-4_96:1.4
	BuildSys-4_95:1.4
	BuildSys-4_94:1.4
	BuildSys-4_93:1.4
	BuildSys-4_92:1.4
	BuildSys-4_91:1.4
	BuildSys-4_90:1.4
	BuildSys-4_89:1.4
	BuildSys-4_88:1.4
	BuildSys-4_87:1.4
	BuildSys-4_86:1.4
	BuildSys-4_85:1.4
	BuildSys-4_84:1.4
	BuildSys-4_83:1.4
	BuildSys-4_82:1.4
	BuildSys-4_81:1.4
	BuildSys-4_80:1.4
	BuildSys-4_79:1.3
	BuildSys-4_78:1.3
	BuildSys-4_77:1.3
	BuildSys-4_76:1.2
	BuildSys-4_75:1.2
	BuildSys-4_74:1.2
	BuildSys-4_73:1.2
	BuildSys-4_72:1.2
	BuildSys-4_71:1.2
	BuildSys-4_70:1.2
	BuildSys-4_69:1.2
	BuildSys-4_68:1.2
	BuildSys-4_67:1.1
	BuildSys-4_66:1.1
	BuildSys-4_65:1.1
	BuildSys-4_64:1.1
	BuildSys-4_63:1.1
	BuildSys-4_62:1.1
	Batch4:1.1;
locks; strict;
comment	@# @;


1.20
date	2018.04.11.23.21.12;	author bavison;	state Exp;
branches;
next	1.19;
commitid	IH1EokSuAjoQZ4yA;

1.19
date	2016.05.29.13.34.41;	author rsprowson;	state Exp;
branches;
next	1.18;
commitid	0r01XPH2sBMOFn8z;

1.18
date	2015.08.02.08.28.13;	author rsprowson;	state Exp;
branches;
next	1.17;
commitid	bkfyCeusU4CwEFvy;

1.17
date	2015.08.01.09.21.15;	author rsprowson;	state Exp;
branches;
next	1.16;
commitid	kivVtyaG05k2Yxvy;

1.16
date	2014.10.24.12.36.49;	author rsprowson;	state Exp;
branches;
next	1.15;
commitid	FCeT0nrCnPiO5sVx;

1.15
date	2014.10.19.13.50.08;	author srevill;	state Exp;
branches;
next	1.14;
commitid	jLja0Ffp373VEOUx;

1.14
date	2014.10.18.13.42.25;	author srevill;	state Exp;
branches;
next	1.13;
commitid	gJhpwGaEuU5hEGUx;

1.13
date	2014.09.27.09.51.17;	author rsprowson;	state Exp;
branches;
next	1.12;
commitid	uwRe5gX3cYxE1YRx;

1.12
date	2014.09.24.20.24.13;	author rsprowson;	state Exp;
branches;
next	1.11;
commitid	DA9s1M3numtWDDRx;

1.11
date	2014.09.18.08.04.44;	author rsprowson;	state Exp;
branches;
next	1.10;
commitid	fHAY8yIhojRdKNQx;

1.10
date	2013.11.11.00.50.38;	author bavison;	state Exp;
branches;
next	1.9;
commitid	Tr3fHk0Gie15lNcx;

1.9
date	2012.09.01.11.03.04;	author jlee;	state Exp;
branches
	1.9.2.1;
next	1.8;
commitid	fZ0T28vScda6KOiw;

1.8
date	2012.02.05.09.13.26;	author rsprowson;	state Exp;
branches;
next	1.7;
commitid	XCR9w41JK8TYQWRv;

1.7
date	2012.02.04.21.14.17;	author rsprowson;	state Exp;
branches;
next	1.6;
commitid	oVq2mnfkWDwhSSRv;

1.6
date	2011.04.03.16.42.52;	author bavison;	state Exp;
branches;
next	1.5;
commitid	9brrKnYOmLyYepev;

1.5
date	2011.03.31.00.04.06;	author bavison;	state Exp;
branches;
next	1.4;
commitid	BfewXnm4kl3lOVdv;

1.4
date	2009.07.17.00.31.31;	author jlee;	state Exp;
branches;
next	1.3;

1.3
date	2009.06.26.14.03.06;	author bavison;	state Exp;
branches;
next	1.2;

1.2
date	2009.01.27.19.28.32;	author bavison;	state Exp;
branches;
next	1.1;

1.1
date	2008.10.14.21.29.37;	author bavison;	state Exp;
branches;
next	;

1.9.2.1
date	2014.02.20.21.02.48;	author rsprowson;	state Exp;
branches;
next	1.9.2.2;
commitid	HvOFwLQ3c6PzNSpx;

1.9.2.2
date	2014.10.12.10.36.30;	author rsprowson;	state Exp;
branches;
next	1.9.2.3;
commitid	tHT6hsrmkNpoOTTx;

1.9.2.3
date	2015.02.12.20.30.56;	author rsprowson;	state Exp;
branches;
next	1.9.2.4;
commitid	joerV7rvwrTd9L9y;

1.9.2.4
date	2017.02.21.08.36.59;	author rsprowson;	state Exp;
branches;
next	;
commitid	yeUPZ9XHdm2zpNGz;


desc
@@


1.20
log
@  Incremental step in cross-compilation support
Detail:
  ModuleDB:
  * Correct capitalisation of resgen's TARGET to match its main source file
  GNUmakefiles/AAsmModule:
  * Targets now given ,ffa filetype suffix
  * Support source directory layouts s/<subdir>/<leaf> as used by the
    kernel and printer drivers - define SYMLINK_EXT_FIRST to enable
  * Prevent relinking when running make on an up-to-date component due to
    a difference between amu and GNU make's handling of double-colon rules
  * Support linking with GNU toolchain
  * Fix installation rule (mixup between MERGEDMDIR and MERGEDRDIR)
  * Support up to 16 assembler and 8 C-from-assembler headers, up from 3
    of each (here's looking at you, kernel) - long-term, it might be worth
    changing this to a scheme like that used by CModule to remove any
    limits
  * Fix C-from-assembler exports to have .h suffix
  GNUmakefiles/AppLibs:
  * Define INCLUDE_OSLIB to permit OSLib header search paths to be
    specified in an OS-agnostic way
  GNUmakefiles/CApp:
  * Prevent relinking when running make on an up-to-date component due to
    a difference between amu and GNU make's handling of double-colon rules
  GNUmakefiles/CLibrary:
  * Prevent rearchiving when running make on an up-to-date component due
    to a difference between amu and GNU make's handling of double-colon
    rules
  * Don't use .hdr suffix on exported assembler header files
  * Correct order of dependencies for export_libs phony target
  GNUmakefiles/StdTools:
  * Definition for the module filetype suffix
  * Add LDBIN tool for GNU/Norcroft-agnostic binary link, useful for
    linking position-independent binary code, such as relocatable modules
    (i.e. ones that don't require the linker to create a __RelocCode
    function)
  * FAPPEND function now works if the same file is used for the
    destination as for one of the sources (this is used by CModule)
  GNUmakefiles/CModule, ModStdRule, ModuleLibs:
  * Finally created cross-compilation versions of the last major shared
    makefiles! Warning: these have received limited testing to date.
  Makefiles/AAsmModule:
  * Support up to 16 assembler and 8 C-from-assembler headers
  Makefiles/AppLibs, ModuleLibs:
  * Define INCLUDE_OSLIB
  Makefiles/StdTools:
  * Add LDBIN tool


Version 7.24. Tagged as 'BuildSys-7_24'
@
text
@# Copyright 2008 Castle Technology Ltd
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# Makefile fragment for C and C++ modules

INCLUDED_CMODULE = YES

#
# $Id: CModule,v 1.19 2016/05/29 13:34:41 rsprowson Exp $
#
# This makefile provides the following phony targets:
#
#    all 
#    export  export_hdrs  export_libs
#    resources
#    rom  rom_link
#    standalone  install
#    debug  gpa_debug
#    prepro
#    clean
#
#
# This fragment uses the following macros set by the master makefile.
#
#
# COMPONENT          (the name of the component)
# TARGET       (opt) (the leafname of the module - otherwise ${COMPONENT})
# ROM_TARGET   (opt) (partially linked module leafname - otherwise ${TARGET} in aof)
# LNK_TARGET   (opt) (fixed-position module leafname - otherwise ${TARGET} in linked)
# SA_TARGET    (opt) (standalone module leafname - otherwise ${TARGET} in rm)
# DBG_TARGET   (opt) (debug module leafname - otherwise ${TARGET}D in rm)
# AIF_TARGET   (opt) (GPA-intermediate leafname - otherwise ${TARGET} in aif)
# GPA_TARGET   (opt) (GPA debug leafname - otherwise ${TARGET} in gpa)
# INSTDIR      (opt) (the target directory - otherwise <Install$Dir>)
# C_EXP_HDR    (opt) (C header target directory - otherwise <cexport$dir>.Interface.h)
# EXP_HDR      (opt) (assembly header target directory - otherwise <export$dir>
# DIRS         (opt) (stamp object for directory creation - otherwise o._dirs)
# HDRS         (opt) (C header files to export, no h. prefix - otherwise ${TARGET})
# ASMHDRS      (opt) (assembly header files to export, no Hdr. prefix - otherwise none)
# ASMCHDRS     (opt) (C-from-assembly auto-generated header files to export, no Hdr. prefix - otherwise none)
# INSTRES_FILES   (opt) (extra resource files in addition to Messages - use InstRes specification rules)
# INSTRAM_FILES   (opt) (RAM build specific resources - otherwise ${INSTRES_FILES})
# INSTROM_FILES   (opt) (ROM build specific resources - otherwise ${INSTRES_FILES})
# INSTR??_DEPENDS (opt) (any extra dependency to assert on INSTRES/INSTRAM/INSTROM_FILES)
# MERGEDRDIR      (r/o) (directory for generating exported resources, for information only)
# MERGEDMSGS      (r/o) (leafname of generated Messages file, for compatibility with AAsmModule)
# RESFSDIR        (opt) (actual directory to export resources to - otherwise ${RESDIR}.${TARGET})
# RES_AREA        (opt) (area name to use for embedded messages in standalone build - otherwise Resources)
# RES_OBJ         (opt) (object file for embedded messages in standalone build, no o.prefix - otherwise ${TARGET}Msgs)
# RES_PATH        (opt) (path relative to ResourceFS root to be suffixed by ${TARGET} - otherwise Resources)
# CMHGFILE     (opt) (name of CMHG source file, no cmhg. prefix - otherwise ${TARGET}Hdr)
# CMHGAUTOHDR  (opt) (header file, if any, from HDRS or ASMCHDRS, to which to append the SWI defines from CMHG)
# CMHGFILE_SWIPREFIX (opt) (name of SWI prefix used in CMHG file - otherwise ${TARGET})
# OBJS         (opt) (object files, no o. prefixes - otherwise ${TARGET} ${CMHGFILE})
# ROM_OBJS     (opt) (ROM build objects - otherwise ${OBJS})
# SA_OBJS      (opt) (standalone build objects - otherwise ${OBJS})
# DBG_OBJS     (opt) (debug build object files, no prefixes - otherwise ${OBJS})
# LIBS         (opt) (extra libraries; ${CLIB} is always used)
# ROM_LIBS     (opt) (libraries to link for ROM targets - otherwise ${LIBS})
# SA_LIBS      (opt) (libraries to link for standalone targets - otherwise ${LIBS})
# DBG_LIBS     (opt) (extra debug libraries in addition to SA_LIBS and DEBUGLIBS)
# ROM_DEPEND   (opt) (any extra dependency to assert on ROM_TARGET)
# SA_DEPEND    (opt) (any extra dependency to assert on SA_TARGET and DBG_TARGET)
# CUSTOMEXP    (opt) (set to "custom" to override the export rules)
# CUSTOMRES    (opt) (set to "custom" to override the resources rules, or "no" for no resources)
# CUSTOMROM    (opt) (set to "custom" to override the rom rules)
# CUSTOMSA     (opt) (set to "custom" to override the standalone rules)
# CUSTOMDBG    (opt) (set to "custom" to override the debug rules)
# CUSTOMGPA    (opt) (set to "custom" to override the GPA rules)
# RAMCDEFINES  (opt) (additions to CDEFINES for RAM builds - requires ModStdRule to be included later)
# ROMCDEFINES  (opt) (additions to CDEFINES for ROM builds - requires ModStdRule to be included later)
# RAMASMDEFINES (opt) (additions to ASMDEFINES for RAM builds - requires ModStdRule to be included later)
# ROMASMDEFINES (opt) (additions to ASMDEFINES for ROM builds - requires ModStdRule to be included later)
# CMHGDEPENDS  (opt) (source files which need to include the .h file autogenerated from the CMHG file)
#
#
# It relies on the following from the build system:
#
#
# PHASE            (export phase discriminator)
# CMDHELP          (whether star command help/syntax strings are included)
# RESDIR           (installation directory for resources - cf. RESFSDIR)
# FORCEROMLINK     (set to force a relink of the ROM target, used in BBE)
# LINKDIR          (installation directory for LNK_TARGET)
# ADDRESS          (base address for LNK_TARGET)
# INSERTVERSION    (awk script to substitute from VersionNum)
#
#
# It relies on the following generic tool macros from the StdTools makefile
#
#
# C + CFLAGS       (C compiler; CDFLAGS also used in debug builds; -g implicit)
# CP + CPFLAGS     (copy, cp etc.)
# WIPE + WFLAGS    (recursive delete)
# RM               (non-recursive delete)
# AS + ASFLAGS     (assembler)
# LD + LDFLAGS     (linker; LDDFLAGS also used in debug builds; -d implicit)
# LDRAMFLAGS       (more linker flags)
# LDROMFLAGS       (more linker flags)
# LDLINKFLAGS      (flags for the rom_link phase)
# MODSQZ + MODSQZFLAGS (module binary compressor)
# CHMOD
# MKDIR            (cdir/mkdir -p)
# ECHO
# TOUCH            (create/touch)
# TOKENCHECK
# RESGEN
# TOGPA
#
#
# It relies on the following from the StdRules makefile
#
#
# .c.o  .c++.o  .cpp.o  .s.o
#
#
# It relies on the following from the ModStdRule makefile
#
#
# .cmhg.h  .cmhg.o
#
#
# It relies on the following from the DbgRules makefile
#
#
# CDFLAGS  C++DFLAGS  ASDFLAGS  LDDFLAGS
# .c.od  .c++.od  .cpp.od  .s.od
#
#

INSTALLDIR    = <Install$Dir>
EXPDIR        = <export$dir>
CEXPDIR       = <cexport$dir>

TARGET       ?= ${COMPONENT}
ROM_TARGET   ?= ${TARGET}
LNK_TARGET   ?= ${TARGET}
SA_TARGET    ?= ${TARGET}
DBG_TARGET   ?= ${TARGET}D
AIF_TARGET   ?= ${TARGET}
GPA_TARGET   ?= ${TARGET}
INSTDIR      ?= ${INSTALLDIR}
C_EXP_HDR    ?= ${CEXPDIR}.Interface.h
EXP_HDR      ?= ${EXPDIR}
DIRS         ?= o._dirs
HDRS         ?= ${TARGET}
ASMHDRS      ?= 
ASMCHDRS     ?= 
INSTRAM_FILES   ?= ${INSTRES_FILES}
INSTRAM_DEPENDS ?= ${INSTRES_DEPENDS}
INSTROM_FILES   ?= ${INSTRES_FILES}
INSTROM_DEPENDS ?= ${INSTRES_DEPENDS}
MERGEDRDIR   ?= o._ResData_
MERGEDMSGS   ?= ${MERGEDRDIR}.${TARGET}.Messages
RES_AREA     ?= Resources
RES_OBJ      ?= ${TARGET}Msgs
RES_PATH     ?= Resources
RESFSDIR     ?= ${RESDIR}.${TARGET}
CMHGFILE     ?= ${TARGET}Hdr
CMHGFILE_SWIPREFIX ?= ${TARGET}
OBJS         ?= ${TARGET}
ROM_OBJS     ?= ${OBJS}
SA_OBJS      ?= ${OBJS}
DBG_OBJS     ?= ${OBJS}
ROM_OBJS     += ${CMHGFILE}
SA_OBJS      += ${CMHGFILE}
DBG_OBJS     += ${CMHGFILE}
ifeq ($(filter no custom,${CUSTOMRES}),)
RESDIR       ?= ${MERGEDRDIR}  # Place to internally collect up contents of RES_OBJ
SA_OBJS      += ${RES_OBJ}
DBG_OBJS     += ${RES_OBJ}
endif
ROM_LIBS     ?= ${LIBS}
SA_LIBS      ?= ${LIBS}
ROM_LIBS     += ${ROMCSTUBS}
ROM_SYMS      = ${C_ABSSYM}
SA_LIBS      += ${CLIB}
DBG_LIBS     += ${DEBUGLIBS}

ROM_OBJS_     = $(addprefix o.,${ROM_OBJS})
SA_OBJS_      = $(addprefix o.,${SA_OBJS})
DBG_OBJS_     = $(addprefix od.,${DBG_OBJS})
PP_OBJS_      = $(addprefix i.,$(filter-out ${CMHGFILE} ${RES_OBJ},${DBG_OBJS}))
EXPORTING_HDRS     = $(addprefix exphdr.,${HDRS})
EXPORTING_ASMHDRS  = $(addprefix expasm.,${ASMHDRS})
EXPORTING_ASMCHDRS = $(addprefix expasmc.,${ASMCHDRS})

ifeq ($(filter rom%,${MAKECMDGOALS}),)
CDEFINES     += ${RAMCDEFINES}
ASMDEFINES   += ${RAMASMDEFINES}
RES_FILES_    = ${INSTRAM_FILES}
RES_DEPENDS_  = ${INSTRAM_DEPENDS}
else
CDEFINES     += ${ROMCDEFINES}
ASMDEFINES   += ${ROMASMDEFINES}
RES_FILES_    = ${INSTROM_FILES}
RES_DEPENDS_  = ${INSTROM_DEPENDS}
endif

ifneq ($(filter debug%,${MAKECMDGOALS}),)
CMHGFLAGS    += ${CMHGDFLAGS}  # Affects both object and header generation 
endif

ifeq ("${INCLUDED_STDTOOLS}","")
include StdTools
endif
ifeq ("${INCLUDED_MODULELIBS}","")
include ModuleLibs
endif

CFLAGS       := -zM -zps1 ${CFLAGS}

ifeq ("${INCLUDED_MODSTDRULE}","")
include ModStdRule
endif
ifeq ("${INCLUDED_DBGRULES}","")
include DbgRules
endif

#
# General rules
#
all: aof.${ROM_TARGET} rm.${SA_TARGET} rm.${DBG_TARGET}
        @@${ECHO} ${COMPONENT}: all built

${DIRS} ::
        ${MKDIR} aif
        ${MKDIR} aof
        ${MKDIR} i
        ${MKDIR} linked
        ${MKDIR} gpa
        ${MKDIR} o
        ${MKDIR} od
        ${MKDIR} rm
        ${TOUCH} $@@

#
# Clean the module
#
clean ::
        @@IfThere aif    Then ${ECHO} ${WIPE} aif ${WFLAGS}
        @@IfThere aif    Then ${WIPE} aif ${WFLAGS}
        @@IfThere aof    Then ${ECHO} ${WIPE} aof ${WFLAGS}
        @@IfThere aof    Then ${WIPE} aof ${WFLAGS}
        @@IfThere i      Then ${ECHO} ${WIPE} i ${WFLAGS}
        @@IfThere i      Then ${WIPE} i ${WFLAGS}
        @@IfThere linked Then ${ECHO} ${WIPE} linked ${WFLAGS}
        @@IfThere linked Then ${WIPE} linked ${WFLAGS}
        @@IfThere gpa    Then ${ECHO} ${WIPE} gpa ${WFLAGS}
        @@IfThere gpa    Then ${WIPE} gpa ${WFLAGS}
        @@IfThere o      Then ${ECHO} ${WIPE} o ${WFLAGS}
        @@IfThere o      Then ${WIPE} o ${WFLAGS}
        @@IfThere od     Then ${ECHO} ${WIPE} od ${WFLAGS}
        @@IfThere od     Then ${WIPE} od ${WFLAGS}
        @@IfThere rm     Then ${ECHO} ${WIPE} rm ${WFLAGS}
        @@IfThere rm     Then ${WIPE} rm ${WFLAGS}
        @@IfThere h.${CMHGFILE} Then ${ECHO} ${RM} h.${CMHGFILE}
        @@IfThere h.${CMHGFILE} Then ${RM} h.${CMHGFILE}
        @@${ECHO} ${COMPONENT}: cleaned

#
# Export phases
#
export${CUSTOMEXP}: export_${PHASE}
        @@${NOP}

export_: export_libs export_hdrs
        @@${NOP}

create_exp_hdr_dirs:
        ${MKDIR} ${C_EXP_HDR}
        ${MKDIR} ${EXP_HDR}

ifneq (${CMHGFILE},)
o._h_${CMHGAUTOHDR}: h.${CMHGFILE} ${DIRS}
        ${DO} ${AWK} -- "/.ifndef ${CMHGFILE_SWIPREFIX}/,/endif/" h.${CMHGFILE} > o._h_${CMHGAUTOHDR}
endif

ifneq ($(findstring ${CMHGAUTOHDR},${HDRS}),)
exphdr.${CMHGAUTOHDR}: h.${CMHGAUTOHDR} o._h_${CMHGAUTOHDR}
        ${FAPPEND} ${C_EXP_HDR}.${CMHGAUTOHDR} h.${CMHGAUTOHDR} o._h_${CMHGAUTOHDR}
endif

ifneq ($(findstring ${CMHGAUTOHDR},${ASMCHDRS}),)
expasmc.${CMHGAUTOHDR}: hdr.${CMHGAUTOHDR} o._h_${CMHGAUTOHDR}
        ${HDR2H} hdr.${CMHGAUTOHDR} ${C_EXP_HDR}.${CMHGAUTOHDR}
        ${FAPPEND} ${C_EXP_HDR}.${CMHGAUTOHDR} ${C_EXP_HDR}.${CMHGAUTOHDR} o._h_${CMHGAUTOHDR}
endif

ifneq (${CMHGDEPENDS},)
CMHGDEPENDS_ = $(addprefix o.,${CMHGDEPENDS}) $(addprefix od.,${CMHGDEPENDS}) $(addprefix i.,${CMHGDEPENDS})
${CMHGDEPENDS_}: h.${CMHGFILE}
endif

.SUFFIXES: .exphdr .expasm .expasmc .h .hdr
.h.exphdr:;    @@${ECHO} ${CP} $< ${C_EXP_HDR}.$(subst h.,,$<) ${CPFLAGS} ; ${CP} $< ${C_EXP_HDR}.$(subst h.,,$<) ${CPFLAGS} 
.hdr.expasm:;  @@${ECHO} ${CP} $< ${EXP_HDR}.$(subst hdr.,,$<) ${CPFLAGS} ; ${CP} $< ${EXP_HDR}.$(subst hdr.,,$<) ${CPFLAGS} 
.hdr.expasmc:; @@${ECHO} ${HDR2H} $< ${C_EXP_HDR}.$(subst hdr.,,$<)       ; ${HDR2H} $< ${C_EXP_HDR}.$(subst hdr.,,$<)

export_hdrs${CUSTOMEXP}: ${EXPORTING_ASMCHDRS} ${EXPORTING_ASMHDRS} ${EXPORTING_HDRS} ${DIRS} create_exp_hdr_dirs
        @@${ECHO} ${COMPONENT}: header export complete

export_libs${CUSTOMEXP}:
        @@${ECHO} ${COMPONENT}: no exported libraries

#
# Resources rules
#
resources${CUSTOMRES}:: resources-${CMDHELP}
        @@${ECHO} ${COMPONENT}: resources copied to Messages module

ifeq (${CUSTOMRES},no)
resources:
        @@${ECHO} ${COMPONENT}: no resources to export
endif        

resources_extra: ${RES_DEPENDS_}
ifneq (${RES_FILES_},)
        ${INSTRES} -I Resources.${USERIF}.${LOCALE},Resources.${USERIF}.UK,Resources.${LOCALE},Resources.UK,Resources ${RESFSDIR} ${RES_FILES_}
endif
ifneq (,$(filter Messages,${INSTRES_VERSION}))
        ${INSERTVERSION} ${RESFSDIR}.Messages > ${RESFSDIR}._Awk_
        ${CP} ${RESFSDIR}._Awk_ ${RESFSDIR}.Messages ${CPFLAGS}
        ${RM} ${RESFSDIR}._Awk_
endif
        @@${NOP}

resources_common:
        ${MKDIR} ${RESFSDIR}
        ${TOKENCHECK} LocalRes:Messages
        ${CP} LocalRes:Messages ${RESFSDIR}.Messages ${CPFLAGS}

resources_cmdhelp:
        IfThere LocalRes:CmdHelp Then ${TOKENCHECK} LocalRes:CmdHelp
        IfThere LocalRes:CmdHelp Then ${FAPPEND} ${RESFSDIR}.Messages LocalRes:Messages LocalRes:CmdHelp

resources-None: resources_extra resources_common 
        @@${NOP}

resources-: resources_extra resources_cmdhelp resources_common
        @@${NOP}

o.${RES_OBJ}: resources-${CMDHELP} ${DIRS}
        ${INSTVIARG} ${MERGEDRDIR} ${RES_PATH} o._ResGen_
        ${RESGEN} ${RES_AREA} $@@ -via o._ResGen_

od.${RES_OBJ}: o.${RES_OBJ}
        ${CP} o.${RES_OBJ} $@@ ${CPFLAGS}

#
# ROM build rules
#
rom${CUSTOMROM}: aof.${ROM_TARGET}
        @@${ECHO} ${COMPONENT}: rom module built

rom_link${CUSTOMROM}: linked.${LNK_TARGET}
        ${CP} linked.${LNK_TARGET} ${LINKDIR}.${TARGET} ${CPFLAGS}
        ${CP} linked.${LNK_TARGET}_sym ${LINKDIR}.${TARGET}_sym ${CPFLAGS}
        @@${ECHO} ${COMPONENT}: rom_link complete

aof.${ROM_TARGET}: ${ROM_OBJS_} ${ROM_LIBS} ${DIRS} ${ROM_DEPEND}
        ${LD} -o $@@ -aof ${ROM_OBJS_} ${ROM_LIBS}

linked.${LNK_TARGET}: aof.${ROM_TARGET} ${ROM_SYMS} ${FORCEROMLINK}
        ${LD} ${LDFLAGS} ${LDLINKFLAGS} -o $@@ -rmf -base ${ADDRESS} aof.${ROM_TARGET} ${ROM_SYMS} -Symbols linked.${LNK_TARGET}_sym

#
# Standalone rules
#
install${CUSTOMSA}: rm.${SA_TARGET}
        ${MKDIR} ${INSTDIR}
        ${CP} rm.${SA_TARGET} ${INSTDIR}.${TARGET} ${CPFLAGS}
        @@${ECHO} ${COMPONENT}: ram module installed

standalone${CUSTOMSA}: rm.${SA_TARGET}
        @@${ECHO} ${COMPONENT}: ram module built

debug${CUSTOMDBG}: rm.${DBG_TARGET}
        @@${ECHO} ${COMPONENT}: debug module built

gpa_debug${CUSTOMGPA}: gpa.${GPA_TARGET}
        @@${ECHO} ${COMPONENT}: GPA debug built

prepro: ${PP_OBJS_} ${DIRS}
        @@${ECHO} ${COMPONENT}: sources preprocessed

rm.${SA_TARGET}: ${SA_OBJS_} ${SA_LIBS} ${DIRS} ${SA_DEPEND}
        ${LD} ${LDFLAGS} ${LDRAMFLAGS} -o $@@ -rmf ${SA_OBJS_} ${SA_LIBS}
        ${MODSQZ} ${MODSQZFLAGS} $@@
        ${CHMOD} -R a+rx rm

rm.${DBG_TARGET}: ${DBG_OBJS_} ${DBG_LIBS} ${SA_LIBS} ${DIRS} ${SA_DEPEND}
        ${LD} ${LDFLAGS} ${LDRAMFLAGS} -o $@@ -rmf ${DBG_OBJS_} ${DBG_LIBS} ${SA_LIBS}
        ${CHMOD} -R a+rx rm

gpa.${GPA_TARGET}: aif.${AIF_TARGET}
        ${TOGPA} -s aif.${AIF_TARGET} $@@

aif.${AIF_TARGET}: rm.${DBG_TARGET}
        ${LD} -aif -bin -d -o aif.${AIF_TARGET} ${DBG_OBJS_} ${DBG_LIBS} ${SA_LIBS}

# EOF
@


1.19
log
@Use the same optional resources syntax for AAsmModule as for CModule
Copy over the rules that use platform agnostic InstRes to copy their extra resources (for those modules wanting more than just the default Messages+CmdHelp).
Copy over the logic that allows INSERTVERSION to be run on Messages files (from CApp shared makefile) so modules which have a front end can get their dates from Messages.
Add INSERTVERSION facility to CModule too.

Version 6.91. Tagged as 'BuildSys-6_91'
@
text
@d20 1
a20 1
# $Id: CModule,v 1.18 2015/08/02 08:28:13 rsprowson Exp $
d25 1
a25 1
#    export  export-hdrs  export-libs
d103 1
a103 1
# C + CFLAGS       (C compiler; CDFLAGS also used in debug builds; -g implicit)
@


1.18
log
@Extend resources phase to handle more than just Messages
Using the InstViaRG script CModule will now collate a list of files (using the syntax for the InstRes script employed by the CApp shared makefile) for resources, rather than the previous Messages file only.
The list is specified in INSTRES_FILES, or if for some reason the standalone and ROM versions need to be different INSTRAM_FILES and INSTROM_FILES (cf. INSTAPP_FILES in CApp).
Shock new documentation for CModule added.

Version 6.70. Tagged as 'BuildSys-6_70'
@
text
@d20 1
a20 1
# $Id: CModule,v 1.17 2015/08/01 09:21:15 rsprowson Exp $
d97 1
d332 5
@


1.17
log
@Make CModule more closely follow AAsmModule when no resources are needed
Previously there was a quirky requirement to set RES_OBJ to an empty string to get this to work, now, we only require CUSTOMRES=no like AAsmModule does.
Not tagged, part of a 2 part update.
@
text
@d20 1
a20 1
# $Id: CModule,v 1.16 2014/10/24 12:36:49 rsprowson Exp $
d26 1
a26 1
#    resources  resources_common  resources-None
d52 10
a61 5
# MERGEDMDIR   (opt) (directory for generating exported message file - otherwise o._Messages_)
# MERGEDMSGS   (opt) (leafname of generated messages file - otherwise ${MERGEDMDIR}.${TARGET})
# RES_AREA     (opt) (area name to use for embedded messages in standalone build - otherwise Resources)
# RES_OBJ      (opt) (object file for embedded messages in standalone build, no o.prefix - otherwise ${TARGET}Msgs)
# RES_PATH     (opt) (path in ResourceFS to messages file - otherise Resources.${TARGET}.Messages)
a64 1
# RESFSDIR     (opt) (actual directory to export resources to)
d159 6
a164 2
MERGEDMDIR   ?= o._Messages_
MERGEDMSGS   ?= ${MERGEDMDIR}.${TARGET}
d167 1
a167 1
RES_PATH     ?= Resources.${TARGET}.Messages
d178 2
a179 1
ifneq (${CUSTOMRES},no)
d201 2
d206 2
d319 1
a319 1
resources${CUSTOMRES}:: ${RESOURCEEXTRA} resources-${CMDHELP}
d327 6
d338 1
a338 4
resources-None: resources_common
        @@${NOP}

resources-: resources_common
d342 2
a343 5
resources_res::
        ${CP} LocalRes:Res ${RESFSDIR}.Res ${CPFLAGS}
        
resources_sprites::
        ${INSTRES} -I LocalUserIFRes:,LocalRes:,Resources ${RESFSDIR} Sprites [Sprites11] [Sprites22]
d345 2
a346 8
resources_templates::
        ${CP} LocalRes:Templates ${RESFSDIR}.Templates ${CPFLAGS}

${MERGEDMSGS}: LocalRes:Messages
        ${MKDIR} ${MERGEDMDIR}
        ${TOKENCHECK} LocalRes:Messages
        IfThere LocalRes:CmdHelp Then ${TOKENCHECK} LocalRes:CmdHelp
        IfThere LocalRes:CmdHelp Then ${FAPPEND} $@@ LocalRes:Messages LocalRes:CmdHelp Else ${CP} LocalRes:Messages $@@ ${CPFLAGS}
d348 3
a350 2
o.${RES_OBJ}: ${MERGEDMSGS} ${DIRS}
        ${RESGEN} ${RES_AREA} $@@ ${MERGEDMSGS} ${RES_PATH}
@


1.16
log
@Do 'rom_link' against the same thing you do 'rom' with
During the rom phase, ROM C modules would be linked against ${ROMCSTUBS}, ie. clib.
During the rom_link phase, they'd be linked against ${ABSSYM}, ie. clib and rlib.
As RISC_OSLib contains various wimp_ symbol names which clash with ${WIMPLIB} from the Toolbox, so you can't write a ROMmable C module which links against the Toolbox and uses the shared makefiles.

We define a new variable ROM_SYMS which is initialised to ${C_ABSSYM}, ie. just the clib to match the stubs used during the rom phase, and the ${ROMCSTUBS} is now appended to ${ROM_LIBS} so it can be overridden rather than being hardwired into the rule.
For completeness SA_LIBS can now also be overridden to remove ${CLIB} if desired.

CApp/CLibrary now use ${NOP} silently.

Version 6.60. Tagged as 'BuildSys-6_60'
@
text
@d20 1
a20 1
# $Id: CModule,v 1.15 2014/10/19 13:50:08 srevill Exp $
d168 6
a173 2
SA_OBJS      += ${CMHGFILE} ${RES_OBJ}
DBG_OBJS     += ${CMHGFILE} ${RES_OBJ}
a340 1
ifneq (${RES_OBJ},)
a345 1
endif
@


1.15
log
@CTools build will now export things into an "Exports" directory.
This replaces the "AcornC/C++.Libraries" directory that we had
before, which was a random mash-up of bits of a real "Exports"
directory.

Also reverted the CModule change - leave this job to components
to deal with in their own makefiles.

Version 6.58. Tagged as 'BuildSys-6_58'
@
text
@d20 1
a20 1
# $Id: CModule,v 1.14 2014/10/18 13:42:25 srevill Exp $
d172 3
d356 2
a357 2
aof.${ROM_TARGET}: ${ROM_OBJS_} ${ROM_LIBS} ${ROMCSTUBS} ${DIRS} ${ROM_DEPEND}
        ${LD} -o $@@ -aof ${ROM_OBJS_} ${ROM_LIBS} ${ROMCSTUBS}
d359 2
a360 2
linked.${LNK_TARGET}: aof.${ROM_TARGET} ${ABSSYM} ${FORCEROMLINK}
        ${LD} ${LDFLAGS} ${LDLINKFLAGS} -o $@@ -rmf -base ${ADDRESS} aof.${ROM_TARGET} ${ABSSYM} -Symbols linked.${LNK_TARGET}_sym
d382 2
a383 2
rm.${SA_TARGET}: ${SA_OBJS_} ${SA_LIBS} ${CLIB} ${DIRS} ${SA_DEPEND}
        ${LD} ${LDFLAGS} ${LDRAMFLAGS} -o $@@ -rmf ${SA_OBJS_} ${SA_LIBS} ${CLIB}
d387 2
a388 2
rm.${DBG_TARGET}: ${DBG_OBJS_} ${DBG_LIBS} ${SA_LIBS} ${CLIB} ${DIRS} ${SA_DEPEND}
        ${LD} ${LDFLAGS} ${LDRAMFLAGS} -o $@@ -rmf ${DBG_OBJS_} ${DBG_LIBS} ${SA_LIBS} ${CLIB}
d395 1
a395 1
        ${LD} -aif -bin -d -o aif.${AIF_TARGET} ${DBG_OBJS_} ${DBG_LIBS} ${SA_LIBS} ${CLIB}
@


1.14
log
@Tweak to the ModuleDB to allow builds (e.g. CTools) to include some more of
the common librabries in their install phase. The ones I've added are (almost)
all required by shared makefiles - e.g. for debug app builds.

Also a minor fix to CModule shared makefile to cope with certain arrangements
of source files in a component.

Version 6.57. Tagged as 'BuildSys-6_57'
@
text
@d20 1
a20 1
# $Id: CModule,v 1.13 2014/09/27 09:51:17 rsprowson Exp $
a216 1
        ${MKDIR} h
@


1.13
log
@Change less useful resources_messages for resources_sprites
GNU/AAsmModule:
 Swap round ${RESOURCEEXTRA} to come later, since otherwise the ${RESDIR} hasn't been created
AAsmModule & CModule:
 Recemtly added resources_messages was a bit pointless as resources_common did the same thing, instead add resources_sprites.
ModuleLibs:
 Debug library for internal Toolbox objects added.
Retagged as BuildSys-6_50.
@
text
@d20 1
a20 1
# $Id: CModule,v 1.12 2014/09/24 20:24:13 rsprowson Exp $
d217 1
@


1.12
log
@Make debug builds a bit simpler
AAsmModule:
 Remove SA_DEBUG override, instead use ASDFLAGS like CModule does.
CModule:
 If the target is 'debug' allow CMHGDFLAGS to pass extra defines into CMHG, this avoids the common problem of having to have 2 CMHG files and select between them.

Other - sync the messages token check/copying, use ${NOP} and ${FAPPEND} and ${DO}, and od.${RES_OBJ} isn't dependent on ${DIRS} since it already has that when creating o.${RES_OBJ}.

Version 6.50. Tagged as 'BuildSys-6_50'
@
text
@d20 1
a20 1
# $Id: CModule,v 1.11 2014/09/18 08:04:44 rsprowson Exp $
d65 1
a65 1
# LIBS         (opt) (extra libraries; CLib is always used)
d317 1
a317 1
        IfThere LocalRes:CmdHelp Then FAppend ${RESFSDIR}.Messages LocalRes:Messages LocalRes:CmdHelp
d322 2
a323 2
resources_messages::
        ${CP} LocalRes:Messages ${RESFSDIR}.Messages ${CPFLAGS}
@


1.11
log
@Improvements to resources phase rules
AAsmModule:
The preferred override is now 'CUSTOMRES' to match CModule, though the former 'RESOURCES' is still accepted as a transitional step.
The internal phoney targets (like resources-None) can no longer be augmented with :: since that doesn't make sense.
Copied some block comments from CModule so they're easier to compare.
Fixed the resourcesno/resourcesNo never appearing, this is because when CUSTOMRES=no you end up with two rules called resourcesno and no rule called resources.
CModule:
Added resources_res and resources_messages and resources_templates as well as RESOURCEEXTRA support (from AAsmModule).
Copied some block comments from AAsmModule so they're easier to compare.

Tested in an IOMD ROM resources phase.

Version 6.48. Tagged as 'BuildSys-6_48'
@
text
@d20 1
a20 1
# $Id: CModule,v 1.10 2013/11/11 00:50:38 bavison Exp $
d72 1
a72 1
# CUSTOMRES    (opt) (set to "custom" to override the resources rules)
d190 4
d266 1
a266 1
        Do ${AWK} -- "/.ifndef ${CMHGFILE_SWIPREFIX}/,/endif/" h.${CMHGFILE} > o._h_${CMHGAUTOHDR}
d271 1
a271 1
        FAppend ${C_EXP_HDR}.${CMHGAUTOHDR} h.${CMHGAUTOHDR} o._h_${CMHGAUTOHDR}
d277 1
a277 1
        FAppend ${C_EXP_HDR}.${CMHGAUTOHDR} ${C_EXP_HDR}.${CMHGAUTOHDR} o._h_${CMHGAUTOHDR}
d313 1
a313 1
        @@|
d332 1
a332 1
        IfThere LocalRes:CmdHelp Then FAppend $@@ LocalRes:Messages LocalRes:CmdHelp Else ${CP} LocalRes:Messages $@@ ${CPFLAGS}
d338 2
a339 2
od.${RES_OBJ}: o.${RES_OBJ} ${DIRS}
        ${CP} o.${RES_OBJ} od.${RES_OBJ} ${CPFLAGS}
@


1.10
log
@  Changes to keep GNUmakefiles and Makefiles compatible
Detail:
  Makefiles/CApp:
  * Naming of object file variables rationalised in line with CModule
  * Noted that INSTAPP_VERSION files must also be present in INSTAPP_FILES for
    compatibility with GNUmakefiles - requires changes to individual top-level
    makefiles, but not BuildSys
  Makefiles/CLibrary:
  * Naming of object file variables rationalised in line with CModule
  Makefiles/CModule:
  * Removed unused variable OBJS_
  Makefiles/StdTools:
  * Retired TIDYDESC
  GNUmakefiles/AppLibs:
  * Add CONLIB, RMVSN, SYNCLIB
  GNUmakefiles/CApp:
  * Default definition of INSTAPP
  * Naming of object file variables rationalised in line with CModule
  * CLEAN_DEPEND removed, clean made a double-colon rule (it's worth noting
    that such additional clean rules are now only executed from the component's
    top-level directory: this was not true for the old extra_clean rules that
    this replaces, in the GNUmakefiles case)
  * Rename of INSTALLAPPFILES to INSTAPP_FILES
  * Rename of INSTALLAPP_DEPEND to INSTAPP_DEPENDS
  * Insertion of component version into Desc files now done using AwkVers
    script rather than the C preprocessor (note, will require editing of Desc
    files to comply). Also supports versions in Messages and !Run files,
    controlled by new variable INSTAPP_VERSION
  GNUmakefiles/CLibrary:
  * Naming of object file variables rationalised in line with CModule
  * clean rules now only executed from the component's top-level directory, as
    with CApp
  GNUmakefiles/StdTools:
  * Added INSERTVERSION (AwkVers), retired TIDYDESC
  * Perl scripts now explicitly passed to perl - no need to chmod +x the
    scripts in RiscOS/Library
  * asasm/objasm include paths and APCS/Machine/UserIF predefines set to match
    Makefiles
Admin:
  Tested in a CTools build

Version 6.32. Tagged as 'BuildSys-6_32'
@
text
@d20 1
a20 1
# $Id: CModule,v 1.9 2012/09/01 11:03:04 jlee Exp $
d206 1
d208 1
a208 1

d223 3
d247 3
a249 2
# Export rules

d292 1
a292 1

d294 3
d298 4
a301 2
resources${CUSTOMRES}: resources-${CMDHELP}
        @@${ECHO} ${COMPONENT}: resources copied to Messages module
d309 1
a309 1
        ${CP} LocalRes:Messages ${RESFSDIR}.Messages ${CPFLAGS}
d315 9
d338 3
a340 2
# ROM rules

d355 1
a355 1

d357 1
a357 1

@


1.9
log
@Modify makefile fragments to generate GPA & symbol files when building ROM modules. Add HangWatch to ModuleDB.
Detail:
  Makefiles/AAsmModule, Makefiles/CModule - Modified to generate GPA (for assembler) and symbols (for C) files when building ROM modules. These files are copied into the install folder, allowing them to easily be picked up by debugging tools.
  ModuleDB - Added entry for HangWatch module
Admin:
  Makefile changes tested with BCM2835, OMAP3, and Disc builds


Version 5.87. Tagged as 'BuildSys-5_87'
@
text
@d20 1
a20 1
# $Id: CModule,v 1.8 2012/02/05 09:13:26 rsprowson Exp $
a173 1
OBJS_         = $(addprefix o.,${OBJS})
@


1.9.2.1
log
@Merge of trunk BuildSys-6_34 to branch RPiFreeze

Version 6.00, 1.142.2.4. Tagged as 'BuildSys-6_00-1_142_2_4'
@
text
@d20 1
a20 1
# $Id: CModule,v 1.10 2013/11/11 00:50:38 bavison Exp $
d174 1
@


1.9.2.2
log
@Merge of BuildSys-6_52 to branch

Version 6.00, 1.142.2.5. Tagged as 'BuildSys-6_00-1_142_2_5'
@
text
@d20 1
a20 1
# $Id: CModule,v 1.13 2014/09/27 09:51:17 rsprowson Exp $
d65 1
a65 1
# LIBS         (opt) (extra libraries; ${CLIB} is always used)
d72 1
a72 1
# CUSTOMRES    (opt) (set to "custom" to override the resources rules, or "no" for no resources)
a189 4
ifneq ($(filter debug%,${MAKECMDGOALS}),)
CMHGFLAGS    += ${CMHGDFLAGS}  # Affects both object and header generation 
endif

a205 1
#
d207 1
a207 1
#
a221 3
#
# Clean the module
#
d243 2
a244 3
#
# Export phases
#
d257 1
a257 1
        ${DO} ${AWK} -- "/.ifndef ${CMHGFILE_SWIPREFIX}/,/endif/" h.${CMHGFILE} > o._h_${CMHGAUTOHDR}
d262 1
a262 1
        ${FAPPEND} ${C_EXP_HDR}.${CMHGAUTOHDR} h.${CMHGAUTOHDR} o._h_${CMHGAUTOHDR}
d268 1
a268 1
        ${FAPPEND} ${C_EXP_HDR}.${CMHGAUTOHDR} ${C_EXP_HDR}.${CMHGAUTOHDR} o._h_${CMHGAUTOHDR}
d287 1
a287 1
#
d289 2
a290 2
#
resources${CUSTOMRES}:: ${RESOURCEEXTRA} resources-${CMDHELP}
a292 5
ifeq (${CUSTOMRES},no)
resources:
        @@${ECHO} ${COMPONENT}: no resources to export
endif        

d299 1
a299 1
        @@${NOP}
d303 1
a303 10
        IfThere LocalRes:CmdHelp Then ${FAPPEND} ${RESFSDIR}.Messages LocalRes:Messages LocalRes:CmdHelp

resources_res::
        ${CP} LocalRes:Res ${RESFSDIR}.Res ${CPFLAGS}
        
resources_sprites::
        ${INSTRES} -I LocalUserIFRes:,LocalRes:,Resources ${RESFSDIR} Sprites [Sprites11] [Sprites22]

resources_templates::
        ${CP} LocalRes:Templates ${RESFSDIR}.Templates ${CPFLAGS}
d309 1
a309 1
        IfThere LocalRes:CmdHelp Then ${FAPPEND} $@@ LocalRes:Messages LocalRes:CmdHelp Else ${CP} LocalRes:Messages $@@ ${CPFLAGS}
d315 2
a316 2
od.${RES_OBJ}: o.${RES_OBJ}
        ${CP} o.${RES_OBJ} $@@ ${CPFLAGS}
d319 2
a320 3
#
# ROM build rules
#
d335 1
a335 1
#
d337 1
a337 1
#
@


1.9.2.3
log
@Merge of BuildSys-6_64 to branch

Version 6.00, 1.142.2.6. Tagged as 'BuildSys-6_00-1_142_2_6'
@
text
@d20 1
a20 1
# $Id: CModule,v 1.16 2014/10/24 12:36:49 rsprowson Exp $
a171 3
ROM_LIBS     += ${ROMCSTUBS}
ROM_SYMS      = ${C_ABSSYM}
SA_LIBS      += ${CLIB}
d353 2
a354 2
aof.${ROM_TARGET}: ${ROM_OBJS_} ${ROM_LIBS} ${DIRS} ${ROM_DEPEND}
        ${LD} -o $@@ -aof ${ROM_OBJS_} ${ROM_LIBS}
d356 2
a357 2
linked.${LNK_TARGET}: aof.${ROM_TARGET} ${ROM_SYMS} ${FORCEROMLINK}
        ${LD} ${LDFLAGS} ${LDLINKFLAGS} -o $@@ -rmf -base ${ADDRESS} aof.${ROM_TARGET} ${ROM_SYMS} -Symbols linked.${LNK_TARGET}_sym
d379 2
a380 2
rm.${SA_TARGET}: ${SA_OBJS_} ${SA_LIBS} ${DIRS} ${SA_DEPEND}
        ${LD} ${LDFLAGS} ${LDRAMFLAGS} -o $@@ -rmf ${SA_OBJS_} ${SA_LIBS}
d384 2
a385 2
rm.${DBG_TARGET}: ${DBG_OBJS_} ${DBG_LIBS} ${SA_LIBS} ${DIRS} ${SA_DEPEND}
        ${LD} ${LDFLAGS} ${LDRAMFLAGS} -o $@@ -rmf ${DBG_OBJS_} ${DBG_LIBS} ${SA_LIBS}
d392 1
a392 1
        ${LD} -aif -bin -d -o aif.${AIF_TARGET} ${DBG_OBJS_} ${DBG_LIBS} ${SA_LIBS}
@


1.9.2.4
log
@Merge of BuildSys-7_04 to branch

Version 6.00, 1.142.2.9. Tagged as 'BuildSys-6_00-1_142_2_9'
@
text
@d20 1
a20 1
# $Id: CModule,v 1.19 2016/05/29 13:34:41 rsprowson Exp $
d26 1
a26 1
#    resources
d52 5
a56 10
# INSTRES_FILES   (opt) (extra resource files in addition to Messages - use InstRes specification rules)
# INSTRAM_FILES   (opt) (RAM build specific resources - otherwise ${INSTRES_FILES})
# INSTROM_FILES   (opt) (ROM build specific resources - otherwise ${INSTRES_FILES})
# INSTR??_DEPENDS (opt) (any extra dependency to assert on INSTRES/INSTRAM/INSTROM_FILES)
# MERGEDRDIR      (r/o) (directory for generating exported resources, for information only)
# MERGEDMSGS      (r/o) (leafname of generated Messages file, for compatibility with AAsmModule)
# RESFSDIR        (opt) (actual directory to export resources to - otherwise ${RESDIR}.${TARGET})
# RES_AREA        (opt) (area name to use for embedded messages in standalone build - otherwise Resources)
# RES_OBJ         (opt) (object file for embedded messages in standalone build, no o.prefix - otherwise ${TARGET}Msgs)
# RES_PATH        (opt) (path relative to ResourceFS root to be suffixed by ${TARGET} - otherwise Resources)
d60 1
a92 1
# INSERTVERSION    (awk script to substitute from VersionNum)
d155 2
a156 6
INSTRAM_FILES   ?= ${INSTRES_FILES}
INSTRAM_DEPENDS ?= ${INSTRES_DEPENDS}
INSTROM_FILES   ?= ${INSTRES_FILES}
INSTROM_DEPENDS ?= ${INSTRES_DEPENDS}
MERGEDRDIR   ?= o._ResData_
MERGEDMSGS   ?= ${MERGEDRDIR}.${TARGET}.Messages
d159 1
a159 1
RES_PATH     ?= Resources
d168 2
a169 7
SA_OBJS      += ${CMHGFILE}
DBG_OBJS     += ${CMHGFILE}
ifeq ($(filter no custom,${CUSTOMRES}),)
RESDIR       ?= ${MERGEDRDIR}  # Place to internally collect up contents of RES_OBJ
SA_OBJS      += ${RES_OBJ}
DBG_OBJS     += ${RES_OBJ}
endif
a187 2
RES_FILES_    = ${INSTRAM_FILES}
RES_DEPENDS_  = ${INSTRAM_DEPENDS}
a190 2
RES_FILES_    = ${INSTROM_FILES}
RES_DEPENDS_  = ${INSTROM_DEPENDS}
d302 1
a302 1
resources${CUSTOMRES}:: resources-${CMDHELP}
a309 11
resources_extra: ${RES_DEPENDS_}
ifneq (${RES_FILES_},)
        ${INSTRES} -I Resources.${USERIF}.${LOCALE},Resources.${USERIF}.UK,Resources.${LOCALE},Resources.UK,Resources ${RESFSDIR} ${RES_FILES_}
endif
ifneq (,$(filter Messages,${INSTRES_VERSION}))
        ${INSERTVERSION} ${RESFSDIR}.Messages > ${RESFSDIR}._Awk_
        ${CP} ${RESFSDIR}._Awk_ ${RESFSDIR}.Messages ${CPFLAGS}
        ${RM} ${RESFSDIR}._Awk_
endif
        @@${NOP}

d315 4
a318 1
resources_cmdhelp:
d322 8
a329 2
resources-None: resources_extra resources_common 
        @@${NOP}
d331 5
a335 2
resources-: resources_extra resources_cmdhelp resources_common
        @@${NOP}
d337 3
a339 3
o.${RES_OBJ}: resources-${CMDHELP} ${DIRS}
        ${INSTVIARG} ${MERGEDRDIR} ${RES_PATH} o._ResGen_
        ${RESGEN} ${RES_AREA} $@@ -via o._ResGen_
d343 1
@


1.8
log
@Change back to overridable clean and dirs steps.
The CLEAN_DEPEND intermediate was added because GNU make didn't support '::' notation, but GNU nake 3.81 (possibly earlier) does as described at
  http://www.gnu.org/software/make/manual/make.html#Double_002dColon
verified with two test makefiles
# This is 'makefile'
include ./other.mk
clean::
	@@echo 1
	@@echo 2
# This is 'other.mk'
CLEANALIAS = clean
${CLEANALIAS}::
	@@echo 3
	@@echo 4
which did what was required.

Version 5.42. Tagged as 'BuildSys-5_42'
@
text
@d20 1
a20 1
# $Id: CModule,v 1.6 2011/04/03 16:42:52 bavison Exp $
d325 1
a325 2
rom_link${CUSTOMROM}: aof.${ROM_TARGET} ${ABSSYM} ${FORCEROMLINK}
        ${LD} ${LDFLAGS} ${LDLINKFLAGS} -o linked.${LNK_TARGET} -rmf -base ${ADDRESS} aof.${ROM_TARGET} ${ABSSYM}
d327 1
d334 1
a334 1
        ${LD} ${LDFLAGS} ${LDLINKFLAGS} -o $@@ -rmf -base ${ADDRESS} aof.${ROM_TARGET} ${ABSSYM}
@


1.7
log
@Add optional CLEAN_DEPEND to the clean rule in CModule.
Do actively report when the CMHG file is deleted in CModule.
Add PRISMLIB to the available module libraries.
Components files updated to pass USB driver switches via CDEFINES not
CFLAGS.
Tested with OMAP3 ROM build, other components files modified by eye but
not tested.

Version 5.39. Tagged as 'BuildSys-5_39'
@
text
@a81 1
# CLEAN_DEPEND (opt) (phony target for additional clean actions)
d223 1
a223 1
clean :: ${CLEAN_DEPEND}
@


1.6
log
@  Bugfix to CModule makefile from previous commit
Detail:
  A line in this makefile evaluates CFLAGS so that the default static data
  relocation and stack checking options can be inserted before any overrides
  from the top-level makefile. But this was being done before StdTools was
  included, so C_STKCHK had not yet been defined, so if the top-level makefile
  tried to use it, it had no effect.
Admin:
  Tested using new FrontEnd makefile.

Version 5.13. Tagged as 'BuildSys-5_13'
@
text
@d1 14
d20 1
a20 1
# $Id: CModule,v 1.5 2011/03/31 00:04:06 bavison Exp $
a32 3
# It is intended that this be used instead of the ROMCModule and RAMCModule
# makefiles, but they remain for the time being for compatibility reasons.
#
d60 1
d82 1
d224 1
a224 1
clean ::
d241 1
a244 1

d315 1
a315 1
	${RESGEN} ${RES_AREA} $@@ ${MERGEDMSGS} ${RES_PATH}
a320 1

@


1.5
log
@  Improvements to shared makefiles
Detail:
  * Some subtle bugs can be caused by including shared makefiles in the
    wrong order. To try to prevent further problems, and simplify main
    makefiles at the same time, CApp, CLibrary and CModule now include the
    makefiles they depend upon themselves, in the correct order: generally
    speaking, all macro (re)definitions should be before rule definitions.
  * Added sentry macro definitions to each makefile. These can be used to
    avoid repeated inclusion of makefiles - particularly important now that
    CApp, CLibrary and CModule do additional includes. This removes the
    majority of cases where amu produced warnings about multiple inclusion;
    a few components remain where this is still the case, but these
    warnings are harmless. If they bother you, simply remove the
    now-superfluous include statements from the relevant main makefile.
  * Created a CUtil shared makefile, for building transient utilities. The
    'C' in the name is more for consistency with CApp/CLibrary/CModule than
    anything to do with the 'C' language, since all of these makefiles work
    equally well for assembler and 'C' - the 'C' is for historic reasons.
  * Tweaked the debug rules in CApp to avoid harmless but annoying linker
    warnings about stubs being included twice.
  * Added several new default switches to ASFLAGS. These enable us to start
    making assembler source files work under a cross-assembler, because
    statements like
        GET  Hdr:Macros
        GET  Hdr:Machine.<Machine>
    are not portable, and tweaking the cross-assembler to understand these
    types of constructs would not be pretty. Instead, with the extra
    command line switches now introduced, you can use
        GET  Macros
        GET  Machine/$Machine
Admin:
  Tested in a ROM build

Version 5.12. Tagged as 'BuildSys-5_12'
@
text
@d6 1
a6 1
# $Id: CModule,v 1.4 2009/07/17 00:31:31 jlee Exp $
a161 1
CFLAGS       := -zM -zps1 ${CFLAGS}
d186 2
@


1.4
log
@Update CModule makefile fragment to use a default RESFSDIR if required. Add IIC module to OMAP3 components file.
Detail:
  Makefiles/CModule - makefile fragment now generates a default RESFSDIR value in an identical way to the AAsmModule fragment, easing migration of makefiles to the fragment system.
  Components/ROOL/OMAP3 - IIC module has been added to ROM image
Admin:
  Tested on rev C2 beagleboard


Version 4.80. Tagged as 'BuildSys-4_80'
@
text
@d2 3
d6 1
a6 1
# $Id: CModule,v 1.3 2009/06/26 14:03:06 bavison Exp $
d180 13
@


1.3
log
@  Added CTools disc build, and various supporting changes
Detail:
  * Updates to CModule makefile fragment to reduce the number of OS-specific
    rules in main Makefiles:
    + Added (RAM|ROM)(C|ASM)DEFINES variables. These allow the calling makefile
      to specify additional defines for RAM or ROM builds of C or assembler
      source files respectively. Traditionally this was done by having separate
      object files for RAM and ROM corresponding at least to whichever source
      file was responsible for interfacing with ResourceFS, but this requires
      messy additional rules. With this new approach, it is necessary to clean
      the component when switching between RAM and ROM builds, but I don't
      think this will affect many people's workflows.
    + Added CMHGDEPENDS. This should be used to specify which object files need
      a static dependency upon the h file autogenerated from the cmhg file.
      It should be specified in the usual form for object files passed to
      CModule - with neither an o. prefix nor a .o suffix.
  * Added TBOXINTLIB to ModuleLibs makefile fragment.
  * AsmUtils, HdrSrc, TCPIPheaders, ToolboxLib and UnicodeLib all upgraded in
    ModuleDB from EXP to ASM or C components, to permit them to be built in the
    install phase. As a result, those other Components files that didn't
    already do so now need to override this back to -type EXP.
  * BuildHost Components file edited to reflect the fact that binaof, binasm,
    modgen and ResGen now have separate install phases for executables and
    Docs files.
Admin:
  The new Components file uses various components that are not publicly
  released, so it can only sensibly be used internally by ROOL. However, it's
  more convenient for us to keep it alongside the other Components files - and
  it also serves as an illustration of how to do a disc build.

Version 4.77. Tagged as 'BuildSys-4_77'
@
text
@d3 1
a3 1
# $Id: CModule,v 1.2 2009/01/27 19:28:32 bavison Exp $
d74 1
a74 1
# RESFSDIR         (location to install files destined for ResourceFS)
d145 1
@


1.2
log
@  Added initial support for OMAP-3 builds.
Detail:
  * Added new components file
  * Added entry for new HAL in the ModuleDB
  * Minor tweak to Makefiles:CModule so HALs can use shared Makefiles:
    no longer assumes that all callers wil have a non-null CMHGFILE
Admin:
  Used in a test build

Version 4.68. Tagged as 'BuildSys-4_68'
@
text
@d3 1
a3 1
# $Id: CModule,v 1.1 2008/10/14 21:29:37 bavison Exp $
d62 5
d168 8
d242 5
@


1.1
log
@Clean reimport of the build environment directories.
This represents the version released in the Batch 4 "bbe" tarfiles.
Tagged as 'Batch4'
@
text
@d3 1
a3 1
# $Id: CModule,v 1.1 2007/07/02 18:30:10 bavison Exp $
d213 1
d216 1
@

