head	1.7;
access;
symbols
	BuildSys-7_30:1.7
	BuildSys-7_29:1.7
	BuildSys-7_28:1.7
	BuildSys-7_27:1.7
	BuildSys-7_26:1.7
	BuildSys-7_25:1.7
	BuildSys-7_24:1.7
	BuildSys-7_23:1.6
	BuildSys-7_22:1.6
	BuildSys-7_21:1.6
	BuildSys-7_20:1.5
	BuildSys-7_19:1.5
	BuildSys-7_18:1.5
	BuildSys-7_17:1.5
	BuildSys-7_16:1.5
	BuildSys-7_15:1.5
	BuildSys-7_14:1.5
	BuildSys-7_13:1.5
	BuildSys-7_12:1.5
	BuildSys-7_11:1.5
	BuildSys-7_10:1.5
	BuildSys-7_09:1.5
	BuildSys-6_00-1_142_2_10:1.4.2.1
	BuildSys-7_08:1.5
	BuildSys-7_07:1.5
	BuildSys-7_06:1.5
	BuildSys-7_05:1.5
	BuildSys-6_00-1_142_2_9:1.4.2.1
	BuildSys-7_04:1.5
	BuildSys-7_03:1.5
	BuildSys-7_02:1.5
	BuildSys-7_01:1.5
	BuildSys-7_00:1.5
	BuildSys-6_99:1.5
	BuildSys-6_98:1.5
	BuildSys-6_97:1.5
	BuildSys-6_96:1.5
	BuildSys-6_95:1.5
	BuildSys-6_94:1.5
	BuildSys-6_93:1.5
	BuildSys-6_92:1.5
	BuildSys-6_91:1.5
	BuildSys-6_90:1.5
	BuildSys-6_89:1.5
	BuildSys-6_81-1:1.5
	BuildSys-6_88:1.5
	BuildSys-6_87:1.5
	BuildSys-6_86:1.5
	BuildSys-6_85:1.5
	BuildSys-6_84:1.5
	BuildSys-6_83:1.5
	BuildSys-6_82:1.5
	BuildSys-6_81:1.5
	BuildSys-6_80:1.5
	BuildSys-6_79:1.5
	BuildSys-6_78:1.5
	BuildSys-6_77:1.5
	BuildSys-6_76:1.5
	BuildSys-6_75:1.5
	BuildSys-6_74:1.5
	BuildSys-6_73:1.5
	BuildSys-6_72:1.5
	BuildSys-6_71:1.5
	BuildSys-6_70:1.5
	BuildSys-6_69:1.5
	BuildSys-6_68:1.5
	BuildSys-6_67:1.5
	BuildSys-6_66-1:1.5
	BuildSys-6_66:1.5
	BuildSys-6_65:1.5
	BuildSys-6_00-1_142_2_8:1.4.2.1
	BuildSys-6_00-1_142_2_7:1.4.2.1
	BuildSys-6_00-1_142_2_6:1.4.2.1
	BuildSys-6_64:1.5
	BuildSys-6_63:1.5
	BuildSys-6_62:1.5
	BuildSys-6_61:1.5
	BuildSys-6_60:1.5
	BuildSys-6_59:1.5
	BuildSys-6_58:1.5
	BuildSys-6_57:1.5
	BuildSys-6_56:1.5
	BuildSys-6_55:1.5
	BuildSys-6_54:1.5
	BuildSys-6_53:1.5
	BuildSys-6_00-1_142_2_5:1.4.2.1
	BuildSys-6_52:1.5
	BuildSys-6_51:1.5
	BuildSys-6_50:1.5
	BuildSys-6_49:1.5
	BuildSys-6_48:1.5
	BuildSys-6_47:1.5
	BuildSys-6_46:1.5
	BuildSys-6_45:1.5
	BuildSys-6_44:1.5
	BuildSys-6_43:1.5
	BuildSys-6_42:1.5
	BuildSys-6_41:1.5
	BuildSys-6_40:1.5
	BuildSys-6_39:1.5
	BuildSys-6_38:1.5
	BuildSys-6_00-1_142_2_4:1.4.2.1
	BuildSys-6_37:1.5
	BuildSys-6_36:1.5
	BuildSys-6_35:1.5
	BuildSys-6_34:1.5
	BuildSys-6_33:1.5
	BuildSys-6_32:1.5
	BuildSys-6_31:1.4
	BuildSys-6_30:1.4
	BuildSys-6_29:1.4
	BuildSys-6_28:1.4
	BuildSys-6_27:1.4
	BuildSys-6_26:1.4
	BuildSys-6_25:1.4
	BuildSys-6_24:1.4
	BuildSys-6_23:1.4
	BuildSys-6_22:1.4
	BuildSys-6_21:1.4
	BuildSys-6_20:1.4
	BuildSys-6_00-1_142_2_3:1.4
	BuildSys-6_19:1.4
	BuildSys-6_18:1.4
	BuildSys-6_17:1.4
	BuildSys-6_16:1.4
	BuildSys-6_15:1.4
	BuildSys-6_14:1.4
	BuildSys-6_13:1.4
	BuildSys-6_12:1.4
	BuildSys-6_00-1_142_2_2:1.4
	BuildSys-6_11:1.4
	BuildSys-6_10:1.4
	BuildSys-6_09:1.4
	BuildSys-6_08:1.4
	BuildSys-6_07:1.4
	BuildSys-6_06:1.4
	BuildSys-6_05:1.4
	BuildSys-6_04:1.4
	BuildSys-6_03:1.4
	BuildSys-6_02:1.4
	BuildSys-6_01:1.4
	BuildSys-6_00-1_142_2_1:1.4
	RPiFreeze:1.4.0.2
	BuildSys-6_00:1.4
	BuildSys-5_99:1.4
	BuildSys-5_98:1.4
	BuildSys-5_97:1.4
	BuildSys-5_96:1.4
	BuildSys-5_95:1.4
	BuildSys-5_94:1.4
	BuildSys-5_93:1.4
	BuildSys-5_92:1.4
	BuildSys-5_91:1.4
	BuildSys-5_90:1.4
	BuildSys-5_89:1.4
	BuildSys-5_88:1.4
	BuildSys-5_87:1.4
	BuildSys-5_86:1.4
	BuildSys-5_85:1.4
	BuildSys-5_84:1.4
	BuildSys-5_83:1.4
	BuildSys-5_82:1.4
	BuildSys-5_81:1.4
	BuildSys-5_80:1.4
	BuildSys-5_79:1.4
	BuildSys-5_78:1.4
	BuildSys-5_77:1.4
	BuildSys-5_76:1.4
	BuildSys-5_75:1.4
	BuildSys-5_74:1.4
	BuildSys-5_73:1.4
	BuildSys-5_72:1.4
	BuildSys-5_71:1.4
	BuildSys-5_70:1.4
	BuildSys-5_69:1.4
	BuildSys-5_68:1.4
	BuildSys-5_67:1.4
	BuildSys-5_66:1.4
	BuildSys-5_65:1.4
	BuildSys-5_64:1.4
	BuildSys-5_63:1.4
	BuildSys-5_62:1.4
	BuildSys-5_61:1.4
	BuildSys-5_60:1.4
	BuildSys-5_59:1.4
	BuildSys-5_58:1.4
	BuildSys-5_57:1.4
	BuildSys-5_56:1.4
	BuildSys-5_55:1.4
	BuildSys-5_54:1.4
	BuildSys-5_53:1.4
	BuildSys-5_52:1.4
	BuildSys-5_51:1.4
	BuildSys-5_50:1.4
	BuildSys-5_49:1.4
	BuildSys-5_48:1.4
	BuildSys-5_47:1.4
	BuildSys-5_46:1.4
	BuildSys-5_45:1.4
	BuildSys-5_44:1.4
	BuildSys-5_43:1.4
	BuildSys-5_42:1.4
	BuildSys-5_41:1.3
	BuildSys-5_40:1.3
	BuildSys-5_39:1.3
	BuildSys-5_38:1.3
	BuildSys-5_37:1.3
	BuildSys-5_36:1.3
	BuildSys-5_35:1.3
	BuildSys-5_34:1.3
	BuildSys-5_33:1.3
	BuildSys-5_32:1.3
	BuildSys-5_31:1.3
	BuildSys-5_30:1.3
	BuildSys-5_29:1.3
	BuildSys-5_28:1.3
	BuildSys-5_27:1.3
	BuildSys-5_26:1.3
	BuildSys-5_25:1.3
	BuildSys-5_24:1.3
	BuildSys-5_23:1.3
	BuildSys-5_22:1.3
	BuildSys-5_21:1.3
	BuildSys-5_20:1.2
	BuildSys-5_19:1.2
	BuildSys-5_18:1.2
	BuildSys-5_17:1.2
	BuildSys-5_16:1.2
	BuildSys-5_15:1.2
	BuildSys-5_14:1.2
	BuildSys-5_13:1.2
	BuildSys-5_12:1.2
	BuildSys-5_11:1.2
	BuildSys-5_10:1.2
	BuildSys-5_09:1.2
	BuildSys-5_08:1.2
	BuildSys-5_07:1.2
	BuildSys-5_06:1.2
	BuildSys-5_05:1.2
	BuildSys-5_04:1.2
	BuildSys-5_03:1.2
	BuildSys-5_02:1.1
	BuildSys-5_01:1.1;
locks; strict;
comment	@# @;


1.7
date	2018.04.11.23.21.08;	author bavison;	state Exp;
branches;
next	1.6;
commitid	IH1EokSuAjoQZ4yA;

1.6
date	2018.03.12.21.44.40;	author bavison;	state Exp;
branches;
next	1.5;
commitid	k1x0Nm0F4RqwqduA;

1.5
date	2013.11.11.00.50.35;	author bavison;	state Exp;
branches;
next	1.4;
commitid	Tr3fHk0Gie15lNcx;

1.4
date	2012.02.05.09.13.23;	author rsprowson;	state Exp;
branches
	1.4.2.1;
next	1.3;
commitid	XCR9w41JK8TYQWRv;

1.3
date	2011.09.12.23.00.47;	author bavison;	state Exp;
branches;
next	1.2;
commitid	mwF3dZUt3oUN7gzv;

1.2
date	2010.10.20.23.14.23;	author bavison;	state Exp;
branches;
next	1.1;

1.1
date	2010.05.19.14.47.57;	author bavison;	state Exp;
branches;
next	;

1.4.2.1
date	2014.02.20.21.02.43;	author rsprowson;	state Exp;
branches;
next	;
commitid	HvOFwLQ3c6PzNSpx;


desc
@@


1.7
log
@  Incremental step in cross-compilation support
Detail:
  ModuleDB:
  * Correct capitalisation of resgen's TARGET to match its main source file
  GNUmakefiles/AAsmModule:
  * Targets now given ,ffa filetype suffix
  * Support source directory layouts s/<subdir>/<leaf> as used by the
    kernel and printer drivers - define SYMLINK_EXT_FIRST to enable
  * Prevent relinking when running make on an up-to-date component due to
    a difference between amu and GNU make's handling of double-colon rules
  * Support linking with GNU toolchain
  * Fix installation rule (mixup between MERGEDMDIR and MERGEDRDIR)
  * Support up to 16 assembler and 8 C-from-assembler headers, up from 3
    of each (here's looking at you, kernel) - long-term, it might be worth
    changing this to a scheme like that used by CModule to remove any
    limits
  * Fix C-from-assembler exports to have .h suffix
  GNUmakefiles/AppLibs:
  * Define INCLUDE_OSLIB to permit OSLib header search paths to be
    specified in an OS-agnostic way
  GNUmakefiles/CApp:
  * Prevent relinking when running make on an up-to-date component due to
    a difference between amu and GNU make's handling of double-colon rules
  GNUmakefiles/CLibrary:
  * Prevent rearchiving when running make on an up-to-date component due
    to a difference between amu and GNU make's handling of double-colon
    rules
  * Don't use .hdr suffix on exported assembler header files
  * Correct order of dependencies for export_libs phony target
  GNUmakefiles/StdTools:
  * Definition for the module filetype suffix
  * Add LDBIN tool for GNU/Norcroft-agnostic binary link, useful for
    linking position-independent binary code, such as relocatable modules
    (i.e. ones that don't require the linker to create a __RelocCode
    function)
  * FAPPEND function now works if the same file is used for the
    destination as for one of the sources (this is used by CModule)
  GNUmakefiles/CModule, ModStdRule, ModuleLibs:
  * Finally created cross-compilation versions of the last major shared
    makefiles! Warning: these have received limited testing to date.
  Makefiles/AAsmModule:
  * Support up to 16 assembler and 8 C-from-assembler headers
  Makefiles/AppLibs, ModuleLibs:
  * Define INCLUDE_OSLIB
  Makefiles/StdTools:
  * Add LDBIN tool


Version 7.24. Tagged as 'BuildSys-7_24'
@
text
@# Makefile fragment for C and C++ applications

INCLUDED_CAPP = YES

#
# This makefile provides the following phony targets:
#
#    all  install  debug
#
#
# This fragment uses the following macros set by the master makefile.
#
#
# COMPONENT                 (the name of the component)
# TARGET              (opt) (the leafname of the application - otherwise ${COMPONENT})
# DBG_TARGET          (opt) (debug application leafname - otherwise ${TARGET}-D)
# INSTAPP             (opt) (the application target directory - otherwise ${INSTDIR}/!${COMPONENT})
# INSTDIR             (opt) (the target directory - otherwise ${INSTALLDIR}/${TARGET})
# DIRS                (opt) (stamp object for directory creation - otherwise _dirs)
# OBJS                (opt) (object files, no o. prefixes - otherwise ${TARGET})
# APP_OBJS            (opt) (release build object files, no prefixes - otherwise ${OBJS})
# DBG_OBJS            (opt) (debug build object files, no prefixes - otherwise ${OBJS})
# LIBS                (opt) (extra libraries; ${CLIB} is always used)
# APP_LIBS            (opt) (extra release libraries - otherwise ${LIBS}; ${CLIB} is always used)
# DBG_LIBS            (opt) (extra debug libraries - otherwise ${LIBS}; ${CLIB} and ${DEBUGLIBS} always used)
# LINK_TYPE           (opt) (variant of linking command, eg C++ - defaults to C)
# INSTTYPE            (opt) (use "tool" or "app" to install executable vs application - defaults to "tool")
# INSTAPP_FILES       (opt) (list of files to be installed in application directory - use InstRes specification rules)
# INSTAPP_DEPENDS     (opt) (list of dependencies to be satisfied before doing application install - ${TARGET} assumed if in INSTAPP_FILES)
# INSTAPP_VERSION     (opt) (list of Messages/!Run/Desc files to insert app version from VersionNum - include in INSTAPP_FILES as well)
# CUSTOMLINK          (opt) (set to "custom" to override the link rule)
# CUSTOMINSTALLAPP    (opt) (set to "custom" to override the install rule for resource files)
# CUSTOMINSTALLTOOL   (opt) (set to "custom" to override the install rule for target binary)
# CUSTOMINSTALLDBGAPP (opt) (set to "custom" to override the install rule for debug resources)
# SOURCES_TO_SYMLINK  (opt) (files which need be linked to by the link farm, in addition to contents of c and h directories)
#
#
# It relies on the following generic tool macros from the StdTools makefile
#
#
# C + CFLAGS       (C compiler; CDFLAGS also used in debug builds; -g implicit)
# CP + CPFLAGS     (copy, cp etc.)
# WIPE + WFLAGS    (recursive delete)
# RM               (non-recursive delete)
# AS + ASFLAGS     (assembler)
# LD + LDFLAGS     (linker; LDDFLAGS also used in debug builds; -d implicit)
# SQZ + SQZFLAGS   (binary compressor)
# MKDIR            (cdir/mkdir -p)
# ECHO
# TOUCH            (create/touch)
# INSERTVERSION    (awk script to substitute from VersionNum)
#
#
# It relies on the following from the StdRules makefile
#
#
# .c.o  .c++.o  .cpp.o  .s.o
#
#
# It relies on the following from the DbgRules makefile
#
#
# CDFLAGS  C++DFLAGS  ASDFLAGS  LDDFLAGS
# .c.od  .c++.od  .cpp.od  .s.od
#
#

TARGET       ?= ${COMPONENT}
DBG_TARGET   ?= ${TARGET}-D
INSTDIR      ?= ${INSTALLDIR}/${TARGET}
INSTAPP      ?= ${INSTDIR}/!${COMPONENT}
DIRS         ?= _dirs
OBJS         ?= ${TARGET}
APP_OBJS     ?= ${OBJS}
DBG_OBJS     ?= ${OBJS}
APP_LIBS     ?= ${LIBS}
DBG_LIBS     ?= ${LIBS}
DBG_LIBS     += ${DEBUGLIBS}
ifeq (C++,${LINK_TYPE})
APP_LIBS     += ${C++LIB}
DBG_LIBS     += ${C++LIB}
endif
APP_LIBS     += ${CLIB}
DBG_LIBS     += ${CLIB}

APP_OBJS_     = $(addsuffix .o,${APP_OBJS})
DBG_OBJS_     = $(addsuffix .od,${DBG_OBJS})

SOURCES_TO_SYMLINK += $(wildcard c/*) $(wildcard c++/*) $(wildcard h/*) $(wildcard s/*) VersionNum VersionASM

ifneq (objs,$(notdir ${CURDIR}))

# Makefile invoked from same directory
# Create link farm, then execute the makefile from within it

ifeq (clean,${MAKECMDGOALS})
# With a double-colon rule which can have additional actions assigned from the
# master makefile, we'd normally need the master makefile to include the
# ${CURDIR} check to ensure that it's performed on the same invocation as us.
# However, there's no real benefit to performing clean from within the objs
# directory, and it adds an ordering problem between the different double-colon
# rules (the one that deletes the objs directory has to be last otherwise the
# cwd is invalid for the others) so to simplify things, we only ever do cleans
# from the same directory as the Makefile.
clean::
	@@echo Cleaning...
	@@rm -rf objs
	@@echo ${COMPONENT}: cleaned
else
all install debug links: ${SYMLINK_DEPEND}
	$(foreach linksource,${SOURCES_TO_SYMLINK}, \
		$(shell \
			linkdest=`echo ${linksource} | sed -e 's,\([^/]*\)/\([^/]*\)$$,\2.\1,' -e 's,^,objs/,'`; \
			linkdestdir=`echo $$linkdest | sed -e 's,/[^/]*$$,,'`; \
			linkbackpath=`echo $$linkdestdir | sed -e 's,[^/]*,..,g'`; \
			[ -d ${linksource} ] || [ -L $$linkdest ] || mkdir -p $$linkdestdir; \
			[ -d ${linksource} ] || [ -L $$linkdest ] || ln -s $$linkbackpath/${linksource} $$linkdest; \
		 ) \
	)
	@@[ -L objs/Resources ] || ln -s ../Resources objs/Resources
	@@mkdir -p objs
ifneq (links,${MAKECMDGOALS})
	@@${MAKE} -C objs -f ../$(firstword ${MAKEFILE_LIST}) ${MAKECMDGOALS}
endif
endif

else

# Makefile invoked from objs subdirectory

ifeq ("${INCLUDED_STDTOOLS}","")
ifeq ("${INCLUDED_HOSTTOOLS}","")
include StdTools
endif
endif
ifeq ("${INCLUDED_APPLIBS}","")
include AppLibs
endif

ifeq ("${INCLUDED_APPSTDRULE}","")
include AppStdRule
endif
ifeq ("${INCLUDED_DBGRULES}","")
include DbgRules
endif

all: ${TARGET}${SUFFIX_ABSOLUTE}
	@@${ECHO} ${COMPONENT}: application built

# GNU make seems to treat any double-colon rule with no dependencies as
# always out-of-date, therefore always rebuilds it and anything which in turn
# depends on the target of the double-colon rule. So use a single-colon rule
# instead. If any cross builds need to create extra directories on a
# per-component basis, we'll cross that bridge when we get to it.
${DIRS}:
	${TOUCH} $@@

install: install_${INSTTYPE}

install_: install_tool

INSTAPP_DEPENDS +=  $(addsuffix ${SUFFIX_ABSOLUTE},$(filter ${TARGET},${INSTAPP_FILES}))

install_app${CUSTOMINSTALLAPP}: ${INSTAPP_DEPENDS}
	${MKDIR} ${INSTAPP}
	${INSTRES} -I Resources.${USERIF}.${LOCALE},Resources.${USERIF}.UK,Resources.${LOCALE},Resources.UK,Resources ${INSTAPP} ${INSTAPP_FILES}
ifneq (,$(filter Messages,${INSTAPP_VERSION}))
	TMP=`mktemp`; ${INSERTVERSION} ${INSTAPP}/Messages > $$TMP; mv $$TMP ${INSTAPP}/Messages
endif        
ifneq (,$(filter Desc,${INSTAPP_VERSION}))
	TMP=`mktemp`; ${INSERTVERSION} descmode=1 ${INSTAPP}/Desc ${INSTAPP}/Desc > $$TMP; mv $$TMP ${INSTAPP}/Desc
endif        
ifneq (,$(filter !Run,${INSTAPP_VERSION}))
	TMP=`mktemp`; ${INSERTVERSION} obeymode=1 ${INSTAPP}/!Run${SUFFIX_OBEY} > $$TMP; mv $$TMP ${INSTAPP}/!Run${SUFFIX_OBEY}
endif
	@@${ECHO} ${COMPONENT}: application installation complete

install_debug_app${CUSTOMINSTALLDBGAPP}: ${DBG_TARGET}${SUFFIX_DEBIMAGE}
	${CP} ${DBG_TARGET}${SUFFIX_DEBIMAGE} ${INSTAPP}/${TARGET}${SUFFIX_DEBIMAGE} ${CPFLAGS}
	@@${ECHO} ${COMPONENT}: ${TARGET} replaced with ${DBG_TARGET}

install_tool${CUSTOMINSTALLTOOL}: ${TARGET}${SUFFIX_ABSOLUTE}
	${MKDIR} ${INSTDIR}
	${CP} ${TARGET}${SUFFIX_ABSOLUTE} ${INSTDIR}/${TARGET}${SUFFIX_ABSOLUTE} ${CPFLAGS}
	@@${ECHO} ${COMPONENT}: tool installation complete

debug: ${DBG_TARGET}${SUFFIX_DEBIMAGE}
	@@${ECHO} ${COMPONENT}: debug application built

${TARGET}${SUFFIX_ABSOLUTE}${CUSTOMLINK}: ${DIRS} ${APP_OBJS_} ${APP_LIBS}
	${LD} ${LDFLAGS} -o $@@ ${APP_OBJS_} ${APP_LIBS}
	${STRIP} $@@
	${SQZ} ${SQZFLAGS} $@@

${DBG_TARGET}${SUFFIX_DEBIMAGE}${CUSTOMLINK}: ${DIRS} ${DBG_OBJS_} ${DBG_LIBS}
	${LD} ${LDFLAGS} ${LDDFLAGS} -o $@@ ${DBG_OBJS_} ${DBG_LIBS}

include $(wildcard *.d)
include $(wildcard *.dd)

endif

# EOF
@


1.6
log
@  Changes to keep GNUmakefiles and Makefiles compatible
Detail:
  GNUmakefiles/AAsmModule:
  * Adopt same extensible syntax for describing resources phase files as CModule (see BuildSys 6.91)
  GNUmakefiles/AppLibs:
  * Don't permit CALLXLIB to be used for application builds (see BuildSys 6.61)
  * Reflect MODMALLOCLIB leafname change (see BuildSys 6.61)
  * Add TBOXINTLIB, TBOXINTDBGLIB, PDEBUGLIB, PRISMLIB, REMOTEDBLIB, TRACELIB, UNICODELIB and include more libs in DEBUGLIBS (see BuildSys 6.63)
  GNUmakefiles/CApp:
  * Add install_debug_app rule for debug app installations (see BuildSys 6.53)
  GNUmakefiles/CLibrary:
  * Allow additional dependencies to be specified using LIB_DEPENDS (see BuildSys 6.63)
  * Gains install target (see BuildSys 7.15)
  GNUmakefiles/StdTools:
  * Add shell implementation of FAppend (see BuildSys 6.45) - compatible except for the fact that the destination is given current timestamp
  * ${NOP} no longer implicitly includes the silent-command prefix character @@ (see BuildSys 6.50)
  * Add CPVFLAGS (see BuildSys 6.53) although it can't achieve anything as a suffix to the command
  * Add shell implementation of EraseCVS (see BuildSys 6.53)
  * Add InstViaRG tool (see BuildSys 6.70)


Version 7.21. Tagged as 'BuildSys-7_21'
@
text
@d35 1
a35 1
# SOURCES_TO_LINK     (opt) (files which need be linked to by the link farm, in addition to contents of c and h directories)
d150 6
a155 1
${DIRS}::
@


1.5
log
@  Changes to keep GNUmakefiles and Makefiles compatible
Detail:
  Makefiles/CApp:
  * Naming of object file variables rationalised in line with CModule
  * Noted that INSTAPP_VERSION files must also be present in INSTAPP_FILES for
    compatibility with GNUmakefiles - requires changes to individual top-level
    makefiles, but not BuildSys
  Makefiles/CLibrary:
  * Naming of object file variables rationalised in line with CModule
  Makefiles/CModule:
  * Removed unused variable OBJS_
  Makefiles/StdTools:
  * Retired TIDYDESC
  GNUmakefiles/AppLibs:
  * Add CONLIB, RMVSN, SYNCLIB
  GNUmakefiles/CApp:
  * Default definition of INSTAPP
  * Naming of object file variables rationalised in line with CModule
  * CLEAN_DEPEND removed, clean made a double-colon rule (it's worth noting
    that such additional clean rules are now only executed from the component's
    top-level directory: this was not true for the old extra_clean rules that
    this replaces, in the GNUmakefiles case)
  * Rename of INSTALLAPPFILES to INSTAPP_FILES
  * Rename of INSTALLAPP_DEPEND to INSTAPP_DEPENDS
  * Insertion of component version into Desc files now done using AwkVers
    script rather than the C preprocessor (note, will require editing of Desc
    files to comply). Also supports versions in Messages and !Run files,
    controlled by new variable INSTAPP_VERSION
  GNUmakefiles/CLibrary:
  * Naming of object file variables rationalised in line with CModule
  * clean rules now only executed from the component's top-level directory, as
    with CApp
  GNUmakefiles/StdTools:
  * Added INSERTVERSION (AwkVers), retired TIDYDESC
  * Perl scripts now explicitly passed to perl - no need to chmod +x the
    scripts in RiscOS/Library
  * asasm/objasm include paths and APCS/Machine/UserIF predefines set to match
    Makefiles
Admin:
  Tested in a CTools build

Version 6.32. Tagged as 'BuildSys-6_32'
@
text
@d14 22
a35 21
# COMPONENT               (the name of the component)
# TARGET            (opt) (the leafname of the application - otherwise ${COMPONENT})
# DBG_TARGET        (opt) (debug application leafname - otherwise ${TARGET}-D)
# INSTAPP           (opt) (the application target directory - otherwise ${INSTDIR}/!${COMPONENT})
# INSTDIR           (opt) (the target directory - otherwise ${INSTALLDIR}/${TARGET})
# DIRS              (opt) (stamp object for directory creation - otherwise _dirs)
# OBJS              (opt) (object files, no o. prefixes - otherwise ${TARGET})
# APP_OBJS          (opt) (release build object files, no prefixes - otherwise ${OBJS})
# DBG_OBJS          (opt) (debug build object files, no prefixes - otherwise ${OBJS})
# LIBS              (opt) (extra libraries; ${CLIB} is always used)
# APP_LIBS          (opt) (extra release libraries - otherwise ${LIBS}; ${CLIB} is always used)
# DBG_LIBS          (opt) (extra debug libraries - otherwise ${LIBS}; ${CLIB} and ${DEBUGLIBS} always used)
# LINK_TYPE         (opt) (variant of linking command, eg C++ - defaults to C)
# INSTTYPE          (opt) (use "tool" or "app" to install executable vs application - defaults to "tool")
# INSTAPP_FILES     (opt) (list of files to be installed in application directory - use InstRes specification rules)
# INSTAPP_DEPENDS   (opt) (list of dependencies to be satisfied before doing application install - ${TARGET} assumed if in INSTAPP_FILES)
# INSTAPP_VERSION   (opt) (list of Messages/!Run/Desc files to insert app version from VersionNum - include in INSTAPP_FILES as well)
# CUSTOMLINK        (opt) (set to "custom" to override the link rule)
# CUSTOMINSTALLAPP  (opt) (set to "custom" to override the install rule for resource files)
# CUSTOMINSTALLTOOL (opt) (set to "custom" to override the install rule for target binary)
# SOURCES_TO_LINK   (opt) (files which need be linked to by the link farm, in addition to contents of c and h directories)
d41 1
a41 1
# C + CFLAGS       (C compiler; CDFLAGS also used in debug builds; -g implicit)
d173 4
@


1.4
log
@Change back to overridable clean and dirs steps.
The CLEAN_DEPEND intermediate was added because GNU make didn't support '::' notation, but GNU nake 3.81 (possibly earlier) does as described at
  http://www.gnu.org/software/make/manual/make.html#Double_002dColon
verified with two test makefiles
# This is 'makefile'
include ./other.mk
clean::
	@@echo 1
	@@echo 2
# This is 'other.mk'
CLEANALIAS = clean
${CLEANALIAS}::
	@@echo 3
	@@echo 4
which did what was required.

Version 5.42. Tagged as 'BuildSys-5_42'
@
text
@d14 17
a30 18
# COMPONENT          (the name of the component)
# TARGET       (opt) (the leafname of the application - otherwise ${COMPONENT})
# DBG_TARGET   (opt) (debug application leafname - otherwise ${TARGET}-D)
# INSTDIR      (opt) (the target directory - otherwise ${INSTALLDIR}/${TARGET})
# DIRS         (opt) (stamp object for directory creation - otherwise _dirs)
# OBJS         (opt) (object files, no o. prefixes - otherwise ${TARGET})
# DBG_OBJS     (opt) (debug build object files, no prefixes - otherwise ${OBJS})
# LIBS         (opt) (extra libraries; CLib is always used)
# DBG_LIBS     (opt) (extra debug libraries - otherwsie ${LIBS};
#                     CLib and DEBUGLIBS always used)
# APP_OBJS     (opt) (object files for application version - otherwise derived
#                     from ${OBJS})
# APP_DBG_OBJS (opt) (object files for debug app version - otherwise derived
#                     from ${DBG_OBJS})
# LINK_TYPE    (opt) (variant of linking command, eg C++ - defaults to C)
# INSTTYPE     (opt) (use "tool" or "app" to install executable vs application - defaults to "tool")
# INSTALLAPPFILES   (opt) (list of files to be installed in application directory - use InstRes specification rules)
# INSTALLAPP_DEPEND (opt) (list of dependencies to be satisfied before doing application install - ${TARGET} assumed if in INSTALLAPPFILES)
d50 1
d70 1
d73 1
d84 3
a86 2
APP_OBJS     ?= $(addsuffix .o,${OBJS})
APP_DBG_OBJS ?= $(addsuffix .od,${DBG_OBJS})
d95 15
a109 2
all install debug clean links: ${SYMLINK_DEPEND}
ifneq (clean,${MAKECMDGOALS})
a119 1
endif
d124 1
d149 1
a149 1
${DIRS} ::
a151 5
clean ::
	@@${ECHO} Cleaning...
	@@cd .. && ${WIPE} objs ${WFLAGS}
	@@${ECHO} ${COMPONENT}: cleaned

d156 1
a156 1
INSTALLAPP_DEPEND +=  $(addsuffix ${SUFFIX_ABSOLUTE},$(filter ${TARGET},${INSTALLAPPFILES}))
d158 1
a158 1
install_app${CUSTOMINSTALLAPP}: ${INSTALLAPP_DEPEND}
d160 9
a168 5
	${INSTRES} -I Resources.${USERIF}.${LOCALE},Resources.${USERIF}.UK,Resources.${LOCALE},Resources.UK,Resources ${INSTAPP} ${INSTALLAPPFILES}
ifneq (,$(filter Desc,${INSTALLAPPFILES}))
	${CPREPRO} -I. ${INSTAPP}/Desc > ${INSTAPP}/DescTmp
	${TIDYDESC} ${INSTAPP}/Desc ${INSTAPP}/DescTmp
	${RM} ${INSTAPP}/DescTmp
d180 2
a181 2
${TARGET}${SUFFIX_ABSOLUTE}${CUSTOMLINK}: ${DIRS} ${APP_OBJS} ${APP_LIBS}
	${LD} ${LDFLAGS} -o $@@ ${APP_OBJS} ${APP_LIBS}
d185 2
a186 2
${DBG_TARGET}${SUFFIX_DEBIMAGE}${CUSTOMLINK}: ${DIRS} ${APP_DBG_OBJS} ${DBG_LIBS}
	${LD} ${LDFLAGS} ${LDDFLAGS} -o $@@ ${APP_DBG_OBJS} ${DBG_LIBS}
@


1.4.2.1
log
@Merge of trunk BuildSys-6_34 to branch RPiFreeze

Version 6.00, 1.142.2.4. Tagged as 'BuildSys-6_00-1_142_2_4'
@
text
@d14 18
a31 17
# COMPONENT               (the name of the component)
# TARGET            (opt) (the leafname of the application - otherwise ${COMPONENT})
# DBG_TARGET        (opt) (debug application leafname - otherwise ${TARGET}-D)
# INSTAPP           (opt) (the application target directory - otherwise ${INSTDIR}/!${COMPONENT})
# INSTDIR           (opt) (the target directory - otherwise ${INSTALLDIR}/${TARGET})
# DIRS              (opt) (stamp object for directory creation - otherwise _dirs)
# OBJS              (opt) (object files, no o. prefixes - otherwise ${TARGET})
# APP_OBJS          (opt) (release build object files, no prefixes - otherwise ${OBJS})
# DBG_OBJS          (opt) (debug build object files, no prefixes - otherwise ${OBJS})
# LIBS              (opt) (extra libraries; ${CLIB} is always used)
# APP_LIBS          (opt) (extra release libraries - otherwise ${LIBS}; ${CLIB} is always used)
# DBG_LIBS          (opt) (extra debug libraries - otherwise ${LIBS}; ${CLIB} and ${DEBUGLIBS} always used)
# LINK_TYPE         (opt) (variant of linking command, eg C++ - defaults to C)
# INSTTYPE          (opt) (use "tool" or "app" to install executable vs application - defaults to "tool")
# INSTAPP_FILES     (opt) (list of files to be installed in application directory - use InstRes specification rules)
# INSTAPP_DEPENDS   (opt) (list of dependencies to be satisfied before doing application install - ${TARGET} assumed if in INSTAPP_FILES)
# INSTAPP_VERSION   (opt) (list of Messages/!Run/Desc files to insert app version from VersionNum - include in INSTAPP_FILES as well)
a50 1
# INSERTVERSION    (awk script to substitute from VersionNum)
a69 1
INSTAPP      ?= ${INSTDIR}/!${COMPONENT}
a71 1
APP_OBJS     ?= ${OBJS}
d82 2
a83 3

APP_OBJS_     = $(addsuffix .o,${APP_OBJS})
DBG_OBJS_     = $(addsuffix .od,${DBG_OBJS})
d92 2
a93 15
ifeq (clean,${MAKECMDGOALS})
# With a double-colon rule which can have additional actions assigned from the
# master makefile, we'd normally need the master makefile to include the
# ${CURDIR} check to ensure that it's performed on the same invocation as us.
# However, there's no real benefit to performing clean from within the objs
# directory, and it adds an ordering problem between the different double-colon
# rules (the one that deletes the objs directory has to be last otherwise the
# cwd is invalid for the others) so to simplify things, we only ever do cleans
# from the same directory as the Makefile.
clean::
	@@echo Cleaning...
	@@rm -rf objs
	@@echo ${COMPONENT}: cleaned
else
all install debug links: ${SYMLINK_DEPEND}
d104 1
a108 1
endif
d133 1
a133 1
${DIRS}::
d136 5
d145 1
a145 1
INSTAPP_DEPENDS +=  $(addsuffix ${SUFFIX_ABSOLUTE},$(filter ${TARGET},${INSTAPP_FILES}))
d147 1
a147 1
install_app${CUSTOMINSTALLAPP}: ${INSTAPP_DEPENDS}
d149 5
a153 9
	${INSTRES} -I Resources.${USERIF}.${LOCALE},Resources.${USERIF}.UK,Resources.${LOCALE},Resources.UK,Resources ${INSTAPP} ${INSTAPP_FILES}
ifneq (,$(filter Messages,${INSTAPP_VERSION}))
	TMP=`mktemp`; ${INSERTVERSION} ${INSTAPP}/Messages > $$TMP; mv $$TMP ${INSTAPP}/Messages
endif        
ifneq (,$(filter Desc,${INSTAPP_VERSION}))
	TMP=`mktemp`; ${INSERTVERSION} descmode=1 ${INSTAPP}/Desc ${INSTAPP}/Desc > $$TMP; mv $$TMP ${INSTAPP}/Desc
endif        
ifneq (,$(filter !Run,${INSTAPP_VERSION}))
	TMP=`mktemp`; ${INSERTVERSION} obeymode=1 ${INSTAPP}/!Run${SUFFIX_OBEY} > $$TMP; mv $$TMP ${INSTAPP}/!Run${SUFFIX_OBEY}
d165 2
a166 2
${TARGET}${SUFFIX_ABSOLUTE}${CUSTOMLINK}: ${DIRS} ${APP_OBJS_} ${APP_LIBS}
	${LD} ${LDFLAGS} -o $@@ ${APP_OBJS_} ${APP_LIBS}
d170 2
a171 2
${DBG_TARGET}${SUFFIX_DEBIMAGE}${CUSTOMLINK}: ${DIRS} ${DBG_OBJS_} ${DBG_LIBS}
	${LD} ${LDFLAGS} ${LDDFLAGS} -o $@@ ${DBG_OBJS_} ${DBG_LIBS}
@


1.3
log
@  Fixes to shared makefiles
Detail:
  The change which permitted top-level makefiles to include only CApp,
  CModule etc accidentally broke makefiles which included HostTools (StdTools
  got included instead and overwrote the HostTools settings). Amazingly, we
  seem to have got away with this so far - but fixed now. Also, brought the
  GNUmakefiles versions in line with updates to the amu Makefiles in this
  and other respects.
Admin:
  Tested in a RISC OS ROM build, and for building cross-compiling versions
  of the tools.

Version 5.21. Tagged as 'BuildSys-5_21'
@
text
@a27 1
# CLEAN_DEPEND (opt) (phony target for additional clean actions)
d133 1
a133 1
${DIRS}:
d136 1
a136 1
clean :: ${CLEAN_DEPEND}
@


1.2
log
@  Makefile bugfixes, and support for latest CTools build
Detail:
  * Fixed dependencies for debug builds in GNUmakefiles/CApp
  * Added -f switch to rm in GNUmakefiles/StdTools to make it fail silently
    if the file doesn't exist, like the RISC OS version
  * Fix for amu complaining if INSTTYPE is undefined in Makefiles/CApp
  * Reflected makefile changes in resgen, squeeze and xpand in CTools
    component file
  * Added a8time to ModuleDB and CTools component file
Admin:
  Tested in  a C Tools build

Version 5.03. Tagged as 'BuildSys-5_03'
@
text
@d2 3
d33 1
d74 1
d78 1
a78 1
LIBS         += ${C++LIB}
d81 1
a81 1
LIBS         += ${CLIB}
d100 1
a100 1
			[ -d ${linksource} ] || [ -L $$linkdest ] || ${MKDIR} $$linkdestdir; \
d106 1
a106 1
	@@[ -d objs ] || ${MKDIR} objs
d115 16
d166 2
a167 2
${TARGET}${SUFFIX_ABSOLUTE}: ${DIRS} ${APP_OBJS} ${LIBS}
	${LD} ${LDFLAGS} -o $@@ ${APP_OBJS} ${LIBS}
d171 1
a171 1
${DBG_TARGET}${SUFFIX_DEBIMAGE}: ${DIRS} ${APP_DBG_OBJS} ${DBG_LIBS}
@


1.1
log
@  Changes to facilitate platform independence.

Detail:
 CApp:
  * New variable CLEAN_DEPEND is now the preferred way to specify additional
    clean actions because GNU make doesn't have an equivalent to amu's :: rules
  * Can now indicate preference to use C++ linker options using LINK_TYPE
  * Gains install phase support:
    + INSTALLAPPFILES lists the files to be copied, effectively specified
      relative to LocalRes$Path
    + Adopted INSTTYPE concept from DDE makefiles for cases where executable
      and support files need to be installed to different locations
    + Unusual cases can override this implementation using CUSTOMINSTALLAPP
      and/or CUSTOMINSTALLTOOL

  CLibrary:
  * New variable CLEAN_DEPEND is now the preferred way to specify additional
    clean actions because GNU make doesn't have an equivalent to amu's :: rules
  * -o is no longer a mandatory argument to libfile - now in ARFLAGS rather
    than used explicitly

  DbgRules / StdRules:
  * Macroised some Norcroft-specific features

  HostTools:
  * Clean phase support was incomplete

  StdTools:
  * A few additional tool definitions
  * Added macro definitions for common C options
  * C's enable-warnings and suppress-function-name-embedding options now on by
    default because they're usually (maybe even universally?) used - it won't
    hurt if they're specified again by existing makefiles
  * C++ now has equivalent INCLUDES and DEFINES variables, and the standard C++
    headers are on the default include path
  * SEP is defined as the directory separator character and can be used from
    top-level makefiles in a platform-independent way

  Functionally equivalent versions of the following makefile fragments
  have been developed so far for executing on a Posix build host:
    AppLibs, CApp, CLibrary, DbgRules, HostTools, StdRules, StdTools
  These suport native compilers (when APCS=Host) and cross-compilers,
  and GCC (when TOOLCHAIN=GNU) and Norcroft toolchains - typically these
  environment variables would be selected by running an Env file.

Admin:
  Tested by building as many as possible of the DDE components on RISC OS
  and on Linux, using native and cross compilers, and using Norcroft and
  GNU toolchains.

Version 5.01. Tagged as 'BuildSys-5_01'
@
text
@d153 3
@

