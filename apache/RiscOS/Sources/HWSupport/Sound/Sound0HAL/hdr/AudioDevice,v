head	1.4;
access;
symbols
	Sound0HAL-1_88:1.4
	Sound0HAL-1_87:1.4
	Sound0HAL-1_86:1.4
	Sound0HAL-1_85:1.4
	Sound0HAL-1_84:1.4
	Sound0HAL-1_83:1.4
	Sound0HAL-1_82:1.4
	Sound0HAL-1_81:1.4
	Sound0HAL-1_80:1.3
	Sound0HAL-1_79:1.2
	Sound0HAL-1_78:1.2
	Sound0HAL-1_77:1.2
	Sound0HAL-1_76:1.2
	Sound0HAL-1_75:1.2
	Sound0HAL-1_74:1.2
	Sound0HAL-1_73:1.2
	Sound0HAL-1_72:1.2
	Sound0HAL-1_71:1.2
	Sound0HAL-1_70:1.1
	Sound0HAL-1_69:1.1
	Sound0HAL-1_68:1.1
	Sound0HAL-1_67:1.1
	Sound0HAL-1_66:1.1
	Sound0HAL-1_65:1.1;
locks; strict;
comment	@# @;


1.4
date	2015.12.01.20.47.59;	author jlee;	state Exp;
branches;
next	1.3;
commitid	oU5pl7g7AqO7RhLy;

1.3
date	2015.04.06.09.00.32;	author rsprowson;	state Exp;
branches;
next	1.2;
commitid	PyFQBqFap0bpCvgy;

1.2
date	2012.08.14.23.38.09;	author jlee;	state Exp;
branches;
next	1.1;
commitid	XmeKVINrv8U0vzgw;

1.1
date	2010.01.16.03.53.44;	author jlee;	state Exp;
branches;
next	;


desc
@@


1.4
log
@Add device enumeration and selection APIs. Make audio HAL device API more flexible. Add a generic software mixer implementation that can be used for devices where no hardware mixer is available.
Detail:
  Makefile - Include new source files. Export a C version of hdr/Sound.
  Resources/* - Add new error text to messages file and update command help text
  Version - Update MaxDeviceVersion. Add MinDeviceVersion definition to get rid of a magic constant from the code. Add new switch for whether software mixer support is enabled.
  hdr/AudioDevice - Extend with audio device API 3 features. Buffer size granularity can now be non-power of 2 values, and CustomDMA can be used in a synchronous manner instead of an asynchronous manner (asynchronous defers buffer filling to an RTSupport routine, synchronous performs it directly from within the callback from the device). Also correct a comment relating to AudioRateTable_Frequency.
  hdr/Sound - Add new SWIs and reason codes. Protect a portion of the header from being processed by Hdr2H (Hdr2H can't handle it)
  s/Sound0 - Change default sample rate & buffer size settings to 22050Hz (none of the hardware currently supported by this version of the module supports 20833Hz). Add implementations of the new SWIs and features. Tidy up a couple of other bits.
  s/Sound0NEON - Refactor post-processing code to add support for the software mixer - code is now generated by macros rather than copy & paste. Fix indentation of some other code sections.
  s/DeviceList - New file to contain code related to managing the list of audio devices that SoundDMA now keeps.
  s/SoftMix - New file containing the software mixer device implementation. Implements a single mixer channel to control the overall gain of the sound system. Mixing/volume scaling is performed by the buffer post-processing sequences in Sound0ARM/Sound0NEON, with the optimisation of skipping the processing for a gain of +0dB. Note however that Sound0ARM has yet to be updated and so software mixing is currently only available for the NEON version of the module.
Admin:
  Tested in iMX6 ROM
  German resources are in need of translation


Version 1.81. Tagged as 'Sound0HAL-1_81'
@
text
@; Copyright 2010 Castle Technology Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;

; Public interface (ie interface to SoundDMA) of DMA audio controller devices

        GET     hdr:HALDevice

OldOpt  SETA    {OPT}
        OPT     OptNoList+OptNoP1List

 [ :LNOT: :DEF: Included_Hdr_AudioDevice
                         GBLL Included_Hdr_AudioDevice
Included_Hdr_AudioDevice SETL {TRUE}

; Device for each DMA controller

                                ^       0
                                #       HALDeviceSize
HALDevice_AudioMixer            #       4
HALDevice_AudioChannelsOut      #       4
HALDevice_AudioChannelsIn       #       4
HALDevice_Audio_Size            *       :INDEX: @@
; Extra data for API 1
HALDevice_AudioDMAParams        #       20 ; Values of R0, R1, R2, R3, R7 to pass to DMA_RegisterChannel
HALDevice_AudioPreEnable        #       4 ; Called before DMA is enabled. R1=DMA buffer size.
HALDevice_AudioPostEnable       #       4 ; Called after DMA is enabled. R1=DMA buffer size.
HALDevice_AudioPreDisable       #       4 ; Called before DMA is disabled.
HALDevice_AudioPostDisable      #       4 ; Called after DMA is disabled.
HALDevice_AudioIRQHandle        #       4 ; IRQ handler. On exit, r0=0 for OK, r0=1 for audio reset required.
HALDevice_AudioNumRates         #       4 ; Number of supported sample rates
HALDevice_AudioRateTable        #       4 ; Pointer to sample rate table
HALDevice_AudioSetRate          #       4 ; Call with R1=0-based sample rate idx
HALDevice_Audio_Size_1          *       :INDEX: @@
; Extra data for API 2
HALDevice_AudioCustomDMAEnable  #       4 ; PreEnable+PostEnable replacement for systems that don't use DMAManager. R1=DMA buffer size, R2=first buffer, R3=second buffer, SP+0=callback param, SP+4=callback func
HALDevice_AudioFlags            #       4 ; Extra flags
HALDevice_AudioMinBuffSize      #       4 ; Minimum buffer size, bytes
HALDevice_AudioBuffAlign        #       4 ; Alignment/granularity of buffer (bytes, power of 2 for API 2, non-power of 2 supported by API 3+)
HALDevice_Audio_Size_2          *       :INDEX: @@

; Sample rate table format
                                ^       0
AudioRateTable_Frequency        #       4 ; Frequency in Hz*1024
AudioRateTable_Period           #       1 ; Period in usec
AudioRateTable_Reserved         #       3 ; Reserved - can be used by audio device
AudioRateTableSize              *       :INDEX: @@

; Flags

AudioFlag_StereoReverse         *       1 ; If set, data needs to be supplied L-R-L-R instead of VIDC style R-L-R-L
AudioFlag_Synchronous           *       2 ; For CustomDMA mode: If set, SoundDMA should perform its processing in a synchronous manner from within the callback function, rather than postponing to an RTSupport routine (requires API 3+)

; Return values for IRQHandle entry

AudioIRQHandle_NOP              *       0 ; Do nothing further
AudioIRQHandle_RequestReset     *       1 ; Turn it off and on again

 ]

        OPT     OldOpt
        END
@


1.3
log
@Rename exported flags
Inspection of DMADevice/GPIODevice/RTCDevice suggests the equivalent of C structs become HALDeviceTHING and enums become THINGFlagName. Rename AudioDevice's flags ot match that pattern.
No code change, not tagged.
@
text
@d50 1
a50 1
HALDevice_AudioBuffAlign        #       4 ; Alignment/granularity of buffer (bytes, power of 2)
d55 1
a55 1
AudioRateTable_Frequency        #       4 ; Frequency in Hz
d63 1
@


1.2
log
@Update audio controller API to version 2
Detail:
  hdr/AudioDevice - extended audio device structure for API version 2. This adds support for controllers that don't use DMAManager, runtime selection of stereo reversal, and device-dictated buffer minimum size & granularity constraints
  Version, s/Sound0, s/Sound0ARM, s/Sound0NEON - Stripped out StereoReverse compile-time switch, adding support for runtime selection instead. Added support for other new features of device API version 2.
Admin:
  Tested on Raspberry Pi with high processor vectors


Version 1.71. Tagged as 'Sound0HAL-1_71'
@
text
@d54 5
a58 5
                                       ^     0
HALDevice_AudioRateTable_Frequency     #     4 ; Frequency in Hz
HALDevice_AudioRateTable_Period        #     1 ; Period in usec
HALDevice_AudioRateTable_Reserved      #     3 ; Reserved - can be used by audio device
HALDevice_AudioRateTableSize           *     :INDEX: @@
d62 6
a67 1
HALDevice_AudioFlag_StereoReverse   *   1 ; If set, data needs to be supplied L-R-L-R instead of VIDC style R-L-R-L
@


1.1
log
@Add initial version of new SoundDMA module, 'Sound0HAL'
Detail:
  Based on the Sound0Trid source code, this version of SoundDMA makes use of a new version of the audio controller HAL device API. Briefly:
  * DMA is handled by the HALified DMAManager
  * The DMASync callback is used to trigger audio buffer filling
  * The set of available sample rates is dictated by the audio controller device
  * Basic support for resetting the audio when an error occurs (e.g. FIFO under/overflow causing stereo channels to be swapped)
  * Module is now ARMv6/7-safe, due to use of LDR(S)H instead of unaligned loads. This comes at the cost of losing RiscPC compatability. Can be disabled if needed via setting UseLDRSH to false.
  * To keep the code simple, it only accepts devices which use the new API version.
  * Sound0Enable now enables IRQs for most of its execution, to allow for supporting slow devices (e.g. IIC communications with the TPS65950). The PRMs describe Sound_Enable as having undefined reentrancy & IRQ state, so this should be OK with regards to code compatability.
  * The stereo reverse code still needs to be made ARMv6/v7-safe, as well as (preferably) being something that can be selectively enabled at runtime, depending on the audio controller in use
  * The oversampling code is disabled, much as it was in Sound0Trid.
  * The pipelining of sample rate changes that Sound0Trid performed is gone - partly to keep the code simple, and partly because it wouldn't work too well with the TPS65950 (due to the intermediate FIFO that the samples pass through, and the fact that the TPS audio codec must be turned off to change the sample rate)
Admin:
  Tested on rev C2 beagleboard.


Version 1.65. Tagged as 'Sound0HAL-1_65'
@
text
@d46 6
d59 4
a62 1
                                       
@

