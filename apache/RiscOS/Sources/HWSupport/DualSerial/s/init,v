head	4.5;
access;
symbols
	DualSerial-0_25-4_8_2_16-1:4.4.4.4
	DualSerial-0_25-4_8_2_16:4.4.4.4
	DualSerial-0_25-4_8_2_15:4.4.4.4
	DualSerial-0_25-4_8_2_14:4.4.4.4
	DualSerial-0_25-4_8_2_13:4.4.4.4
	DualSerial-0_25-4_8_2_12:4.4.4.4
	DualSerial-0_25-4_8_2_11:4.4.4.4
	DualSerial-0_29:4.5
	DualSerial-0_25-4_8_2_10:4.4.4.3
	RO_5_07:4.4.4.2
	DualSerial-0_28:4.5
	DualSerial-0_25-4_8_2_9:4.4.4.2
	DualSerial-0_25-4_8_2_8:4.4.4.2
	DualSerial-0_25-4_8_2_7:4.4.4.2
	DualSerial-0_25-4_8_2_6:4.4.4.1
	DualSerial-0_27:4.5
	DualSerial-0_25-4_8_2_5:4.4.4.1
	DualSerial-0_25-4_8_2_4:4.4.4.1
	DualSerial-0_25-4_8_2_3:4.4.4.1
	DualSerial-0_25-4_8_2_2:4.4.4.1
	DualSerial-0_25-4_8_2_1:4.4
	HAL:4.4.0.4
	DualSerial-0_26:4.5
	DualSerial-0_25:4.4
	kbracey_32bit_merge:4.4
	DualSerial-0_24-4_7_2_4:4.4
	DualSerial-0_24-4_7_2_3:4.4
	DualSerial-0_24-4_7_2_2:4.4
	dellis_autobuild_BaseSW:4.4
	DualSerial-0_24-4_7_2_1:4.4
	kbracey_32bit:4.4.0.2
	DualSerial-0_24:4.4
	sbrodie_sedwards_16Mar2000:4.4
	DualSerial-0_23:4.4
	dcotton_autobuild_BaseSW:4.5
	DualSerial-0_22:4.3
	DualSerial-0_21:4.3
	DualSerial-0_18:4.3
	Daytona_merge:4.1.6.2
	DualSerial-0_17:4.2
	rthornb_UrsulaBuild-15Jul1998:4.1
	rthornb_UrsulaBuild-07Jul1998:4.1
	rthornb_UrsulaBuild-17Jun1998:4.1
	rthornb_UrsulaBuild-03Jun1998:4.1
	rthornb_UrsulaBuild-27May1998:4.1
	rthornb_UrsulaBuild-21May1998:4.1
	rthornb_UrsulaBuild_01May1998:4.1
	afrost_NC2_Generic:4.1.7.1
	Spinner_B20_2:4.1.7.1
	Spinner_19_3:4.1.7.1
	Spinner_B18:4.1.7.1
	Spinner_B17:4.1.7.1
	Spinner_B15:4.1.7.1
	Spinner_B14:4.1.7.1
	Spinner_B13:4.1.7.1
	Spinner_B12:4.1.7.1
	Spinner_B10:4.1.7.1
	Daytona:4.1.0.6
	Daytona_bp:4.1
	Ursula:4.1.0.4
	Ursula_bp:4.1
	Spinner_B7:4.1.7.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	ARTtmp:4.1.7.1.0.2
	RCA:4.1.0.2
	Spin_merge:4.1.7.1
	MergeFiles:4.1.7.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1;
locks; strict;
comment	@# @;


4.5
date	2001.03.16.15.55.52;	author sbrodie;	state Exp;
branches;
next	4.4;

4.4
date	99.10.26.09.22.15;	author kbracey;	state Exp;
branches
	4.4.4.1;
next	4.3;

4.3
date	98.09.29.13.30.05;	author kbracey;	state Exp;
branches;
next	4.2;

4.2
date	98.09.21.14.21.55;	author kbracey;	state Exp;
branches;
next	4.1;

4.1
date	96.11.21.12.06.25;	author nturton;	state Exp;
branches
	4.1.4.1
	4.1.5.1
	4.1.6.1
	4.1.7.1;
next	;

4.4.4.1
date	2001.03.20.13.13.47;	author kbracey;	state Exp;
branches;
next	4.4.4.2;

4.4.4.2
date	2003.03.31.09.28.07;	author rsprowson;	state Exp;
branches;
next	4.4.4.3;

4.4.4.3
date	2009.06.11.21.16.08;	author bavison;	state Exp;
branches;
next	4.4.4.4;

4.4.4.4
date	2012.06.04.23.36.13;	author jlee;	state Exp;
branches;
next	;
commitid	lqDFJl0aX8rOLr7w;

4.1.4.1
date	98.07.21.13.36.44;	author wturner;	state dead;
branches;
next	;

4.1.5.1
date	96.11.21.12.06.25;	author nturton;	state Exp;
branches;
next	;

4.1.6.1
date	97.07.07.13.27.26;	author blaughto;	state Exp;
branches;
next	4.1.6.2;

4.1.6.2
date	97.07.11.07.12.17;	author blaughto;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.20.45.40;	author nturton;	state Exp;
branches;
next	;


desc
@@


4.5
log
@  Updated build structure to use the shared AAsmModule makefile.
  Updated to build using objasm instead of aasm.
  Sources changed to be objasm-compatible.
Admin:
  Requires Library 0.71 or later.
  Requires BuildSys 3.06 or later.
  Requires Env 0.65 or later.

Version 0.26. Tagged as 'DualSerial-0_26'
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
;
; 		Copyright 1996 Acorn Network Computing
;
;  This material is the confidential trade secret and proprietary
;  information of Acorn Network Computing. It may not be reproduced,
;  used, sold, or transferred to any third party without the prior
;  written consent of Acorn Network Computing. All rights reserved.
;
; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
;
;    Author	  : R.W.Buckley
;    Date         : 22-Apr-96
;
; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
;
; Modification History
;
; Ver	Date		Who	Description
; 0.02	21-May-96	RWB	Slight tweeks to ioctls
; 0.03	22-May-96	RWB	Sorted out redundant error messages
; 0.04	22-May-96	RWB	Default to 9600 baud
;				Register for threshold upcalls on in/out streams
;				Check stream handles on threshold halt/resume
; 0.05  28-May-96	RWB	Register for device upcalls from DeviceFS
;				Re-assert handshake control lines on new stream
; 0.06  31-May-96	SMC	Fixed module help string for brain-dead Kernel
; 0.07  03-Jun-96	RWB	Generate serial event on serial error
; 0.08  06-Jun-96	RWB	Corrected some error reporting, changed probe
;				slightly.
; 0.09  10-Jun-96	RWB	Fixed bug that occured when errors are found
;				during module initialisation.
; 0.10  14-Jun-96 	RWB	Added file handle to Error event call
; 0.11  01-Jul-96	RWB	Changed date format in version file
; 0.12  23-Jul-96	SC,RWB  Moved release device vector in finalisation code
; 0.13  02-Aug-96       RWB     Discovered the messages file was being put in
;				the wrong place.
;				Added check for open streams on module finalis.
; 0.14  05-Aug-96	RWB     Use allocated error block number for errors.
; 0.15  06-Aug-96	RWB	Only register with devicefs if not already
;				registered. This was a problem when service call
;				DeviceFSStarting goes round.
;				Changed the value for an invalid internal buffer
;				handle.
; 0.16  25-Oct-96	RWB	Introduced IOCtls to enumerate the available baud
;				rates.
; 0.17  13-Dec-96       SBF     Corrected bug which inhibited the 50bps baud
;                               rate from being selected.
; 0.18  21-Jan-97	RWB	Fixed problem killing module when one serial
;				port.
; 0.19  04-Jul-97       BAL     Made buffer threshold changes take effect
;                               immediately instead of next time a stream is
;                               opened.
; 0.20  10-Jul-97       BAL     Fixed problem killing module when two serial
;                               ports.
;                               Added IOCtl to flush a buffer.
; 0.23  26-Oct-99       KJB     Added support for "type-2" serial ports - the
;                               interrupt is in a different place.
; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
;
; Global header files
;
                GET     Hdr:ListOpts
		OPT	OptNoList
                GET     Hdr:NdrDebug		; definition of true
                GET     Hdr:Macros		; system wide macro definitions
                GET     Hdr:System		; swis and hardware declarations
		GET	Hdr:Machine.<Machine>	; for machine-specific flags
                GET     Hdr:ModHand		; Module handler reason codes
                GET     Hdr:FSNumbers           ; for NewErrors
                GET     Hdr:NewErrors           ; for global errors
                GET     Hdr:HighFSI		; high level filing system
                GET     Hdr:DevNos		; device no for new IRQ handling
                GET     Hdr:Services		; service call info
                GET     Hdr:Symbols		; constants TRUE, FALSE, VFlag
                GET     Hdr:MsgTrans		; MessageTrans constants
                GET     Hdr:Proc                ; ENTRY and EXIT macros
		GET	Hdr:Buffer
                GET     Hdr:ResourceFS
                GET     Hdr:DeviceFS		; reason code definitions
		GET     Hdr:IO.IOEB
		GET	Hdr:RS423		; need serial error flags
		$GetIO				; I need IOMD declarations etc

; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
;
; Global variables
;
 		 	GBLL	debug
		 	GBLL	border_handshake
			GBLL	counting

debug 		 	SETL	false	; to include debug macros
border_handshake 	SETL	false	; to flash border when handshaking
counting		SETL	false	; to count stuff

; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
;
; Debug header files
;
		GBLS	conditional_get
 [ debug
conditional_get	SETS	"GET 	Hdr:Debug"		; Standard debug macros
 |
conditional_get SETS	""
 ]
		$conditional_get

                GBLL    standalonemessages
 [ :DEF: standalone
standalonemessages SETL standalone
 |
standalonemessages SETL {FALSE}
 ]


; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
;
; User header files
;
		OPT 	OptList

                GET     VersionASM
		GET 	s.errors	; error handling stuff
		GET	s.macros	; some useful macros
                GET     s.main		; module interfaces
		GET 	s.hardware	; hardware detection and irq stuff
		GET 	s.interrupts	; handle irqs
		GET	s.devicecall 	; handle devicefs stuff

; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
;
; Debug routine code
;
 [ debug
      		InsertDebugRoutines     ; ensure this is after module header !
 ]

; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

                END
@


4.4
log
@Added support for serial ports on device 9, as well as the traditional 10.

Version 0.23. Tagged as 'DualSerial-0_23'
@
text
@a123 1
 [ :LNOT: :DEF: standalonemessages
d125 3
a127 1

d130 1
a130 1
                LEADR   Module_LoadAddr
@


4.4.4.1
log
@Second attempt to check this in.

Version 0.25, 4.8.2.2. Tagged as 'DualSerial-0_25-4_8_2_2'
@
text
@a97 1
                GET     Hdr:HALEntries
a104 1
                        GBLL    nohal_debug
a108 1
nohal_debug             SETL    false   ; extra debugging for HALless debugging
@


4.4.4.2
log
@Change to use objasm (the non HAL one already has): fixes report that
it blew messagetrans away when rmkilled.
Change to have a zero in the command table word: fixes report that
serialinfo and serialtest don't do anything,indeed they don't in this
HAL version!

Version 0.25, 4.8.2.7. Tagged as 'DualSerial-0_25-4_8_2_7'
@
text
@d92 1
a92 1
                GET     Hdr:Proc                ; Entry and EXIT macros
d127 1
d129 1
a129 3
 [ :DEF: standalone
standalonemessages SETL standalone
 |
d132 1
a132 1

@


4.4.4.3
log
@  GET file pathnames changed
Detail:
  Uses suffixed file extensions for compatiblity with both objasm and asasm.
Admin:
  Supplied by Peter Naulls, tested at ROOL

Version 0.25, 4.8.2.10. Tagged as 'DualSerial-0_25-4_8_2_10'
@
text
@d142 6
a147 6
		GET 	errors.s	; error handling stuff
		GET	macros.s	; some useful macros
                GET     main.s		; module interfaces
		GET 	hardware.s	; hardware detection and irq stuff
		GET 	interrupts.s	; handle irqs
		GET	devicecall.s 	; handle devicefs stuff
@


4.4.4.4
log
@Rewrite module to add support for acting as a client of SerialSupport
Detail:
  In order to act as a client of SerialSupport, DualSerial needs to support the set of device calls that SerialSupport uses to talk to the serial driver.
  This set of device calls operates at a lower level than the IOCtl interface which DualSerial already supports.
  Therefore simply adding the new device call interface ontop of DualSerial (or modifying SerialSupport to add IOCtl support) would have been a risky venture, due to the many complexities hidden in the Serial module sources.
  So to reduce the amount of risk inherent in the change, I've instead taken the Serial module, stripped out 6551 support, rewritten the 710 interface to use HAL calls, and then bolted the IOCtl interface on top.
  This should ensure the SerialSupport/OS_SerialOp interface is identical to that provided by the Serial module, and only the simpler to understand DualSerial/IOCtl interface is the one likely to contain any bugs.
  File changes:
  - Docs/serial.htm - Added a copy of the IOCtl interface docs, from the Ursula branch
  - s/common, s/errors, s/init, s/macros, s/main - New implementation of the module, based around modified Serial sources
  - s/serialhal - The business end of the module, based around s/Serial710 in the Serial sources
  - s/ioctl - New file containing reimplemented IOCtl interface
  - s/devicecall, s/hardware, s/interrupts, s/standalone - Deleted redundant files from old implementation
  - Makefile - Trimmed somewhat redundant comment
  - resources/UK/messages - Added new error messages
Admin:
  Tested in OMAP3 & Tungsten ROMs


Version 0.25, 4.8.2.11. Tagged as 'DualSerial-0_25-4_8_2_11'
@
text
@d15 58
a72 1
; > Serial
d74 4
d79 15
a93 22
                GET     Hdr:Macros
                GET     Hdr:System
                GET     Hdr:ModHand
                GET     Hdr:Machine.<Machine>
                GET     Hdr:FSNumbers
                GET     Hdr:HighFSI
                GET     Hdr:NewErrors
                GET     Hdr:DevNos
                GET     Hdr:Services
                GET     Hdr:Symbols
                GET     Hdr:UpCall
                GET     Hdr:NdrDebug
                GET     Hdr:DDVMacros
                GET     Hdr:CMOS
                GET     Hdr:DeviceFS
                GET     Hdr:Serial
                GET     Hdr:RS423
                GET     Hdr:Buffer
                $GetIO
                GET     Hdr:IO.IOEB
                GET     Hdr:MsgTrans
                GET     Hdr:Proc
d95 3
a97 1
                GET     Hdr:Portable
d99 1
a99 2
                GET     Hdr:HostFS
                GET     Hdr:OsBytes
d101 13
a113 1
                AREA    |Serial$$Code|,  CODE, READONLY, PIC
d115 11
a125 13
                GBLL    debug
                GBLL    hostvdu
                GBLL    international
                GBLL    NewSplitScheme  ; if true, always sets hardware baud rate to RX rate
                                        ;          can set TX to something different and it
                                        ;          reads back what you set
                                        ;          opening TX stream with split baud rates gives error
                                        ; if false, always sets both rates to what you just set (RX or TX)
                                        ;          doesn't give an error from open
                GBLL    KickSerialTX    ; kick serial TX on 710/665 to work round TX irqs stopping for no reason
                GBLL    Fix710TXEnable  ; on 710 must write with TX enable clear before set
                GBLL    NewTXStrategy   ; always use FIFOs if enabled but if TX rate <= 19200 then only TX one byte at a time
                GBLL    PowerControl    ; enable power control calls
d135 13
a147 8
debug           SETL    false
hostvdu         SETL    false
international   SETL    true
NewSplitScheme  SETL    false           ; (mainly because vt220 can't cope with an error from SerialOp(3))
KickSerialTX    SETL    true
Fix710TXEnable  SETL    :LNOT: KickSerialTX     ; not needed if KickSerialTX is true
NewTXStrategy   SETL    true
PowerControl    SETL    false           ; (needs HAL interface defining)
d151 5
a155 11
; debug options


init            SETD    false           ; for module startup etc...
final           SETD    false           ; for module finalisation...
baud710         SETD    false           ; debugging the 710 baud setup
flags710        SETD    true            ; flag control on 710
inter           SETD    false           ; debugging of internationalisation
interface       SETD    false           ; debugging the DeviceFS to devices
open            SETD    false           ; debugging stream opening
close           SETD    false           ; debugging stream closing
d157 3
a159 11
                GET     VersionASM
                GET     macros.s
                GET     errors.s
                GET     main.s
                GET     common.s
                GET     serialhal.s
                GET     ioctl.s

              [ debug
                InsertNDRDebugRoutines
              ]
@


4.3
log
@Daytona branch merged.

Version 0.18. Tagged as 'DualSerial-0_18'
@
text
@d70 2
d85 2
@


4.2
log
@Makefile changed to use LocalRes$Path.
Changed to use srccommit.
Spinner branch merged.

Version 0.17. Tagged as 'DualSerial-0_17'
@
text
@d53 1
a53 1
; 0.15  06-Aug-96	RWB	Only register with devicefs if not alrealy
d58 12
@


4.1
log
@Initial revision
@
text
@d121 1
a121 1
                GET     Version
@


4.1.4.1
log
@Rightio, we'll try for a real log this time...

Files deleted due to CVSs incompetency in replacing them with newer
differently named ones. Next, you'll see the new files arrive, with
a more descriptive log of what & why.
@
text
@@


4.1.6.1
log
@Made buffer threshold changes take effect immediately instead of next time a stream is opened.
@
text
@d53 1
a53 1
; 0.15  06-Aug-96	RWB	Only register with devicefs if not already
a57 10
; 0.16  25-Oct-96	RWB	Introduced IOCtls to enumerate the available baud
;				rates.
; 0.17  13-Dec-96       SBF     Corrected bug which inhibited the 50bps baud
;                               rate from being selected.
; 0.18  21-Jan-97	RWB	Fixed problem killing module when one serial
;				port.
; 0.19  04-Jul-97       BAL     Made buffer threshold changes take effect
;                               immediately instead of next time a stream is
;                               opened.
;
@


4.1.6.2
log
@Fixed problem killing module when two serial ports.  Added IOCtl to flush a
buffer.
@
text
@d67 1
a67 3
; 0.20  10-Jul-97       BAL     Fixed problem killing module when two serial
;                               ports.
;                               Added IOCtl to flush a buffer.
@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@@


4.1.5.1
log
@Import from SrcFiler
@
text
@@
