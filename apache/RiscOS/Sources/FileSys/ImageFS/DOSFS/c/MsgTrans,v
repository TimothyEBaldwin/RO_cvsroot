head	4.5;
access;
symbols
	DOSFS-1_14:4.5
	DOSFS-1_13:4.5
	DOSFS-1_12:4.5
	DOSFS-1_11:4.5
	DOSFS-1_10:4.5
	DOSFS-1_09:4.5
	DOSFS-1_08:4.5
	DOSFS-1_07:4.5
	DOSFS-1_06:4.4
	DOSFS-1_05:4.4
	DOSFS-1_04:4.4
	DOSFS-1_03:4.4
	DOSFS-1_02:4.4
	DOSFS-1_01:4.4
	DOSFS-1_00:4.3
	DOSFS-0_99:4.3
	DOSFS-0_98:4.3
	DOSFS-0_97:4.2
	DOSFS-0_96:4.2
	DOSFS-0_95:4.1
	DOSFS-0_94:4.1
	DOSFS-0_93:4.1
	DOSFS-0_92:4.1
	DOSFS-0_91:4.1
	DOSFS-0_90:4.1
	DOSFS-0_89:4.1
	DOSFS-0_88:4.1
	DOSFS-0_87:4.1
	DOSFS-0_86:4.1
	DOSFS-0_85:4.1
	DOSFS-0_84:4.1
	DOSFS-0_83:4.1
	DOSFS-0_82:4.1
	DOSFS-0_81:4.1
	DOSFS-0_80:4.1
	DOSFS-0_79:4.1
	RO_5_07:4.1
	DOSFS-0_78:4.1
	DOSFS-0_77:4.1
	DOSFS-0_76:4.1
	DOSFS-0_75:4.1
	DOSFS-0_74:4.1
	DOSFS-0_73:4.1
	DOSFS-0_72:4.1
	DOSFS-0_71:4.1
	DOSFS-0_70:4.1
	DOSFS-0_69:4.1
	DOSFS-0_68:4.1
	DOSFS-0_67:4.1
	DOSFS-0_66:4.1
	DOSFS-0_65:4.1
	dellis_autobuild_BaseSW:4.1
	sbrodie_sedwards_16Mar2000:4.1
	dcotton_autobuild_BaseSW:4.1
	DOSFS-0_64:4.1
	mstphens_UrsulaRiscPCBuild_20Nov98:4.1
	Ursula_RiscPC:4.1.0.8
	nicke_DOSFS_0_63:4.1.7.1
	rthornb_UrsulaBuild-19Aug1998:4.1
	UrsulaBuild_FinalSoftload:4.1
	rthornb_UrsulaBuild-12Aug1998:4.1
	aglover_UrsulaBuild-05Aug1998:4.1
	rthornb_UrsulaBuild-29Jul1998:4.1
	rthornb_UrsulaBuild-22Jul1998:4.1
	hsimons_BOCA-1_2-Release:4.1.7.1
	rthornb_UrsulaBuild-15Jul1998:4.1
	rthornb_UrsulaBuild-07Jul1998:4.1
	rthornb_UrsulaBuild-17Jun1998:4.1
	rthornb_UrsulaBuild-03Jun1998:4.1
	rthornb_UrsulaBuild-27May1998:4.1
	rthornb_UrsulaBuild-21May1998:4.1
	rthornb_UrsulaBuild_01May1998:4.1
	Spinner_RCA116:4.1.7.1
	Spinner_B20_2:4.1.7.1
	Spinner_19_3:4.1.7.1
	Spinner_B18:4.1.7.1
	Spinner_B17:4.1.7.1
	Spinner_B15:4.1.7.1
	Spinner_B14:4.1.7.1
	Spinner_B13:4.1.7.1
	Spinner_B12:4.1.7.1
	Spinner_B10:4.1.7.1
	Daytona:4.1.0.6
	Daytona_bp:4.1
	Ursula:4.1.0.4
	Ursula_bp:4.1
	Spinner_B7:4.1.7.1
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	RCA_bp:4.1
	ARTtmp:4.1.7.1.0.2
	RCA:4.1.0.2
	Spin_merge:4.1.7.1
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.5
date	2014.06.25.20.13.35;	author rsprowson;	state Exp;
branches;
next	4.4;
commitid	E7yWETwfWvNEvWFx;

4.4
date	2013.01.13.18.57.33;	author rsprowson;	state Exp;
branches;
next	4.3;
commitid	IcVKoGKFReBN35Aw;

4.3
date	2013.01.13.18.49.43;	author rsprowson;	state Exp;
branches;
next	4.2;
commitid	fjzSOoRRnhA815Aw;

4.2
date	2012.12.07.14.20.16;	author rsprowson;	state Exp;
branches;
next	4.1;
commitid	jnwtWy3St1iqIivw;

4.1
date	96.11.05.09.33.02;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.5.1
	4.1.7.1;
next	;

4.1.1.1
date	96.11.05.09.33.02;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.06.00.54.39;	author nturton;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.12.37.33;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.20.34.03;	author nturton;	state Exp;
branches;
next	;


desc
@@


4.5
log
@Change last couple of uses of trace macros to use DebugLib
This town ain't big enough for the two of us.

Version 1.07. Tagged as 'DOSFS-1_07'
@
text
@/* Copyright 1996 Acorn Computers Ltd
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/*> c.MsgTrans <*/
/*-------------------------------------------------------------------------*/
/* Wrappers for MessageTrans SWIs                                          */
/*-------------------------------------------------------------------------*/

#include <stdio.h>
#include <stdlib.h>
#include "kernel.h"
#include "swis.h"
#include "DebugLib/DebugLib.h"
#include "Global/FSNumbers.h"

#include "DOSFSHdr.h"
#include "MsgTrans.h"

/* Handle for MessageTrans. */
static int file_data[4];

/* Flag which specifies whether the Messages file is open or closed. */
static int file_closed = 1;

static _kernel_oserror *msgtrans_openfile(void)
{
  _kernel_swi_regs r;
  _kernel_oserror *err;
  if (!file_closed)
    return NULL;
  r.r[0] = (int)file_data;
  r.r[1] = (int)Module_MessagesFile;
  r.r[2] = 0;
  if ((err = _kernel_swi(MessageTrans_OpenFile, &r, &r)) != NULL)
    return err;
  file_closed = 0;
  return NULL;
}

/* Call from shutdown_fs() */
extern void msgtrans_closefile(void)
{
  _kernel_swi_regs r;
  if (file_closed)
    return;
  r.r[0] = (int)file_data;
  (void)_kernel_swi(MessageTrans_CloseFile, &r, &r);
  file_closed = 1;
}

extern _kernel_oserror *msgtrans_lookup(
  char *token,
  char **buf,
  int *bufsz,
  char *p1,
  char *p2,
  char *p3,
  char *p4
) {
  _kernel_swi_regs r;
  _kernel_oserror *err;
  if (file_closed)
    if ((err = msgtrans_openfile()) != NULL)
      return err;
  r.r[0] = (int)file_data;
  r.r[1] = (int)token;
  r.r[2] = (int)*buf;
  r.r[3] = *bufsz;
  r.r[4] = (int)p1;
  r.r[5] = (int)p2;
  r.r[6] = (int)p3;
  r.r[7] = (int)p4;
  if ((err = _kernel_swi(MessageTrans_Lookup, &r, &r)) != NULL)
    return err;
  *bufsz = r.r[3];
  if (*buf == NULL)
   *buf = (char *)r.r[2];
  return NULL;
}

/*-------------------------------------------------------------------------*/

_kernel_oserror *_syserr ;      /* global error pointer */

/*---------------------------------------------------------------------------*/

/* The following is used to construct MessageTrans tokens for errors. */
#define ERROR_FMT "ERR%2.2X"

_kernel_oserror  _gerror = {0} ; /* static error structure */
_kernel_oserror *_syserr ;       /* static pointer to the error structure */

/*---------------------------------------------------------------------------*/
/* global_error:
 * Return a RISC OS error block pointer for the given error number.
 */
_kernel_oserror *global_error(int number)
{
 /* return a pointer to the "_kernel_oserror" block for error "number" */
 char token[8];
 _kernel_oserror *err;
 char *buf = _gerror.errmess;
 int bufsz = 252;
 _gerror.errnum = ext_err(number) ;
 /* lookup Messages file for error text */
 sprintf(token, ERROR_FMT, number);
 if ((err = msgtrans_lookup(token, &buf, &bufsz, 0, 0, 0, 0)) != NULL)
  return err;
 dprintf(("", "DOSFS: global_error: &%08X \"%s\"\n",
              _gerror.errnum,_gerror.errmess));
 return(_syserr) ;
}

/*---------------------------------------------------------------------------*/
/* global_errorP:
 * Return a RISC OS error block pointer for the given error number. The
 * passed parameter is placed into the error message.
 */

_kernel_oserror *global_errorP(int number,char *par1)
{
 /* return a pointer to the "_kernel_oserror" block for error "number" */
 char token[8];
 _kernel_oserror *err;
 char *buf = _gerror.errmess;
 int bufsz = 252;
 _gerror.errnum = ext_err(number) ;
 /* lookup Messages file for error text */
 sprintf(token, ERROR_FMT, number);
 if ((err = msgtrans_lookup(token, &buf, &bufsz, par1, 0, 0, 0)) != NULL)
  return err;
 dprintf(("", "DOSFS: global_errorP: &%08X \"%s\"\n",
              _syserr->errnum,_syserr->errmess));
 return(_syserr) ;
}

/*---------------------------------------------------------------------------*/

void global_error0(int number)
{
 /* place error number and message into "_syserr" */
 global_error(number) ;
 return ;
}

/*---------------------------------------------------------------------------*/

void global_error1(int number,char *par1)
{
 /* place error number and message into "_syserr" */
 global_errorP(number, par1);
 return ;
}

/*---------------------------------------------------------------------------*/

void global_errorX(_kernel_oserror *errptr)
{
 _gerror.errnum = errptr->errnum ;
 sprintf(&(_gerror.errmess[0]),errptr->errmess) ;
 return ;
}

/*---------------------------------------------------------------------------*/

_kernel_oserror *global_errorT(int number,char *token,char *par1,char *par2)
{
 _kernel_oserror *err;
 char *buf = _gerror.errmess;
 int bufsz = 252;
 _gerror.errnum = ext_err(number) ;
 /* lookup Messages file for error text */
 if ((err = msgtrans_lookup(token, &buf, &bufsz, par1, par2, 0, 0)) != NULL)
  return err;
 dprintf(("", "DOSFS: global_errorT: &%08X \"%s\"\n",
              _syserr->errnum,_syserr->errmess));
 return(_syserr) ;
}
@


4.4
log
@Add missing message, use central allocations for DOSFS' FS number
Missing 'Stack full' error message added (German translation needed).
Use DOSFS FS number from headers.
Tested with floppy disc (FAT12), 1GB image file (FAT16) and 4GB image file (FAT32) with no issues seen.

Version 1.01. Tagged as 'DOSFS-1_01'
@
text
@d24 1
a28 1
#include "debug.h"
d120 2
a121 1
 tracef2("DOSFS: global_error: &%08X \"%s\"\n",_gerror.errnum,_gerror.errmess);
d143 2
a144 1
 tracef2("DOSFS: global_errorP: &%08X \"%s\"\n",_syserr->errnum,_syserr->errmess) ;
d186 2
a187 1
 tracef2("DOSFS: global_errorT: &%08X \"%s\"\n",_syserr->errnum,_syserr->errmess) ;
@


4.3
log
@Rationalise some defines
Many magic numbers changed to exported defines.
Eliminated unused "BOOTblock.h" (was just nesting 1 include file).
Moved non ASCII definitions out of "ASCII.h" then found the remainder weren't used => eliminated.

Version 0.98. Tagged as 'DOSFS-0_98'
@
text
@d24 1
@


4.2
log
@Source file subdivision
The sources to DOSFS had become rather jumbled and monolithic
* Split FileSwitch interface out into seperate ops source files.
* Combined international error lookup with MsgTrans code.
* Split utility functions into 'Helpers.c' along with wildcard matching functions.
* Moved DOS naming functions into, erm, 'DOSnaming.c'.
Also
* Makefile tweaked to remove 'symbols' on clean.
* Obsolete 'Help' and 'Syntax' placed in attic.

RAM, debug, and ROM targets built. RAM target tested with a DOS floppy disc.

Version 0.96. Tagged as 'DOSFS-0_96'
@
text
@d25 1
d42 1
a42 1
  r.r[1] = (int)ResourceFile;
@


4.1
log
@Initial revision
@
text
@a21 1

d89 96
@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@@


4.1.5.1
log
@Import from SrcFiler
@
text
@@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
