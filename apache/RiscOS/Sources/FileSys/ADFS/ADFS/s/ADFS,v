head	4.12;
access;
symbols
	ADFS-3_54:4.12
	ADFS-3_53:4.12
	ADFS-3_52:4.12
	ADFS-3_51:4.12
	ADFS-3_50:4.12
	ADFS-3_49:4.11
	ADFS-3_48:4.11
	ADFS-3_47:4.11
	ADFS-3_46:4.11
	ADFS-3_45:4.10
	ADFS-3_44:4.9
	ADFS-3_43:4.9
	ADFS-3_42:4.9
	ADFS-3_41:4.9
	ADFS-3_40:4.9
	ADFS-3_39:4.8
	ADFS-3_38:4.8
	ADFS-3_37:4.8
	ADFS-3_36:4.8
	RO_5_07:4.7
	ADFS-3_35:4.7
	ADFS-3_34:4.6
	ADFS-3_33:4.4
	dellis_autobuild_BaseSW:4.4
	ADFS-3_32:4.4
	Ursula_merge:4.3
	Ursula_RiscPC_merge:4.3.6.2
	sbrodie_sedwards_16Mar2000:4.3
	dcotton_autobuild_BaseSW:4.4
	sbrodie_UrsulaRiscPC_ADFS-3_30:4.3.6.2
	Ursula_RiscPC_bp:4.3
	nturton_ADFS-3_29:4.3
	mstphens_UrsulaRiscPCBuild_20Nov98:4.3
	Ursula_RiscPC:4.3.0.6
	sproven_ADFS-3_31:4.3
	nicke_ADFS_3_26:4.1.7.1
	rthornb_UrsulaBuild-19Aug1998:4.3
	UrsulaBuild_FinalSoftload:4.3
	rthornb_UrsulaBuild-12Aug1998:4.3
	aglover_UrsulaBuild-05Aug1998:4.3
	rthornb_UrsulaBuild-29Jul1998:4.3
	rthornb_UrsulaBuild-22Jul1998:4.3
	hsimons_BOCA-1_2-Release:4.1.7.1
	rthornb_UrsulaBuild-15Jul1998:4.3
	rthornb_UrsulaBuild-07Jul1998:4.3
	rthornb_UrsulaBuild-17Jun1998:4.3
	rthornb_UrsulaBuild-03Jun1998:4.3
	rthornb_UrsulaBuild-27May1998:4.3
	rthornb_UrsulaBuild-21May1998:4.3
	rthornb_UrsulaBuild_01May1998:4.3
	sproven_330:4.3
	Spinner_RCA116:4.1.7.1
	Spinner_B20_2:4.1.7.1
	Spinner_19_3:4.1.7.1
	Spinner_B18:4.1.7.1
	Spinner_B17:4.1.7.1
	Spinner_B15:4.1.7.1
	Spinner_B14:4.1.7.1
	Spinner_B13:4.1.7.1
	Spinner_B12:4.1.7.1
	Spinner_B10:4.1.7.1
	Daytona:4.3.0.4
	Daytona_bp:4.3
	Ursula:4.3.0.2
	Ursula_bp:4.3
	Spinner_B7:4.1.7.1
	RO_3_71:4.1.3.2
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	RCA_bp:4.2
	ARTtmp:4.1.7.1.0.2
	RCA:4.2.0.4
	Spin_merge:4.1.7.1
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.12
date	2016.01.05.21.49.09;	author rsprowson;	state Exp;
branches;
next	4.11;
commitid	els1sSTqH2Im4NPy;

4.11
date	2012.10.21.16.27.50;	author rsprowson;	state Exp;
branches;
next	4.10;
commitid	ReyUVZewswdRVgpw;

4.10
date	2012.10.21.11.38.09;	author rsprowson;	state Exp;
branches;
next	4.9;
commitid	L8DklCrHdjSrkfpw;

4.9
date	2011.08.07.19.35.54;	author jlee;	state Exp;
branches;
next	4.8;
commitid	AILCacyEauof9Cuv;

4.8
date	2009.06.11.20.58.41;	author bavison;	state Exp;
branches;
next	4.7;

4.7
date	2003.01.28.15.14.02;	author bavison;	state Exp;
branches;
next	4.6;

4.6
date	2003.01.17.19.33.27;	author kbracey;	state Exp;
branches;
next	4.5;

4.5
date	2002.09.18.15.03.29;	author kbracey;	state Exp;
branches;
next	4.4;

4.4
date	2000.07.11.10.39.25;	author kbracey;	state Exp;
branches;
next	4.3;

4.3
date	97.05.02.09.12.16;	author kbracey;	state Exp;
branches
	4.3.6.1;
next	4.2;

4.2
date	97.01.06.11.31.42;	author nturton;	state Exp;
branches;
next	4.1;

4.1
date	96.11.05.09.31.17;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.5.1
	4.1.7.1;
next	;

4.3.6.1
date	99.08.18.13.55.15;	author sbrodie;	state Exp;
branches;
next	4.3.6.2;

4.3.6.2
date	99.08.18.14.58.02;	author sbrodie;	state Exp;
branches;
next	;

4.1.1.1
date	96.11.05.09.31.17;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.05.23.35.08;	author nturton;	state Exp;
branches
	4.1.3.1.2.1;
next	4.1.3.2;

4.1.3.2
date	97.05.01.14.32.21;	author kbracey;	state Exp;
branches;
next	;

4.1.3.1.2.1
date	97.04.30.11.50.42;	author kbracey;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.12.28.48;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.20.24.20;	author nturton;	state Exp;
branches;
next	;


desc
@@


4.12
log
@Use HAL device for PATA IDE controller, and a few minor fixes
ADFS 3 is currently both a filing system and a hardware poker, so have it own the PATA device for now as a stepping stone to a PATADriver module; export the header.
No longer call HAL entries, look for the HAL device, activate, and call that instead. At API 0.00 it just has the exact same 3 functions as the previous HAL entries only refactored to pass a device pointer in R0.

Makefile/IDEDevice.hdr/ADFS.s/Adfs00.s:
  Export, include, and reserve workspace.
Adfs12.s/IDEDetect.s:
  Refactor function calls.
Messages:
  Unrelated correction to pluralisation of 'Sectors'.
Adfs50.s:
  Hunt for the IDE controller device.
  Fix oflaofla error if run on a non HAL machine - OS_Hardware errors but the ErrXFree code label expects the error pointer in R9 not R0.

Tested in an IOMD build.

Version 3.50. Tagged as 'ADFS-3_50'
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
; ADFS

        GBLL    StrongARM
        GBLL    A1
        GBLL    Top16Write
        GBLL    Support1772
        GBLL    TwinIDEHardware
        GBLL    NewTransferCode
        GBLL    ByteAddressedHW
        GBLA    Override_PDevNo
        GBLL    FloppyPodule
        GBLL    FloppyPCI
        GBLL    UseDiscOp64
        GBLL    IDEDMA

        AREA    |!!!ADFSModule|,CODE,READONLY,PIC

StrongARM       SETL {TRUE}
        GET     DebugOpts.s
        GET     Ver.<Machine>
        GET     Fixes.s

        GET     Hdr:ListOpts
        GET     Hdr:Macros
        GET     Hdr:System
        GET     Hdr:DevNos
        GET     Hdr:Machine.<Machine>
        $GetIO
        GET     Hdr:CMOS
        GET     Hdr:Services
        GET     Hdr:ModHand
        GET     Hdr:PublicWS
        GET     Hdr:Tokens
        GET     Hdr:UpCall
        GET     Hdr:FSNumbers
        GET     Hdr:OsWords
        GET     Hdr:OsBytes
        GET     Hdr:HighFSI
        GET     Hdr:MultiFS
        GET     Hdr:FileCore
        GET     Hdr:ADFS
        GET     Hdr:MsgTrans
        GET     Hdr:NewErrors
        GET     Hdr:Portable
        GET     Hdr:Proc
        GET     Hdr:HALEntries
        GET     Hdr:PCI
        GET     Hdr:Podule
        GET     Hdr:DMA
        GET     Hdr:DMADevice
        GET     Hdr:IDEDevice
        GET     Hdr:OSRSI6
        GET     VersionASM
        
        GET     NewBits.s
        GET     ADFSMacros.s
        GET     Consts.s
        GET     ModHeader.s
        GET     ADFSErrors.s
        GET     ADFS00.s
        GET     ADFS05.s
        GET     Adfs11.s
        GET     ADFS12.s
        GET     ADFS13.s
        GET     ADFS14.s
        GET     IDEDetect.s
        GET     ATAPI.s
        GET     ADFS15.s
        GET     ADFS17.s
        GET     ADFS18.s
        GET     ADFS19.s
        GET     ADFS20.s
        GET     TokenHelp.s
        GET     ADFS50.s
        GET     MFormat.s
      [ IDEDMA
        GET     BusMaster.s
      ]
        GET     ADFS_SA.s

        END
@


4.11
log
@Reinstate floppies on IOMD platform
ADFS.s:
  Remove redundant header file.
Adfs05.s/Adfs15.s:
  Group the options a bit more simply, use {TRUE} and {FALSE}.
Adfs12.s/BusMaster.s/IDEDetect.s:
  Use defines instead of magic numbers.
Adfs17.s:
  Organise the offsets from the floppy controller to cover both PCI and IO based controllers.
  Only do the dummy read from the PBI on Tungsten.
Adfs18.s:
  Implement the FIQ equivalent of the 'FlpUseVerify' command switch, modern controllers (!) have a built in verify rather than using a sector read, but the verify command has no data phase and the FIQ handler was sitting waiting for a sector that never arrives.
  Rationalise FlpDRQmask and FlpDRQmaskbit.
Adfs19:
  Rationalise the calls to OS_Hardware by rejigging the assembly time switches.
  Reinstate the non HAL version of IRQ enable for reference.
  On RPCEmu 0.8.8 and 0.8.9 the emulator hangs during the four set of DCB's used to autodetect the drive (Recalibrate/Seek/Seek/Sense) which seems to be due to the way the emulator splits CPU time to floppy emulation time, to avoid this we wait 128us (real time) which is enough emulated time for the controller to have changed state. You probably just want to *CONFIGURE FLOPPIES 0 though.

Tested om A7000, ARM610, StrongARM manipulating a veriety of disc densities for read and write. Also ran the "Test/TestADFS" test program.
RPCEmu 0.8.8 and 0.8.9 boots still, but no attempt has been made to use emulated floppies.

Version 3.46. Tagged as 'ADFS-3_46'
@
text
@d65 1
@


4.10
log
@Tidy up pass
ADFS.s:
  Redundant header files trimmed
  Get OsWords and OsBytes
  Switches rationalised
ADFS_SA.a
  Removed ARM810 support
Adfs00.s:
  Unused MEMC flag removed
Adfs05.s/Adfs12.s/Adfs13.s/Adfs14.s/Adfs15.s/Adfs19.s:
  Use defines instead of magic numbers
  Make use of FileCore exported bit fields
Adfs17.s/Adfs18.s/ConstIDE:
  {TRUE} and {FALSE} used with objasm
Adfs20.s
  Use AND of the opmask instead of BIC of all the flags except the opmask
Adfs50.s
  Unused MEMC flag no longer initialised
  Make use of FileCore exported bit fields
  Service call table reordered so the Ursula despatch doesn't incur a branch
  OsByte defines used
Consts:
  Removed those definitions now duplicating FileCore's exports
DebugOpts/Fixes:
  All options brought under one roof
ModHeader:
  Now uses VersionNum directly
Ver/*:
  Redundant switches deleted
  Removed used of 'Version' header


Version 3.45. Tagged as 'ADFS-3_45'
@
text
@a59 1
        GET     Hdr:CPU.ARM600
@


4.9
log
@Update to work with zero page relocation
Detail:
  s/ADFS, s/Adfs00, s/Adfs50 - Use OS_ReadSysInfo 6 to get ESC_Status location and store it in module workspace
  s/Adfs05 - Updated debug code to use OS_ReadSysInfo 6 to get IRQsema location. Updated CheckEscape to use local ESC_Status pointer, and updated it to only be compiled if it's actually needed
  s/Adfs10, s/Adfs14, s/Adfs15, s/Adfs17 - Use local ESC_Status pointer
Admin:
  Tested (with low processor vectors) in Iyonix ROM softload
  Note that FIQ handlers haven't been updated to support high vectors, since they aren't currently used on any hardware capable of using high vectors


Version 3.40. Tagged as 'ADFS-3_40'
@
text
@d17 12
a28 4
              GBLL    StrongARM
	      GBLL    ARM810support
StrongARM     SETL {TRUE}
ARM810support SETL {FALSE}
d30 1
a30 1
        AREA    |!!!Module|,CODE,READONLY,PIC
d32 2
a35 1
        GET     DevVersion
d41 2
a42 3
	GET	Hdr:Machine.<Machine>
	GET	Hdr:IO.IOEB
	$GetIO
d50 2
d67 2
a68 1

a71 1
        GET     DebugOpts.s
a92 1

@


4.8
log
@  GET file pathnames changed
Detail:
  Uses suffixed file extensions for compatiblity with both objasm and asasm.
Admin:
  Supplied by Peter Naulls, tested at ROOL

Version 3.35. Not tagged
@
text
@d56 1
@


4.7
log
@First bits of DMA support: reads bus master information from the HAL and
uses it to create a set of DMA "HAL" devices for use by the DMA Manager.
Also responds to Service_ModulePostInit for the DMA Manager to reregister
(currently only the floppy) DMA channel(s).

Version 3.34. Not tagged
@
text
@d25 1
a25 1
        GET     s.Fixes
d57 22
a78 22
        GET     s.NewBits
        GET     s.ADFSMacros
        GET     s.Consts
        GET     s.DebugOpts
        GET     s.ModHeader
        GET     s.ADFSErrors
        GET     s.ADFS00
        GET     s.ADFS05
        GET     s.Adfs11
        GET     s.ADFS12
        GET     s.ADFS13
        GET     s.ADFS14
        GET     s.IDEDetect
        GET     s.ATAPI
        GET     s.ADFS15
        GET     s.ADFS17
        GET     s.ADFS18
        GET     s.ADFS19
        GET     s.ADFS20
        GET     s.TokenHelp
        GET     s.ADFS50
        GET     s.MFormat
d80 1
a80 1
        GET     s.BusMaster
d83 1
a83 1
        GET     s.ADFS_SA
@


4.6
log
@* ADFS_DiscOp64 and ADFS_ATAPIOp added.
* New FileCore error passing scheme supported.
* PCI floppy support functional.
* 48-bit LBA support added for ADFS_IDEUserOp and accessing beyond the
  first 128GB of a drive - not thoroughly tested.
* IDE autodetection improved

Version 3.34. Tagged as 'ADFS-3_34'
@
text
@d55 1
d79 3
@


4.5
log
@32-bit conversion started, Tungsten hard disc support added.
Hard disc functional, but PIO mode only. Don't go near the floppy.

Version 3.33. Not tagged
@
text
@d54 1
d69 1
@


4.4
log
@  Ursula_RiscPC branch merged.

Detail:
  The Ursula_RiscPC branch contained version 3.30 of ADFS, which had
  minimal updates for Ursula, such as the service call table. This
  version, incorporating changes on the Ursula branch up to
  the Ursula_RiscPC_bp tag, is now merged on to the trunk as 3.32.
  This leaves version 3.31 on the Ursula branch, unmerged. This contains
  unfinished support for auto-detection of IDE drives and support for
  Phoebe hardware.

Version 3.32. Tagged as 'ADFS-3_32'
@
text
@d22 2
d51 3
d63 5
a67 7
        GBLS    GRBA
 [ MEMC1A
GRBA    SETS    "MEMC1ABits"
 |
GRBA    SETS    "MEMC1Bits"
 ]
        GET     s.$GRBA
@


4.3
log
@Version RO_3_71 merged
@
text
@d30 3
a47 2
        GET     Hdr:IO.IOEB
        GET     Hdr:IO.IOMD
@


4.3.6.1
log
@Added inclusion of Machine header file for new CMOS header.
Version number retained.
Tagged as sbrodie_UrsulaRiscPC_ADFS-3_30.
@
text
@a29 1
	GET	Hdr:Machine.<Machine>
@


4.3.6.2
log
@Fixed header inclusion order
@
text
@a30 2
	GET	Hdr:IO.IOEB
	$GetIO
d46 2
@


4.2
log
@Taken from RiscOS 3.70
@
text
@d17 4
a20 2
        GBLL    StrongARM
StrongARM SETL {TRUE}
@


4.1
log
@Initial revision
@
text
@d17 3
d70 2
@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@@


4.1.5.1
log
@Import from SrcFiler
@
text
@@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@a16 3
        GBLL    StrongARM
StrongARM SETL {TRUE}

a66 2

        GET     s.ADFS_SA
@


4.1.3.2
log
@Version RO_3_71 taken
@
text
@d17 2
a18 4
              GBLL    StrongARM
	      GBLL    ARM810support
StrongARM     SETL {TRUE}
ARM810support SETL {FALSE}
@


4.1.3.1.2.1
log
@Merged from 3.71 CD
@
text
@d17 2
a18 4
              GBLL    StrongARM
	      GBLL    ARM810support
StrongARM     SETL {TRUE}
ARM810support SETL {FALSE}
@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
