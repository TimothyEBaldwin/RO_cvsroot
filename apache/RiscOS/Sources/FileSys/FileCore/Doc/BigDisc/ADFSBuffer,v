head	4.4;
access;
symbols
	FileCore-3_75:4.3
	FileCore-3_74:4.3
	FileCore-3_73:4.3
	FileCore-3_72:4.3
	FileCore-3_71:4.3
	FileCore-3_70:4.3
	FileCore-3_69:4.3
	FileCore-3_68:4.3
	FileCore-3_67:4.3
	FileCore-3_66:4.3
	FileCore-3_65:4.3
	FileCore-3_64:4.3
	FileCore-3_63:4.3
	FileCore-3_62:4.3
	FileCore-3_61:4.3
	FileCore-3_60:4.3
	FileCore-3_59:4.3
	FileCore-3_58:4.3
	FileCore-3_57:4.2
	FileCore-3_56:4.1
	FileCore-3_55:4.1
	FileCore-3_54:4.1
	FileCore-3_53:4.1
	FileCore-3_52:4.1
	FileCore-3_51:4.1
	FileCore-3_50:4.1
	FileCore-3_49:4.1
	FileCore-3_48:4.1
	FileCore-3_47:4.1
	FileCore-3_46:4.1
	FileCore-3_45:4.1
	FileCore-3_44:4.1
	FileCore-3_43:4.1
	FileCore-3_42:4.1
	FileCore-3_41:4.1
	FileCore-3_40:4.1
	FileCore-3_39:4.1
	FileCore-3_38:4.1
	FileCore-3_37:4.1
	FileCore-3_36:4.1
	FileCore-3_35:4.1
	FileCore-3_34:4.1
	FileCore-3_33:4.1
	RO_5_07:4.1
	FileCore-3_32:4.1
	FileCore-3_31:4.1
	FileCore-3_30:4.1
	FileCore-3_29:4.1
	FileCore-3_28:4.1
	FileCore-3_25-4_9_2_2:4.1
	FileCore-3_27:4.1
	FileCore-3_26:4.1
	FileCore-3_22-4_6_2_1:4.1
	bavison_FileCore-3_22_dev_bp:4.1
	bavison_FileCore-3_22:4.1.0.14
	FileCore-3_25-4_9_2_1:4.1
	HAL:4.1.0.12
	FileCore-3_25:4.1
	FileCore-3_24:4.1
	FileCore-3_23:4.1
	dellis_autobuild_BaseSW:4.1
	FileCore-3_22:4.1
	Ursula_merge:4.1
	ROL_merge:4.1
	FileCore-3_21:4.1
	ROL_Ursula_merge:4.1
	Ursula_RiscPC_merge:4.1
	sbrodie_sedwards_16Mar2000:4.1
	dcotton_autobuild_BaseSW:4.1
	ROL_FileCore-3_21:4.1
	ROL_FileCore-3_20:4.1
	ROL:4.1.0.10
	ROL_bp:4.1
	Ursula_RiscPC_bp:4.1
	FileCore-3_18:4.1
	FileCore-3_01:4.1
	mstphens_UrsulaRiscPCBuild_20Nov98:4.1
	Ursula_RiscPC:4.1.0.8
	FileCore-3_00:4.1
	FileCore-2_99:4.1
	aglover_FileCore-3_17:4.1
	sproven_FileCore-3_16:4.1
	rthornb_UrsulaBuild-19Aug1998:4.1
	UrsulaBuild_FinalSoftload:4.1
	rthornb_UrsulaBuild-12Aug1998:4.1
	aglover_UrsulaBuild-05Aug1998:4.1
	rthornb_UrsulaBuild-29Jul1998:4.1
	rthornb_UrsulaBuild-22Jul1998:4.1
	rthornb_UrsulaBuild-15Jul1998:4.1
	rthornb_UrsulaBuild-07Jul1998:4.1
	rthornb_UrsulaBuild-17Jun1998:4.1
	rthornb_UrsulaBuild-03Jun1998:4.1
	rthornb_UrsulaBuild-27May1998:4.1
	rthornb_UrsulaBuild-21May1998:4.1
	sproven_FileCore-3_15:4.1
	sproven_314:4.1
	rthornb_UrsulaBuild_01May1998:4.1
	afrost_Funai01-33:4.1.7.1
	afrost_NC2_Generic:4.1.7.1
	sproven_313:4.1
	sproven_3_11:4.1
	sproven_3_10:4.1
	sproven_Ursula_3_09:4.1
	sproven_3_07:4.1
	sproven_3_06:4.1
	sproven_3_05:4.1
	sproven_3_04:4.1
	Spinner_RCA116:4.1.7.1
	sproven_3_03:4.1
	sproven_3_02:4.1
	sproven_3_01:4.1
	sproven_2_99:4.1
	sproven_2_98:4.1
	Spinner_B20_2:4.1.7.1
	Spinner_19_3:4.1.7.1
	Spinner_B18:4.1.7.1
	Spinner_B17:4.1.7.1
	Spinner_B15:4.1.7.1
	Spinner_B14:4.1.7.1
	Spinner_B13:4.1.7.1
	Spinner_B12:4.1.7.1
	Spinner_B10:4.1.7.1
	Daytona:4.1.0.6
	Daytona_bp:4.1
	Ursula:4.1.0.4
	Ursula_bp:4.1
	Spinner_B7:4.1.7.1
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	RCA_bp:4.1
	ARTtmp:4.1.7.1.0.2
	RCA:4.1.0.2
	Spin_merge:4.1.7.1
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.4
date	2018.06.08.07.48.03;	author rsprowson;	state Exp;
branches;
next	4.3;
commitid	xb8lHKhgnMjvXrFA;

4.3
date	2013.04.01.16.40.48;	author rsprowson;	state Exp;
branches;
next	4.2;
commitid	tkUggU6sItgtN5Kw;

4.2
date	2013.03.25.20.31.03;	author rsprowson;	state Exp;
branches;
next	4.1;
commitid	vCGDXb1zgPQnidJw;

4.1
date	96.11.05.09.32.08;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.5.1
	4.1.7.1;
next	;

4.1.1.1
date	96.11.05.09.32.08;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.06.00.02.14;	author nturton;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.12.33.15;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.20.30.07;	author nturton;	state Exp;
branches;
next	;


desc
@@


4.4
log
@Docs update
Having disassembled various old copies of FileCore, make a note of the most likely reason it declares with fsinfo_dontuseload to maximise the use of background transfer buffers.
Not tagged.
@
text
@ADFSBuffers
-----------

These are my general notes on ADFSBuffers support (FileCore80) as I attempt to
understand the code within (here be demons!).  I intend to list every ADFSBuffers 
function that I examine here along with what changes are required.  I'll also list 
those functions which I consider to not need updating at all.  I'll also generate 
some notes of general ADFSBuffers working.  Hopefully this documentation should be
useful to others in the future.

Buffers
-------

Each buffer is a 1K buffer.  It can however be considered
as two sub-buffers of 512 bytes or four sub-buffers of
256 bytes.

The buffers are controlled by 'BufFlags' which is a 32 bit word arranged as 4 bytes,
one for each sub-buffer. The value of 'BufSz' describes how the buffer is to be
divided, for example a drive with 512 byte sectors would divide it in two.
But BufSz is only an 8 bit variable, so the actual number of bytes in a buffer
is expressed by first shifting down by 'BufScale', which is 5. In other words

  1024 -> 32; 512 -> 16; 256 -> 8.

We can see these cunningly allow the BufFlags to be manipulated using shifts
which exactly correspond to the number of bytes of flags which would be needed to
describe the corresponding number of sub-buffers. The downside to this scheme
is the buffers are stuck at 1K without some serious rewriting of the code.  

Processes
---------

Each 'process' contains a process block which tells us what this
process is actually doing.  Tacked onto the end of the process is
a scatter list - everyone likes scatter lists don't they?  Luckily
for us, pair extension is disabled.  That is, the scatter list never
gets extended just when the driver least expects it, as it causes
all sorts of headaches - allegedly, of course.

There's one process per controller (one for floppies and one for fixed discs).

Each process maintains some state in its respective process control block,
this is kept for the duration of the processing:
 * The drive number (so that scatter lists can be sent to the
   right drive on that controller)
 * Start offset & end offset, in bytes, for the portion of the transfer
   currently being scattered. Note that scatter lists are just attached
   blindly by the foreground process without any consideration of where
   they cross fragment boundaries - it is only when a new chunk of a
   scatter list is being passed (via the DiscOp low level entry) to the
   client filing system that the fragment boundaries are respected
 * Fcb, the file control block to which the scatter list entries relate
 * FragEnd, the end offset, in bytes, of the portion of the scatter list
   that is currently being processed.
 * Error & Status (part of the client API) defined to be held at -4
   and -8 from the scatter list start

When idle FileCore will look to see if any more background work could be
started. If writes are possible the first buffer (attached to the Fcb) will
be picked and using its BufFileOff this is mapped to a fragment. More buffers
will be considered (using SkipWriteBehind and BackwardsSkipWriteBehind) to
see how many buffer s cover the corresponding fragment. These are then inserted
in one go onto a scatter list and consumed.
Later, the above steps will repeat. Due to the way the buffers are attached
to the Fcb this results in writing backwards through the file as it happens.

Process Scatter Lists
------- ------- -----

As mentioned above, the process scatter lists cannot be extended
by adding more pairs.  Indeed, enough pairs must be available
in each process to satisfy the maximum number of buffers that
can be in use.  Thus each process has a scatter list upto
MaxFileBuffers in length.  Each scatter list entry must correspond
to either a buffer or a direct transfer.  A scatter list entry
cannot cover multiple buffers as data for adjacent buffers in
a transfer will not conjoin.  Does this apply for sub-buffers?

DiscAdjust/RamAdjust
--------------------

This is an adjustment offset which expresses either the originating
buffer (when RamAdjust) or target disc address (when DiscAdjust)
relative to the file offset.

By example

  Buffer    = 0x12340000
  FileOff   = 0x00010000
  RamAdjust = 0x12330000

so as you read bytes at FileOff, there's no need to keep two indexes
in sync, the buffer address can be recreated by just adding RamAdjust.

DiscAdjust works the same, only it's a disc address rather than RAM.
I'm thinking that DiscAdjust must be always sector aligned.  If
this assumption breaks I'll have fun.

OS_File Load
------------

At least as far back as FileCore 2.41, and throughout all CVS history, FileCore
has registered with FileSwitch with bit 20 (fsinfo_dontuseload) of the FS
info word set.

This is rationalised as being so that the GetBytes entry gets used in the
hope that some of the request can be met from the read ahead cache.

The code to handle OS_File 255 (DoOsFileLoad in FileCore45.s) bypasses the
read ahead cache, using IndDiscOp directly, but the function is never called.
@


4.3
log
@Fix for mistargetted write with a file size > 2G when a background scatter list straddles a fragment
When large transfers are being buffered to be written in the background they are attached to the Fcb without considering how the underlying disc fragments are lined up.
When the background process grabs a handful of buffers to build into a scatter list to pass to the low level DiscOp it picks the head of the list and goes forward (SkipWriteBehind) to the fragment end and back (BackwardSkipWriteBehind).
However, BackwardsSkipWriteBehind uses DefFileFrag which substitutes a default offset of 0, and the signed compare resulted in this being left as the believed start of fragment.
In turn, far too many buffers got associated with the fragment, and written to the wrong place on the disc.
In general this doesn't occur, but if the group of buffers happens to straddle a fragment, and that group of buffers is > 2G, the signed compare would trip up.
As fsbash uses the same random number seed this conspired that testing the same drive twice (with and without background transfers enabled) would appear to pass the integrity check step. A new harddisc was used to show this up.

FileCore80.s: Recoded the compare to be in sectors, so 4G files aren't top bit set, but shared files not at the fragment start still are.
Docs/AdfsBuffers: Added some notes before I forget what I just wrote meant.


Version 3.58. Tagged as 'FileCore-3_58'
@
text
@d63 1
a63 1
see how many buffers cover the corresponding fragment. These are then inserted
d99 13
@


4.2
log
@Reenable background transfer support when BigFiles is {TRUE}
BigDirCode.s: Retire BigDirFix switch, it wasn't actually a fix, it was more that the directory format was changed early in development, but there's no point keeping support for the prototype any more
FileCore45.s/FileCore25.s/FileCore31.s/FileCore35.s/DebugOpts.s: Retire BigDirFix
Defns.s: Shock addition of some comments
FileCore.s: Manual inclusion of CPU/Arch no longer needed
FileCore70.s: Crucially apply the same 1k dead band to the FileSwitch "write zeros" entry point, since it (along with Get/PutBytes) are the only places file offsets get passed
FileCore80.s: Lots of tedious and subtle boundary cases fixed
InitDieSvc.s: Removed the disabling switch
doc/BigDisc/ADFSBuffer: Detail what the BufFlags mean

Tested on ADFS (the only background-transferring filing system about) with LFAUs of 2k, 4k, 8k, 16k and bashing 65536 iterations.

Version 3.57. Tagged as 'FileCore-3_57'
@
text
@d41 27
d80 2
a81 2
DiscAdjust
----------
d83 5
a87 7
This seems to be an adjustment offset which would generally appear
to be added to any offset within a file to give the actual disc
address for that offset - thus DiscAdjust only remains valid
when working within a single fragment.  It is added to the offset 
into a file to give the disc address corresponding to that offset.
I'm thinking that DiscAdjust must be always sector aligned.  If
this assumption breaks I'll have fun.
d89 3
a91 1
The next three sections list what needs modified.
d93 2
a94 2
Functions which will need modified:
--------- ----- ---- ---- --------
d96 3
a98 58
FileFrag						... SBP: done
BackGroundFileCacheOp					... SBP: done
GetBytesEntry						... SBP: done
PutBytesEntry						... SBP: done
BackGroundOps						... SBP: done


Functions which will not need modified:
--------- ----- ---- --- ---- --------

FindSubBuf
UpdateProcess
GetPutCommon
FcbCommon
ReadAheadCommon
R3LoadNewMap
BufsToRam
BackGroundTidyUp
ReduceWriteBehind
AddBuffer
SkipEmpty
SkipWriteBehind
BackwardsSkipWriteBehind
DefFileFrag
FindSubBuf
UpdateBufState
ClaimFileCache
ReleaseFileCache
IncReadAhead
ExtendUp
ExtendDown
Flush
TestFileCacheGrowable
RestartCheck
FloppyOpDone
WinnieOpDone
TickerEntry
UpdateProcesses
ScanBuffers
FindFreeBuf
EmptyBuffers
UnlinkAllocChain
LinkAllocChain
UnlinkFileChain
LinkFileChain
LessValid
MoreValid
WaitForControllerFree
DiscWriteBehindWait
DriveWriteBehindWait
LockDisc
FindDisc
FreeFcb
ClaimController
ReleaseController
AddPair
FragLeft
DefFileFrag (veneer to FileFrag)
@


4.1
log
@Initial revision
@
text
@d18 13
@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@@


4.1.5.1
log
@Import from SrcFiler
@
text
@@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
