head	4.16;
access;
symbols
	FileCore-3_75:4.16
	FileCore-3_74:4.16
	FileCore-3_73:4.16
	FileCore-3_72:4.16
	FileCore-3_71:4.16
	FileCore-3_70:4.16
	FileCore-3_69:4.16
	FileCore-3_68:4.16
	FileCore-3_67:4.16
	FileCore-3_66:4.16
	FileCore-3_65:4.16
	FileCore-3_64:4.16
	FileCore-3_63:4.16
	FileCore-3_62:4.16
	FileCore-3_61:4.16
	FileCore-3_60:4.16
	FileCore-3_59:4.16
	FileCore-3_58:4.16
	FileCore-3_57:4.16
	FileCore-3_56:4.15
	FileCore-3_55:4.15
	FileCore-3_54:4.15
	FileCore-3_53:4.14
	FileCore-3_52:4.14
	FileCore-3_51:4.14
	FileCore-3_50:4.14
	FileCore-3_49:4.14
	FileCore-3_48:4.14
	FileCore-3_47:4.14
	FileCore-3_46:4.13
	FileCore-3_45:4.13
	FileCore-3_44:4.12
	FileCore-3_43:4.12
	FileCore-3_42:4.12
	FileCore-3_41:4.12
	FileCore-3_40:4.11
	FileCore-3_39:4.11
	FileCore-3_38:4.10
	FileCore-3_37:4.10
	FileCore-3_36:4.10
	FileCore-3_35:4.10
	FileCore-3_34:4.10
	FileCore-3_33:4.10
	RO_5_07:4.9
	FileCore-3_32:4.9
	FileCore-3_31:4.9
	FileCore-3_30:4.9
	FileCore-3_29:4.9
	FileCore-3_28:4.8
	FileCore-3_25-4_9_2_2:4.6.2.2
	FileCore-3_27:4.7
	FileCore-3_26:4.6
	FileCore-3_22-4_6_2_1:4.5
	bavison_FileCore-3_22_dev_bp:4.5
	bavison_FileCore-3_22:4.5.0.2
	FileCore-3_25-4_9_2_1:4.6.2.1
	HAL:4.6.0.2
	FileCore-3_25:4.6
	FileCore-3_24:4.6
	FileCore-3_23:4.6
	dellis_autobuild_BaseSW:4.5
	FileCore-3_22:4.5
	Ursula_merge:4.2.2.2
	ROL_merge:4.2.2.1.4.1
	FileCore-3_21:4.5
	ROL_Ursula_merge:4.2.2.1.4.1
	Ursula_RiscPC_merge:4.2.2.1
	sbrodie_sedwards_16Mar2000:4.4
	dcotton_autobuild_BaseSW:4.9
	ROL_FileCore-3_21:4.2.2.1.4.1
	ROL_FileCore-3_20:4.2.2.1
	ROL:4.2.2.1.0.4
	ROL_bp:4.2.2.1
	Ursula_RiscPC_bp:4.2.2.1
	FileCore-3_18:4.2.2.2
	FileCore-3_01:4.4
	mstphens_UrsulaRiscPCBuild_20Nov98:4.2.2.1
	Ursula_RiscPC:4.2.2.1.0.2
	FileCore-3_00:4.4
	FileCore-2_99:4.3
	aglover_FileCore-3_17:4.2.2.1
	sproven_FileCore-3_16:4.2.2.1
	rthornb_UrsulaBuild-19Aug1998:4.2.2.1
	UrsulaBuild_FinalSoftload:4.2.2.1
	rthornb_UrsulaBuild-12Aug1998:4.2.2.1
	aglover_UrsulaBuild-05Aug1998:4.2.2.1
	rthornb_UrsulaBuild-29Jul1998:4.2.2.1
	rthornb_UrsulaBuild-22Jul1998:4.2.2.1
	rthornb_UrsulaBuild-15Jul1998:4.2.2.1
	rthornb_UrsulaBuild-07Jul1998:4.2.2.1
	rthornb_UrsulaBuild-17Jun1998:4.2.2.1
	rthornb_UrsulaBuild-03Jun1998:4.2.2.1
	rthornb_UrsulaBuild-27May1998:4.2.2.1
	rthornb_UrsulaBuild-21May1998:4.2.2.1
	sproven_FileCore-3_15:4.2.2.1
	sproven_314:4.2.2.1
	rthornb_UrsulaBuild_01May1998:4.2.2.1
	afrost_Funai01-33:4.1.7.1
	afrost_NC2_Generic:4.1.7.1
	sproven_313:4.2.2.1
	sproven_3_11:4.2.2.1
	sproven_3_10:4.2.2.1
	sproven_Ursula_3_09:4.2.2.1
	sproven_3_07:4.2.2.1
	sproven_3_06:4.2.2.1
	sproven_3_05:4.2.2.1
	sproven_3_04:4.2.2.1
	Spinner_RCA116:4.1.7.1
	sproven_3_03:4.2.2.1
	sproven_3_02:4.2.2.1
	sproven_3_01:4.2.2.1
	sproven_2_99:4.2
	sproven_2_98:4.2
	Spinner_B20_2:4.1.7.1
	Spinner_19_3:4.1.7.1
	Spinner_B18:4.1.7.1
	Spinner_B17:4.1.7.1
	Spinner_B15:4.1.7.1
	Spinner_B14:4.1.7.1
	Spinner_B13:4.1.7.1
	Spinner_B12:4.1.7.1
	Spinner_B10:4.1.7.1
	Daytona:4.2.0.6
	Daytona_bp:4.2
	Ursula:4.2.0.2
	Ursula_bp:4.2
	Spinner_B7:4.1.7.1
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	RCA_bp:4.2
	ARTtmp:4.1.7.1.0.2
	RCA:4.2.0.4
	Spin_merge:4.1.7.1
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.16
date	2013.03.25.20.31.07;	author rsprowson;	state Exp;
branches;
next	4.15;
commitid	vCGDXb1zgPQnidJw;

4.15
date	2012.10.28.08.52.31;	author rsprowson;	state Exp;
branches;
next	4.14;
commitid	6n5fY77YU7JEb8qw;

4.14
date	2011.11.25.08.50.21;	author rsprowson;	state Exp;
branches;
next	4.13;
commitid	Wvsb4iMJaWIw2HIv;

4.13
date	2011.10.14.07.23.50;	author rsprowson;	state Exp;
branches;
next	4.12;
commitid	D2Id4aPp4zmuUhDv;

4.12
date	2011.09.13.19.13.15;	author rsprowson;	state Exp;
branches;
next	4.11;
commitid	PKTDORFkNFRVOmzv;

4.11
date	2011.08.04.20.43.10;	author jlee;	state Exp;
branches;
next	4.10;
commitid	zcIknvqdwARiCeuv;

4.10
date	2009.05.17.01.48.30;	author bavison;	state Exp;
branches;
next	4.9;

4.9
date	2001.05.14.14.27.07;	author sbrodie;	state Exp;
branches;
next	4.8;

4.8
date	2001.05.10.15.10.27;	author kbracey;	state Exp;
branches;
next	4.7;

4.7
date	2001.03.01.13.38.55;	author sforrest;	state Exp;
branches;
next	4.6;

4.6
date	2000.10.30.13.26.34;	author kbracey;	state Exp;
branches
	4.6.2.1;
next	4.5;

4.5
date	2000.05.09.11.36.52;	author sbrodie;	state Exp;
branches;
next	4.4;

4.4
date	98.10.19.15.51.54;	author kbracey;	state Exp;
branches;
next	4.3;

4.3
date	98.09.21.12.07.11;	author kbracey;	state Exp;
branches;
next	4.2;

4.2
date	97.01.06.13.47.28;	author nturton;	state Exp;
branches
	4.2.2.1;
next	4.1;

4.1
date	96.11.05.09.32.16;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.5.1
	4.1.7.1;
next	;

4.6.2.1
date	2000.11.30.17.04.36;	author kbracey;	state Exp;
branches;
next	4.6.2.2;

4.6.2.2
date	2001.05.10.15.04.37;	author kbracey;	state Exp;
branches;
next	;

4.2.2.1
date	97.09.16.14.46.37;	author sproven;	state Exp;
branches
	4.2.2.1.4.1;
next	4.2.2.2;

4.2.2.2
date	99.08.17.14.19.28;	author sbrodie;	state Exp;
branches;
next	;

4.2.2.1.4.1
date	99.08.27.13.56.35;	author nbingham;	state Exp;
branches;
next	;

4.1.1.1
date	96.11.05.09.32.16;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.06.00.11.31;	author nturton;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.12.33.54;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.20.30.48;	author nturton;	state Exp;
branches;
next	;


desc
@@


4.16
log
@Reenable background transfer support when BigFiles is {TRUE}
BigDirCode.s: Retire BigDirFix switch, it wasn't actually a fix, it was more that the directory format was changed early in development, but there's no point keeping support for the prototype any more
FileCore45.s/FileCore25.s/FileCore31.s/FileCore35.s/DebugOpts.s: Retire BigDirFix
Defns.s: Shock addition of some comments
FileCore.s: Manual inclusion of CPU/Arch no longer needed
FileCore70.s: Crucially apply the same 1k dead band to the FileSwitch "write zeros" entry point, since it (along with Get/PutBytes) are the only places file offsets get passed
FileCore80.s: Lots of tedious and subtle boundary cases fixed
InitDieSvc.s: Removed the disabling switch
doc/BigDisc/ADFSBuffer: Detail what the BufFlags mean

Tested on ADFS (the only background-transferring filing system about) with LFAUs of 2k, 4k, 8k, 16k and bashing 65536 iterations.

Version 3.57. Tagged as 'FileCore-3_57'
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;

        GET     Hdr:ListOpts
        GET     Hdr:Macros
        GET     Hdr:System
        GET     Hdr:Machine.<Machine>
        GBLS    GetHAL
 [ HAL
GetHAL  SETS    "GET Hdr:HALEntries"
 |
GetHAL  SETS    ""
 ]
        $GetHAL
        GET     Hdr:CMOS
        GET     Hdr:Services
        GET     Hdr:ModHand
        GET     Hdr:FSNumbers
        GET     Hdr:HighFSI
        GET     Hdr:PublicWS
        GET     Hdr:Tokens
        GET     Hdr:Wimp
        GET     Hdr:UpCall
        GET     Hdr:VduExt
        GET     Hdr:LowFSI
        GET     Hdr:Heap
        GET     Hdr:FileCore
        GET     Hdr:MsgTrans
        GET     Hdr:FileTypes
        GET     Hdr:OsWords
        GET     Hdr:OsBytes
        GET     Hdr:MultiFS
        GET     Hdr:NewErrors
        GET     Hdr:Territory
        GET     Hdr:OSRSI6

        GET     VersionASM
        GET     DebugOpts.s
        GET     MyMacros.s
        GET     Defns.s
        GET     FileCore00.s
        GET     Errors.s
        GET     FileCore05.s
        GET     FileCore15.s
        GET     FileCore20.s
        GET     FileCore25.s
        GET     FileCore30.s
        GET     FileCore31.s
        GET     FileCore32.s
        GET     FileCore33.s
        GET     FileCore35.s
        GET     FileCore40.s
        GET     FileCore45.s
        GET     TokHelpSrc.s
        GET     InitDieSvc.s
        GET     Commands.s
        GET     GenSWIs.s
        GET     MsgsStuff.s
        GET     FileCore60.s
        GET     FileCore70.s
        GET     FileCore80.s
        GET     FormSrvcs.s
        GET     FormSWIs.s
        GET     Identify.s
        GET     BigDirCode.s

 [ Debug
        InsertDebugRoutines
 ]

        END
@


4.15
log
@Swap out some more constants for symbolic names
* OsBytes
* Application start &8000
* Fixed disc density
* Unused a4 macro deleted
* Redundant 'todo', 'Help, 'Syntax' removed

Version 3.53. Not tagged
@
text
@a46 1
        GET     Hdr:CPU.Arch
@


4.14
log
@Fold in old fixes.
From 1989, probably safe to keep them. Binary unchanged.

Version 3.47. Tagged as 'FileCore-3_47'
@
text
@d36 1
d43 1
@


4.13
log
@Revise exports in "hdr.FileCore".
Now, for each SWI call there is a definition of any pertinent structures it asks for and definitions of any bitfields within those flags. This avoids the need for clients to endlessly redefine these locally (in practice it looks like sections of FileCore were simply copy and pasted into clients RAMFS/SCSIFS/ADFS). Delete private definitions.
This binary was carefully checked to be identical since so many locations were changed.
Then, the following additional changes:
* InitDieSvc line 74, the floppy config is extracted using a mask and shift rather than reaching up the stack
* Identify lin 1254, the superfluous instruction marked as such deleted
* FileCore15 line 762 recoded the check for background op to not need the bit number defined any more
* FileCore00 moved the label 'anull' to be word aligned guaranteed
The duff pointer marker ('nowt' = &40000000) is no longer used to mark territory translation tables as invalid as that address is now quite reasonable. -1 is used instead.

Version 3.45. Tagged as 'FileCore-3_45'
@
text
@a49 1
        GET     Fixes.s
@


4.12
log
@Delete s.AsmHdr, s.DevVersion, Version, s.ModHand
Delete Doc.!ReadMe, update Doc.!Implement
Collapse dead switches.
s.MyMacros:
 Remove 'nop' macro, use NOP.
s.Defns:
 Some definitions taken from global headers.
s.Commands:
 Indentation and function calling parameter comments reviewed.

Still produces the same binary as 3.40.
@
text
@d54 1
@


4.11
log
@Update to work with zero page relocation
Detail:
  s/FileCore, s/FileCore00, s/InitDieSvc - Try using OS_ReadSysInfo 6 to get IRQsema & CannotReset locations before falling back on legacy values. Store results in module workspace.
  s/FileCore05 - Commented out unused CheckEscape routine to avoid having to update it
  s/FileCore15 - Debugging code updated to use OS_ReadSysInfo 6 to fetch IRQsema ptr. Can't always rely on workspace version since workspace might not be set up yet.
  s/FileCore25, s/FileCore30, s/FileCore80 - Use IRQsema & CannotReset pointers from workspace
Admin:
  Tested on rev A2 BB-xM


Version 3.39. Tagged as 'FileCore-3_39'
@
text
@a15 5
        GET     VersionASM
        GET     Version
        GET     Fixes.s
        GET     AsmHdr.s
        GET     DevVersion.s
d36 1
a36 1
        GET     Hdr:LowFSi
d41 1
d48 1
d50 1
@


4.10
log
@  Various archiecture-based optimisations
Detail:
  * ARMv6+ builds use unaligned halfword and word loads and stores (unless
    pre-ARMv6 compatibility is required or NoUnaligned is set)
  * In many cases, one unnecessary BIC instruction has been removed from
    pre-ARMv6 builds
  * ARMv5+ builds (so Tungsten and OMAP) make use of CLZ instruction when
    parsing fragment blocks
Admin:
  Built and included in an OMAP3 ROM. But be warned, this has not received
  the rigorous testing normally required of filesystem code, use at your
  own risk.

Version 3.33. Tagged as 'FileCore-3_33'
@
text
@d50 1
@


4.9
log
@  Updated build structure to use the shared AAsmModule makefile.
  Updated to build using objasm instead of aasm.
  Sources changed to be objasm-compatible.
Admin:
  Requires Library 0.72 or later.
  Requires BuildSys 3.09 or later.
  Requires Env 0.65 or later.

Version 3.29. Tagged as 'FileCore-3_29'
@
text
@d49 1
@


4.8
log
@HAL branch changes (to code to read Timer0) merged. Should still assemble
on non-HAL builds.

Version 3.28. Tagged as 'FileCore-3_28'
@
text
@d18 3
a20 3
        GET     s.Fixes
        GET     s.AsmHdr
        GET     s.DevVersion
d50 27
a76 27
        GET     s.DebugOpts
        GET     s.MyMacros
        GET     s.Defns
        GET     s.FileCore00
        GET     s.FileCore05
        GET     s.FileCore15
        GET     s.FileCore20
        GET     s.FileCore25
        GET     s.FileCore30
        GET     s.FileCore31
        GET     s.FileCore32
        GET     s.FileCore33
        GET     s.FileCore35
        GET     s.FileCore40
        GET     s.FileCore45
        GET     s.TokenHelp
        GET     s.InitDieSvc
        GET     s.Commands
        GET     s.GenSWIs
        GET     s.MsgsStuff
        GET     s.FileCore60
        GET     s.FileCore70
        GET     s.FileCore80
        GET     s.FormSrvcs
        GET     s.FormSWIs
        GET     s.Identify
        GET	s.BigDirCode
@


4.7
log
@
  * Removed dependency on obsolete STB and StrongARM flags.

Detail:

  * No longer reliant on STB flag.  Now both Desktop and Embedded builds
    are the same (which, of course, they should be).

Admin:

  * StripDepnd support moved to MkClean file.

  * The "What'sHere" file has been renamed to "ReadMe", since the existence
    of the single-quote causes problems with some Unix commands (notably
    'xargs').

  * Built and tested in a Lazarus 32-bit build.

Version 3.27. Tagged as 'FileCore-3_27'
@
text
@d25 7
@


4.6
log
@32-bit compatible. Some known issues remaining - don't use, except for
testing.

Version 3.23. Tagged as 'FileCore-3_23'
@
text
@a42 3
        GBLL StrongARM
StrongARM  SETL :LNOT:STB

@


4.6.2.1
log
@Simple HAL changes to stop it accessing Timer0 directly. Nowhere near
actually accessing other than a RAM disc on a non-IOMD machine.

Version 3.25, 4.9.2.1. Tagged as 'FileCore-3_25-4_9_2_1'
@
text
@a24 1
        GET     Hdr:HALEntries
@


4.6.2.2
log
@HAL changes conditionalised, so it should be possible to move it onto the
trunk.

Version 3.25, 4.9.2.2. Tagged as 'FileCore-3_25-4_9_2_2'
@
text
@d25 1
a25 7
        GBLS    GetHAL
 [ HAL
GetHAL  SETS    "GET Hdr:HALEntries"
 |
GetHAL  SETS    ""
 ]
        $GetHAL
@


4.5
log
@  Merge of Ursula branch to the trunk.
Detail:
  This module represents the latest version of FileCore incorporating
    both the Ursula changes and the ROL changes as we have them to date.
  Changes from ROL-FileCore-3_21 are basically the stripping of trailling
    spaces and the change of Version to Module_Version in the conditionals.
    No other changes.
Admin:
  ROL branch tagged ROL_merge
  Ursula branch tagged Ursula_merge.
  Untested, but essentially the same as ROL-FileCore-3_21, so no problems
    expected.

Version 3.21. Tagged as 'FileCore-3_21'
@
text
@d24 1
a24 1
	GET	Hdr:Machine.<Machine>
@


4.4
log
@Changed to cope with new Hdr:CMOS

Version 3.00. Tagged as 'FileCore-3_00'
@
text
@d24 1
a24 1
        GET     Hdr:Machine.<Machine>
d72 1
@


4.3
log
@Spinner branch merged.
Makefile changed to use LocalRes$Path.
Changed to use srccommit.
StrongARM flag now set to :LNOT:STB

Version 2.99. Tagged as 'FileCore-2_99'
@
text
@d24 1
a41 1
        GET     Hdr:Machine.<Machine>
@


4.2
log
@RiscOS 3.70 version used
@
text
@d16 1
a16 3
        GBLL StrongARM
StrongARM  SETL {TRUE}

d41 4
@


4.2.2.1
log
@Fixed a bug with NewClaimFree (and its use of SortDir) which caused problems
with 16 bit object ids.  Now copes with long ids correctly.

Started on bits of code for the long file names work.
@
text
@a69 1
        GET	s.BigDirCode
@


4.2.2.1.4.1
log
@* Added GET Hdr:Machine.<Machine> to s.FileCore to allow it to be compiled
  with new-style HdrSrc.
* Tagged as ROL_FileCore-3_21
@
text
@a25 1
	GET	Hdr:Machine.<Machine>
@


4.2.2.2
log
@Added inclusion of Machine file in s.FileCore to stop Hdr:CMOS blowing up.

Tagged FileCore-3_18
@
text
@a25 1
	GET	Hdr:Machine.<Machine>
@


4.1
log
@Initial revision
@
text
@d16 2
@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@@


4.1.5.1
log
@Import from SrcFiler
@
text
@@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@a15 2
        GBLL StrongARM
StrongARM  SETL {TRUE}
@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
