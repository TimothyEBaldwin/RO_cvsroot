head	4.10;
access;
symbols
	FileCore-3_46:4.9
	FileCore-3_45:4.9
	FileCore-3_44:4.8
	FileCore-3_43:4.8
	FileCore-3_42:4.8
	FileCore-3_41:4.7
	FileCore-3_40:4.6
	FileCore-3_39:4.6
	FileCore-3_38:4.6
	FileCore-3_37:4.6
	FileCore-3_36:4.6
	FileCore-3_35:4.6
	FileCore-3_34:4.6
	FileCore-3_33:4.6
	RO_5_07:4.6
	FileCore-3_32:4.6
	FileCore-3_31:4.6
	FileCore-3_30:4.6
	FileCore-3_29:4.6
	FileCore-3_28:4.5
	FileCore-3_25-4_9_2_2:4.4
	FileCore-3_27:4.5
	FileCore-3_26:4.5
	FileCore-3_22-4_6_2_1:4.3.2.1
	bavison_FileCore-3_22_dev_bp:4.3
	bavison_FileCore-3_22:4.3.0.2
	FileCore-3_25-4_9_2_1:4.4
	HAL:4.4.0.2
	FileCore-3_25:4.4
	FileCore-3_24:4.4
	FileCore-3_23:4.4
	dellis_autobuild_BaseSW:4.3
	FileCore-3_22:4.3
	Ursula_merge:4.1.4.1
	ROL_merge:4.1.4.1
	FileCore-3_21:4.3
	ROL_Ursula_merge:4.1.4.1
	Ursula_RiscPC_merge:4.1.4.1
	sbrodie_sedwards_16Mar2000:4.2
	dcotton_autobuild_BaseSW:4.6
	ROL_FileCore-3_21:4.1.4.1
	ROL_FileCore-3_20:4.1.4.1
	ROL:4.1.4.1.0.4
	ROL_bp:4.1.4.1
	Ursula_RiscPC_bp:4.1.4.1
	FileCore-3_18:4.1.4.1
	FileCore-3_01:4.2
	mstphens_UrsulaRiscPCBuild_20Nov98:4.1.4.1
	Ursula_RiscPC:4.1.4.1.0.2
	FileCore-3_00:4.2
	FileCore-2_99:4.2
	aglover_FileCore-3_17:4.1.4.1
	sproven_FileCore-3_16:4.1.4.1
	rthornb_UrsulaBuild-19Aug1998:4.1.4.1
	UrsulaBuild_FinalSoftload:4.1.4.1
	rthornb_UrsulaBuild-12Aug1998:4.1.4.1
	aglover_UrsulaBuild-05Aug1998:4.1.4.1
	rthornb_UrsulaBuild-29Jul1998:4.1.4.1
	rthornb_UrsulaBuild-22Jul1998:4.1.4.1
	rthornb_UrsulaBuild-15Jul1998:4.1.4.1
	rthornb_UrsulaBuild-07Jul1998:4.1.4.1
	rthornb_UrsulaBuild-17Jun1998:4.1.4.1
	rthornb_UrsulaBuild-03Jun1998:4.1.4.1
	rthornb_UrsulaBuild-27May1998:4.1.4.1
	rthornb_UrsulaBuild-21May1998:4.1.4.1
	sproven_FileCore-3_15:4.1.4.1
	sproven_314:4.1.4.1
	rthornb_UrsulaBuild_01May1998:4.1.4.1
	afrost_Funai01-33:4.1.7.1
	afrost_NC2_Generic:4.1.7.1
	sproven_313:4.1.4.1
	sproven_3_11:4.1.4.1
	sproven_3_10:4.1.4.1
	sproven_Ursula_3_09:4.1.4.1
	sproven_3_07:4.1.4.1
	sproven_3_06:4.1.4.1
	sproven_3_05:4.1.4.1
	sproven_3_04:4.1.4.1
	Spinner_RCA116:4.1.7.1
	sproven_3_03:4.1.4.1
	sproven_3_02:4.1
	sproven_3_01:4.1
	sproven_2_99:4.1
	sproven_2_98:4.1
	Spinner_B20_2:4.1.7.1
	Spinner_19_3:4.1.7.1
	Spinner_B18:4.1.7.1
	Spinner_B17:4.1.7.1
	Spinner_B15:4.1.7.1
	Spinner_B14:4.1.7.1
	Spinner_B13:4.1.7.1
	Spinner_B12:4.1.7.1
	Spinner_B10:4.1.7.1
	Daytona:4.1.0.6
	Daytona_bp:4.1
	Ursula:4.1.0.4
	Ursula_bp:4.1
	Spinner_B7:4.1.7.1
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	RCA_bp:4.1
	ARTtmp:4.1.7.1.0.2
	RCA:4.1.0.2
	Spin_merge:4.1.7.1
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.10
date	2011.11.25.08.50.22;	author rsprowson;	state dead;
branches;
next	4.9;
commitid	Wvsb4iMJaWIw2HIv;

4.9
date	2011.10.14.07.23.51;	author rsprowson;	state Exp;
branches;
next	4.8;
commitid	D2Id4aPp4zmuUhDv;

4.8
date	2011.10.02.20.25.33;	author rsprowson;	state Exp;
branches;
next	4.7;
commitid	A9Zxco9ydo9FCOBv;

4.7
date	2011.09.13.19.13.15;	author rsprowson;	state Exp;
branches;
next	4.6;
commitid	PKTDORFkNFRVOmzv;

4.6
date	2001.05.14.14.27.08;	author sbrodie;	state Exp;
branches;
next	4.5;

4.5
date	2000.12.07.17.25.29;	author bavison;	state Exp;
branches;
next	4.4;

4.4
date	2000.10.30.13.26.34;	author kbracey;	state Exp;
branches;
next	4.3;

4.3
date	2000.05.09.11.37.00;	author sbrodie;	state Exp;
branches
	4.3.2.1;
next	4.2;

4.2
date	98.09.21.12.07.27;	author kbracey;	state Exp;
branches;
next	4.1;

4.1
date	96.11.05.09.32.22;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.4.1
	4.1.5.1
	4.1.7.1;
next	;

4.3.2.1
date	2000.12.07.17.11.15;	author bavison;	state Exp;
branches;
next	;

4.1.1.1
date	96.11.05.09.32.22;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.06.00.38.52;	author nturton;	state Exp;
branches;
next	;

4.1.4.1
date	97.12.01.12.03.10;	author sproven;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.12.34.18;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.20.31.11;	author nturton;	state Exp;
branches;
next	;


desc
@@


4.10
log
@Fold in old fixes.
From 1989, probably safe to keep them. Binary unchanged.

Version 3.47. Tagged as 'FileCore-3_47'
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
;>Fixes   Modification history of FileCore since V 2.00 (15 Sep 1988)

        GBLA    max_fix
max_fix SETA    5

        MACRO
        fcfix   $number,$state,$description
        GBLL    fix_$number
fix_$number SETL {TRUE}
        [ fix_$number
        ! 0,"Apply fix $number $description"
        ]
        MEND


; VERSION 2.00


        fcfix   1,{TRUE},Fix LDR to LDRB in *Defect
;25-Oct-88      NReeves
;When *Defect reads the number of winnies from workspace it uses LDR rather
;than LDRB. This means when *Defect is used on a floppy it has a 50% chance
;of producing a spurious 'File Core error' after successfully mapping out
;the defect. There is also a small chance of corrupting other parts of the RMA.


; VERSION 2.01
; the date was left at 15-Sep-88 since the change was done by patching the ROM


        fcfix   2,{TRUE},Fix address exceptions in DiscOp when Winnies=0
;4-Dec-89       RCManby
;If FileCore was used with Winnies=0 and FileCore_DiscOp called for drive 4..7
;filecore would give an address exception in WaitForControllerFree. This was
;because WinnieProcessBlk would be unallocated (and set to &FC000003).
;We now check the specified drive type and the appropriate Winnies/Floppies
;count and report BadDriveErr early on in RetryDriveOp


; VERSION 2.02
; released dated 06-Dec-89

        fcfix   3,{TRUE},Fix address exceptions on 8th floppy disc when Winnies=0
;12-Jan-90      RCManby
;If FileCore was used with Winnies=0 and Buffers<>0 (ie read ahead and write
;behind enabled), opening a file on the eighth floppy shown to Filecore
;would cause the TickerV code to give an address exception.
;Due to a bug in MyOpenFile (ORRLO instead of ORRLS), the disc record for
;this floppy was mistaken for that of a winnie. This ment that the
;FcbFloppyFlag in FcbFlags was cleared, which lead to the clearing of the
;NoOpenWinnie bit in Interlocks.
;On finding NoOpenWinnie clear, TickerEntry picked up WinnieProcessBlk
;and passed it to BackgroundOps. Since WinnieProcessBlk isn't claimed when
;Winnies=0 (its set to &FC000003), BackgroundOps exploded.


; VERSION 2.03
; released dated 22-Jan-90




        fcfix   4,{TRUE},ProcessBlock calling in service reset
;16-May-90      BCockburn & RManby
;

; VERSION 2.05
;

; VERSION 2.41 (RISC OS 3.10)
;

        fcfix   5,{TRUE},File allocation length estimation in Delete and CheckMap

; This flags those section of code adjusted to treat winnies as floppies.
; These changes are based upon previous changes made during the development
; of version 2.05, in particular the decoupling of winnie disc numbers from
; winnie drive numbers. In summary WinniesAsFloppies changes are to do with
; applying the floppywritebehind algorithms symetrically to winnies.
; (Note - the WinniesAsFloppies flag has been removed).


        fcfix   6,{FALSE},SWI LayoutStructure can't handle defects >512M

; FileCore_LayoutStructure takes &20000000 as the defect list end, when the
; PRM says -1.  We use a second defect list, terminated by &40000000, just
; after the first one, as held in the boot block.  defects in the second
; list are thus sector numbers.  this occurs for all discs where the BigFlag
; field is set in the disc record passed

; This flag determins whether RMA or System heap is used for fcbs
        GBLL    UseRMAForFCBs
UseRMAForFCBs   SETL {TRUE}

; updated semantics of scatter list to allow background transfer
; to/from top-bit set logical addresses
        GBLL    FixTBSAddrs
FixTBSAddrs     SETL    {TRUE}
ScatterListNegThresh    *       &10000

                        GBLL    FixTruncateOnBigDiscs
FixTruncateOnBigDiscs   SETL    {TRUE}

        END
@


4.9
log
@Revise exports in "hdr.FileCore".
Now, for each SWI call there is a definition of any pertinent structures it asks for and definitions of any bitfields within those flags. This avoids the need for clients to endlessly redefine these locally (in practice it looks like sections of FileCore were simply copy and pasted into clients RAMFS/SCSIFS/ADFS). Delete private definitions.
This binary was carefully checked to be identical since so many locations were changed.
Then, the following additional changes:
* InitDieSvc line 74, the floppy config is extracted using a mask and shift rather than reaching up the stack
* Identify lin 1254, the superfluous instruction marked as such deleted
* FileCore15 line 762 recoded the check for background op to not need the bit number defined any more
* FileCore00 moved the label 'anull' to be word aligned guaranteed
The duff pointer marker ('nowt' = &40000000) is no longer used to mark territory translation tables as invalid as that address is now quite reasonable. -1 is used instead.

Version 3.45. Tagged as 'FileCore-3_45'
@
text
@@


4.8
log
@Make debug versions assemble again.
Entry macro renamed as SemEntry to avoid conflict with Hdr:Proc.
Other macro bit rot fixed up.
Tidy up switches.
DebugFx switch is the only one that doesn't work.
Non debug binary same as 3.41.

Version 3.42. Tagged as 'FileCore-3_42'
@
text
@d115 2
a116 2
			GBLL	FixTruncateOnBigDiscs
FixTruncateOnBigDiscs	SETL	{TRUE}
@


4.7
log
@Delete s.AsmHdr, s.DevVersion, Version, s.ModHand
Delete Doc.!ReadMe, update Doc.!Implement
Collapse dead switches.
s.MyMacros:
 Remove 'nop' macro, use NOP.
s.Defns:
 Some definitions taken from global headers.
s.Commands:
 Indentation and function calling parameter comments reviewed.

Still produces the same binary as 3.40.
@
text
@a22 4
        [ test_version
fix_$number SETL $state
        |
         [ $number <= max_fix
a23 4
         |
fix_$number SETL {FALSE}
         ]
        ]
d115 3
@


4.6
log
@  Updated build structure to use the shared AAsmModule makefile.
  Updated to build using objasm instead of aasm.
  Sources changed to be objasm-compatible.
Admin:
  Requires Library 0.72 or later.
  Requires BuildSys 3.09 or later.
  Requires Env 0.65 or later.

Version 3.29. Tagged as 'FileCore-3_29'
@
text
@d17 3
@


4.5
log
@  Re-applied fixes from FileCore-3_22-4_6_2_1 to the trunk.
Detail:
  Scatter list wrap condition updated to allow top-bit-set memory accesses.
Admin:
  Not tested - any issues related to the 32-bit conversion have not been
  addressed. I'd suggest that you use the branched version mentioned above,
  except in test builds.

Version 3.26. Tagged as 'FileCore-3_26'
@
text
@d18 1
a18 1
        fix     $number,$state,$description
d38 1
a38 1
        fix     1,{TRUE},Fix LDR to LDRB in *Defect
d50 1
a50 1
        fix     2,{TRUE},Fix address exceptions in DiscOp when Winnies=0
d62 1
a62 1
        fix     3,{TRUE},Fix address exceptions on 8th floppy disc when Winnies=0
d82 1
a82 1
        fix     4,{TRUE},ProcessBlock calling in service reset
d92 1
a92 1
        fix     5,{TRUE},File allocation length estimation in Delete and CheckMap
d102 1
a102 1
	fix	6,{FALSE},SWI LayoutStructure can't handle defects >512M
@


4.4
log
@32-bit compatible. Some known issues remaining - don't use, except for
testing.

Version 3.23. Tagged as 'FileCore-3_23'
@
text
@d114 6
@


4.3
log
@  Merge of Ursula branch to the trunk.
Detail:
  This module represents the latest version of FileCore incorporating
    both the Ursula changes and the ROL changes as we have them to date.
  Changes from ROL-FileCore-3_21 are basically the stripping of trailling
    spaces and the change of Version to Module_Version in the conditionals.
    No other changes.
Admin:
  ROL branch tagged ROL_merge
  Ursula branch tagged Ursula_merge.
  Untested, but essentially the same as ROL-FileCore-3_21, so no problems
    expected.

Version 3.21. Tagged as 'FileCore-3_21'
@
text
@d99 1
a108 3

        GBLL    WinniesAsFloppies
WinniesAsFloppies SETL Module_Version >= 205
@


4.3.2.1
log
@  Fixes to allow loading to/saving from top-bit-set addresses.
Detail:
  Updated to use the new conditions for wrapping around scatter lists, as
  first used in ADFS 3.33, viz that the address word is >= &FFFF0000, rather
  than just being negative.
Admin:
  Tested briefly - at least the one reproducable data abort that I had is now
  fixed.

Version 3.22, 4.6.2.1. Tagged as 'FileCore-3_22-4_6_2_1'
@
text
@a115 6
; updated semantics of scatter list to allow background transfer
; to/from top-bit set logical addresses
        GBLL    FixTBSAddrs
FixTBSAddrs     SETL    {TRUE}
ScatterListNegThresh    *       &10000

@


4.2
log
@Spinner branch merged.
Makefile changed to use LocalRes$Path.
Changed to use srccommit.
StrongARM flag now set to :LNOT:STB

Version 2.99. Tagged as 'FileCore-2_99'
@
text
@d99 10
@


4.1
log
@Initial revision
@
text
@d100 1
a100 1
WinniesAsFloppies SETL Version >= 205
@


4.1.4.1
log
@Altered directory format (change backup dir entries to be one word instead
of an entire copy of the entry).  Also reduced size of a directory entry
by one word.  Also fixed a number of small bugs.
@
text
@a98 10


	fix	6,{FALSE},SWI LayoutStructure can't handle defects >512M

; FileCore_LayoutStructure takes &20000000 as the defect list end, when the
; PRM says -1.  We use a second defect list, terminated by &40000000, just
; after the first one, as held in the boot block.  defects in the second
; list are thus sector numbers.  this occurs for all discs where the BigFlag
; field is set in the disc record passed

@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@@


4.1.5.1
log
@Import from SrcFiler
@
text
@@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
