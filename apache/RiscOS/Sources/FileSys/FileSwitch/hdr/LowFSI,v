head	4.5;
access;
symbols
	FileSwitch-2_87:4.5
	FileSwitch-2_86:4.5
	FileSwitch-2_85:4.5
	FileSwitch-2_84:4.5
	FileSwitch-2_83:4.4
	FileSwitch-2_82:4.4
	FileSwitch-2_81:4.3
	FileSwitch-2_80:4.3
	FileSwitch-2_79:4.3
	FileSwitch-2_78:4.3
	FileSwitch-2_77:4.3
	FileSwitch-2_76:4.3
	FileSwitch-2_75:4.3
	FileSwitch-2_74:4.3
	FileSwitch-2_73:4.3
	FileSwitch-2_72:4.3
	FileSwitch-2_71:4.3
	FileSwitch-2_70:4.3
	FileSwitch-2_69:4.3
	FileSwitch-2_68:4.3
	FileSwitch-2_67:4.3
	RO_5_07:4.3
	FileSwitch-2_66:4.3
	FileSwitch-2_65:4.3
	FileSwitch-2_64:4.3
	FileSwitch-2_63:4.3
	FileSwitch-2_62:4.3
	FileSwitch-2_61:4.3
	FileSwitch-2_60:4.3
	FileSwitch-2_59:4.3
	FileSwitch-2_58:4.3
	FileSwitch-2_57:4.3
	FileSwitch-2_56:4.3
	FileSwitch-2_55:4.3
	FileSwitch-2_54:4.3
	FileSwitch-2_53:4.2
	dellis_autobuild_BaseSW:4.2
	FileSwitch-2_52:4.2
	FileSwitch-2_51:4.2
	ROLtd-4_02:4.2
	FileSwitch-2_45:4.2
	Ursula_merge:4.2
	FileSwitch-2_50:4.2
	sbrodie_sedwards_16Mar2000:4.2
	FileSwitch-2_41:4.2
	dcotton_Spin_merge:4.1.7.1
	FileSwitch-2_40:4.2
	dcotton_autobuild_BaseSW:4.3
	FileSwitch-2_39:4.2
	FileSwitch-2_43:4.2
	Ursula_FileSwitch-2_42:4.2
	mstphens_UrsulaRiscPCBuild_20Nov98:4.2
	Ursula_RiscPC:4.2.0.8
	nicke_FileSwitch-2_29:4.1.7.1
	FileSwitch-2_38:4.2
	rthornb_UrsulaBuild-19Aug1998:4.2
	UrsulaBuild_FinalSoftload:4.2
	rthornb_UrsulaBuild-12Aug1998:4.2
	aglover_UrsulaBuild-05Aug1998:4.2
	rthornb_UrsulaBuild-29Jul1998:4.2
	rthornb_UrsulaBuild-22Jul1998:4.2
	rthornb_UrsulaBuild-15Jul1998:4.2
	rthornb_UrsulaBuild-07Jul1998:4.2
	rthornb_UrsulaBuild-17Jun1998:4.2
	rthornb_UrsulaBuild-03Jun1998:4.2
	rthornb_UrsulaBuild-27May1998:4.2
	rthornb_UrsulaBuild-21May1998:4.2
	rthornb_UrsulaBuild_01May1998:4.2
	afrost_Funai01-33:4.1.7.1
	afrost_NC2_Generic:4.1.7.1
	sproven_241:4.2
	sproven_2_40:4.2
	sproven_2_38:4.2
	Spinner_RCA116:4.1.7.1
	Spinner_B20_2:4.1.7.1
	Spinner_19_3:4.1.7.1
	Spinner_B18:4.1.7.1
	Spinner_B17:4.1.7.1
	Spinner_B15:4.1.7.1
	Spinner_B14:4.1.7.1
	Spinner_B13:4.1.7.1
	Spinner_B12:4.1.7.1
	Spinner_B10:4.1.7.1
	Daytona:4.2.0.6
	Daytona_bp:4.2
	Ursula:4.2.0.2
	Ursula_bp:4.2
	Spinner_B7:4.1.7.1
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	RCA_bp:4.2
	ARTtmp:4.1.7.1.0.2
	RCA:4.2.0.4
	Spin_merge:4.1.7.1
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.5
date	2016.07.05.20.21.16;	author rsprowson;	state Exp;
branches;
next	4.4;
commitid	qafTwTPNUUN5Jadz;

4.4
date	2013.03.11.21.11.09;	author rsprowson;	state Exp;
branches;
next	4.3;
commitid	qH6q1SKEMrc3YpHw;

4.3
date	2001.03.19.10.12.42;	author sbrodie;	state Exp;
branches;
next	4.2;

4.2
date	97.01.14.17.11.39;	author nturton;	state Exp;
branches;
next	4.1;

4.1
date	96.11.05.09.32.44;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.5.1
	4.1.7.1;
next	;

4.1.1.1
date	96.11.05.09.32.44;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.06.00.50.02;	author nturton;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.12.36.26;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.20.33.03;	author nturton;	state Exp;
branches;
next	;


desc
@@


4.5
log
@A few extra fsfunc symbols
Add fsfunc_Opt subreasons, fsfunc_DirIs subreasons.
Expand tabs on fsargs_IOCtl.
No code change, retagged as FileSwitch-2_84.
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
        SUBT    Low level Filing System interfaces => &.Hdr.LowFSi

OldOpt  SETA    {OPT}
        OPT     OptNoList+OptNoP1List

; ***********************************
; ***    C h a n g e   L i s t    ***
; ***********************************

; Date       Name  Description
; ----       ----  -----------
; 03-Mar-88  SKS   Add fsinfo_flushnotify
; 08-Mar-88  SKS   Add fsinfo_fsfilereadinfonolen, fsfile_ReadInfoNoLen
; 18-Mar-88  BC    Add fsfunc_FileInfo
; 21-Apr-88  SKS   Add fsinfo_fileinfo
; 13-Jul-88  SKS   Add fsinfo_nfiles, removed pre 1-20 mods
; 09-Oct-89  BC    Add fsfunc_LastFileClosed
; 01-Nov-89  BC    Remove fsfunc_LastFileClosed
;  4-Dec-89  NDR   Add fsinfo_readonly
; 16-Jul-90  JSR   Add fsinfo_multifsextensions
; 03-Sep-90  JSR   Add fsfunc_NewImage, fsfunc_ImageClosing values.
; 22-Oct-90  JSR   Add IFS_... structure, fsinfo_handlesurdetc,
;                       fsinfo_nodirectories
; 25-Oct-90  JSR   Add fsinfo_dontuseload
; 22-Nov-90  JSR   Add fsfunc_DefectList and fsfunc_AddDefect
; 15-Mar-91  JSR   Add fsfile_ReadBlockSize
;                      fsfunc_ReadBootOption
;                      fsfunc_WriteBootOption
; 21-Mar-91  JSR   Add fsfunc_UsedSpaceMap
; 09-Apr-91  JSR   Add fsfunc_ReadFreeSpace
; 26-Apr-91  JSR   Add fsfunc_NameDisc
; 29-Apr-91  JSR   Add fsfunc_StampImage
;                      fsargs_ImageStampIs
; 09-May-91  JSR   Add fsfunc_ObjectAtOffset
; 12-Jul-91  JSR   Add fsinfo_dontusesave
;                      fsinfo_giveaccessstring
;                      fsinfo_extrainfo
;                      fsextra_dirinformation
;                      fsfunc_DirIs
; 22-Jul-91  JSR   Update FSHeader macro to handle extrainfo
; 07-Aug-91  JSR   Add fsextra_FSDoesCat
;                      fsextra_FSDoesEx
; 16-Sep-91  BC    Added symbols for calculating the fsinfo word
; 03-Nov-94  amg   Add fsfunc_ReadFreeSpace64
; 09-Nov-94  amg   Add fsfunc_DefectList64, fsfunc_AddDefect64
; 02-Nov-95  MFC   Add Max_BuffSize
; 29-Apr-96  RWB   Add fsextra_IOCtl and fsargs_IOCtl

        MACRO
$label  FSHeader $info, $extrainfo
$label._FSInfoBlock
        DCD     $label._Name        -$label._ModuleBase
        DCD     $label._StartupText -$label._ModuleBase
        DCD     $label._Open        -$label._ModuleBase
        DCD     $label._Get         -$label._ModuleBase
        DCD     $label._Put         -$label._ModuleBase
        DCD     $label._Args        -$label._ModuleBase
        DCD     $label._Close       -$label._ModuleBase
        DCD     $label._File        -$label._ModuleBase
        DCD     $info
        DCD     $label._Func        -$label._ModuleBase
        DCD     $label._GBPB        -$label._ModuleBase
 [ "$extrainfo"=""
 ASSERT (.-$label._FSInfoBlock) = FS_size - 4
 |
        DCD     $extrainfo
 ASSERT (.-$label._FSInfoBlock) = FS_size
 ]
        MEND


; The variable Max_BuffSize determines the maximum permitted value for the
;  "natural block size" returned by a Filing System to FileSwitch when
;  FSEntry_Open is called. The value must be a power of 2.
;
; In versions of FileSwitch prior to 2.28, this was hard-coded as 1024.
; From FileSwitch 2.28 it is 2048, which is of considerable benefit to CDFS.
; From FileSwitch 2.82 it is 4096, for Advanced Format '4Kn' harddiscs.

Max_BuffSize   *   4096


; Offsets from start of FS information block in a FS module

         ^      0
FS_name  #      4
FS_startuptext # 4
FS_open  #      4 ; --+
FS_get   #      4 ;   |
FS_put   #      4 ;   } Module offsets in same order and offset as fscb_xxx
FS_args  #      4 ;   |
FS_close #      4 ;   |
FS_file  #      4 ; --+
FS_info  #      4
FS_func  #      4 ; --|
FS_gbpb  #      4 ; --+ For fast unbuffered gbpb
FS_extra #      4 ; extra information word
FS_size  *      @@-FS_name

; Bits in FS_info

fsinfo_special          * 1 :SHL: 31
fsinfo_notpermanent     * 1 :SHL: 30
fsinfo_nullnameok       * 1 :SHL: 29
fsinfo_alwaysopen       * 1 :SHL: 28    ; Try to open regardless of file exist
fsinfo_flushnotify      * 1 :SHL: 27    ; Tell filing system when flushing
fsinfo_fsfilereadinfonolen * 1 :SHL: 26 ; fsfile_ReadInfoNoLen supported
fsinfo_fileinfo         * 1 :SHL: 25    ; fsfunc_FileInfo supported
fsinfo_setcontexts      * 1 :SHL: 24    ; fsfunc_SetContexts supported
fsinfo_multifsextensions * 1:SHL: 23    ; Calls introduced for MultiFS supported:
                                        ; fsfunc_CanonicaliseSpecialAndDisc
                                        ; fsfunc_ResolveWildcard
fsinfo_handlesurdetc    * 1 :SHL: 22    ; This FS must handle & and % itself, so pass
                                        ; these through please, FileSwitch.
fsinfo_nodirectories    * 1 :SHL: 21    ; Don't store directories for this FS in system
                                        ; variables. When pressed FileSwitch will plug
                                        ; in the default values for the directories.
fsinfo_dontuseload      * 1 :SHL: 20    ; Don't use fsfile_Load, but openin, gbgp, close
                                        ; instead
fsinfo_dontusesave      * 1 :SHL: 19    ; Don't use fsfile_Save, but create, openup, gbgp, close
                                        ; instead
fsinfo_giveaccessstring * 1 :SHL: 18    ; On a *access use the access entry point quoting the
                                        ; access string. If this bit is clear OS_File will be
                                        ; used instead, with the access string having been parsed
                                        ; by FileSwitch
fsinfo_extrainfo        * 1 :SHL: 17    ; FS_extra present

fsinfo_readonly         * 1 :SHL: 16    ; filing system is read-only

fsinfo_nfiles_shift     * 8
fsinfo_nfiles           * &FF :SHL: fsinfo_nfiles_shift
                                        ; Min number of files openable on fs
                                        ; 0 -> unlimited by fs
fsinfo_number_shift     * 0
fsinfo_number           * &FF :SHL: fsinfo_number_shift

fsinfo_notforMultiFS    * :NOT: fsinfo_flushnotify      ; Anything other than flushnotify is going to upset a MultiFS

; Bits in FS_extra
fsextra_dirinformation  * 1 :SHL: 0     ; filing system supports fsfunc_DirIs
fsextra_FSDoesCat       * 1 :SHL: 1     ; filing system does Cat rather than FileSwitch
fsextra_FSDoesEx        * 1 :SHL: 2     ; filing system does Ex rather than FileSwitch
fsextra_IOCtl           * 1 :SHL: 3     ; filing system does IOCtls
; bits 4-31 unused (yet)

; Offsets from start of IFS information block in a IFS (MultiFS) module

                ^       0
IFS_info        #       4
IFS_filetype    #       4
IFS_open        #       4
IFS_get         #       4
IFS_put         #       4
IFS_args        #       4
IFS_close       #       4
IFS_file        #       4
IFS_func        #       4
IFS_size        *       @@-IFS_info


; Reason codes passed to fscb^.File

fsfile_Load          *  &FF
fsfile_Save          *  0
fsfile_WriteInfo     *  1
fsfile_WriteLoad     *  2
fsfile_WriteExec     *  3
fsfile_WriteAttr     *  4
fsfile_ReadInfo      *  5
fsfile_Delete        *  6
fsfile_Create        *  7
fsfile_CreateDir     *  8
fsfile_ReadInfoNoLen *  9
fsfile_ReadBlockSize *  10


; Reason codes passed to fscb^.Open

                    ^ 0
fsopen_ReadOnly     # 1
fsopen_CreateUpdate # 1
fsopen_Update       # 1


; Bits in r0 passed back from fscb^.Open

fsopen_WritePermission  * 1 :SHL: 31
fsopen_ReadPermission   * 1 :SHL: 30
fsopen_IsDirectory      * 1 :SHL: 29
fsopen_UnbufferedGBPB   * 1 :SHL: 28
fsopen_Interactive      * 1 :SHL: 27
fsopen_DeviceIdentity   * &FFFFFFFF :SHR: (32-27)


; Reason codes passed to fscb^.Args

                        ^ 0
fsargs_ReadPTR          # 1     ; ARGS 0        0  Only unbuffered fs
fsargs_SetPTR           # 1     ; ARGS 1        1  Only unbuffered fs
fsargs_ReadEXT          # 1     ; ARGS 2        2  Only unbuffered fs
fsargs_SetEXT           # 1     ; ARGS 3        3  All fs
fsargs_ReadSize         # 1     ; ARGS 4        4  Only unbuffered fs
fsargs_EOFCheck         # 1     ; ARGS 5        5  Only unbuffered fs
fsargs_Flush            # 1     ; ARGS 255      6  Only unbuffered fs (or Nick)
fsargs_EnsureSize       # 1     ; ARGS 6        7  All fs
fsargs_WriteZeroes      # 1     ; internal      8  Only buffered fs
fsargs_ReadLoadExec     # 1     ; internal      9  All fs
fsargs_ImageStampIs     # 1     ; ARGS 8        10 Only
fsargs_IOCtl            # 1     ; ARGS 9        11


; Reason codes passed to fscb^.Func

                        ^ 0
fsfunc_Dir                        # 1 ;0  FSC 0
fsfunc_Lib                        # 1 ;1  FSC 1
fsfunc_Cat                        # 1 ;2  FSC 5
fsfunc_Ex                         # 1 ;3  FSC 6
fsfunc_LCat                       # 1 ;4  FSC 7
fsfunc_LEx                        # 1 ;5  FSC 8
fsfunc_Info                       # 1 ;6  FSC 9
fsfunc_Opt                        # 1 ;7  FSC 10
fsfunc_Opt_Default                * 0
fsfunc_Opt_Boot                   * 4
fsfunc_Rename                     # 1 ;8  FSC 25
fsfunc_Access                     # 1 ;9  FSC 24
fsfunc_Bootup                     # 1 ;10 FSC 15
fsfunc_ReadDiscName               # 1 ;11 GBPB 5
fsfunc_ReadCSDName                # 1 ;12 GBPB 6
fsfunc_ReadLIBName                # 1 ;13 GBPB 7
fsfunc_ReadDirEntries             # 1 ;14 GBPB 9
fsfunc_ReadDirEntriesInfo         # 1 ;15 GBPB 10
fsfunc_ShutDown                   # 1 ;16 FSC 23
fsfunc_PrintBanner                # 1 ;17 internal
fsfunc_SetContexts                # 1 ;18 FSC ??
fsfunc_CatalogObjects             # 1 ;19 GBPB 11
fsfunc_FileInfo                   # 1 ;20 FSC 32 *FileInfo
fsfunc_NewImage                   # 1 ;21 one of your image files has been opened
fsfunc_ImageClosing               # 1 ;22 one of your image files is about to be closed
fsfunc_CanonicaliseSpecialAndDisc # 1 ;23 For canonicalising a path
fsfunc_ResolveWildcard            # 1 ;24 For canonicalising a path
fsfunc_DefectList                 # 1 ;25 For obtaining the image's defect list
fsfunc_AddDefect                  # 1 ;26 For adding a defect
fsfunc_ReadBootOption             # 1 ;27 For reading the boot option
fsfunc_WriteBootOption            # 1 ;28 For writing the boot option
fsfunc_UsedSpaceMap               # 1 ;29 for reading the used space map
fsfunc_ReadFreeSpace              # 1 ;30 for reading the free space
fsfunc_NameDisc                   # 1 ;31 for naming a disc
fsfunc_StampImage                 # 1 ;32 for image stamping control
fsfunc_ObjectAtOffset             # 1 ;33
fsfunc_DirIs                      # 1 ;34 for NetFS (and others if they want)
fsfunc_DirIs_CSD                  * 0
fsfunc_DirIs_PSD                  * 1
fsfunc_DirIs_URD                  * 2
fsfunc_DirIs_Lib                  * 3
fsfunc_ReadFreeSpace64            # 1 ;35 for reading the free space in 64 bit (FSC 55)
fsfunc_DefectList64               # 1 ;36 for obtaining the image's defect list (two words per defect)
fsfunc_AddDefect64                # 1 ;37 for adding a defect expressed in two words

        OPT OldOpt
        END
@


4.4
log
@Increase maximum supported buffer size to 4k
LowFSI: Max_BuffSize define changed.
FileSwBody: Module workspace claim changed to claim Max_BuffSize in addition to the workspace required, so that all the variables in the workspace remain within ADR range.
OSFind: Vetting of acceptable buffer sizes now produced with a WHILE/WEND loop.
StreamBits: Changed to use 'free' flag rather then comparing with 'Nowt'.
MkClean/MkRom: Throwback enabled.

Tested in IOMD ROM, workspace manually inspected as OK.

Version 2.82. Tagged as 'FileSwitch-2_82'
@
text
@d157 1
a157 1
fsextra_IOCtl		* 1 :SHL: 3	; filing system does IOCtls
d174 1
d223 2
a224 1
fsargs_IOCtl		# 1	; ARGS 9	11
d237 2
d266 4
@


4.3
log
@  hdr/LowFSI was not objasm-compatible!
Detail:
  It is not legal for lines to end in \ unless the intention is that the
    line be rejoined.  This caused a structure member to be missing in the
    filing system header file which could have caused absolute havoc.
  Assertions are dead useful ...
Admin:
  Built.
  Required by SystemDevices 1.30 or later (and other components)

Version 2.54. Tagged as 'FileSwitch-2_54'
@
text
@d88 1
a88 1
;  FSEntry_Open is called.
d91 4
a94 9
;
; The value must be a power of 2, and is set to 2048 in 2.28. This is of
;  considerable benefit to CDFS, since the sector size on CD-ROMs is
;  2048 bytes.
;
; If any value other than 1024 or 2048 is chosen, code in s.OSFind will also
;  need to be changed (search for Max_BuffSize and it's obvious).
 
Max_BuffSize   *   2048
@


4.2
log
@Module merged
@
text
@d107 1
a107 1
FS_open  #      4 ; --\
d112 1
a112 1
FS_file  #      4 ; --/
d114 2
a115 2
FS_func  #      4 ; --\
FS_gbpb  #      4 ; --/ For fast unbuffered gbpb
@


4.1
log
@Initial revision
@
text
@d60 2
a61 1
; 
d86 16
d162 2
a163 1
; bits 3-31 unused (yet)
d226 2
a227 1
fsargs_ImageStampIs     # 1     ; ARGS 8        10 Only 
@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@d60 1
a60 2
; 02-Nov-95  MFC   Add Max_BuffSize
; 29-Apr-96  RWB   Add fsextra_IOCtl and fsargs_IOCtl
a84 16
; The variable Max_BuffSize determines the maximum permitted value for the
;  "natural block size" returned by a Filing System to FileSwitch when
;  FSEntry_Open is called.
;
; In versions of FileSwitch prior to 2.28, this was hard-coded as 1024.
;
; The value must be a power of 2, and is set to 2048 in 2.28. This is of
;  considerable benefit to CDFS, since the sector size on CD-ROMs is
;  2048 bytes.
;
; If any value other than 1024 or 2048 is chosen, code in s.OSFind will also
;  need to be changed (search for Max_BuffSize and it's obvious).

Max_BuffSize   *   2048


d145 1
a145 2
fsextra_IOCtl		* 1 :SHL: 3	; filing system does IOCtls
; bits 4-31 unused (yet)
d208 1
a208 2
fsargs_ImageStampIs     # 1     ; ARGS 8        10 Only
fsargs_IOCtl		# 1	; ARGS 9	11
@


4.1.5.1
log
@Import from SrcFiler
@
text
@d60 1
a60 2
; 02-Nov-95  MFC   Add Max_BuffSize
; 29-Apr-96  RWB   Add fsextra_IOCtl and fsargs_IOCtl
a84 16
; The variable Max_BuffSize determines the maximum permitted value for the
;  "natural block size" returned by a Filing System to FileSwitch when
;  FSEntry_Open is called.
;
; In versions of FileSwitch prior to 2.28, this was hard-coded as 1024.
;
; The value must be a power of 2, and is set to 2048 in 2.28. This is of
;  considerable benefit to CDFS, since the sector size on CD-ROMs is
;  2048 bytes.
;
; If any value other than 1024 or 2048 is chosen, code in s.OSFind will also
;  need to be changed (search for Max_BuffSize and it's obvious).

Max_BuffSize   *   2048


d145 1
a145 2
fsextra_IOCtl		* 1 :SHL: 3	; filing system does IOCtls
; bits 4-31 unused (yet)
d208 1
a208 2
fsargs_ImageStampIs     # 1     ; ARGS 8        10 Only
fsargs_IOCtl		# 1	; ARGS 9	11
@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@d60 1
a60 1
; 02-Nov-95  MFC   Add Max_BuffSize
a82 16


; The variable Max_BuffSize determines the maximum permitted value for the
;  "natural block size" returned by a Filing System to FileSwitch when
;  FSEntry_Open is called.
;
; In versions of FileSwitch prior to 2.28, this was hard-coded as 1024.
;
; The value must be a power of 2, and is set to 2048 in 2.28. This is of
;  considerable benefit to CDFS, since the sector size on CD-ROMs is
;  2048 bytes.
;
; If any value other than 1024 or 2048 is chosen, code in s.OSFind will also
;  need to be changed (search for Max_BuffSize and it's obvious).
 
Max_BuffSize   *   2048
@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
