head	4.12;
access;
symbols
	FileSwitch-2_87:4.12
	FileSwitch-2_86:4.11
	FileSwitch-2_85:4.11
	FileSwitch-2_84:4.11
	FileSwitch-2_83:4.11
	FileSwitch-2_82:4.11
	FileSwitch-2_81:4.11
	FileSwitch-2_80:4.11
	FileSwitch-2_79:4.11
	FileSwitch-2_78:4.11
	FileSwitch-2_77:4.11
	FileSwitch-2_76:4.11
	FileSwitch-2_75:4.11
	FileSwitch-2_74:4.11
	FileSwitch-2_73:4.11
	FileSwitch-2_72:4.11
	FileSwitch-2_71:4.10
	FileSwitch-2_70:4.9
	FileSwitch-2_69:4.9
	FileSwitch-2_68:4.9
	FileSwitch-2_67:4.8
	RO_5_07:4.7
	FileSwitch-2_66:4.7
	FileSwitch-2_65:4.7
	FileSwitch-2_64:4.6
	FileSwitch-2_63:4.6
	FileSwitch-2_62:4.6
	FileSwitch-2_61:4.6
	FileSwitch-2_60:4.6
	FileSwitch-2_59:4.6
	FileSwitch-2_58:4.6
	FileSwitch-2_57:4.6
	FileSwitch-2_56:4.5
	FileSwitch-2_55:4.5
	FileSwitch-2_54:4.5
	FileSwitch-2_53:4.5
	dellis_autobuild_BaseSW:4.4
	FileSwitch-2_52:4.4
	FileSwitch-2_51:4.3
	ROLtd-4_02:4.2.2.2
	FileSwitch-2_45:4.2.2.2
	Ursula_merge:4.2.2.2
	FileSwitch-2_50:4.3
	sbrodie_sedwards_16Mar2000:4.2
	FileSwitch-2_41:4.2
	dcotton_Spin_merge:4.1.7.1
	FileSwitch-2_40:4.2
	dcotton_autobuild_BaseSW:4.6
	FileSwitch-2_39:4.2
	FileSwitch-2_43:4.2.2.2
	Ursula_FileSwitch-2_42:4.2.2.2
	mstphens_UrsulaRiscPCBuild_20Nov98:4.2.2.2
	Ursula_RiscPC:4.2.2.2.0.2
	nicke_FileSwitch-2_29:4.1.7.1
	FileSwitch-2_38:4.2
	rthornb_UrsulaBuild-19Aug1998:4.2.2.2
	UrsulaBuild_FinalSoftload:4.2.2.2
	rthornb_UrsulaBuild-12Aug1998:4.2.2.2
	aglover_UrsulaBuild-05Aug1998:4.2.2.2
	rthornb_UrsulaBuild-29Jul1998:4.2.2.2
	rthornb_UrsulaBuild-22Jul1998:4.2.2.2
	rthornb_UrsulaBuild-15Jul1998:4.2.2.2
	rthornb_UrsulaBuild-07Jul1998:4.2.2.2
	rthornb_UrsulaBuild-17Jun1998:4.2.2.2
	rthornb_UrsulaBuild-03Jun1998:4.2.2.2
	rthornb_UrsulaBuild-27May1998:4.2.2.2
	rthornb_UrsulaBuild-21May1998:4.2.2.2
	rthornb_UrsulaBuild_01May1998:4.2.2.2
	afrost_Funai01-33:4.1.7.1
	afrost_NC2_Generic:4.1.7.1
	sproven_241:4.2.2.2
	sproven_2_40:4.2.2.1
	sproven_2_38:4.2
	Spinner_RCA116:4.1.7.1
	Spinner_B20_2:4.1.7.1
	Spinner_19_3:4.1.7.1
	Spinner_B18:4.1.7.1
	Spinner_B17:4.1.7.1
	Spinner_B15:4.1.7.1
	Spinner_B14:4.1.7.1
	Spinner_B13:4.1.7.1
	Spinner_B12:4.1.7.1
	Spinner_B10:4.1.7.1
	Daytona:4.2.0.6
	Daytona_bp:4.2
	Ursula:4.2.0.2
	Ursula_bp:4.2
	Spinner_B7:4.1.7.1
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	RCA_bp:4.2
	ARTtmp:4.1.7.1.0.2
	RCA:4.2.0.4
	Spin_merge:4.1.7.1
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.12
date	2018.06.08.08.09.32;	author rsprowson;	state Exp;
branches;
next	4.11;
commitid	qYabIIAebGnw5sFA;

4.11
date	2011.11.27.11.59.31;	author rsprowson;	state Exp;
branches;
next	4.10;
commitid	SMknibmDFieq1YIv;

4.10
date	2011.11.27.11.56.26;	author rsprowson;	state Exp;
branches;
next	4.9;
commitid	K4NCQAqLgaBl0YIv;

4.9
date	2011.08.04.21.27.55;	author jlee;	state Exp;
branches;
next	4.8;
commitid	IhtTEsao98YEReuv;

4.8
date	2009.06.15.23.01.34;	author bavison;	state Exp;
branches;
next	4.7;

4.7
date	2002.12.12.15.41.58;	author kbracey;	state Exp;
branches;
next	4.6;

4.6
date	2001.04.17.11.29.46;	author dcotton;	state Exp;
branches;
next	4.5;

4.5
date	2001.03.01.13.45.47;	author sforrest;	state Exp;
branches;
next	4.4;

4.4
date	2000.03.20.15.57.44;	author kbracey;	state Exp;
branches;
next	4.3;

4.3
date	2000.03.20.14.30.47;	author kbracey;	state Exp;
branches;
next	4.2;

4.2
date	97.01.14.17.11.49;	author nturton;	state Exp;
branches
	4.2.2.1;
next	4.1;

4.1
date	96.11.05.09.32.47;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.5.1
	4.1.7.1;
next	;

4.2.2.1
date	98.04.07.11.09.55;	author sproven;	state Exp;
branches;
next	4.2.2.2;

4.2.2.2
date	98.04.16.14.49.10;	author sproven;	state Exp;
branches;
next	;

4.1.1.1
date	96.11.05.09.32.47;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.06.00.51.07;	author nturton;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.12.36.38;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.20.33.14;	author nturton;	state Exp;
branches;
next	;


desc
@@


4.12
log
@Fix for missing monitor name after load
The code path that filing systems the register with dontuseload omitted the line printed when *OPT 1 is non-zero.
In particular this meant FileCore (which has the fsinfo word flag set) didn't report any monitor name.
For dontusesave, the initial call to do the equivalent of *Create covers the output even though it's a bit early. However, the flag check appeared to be inverted, so an FS with it set would call OS_File, and one clear would call OS_GBPB.

FileSwHdr.s: Remove use_fsfile_Save and use_fsfile_Load switches, since clients declare at runtime what their preference is (since RISC OS 3).
LowLevel.s: Extract monitor name reporting code, replace with function call to common code.
FSShared.s: Common function ReportMonitor.
OSFile.s: After doing a load via OS_GBPB call the monitor name reporting code. Tune up the StrongARM code flush code a little to not need R5 as a temporary. Fix inverted sense of dontusesave.

Version 2.87. Tagged as 'FileSwitch-2_87'
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
        SUBT    > Sources.FileSwHdr - for standalone assembly

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; Other implementation modifiers

                GBLL    appendhandle       ; Append channel number to error messages?
appendhandle    SETL    {FALSE}

                                           ; Ursula performance enhancements
                GBLL    MercifulToSysHeap  ; attempt to avoid very frequent OS_Heap
                                           ; claims and releases for sytem heap
                GBLL    MercifulTracing    ; tracing for diagnostics only
MercifulToSysHeap SETL  {TRUE}
MercifulTracing   SETL  {FALSE} :LAND: MercifulToSysHeap

                GBLL    CatExLong
CatExLong       SETL    {TRUE}             ; if this is set to TRUE, then *cat, *ex, etc, will attempt
                                           ; to make the display look better with long filenames

                GBLL    ChopOffTheGoolies
ChopOffTheGoolies SETL  {FALSE}            ; For deviant OS debugging versions

                GBLL    chopoffdollarfrompaths
chopoffdollarfrompaths  SETL     {FALSE}

                GBLL    sparebuffer
sparebuffer     SETL    {TRUE}

                GBLL    osfile5cache
osfile5cache    SETL    {TRUE}

                GBLL    kludgeforNFS
kludgeforNFS    SETL    {FALSE}

		GBLL	StrongARM
		GBLL	SASTMhatbroken
StrongARM	SETL	{TRUE}
SASTMhatbroken	SETL	{TRUE} :LAND: StrongARM

	GBLL	UseDynamicAreas
UseDynamicAreas	SETL	{TRUE}

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; Flags to strip out copy + wipe for MOS debugging versions

                GBLL    hascopy
                GBLL    haswipe
                GBLL    hascount
                GBLL    hasutil

 [ ChopOffTheGoolies ; For Sam MOS debugging versions
hascopy         SETL    {FALSE}
haswipe         SETL    {FALSE}
hascount        SETL    {FALSE}
 |
hascopy         SETL    {TRUE}
haswipe         SETL    {TRUE}
hascount        SETL    {TRUE}
 ]
hasutil         SETL    hascopy :LOR: haswipe :LOR: hascount

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; One or two header definitions

        GET     Hdr:ListOpts
        OPT     OptNoList
        GET     Hdr:Macros
        GET     Hdr:System
        GET     Hdr:Machine.<Machine>
        GET     Hdr:UserIF.<UserIF>
        GET     Hdr:ImageSize.<ImageSize>

      [ :LNOT: No26bitCode            ; Get brutal with 32-bitness - use 26-bit code unless 
No32bitCode     SETL {TRUE}           ; we really mustn't, as 32-bit is a performance drain.
      ]                               ; Can't really softload FileSwitch anyway.

        GET     Hdr:CMOS
        GET     Hdr:ModHand
        GET     Hdr:Services
        GET     Hdr:FSNumbers
        GET     Hdr:HighFSI
        GET     Hdr:NewErrors
        GET     Hdr:Heap
        GET     Hdr:Variables
        GET     Hdr:EnvNumbers
        GET     Hdr:Proc
        GET     Hdr:PublicWS          ; Import ScratchSpace
        GET     Hdr:Tokens
        GET     Hdr:FileTypes
        GET     Hdr:VduExt
        GET     Hdr:UpCall
        GET     Hdr:LowFSI
        GET     Hdr:Wimp              ; It happens to us all in the end ...
        GET     Hdr:MsgTrans
        GET     Hdr:Territory
        GET     Hdr:OSRSI6            ; Import DomainId
        GET     VersionASM

        OPT     OptList + OptPage

        END
@


4.11
log
@assert -> ASSERT.
Collapse old switches.
Remove 'Version' GBLA.
*COUNT summary now says "total 1234 bytes" not "1234 bytes" to match *COPY
Empty *COUNT syntax message corrected.
Binary identical to last version (messages different clearly).

Version 2.72. Tagged as 'FileSwitch-2_72'
@
text
@a53 6
                GBLL    Use_fsfile_Save
Use_fsfile_Save SETL    {TRUE}             ; Indicates whether fsfile_Save reason is used, or create, open, GBPB, close

        GBLL    Use_fsfile_Load
Use_fsfile_Load SETL    {TRUE}             ; Indicates whether fsfile_Load reason is used, or open, GBPB, close

@


4.10
log
@Fixed up a deprecated push (in OSBgetBput), untangled two STM single reg (in OSFile).
Delete unused 'KernelFSW'.
HighFSI
 Retire some crusty definitions
 Reserve OS_FSControl reason codes used by ROL

Version 2.71. Tagged as 'FileSwitch-2_71'
@
text
@d93 3
a95 3
      [ :LNOT: No26bitCode            ; Get brutal with 32-bitness - use 26-bit code unless we really mustn't,
No32bitCode     SETL {TRUE}           ; as 32-bit is a performance drain. Can't softload FileSwitch really,
      ]                               ; anyway.
d107 1
a107 1
        GET     Hdr:PublicWS          ; Import ScratchSpace, DomainId
d112 1
a112 1
        GET     Hdr:LowFSi
d116 1
a116 1
        GET     Hdr:OSRSI6
a117 2
                GBLA  Version
Version         SETA  Module_Version
a120 21
 [ False
        AREA    FileSwitch, CODE, READONLY, RELOCATABLE

        EXPORT  BGetEntry
        EXPORT  BPutEntry
 |
        AREA    |FileSwitch$$Code|, CODE, READONLY, PIC
 ]
        ENTRY

TAB     *       09
LF      *       10
CR      *       13

        MACRO
        assert  $condition
 [ :LNOT: ($condition)
 ! 1,"assert failed: $condition"
 ]
        MEND

@


4.9
log
@Update to work with zero page relocation
Detail:
  s/FileSwBody, s/FileSwHdr - Try getting DomainId pointer via OS_ReadSysInfo 6 before falling back on legacy address. Store result in workspace for speedy lookup.
  s/FSCommon - Use workspace DomainId pointer
  s/CtrlUtils - Update int_ConstructFullPathWithoutFSAndSpecial to not attempt to append the contents of null string pointers.
  s/FSControl - Update AppendStringIfNotNull to ignore null pointers
  s/LowLevel - Update CallFSFile_Given to not try copying from null special field strings
Admin:
  Tested on rev A2 BB-xM.
  AFAIK the null pointer bugs are all FileSwitch bugs and not bugs in whatever called FileSwitch, although I may be wrong. Not entirely sure how some of the code managed to read strings from null pointers without creating garbage filenames as a result!


Version 2.68. Tagged as 'FileSwitch-2_68'
@
text
@d17 68
d93 4
a96 6
; Get brutal with 32-bitness - use 26-bit code unless we really mustn't,
; as 32-bit is a performance drain. Can't softload FileSwitch really,
; anyway.
 [ :LNOT: No26bitCode
No32bitCode     SETL {TRUE}
 ]
d117 3
a136 18

        GBLL    ChopOffTheGoolies       ; For deviant OS debugging versions
ChopOffTheGoolies SETL False

        ; Indicates whether fsfile_Save reason is used, or create, open, GBPB, close
        GBLL    Use_fsfile_Save
Use_fsfile_Save SETL True

        ; Indicates whether fsfile_Load reason is used, or open, GBPB, close
        GBLL    Use_fsfile_Load
Use_fsfile_Load SETL True

	GBLL	CatExLong
CatExLong	SETL	{TRUE}

	GBLL	UseDynamicAreas
UseDynamicAreas	SETL	{TRUE}

@


4.8
log
@  Bugfix to OS_File 5
Detail:
  s.LowLevel: STRNE should have been STRNEB. Looks like this meant that
  OS_File 5 was broken if the object name contained a filing system special
  field.
  Added ENTRY directive to permit building of GPA debug listing.
Admin:
  Built but not tested (should be a safe change).

Version 2.67. Tagged as 'FileSwitch-2_67'
@
text
@d50 1
@


4.7
log
@More 32-bit fixes; all to do with coping with the system heap, ROM etc
being in new places - these are now checked at run-time.

Version 2.65. Tagged as 'FileSwitch-2_65'
@
text
@d61 1
@


4.6
log
@    Altered to use shared makefiles and ObjAsm.

Detail:
    As above. No other changes.

Admin:
    Tested in a Lazarus build.

Version 2.57. Tagged as 'FileSwitch-2_57'
@
text
@d23 1
d41 1
a41 1
        GET     Hdr:PublicWS          ; Import SVCSTK, SysHeap, ScratchSpace
@


4.5
log
@
  * Removed dependency on obsolete STB flag.

Detail:

  * No longer relies on the STB flag; instead utilises "Hdr:UserIF.<UserIF>"
    to provide the Embedded_UI flag.

    The only difference between Desktop and Embedded builds is that the
    filing system name is NOT printed on Embedded builds upon Service_Reset.

Admin:

  * Built and tested on Lazarus 32-bit build.  Code is binary identical to
    previous versions the relied on the STB flag in both the Desktop and
    Embedded cases.

  * Requires HdrSrc 1.17 or later.

Version 2.53. Tagged as 'FileSwitch-2_53'
@
text
@d58 1
a58 1
        LEADR   Module_LoadAddr
@


4.4
log
@  32-bit compatible.
Admin:
  Tested on a 32-bit system; untested on 26-bit, and merge with Ursula branch
  untested.

Version 2.52. Tagged as 'FileSwitch-2_52'
@
text
@d22 1
@


4.3
log
@  Ursula branch merged.
Detail:
  Full merge of Ursula branch. Path length limited to 256 if a compile-time
  check says SVCSTK is still &01C02000.

  Fix to bug introduced in RISC OS 3.70 - any errors returned by FSEntry_File
  255 were ignored.
  Some changes from RISC OS Ltd still to come.
Admin:
  Untested.

Version 2.50. Tagged as 'FileSwitch-2_50'
@
text
@d22 7
@


4.2
log
@Module merged
@
text
@d69 6
@


4.2.2.1
log
@Fixed bug whereby *info <filename> (where the filename is not wildcarded)
gives the error "buffer overflow".  Error also fixed for *fileinfo.
@
text
@a68 3
	GBLL	CatExLong
CatExLong	SETL	{TRUE}

@


4.2.2.2
log
@Updated the FSControl code to make the copy operation use a dynamic area,
instead of the free pool.  The maximum size of this dynamic area is set as
the size of the 'next' slot.  This prevents the problems associated with
*copy where it will claim all the free memory, thus stoppping for example
filecore from growing its directory buffer, or zap from growing its dynamic
area.  This makes multiple *copies in task windows usable.
@
text
@a71 3
	GBLL	UseDynamicAreas
UseDynamicAreas	SETL	{TRUE}

@


4.1
log
@Initial revision
@
text
@d21 1
@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@a20 1
        GET     Hdr:Machine.<Machine>
@


4.1.5.1
log
@Import from SrcFiler
@
text
@a20 1
        GET     Hdr:Machine.<Machine>
@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
