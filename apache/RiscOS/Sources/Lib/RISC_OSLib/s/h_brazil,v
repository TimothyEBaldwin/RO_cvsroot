head	4.6;
access;
symbols
	RISC_OSLib-5_97:4.6
	RISC_OSLib-5_96:4.6
	RISC_OSLib-5_95:4.6
	RISC_OSLib-5_94:4.6
	RISC_OSLib-5_93:4.6
	RISC_OSLib-5_92:4.6
	RISC_OSLib-5_91:4.6
	RISC_OSLib-5_90:4.6
	RISC_OSLib-5_89:4.6
	RISC_OSLib-5_88:4.6
	RISC_OSLib-5_87:4.6
	RISC_OSLib-5_86-1:4.6
	RISC_OSLib-5_86:4.6
	RISC_OSLib-5_85:4.6
	RISC_OSLib-5_84:4.6
	RISC_OSLib-5_83-2:4.6
	RISC_OSLib-5_83-1:4.6
	RISC_OSLib-5_83:4.6
	RISC_OSLib-5_82:4.6
	RISC_OSLib-5_81:4.6
	RISC_OSLib-5_75-2:4.6
	RISC_OSLib-5_80:4.6
	RISC_OSLib-5_79:4.6
	RISC_OSLib-5_78:4.6
	RISC_OSLib-5_75-1:4.6
	RISC_OSLib-5_77:4.6
	RISC_OSLib-5_76:4.5
	RISC_OSLib-5_75:4.5
	RISC_OSLib-5_74:4.5
	RISC_OSLib-5_73:4.5
	RISC_OSLib-5_72:4.5
	RISC_OSLib-5_71:4.5
	RISC_OSLib-5_70:4.5
	RISC_OSLib-5_69:4.5
	RISC_OSLib-5_68:4.5
	RISC_OSLib-5_67:4.5
	RISC_OSLib-5_66:4.5
	RISC_OSLib-5_65:4.5
	RISC_OSLib-5_64:4.4
	RISC_OSLib-5_63:4.4
	RISC_OSLib-5_62:4.4
	RISC_OSLib-5_61:4.4
	RISC_OSLib-5_60:4.4
	RISC_OSLib-5_59:4.4
	RISC_OSLib-5_58:4.4
	RISC_OSLib-5_57:4.4
	RISC_OSLib-5_56:4.4
	RISC_OSLib-5_55:4.4
	RISC_OSLib-5_54:4.4
	RISC_OSLib-5_53:4.4
	RISC_OSLib-5_52:4.4
	RISC_OSLib-5_51:4.4
	RO_5_07:4.4
	RISC_OSLib-5_50:4.4
	RISC_OSLib-5_49:4.4
	RISC_OSLib-5_46-4_64_2_1:4.4
	NoInlineAsm:4.4.0.2
	RISC_OSLib-5_48:4.4
	RISC_OSLib-5_47:4.4
	RISC_OSLib-5_46:4.4
	RISC_OSLib-5_45:4.4
	RISC_OSLib-5_44:4.4
	RISC_OSLib-5_43:4.3
	RISC_OSLib-5_42:4.3
	RISC_OSLib-5_41:4.3
	RISC_OSLib-5_40:4.3
	RISC_OSLib-5_39:4.3
	RISC_OSLib-5_38:4.3
	RISC_OSLib-5_37:4.3
	RISC_OSLib-5_36:4.3
	RISC_OSLib-5_35:4.3
	RISC_OSLib-5_34:4.3
	RISC_OSLib-5_33-4_50_2_1:4.3
	sbrodie_dev:4.3.0.2
	sbrodie_dev_bp:4.3
	RISC_OSLib-5_33:4.3
	RISC_OSLib-5_32:4.3
	RISC_OSLib-5_31:4.3
	RISC_OSLib-5_30:4.3
	RISC_OSLib-5_29:4.3
	RISC_OSLib-5_28:4.3
	RISC_OSLib-5_27:4.3
	RISC_OSLib-5_26:4.3
	RISC_OSLib-5_25:4.3
	RISC_OSLib-5_24:4.3
	RISC_OSLib-5_01-4_16_2_5:4.1
	RISC_OSLib-5_23:4.3
	RISC_OSLib-5_22:4.3
	RISC_OSLib-5_21:4.3
	RISC_OSLib-5_20:4.3
	RISC_OSLib-5_19:4.3
	RISC_OSLib-5_18:4.3
	RISC_OSLib-5_17:4.3
	RISC_OSLib-5_16:4.3
	RISC_OSLib-5_15:4.3
	dellis_autobuild_BaseSW:4.3
	RISC_OSLib-5_14:4.3
	RISC_OSLib-5_13:4.3
	RISC_OSLib-5_12:4.3
	RISC_OSLib-5_01-4_16_2_4:4.1
	RISC_OSLib-5_11:4.3
	RISC_OSLib-5_01-4_16_2_3:4.1
	RISC_OSLib-5_01-4_16_2_2:4.1
	RISC_OSLib-5_10:4.3
	RISC_OSLib-5_01-4_16_2_1:4.1
	Bethany:4.1.0.12
	RISC_OSLib-5_09:4.2
	RISC_OSLib-5_08:4.2
	RISC_OSLib-5_07:4.2
	RISC_OSLib-5_06:4.2
	RISC_OSLib-4_97-4_12_2_8:4.1.10.3
	RISC_OSLib-5_05:4.1
	RISC_OSLib-5_04:4.1
	sbrodie_sedwards_16Mar2000:4.1
	RISC_OSLib-5_03:4.1
	RISC_OSLib-5_02:4.1
	RISC_OSLib-4_97-4_12_2_7:4.1.10.2
	RISC_OSLib-5_01:4.1
	RISC_OSLib-5_00:4.1
	RISC_OSLib-4_99:4.1
	RISC_OSLib-4_98:4.1
	RISC_OSLib-4_97-4_12_2_6:4.1.10.2
	RISC_OSLib-4_97-4_12_2_5:4.1.10.2
	RISC_OSLib-4_97-4_12_2_4:4.1.10.2
	RISC_OSLib-4_97-4_12_2_3:4.1.10.1
	RISC_OSLib-4_97-4_12_2_2:4.1
	sbrodie_RISC_OSLib-4_97-4_12_2_1:4.1
	kbracey_32bit:4.1.0.10
	kbracey_32bit_bp:4.1
	dcotton_autobuild_BaseSW:4.3
	RISC_OSLib-4_97:4.1
	RISC_OSLib-4_96:4.1
	RISC_OSLib-4_95:4.1
	RISC_OSLib-4_94:4.1
	RISC_OSLib-4_93:4.1
	RISC_OSLib-4_92:4.1
	mstphens_UrsulaRiscPCBuild_20Nov98:4.1
	Ursula_RiscPC:4.1.0.8
	sforrest_daytona_appflash-0_31:4.1
	RISC_OSLib-4_91:4.1
	RISC_OSLib-4_90:4.1
	RISC_OSLib-4_89:4.1
	Ursula_merge:4.1
	RISC_OSLib-4_88:4.1
	RISC_OSLib-4_87:4.1
	blaughto_daytona_appflash-0_30:4.1
	rmanby_clib-4_86:4.1
	rthornb_UrsulaBuild-19Aug1998:4.1
	UrsulaBuild_FinalSoftload:4.1
	rthornb_UrsulaBuild-12Aug1998:4.1
	aglover_UrsulaBuild-05Aug1998:4.1
	rthornb_UrsulaBuild-29Jul1998:4.1
	rthornb_UrsulaBuild-22Jul1998:4.1
	rthornb_UrsulaBuild-15Jul1998:4.1
	rthornb_UrsulaBuild-07Jul1998:4.1
	rthornb_UrsulaBuild-17Jun1998:4.1
	rthornb_UrsulaBuild-03Jun1998:4.1
	rthornb_UrsulaBuild-27May1998:4.1
	rthornb_UrsulaBuild-21May1998:4.1
	rthornb_UrsulaBuild_01May1998:4.1
	afrost_NC2_Generic:4.1.7.1
	Spinner_B20_2:4.1.7.1
	Spinner_19_3:4.1.7.1
	Spinner_B18:4.1.7.1
	Spinner_B17:4.1.7.1
	Spinner_B15:4.1.7.1
	Spinner_B14:4.1.7.1
	Spinner_B13:4.1.7.1
	Spinner_B12:4.1.7.1
	Spinner_B10:4.1.7.1
	Daytona:4.1.0.6
	Daytona_bp:4.1
	Ursula:4.1.0.4
	Ursula_bp:4.1
	Spinner_B7:4.1.7.1
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	ARTtmp:4.1.7.1.0.2
	Spin_merge:4.1.7.1
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.6
date	2013.03.24.08.06.53;	author rsprowson;	state Exp;
branches;
next	4.5;
commitid	sKrRgCgz4PD5d1Jw;

4.5
date	2011.11.26.13.04.59;	author rsprowson;	state Exp;
branches;
next	4.4;
commitid	oqcep4Kpl6STpQIv;

4.4
date	2002.11.15.15.00.33;	author kbracey;	state Exp;
branches;
next	4.3;

4.3
date	2000.07.03.12.30.41;	author kbracey;	state Exp;
branches;
next	4.2;

4.2
date	2000.05.09.14.09.42;	author kbracey;	state Exp;
branches;
next	4.1;

4.1
date	96.11.05.09.25.41;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.5.1
	4.1.7.1
	4.1.10.1;
next	;

4.1.1.1
date	96.11.05.09.25.41;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.05.19.56.14;	author nturton;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.11.35.12;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.19.51.47;	author nturton;	state Exp;
branches;
next	;

4.1.10.1
date	99.11.10.14.02.38;	author kbracey;	state Exp;
branches;
next	4.1.10.2;

4.1.10.2
date	99.11.10.16.59.11;	author kbracey;	state Exp;
branches;
next	4.1.10.3;

4.1.10.3
date	2000.05.09.13.58.56;	author kbracey;	state Exp;
branches;
next	;


desc
@@


4.6
log
@Build fix
s/h_brazil: use Hdr:System instead of GETting them one at a time
c/scanf: type cast

Version 5.77. Tagged as 'RISC_OSLib-5_77'
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
; -*- Mode: Assembler -*-
;* Lastedit: 08 Mar 90 12:05:26 by Harry Meekings *
; OS interface for Clibrary / shared kernel
; Copyright (C) Acorn Computers Ltd., 1988

; The version number below bears no resemblance to any release version
; numbers.  It must be incremented by one each time a non-downwards compatible
; version of the library is produced (ie one where the new stubs will not
; function correctly with an older library).
LibraryVersionNumber            *       6

        GET     Hdr:ListOpts
        GET     Hdr:Machine.<Machine>
        GET     Hdr:APCS.<APCS>
        GET     Hdr:Macros
        GET     Hdr:System
        GET     Hdr:ModHand
        GET     Hdr:FPEmulator

        GBLL    StrongARM
        GBLL    SASTMhatbroken
; This switch should be read as the "maybe split caches, don't do dynamic
; code" switch *only*, other StrongARM things like storing PC+8/PC+12
; differences must be deduced at run time. In 'kernel.s.swiv' this results
; in use of OS_CallASWI so as a result the CallASWI module must be loaded
; for pre RISC OS 3.70 use, and there are a few XOS_SynchroniseCodeAreas too.
StrongARM       SETL {TRUE}
SASTMhatbroken  SETL {TRUE} :LAND: StrongARM

X               EQU     1:SHL:17

; SWIs common to Brazil and Arthur
WriteC          EQU     X+0
WriteS          EQU     X+1
Write0          EQU     X+2
NewLine         EQU     X+3
ReadC           EQU     X+4
CLI             EQU     X+5
Byte            EQU     X+6
Word            EQU     X+7
File            EQU     X+8
Args            EQU     X+9
BGet            EQU     X+&a
BPut            EQU     X+&b
Multiple        EQU     X+&c
Open            EQU     X+&d
ReadLine        EQU     X+&e
Control         EQU     X+&f
GetEnv          EQU     X+&10
Exit            EQU     X+&11
SetEnv          EQU     X+&12
IntOn           EQU     X+&13
IntOff          EQU     X+&14
CallBack        EQU     X+&15
EnterSVC        EQU     X+&16
BreakPt         EQU     X+&17
BreakCtrl       EQU     X+&18
UnusedSWI       EQU     X+&19
KUpdateMEMC     EQU     X+&1A
SetCallBack     EQU     X+&1B
Mouse           EQU     X+&1C

WriteI          EQU     X+&100

; Arthur only SWIs
Module          EQU     X+&1E
ChangeEnv       EQU     X+&40
GenerateError   EQU     &2B               ; X form not sensible
ReadVarVal      EQU     X+&23
SetVarVal       EQU     X+&24
ExitAndDie      EQU     X+&4D

Lib_Init        EQU     &80680            ; shared library initialise

FPE_Version     EQU     X+&40480

Module_Claim    EQU     6                 ; Module reason codes
Module_Free     EQU     7
Module_Extend   EQU     13

; r0 values for swi ChangeEnv
Env_MemoryLimit         EQU     0
Env_UIHandler           EQU     1
Env_PAHandler           EQU     2
Env_DAHandler           EQU     3
Env_AEHandler           EQU     4
Env_ErrorHandler        EQU     6
Env_CallBackHandler     EQU     7
Env_EscapeHandler       EQU     9
Env_EventHandler        EQU     10
Env_ExitHandler         EQU     11
Env_ApplicationSpace    EQU     14
Env_UpCallHandler       EQU     16

Application_Base EQU    &8000

 [ ModeMayBeNonUser
        MACRO
        EnterLeafProcContainingSWI
        FunctionEntry
        MEND

        MACRO
        ExitLeafProcContainingSWI $cond
        Return
        MEND

  |

        MACRO
        EnterLeafProcContainingSWI
        MEND

        MACRO
        ExitLeafProcContainingSWI $cond
        Return "", LinkNotStacked
        MEND
 ]

 [ :DEF:DEFAULT_TEXT
        MACRO
        ErrorBlock $name, $string, $tag, $withdefault
E_$name
        &       Error_$name
        =       "$string", 0
        ALIGN
        ASSERT  "$tag" <> ""
        &       Error_$name
        =       "$tag", 0
        ALIGN
        MEND
 |
        MACRO
        ErrorBlock $name, $string, $tag, $withdefault
E_$name
        ASSERT  "$tag" <> ""
        &       Error_$name
  [ "$withdefault" <> ""
        =       "$tag:$string", 0
  |
        =       "$tag", 0
  ]
        ALIGN
        MEND
 ]

; Arthur error numbers
Error_NameNotFound              *       &124
Error_ValueTooLong              *       &125

Error_IllegalInstruction        *       &80000000
Error_PrefetchAbort             *       &80000001
Error_DataAbort                 *       &80000002
Error_AddressException          *       &80000003
Error_UnknownIRQ                *       &80000004
Error_BranchThroughZero         *       &80000005

Error_FPBase                    *       &80000200
Error_FPLimit                   *       &80000300

; Arthur errors generated by the library
CLib_Error_Base                 *       &800e80
CLib_Error_Range                *       &80

Error_BadMemory                 *       &800e80
Error_UnknownLib                *       &800e81
Error_StubCorrupt               *       &800e82
Error_StaticSizeWrong           *       &800e83
Error_StaticOffsetInconsistent  *       &800e84
Error_UnknownSWI                *       &800e85
Error_OldAPCS_A                 *       &800e86 ; } error number shared
Error_OldAPCS_R                 *       &800e86 ; }

Error_SharedLibraryNeeded       *       &800e90
Error_OldSharedLibrary          *       &800e91
Error_NoVeneer                  *     &80800e92
 [ :DEF:NEW_SWIS
Error_UnknownFn                 *       &800e93
 ]

Error_ReadFail                  *     &80800ea0
Error_WriteFail                 *     &80800ea1

Error_RecursiveTrap             *       &800e00
Error_UncaughtTrap              *       &800e01
Error_NoMainProgram             *       &800e02
Error_NotAvailable              *       &800e03
Error_NoEnvFile                 *       &800e04
Error_NoRoomForEnv              *       &800e05
Error_BadReturnCode             *       &800e06
Error_NoStackForTrapHandler     *       &800e07
Error_Exit                      *       &800e08   ; in non-user mode
Error_NoWorkSpace               *       &800e09

Error_ReservedForOverlayManager1 *      &800efe
Error_ReservedForOverlayManager2 *      &800eff

Error_DivideByZero              *     &80000020
Error_StackOverflow             *     &80000021

        END
@


4.5
log
@Review use of StrongARM switch.
Was being used to conditionalise things which aren't really StrongARM related, now should be read as "support split I+D caches" switch.

Version 5.65. Tagged as 'RISC_OSLib-5_65'
@
text
@a28 2
        GET     Hdr:CPU.Generic26
        GET     Hdr:CPU.Generic32
d30 1
a30 2
        GET     Hdr:SWIs
        GET     Hdr:RISCOS
@


4.4
log
@ROM build fixed for 64-bit stuff.
PCI added to swis.h
alloc.c updated to handle bigger slots (new code merged from ARM libraries)
Various 32-bit fixes for backtracing, and general trap handling.
Polite "Application is not 32-bit compatible" message.
Headers <stdint.h> and <inttypes.h> fixed to work in non-C99 mode.
txt changed to do new-style Delete behaviour

Version 5.44. Tagged as 'RISC_OSLib-5_44'
@
text
@d39 6
a44 2

StrongARM       SETL :DEF: AMBKernel
a46 13
  [ StrongARM
        ;macro to synchronise to $Ncodewords words of code on (FD) stack
        MACRO
        SyncStackCode $Ncodewords
        STMFD  sp!,{r0-r2,lr}
        MOV    r0,#1                    ;means range specified in r1,r2
        ADD    r1,sp,#4*4               ;start address (allowing for stacked r0-r2,lr)
        ADD    r2,r1,#($Ncodewords-1)*4 ;end address (inclusive) for $Ncodewords words of code
        SWI    XOS_SynchroniseCodeAreas ;do the necessary
        LDMFD  sp!,{r0-r2,lr}
        MEND
  ]

@


4.3
log
@C library now has a default message for C71 (Calling standard no longer
supported), so you get a meaningful message if soft-loading a new version.
No code changes.

Version 5.10. Tagged as 'RISC_OSLib-5_10'
@
text
@d197 2
a198 1
Error_OldAPCS                   *       &800e86
@


4.2
log
@32-bit work merged from kbracey_32bit branch.

Version 5.06. Tagged as 'RISC_OSLib-5_06'
@
text
@d148 1
a148 1
        ErrorBlock $name, $string, $tag
d155 1
a155 1
        =       "$tag"
d160 1
a160 1
        ErrorBlock $name, $string, $tag
d164 5
a168 1
        =       "$tag"
@


4.1
log
@Initial revision
@
text
@d26 30
a102 2
Wimp_StartTask  EQU     X+&400DE

d126 1
a126 1
        STMFD   sp!, {r14}
d131 1
a131 1
        LDM$cond.FD   sp!, {pc}^
d142 1
a142 1
        MOV$cond.S pc, r14
d193 1
@


4.1.10.1
log
@_kernel_unwind now understands SFMFD instructions in function entry.
It also copes with STFE now - it was totally broken.
32-bit stubs and corresponding LibInit SWIs created.
All rather untested.

Version 4.97, 4.12.2.3. Tagged as 'RISC_OSLib-4_97-4_12_2_3'
@
text
@a25 28
        GET     Hdr:ListOpts
        GET     Hdr:Machine.<Machine>
        GET     Hdr:APCS.<APCS>
        GET     Hdr:CPU.Generic26
        GET     Hdr:CPU.Generic32
        GET     Hdr:Macros
        GET     Hdr:SWIs
        GET     Hdr:RISCOS

        GBLL    StrongARM
        GBLL    SASTMhatbroken

StrongARM       SETL :DEF: AMBKernel
SASTMhatbroken  SETL {TRUE} :LAND: StrongARM

  [ StrongARM
        ;macro to synchronise to $Ncodewords words of code on (FD) stack
        MACRO
        SyncStackCode $Ncodewords
        STMFD  sp!,{r0-r2,lr}
        MOV    r0,#1                    ;means range specified in r1,r2
        ADD    r1,sp,#4*4               ;start address (allowing for stacked r0-r2,lr)
        ADD    r2,r1,#($Ncodewords-1)*4 ;end address (inclusive) for $Ncodewords words of code
        SWI    XOS_SynchroniseCodeAreas ;do the necessary
        LDMFD  sp!,{r0-r2,lr}
        MEND
  ]

d98 1
a98 1
        FunctionEntry
d103 1
a103 1
        Return
d114 1
a114 1
        Return "", LinkNotStacked
@


4.1.10.2
log
@Most of the obvious problems in the last check-in fixed. It now builds, at
least.
Stubs now correctly, and internationalisably, report "C library too old".
Both BL and LDR PC forms of branch table successfully created.
Tested on various existing 26-bit programs, and one 32-bit program tested.

Version 4.97, 4.12.2.4. Tagged as 'RISC_OSLib-4_97-4_12_2_4'
@
text
@d101 2
@


4.1.10.3
log
@Features:

* APCS-32 support complete.
* APCS-A compatibility removed.
* Old ArthurLib code removed.
* _clib_version() now reports version from VersionNum.
* time() no longer does a run-time host check - I think we know we're not a BBC
  Master ARM second processor now.
* rename() now uses OS_FSControl 25 instead of *rename.
* getenv() can handle arbitrary length variables.
* Can now handle exceptions in 32-bit form of FPEmulator (on either 26 or 32
  bit systems).
* tmpnam() switches to SVC mode to access its zero page counter.
* Faster divide routines.

Admin:

  This will build all sorts of different things depending on the flags. See
  the Docs directory for details.

  As far as ROM builds are concerned, if using APCS-R, no changes are needed.
  If using APCS-32, the Shared C Library must be built as APCS-R to ensure
  compatibility with old binaries. To achieve this, pass in the option
  SCL_APCS="-APCS 3/26bit" in the Components file.

Version 4.97, 4.12.2.8. Tagged as 'RISC_OSLib-4_97-4_12_2_8'
@
text
@a33 2
        GET     Hdr:ModHand
        GET     Hdr:FPEmulator
a190 1
Error_OldAPCS                   *       &800e86
@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@@


4.1.5.1
log
@Import from SrcFiler
@
text
@@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
