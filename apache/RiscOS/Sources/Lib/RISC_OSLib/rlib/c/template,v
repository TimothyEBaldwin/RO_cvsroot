head	4.4;
access;
symbols
	RISC_OSLib-5_97:4.4
	RISC_OSLib-5_96:4.4
	RISC_OSLib-5_95:4.4
	RISC_OSLib-5_94:4.4
	RISC_OSLib-5_93:4.4
	RISC_OSLib-5_92:4.4
	RISC_OSLib-5_91:4.4
	RISC_OSLib-5_90:4.4
	RISC_OSLib-5_89:4.4
	RISC_OSLib-5_88:4.4
	RISC_OSLib-5_87:4.4
	RISC_OSLib-5_86-1:4.4
	RISC_OSLib-5_86:4.4
	RISC_OSLib-5_85:4.4
	RISC_OSLib-5_84:4.4
	RISC_OSLib-5_83-2:4.4
	RISC_OSLib-5_83-1:4.4
	RISC_OSLib-5_83:4.4
	RISC_OSLib-5_82:4.4
	RISC_OSLib-5_81:4.4
	RISC_OSLib-5_75-2:4.3
	RISC_OSLib-5_80:4.4
	RISC_OSLib-5_79:4.4
	RISC_OSLib-5_78:4.4
	RISC_OSLib-5_75-1:4.3
	RISC_OSLib-5_77:4.3
	RISC_OSLib-5_76:4.3
	RISC_OSLib-5_75:4.3
	RISC_OSLib-5_74:4.3
	RISC_OSLib-5_73:4.3
	RISC_OSLib-5_72:4.3
	RISC_OSLib-5_71:4.3
	RISC_OSLib-5_70:4.3
	RISC_OSLib-5_69:4.3
	RISC_OSLib-5_68:4.3
	RISC_OSLib-5_67:4.3
	RISC_OSLib-5_66:4.3
	RISC_OSLib-5_65:4.3
	RISC_OSLib-5_64:4.3
	RISC_OSLib-5_63:4.3
	RISC_OSLib-5_62:4.3
	RISC_OSLib-5_61:4.3
	RISC_OSLib-5_60:4.3
	RISC_OSLib-5_59:4.3
	RISC_OSLib-5_58:4.3
	RISC_OSLib-5_57:4.3
	RISC_OSLib-5_56:4.3
	RISC_OSLib-5_55:4.3
	RISC_OSLib-5_54:4.3
	RISC_OSLib-5_53:4.2
	RISC_OSLib-5_52:4.2
	RISC_OSLib-5_51:4.2
	RO_5_07:4.2
	RISC_OSLib-5_50:4.2
	RISC_OSLib-5_49:4.2
	RISC_OSLib-5_46-4_64_2_1:4.2
	NoInlineAsm:4.2.0.2
	RISC_OSLib-5_48:4.2
	RISC_OSLib-5_47:4.2
	RISC_OSLib-5_46:4.2
	RISC_OSLib-5_45:4.2
	RISC_OSLib-5_44:4.2
	RISC_OSLib-5_43:4.2
	RISC_OSLib-5_42:4.2
	RISC_OSLib-5_41:4.2
	RISC_OSLib-5_40:4.2
	RISC_OSLib-5_39:4.2
	RISC_OSLib-5_38:4.2
	RISC_OSLib-5_37:4.2
	RISC_OSLib-5_36:4.2
	RISC_OSLib-5_35:4.2
	RISC_OSLib-5_34:4.2
	RISC_OSLib-5_33-4_50_2_1:4.1.14.1
	sbrodie_dev:4.1.0.14
	sbrodie_dev_bp:4.1
	RISC_OSLib-5_33:4.1
	RISC_OSLib-5_32:4.1
	RISC_OSLib-5_31:4.1
	RISC_OSLib-5_30:4.1
	RISC_OSLib-5_29:4.1
	RISC_OSLib-5_28:4.1
	RISC_OSLib-5_27:4.1
	RISC_OSLib-5_26:4.1
	RISC_OSLib-5_25:4.1
	RISC_OSLib-5_24:4.1
	RISC_OSLib-5_01-4_16_2_5:4.1
	RISC_OSLib-5_23:4.1
	RISC_OSLib-5_22:4.1
	RISC_OSLib-5_21:4.1
	RISC_OSLib-5_20:4.1
	RISC_OSLib-5_19:4.1
	RISC_OSLib-5_18:4.1
	RISC_OSLib-5_17:4.1
	RISC_OSLib-5_16:4.1
	RISC_OSLib-5_15:4.1
	dellis_autobuild_BaseSW:4.1
	RISC_OSLib-5_14:4.1
	RISC_OSLib-5_13:4.1
	RISC_OSLib-5_12:4.1
	RISC_OSLib-5_01-4_16_2_4:4.1
	RISC_OSLib-5_11:4.1
	RISC_OSLib-5_01-4_16_2_3:4.1
	RISC_OSLib-5_01-4_16_2_2:4.1
	RISC_OSLib-5_10:4.1
	RISC_OSLib-5_01-4_16_2_1:4.1
	Bethany:4.1.0.12
	RISC_OSLib-5_09:4.1
	RISC_OSLib-5_08:4.1
	RISC_OSLib-5_07:4.1
	RISC_OSLib-5_06:4.1
	RISC_OSLib-4_97-4_12_2_8:4.1
	RISC_OSLib-5_05:4.1
	RISC_OSLib-5_04:4.1
	sbrodie_sedwards_16Mar2000:4.1
	RISC_OSLib-5_03:4.1
	RISC_OSLib-5_02:4.1
	RISC_OSLib-4_97-4_12_2_7:4.1
	RISC_OSLib-5_01:4.1
	RISC_OSLib-5_00:4.1
	RISC_OSLib-4_99:4.1
	RISC_OSLib-4_98:4.1
	RISC_OSLib-4_97-4_12_2_6:4.1
	RISC_OSLib-4_97-4_12_2_5:4.1
	RISC_OSLib-4_97-4_12_2_4:4.1
	RISC_OSLib-4_97-4_12_2_3:4.1
	RISC_OSLib-4_97-4_12_2_2:4.1
	sbrodie_RISC_OSLib-4_97-4_12_2_1:4.1
	kbracey_32bit:4.1.0.10
	kbracey_32bit_bp:4.1
	dcotton_autobuild_BaseSW:4.2
	RISC_OSLib-4_97:4.1
	RISC_OSLib-4_96:4.1
	RISC_OSLib-4_95:4.1
	RISC_OSLib-4_94:4.1
	RISC_OSLib-4_93:4.1
	RISC_OSLib-4_92:4.1
	mstphens_UrsulaRiscPCBuild_20Nov98:4.1
	Ursula_RiscPC:4.1.0.8
	sforrest_daytona_appflash-0_31:4.1
	RISC_OSLib-4_91:4.1
	RISC_OSLib-4_90:4.1
	RISC_OSLib-4_89:4.1
	Ursula_merge:4.1
	RISC_OSLib-4_88:4.1
	RISC_OSLib-4_87:4.1
	blaughto_daytona_appflash-0_30:4.1
	rmanby_clib-4_86:4.1
	rthornb_UrsulaBuild-19Aug1998:4.1
	UrsulaBuild_FinalSoftload:4.1
	rthornb_UrsulaBuild-12Aug1998:4.1
	aglover_UrsulaBuild-05Aug1998:4.1
	rthornb_UrsulaBuild-29Jul1998:4.1
	rthornb_UrsulaBuild-22Jul1998:4.1
	rthornb_UrsulaBuild-15Jul1998:4.1
	rthornb_UrsulaBuild-07Jul1998:4.1
	rthornb_UrsulaBuild-17Jun1998:4.1
	rthornb_UrsulaBuild-03Jun1998:4.1
	rthornb_UrsulaBuild-27May1998:4.1
	rthornb_UrsulaBuild-21May1998:4.1
	rthornb_UrsulaBuild_01May1998:4.1
	afrost_NC2_Generic:4.1.7.1
	Spinner_B20_2:4.1.7.1
	Spinner_19_3:4.1.7.1
	Spinner_B18:4.1.7.1
	Spinner_B17:4.1.7.1
	Spinner_B15:4.1.7.1
	Spinner_B14:4.1.7.1
	Spinner_B13:4.1.7.1
	Spinner_B12:4.1.7.1
	Spinner_B10:4.1.7.1
	Daytona:4.1.0.6
	Daytona_bp:4.1
	Ursula:4.1.0.4
	Ursula_bp:4.1
	Spinner_B7:4.1.7.1
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	ARTtmp:4.1.7.1.0.2
	Spin_merge:4.1.7.1
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.4
date	2013.10.24.20.03.55;	author rsprowson;	state Exp;
branches;
next	4.3;
commitid	8snV0tcFxVQyiAax;

4.3
date	2009.05.31.17.58.59;	author pnaulls;	state Exp;
branches;
next	4.2;

4.2
date	2001.08.23.13.53.55;	author kbracey;	state Exp;
branches;
next	4.1;

4.1
date	96.11.05.09.25.13;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.5.1
	4.1.7.1
	4.1.14.1;
next	;

4.1.1.1
date	96.11.05.09.25.13;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.05.19.54.02;	author nturton;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.11.30.58;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.19.49.44;	author nturton;	state Exp;
branches;
next	;

4.1.14.1
date	2001.07.02.15.01.15;	author sbrodie;	state Exp;
branches;
next	;


desc
@@


4.4
log
@Some library fixes
Fix for problem passing long command lines via system(), while there are good arguments to leave the threshold at 255, non DDEUtils aware programs get brutally truncated command strings, and since the old threshold of 255 applied when the kernel handled 256 command lines, upping the limit to 1k is no worse than before.
Fix for Edit failing to draw lines of text longer than 192 characters (ticket #350). Several factors were conspiring here: on a mode change the window width in characters wasn't being clamped, whereas user entered limits in the menu were, then the internal buffer ("PAINTBUFSIZE") was too short so lines got truncated, and when larger than 256 got wrapped modulo 256 due to the use of an array of chars. Now set at compile time with BIG_WINDOW_SIZE_LIMIT with a new theoretical maximum of 8192. Currently limited to 480 since it uses stack variables.

In the C library:
 armsys.c: adapt the threshold at which to use DDEUtils based on the kernel version number
 scanf.c: squash a warning
 time.c: mark the table of month lengths as constant so we can claw back 13 words of static workspace without having to change the stubs

In RISC OS lib:
 bbc.c: remove local definitions of some SWI numbers
 template.c: squash a warning
 txt.c: delete Modula-2 support
 txt1.c: compare pointer with NULL not an integer
 txtar.c: introduce BIG_WINDOW_SIZE_LIMIT, rationalise a few sprintf's, mark private functions as static
 txtundo.c/txtedit.c: squash old style function warnings
 txtoptmenu.c: clamp the window width read from Edit$Options properly, delete long disabled code
 txtscrap.c: dead function deleted


Version 5.78. Tagged as 'RISC_OSLib-5_78'
@
text
@/* Copyright 1996 Acorn Computers Ltd
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/************************************************************************/
/* © Acorn Computers Ltd, 1992.                                         */
/*                                                                      */
/* This file forms part of an unsupported source release of RISC_OSLib. */
/*                                                                      */
/* It may be freely used to create executable images for saleable       */
/* products but cannot be sold in source form or as an object library   */
/* without the prior written consent of Acorn Computers Ltd.            */
/*                                                                      */
/* If this file is re-distributed (even if modified) it should retain   */
/* this copyright notice.                                               */
/*                                                                      */
/************************************************************************/

/*
 * Title:  template.c
 * Purpose:  Template file management
 * History: IDJ: 07-Feb-92: prepared for source release
 *
 */


#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <string.h>

#include "swis.h"
#include "os.h"
#include "wimp.h"
#include "wimpt.h"
#include "res.h"
#include "sprite.h"
#include "resspr.h"
#include "werr.h"
#include "template.h"
#include "trace.h"
#include "msgs.h"
#include "font.h"
#include "VerIntern/messages.h"

/*
 * Templates held in private linked list
 */

static  template *template__list = 0;
static  wimp_font_array *template__fontcounts = 0;


static BOOL template__nameeq(char *s, char *t)
{
    int i;

    for (i = 0; i < 12; i++) {
        if (*s < ' ' && *t < ' ') return 1;
        if (*s < ' ' || *t < ' ') return 0;
        if (*s++ != *t++) return 0;
    }
    return 1;
}

static void *template_alloc(int n)
{
    void *p;

    p = malloc(n);
    if (!p) werr(1, msgs_lookup(MSGS_template2));
    return p;
}

template *template_find(char *name)
{
  template *t = template__list;
  while (t != 0 && template__nameeq(name, t->name) == 0) t=t->next;
  if (t == 0) werr(1, msgs_lookup(MSGS_template1), name);
  return(t);
}

template *template_copy(template *from)
{
  template *to;
  int j;
  int windowsize, size;
  int reloc;

  windowsize = sizeof(template) + from->window.nicons * sizeof(wimp_icon);
  size = windowsize + from->workspacesize;

  /* --- copy the template --- */
  to = malloc(size);
  if (to == 0) return 0;

  memcpy(to, from, windowsize);

  if (to->workspacesize) {
    to->workspace = (char *)to + windowsize;
    memcpy(to->workspace, from->workspace, to->workspacesize);
    reloc = (int)to->workspace - (int)from->workspace;

    /* - fix up indirect icon pointers - */
    for (j=0; j<to->window.nicons; j++)
    {
      wimp_icon *i = ((wimp_icon *)(&to->window + 1)) + j;
      if ((i->flags & wimp_INDIRECT) != 0)
      {
        i->data.indirecttext.buffer += reloc;
        if ((i->flags & wimp_ITEXT) != 0 &&
            ((int) i->data.indirecttext.validstring) > 0)
          i->data.indirecttext.validstring += reloc;
      }
    }

    /* --- fix up relocated title pointer --- */
    if ((to->window.titleflags & wimp_INDIRECT) != 0)
      to->window.title.indirecttext.buffer += reloc;

  }

  to->next = 0;
  return to;
}

static BOOL (template_readfile)(char *filename)
{
  template *to;          /* for insertion into linked list */
  int sprites = 0;       /* are sprites used? */
  int j;
  int index;
  char name[12];
  int windowsize, datasize;

  _swi(Wimp_OpenTemplate, _IN(1), filename);
  index = 0;
  while (1)
  {
    *((int *)name) = '*';
    if (!_swi(Wimp_LoadTemplate,
              _IN(1)|_IN(5)|_IN(6)|_OUT(1)|_OUT(2)|_RETURN(6),
              -1, name, index, &windowsize, &datasize))
        break;
    windowsize = (windowsize + 3) & ~3;
    to = template_alloc(offsetof(template, window) + windowsize + datasize);
    to->next = template__list;
    template__list = to;
    to->workspace = (char *)&to->window + windowsize;
    to->workspacesize = datasize;
    *((int *)to->name) = '*';
    index = _swi(Wimp_LoadTemplate,
                 _IN(1)|_IN(2)|_IN(3)|_IN(4)|_IN(5)|_IN(6)|_RETURN(6),
                 &to->window, to->workspace, to->workspace + datasize,
                 template__fontcounts ? template__fontcounts : (void *)-1,
                 to->name, index);

    /* --- look for sprites --- */
    if (!sprites) {
        for (j=0; j < to->window.nicons; j++)
        {
            /* - icons come after buffer->window in memory - */
            wimp_icon *i = ((wimp_icon *)(&to->window + 1)) + j;
            if ((i->flags & wimp_ISPRITE) != 0)
            {
                 sprites = 1;
                 break;
            }
        }
    }

    /* --- bind sprite area appropriately --- */
    to->window.spritearea = resspr_area();

  }

  /* --- close the template file and free up temporary space --- */
  _swi(Wimp_CloseTemplate, 0);
  return sprites;
}


BOOL template_loaded(void)
{
   return ((BOOL)template__list);
}

#ifndef UROM
static void template__loseallfonts(void)
{
   int num, used;

   if (template__fontcounts != 0)
   {
      for (num = 0; num < 256; num++)
          for (used = 0; used < template__fontcounts->f[num]; used++)
              wimpt_noerr(font_lose(num));
   }
}
#endif

#ifndef UROM
void template_use_fancyfonts(void)
{
   if (template__fontcounts == 0) {
      template__fontcounts = template_alloc(sizeof(wimp_font_array));
      memset(template__fontcounts, 0, 256);
      atexit(template__loseallfonts);
   }
}
#endif

void template_init(void)
{
  char s[40];

  if (res_findname("Templates", s))
    (template_readfile)(s);

  return;

}


wimp_wind *template_syshandle(char *name)
{
  template *tem;

  /* find template in linked list */
  if ((tem = template_find(name)) == 0)
    return ((wimp_wind *)0);

  /* return pointer to underlying window structure */
  return (&(tem -> window));
}
@


4.3
log
@Normalise C and assembler include paths
Detail:
 This changes all the C and assembler includes to be a canoncial Unix format.
 Also match include paths to previous commit for EditIntern/DrawIntern/VerIntern
 Finally, also include some minor type fixes (NULL vs 0)
Admin:
 May be some other paths elsewhere in the source I'm not immediately able to fix.  Will address any issues ASAP, since this is a huge change.

Version 5.54. Not tagged
@
text
@d137 1
a137 1
BOOL (template_readfile)(char *filename)
@


4.2
log
@* Merged in (via sbrodie's branch) public source release of RISC_OSLib.
* Fixed C library tty so it can output '\b' (backspace).
* Made offsetof() and va_arg() macros work with C++.

Version 5.34. Tagged as 'RISC_OSLib-5_34'
@
text
@d54 1
a54 1
#include "h.verintern.messages"
@


4.1
log
@Initial revision
@
text
@d15 14
d32 2
a33 7
 * History:  8-Mar-89 IDJ created
 *           22-May-89  IDJ added mosticons and mostspace to allow any
 *                          size of template to be loaded.
 *           1-June-89  IDJ Kludge added to allow more workspace
 *                          for indirected icons (dunno why this is needed)
 *           5-Feb-90  IDJ added template_use_fancyfonts()
 *           8-May-91  ECN #ifndefed out unused ROM functions
d36 1
d56 1
a56 1
/* 
d125 1
a125 1
    }  
d129 1
a129 1
      to->window.title.indirecttext.buffer += reloc;     
d136 1
a136 1
 
d139 1
a139 1
  template *to;          /* for insertion into linked list */ 
d149 1
a149 1
  { 
d167 1
a167 1
  
d171 1
a171 1
        {                                                      
d186 1
a186 1
  
d190 1
a190 1
}  
d222 1
a222 1
   
d226 1
a226 1
 
@


4.1.14.1
log
@  Merge of multiple versions of RISC_OSLib.
Detail:
  This work may be incomplete - hence import on a branch.
  It has NOT been tested.
Admin:
  Might even build.


Version 5.33, 4.50.2.1. Tagged as 'RISC_OSLib-5_33-4_50_2_1'
@
text
@a0 28
/* Copyright 1996 Acorn Computers Ltd
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/************************************************************************/
/* © Acorn Computers Ltd, 1992.                                         */
/*                                                                      */
/* This file forms part of an unsupported source release of RISC_OSLib. */
/*                                                                      */
/* It may be freely used to create executable images for saleable       */
/* products but cannot be sold in source form or as an object library   */
/* without the prior written consent of Acorn Computers Ltd.            */
/*                                                                      */
/* If this file is re-distributed (even if modified) it should retain   */
/* this copyright notice.                                               */
/*                                                                      */
/************************************************************************/

d18 7
a24 2
 * History: IDJ: 07-Feb-92: prepared for source release
 *
a26 1

d46 1
a46 1
/*
d115 1
a115 1
    }
d119 1
a119 1
      to->window.title.indirecttext.buffer += reloc;
d126 1
a126 1

d129 1
a129 1
  template *to;          /* for insertion into linked list */
d139 1
a139 1
  {
d157 1
a157 1

d161 1
a161 1
        {
d176 1
a176 1

d180 1
a180 1
}
d212 1
a212 1

d216 1
a216 1

@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@@


4.1.5.1
log
@Import from SrcFiler
@
text
@@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
