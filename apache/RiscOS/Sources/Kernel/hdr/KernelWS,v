head	4.31;
access;
symbols
	Kernel-6_14:4.31
	Kernel-6_01-3:4.26
	Kernel-6_13:4.30
	Kernel-6_12:4.30
	Kernel-6_11:4.30
	Kernel-6_10:4.29
	Kernel-6_09:4.29
	Kernel-6_08-4_129_2_10:4.23.2.5
	Kernel-6_08-4_129_2_9:4.23.2.5
	Kernel-6_08:4.28
	Kernel-6_07:4.28
	Kernel-6_06:4.28
	Kernel-6_05-4_129_2_8:4.23.2.5
	Kernel-6_05:4.28
	Kernel-6_04:4.28
	Kernel-6_03:4.27
	Kernel-6_01-2:4.26
	Kernel-6_01-4_146_2_1:4.26
	Kernel-6_02:4.26
	Kernel-6_01-1:4.26
	Kernel-6_01:4.26
	Kernel-6_00:4.26
	Kernel-5_99:4.26
	Kernel-5_98:4.26
	Kernel-5_97-4_129_2_7:4.23.2.4
	Kernel-5_97:4.26
	Kernel-5_96:4.26
	Kernel-5_95:4.26
	Kernel-5_94:4.26
	Kernel-5_93:4.26
	Kernel-5_92:4.26
	Kernel-5_91:4.26
	Kernel-5_90:4.26
	Kernel-5_89-4_129_2_6:4.23.2.3
	Kernel-5_89:4.25
	Kernel-5_88-4_129_2_5:4.23.2.2
	Kernel-5_88-4_129_2_4:4.23.2.2
	Kernel-5_88:4.24
	Kernel-5_87:4.24
	Kernel-5_86-4_129_2_3:4.23.2.1
	Kernel-5_86-4_129_2_2:4.23.2.1
	Kernel-5_86-4_129_2_1:4.23
	Kernel-5_86:4.23
	SMP:4.23.0.2
	SMP_bp:4.23
	Kernel-5_85:4.23
	Kernel-5_54-1:4.17
	Kernel-5_84:4.23
	Kernel-5_83:4.23
	Kernel-5_82:4.23
	Kernel-5_81:4.22
	Kernel-5_80:4.22
	Kernel-5_79:4.22
	Kernel-5_78:4.22
	Kernel-5_77:4.22
	Kernel-5_76:4.22
	Kernel-5_75:4.22
	Kernel-5_74:4.21
	Kernel-5_73:4.20
	Kernel-5_72:4.20
	Kernel-5_71:4.20
	Kernel-5_70:4.19
	Kernel-5_69:4.19
	Kernel-5_68:4.19
	Kernel-5_67:4.18
	Kernel-5_66:4.18
	Kernel-5_65:4.18
	Kernel-5_64:4.18
	Kernel-5_63:4.18
	Kernel-5_62:4.18
	Kernel-5_61:4.18
	Kernel-5_60:4.18
	Kernel-5_59:4.18
	Kernel-5_58:4.18
	Kernel-5_57:4.18
	Kernel-5_56:4.18
	Kernel-5_55:4.18
	Kernel-5_54:4.17
	Kernel-5_53:4.17
	Kernel-5_52:4.17
	Kernel-5_51:4.17
	Kernel-5_50:4.16
	Kernel-5_49:4.16
	HAL_merge:4.14.2.61
	Kernel-5_48:4.15
	Kernel-5_35-4_79_2_327:4.14.2.61
	Kernel-5_35-4_79_2_326:4.14.2.61
	Kernel-5_35-4_79_2_325:4.14.2.61
	Kernel-5_35-4_79_2_324:4.14.2.61
	Kernel-5_35-4_79_2_323:4.14.2.61
	Kernel-5_35-4_79_2_322:4.14.2.61
	Kernel-5_35-4_79_2_321:4.14.2.61
	Kernel-5_35-4_79_2_320:4.14.2.61
	Kernel-5_35-4_79_2_319:4.14.2.61
	Kernel-5_35-4_79_2_318:4.14.2.60
	Kernel-5_35-4_79_2_317:4.14.2.60
	Kernel-5_35-4_79_2_316:4.14.2.60
	Kernel-5_35-4_79_2_315:4.14.2.60
	Kernel-5_35-4_79_2_314:4.14.2.60
	Kernel-5_35-4_79_2_313:4.14.2.59
	Kernel-5_35-4_79_2_312:4.14.2.58
	Kernel-5_35-4_79_2_311:4.14.2.58
	Kernel-5_35-4_79_2_310:4.14.2.58
	Kernel-5_35-4_79_2_309:4.14.2.58
	Kernel-5_35-4_79_2_308:4.14.2.58
	Kernel-5_35-4_79_2_307:4.14.2.58
	Kernel-5_35-4_79_2_306:4.14.2.58
	Kernel-5_35-4_79_2_305:4.14.2.57
	Kernel-5_35-4_79_2_304:4.14.2.57
	Kernel-5_35-4_79_2_303:4.14.2.57
	Kernel-5_35-4_79_2_302:4.14.2.57
	Kernel-5_35-4_79_2_301:4.14.2.57
	Kernel-5_35-4_79_2_300:4.14.2.57
	Kernel-5_35-4_79_2_299:4.14.2.57
	Kernel-5_35-4_79_2_298:4.14.2.57
	Kernel-5_35-4_79_2_297:4.14.2.57
	Kernel-5_35-4_79_2_296:4.14.2.56
	Kernel-5_35-4_79_2_295:4.14.2.56
	Kernel-5_35-4_79_2_294:4.14.2.56
	Kernel-5_35-4_79_2_293:4.14.2.56
	Kernel-5_35-4_79_2_292:4.14.2.56
	Kernel-5_35-4_79_2_291:4.14.2.56
	Kernel-5_35-4_79_2_290:4.14.2.56
	Kernel-5_35-4_79_2_289:4.14.2.56
	Kernel-5_35-4_79_2_288:4.14.2.56
	Kernel-5_35-4_79_2_287:4.14.2.56
	Kernel-5_35-4_79_2_286:4.14.2.56
	Kernel-5_35-4_79_2_285:4.14.2.56
	Kernel-5_35-4_79_2_284:4.14.2.55
	Kernel-5_35-4_79_2_283:4.14.2.54
	Kernel-5_35-4_79_2_282:4.14.2.54
	Kernel-5_35-4_79_2_281:4.14.2.54
	Kernel-5_35-4_79_2_280:4.14.2.54
	Kernel-5_35-4_79_2_279:4.14.2.54
	Kernel-5_35-4_79_2_278:4.14.2.53
	Kernel-5_35-4_79_2_277:4.14.2.53
	Kernel-5_35-4_79_2_276:4.14.2.53
	Kernel-5_35-4_79_2_275:4.14.2.53
	Kernel-5_35-4_79_2_274:4.14.2.53
	Kernel-5_35-4_79_2_273:4.14.2.53
	Kernel-5_35-4_79_2_272:4.14.2.52
	Kernel-5_35-4_79_2_271:4.14.2.52
	Kernel-5_35-4_79_2_270:4.14.2.51
	Kernel-5_35-4_79_2_269:4.14.2.51
	Kernel-5_35-4_79_2_268:4.14.2.50
	Kernel-5_35-4_79_2_267:4.14.2.50
	Kernel-5_35-4_79_2_266:4.14.2.50
	Kernel-5_35-4_79_2_265:4.14.2.50
	Kernel-5_35-4_79_2_264:4.14.2.50
	Kernel-5_35-4_79_2_263:4.14.2.50
	Kernel-5_35-4_79_2_262:4.14.2.50
	Kernel-5_35-4_79_2_261:4.14.2.50
	Kernel-5_35-4_79_2_260:4.14.2.50
	Kernel-5_35-4_79_2_259:4.14.2.50
	Kernel-5_35-4_79_2_258:4.14.2.50
	Kernel-5_35-4_79_2_257:4.14.2.50
	Kernel-5_35-4_79_2_256:4.14.2.50
	Kernel-5_35-4_79_2_255:4.14.2.50
	Kernel-5_35-4_79_2_254:4.14.2.50
	Kernel-5_35-4_79_2_253:4.14.2.50
	Kernel-5_35-4_79_2_252:4.14.2.50
	Kernel-5_35-4_79_2_251:4.14.2.49
	Kernel-5_35-4_79_2_250:4.14.2.49
	Kernel-5_35-4_79_2_249:4.14.2.49
	Kernel-5_35-4_79_2_248:4.14.2.49
	Kernel-5_35-4_79_2_247:4.14.2.49
	Kernel-5_35-4_79_2_246:4.14.2.49
	Kernel-5_35-4_79_2_245:4.14.2.49
	Kernel-5_35-4_79_2_244:4.14.2.49
	Kernel-5_35-4_79_2_243:4.14.2.49
	Kernel-5_35-4_79_2_242:4.14.2.49
	Kernel-5_35-4_79_2_241:4.14.2.49
	Kernel-5_35-4_79_2_240:4.14.2.49
	Kernel-5_35-4_79_2_239:4.14.2.49
	Kernel-5_35-4_79_2_238:4.14.2.49
	Kernel-5_35-4_79_2_237:4.14.2.49
	Kernel-5_35-4_79_2_236:4.14.2.49
	Kernel-5_35-4_79_2_235:4.14.2.48
	Kernel-5_35-4_79_2_234:4.14.2.48
	Kernel-5_35-4_79_2_233:4.14.2.48
	Kernel-5_35-4_79_2_232:4.14.2.48
	Kernel-5_35-4_79_2_231:4.14.2.48
	Kernel-5_35-4_79_2_230:4.14.2.48
	Kernel-5_35-4_79_2_229:4.14.2.48
	Kernel-5_35-4_79_2_228:4.14.2.48
	Kernel-5_35-4_79_2_227:4.14.2.48
	Kernel-5_35-4_79_2_226:4.14.2.48
	Kernel-5_35-4_79_2_225:4.14.2.48
	Kernel-5_35-4_79_2_224:4.14.2.48
	Kernel-5_35-4_79_2_223:4.14.2.48
	Kernel-5_35-4_79_2_222:4.14.2.48
	Kernel-5_35-4_79_2_221:4.14.2.47
	Kernel-5_35-4_79_2_220:4.14.2.47
	Kernel-5_35-4_79_2_219:4.14.2.47
	Kernel-5_35-4_79_2_218:4.14.2.47
	Kernel-5_35-4_79_2_217:4.14.2.47
	Kernel-5_35-4_79_2_216:4.14.2.47
	Kernel-5_35-4_79_2_215:4.14.2.47
	Kernel-5_35-4_79_2_214:4.14.2.47
	Kernel-5_35-4_79_2_213:4.14.2.46
	Kernel-5_35-4_79_2_212:4.14.2.46
	Kernel-5_35-4_79_2_211:4.14.2.46
	Kernel-5_35-4_79_2_210:4.14.2.46
	Kernel-5_35-4_79_2_209:4.14.2.46
	Kernel-5_35-4_79_2_208:4.14.2.46
	Kernel-5_35-4_79_2_207:4.14.2.46
	Kernel-5_35-4_79_2_206:4.14.2.46
	Kernel-5_35-4_79_2_205:4.14.2.46
	Kernel-5_35-4_79_2_204:4.14.2.46
	Kernel-5_35-4_79_2_203:4.14.2.46
	Kernel-5_35-4_79_2_202:4.14.2.45
	Kernel-5_35-4_79_2_201:4.14.2.44
	Kernel-5_35-4_79_2_200:4.14.2.44
	Kernel-5_35-4_79_2_199:4.14.2.44
	Kernel-5_35-4_79_2_198:4.14.2.44
	Kernel-5_35-4_79_2_197:4.14.2.44
	Kernel-5_35-4_79_2_196:4.14.2.44
	Kernel-5_35-4_79_2_195:4.14.2.44
	Kernel-5_35-4_79_2_194:4.14.2.44
	Kernel-5_35-4_79_2_193:4.14.2.43
	Kernel-5_35-4_79_2_192:4.14.2.43
	Kernel-5_35-4_79_2_191:4.14.2.43
	Kernel-5_35-4_79_2_190:4.14.2.43
	Kernel-5_35-4_79_2_189:4.14.2.43
	Kernel-5_35-4_79_2_188:4.14.2.43
	Kernel-5_35-4_79_2_187:4.14.2.43
	Kernel-5_35-4_79_2_186:4.14.2.42
	Kernel-5_35-4_79_2_185:4.14.2.41
	Kernel-5_35-4_79_2_184:4.14.2.41
	Kernel-5_35-4_79_2_183:4.14.2.41
	Kernel-5_35-4_79_2_182:4.14.2.40
	Kernel-5_35-4_79_2_181:4.14.2.39
	Kernel-5_35-4_79_2_180:4.14.2.39
	Kernel-5_35-4_79_2_179:4.14.2.38
	Kernel-5_35-4_79_2_178:4.14.2.38
	Kernel-5_35-4_79_2_177:4.14.2.38
	Kernel-5_35-4_79_2_176:4.14.2.38
	Kernel-5_35-4_79_2_175:4.14.2.38
	Kernel-5_35-4_79_2_174:4.14.2.38
	Kernel-5_35-4_79_2_173:4.14.2.38
	Kernel-5_35-4_79_2_172:4.14.2.38
	Kernel-5_35-4_79_2_171:4.14.2.38
	Kernel-5_35-4_79_2_170:4.14.2.38
	Kernel-5_35-4_79_2_169:4.14.2.38
	Kernel-5_35-4_79_2_168:4.14.2.38
	Kernel-5_35-4_79_2_167:4.14.2.38
	Kernel-5_35-4_79_2_166:4.14.2.38
	Kernel-5_35-4_79_2_165:4.14.2.38
	RPi_merge:4.14.2.34.2.3
	Kernel-5_35-4_79_2_147_2_23:4.14.2.34.2.3
	Kernel-5_35-4_79_2_147_2_22:4.14.2.34.2.2
	Kernel-5_35-4_79_2_147_2_21:4.14.2.34.2.1
	Kernel-5_35-4_79_2_147_2_20:4.14.2.34.2.1
	Kernel-5_35-4_79_2_147_2_19:4.14.2.34.2.1
	Kernel-5_35-4_79_2_147_2_18:4.14.2.34.2.1
	Kernel-5_35-4_79_2_164:4.14.2.37
	Kernel-5_35-4_79_2_163:4.14.2.37
	Kernel-5_35-4_79_2_147_2_17:4.14.2.34.2.1
	Kernel-5_35-4_79_2_147_2_16:4.14.2.34.2.1
	Kernel-5_35-4_79_2_147_2_15:4.14.2.34.2.1
	Kernel-5_35-4_79_2_162:4.14.2.37
	Kernel-5_35-4_79_2_161:4.14.2.37
	Kernel-5_35-4_79_2_147_2_14:4.14.2.34
	Kernel-5_35-4_79_2_147_2_13:4.14.2.34
	Kernel-5_35-4_79_2_160:4.14.2.37
	Kernel-5_35-4_79_2_159:4.14.2.37
	Kernel-5_35-4_79_2_158:4.14.2.37
	Kernel-5_35-4_79_2_157:4.14.2.37
	Kernel-5_35-4_79_2_156:4.14.2.36
	Kernel-5_35-4_79_2_147_2_12:4.14.2.34
	Kernel-5_35-4_79_2_147_2_11:4.14.2.34
	Kernel-5_35-4_79_2_155:4.14.2.36
	Kernel-5_35-4_79_2_147_2_10:4.14.2.34
	Kernel-5_35-4_79_2_154:4.14.2.36
	Kernel-5_35-4_79_2_153:4.14.2.36
	Kernel-5_35-4_79_2_147_2_9:4.14.2.34
	Kernel-5_35-4_79_2_152:4.14.2.35
	Kernel-5_35-4_79_2_151:4.14.2.35
	Kernel-5_35-4_79_2_147_2_8:4.14.2.34
	Kernel-5_35-4_79_2_147_2_7:4.14.2.34
	Kernel-5_35-4_79_2_150:4.14.2.35
	Kernel-5_35-4_79_2_147_2_6:4.14.2.34
	Kernel-5_35-4_79_2_147_2_5:4.14.2.34
	Kernel-5_35-4_79_2_149:4.14.2.34
	Kernel-5_35-4_79_2_147_2_4:4.14.2.34
	Kernel-5_35-4_79_2_147_2_3:4.14.2.34
	Kernel-5_35-4_79_2_148:4.14.2.34
	Kernel-5_35-4_79_2_147_2_2:4.14.2.34
	Kernel-5_35-4_79_2_147_2_1:4.14.2.34
	RPi:4.14.2.34.0.2
	RPi_bp:4.14.2.34
	Kernel-5_35-4_79_2_98_2_52_2_1:4.14.2.30.2.7
	alees_Kernel_dev:4.14.2.30.2.7.0.2
	alees_Kernel_dev_bp:4.14.2.30.2.7
	Kernel-5_35-4_79_2_147:4.14.2.34
	Kernel-5_35-4_79_2_146:4.14.2.34
	Kernel-5_35-4_79_2_145:4.14.2.34
	Kernel-5_35-4_79_2_144:4.14.2.34
	Kernel-5_35-4_79_2_143:4.14.2.34
	Kernel-5_35-4_79_2_142:4.14.2.34
	Kernel-5_35-4_79_2_141:4.14.2.34
	Kernel-5_35-4_79_2_140:4.14.2.34
	Kernel-5_35-4_79_2_139:4.14.2.34
	Kernel-5_35-4_79_2_138:4.14.2.34
	Kernel-5_35-4_79_2_137:4.14.2.34
	Kernel-5_35-4_79_2_136:4.14.2.34
	Kernel-5_35-4_79_2_135:4.14.2.34
	Kernel-5_35-4_79_2_134:4.14.2.34
	Kernel-5_35-4_79_2_133:4.14.2.34
	Kernel-5_35-4_79_2_132:4.14.2.34
	Kernel-5_35-4_79_2_131:4.14.2.34
	Kernel-5_35-4_79_2_130:4.14.2.34
	Kernel-5_35-4_79_2_129:4.14.2.34
	Kernel-5_35-4_79_2_128:4.14.2.34
	Kernel-5_35-4_79_2_127:4.14.2.33
	Kernel-5_35-4_79_2_126:4.14.2.33
	Kernel-5_35-4_79_2_125:4.14.2.33
	Kernel-5_35-4_79_2_124:4.14.2.33
	Kernel-5_35-4_79_2_123:4.14.2.33
	Cortex_merge:4.14.2.30.2.7
	Kernel-5_35-4_79_2_122:4.14.2.32
	Kernel-5_35-4_79_2_98_2_54:4.14.2.30.2.7
	Kernel-5_35-4_79_2_98_2_53:4.14.2.30.2.7
	Kernel-5_35-4_79_2_98_2_52:4.14.2.30.2.7
	Kernel-5_35-4_79_2_98_2_51:4.14.2.30.2.7
	Kernel-5_35-4_79_2_98_2_50:4.14.2.30.2.6
	Kernel-5_35-4_79_2_98_2_49:4.14.2.30.2.5
	Kernel-5_35-4_79_2_98_2_48:4.14.2.30.2.5
	Kernel-5_35-4_79_2_121:4.14.2.32
	Kernel-5_35-4_79_2_98_2_47:4.14.2.30.2.5
	Kernel-5_35-4_79_2_120:4.14.2.32
	Kernel-5_35-4_79_2_98_2_46:4.14.2.30.2.5
	Kernel-5_35-4_79_2_119:4.14.2.32
	Kernel-5_35-4_79_2_98_2_45:4.14.2.30.2.5
	Kernel-5_35-4_79_2_98_2_44:4.14.2.30.2.5
	Kernel-5_35-4_79_2_118:4.14.2.32
	Kernel-5_35-4_79_2_98_2_43:4.14.2.30.2.4
	Kernel-5_35-4_79_2_117:4.14.2.31
	Kernel-5_35-4_79_2_116:4.14.2.31
	Kernel-5_35-4_79_2_98_2_42:4.14.2.30.2.4
	Kernel-5_35-4_79_2_115:4.14.2.31
	Kernel-5_35-4_79_2_98_2_41:4.14.2.30.2.4
	Kernel-5_35-4_79_2_98_2_40:4.14.2.30.2.3
	Kernel-5_35-4_79_2_114:4.14.2.30
	Kernel-5_35-4_79_2_98_2_39:4.14.2.30.2.3
	Kernel-5_35-4_79_2_98_2_38:4.14.2.30.2.3
	Kernel-5_35-4_79_2_113:4.14.2.30
	Kernel-5_35-4_79_2_112:4.14.2.30
	Kernel-5_35-4_79_2_98_2_37:4.14.2.30.2.3
	Kernel-5_35-4_79_2_98_2_36:4.14.2.30.2.3
	Kernel-5_35-4_79_2_98_2_35:4.14.2.30.2.3
	Kernel-5_35-4_79_2_98_2_34:4.14.2.30.2.3
	Kernel-5_35-4_79_2_98_2_33:4.14.2.30.2.3
	Kernel-5_35-4_79_2_98_2_32:4.14.2.30.2.2
	Kernel-5_35-4_79_2_98_2_31:4.14.2.30.2.2
	Kernel-5_35-4_79_2_98_2_30:4.14.2.30.2.2
	Kernel-5_35-4_79_2_98_2_29:4.14.2.30.2.2
	Kernel-5_35-4_79_2_98_2_28:4.14.2.30.2.2
	Kernel-5_35-4_79_2_98_2_27:4.14.2.30.2.2
	Kernel-5_35-4_79_2_98_2_26:4.14.2.30.2.2
	Kernel-5_35-4_79_2_111:4.14.2.30
	Kernel-5_35-4_79_2_98_2_25:4.14.2.30.2.2
	Kernel-5_35-4_79_2_98_2_24:4.14.2.30.2.2
	Kernel-5_35-4_79_2_98_2_23:4.14.2.30.2.2
	Kernel-5_35-4_79_2_110:4.14.2.30
	Kernel-5_35-4_79_2_98_2_22:4.14.2.30.2.2
	Kernel-5_35-4_79_2_109:4.14.2.30
	Kernel-5_35-4_79_2_98_2_21:4.14.2.30.2.2
	Kernel-5_35-4_79_2_98_2_20:4.14.2.30.2.2
	Kernel-5_35-4_79_2_108:4.14.2.30
	Kernel-5_35-4_79_2_107:4.14.2.30
	Kernel-5_35-4_79_2_98_2_19:4.14.2.30.2.2
	Kernel-5_35-4_79_2_98_2_18:4.14.2.30.2.2
	Kernel-5_35-4_79_2_98_2_17:4.14.2.30.2.2
	Kernel-5_35-4_79_2_98_2_16:4.14.2.30.2.2
	Kernel-5_35-4_79_2_98_2_15:4.14.2.30.2.2
	Kernel-5_35-4_79_2_106:4.14.2.30
	Kernel-5_35-4_79_2_105:4.14.2.30
	Kernel-5_35-4_79_2_104:4.14.2.30
	Kernel-5_35-4_79_2_98_2_14:4.14.2.30.2.2
	Kernel-5_35-4_79_2_98_2_13:4.14.2.30.2.2
	Kernel-5_35-4_79_2_98_2_12:4.14.2.30.2.2
	Kernel-5_35-4_79_2_98_2_11:4.14.2.30.2.2
	Kernel-5_35-4_79_2_98_2_10:4.14.2.30.2.1
	Kernel-5_35-4_79_2_98_2_9:4.14.2.30.2.1
	Kernel-5_35-4_79_2_103:4.14.2.30
	Kernel-5_35-4_79_2_102:4.14.2.30
	Kernel-5_35-4_79_2_98_2_8:4.14.2.30.2.1
	Kernel-5_35-4_79_2_98_2_7:4.14.2.30.2.1
	Kernel-5_35-4_79_2_98_2_6:4.14.2.30.2.1
	Kernel-5_35-4_79_2_98_2_5:4.14.2.30.2.1
	Kernel-5_35-4_79_2_98_2_4:4.14.2.30.2.1
	Kernel-5_35-4_79_2_101:4.14.2.30
	Kernel-5_35-4_79_2_100:4.14.2.30
	Kernel-5_35-4_79_2_99:4.14.2.30
	Kernel-5_35-4_79_2_98_2_3:4.14.2.30.2.1
	Kernel-5_35-4_79_2_98_2_2:4.14.2.30.2.1
	Kernel-5_35-4_79_2_98_2_1:4.14.2.30
	Cortex:4.14.2.30.0.2
	Cortex_bp:4.14.2.30
	Kernel-5_35-4_79_2_98:4.14.2.30
	Kernel-5_35-4_79_2_97:4.14.2.30
	Kernel-5_35-4_79_2_96:4.14.2.30
	Kernel-5_35-4_79_2_95:4.14.2.30
	Kernel-5_35-4_79_2_94:4.14.2.30
	Kernel-5_35-4_79_2_93:4.14.2.30
	Kernel-5_35-4_79_2_92:4.14.2.30
	Kernel-5_35-4_79_2_91:4.14.2.30
	Kernel-5_35-4_79_2_90:4.14.2.30
	Kernel-5_35-4_79_2_89:4.14.2.30
	Kernel-5_35-4_79_2_88:4.14.2.30
	Kernel-5_35-4_79_2_87:4.14.2.30
	Kernel-5_35-4_79_2_86:4.14.2.30
	Kernel-5_35-4_79_2_85:4.14.2.30
	Kernel-5_35-4_79_2_84:4.14.2.30
	Kernel-5_35-4_79_2_83:4.14.2.30
	Kernel-5_35-4_79_2_82:4.14.2.30
	Kernel-5_35-4_79_2_81:4.14.2.30
	Kernel-5_35-4_79_2_80:4.14.2.30
	Kernel-5_35-4_79_2_79:4.14.2.30
	Kernel-5_35-4_79_2_78:4.14.2.30
	Kernel-5_35-4_79_2_77:4.14.2.30
	RO_5_07:4.14.2.30
	Kernel-5_35-4_79_2_76:4.14.2.30
	Kernel-5_35-4_79_2_75:4.14.2.30
	Kernel-5_35-4_79_2_74:4.14.2.30
	Kernel-5_35-4_79_2_73:4.14.2.30
	Kernel-5_35-4_79_2_72:4.14.2.30
	Kernel-5_35-4_79_2_71:4.14.2.30
	Kernel-5_35-4_79_2_70:4.14.2.30
	Kernel-5_35-4_79_2_69:4.14.2.30
	Kernel-5_35-4_79_2_68:4.14.2.30
	Kernel-5_35-4_79_2_67:4.14.2.29
	Kernel-5_35-4_79_2_66:4.14.2.29
	Kernel-5_35-4_79_2_65:4.14.2.28
	Kernel-5_35-4_79_2_64:4.14.2.28
	Kernel-5_35-4_79_2_63:4.14.2.28
	Kernel-5_35-4_79_2_62:4.14.2.28
	Kernel-5_35-4_79_2_61:4.14.2.28
	Kernel-5_35-4_79_2_59:4.14.2.28
	Kernel-5_35-4_79_2_58:4.14.2.27
	Kernel-5_35-4_79_2_57:4.14.2.27
	Kernel-5_35-4_79_2_56:4.14.2.27
	Kernel-5_35-4_79_2_55:4.14.2.26
	Kernel-5_35-4_79_2_54:4.14.2.25
	Kernel-5_35-4_79_2_53:4.14.2.25
	Kernel-5_35-4_79_2_52:4.14.2.25
	Kernel-5_35-4_79_2_51:4.14.2.25
	Kernel-5_35-4_79_2_50:4.14.2.24
	Kernel-5_35-4_79_2_49:4.14.2.24
	Kernel-5_35-4_79_2_48:4.14.2.23
	Kernel-5_47:4.14
	Kernel-5_46-4_90_2_1:4.14
	nbingham_Kernel_FastNC_dev_bp:4.14
	nbingham_Kernel_FastNC_dev:4.14.0.4
	Kernel-5_46:4.14
	Kernel-5_45:4.14
	Kernel-5_35-4_79_2_47:4.14.2.22
	Kernel-5_35-4_79_2_46:4.14.2.22
	Kernel-5_35-4_79_2_45:4.14.2.22
	Kernel-5_35-4_79_2_44:4.14.2.22
	Kernel-5_35-4_79_2_25_2_2:4.14.2.16
	Kernel-5_35-4_79_2_43:4.14.2.22
	Kernel-5_35-4_79_2_42:4.14.2.22
	Kernel-5_35-4_79_2_41:4.14.2.21
	Kernel-5_35-4_79_2_40:4.14.2.20
	Kernel-5_35-4_79_2_39:4.14.2.20
	Kernel-5_35-4_79_2_38:4.14.2.20
	Kernel-5_35-4_79_2_37:4.14.2.19
	Kernel-5_35-4_79_2_36:4.14.2.18
	Kernel-5_35-4_79_2_35:4.14.2.18
	Kernel-5_35-4_79_2_34:4.14.2.18
	Kernel-5_35-4_79_2_33:4.14.2.17
	Kernel-5_35-4_79_2_32:4.14.2.17
	Kernel-5_44:4.14
	Kernel-5_35-4_79_2_25_2_1:4.14.2.16
	Kernel-5_43:4.14
	Kernel-5_35-4_79_2_31:4.14.2.17
	Kernel-5_35-4_79_2_30:4.14.2.17
	Kernel-5_35-4_79_2_29:4.14.2.17
	Kernel-5_35-4_79_2_28:4.14.2.17
	Kernel-5_35-4_79_2_27:4.14.2.16
	Kernel-5_35-4_79_2_26:4.14.2.16
	Kernel-5_42:4.14
	Kernel-5_41:4.14
	Kernel-5_40:4.14
	Kernel-5_35-4_79_2_25:4.14.2.16
	Kernel-5_35-4_79_2_24:4.14.2.16
	Kernel-5_35-4_79_2_23:4.14.2.16
	Kernel-5_35-4_79_2_22:4.14.2.16
	Kernel-5_35-4_79_2_21:4.14.2.16
	Kernel-5_35-4_79_2_20:4.14.2.16
	Kernel-5_35-4_79_2_19:4.14.2.16
	Kernel-5_35-4_79_2_18:4.14.2.15
	Kernel-5_35-4_79_2_17:4.14.2.15
	Kernel-5_35-4_79_2_16:4.14.2.15
	Kernel-5_35-4_79_2_15:4.14.2.15
	Kernel-5_35-4_79_2_14:4.14.2.15
	Kernel-5_39:4.14
	Kernel-5_13-4_52_2_1:4.10
	Bethany:4.10.0.2
	Kernel-5_38:4.14
	Kernel-5_35-4_79_2_13:4.14.2.14
	Kernel-5_35-4_79_2_12:4.14.2.13
	Kernel-5_35-4_79_2_11:4.14.2.12
	Kernel-5_37:4.14
	Kernel-5_35-4_79_2_10:4.14.2.10
	Kernel-5_35-4_79_2_9:4.14.2.9
	Kernel-5_36:4.14
	Kernel-5_35-4_79_2_8:4.14.2.7
	Kernel-5_35-4_79_2_7:4.14.2.6
	Kernel-5_35-4_79_2_6:4.14.2.6
	Kernel-5_35-4_79_2_5:4.14.2.5
	Kernel-5_35-4_79_2_4:4.14.2.4
	Kernel-5_35-4_79_2_3:4.14.2.3
	Kernel-5_35-4_79_2_2:4.14.2.2
	dellis_autobuild_BaseSW:4.14
	Kernel-5_35-4_79_2_1:4.14.2.1
	HAL:4.14.0.2
	Kernel-5_35:4.14
	Kernel-5_34:4.14
	Kernel-5_33:4.14
	Kernel-5_32:4.14
	Kernel-5_31:4.14
	Kernel-5_30:4.13
	Kernel-5_29:4.12
	Kernel-5_28:4.12
	Kernel-5_27:4.12
	Kernel-5_26:4.12
	Kernel-5_25:4.12
	Kernel-5_24:4.11
	Kernel-5_23:4.11
	Kernel-5_22:4.10
	sbrodie_sedwards_16Mar2000:4.10
	Kernel-5_21:4.10
	Kernel-5_20:4.10
	Kernel-5_19:4.10
	Kernel-5_18:4.10
	Kernel-5_17:4.10
	Kernel-5_16:4.10
	Kernel-5_15:4.10
	Kernel-5_14:4.10
	Kernel-5_13:4.10
	Kernel-5_12:4.10
	Kernel-5_11:4.10
	Kernel-5_10:4.10
	Kernel-5_09:4.10
	Kernel-5_08:4.10
	Kernel-5_07:4.10
	Kernel-5_06:4.10
	Kernel-5_05:4.10
	Kernel-5_04:4.10
	Kernel-5_03:4.10
	Kernel-5_02:4.10
	Kernel-5_01:4.10
	Kernel-5_00:4.10
	Kernel-4_99:4.9
	Kernel-4_98:4.9
	Kernel-4_97:4.9
	Kernel-4_96:4.9
	Kernel-4_95:4.8
	Kernel-4_94:4.8
	Kernel-4_93:4.8
	Kernel-4_92:4.8
	Kernel-4_91:4.8
	Kernel-4_90:4.8
	dcotton_autobuild_BaseSW:4.14
	Kernel-4_89:4.8
	Kernel-4_88:4.7
	Kernel-4_87:4.7
	Kernel-4_86:4.7
	Kernel-4_85:4.7
	sbrodie_UrsulaRiscPC_Kernel_19Aug99:4.2.2.8.2.1
	Kernel-4_84:4.7
	sbrodie_UrsulaRiscPC_Kernel_18Aug99:4.2.2.8.2.1
	Ursula_RiscPC_bp:4.2.2.8
	Kernel-4_83:4.6
	Kernel-4_82:4.5
	Kernel-4_81:4.5
	Kernel-4_80:4.4
	Kernel-4_79:4.4
	Kernel-4_78:4.4
	Kernel-4_77:4.4
	Kernel-4_76:4.4
	Kernel-4_75:4.4
	Kernel-4_74:4.4
	Kernel-4_73:4.4
	Kernel-4_72:4.4
	Kernel-4_71:4.4
	Kernel-4_70:4.4
	Kernel-4_69:4.4
	Kernel-4_68:4.3
	mstphens_UrsulaRiscPCBuild_20Nov98:4.2.2.8.2.1
	Ursula_RiscPC:4.2.2.8.0.2
	Kernel-4_63-1_1_2_5:4.1.7.7
	Kernel-4_63-1_1_2_4:4.1.7.7
	Kernel-4_67:4.3
	Kernel-4_66:4.3
	Kernel-4_63-1_1_2_3:4.1.7.7
	Kernel-4_65:4.3
	Ursula_merge:4.2
	Kernel-4_64:4.3
	mstphens_Kernel-3_81:4.2.2.9
	Kernel-4_63-1_1_2_2:4.1.7.7
	nicke_Kernel_4_62:4.1.7.6
	rthornb_UrsulaBuild-19Aug1998:4.2.2.8
	UrsulaBuild_FinalSoftload:4.2.2.8
	rthornb_UrsulaBuild-12Aug1998:4.2.2.8
	aglover_UrsulaBuild-05Aug1998:4.2.2.8
	rthornb_UrsulaBuild-29Jul1998:4.2.2.8
	rthornb_UrsulaBuild-22Jul1998:4.2.2.8
	nturton_v459:4.1.7.5
	nturton_v460:4.1.7.5
	rthornb_UrsulaBuild-15Jul1998:4.2.2.8
	rthornb_UrsulaBuild-07Jul1998:4.2.2.8
	rthornb_UrsulaBuild-17Jun1998:4.2.2.8
	rthornb_UrsulaBuild-03Jun1998:4.2.2.8
	rthornb_UrsulaBuild-27May1998:4.2.2.8
	mstphens_Kernel-3_80:4.2.2.8
	rthornb_UrsulaBuild-21May1998:4.2.2.8
	afrost_Boca-1_2-Beta:4.1.7.5
	rthornb_UrsulaBuild_01May1998:4.2.2.8
	afrost_NC2_Generic:4.1.7.5
	Spinner_B20_2:4.1.7.5
	Spinner_19_3:4.1.7.5
	Spinner_B18:4.1.7.5
	Spinner_B17:4.1.7.5
	Spinner_B15:4.1.7.5
	Spinner_B14:4.1.7.5
	Spinner_B13:4.1.7.5
	Spinner_B12:4.1.7.5
	Spinner_B10:4.1.7.5
	Daytona:4.2.0.6
	Daytona_bp:4.2
	Ursula_bp:4.2
	Ursula:4.2.0.2
	Spinner_B7:4.1.7.4
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.2
	Spin_3Apr97:4.1.7.2
	ARTtmp:4.1.7.2.0.2
	Spin_merge:4.1.7.7
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.31
date	2018.11.07.22.28.07;	author jlee;	state Exp;
branches;
next	4.30;
commitid	Ub9LVqEF46x8X3ZA;

4.30
date	2018.07.14.19.02.21;	author jlee;	state Exp;
branches;
next	4.29;
commitid	DsDtaR4YavfJx8KA;

4.29
date	2018.07.07.14.06.26;	author jlee;	state Exp;
branches;
next	4.28;
commitid	VD8qInwgaJB98dJA;

4.28
date	2018.04.24.18.43.44;	author jlee;	state Exp;
branches;
next	4.27;
commitid	KGf9l84CSTjL2JzA;

4.27
date	2018.04.19.22.08.25;	author bavison;	state Exp;
branches;
next	4.26;
commitid	EJJRnnDGeShWk6zA;

4.26
date	2017.10.07.12.11.48;	author jlee;	state Exp;
branches;
next	4.25;
commitid	afNukMjf0Y8Ug7aA;

4.25
date	2017.09.09.10.35.40;	author rool;	state Exp;
branches;
next	4.24;
commitid	SuZJGVb4fAmIDv6A;

4.24
date	2017.08.19.16.43.31;	author jlee;	state Exp;
branches;
next	4.23;
commitid	43sQ2BtQwXrLlQ3A;

4.23
date	2017.06.07.20.45.26;	author jlee;	state Exp;
branches
	4.23.2.1;
next	4.22;
commitid	u2lBBGPD3exe2uUz;

4.22
date	2016.12.17.18.33.41;	author jlee;	state Exp;
branches;
next	4.21;
commitid	gK0l0oJHtyZOPmyz;

4.21
date	2016.12.15.15.27.00;	author jlee;	state Exp;
branches;
next	4.20;
commitid	SNoEvPlWCrTKR5yz;

4.20
date	2016.12.13.19.41.09;	author jlee;	state Exp;
branches;
next	4.19;
commitid	XeVhUEC50BLVkRxz;

4.19
date	2016.12.13.17.31.01;	author jlee;	state Exp;
branches;
next	4.18;
commitid	xwV3EbxXsXlhCQxz;

4.18
date	2016.08.02.22.10.40;	author jlee;	state Exp;
branches;
next	4.17;
commitid	CnQYuUGzojQfrMgz;

4.17
date	2016.06.30.20.59.35;	author jlee;	state Exp;
branches;
next	4.16;
commitid	skOEjp3ipLHx6xcz;

4.16
date	2016.06.30.20.28.51;	author jlee;	state Exp;
branches;
next	4.15;
commitid	lMnWzoE9eJz3Wwcz;

4.15
date	2016.06.30.20.07.58;	author jlee;	state Exp;
branches;
next	4.14;
commitid	IWoXxARWeuLDOwcz;

4.14
date	2000.08.15.16.47.24;	author sbrodie;	state Exp;
branches
	4.14.2.1;
next	4.13;

4.13
date	2000.06.28.16.12.26;	author bavison;	state Exp;
branches;
next	4.12;

4.12
date	2000.04.17.14.22.50;	author kbracey;	state Exp;
branches;
next	4.11;

4.11
date	2000.04.04.14.27.23;	author kbracey;	state Exp;
branches;
next	4.10;

4.10
date	99.10.19.14.47.54;	author kbracey;	state Exp;
branches;
next	4.9;

4.9
date	99.10.14.12.18.20;	author kbracey;	state Exp;
branches;
next	4.8;

4.8
date	99.09.23.16.47.39;	author kbracey;	state Exp;
branches;
next	4.7;

4.7
date	99.08.19.10.52.20;	author kbracey;	state Exp;
branches;
next	4.6;

4.6
date	99.08.17.11.16.13;	author kbracey;	state Exp;
branches;
next	4.5;

4.5
date	99.08.03.09.58.52;	author kbracey;	state Exp;
branches;
next	4.4;

4.4
date	99.02.09.10.57.35;	author nturton;	state Exp;
branches;
next	4.3;

4.3
date	98.09.30.08.42.15;	author kbracey;	state Exp;
branches;
next	4.2;

4.2
date	97.01.21.14.06.44;	author nturton;	state Exp;
branches
	4.2.2.1
	4.2.4.1;
next	4.1;

4.1
date	96.11.05.09.40.47;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.5.1
	4.1.7.1;
next	;

4.23.2.1
date	2017.07.29.11.13.05;	author jlee;	state Exp;
branches;
next	4.23.2.2;
commitid	E0o1zV5A8r2fc71A;

4.23.2.2
date	2017.08.31.18.47.00;	author jlee;	state Exp;
branches;
next	4.23.2.3;
commitid	e0d3gZHfENrcEo5A;

4.23.2.3
date	2017.09.10.11.27.18;	author jlee;	state Exp;
branches;
next	4.23.2.4;
commitid	EGooxXrB27MqTD6A;

4.23.2.4
date	2018.02.16.00.01.37;	author jlee;	state Exp;
branches;
next	4.23.2.5;
commitid	L7HYXYTsWSFlZ0rA;

4.23.2.5
date	2018.05.14.19.33.40;	author jlee;	state Exp;
branches;
next	;
commitid	wrVtYH84nAz1GiCA;

4.14.2.1
date	2000.09.15.12.38.00;	author kbracey;	state Exp;
branches;
next	4.14.2.2;

4.14.2.2
date	2000.10.02.08.52.19;	author kbracey;	state Exp;
branches;
next	4.14.2.3;

4.14.2.3
date	2000.10.03.12.05.59;	author mstephen;	state Exp;
branches;
next	4.14.2.4;

4.14.2.4
date	2000.10.05.11.55.12;	author mstephen;	state Exp;
branches;
next	4.14.2.5;

4.14.2.5
date	2000.10.05.13.54.49;	author kbracey;	state Exp;
branches;
next	4.14.2.6;

4.14.2.6
date	2000.10.05.14.33.00;	author mstephen;	state Exp;
branches;
next	4.14.2.7;

4.14.2.7
date	2000.10.05.16.46.36;	author dellis;	state Exp;
branches;
next	4.14.2.8;

4.14.2.8
date	2000.10.09.15.59.15;	author kbracey;	state Exp;
branches;
next	4.14.2.9;

4.14.2.9
date	2000.10.16.11.37.10;	author mstephen;	state Exp;
branches;
next	4.14.2.10;

4.14.2.10
date	2000.10.16.11.55.38;	author kbracey;	state Exp;
branches;
next	4.14.2.11;

4.14.2.11
date	2000.10.20.14.58.21;	author kbracey;	state Exp;
branches;
next	4.14.2.12;

4.14.2.12
date	2000.10.20.15.48.04;	author mstephen;	state Exp;
branches;
next	4.14.2.13;

4.14.2.13
date	2000.11.10.14.41.16;	author mstephen;	state Exp;
branches;
next	4.14.2.14;

4.14.2.14
date	2000.11.10.15.51.34;	author kbracey;	state Exp;
branches;
next	4.14.2.15;

4.14.2.15
date	2001.01.09.17.17.31;	author mstephen;	state Exp;
branches;
next	4.14.2.16;

4.14.2.16
date	2001.03.07.15.12.56;	author kbracey;	state Exp;
branches;
next	4.14.2.17;

4.14.2.17
date	2001.05.01.14.10.56;	author mstephen;	state Exp;
branches;
next	4.14.2.18;

4.14.2.18
date	2001.06.13.12.38.15;	author kbracey;	state Exp;
branches;
next	4.14.2.19;

4.14.2.19
date	2001.06.15.09.39.56;	author mstephen;	state Exp;
branches;
next	4.14.2.20;

4.14.2.20
date	2001.06.18.14.49.42;	author mstephen;	state Exp;
branches;
next	4.14.2.21;

4.14.2.21
date	2001.06.26.09.37.10;	author mstephen;	state Exp;
branches;
next	4.14.2.22;

4.14.2.22
date	2001.06.27.14.16.26;	author mstephen;	state Exp;
branches;
next	4.14.2.23;

4.14.2.23
date	2002.10.07.17.29.36;	author kbracey;	state Exp;
branches;
next	4.14.2.24;

4.14.2.24
date	2002.10.16.17.23.12;	author bavison;	state Exp;
branches;
next	4.14.2.25;

4.14.2.25
date	2002.11.30.00.31.03;	author bavison;	state Exp;
branches;
next	4.14.2.26;

4.14.2.26
date	2003.01.27.15.25.31;	author kbracey;	state Exp;
branches;
next	4.14.2.27;

4.14.2.27
date	2003.02.21.20.21.51;	author bavison;	state Exp;
branches;
next	4.14.2.28;

4.14.2.28
date	2003.03.31.09.44.08;	author kbracey;	state Exp;
branches;
next	4.14.2.29;

4.14.2.29
date	2004.05.06.16.01.59;	author kbracey;	state Exp;
branches;
next	4.14.2.30;

4.14.2.30
date	2004.06.18.14.38.53;	author bavison;	state Exp;
branches
	4.14.2.30.2.1;
next	4.14.2.31;

4.14.2.31
date	2011.07.31.13.48.09;	author jlee;	state Exp;
branches;
next	4.14.2.32;
commitid	o0Go7NdMMK4UrGtv;

4.14.2.32
date	2011.08.03.23.46.16;	author jlee;	state Exp;
branches;
next	4.14.2.33;
commitid	uz6Vep4mDx27F7uv;

4.14.2.33
date	2011.11.26.21.11.10;	author jlee;	state Exp;
branches;
next	4.14.2.34;
commitid	cI3W0zbtALQG6TIv;

4.14.2.34
date	2011.12.10.19.03.42;	author jlee;	state Exp;
branches
	4.14.2.34.2.1;
next	4.14.2.35;
commitid	tEbdTPC2UwO3XFKv;

4.14.2.35
date	2012.05.21.19.31.35;	author rsprowson;	state Exp;
branches;
next	4.14.2.36;
commitid	oEtPURiKNEPMRC5w;

4.14.2.36
date	2012.06.18.20.17.52;	author rsprowson;	state Exp;
branches;
next	4.14.2.37;
commitid	KeuVX14bDnORde9w;

4.14.2.37
date	2012.07.01.21.26.38;	author rsprowson;	state Exp;
branches;
next	4.14.2.38;
commitid	K3GB4gteEYUubUaw;

4.14.2.38
date	2012.09.18.22.01.12;	author jlee;	state Exp;
branches;
next	4.14.2.39;
commitid	eFa3Y1QY0MjZP3lw;

4.14.2.39
date	2013.01.10.21.19.05;	author rsprowson;	state Exp;
branches;
next	4.14.2.40;
commitid	F6D8WGw2f7PkWHzw;

4.14.2.40
date	2013.01.22.23.19.27;	author jlee;	state Exp;
branches;
next	4.14.2.41;
commitid	ySNxVh2X08tIdgBw;

4.14.2.41
date	2013.01.27.17.50.24;	author rsprowson;	state Exp;
branches;
next	4.14.2.42;
commitid	tDlfhdSfOxFReSBw;

4.14.2.42
date	2013.03.28.21.36.19;	author jlee;	state Exp;
branches;
next	4.14.2.43;
commitid	UN0GP6eB0LlNyBJw;

4.14.2.43
date	2013.04.07.07.47.34;	author rsprowson;	state Exp;
branches;
next	4.14.2.44;
commitid	PuNeWyWrAbKzEOKw;

4.14.2.44
date	2013.08.06.22.43.02;	author jlee;	state Exp;
branches;
next	4.14.2.45;
commitid	TOIaeUf2Q4rBIr0x;

4.14.2.45
date	2013.11.20.20.29.56;	author rsprowson;	state Exp;
branches;
next	4.14.2.46;
commitid	X1FKtc2EAz7Jz3ex;

4.14.2.46
date	2013.12.15.21.33.59;	author jlee;	state Exp;
branches;
next	4.14.2.47;
commitid	KwuK29hKRyXO7hhx;

4.14.2.47
date	2014.03.29.22.19.17;	author rsprowson;	state Exp;
branches;
next	4.14.2.48;
commitid	uHiQBUSd0oe72Eux;

4.14.2.48
date	2014.04.20.17.00.18;	author jlee;	state Exp;
branches;
next	4.14.2.49;
commitid	6eesW4yWEAvSyrxx;

4.14.2.49
date	2014.09.15.22.25.32;	author jlee;	state Exp;
branches;
next	4.14.2.50;
commitid	hm3PUFF80LIvBuQx;

4.14.2.50
date	2015.01.11.23.10.45;	author jlee;	state Exp;
branches;
next	4.14.2.51;
commitid	a9HNIsO4R7LP3F5y;

4.14.2.51
date	2015.07.10.20.16.39;	author jlee;	state Exp;
branches;
next	4.14.2.52;
commitid	wa0i3ESGlbkojMsy;

4.14.2.52
date	2015.07.17.00.28.24;	author jlee;	state Exp;
branches;
next	4.14.2.53;
commitid	s5cS0yKIca1Nvzty;

4.14.2.53
date	2015.08.05.21.51.27;	author jlee;	state Exp;
branches;
next	4.14.2.54;
commitid	SpZpzVH47zb408wy;

4.14.2.54
date	2015.08.14.22.02.28;	author jlee;	state Exp;
branches;
next	4.14.2.55;
commitid	6gyfvmM0cNZULhxy;

4.14.2.55
date	2015.08.31.19.28.33;	author jlee;	state Exp;
branches;
next	4.14.2.56;
commitid	Ni3KL17bG70fnszy;

4.14.2.56
date	2015.09.01.21.14.43;	author jlee;	state Exp;
branches;
next	4.14.2.57;
commitid	6XNouVrEaXcGVAzy;

4.14.2.57
date	2015.11.07.18.50.33;	author rool;	state Exp;
branches;
next	4.14.2.58;
commitid	fatEKQJAzhHGYbIy;

4.14.2.58
date	2016.03.10.22.57.37;	author jlee;	state Exp;
branches;
next	4.14.2.59;
commitid	DAXUqMY2ucjim9Yy;

4.14.2.59
date	2016.04.05.19.36.32;	author jlee;	state Exp;
branches;
next	4.14.2.60;
commitid	8RLqvkae1X7wpt1z;

4.14.2.60
date	2016.04.06.21.02.06;	author jlee;	state Exp;
branches;
next	4.14.2.61;
commitid	v0nIS0nphnMTQB1z;

4.14.2.61
date	2016.05.19.21.03.46;	author jlee;	state Exp;
branches;
next	;
commitid	7f3vfXP8BWCNt87z;

4.14.2.30.2.1
date	2009.02.21.17.41.24;	author jlee;	state Exp;
branches;
next	4.14.2.30.2.2;

4.14.2.30.2.2
date	2009.07.23.00.57.10;	author jlee;	state Exp;
branches;
next	4.14.2.30.2.3;

4.14.2.30.2.3
date	2011.02.19.22.19.30;	author jlee;	state Exp;
branches;
next	4.14.2.30.2.4;

4.14.2.30.2.4
date	2011.07.31.13.39.16;	author jlee;	state Exp;
branches;
next	4.14.2.30.2.5;
commitid	tnhfpNorgEFQoGtv;

4.14.2.30.2.5
date	2011.08.03.23.52.00;	author jlee;	state Exp;
branches;
next	4.14.2.30.2.6;
commitid	LLn4KPy3Hjh5H7uv;

4.14.2.30.2.6
date	2011.09.12.18.52.29;	author bavison;	state Exp;
branches;
next	4.14.2.30.2.7;
commitid	KJtDPjWMk0KCKezv;

4.14.2.30.2.7
date	2011.09.12.20.31.37;	author jlee;	state Exp;
branches;
next	;
commitid	aYOriTZbxBByifzv;

4.14.2.34.2.1
date	2012.07.20.00.51.53;	author bavison;	state Exp;
branches;
next	4.14.2.34.2.2;
commitid	ELcSZZYPVgQ6Kedw;

4.14.2.34.2.2
date	2012.09.18.13.44.36;	author jlee;	state Exp;
branches;
next	4.14.2.34.2.3;
commitid	2BntgJjnyfkD51lw;

4.14.2.34.2.3
date	2012.09.18.15.49.56;	author jlee;	state Exp;
branches;
next	;
commitid	jeuxYpI6CQUxM1lw;

4.2.2.1
date	97.05.21.09.29.56;	author mstphens;	state Exp;
branches;
next	4.2.2.2;

4.2.2.2
date	97.05.23.13.06.48;	author kbracey;	state Exp;
branches;
next	4.2.2.3;

4.2.2.3
date	97.09.09.13.32.39;	author mstphens;	state Exp;
branches;
next	4.2.2.4;

4.2.2.4
date	97.10.21.15.30.56;	author mstphens;	state Exp;
branches;
next	4.2.2.5;

4.2.2.5
date	97.12.08.14.34.06;	author mstphens;	state Exp;
branches;
next	4.2.2.6;

4.2.2.6
date	98.03.26.11.25.07;	author mstphens;	state Exp;
branches;
next	4.2.2.7;

4.2.2.7
date	98.04.14.11.23.46;	author mstphens;	state Exp;
branches;
next	4.2.2.8;

4.2.2.8
date	98.04.28.17.05.37;	author mstphens;	state Exp;
branches
	4.2.2.8.2.1;
next	4.2.2.9;

4.2.2.9
date	98.09.24.13.16.50;	author mstphens;	state Exp;
branches;
next	;

4.2.2.8.2.1
date	98.11.23.14.58.55;	author mstphens;	state Exp;
branches;
next	;

4.2.4.1
date	97.04.04.14.40.43;	author nturton;	state Exp;
branches;
next	;

4.1.1.1
date	96.11.05.09.40.47;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.06.01.58.23;	author nturton;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.12.09.08;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.21.02.30;	author nturton;	state Exp;
branches;
next	4.1.7.2;

4.1.7.2
date	97.03.14.18.17.07;	author scormie;	state Exp;
branches;
next	4.1.7.3;

4.1.7.3
date	97.04.28.18.41.21;	author scormie;	state Exp;
branches;
next	4.1.7.4;

4.1.7.4
date	97.04.30.10.31.21;	author scormie;	state Exp;
branches;
next	4.1.7.5;

4.1.7.5
date	97.05.14.15.47.32;	author nturton;	state Exp;
branches;
next	4.1.7.6;

4.1.7.6
date	98.07.21.17.57.34;	author nturton;	state Exp;
branches;
next	4.1.7.7;

4.1.7.7
date	98.09.24.12.36.34;	author kbracey;	state Exp;
branches;
next	;


desc
@@


4.31
log
@Attempt to tidy up substitute screen mode selection logic
Detail:
  Over the years the OS's substitute screen mode selection logic has grown to be a tangled mess, and the logic it does implement isn't always very useful. Additionally, the kernel is structured in such a way that it can be hard for modules to override it.
  This set of changes aims to fix the many of the problems, by doing the following:
  - Moving all substitute mode selection logic out of the core VDU driver code and into a Service_ModeTranslation handler. This means you now only have one place in the kernel to look instead of several, and modules can override the behaviour by claiming/blocking the service call as appropriate.
  - Moving handling of the built-in VIDC lists out of the core VDU driver code and into a Service_ModeExtension handler. This means programs can now inspect these VIDC lists by issuing the right service call (although you are essentially limited to lists which the GraphicsV driver is OK with)
  - Moving *TV interlace & offset adjustment logic into the Service_ModeExtension handler, since they're legacy things which can be handled more cleanly for MDF/EDID (and the old code was poking memory the kernel didn't own)
  - Adding a Service_EnumerateScreenModes implementation, so that if you end up in the desktop with ScreenModes non-functional, the display manager at least has something useful to show you
  - Enhancing the handling of the built-in numbered modes so that they are now available in any colour depth; the Service_ModeExtension handler (and related handlers) treat the builtin VIDC lists as a set of mode timings, not a discrete set of modes
  - Substitute mode selection logic is a complete re-write. Instead of trying a handful of numbered fallback modes, it now tries:
    - Same mode but at higher colour depths
    - Same mode but at lower colour depths
    - Alternate resolutions (half-width mode with no double-pixel if original request was for double-pixel, and default resolution for monitor type)
  - Combined with the logic to allow the builtin VIDC lists to be used at any colour depth, this means that the kernel should now be able to find substitute modes for machines which lack support for <=8bpp modes (e.g. OMAP5)
  - Additionally the mode substitution code will attempt to retain as many properties of the originally requested mode as possible (eigen values, gap mode type, etc.)
  Other improvements:
  - The kernel now actually vets the builtin VIDC lists instead of assuming that they'll work (which also means they'll have the correct ExtraBytes value, where applicable)
  - The kernel now uses GraphicsV 19 (VetMode2) to vet the mode during the mode switch process, using the result to detect where the framebuffer will be placed. This allows for GraphicsV drivers to switch between DA 2 and external framestores on a per-mode basis.
  - The kernel now supports mode selectors which specify LineLength values which are larger than necessary; this will get translated to a suitable ExtraBytes control list item (+ combined with whatever padding the driver indicates is necessary via the VetMode2 result)
  File changes:
  - hdr/KernelWS - Reserve space for a VIDC list, since the Service_ModeExtension implementation typically can't use the built-in list as-is
  - s/Arthur3 - Issue Service_ModeFileChanged when the configured monitor type is changed, so that DisplayManager + friends are aware that the set of available modes has changed
  - s/GetAll - Fiddle with GETs a bit
  - s/MemMap2 - Extra LTORG
  - s/NewIRQs - Small routine to install/uninstall false VSync routine (previously from PushModeInfo, which wasn't really the appropriate place for it)
  - s/Utility - Hook up the extra service call handlers
  - s/vdu/legacymodes - New file containing the new service call implementations, and some related code
  - s/vdu/vdudecl - Move mode workspace definition here, from vdumodes
  - s/vdu/vdudriver - Remove assorted bits of mode substitution code. Plug in new bits for calling GraphicsV 19 during mode set, and deal with ExtraBytes/LineLength during PushModeInfo
  - s/vdu/vdumodes - Move some workspace definitions to s/vdu/vdudecl. Tweak how the builtin VIDC lists are stored.
  - s/vdu/vduswis - Rip out more mode substitution code. Issue Service_ModeFileChanged when monitor type is changed by OS_ScreenMode.
Admin:
  Tested on Raspberry Pi 3, Iyonix, IGEPv5


Version 6.14. Tagged as 'Kernel-6_14'
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
        SUBT    > Kernel WorkSpace

OldOpt  SETA    {OPT}
        OPT     OptNoList+OptNoP1List

; ***********************************
; ***    C h a n g e   L i s t    ***
; ***********************************

; Date       Name  Description
; ----       ----  -----------
; 02-Nov-87  APT   Added module SWI hash table
; 03-Nov-87  APT   Modo-fied module SWI hash table info, removed BRKLST
; 09-Nov-87  APT   Removed ESCCNT and ESFLG
; 12-Nov-87  APT   Added IRQsema
; 13-Nov-87  APT   Added DefaultIRQ1V codespace
; 16-Nov-87  APT   PIRQ chain heads
; 18-Nov-87  APT   Reordered EvtHan, EvtHan_ws
; 19-Nov-87  APT   Moved IRQsema
; 01-Dec-87  APT   Added interruptible heap manager workspace
; 08-Dec-87  TMD   Added ECFShift, ECFYOffset
; 14-Dec-87  TMD   Added DisplayNColour, DisplayModeFlags
; 15-Dec-87  TMD   Added KeyAlphabet
; 22-Dec-87  NDR   Using ScratchSpace
; 13-Jan-88  APT   General scratchspace bash, low workspace reordering.
;                  Removed spurious 32 bytes of osbyte wspace
; 14-Jan-88  APT   *type buffer in scratchspace.
;                  MOShasFIQ byte added
; 20-Jan-88  APT   Workspace juggling for speed & space; also discarded
;                  Level0 stuff.
; 28-Jan-88  APT   MetroGnome moved to "public" location for ADFS
; 02-Feb-88  APT   FIQclaim_interlock added
; 05-Feb-88  APT   CallBack_Vector
; 09-Feb-88  APT   RAM for SWI despatch
; 17-Feb-88  TMD   Added VduSaveArea, VduSaveAreaPtr, DisplayModeNo
; 26-Feb-88  APT   NoOfCamEntries manifest
; 03-Mar-88  APT   Shrank SVC despatch
; 03-Mar-88  APT   NoOfCamEntries manifest doubled
; 07-Mar-88  TMD   Added DisplayScreenStart, VduOutputCurrentState,
;                  SpriteMaskSelect, reordered mode variables
; 07-Mar-88  APT   Made CamEntries always at &164
; 07-Mar-88  TMD   Added GCharSizes, GCharSizeX, GCharSizeY
; 08-Mar-88  TMD   Added GCharSpacing, GCharSpaceX, GCharSpaceY
; 08-Mar-88  TMD   Moved GCharSizes..GCharSpaceY into first 1K of workspace
; 15-Mar-88  TMD   Added HLineAddr
; 18-Mar-88  TMD   Added DisplayXWindLimit, DisplayYWindLimit,
;                   DisplayXEigFactor, DisplayYEigFactor, PointerXEigFactor
; 18-Mar-88  APT   Setting variables scratchspace use revised.
; 21-Mar-88  TMD   Removed CursorIndex
; 22-Mar-88  TMD   Added TCharSizeX,TCharSizeY,TCharSpaceX,TCharSpaceY
; 29-Mar-88  TMD   Added GcolOraEorAddr
; 31-Mar-88  TMD   Removed WsFontPtr
; 07-Apr-88  SKS   Added HeapSort use of ScratchSpace
; 14-Apr-88  TMD   Added SerialFlags
; 28-Apr-88  TMD   Added XONXOFFChar
;  5-May-88  APT   Added MemorySpeed
; 18-May-88  APT   Added CannotReset sema at &107, removed pre-1.20 changes.
; 24-May-88  TMD   Added ClipBoxEnable, ClipBoxLCol..ClipBoxTRow, moved in
;                   ScrLoaSpriteCB, ScrLoaBuffer, SrcSavCommon
; 24-May-88  TMD   Flood fill uses ScratchSpace
; 01-Jun-88  TMD   Added AlignSpace for ClipBoxCoords
; 03-Jun-88  BCSKS Make Keyboard buffer into a useful part of the system
;                  Also PrinterBufferSize
; 09-Jun-88  DJS   Draw uses ScratchSpace
; 09-Jun-88  BC    Gave Econet some private debungling space
; 11-Jun-88  SKS   Align IRQ stack to make STMFD not cross two MEMC bdy's
;                  Made info condit'l on AsmArf; someone had commented it out!
; 15-Jun-88  SKS   Added two more instructions in SWIDespatch area
;                  Moved SLVK definition into kernel; it's not public
; 16-Jun-88  SKS   Added 3 more instructions in SWIDespatch area + nailed
;                  SvcTable address for compatibility
; 22-Jun-88  SKS   Moved MEMC_CR_SoftCopy into pubic ws
; 19-Jul-88  APT   Added UpCall handler stuff
; 20-Jul-88  SKS   Added above entry
;                  Amended comment about overlaid workspace in vdu
; 15-Aug-88  SKS   Inserted DomainId at FF8 (set by Wimp on task swap, used by
;                  FileSwitch to tag resources)
; 27-Sep-89  JSR   Added ColourTrans to users of scratch space
; 24-Oct-89  TMD   Added CamEntriesForBigMachines, CamEntriesPointer
; 26-Oct-89  TMD   Added MaxCamEntry, removed NoOfCamEntries symbol
; 27-Oct-89  TMD   Added VIDCClockSpeed
; 09-Nov-89  TMD   Added ResetIndirection
; 15-Jan-91  TMD   Added ROMModuleChain
; 04-Feb-91  DDV   Added DeviceFS as user of ScratchSpace.
; 04-Feb-91  DDV   Added ColourTrans use of ScratchSpace to build diff tables.
; 06-Mar-91  TMD   Added IOSystemType
; 07-Mar-91  LVR   ADFS uses scratch space for floppy formatting
; 07-Mar-91  TMD   Added MonitorLeadType
; 08-Mar-91  TMD   Added PrinterBufferAddr, PrinterBufferSize
; 11-Apr-91  TMD   Added SerialInHandle, SerialOutHandle
; 24-Apr-91  TMD   Added UniqueMachineID
; 09-Jun-91  RM    Added KernelMessagesBlock,ErrorSemaphore and MOSConvertBuffer
; 26-Jul-91  JSR   Extend GeneralMOSBuffer by 4 bytes to make it a valid
;                       length for the default error handler's error buffer
; 19-Aug-91  JSR   Added *If to list of GeneralMOSBuffer users
; 22-Aug-91  TMD   Reduced ErrorSemaphore to a byte, added PortableFlag
; 25-Aug-91  DDV   Updated to indicate correct usage of scratch space by ColourTrans
; 09-Jan-92  DDV   Added FgPattern, BgPattern and indicate use of ScratchSpace by OS_SetColour
; 20-Jan-92  TMD   OS_SetColour no longer uses ScratchSpace
; 17-Feb-92  ECN   Added CLibWord and RISCOSLibWord
; 02-Apr-92  TMD   Added ScreenBlankFlag
; 27-Jul-92  TMD   Create Victoria specific version
; 28-Jul-92  TMD   Moved RAMDiscAddress
; 29-Jul-92  TMD   Moved SpriteSpaceAddress
; 30-Jul-92  TMD   Moved FontCacheAddress
; 31-Jul-92  TMD   Moved ScreenEndAdr from source.vdudecl, and moved actual address!
; 03-Aug-92  TMD   Added PhysRam (moved from hdr:System)
; 24-Aug-92  TMD   Added AbortIndirection
; 26-Aug-92  TMD   Added PreVeneerRegDump
; 02-Sep-92  TMD   Added FirPalAddr, SecPalAddr
; 10-Sep-92  DDV   Added new Vdu Variables for new text expansion buffer
; 17-Sep-92  DDV   Moved NColour into the word initialised VDU workspace
; 17-Sep-92  DDV   Two new colour words added for text foreground and background.
; 27-Jan-93  TMD   Moved RMA to new position
; 29-Jan-93  TMD   Put RMA back to old position (you can't branch to above 32M!)
; 01-Feb-93  TMD   Added PhysRamTable
; 02-Feb-93  TMD   Added VInitSoftCopy and VEndSoftCopy
; 03-Feb-93  TMD   Added PhysRamTableEnd
; 04-Feb-93  TMD   Added extra slot in PhysRamTable (in case soft-loaded OS splits a bank)
; 08-Feb-93  TMD   Added VRAMWidth variable, and extra symbols for skipped bits
; 24-Feb-93  TMD   Changed VRAMPhysAddr to VideoPhysAddr, and split off VideoSize from VRAMSize, to allow for
;                   DRAM-only systems
; 05-Mar-93  TMD   Added CMOSRAMCache
; 19-Apr-93  TMD   Added DAList, AppSpaceDANode and DANode offset symbols
; 26-Apr-93  TMD   Added FreePoolAddress, FreePoolMaxSize, FreePoolSize
; 29-Apr-93  TMD   Changed FontCacheAddress, SpriteSpaceAddress, RAMDiscAddress and FreePoolAddress
;                   in order to make way for L2PT, which is moving above 64M
; 10-May-93  TMD   Added SoftCamMapSize
; 11-May-93  TMD   Moved SoftCamMapSize into area that's not zapped in clearing all memory routine
; 12-May-93  TMD   Added FreePoolDANode, removed FreePoolSize
; 20-May-93  TMD   Moved AplWorkSize into AppSpaceDANode
; 27-May-93  TMD   Added VideoBandwidth
; 04-Jun-93  TMD   Added CurrentMonitorType
; 09-Jun-93  TMD   Added CamMapCorruptDebugBlock
; 07-Jul-93  TMD   Increased FreePoolMaxSize to 64M (had to reduce RAMDiscMaxSize to 48M and
;                   move FreePoolAddress down to do this)
; 15-Jul-93  TMD   Added KernelModeSelector
; 26-Jul-93  SMC   Moved DefaultIRQ1V (had to accommodate IRQs for IOMD DMA)
; 04-Aug-93  TMD   Added L2PTSize, removed FreePoolMaxSize
; 14-Aug-93  TMD   Removed SpriteSpaceAddress, shuffled things down
; 16-Aug-93  TMD   Removed RAMDiscAddress, shuffled things down
; 17-Aug-93  TMD   Removed FontCacheAddress, shuffled things down
;                  Corrected maximum size of system heap to 2M-8K.
;                  Added node (in bottom 32K) for system heap.
; 25-Aug-93  SMC   Added processor vector table at ProcVec_Start
;                  Added ProcVecPreVeneers
; 02-Sep-93  SMC   Moved RMA to &02100000 and changed application space size to 28M.
; 03-Sep-93  TMD   Moved InitKbdWs into SkippedTables (was at start of screen originally)
; 07-Oct-93  TMD   Put in OldMemoryMap option so I can still use it
; 07-Oct-93  TMD   Added ScreenBlankDPMSState, HSWRSoftCopy, VSWRSoftCopy
; 10-Dec-93  BC    Added RawMachineID
; 13-Dec-93  BC    Removed UniqueMachineID
; 14-Jan-94  TMD   Added CDASemaphore
; 18-Jan-94  TMD   Added MMUControlSoftCopy
; 15-Jun-94  AMcC  Renamed file (was VickySpace)
;                  The following values are 'exported' to PublicWS:
;                        Name:                     Used by:
;                        ----------------------------------
;                        BgEcfOraEor               SprExtend
;                        FgEcfOraEor               SprExtend
;                        BranchToSWIExit           TaskWindow
;                        CannotReset               FileCore
;                        DomainId                  FileSwitch
;                        ESC_Status                ADFS, DeviceFS
;                        IRQsema                   Draw, MsgTrans
;                        LatchBSoftCopy            ADFS, Parallel
;                        MEMC_CR_SoftCopy          ADFS
;                        RedirectInHandle          TaskWindow
;                        RedirectOutHandle         TaskWindow
;                        ScratchSpace              ADFS, Colours, Draw, FileCore
;                                                  FileSwitch, FontManager, NetFiler
;                        SoundDMABufferSize        Sound0
;                        SoundDMABuffers           Sound0
;                        SoundWorkSpace            Portable, Sound1, Sound2, Voices
;                        SVCSTK                    FileSwitch
;                        SvcTable                  TaskWindow, Wimp
;                        SysHeapStart              FileSwitch
;                        VduDriverWorkSpace        SprExtend
;
; 31-Oct-94  AMcC/RM/WT  Added CLine_Softcopy for Morris monitor id
; 03-Nov-94  AMcC        Export ScreenBlankFlag and ScreenBlankDPMSState
;                        (for DPMSUtils: part of RISC OS releases 3.50 and 3.60)
; 28-Mar-95  JRH         Added NVRamSize and RTCFitted, conditioned on E2ROMSupport
; 06-Feb-95  SMC         Increased SVC stack size to 12K.
; 18-Jan-96  JRH         Removed CLine_Softcopy cos not needed
; 06-Feb-96  SMC         Increased DefIRQ1Vspace for IRQC registers
; amg 6/12/96 Renaissance. Merge in changes below from 3.70 version. Make changes conditional.
; 07-Feb-95  WT          Added LCD_Active for LCD/CRT dynamic switching support
; 07-Feb-95  WT          Added VStartSoftCopy for dual-panel LCD support
; 18-May-95  WT          Added LCD_Inverted for LCD inversion (well, surprise surprise!)
; 05-Dec-95  WT          Added ProcessorType and ProcessorFlags (1 byte each)
; amg 07/12/96 Renaissance. Shifted ResetType (which is a public export) so it'll
;              stay in the same place.
; 21-Jul-98  NDT         Added PixelRate.  Moved KernelModeSelector to make space.
; 19-Oct-99  KJB         Moved IOSystemType into SkippedTables.
;
; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; Memory map:

; Dynamic area node format

                  ^     0
DANode_Link       #     4               ; points to next node (in address order)
DANode_Number     #     4               ; number of this area
DANode_Base       #     4               ; base address of area (points in middle of doubly-mapped areas)
DANode_Flags      #     4               ; various flags
DANode_Size       #     4               ; current logical size of area (not counting holes, if Sparse/PMP area)
DANode_MaxSize    #     4               ; maximum logical size of area
DANode_Workspace  #     4               ; workspace pointer when calling handlers
DANode_Handler    #     4               ; pointer to handler routine for area
DANode_Title      #     4               ; pointer to area title
DANode_SubLink    #     4               ; next node in any disjoint sublist (currently used for Shrinkables only)
DANode_SparseHWM  #     4               ; high water mark, if Sparse area (highest base+size claimed for area)
DANode_SortLink   #     4               ; next node in alphabetically sorted list
DANode_PMP        #     4               ; pointer to physical memory pool - zero if not PMP or has been resized to zero
DANode_PMPSize    #     4               ; number of pages currently in phys pool
DANode_PMPMaxSize #     4               ; size of phys memory pool, in pages
DANode_NodeSize   #     0

; CAM entry format
                  ^     0
CAM_LogAddr       #     4               ; Logical address page is assigned to (lower address if doubly mapped, Nowhere/DuffEntry if not mapped)
CAM_PageFlags     #     4               ; DynAreaFlags_* and PageFlags_*
CAM_PMP           #     4               ; Pointer to PMP (DANode ptr) if DynAreaFlags_PMP. 0 if not.
CAM_PMPIndex      #     4               ; Index of page in PMP page list. Invalid if not in PMP.
CAM_EntrySize     #     0
CAM_EntrySizeLog2 *     4


; The addresses below are only temporary; eventually most of them will be allocated at run time (we hope!)

 [ HiProcVecs
ProcVecs            * &FFFF0000
 |
ProcVecs            * &00000000
 ]
; Currently, zero page must be located at the processor vectors
ZeroPage            * ProcVecs

 [ CompatibilityPage
        ASSERT ZeroPage != 0 :LAND: ProcVecs != 0
 ]

; Sort out 26/32 bit versions
SVCStackSize        *  32*1024
IRQStackSize        *   8*1024
ABTStackSize        *   8*1024
UNDStackSize        *   8*1024
KbuffsMaxSize       *  64*1024
ScreenMaxSize       * 480*1024
DCacheCleanSize     * 256*1024  ;should be multiple of 64k

AplWorkMaxSize      * &20000000 ; 512M - temporary (need to decide this at boot time)
RMAAddress          * AplWorkMaxSize ; temporary - run time allocate?
RMAMaxSize          * &10000000 ; 256M
SysHeapChunkAddress * RMAAddress + RMAMaxSize
SysHeapAddress      * SysHeapChunkAddress
SysHeapMaxSize      * 32:SHL:20
FreePoolAddress     * 0

IOLimit             * &BA000000 ; initial lower limit on room for IO space (DA creation may move limit up)
IO                  * &FA000000 ; works downwards
HALWorkspace        * &FA000000
HALWorkspaceSize    * &00100000
IRQStackAddress     * &FA100000
SVCStackAddress     * &FA200000
ABTStackAddress     * &FA300000
UNDStackAddress     * &FA400000
PhysicalAccess      * &FA500000
DCacheCleanAddress  * &FA600000 ; eg. for StrongARM, 256k of space, up to FA640000
KbuffsBaseAddress   * &FA640000 ; kernel buffers for long command lines, size KbuffsMaxSize
HALWorkspaceNCNB    * &FA6E8000 ; 32K of uncacheable HAL workspace (if requested)
L2PT                * &FA800000
L1PT                * &FAC00000
CursorChunkAddress  * &FAFF0000
DuffEntry           * &FAFF8000 ; No page ever mapped in here (L2PT entry always 0), also, all non mapped pages
Nowhere             * DuffEntry ; use this as their CAM entry. There is only one 'Nowhere' (synonym).
CAM                 * &FB000000
CAMspace            * CAM_EntrySize*1024*1024 ; 1M entries = enough for 4GB of RAM

IRQSTK              * IRQStackAddress + IRQStackSize
ABTSTK              * ABTStackAddress + ABTStackSize
UNDSTK              * UNDStackAddress + UNDStackSize

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; system variables

        ^  0,R12

OSBYTEFirstVar  #  0

ByteVars  #  0                 ; The main osbyte variables, accessed
                               ; via calls &A6 to &FF

VarStart  #  2                 ; &A6,&A7
ROMPtr    #  2                 ; &A8,&A9
ROMInfo   #  2                 ; &AA,&AB
KBTran    #  2                 ; &AC,&AD
VDUvars   #  2                 ; &AE,&AF

CFStime   #  1                 ; &B0
InputStream #  1               ; &B1
KeyBdSema #  1                 ; &B2

ROMPollSema #  1               ; &B3
OSHWM     #  1                 ; &B4

RS423mode #  1                 ; &B5
NoIgnore  #  1                 ; &B6
CFSRFS    #  1                 ; &B7
VULAcopy  #  2                 ; &B8,&B9

ROMatBRK  #  1                 ; &BA
BASICROM  #  1                 ; &BB

ADCchanel #  1                 ; &BC
ADCmaxchn #  1                 ; &BD
ADCconv   #  1                 ; &BE

RS423use     #  1              ; &BF
RS423conflag #  1              ; &C0

FlashCount # 1                 ; &C1
SpacPeriod # 1                 ; &C2
MarkPeriod # 1                 ; &C3

KeyRepDelay # 1                ; &C4
KeyRepRate  # 1                ; &C5

ExecFileH   # 1                ; &C6
SpoolFileH  # 1                ; &C7

ESCBREAK    # 1                ; &C8 (200)

KeyBdDisable # 1               ; &C9
KeyBdStatus  # 1               ; &CA

RS423HandShake # 1             ; &CB
RS423InputSupr # 1             ; &CC
RS423CFSFlag   # 1             ; &CD

EconetOScall # 1               ; &CE
EconetOSrdch # 1               ; &CF
EconetOSwrch # 1               ; &D0

SpeechSupr # 1                 ; &D1
SoundSupr # 1                  ; &D2

BELLchannel # 1                ; &D3
BELLinfo    # 1                ; &D4
BELLfreq    # 1                ; &D5
BELLdur     # 1                ; &D6

StartMessSupr # 1              ; &D7

SoftKeyLen # 1                 ; &D8

PageModeLineCount # 1          ; &D9

VDUqueueItems # 1              ; &DA

TABch # 1                      ; &DB
ESCch # 1                      ; &DC

IPbufferCh # 4                 ; &DD,&DE,&DF,&E0
RedKeyCh   # 4                 ; &E1,&E2,&E3,&E4

ESCaction  # 1                 ; &E5
ESCeffect  # 1                 ; &E6

u6522IRQ # 1                   ; &E7
s6850IRQ # 1                   ; &E8
s6522IRQ # 1                   ; &E9

TubeFlag # 1                   ; &EA

SpeechFlag # 1                 ; &EB

WrchDest # 1                   ; &EC
CurEdit  # 1                   ; &ED

SoftResetVars # 0              ; Reset to here on soft reset

KeyBase # 1                    ; &EE
Shadow # 1                     ; &EF
Country # 1                    ; &F0

UserFlag # 1                   ; &F1

SerULAreg # 1                  ; &F2

TimerState # 1                 ; &F3

SoftKeyConsist # 1             ; &F4

PrinterDrivType   # 1          ; &F5
PrinterIgnore     # 1          ; &F6

BREAKvector # 3                ; &F7,&F8,&F9

MemDriver  # 1                 ; &FA - where the VDU drivers write to
MemDisplay # 1                 ; &FB - where we display from

LangROM # 1                    ; &FC

LastBREAK # 1                  ; &FD

KeyOpt # 1                     ; &FE

StartOptions # 1               ; &FF

HardResetVars # 0              ; Reset to here on hard reset
PowerOnResetVars # 0           ; Reset to here on power-on reset

; These two can dovetail in here to use up 2 bytes before the AlignSpace!

SerialInHandle # 1              ; Handle for serial input stream  (0 if not open currently)
SerialOutHandle # 1             ; Handle for serial output stream (-----------""----------)

        AlignSpace

EventSemaphores # 32            ; One byte for each of 32 events

TimerAlpha # 8                  ; As used by time (bottom 5 bytes)
TimerBeta  # 8                  ; ................................
; both aligned to word boundaries

RealTime # 8                    ; 5-byte fast real-time

PrinterActive # 4               ; Handle/active flag for printer (word aligned)

IntervalTimer # 5               ; Up Counter synchronous with TIME.
; Event generated when Zero is reached
; bottom byte aligned to word boundary

SecondsTime # 1 ; the soft copy (centi-)seconds of the RTC
CentiTime   # 1 ; """"""""""""""""""""""""""""""""""""""""

FlashState # 1 ; which flash colours are we using

SecondsDirty # 1                ; the dirty flag for start up!

MinTick # 1                     ; the minutes odd/even state

DCDDSRCopy # 1                  ; copy of ACIA bits to check for change

TVVertical # 1                  ; *TV first parameter

TVInterlace # 1                 ; *TV second parameter

CentiCounter # 1                ; Counter for VDU CTRL timing

Alphabet # 1                    ; Current alphabet number

Keyboard # 1                    ; Current keyboard number

KeyAlphabet # 1                 ; Alphabet associated with current keyboard

                GBLS    PrinterPrefix
PrinterPrefix   SETS    "PrinterType$"

PrinterTypeName #       6 + :LEN: (PrinterPrefix)

        AlignSpace

SerialFlags # 4                 ; New serial flags

XONXOFFChar # 1                 ; Character to send before rest (0 if none)

        AlignSpace

OSBYTEVarSize * @@-OSBYTEFirstVar

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

; End of variables' space

; *** layout of a descriptor block for a display pointer shape ***

                  ^  0
PointerBlkHAL     #  0  ; fields up to private part passed to HAL
PointerWidth      #  1  ; actual (unpadded) shape width in bytes (from OS_Word 21)
PointerHeight     #  1  ; shape height in pixels
                  #  2  ; alignment padding
PointerBuffLA     #  4  ; logical address of shape buffer (up to 8 * 32 bytes)
PointerBuffPA     #  4  ; physical address of shape buffer
PointerBlkPrivate #  0  ; fields below here not used by HAL
PointerActiveX    #  1  ; active x in pixels from left
PointerActiveY    #  1  ; active y in pixels from top
                  #  2  ; alignment padding
PointerBlkSize    #  0


; ***********************************
; ***  Main Vdu Driver Workspace  ***
; ***********************************

        ^ 0

FgEcf  # 4 * 8  ; Foreground Ecf, set by GCOL(a,0-127)
BgEcf  # 4 * 8  ; Background Ecf, set by GCOL(a,128-255)
GPLFMD # 4      ; Foreground action, set by GCOL(a,0-127)
GPLBMD # 4      ; Background action, set by GCOL(a,128-255)
GFCOL  # 4      ; Foreground colour, set by GCOL(a,0-127)
GBCOL  # 4      ; Background colour, set by GCOL(a,128-255)

GWLCol # 4      ; Graphics window left column  --
GWBRow # 4      ; Graphics window bottom row     |
GWRCol # 4      ; Graphics window right column   |
GWTRow # 4      ; Graphics window top row      --

qqqPad   # 3
QQ       # 17   ;Queue - QQ+1 is on a word boundary
QOffset  # 4    ;Value to add to VDUqueueItems to point to next queue posn.
JVec     # 4    ;Jump vector to internal routines

; Start of MODE table workspace

ScreenSize # 4  ; number of bytes needed for this mode (assumed 1st in list)

XWindLimit # 4  ; Maximum value of GWRCol (internal representation)

; LineLength must be immediately after YWindLimit

YWindLimit # 4  ; Maximum value of GWTRow (internal representation)

LineLength # 4  ; Length of one pixel row in bytes

NColour # 4     ; Number of colours minus 1

YShftFactor # 4 ; Number of places to shift YCoord in address generation after
                ; multiplying by 5, holds
                ; 7,6,5 or 4 for 8,4,2 or 1 bits per pixel (640x256 mode) or
                ; 6,5,4 or 3 for 8,4,2 or 1 bits per pixel (320x256 mode).

ModeFlags # 4   ; Bit 0 => non-graphic, Bit 1 => teletext, Bit 2 => gap mode

XEigFactor # 4  ; Number of places to shift XCoord in external to internal
                ; coordinate conversion, holds
                ; 1 for 640x256 mode
                ; 2 for 320x256 mode
                ; 3 for 160x256 (BBC micro mode 2)

YEigFactor # 4  ; number of shifts to convert between internal/external Y

Log2BPC # 4     ; Log to base 2 of BytesPerChar ie (0,1,2,3,4)

Log2BPP # 4     ; Log to base 2 of BitsPerPix ie (0,1,2,3)

ScrRCol # 4     ; Maximum column number in this screen mode
ScrBRow # 4     ; Maximum row number in this screen mode

; End of table-initialised workspace

         # 8    ; SPARE

; Next 3 must be together in this order !

XShftFactor # 4 ; Number of places to shift XCoord in address generation,
                ; holds 2,3,4 or 5 for 8,4,2,1 bits per pixel respectivly
GColAdr # 4     ; Address of Ecf to plot - either FgEcf or BgEcf

ScreenStart # 4         ; Start address of screen (for VDU drivers)

NPix # 4        ; Number of pixels per word minus 1, holds
                ; holds 3,7,15 or 31 for 8,4,2,1 bits per pixel modes

AspectRatio # 4 ; Pixel shape : 0 square, 1 horz rect, 2 vert rect

BitsPerPix # 4  ; Bits per pixel (1,2,4,8)

BytesPerChar # 4        ; Bytes per 8 pixels of character
                        ; (same as BitsPerPix except in double pixel modes)

DisplayLineLength # 4   ; LineLength of display. May include padding from ExtraBytes control list item, so needs manual preservation during screen redirection.

RowMult # 4     ; Row multiplier for text manipulation

RowLength # 4   ; Bytes per text row in this mode (eg 640,1280,5120)

; The following (up to and including NewPtY) must be together in this order
; (relied upon by DefaultWindows)

TWLCol # 4      ; Text window left column  --
TWBRow # 4      ; Text window bottom row     |
TWRCol # 4      ; Text window right column   |
TWTRow # 4      ; Text window top row      --

OrgX # 4        ; Screen origin (external representation)
OrgY # 4

GCsX # 4        ; Graphics cursor (external representation)
GCsY # 4

OlderCsX # 4    ; Very old X coordinate (internal)
OlderCsY # 4    ; Very old Y coordinate (internal)

OldCsX # 4      ; Old graphics cursor (internal representation) --
OldCsY # 4      ;                                                 |
                ;                                                 |
GCsIX  # 4      ; Graphics cursor (internal representation)       |
GCsIY  # 4      ;                                                 |
                ;                                                 |
NewPtX # 4      ; Newest point (internal representation)          |
NewPtY # 4      ;                                               --

; End of together block

TForeCol # 4    ; Text foreground colour
TBackCol # 4    ; Text background colour

CursorX # 4     ; Text cursor X position ; these 3 must be in same order as ...
CursorY # 4     ; Text cursor Y position
CursorAddr # 4  ; Screen address of (output) cursor

InputCursorX # 4        ; Input cursor X position ; ... these 3
InputCursorY # 4        ; Input cursor Y position
InputCursorAddr # 4     ; Screen address of input cursor

EORtoggle # 4   ; Toggle between gap and non-gap
RowsToDo  # 4   ; in the CLS

VduStatus # 4   ; Vdu2, Window, Shadow bits (others in CursorFlags)

CBWS # 8        ; Clear block (VDU 23,8..) workspace
CBStart # 2
CBEnd # 2

CursorDesiredState # 4
CursorStartOffset # 4
CursorEndOffset # 4
CursorCounter # 4
CursorSpeed # 4
Reg10Copy # 4

CursorFill # 4  ; Word to EOR cursor ; MUST be immediately before CursorNbit

CursorNbit # 4  ; Pointer to cursor code for current mode

DisplayStart # 4        ; Start address of screen (for display)
DriverBankAddr # 4      ; Default start address for VDU drivers
DisplayBankAddr # 4     ; Default start address for display
DisplayNColour # 4      ; No. of colours -1 for displayed mode
DisplayModeFlags # 4    ; ModeFlags for displayed mode
DisplayModeNo # 4       ; ModeNo for displayed mode
DisplayScreenStart # 4  ; Where VDU outputs to when outputting to screen

DisplayXWindLimit # 4   ; Used for pointer programming
DisplayYWindLimit # 4
DisplayXEigFactor # 4
DisplayYEigFactor # 4
DisplayLog2BPP # 1
PointerXEigFactor # 1
                  # 2

Ecf1 # 8        ; The Ecf patterns
Ecf2 # 8
Ecf3 # 8
Ecf4 # 8

DotLineStyle # 8        ; Dot dash line pattern

ModeNo # 4      ; Current mode number

TFTint # 4      ; Text foreground tint          (in bits 6,7)
TBTint # 4      ; Text background tint
GFTint # 4      ; Graphics foreground tint
GBTint # 4      ; Graphics background tint

TotalScreenSize # 4     ; Amount configured for screen (in bytes)

MaxMode # 4             ; Maximum mode number allowed (20 for now)

ScreenEndAddr # 4       ; Logical address of screen (start of 2nd copy)

CursorFlags # 4 ; Silly Master cursor movement flags

CursorStack # 4 ; Bit stack of nested cursor states (0 => on, 1 => off)
                ; (bit 31 = TOS)

ECFShift # 4    ; number of bits to rotate right ECF OR and EOR masks by
ECFYOffset # 4  ; vertical offset to ECF index

        ASSERT  ECFShift =  Legacy_ECFShift
        ASSERT ?ECFShift = ?Legacy_ECFShift
        ASSERT  ECFYOffset =  Legacy_ECFYOffset
        ASSERT ?ECFYOffset = ?Legacy_ECFYOffset

WsVdu5 # 0      ; Vdu 5 workspace
WsScr # 4
WsEcfPtr # 4
; WsFontPtr # 4 ; not needed any more, kept in register
EndVerti # 4
StartMask # 4
EndMask # 4
FontOffset # 4
TempPlain # 16  ; only used for MODE 10

VIDCClockSpeed # 4      ; current VIDC clock speed in kHz (now always zero)

CurrentMonitorType # 4  ; initialised from configured one

PixelRate # 4   ; Pixel Rate in kHz

BorderL # 4             ; Size of border
BorderB # 4
BorderR # 4
BorderT # 4

GraphicWs # 300 ; All graphics workspace is overlaid here
EndGraphicWs # 0

 [ :DEF: ShowWS
 ! 0,"16 ":CC::STR:@@
 ]
        AlignSpace 16

GCharSizes  # 0
GCharSizeX  # 4         ; width of VDU 5 chars in pixels
GCharSizeY  # 4         ; height of VDU 5 chars in pixels

GCharSpacing # 0
GCharSpaceX  # 4        ; horizontal spacing between VDU 5 chars in pixels
GCharSpaceY  # 4        ; vertical   ------------------""-----------------

TCharSizes  # 0
TCharSizeX  # 4         ; width of VDU 4 chars in pixels
TCharSizeY  # 4         ; height of VDU 4 chars in pixels

TCharSpacing # 0
TCharSpaceX  # 4        ; horizontal spacing between VDU 4 chars in pixels
TCharSpaceY  # 4        ; vertical   ------------------""-----------------

HLineAddr      # 4      ; address of exported HLine
GcolOraEorAddr # 4      ; address of FgEcfOraEor etc

BlankPalAddr  # 4       ; address of block for blank palette
FirPalAddr    # 4       ; address of block for first flash state palette
SecPalAddr    # 4       ; address of block for second flash state palette

CurrentGraphicsVDriver # 4 ; Current driver number

PointerShapes      # 0
PointerShape1      # 4  ; pointers to defined shapes 1 to 4
PointerShape2      # 4
PointerShape3      # 4
PointerShape4      # 4
PointerShapesH     # 0
PointerShapeH1     # 4  ; pointers to holding shapes 1 and 2 (so updates never hit shape given to HAL)
PointerShapeH2     # 4

PointerShapeBlocks # 6*PointerBlkSize ; room for the 6 shape descriptors themselves

PointerShapeLA     # 4               ; logical address of current shape buffer (owned by HAL)
PointerShapeNumber # 1               ; includes bit 7 linkage flag
                   # 3               ; alignment padding
PointerX           # 4               ; co-ordinates of pointer (not always = mouse)
PointerY           # 4

 [ :DEF: ShowWS
  ! 0, "PointerShapes @@ ":CC::STR:(PointerShapes)
 ]

GraphicsVFeatures  # 4               ; features word from current driver, refreshed each mode change
TrueVideoPhysAddr  # 4               ; VideoPhysAddr is a lie, use this instead
MaxGraphicsVDrivers * 8
GraphicsVDrivers # MaxGraphicsVDrivers*4 ; List of drivers
                # 4*4                ; SPARE (avoiding changes of exported addresses for now)

TextFgColour    # 4             ; Fg/Bg colour stored as a colour number, computed on VDU 18 and re-poked!
TextBgColour    # 4             ;

; In this brave new world there is a pointer to the text expansion
; buffer used for VDU 4 / 5 text plotting.

; This now lives in the system heap.

TextExpandArea # 4      ; Pointer to Text expand area (in system heap)
TextExpandArea_Size * (8*1024)

                 # 2*4   ; SPARE (avoiding changes of exported addresses for now)

ScreenBlankFlag # 1     ; 0 => unblanked, 1 => blanked

        ASSERT  ScreenBlankFlag =  Legacy_ScreenBlankFlag
        ASSERT ?ScreenBlankFlag = ?Legacy_ScreenBlankFlag

ScreenBlankDPMSState # 1       ; 0 => just blank video
                               ; 1 => blank to stand-by (hsync off)
                               ; 2 => blank to suspend (vsync off)
                               ; 3 => blank to off (H+V off)

        ASSERT  ScreenBlankDPMSState =  Legacy_ScreenBlankDPMSState
        ASSERT ?ScreenBlankDPMSState = ?Legacy_ScreenBlankDPMSState


 [ :DEF: ShowWS
 ! 0,"64 ":CC::STR:@@
 ]
        AlignSpace 64

FgEcfOraEor # 4*16      ; Interleaved zgora & zgeor
        ASSERT  FgEcfOraEor =  Legacy_FgEcfOraEor
        ASSERT ?FgEcfOraEor = ?Legacy_FgEcfOraEor

BgEcfOraEor # 4*16      ; Interleaved zgora & zgeor
        ASSERT  BgEcfOraEor =  Legacy_BgEcfOraEor
        ASSERT ?BgEcfOraEor = ?Legacy_BgEcfOraEor

BgEcfStore  # 4*16      ; Interleaved zgora & zgeor to store background

;Current state of pattern
LineDotCnt # 4          ; Count down to restarting pattern
LineDotPatLSW # 4       ; Current state of pattern LSWord
LineDotPatMSW # 4       ;    "      "   "     "    MSWord

DotLineLength # 4       ; Dot Pattern repeat length as given in *FX163,242,n

BBCcompatibleECFs # 4   ; 0 => BBC compatible, 1 => native

SpAreaStart # 4         ; Start of sprite area
SpChooseName # 16       ; No comment says Richard
SpChoosePtr # 4

SWP_W # 1               ; Width & height of image to restore
SWP_H # 1
SWP_Callback # 1        ; Nonzero if palette update callback registered
SWP_Mutex # 1           ; Mutex to prevent re-entrancy
SWP_Restore # 1         ; Nonzero if restore needed in RestorePointer
SWP_Dirty # 1           ; Nonzero if need replot due to palette change
          # 2
SWP_Coords # 4          ; Coordinates of last plot
SWP_Pos # 4             ; Address to restore pixels to, 0 if not displayed
SWP_Under # 4           ; Pointer to copy of screen pixels from under the pointer
SWP_Palette # 3*4       ; Pointer colours converted to pixel values for current mode

TeletextOffset # 4      ; Offset to current teletext flash bank

TeletextCount # 4       ; Number of vsyncs till next teletext flash

WrchNbit # 4            ; Pointer to char code for current mode

CharWidth # 4           ; Width of a character in bytes (same as BytesPerChar except
                        ; in HiResTTX MODE 7, where characters are 16 pixels wide)
                        ; This could also be defined as (TCharSizeX<<Log2BPC)/8

TextOffset # 4          ; Byte offset into screen bank at which text window starts.
                        ; Keeps the text window centered when e.g. when mode 7 picks
                        ; a higher resolution mode than strictly necessary.

TTXFlags # 4            ; VDU 23,18 flags
TTXFlag_Suspend         * 1:SHL:0
TTXFlag_Conceal         * 1:SHL:1
TTXFlag_BlackEnable     * 1:SHL:2
TTXFlag_TransModeShift  * 3
TTXFlag_TransModeMask   * 3:SHL:TTXFlag_TransModeShift
                        ; bits 9-11 must be zero
TTXFlag_FgTransEOR      * 1:SHL:12
                        ; bits 13-15 must be zero
TTXFlag_BgTransEOR      * 1:SHL:16
                        ; bits 17-19 must be zero
TTXFlag_FgTransBIC      * 1:SHL:20
                        ; bits 21-23 must be zero
TTXFlag_BgTransBIC      * 1:SHL:24

BeepBlock # 8           ; OSWORD block for VDU 7

ScreenMemoryClaimed # 1 ; NZ => memory has been claimed or is unusable
ExternalFramestore # 1  ; NZ => using external framestore rather than screen memory DA

     AlignSpace

TTXDoubleCountsPtr # 4 ; Number of double height chars on each line
TTXMapPtr          # 4
TTXLineStartsPtr   # 4
TTXNewWorkspace    # 4 ; Temp variable to allow mode changes to fail gracefully if TTX workspace can't be allocated

 [ :DEF: ShowWS
 ! 0,"16 ":CC::STR:@@
 ]
     AlignSpace 16      ; Align workspace to 16 bytes

RAMMaskTb # 32*4        ; Copy of MaskTb for this mode (up to 32 words)

 [ :DEF: ShowWS
 ! 0,"16 ":CC::STR:@@
 ]
     AlignSpace 16      ; Align workspace to 16 bytes

VduOutputCurrentState # 0 ; values of R0-R3 to return from SwitchOutputToSprite
                        ; or Mask; next 4 must be in this order
SpriteMaskSelect # 4    ; value of R0 to be given to SWI OS_SpriteOp to set up
                        ; current state
VduSpriteArea # 4       ; Pointer to sprite area containing VDU output sprite
                        ; (0 if output is to screen)
VduSprite # 4           ; Pointer to VDU output sprite (0 if output to screen)

VduSaveAreaPtr # 4      ; Pointer to save area for VDU variables


 [ :DEF: ShowWS
 ! 0,"16,12 ":CC::STR:@@
 ]
    AlignSpace 16, 12   ; Make ClipBoxCoords a valid immediate,
                        ; with ClipBoxEnable immediately before it
ClipBoxInfo # 0
ClipBoxEnable # 4       ; 0 => clip box disabled, 1 => enabled

ClipBoxCoords # 0       ; Internal coords of modified area of screen
ClipBoxLCol # 4
ClipBoxBRow # 4
ClipBoxRCol # 4
ClipBoxTRow # 4

FgPattern       # 4*8   ; foreground pattern as defined by OS_SetColour
BgPattern       # 4*8   ; background pattern as defined by OS_SetColour

                # 3*4   ; SPARE (avoiding changes of exported addresses for now)

KernelModeSelector # 4  ; pointer to block in system heap where
                        ; current mode selector is copied

 [ :DEF: ShowWS
 ! 0,"16 ":CC::STR:@@
 ]
     AlignSpace 16      ; Align workspace to 16 bytes

TextExpand # 4*1024     ; Tim's massive text expansion table for whizzy WRCH
; TextPlain is now always hard against the end of TextExpand for this mode

TTXSoftFonts * TextExpand + 2*1024      ; Soft fonts in teletext mode

 [ :DEF: ShowWS
 ! 0,"64 ":CC::STR:@@
 ]
     AlignSpace 64      ; Align workspace to 64 bytes

; Some infrequently used buffers which can be overlaid

LargeCommon     # SpriteAreaCBsize + SpriteCBsize + MaxSpritePaletteSize ; the largest area

ScrLoaSpriteCB  * LargeCommon   ; (size = SpriteCBsize + MaxSpritePaletteSize)
        ASSERT ?LargeCommon >= SpriteCBsize + MaxSpritePaletteSize
ScrSavCommon    * LargeCommon   ; (size = SpriteAreaCBsize + SpriteCBsize
                                ;  + MaxSpritePaletteSize)
        ASSERT ?LargeCommon >= SpriteAreaCBsize + SpriteCBsize + MaxSpritePaletteSize

VIDCList3BaseSize * VIDCList3_ControlList
VIDCList3Size * (VIDCList3BaseSize + ControlList_InvalidReason*8 + 4) ; primary params, up to 16 video control params, terminator

TempModeSelector * LargeCommon  ; (size = ModeSelector_MaxSize + VIDCList3Size)
        ASSERT ?LargeCommon >= ModeSelector_MaxSize + VIDCList3Size
TempVIDCList * TempModeSelector+ModeSelector_MaxSize

FldQueueSize    * ScratchSpaceSize
FldQueueStart   * ScratchSpace

 [ :DEF: ShowWS
 ! 0,"64 ":CC::STR:@@
 ]
     AlignSpace 64      ; Align workspace to 64 bytes

Font # &700             ; 7 pages of (soft) font

SaveAreaSize * 12*1024-@@

VduSaveArea # SaveAreaSize      ; save area for switching output to sprites

VDWSSize # 0

                ASSERT  VDWSSize <= 12 * 1024

; IIC bus info block

               ^ 0
IICBus_Type    # 4 ; Bus type (HAL_IICType)
IICBus_Status  # 4 ; Bus status (HAL_IICMonitorTransfer)
IICBus_Device  # 4 ; Bus device (HAL_IICDevice)
IICBus_Size    # 0

; *****************************************************************************
;                 Space in the first 32K is allocated below
; *****************************************************************************
; Real workspace definition

; locations used during reset only. Not cleared by ClearWkspRAM, but
; cleared later (just before DEFHAN).

; Note that these are all relative to ZeroPage!

                ^       &80             ; steer clear of FIQ code
InitWsStart     #       0
InitIRQHandler  #       4               ; pointer to IRQ handler (LDR PC'ed from IRQ HW vector)
InitIRQWs       #       16              ; workspace for IRQ handler
InitUsedStart   #       4               ; start of used pages (L2PT etc) not to be cleared
InitUsedEnd     #       4               ; end of used pages
InitUsedBlock   #       4               ; current block in PhysRamTable
InitClearRamWs  #       10*4            ; preserve registers during ClearPhysRAM
InitDMABlock    #       8               ; block of DMAable memory extracted from PhysRamTable
InitDMAOffset   #       4               ; offset+8 into PhysRamTable where memory was taken
InitDMAEnd      #       4               ; current DMA alloc pos
                AlignSpace 32           ; because we clear 32 at a time
InitWsEnd       #       0

; Basic kernel space - defined locations for external modules

                       ^       &100
IRQ1V                  #       4       ; &100

ESC_Status             #       1       ; &104
        ASSERT  ESC_Status =  Legacy_ESC_Status
        ASSERT ?ESC_Status = ?Legacy_ESC_Status

LatchBSoftCopy         #       1       ; &105
        ASSERT  LatchBSoftCopy =  Legacy_LatchBSoftCopy
        ASSERT ?LatchBSoftCopy = ?Legacy_LatchBSoftCopy

IOCControlSoftCopy     #       1       ; &106

CannotReset            #       1       ; &107
        ASSERT  CannotReset =  Legacy_CannotReset
        ASSERT ?CannotReset = ?Legacy_CannotReset

IRQsema                #       4       ; &108
        ASSERT  IRQsema =  Legacy_IRQsema
        ASSERT ?IRQsema = ?Legacy_IRQsema

MetroGnome             #       4       ; &10C
        ASSERT  MetroGnome =  Legacy_MetroGnome
        ASSERT ?MetroGnome = ?Legacy_MetroGnome

MemorySpeed            #       4       ; &110

MEMC_CR_SoftCopy       #      4       ; &114
        ASSERT  MEMC_CR_SoftCopy =  Legacy_MEMC_CR_SoftCopy
        ASSERT ?MEMC_CR_SoftCopy = ?Legacy_MEMC_CR_SoftCopy

ResetIndirection        #      4       ; &118

; Now all internal definitions

; Up to here is initialized on reset

; Next come handler variables

MemLimit        #       4
UndHan          #       4
PAbHan          #       4
DAbHan          #       4
AdXHan          #       4

ErrHan          #       4
ErrBuf          #       4
ErrHan_ws       #       4

CallAd_ws       #       4     ; smart Rs ordering:
CallAd          #       4     ; can do LDMIA of r12, pc
CallBf          #       4

BrkAd_ws        #       4
BrkAd           #       4
BrkBf           #       4

EscHan_ws       #       4
EscHan          #       4

EvtHan_ws       #       4
EvtHan          #       4

; The next lot of workspace is in the space vacated by the small soft CAM map area
; (256 words) which is no longer adequate, so we can reuse it

JordanWS        #       0

Serv_SysChains          # 4          ;anchor for block handling 'system' service numbers, in range 1 to 255
Serv_UsrChains          # 4          ;anchor for block handling 'user' service numbers, > 255
Serv_AwkwardChain       # 4          ;anchor for chain handling non-compliant modules (no service table)
 [ :DEF: ShowWS
      ! 0, "Serv_SysChains        at ":CC::STR:(Serv_SysChains)
      ! 0, "Serv_UsrChains        at ":CC::STR:(Serv_UsrChains)
      ! 0, "Serv_AwkwardChain     at ":CC::STR:(Serv_AwkwardChain)
 ]

DAList          #       4       ; Pointer to first node on dynamic area list


                AlignSpace 16
AMBControl_ws   #       4       ; workspace anchor word for AMBControl
DynArea_ws      #       4       ; workspace anchor word for data structures to accelerate OS SWIs for dynamic areas
 [ :DEF: ShowWS
 ! 0, "AMBControl_ws         at ":CC::STR:(AMBControl_ws)
 ! 0, "DynArea_ws            at ":CC::STR:(DynArea_ws)
 ]

Oscli_CmdHashSum        # 4          ;for hashed command lookup
Oscli_CmdHashLists      # 4          ;anchor for hashed command lists structure
 [ :DEF: ShowWS
      ! 0, "Oscli_CmdHashSum      at ":CC::STR:(Oscli_CmdHashSum)
      ! 0, "Oscli_CmdHashLists    at ":CC::STR:(Oscli_CmdHashLists)
 ]


                AlignSpace 16   ; skipped bit must start on 16-byte boundary (ClearPhysRAM does 4 words at a time for skipped areas)
SkippedTables   #       0

PhysRamTable    #       0       ; Pairs of words (physaddr, size+flags)
                                ; indicating RAM present in machine
                                ; Unused entries have size of zero
VideoPhysAddr   #       4       ; Address of video RAM (in the case of DRAM-only machines,
VideoSizeFlags  #       4       ; this is actually a chunk out of DRAM)
DRAMPhysAddrA   #       4       ; Next the DRAM
DRAMSizeFlagsA  #       4
                #       8 * 16  ; Space for 17 DRAM banks + 1 VRAM bank total
PhysRamTableEnd #       0
DRAMPhysTableSize *     (PhysRamTableEnd-DRAMPhysAddrA) / 8

 [ :DEF: ShowWS
 ! 0, "VideoPhysAddr held at  ":CC::STR:(VideoPhysAddr)
 ]

L2PTUsed        #       4       ; Amount of memory used for L2PT
SoftCamMapSize  #       4       ; Amount of memory (in bytes) used for soft CAM map
                                ; (whole number of pages)

                AlignSpace
HAL_StartFlags  #       4
HAL_Descriptor  #       4
HAL_Workspace   #       4
HAL_WsSize      #       4

ICache_Info              #  0
ICache_NSets             #  4
ICache_Size              #  4
ICache_LineLen           #  1
ICache_Associativity     #  1

Cache_Type               #  1
Cache_Flags              #  1

DCache_Info              #  0
DCache_NSets             #  4
DCache_Size              #  4
DCache_LineLen           #  1
DCache_Associativity     #  1

ProcessorArch            #  1
ProcessorType            #  1   ; Processor type (handles 600 series onwards)

DCache_CleanBaseAddress  #  0   ; word used either for IndexBit or CleanBaseAddress
DCache_IndexBit          #  4
DCache_CleanNextAddress  #  0   ; word used either for IndexSegStart or CleanNextAddress
DCache_IndexSegStart     #  4
DCache_RangeThreshold    #  4
                AlignSpace
ProcessorFlags           #  4    ; Processor flags (IMB, Arch4 etc)
 [ :DEF: ShowWS
 ! 0, "ProcessorType  at  ":CC::STR:(ProcessorType)
 ! 0, "ProcessorFlags at  ":CC::STR:(ProcessorFlags)
 ]

                AlignSpace

MMU_PPLTrans             #  4
MMU_PCBTrans             #  4
MMU_PPLAccess            #  4

Proc_Cache_CleanInvalidateAll     #       4
Proc_Cache_CleanInvalidateRange   #       4
Proc_Cache_CleanAll               #       4
Proc_Cache_CleanRange             #       4
Proc_Cache_InvalidateAll          #       4
Proc_Cache_InvalidateRange        #       4
Proc_Cache_RangeThreshold         #       4
Proc_Cache_Examine                #       4
Proc_ICache_InvalidateAll         #       4
Proc_ICache_InvalidateRange       #       4
Proc_TLB_InvalidateAll            #       4
Proc_TLB_InvalidateEntry          #       4
Proc_DSB_ReadWrite                #       4
Proc_DSB_Write                    #       4
Proc_DSB_Read                     #       4
Proc_DMB_ReadWrite                #       4
Proc_DMB_Write                    #       4
Proc_DMB_Read                     #       4
Proc_IMB_Full                     #       4
Proc_IMB_Range                    #       4
Proc_IMB_List                     #       4
Proc_MMU_Changing                 #       4
Proc_MMU_ChangingEntry            #       4
Proc_MMU_ChangingUncached         #       4
Proc_MMU_ChangingUncachedEntry    #       4
Proc_MMU_ChangingEntries          #       4
Proc_MMU_ChangingUncachedEntries  #       4

Cache_Lx_Info                     #       4       ; Cache level ID register
Cache_Lx_MaxLevel                 *       2       ; Current machines have max of 2 cache levels
Cache_Lx_DTable                   #       4*Cache_Lx_MaxLevel ; Data/unified cache layout for all supported levels
Cache_Lx_ITable                   #       4*Cache_Lx_MaxLevel ; Instruction cache layout for all supported levels
Cache_HALDevice                   #       4       ; Pointer to any HAL cache device we're using


IOAllocPtr      #       4               ; current lowpoint of mapped I/O space (also upper limit on DAs)
IOAllocLimit    #       4               ; current lowest allowed I/O space (DA creation may move this up)


  [ :DEF: ShowWS
        ! 0, "Free space before DebuggerSpace = ":CC::STR:(&300-@@)
 ]

        ASSERT  @@ <= &300
                        #       (&300-@@)
 [ :LNOT: HiProcVecs
; Note that this is currently located within the skipped region, even though it
; doesn't need to be. It was just an easy way of adding the IIC bus info to the
; region. The debugger will initialise DebuggerSpace on startup, so it doesn't
; matter that it doesn't get cleared during the main RAM clear.
DebuggerSpace           #       16*8    ; Debugger module needs some zero page
DebuggerSpace_Size      *       ?DebuggerSpace

        ASSERT  DebuggerSpace =  Legacy_DebuggerSpace
        ASSERT ?DebuggerSpace = ?Legacy_DebuggerSpace
 |
DebuggerSpace           *       &2000   ; Debugger gets a page all to itself!
DebuggerSpace_Size      *       &1000

   [ CompatibilityPage
CompatibilityPageEnabled #      1       ; 0 or 1 as appropriate
   ]
                AlignSpace
 ]

IICBus_Count       *    5 ; 5 buses is enough for all current machines
IICBus_Base        #    IICBus_Size*IICBus_Count

PageTable_PageFlags #   4               ; Page flags used for page tables. L2PT uses this directly, L1PT adds in PageFlags_Unavailable.

                AlignSpace 16   ; skipped bit must end on 16-byte boundary (ClearPhysRAM does 4 words at a time for skipped areas)
SkippedTablesEnd #      0

; NVRAM support

NVRamSize          #    1               ; Size of NVRam (E2ROM & CMOS) fitted in 256byte units
NVRamBase          #    1               ; Base of NVRam
NVRamSpeed         #    1               ; Clock hold time in 0.5us units
NVRamPageSize      #    1               ; Page size for writing (log2)
NVRamWriteSize     #    1               ; Size of writable region (256byte units)

                   AlignSpace


AppSpaceDANode     #    DANode_NodeSize ; Dummy area node for application space (not on list)
FreePoolDANode     #    DANode_NodeSize ; Area node for free pool
SysHeapDANode      #    DANode_NodeSize ; Area node for system heap
CDASemaphore       #    4               ; Semaphore for OS_ChangeDynamicArea - non-zero => routine threaded
MMUControlSoftCopy #    4               ; Soft copy of ARM control register
IRQMax             #    4               ; from HAL_IRQMax
DeviceCount     #       4       ; size of our table of devices in the system heap
DeviceTable     #       4       ; pointer to table

ProcVec_Start           #       0       ; Start of processor vector table
ProcVec_Branch0         #       4       ; Branch through zero
ProcVec_UndInst         #       4       ; Undefined instruction vector
ProcVec_SWI             #       4       ; SWI vector
ProcVec_PrefAb          #       4       ; Prefetch abort vector
ProcVec_DataAb          #       4       ; Data abort vector
ProcVec_AddrEx          #       4       ; not used (was Address exception vector on 26-bit-only ARMs)
ProcVec_IRQ             #       4       ; IRQ vector
ProcVec_End             #       0

ProcVecPreVeneersSize   *       4*4     ; Space for preveneers for loading handler addresses from 0 page.
ProcVecPreVeneers       #       ProcVecPreVeneersSize

AplWorkSize * AppSpaceDANode + DANode_Size

ExtendedROMFooter # 4 ; Pointer to the extended ROM footer structure. 0 if not initialised, -1 if not found.

CPUFeatures # 2*4

 [ :DEF: ShowWS
        ! 0, "Free space after EnvString = ":CC::STR:(&500-@@)
 ]

        ASSERT  @@ <= &500               ; a convenient address to remember
                #       (&500-@@)

CamMapCorruptDebugBlock #       &40     ; somewhere to dump registers in case of emergency

 [ :DEF: ShowWS
        ! 0, "Free space after CamMap debug block = ":CC::STR:((JordanWS+256*4)-@@)
 ]

        ASSERT  @@ <= JordanWS+256*4
                #       (JordanWS+256*4-@@)  ; pad out to original size

CamEntriesPointer #     4       ; points to where CAM soft copy is
                                ; (CamEntries for machines up to 8MBytes,
                                ; CamEntriesForBigMachines for larger machines)

MaxCamEntry     #       4       ; maximum index into the cam map, ie
                                ; 511 for 16MByte machines, 383 for 12MBytes
                                ; 255 for 8MBytes, otherwise 127

RAMLIMIT        #       4

ROMPhysAddr     #       4

HiServ_ws       #       4
HiServ          #       4
SExitA          #       4
SExitA_ws       #       4
UpCallHan_ws    #       4
UpCallHan       #       4

ROMModuleChain  #       4               ; pointer to head of ROM module chain

; now a section that it's handy to have in simply loadable places

 [ :DEF: ShowWS
 ! 0,"16 ":CC::STR:@@
 ]
             AlignSpace 16

KeyWorkSpaceSize   *  &200
KeyWorkSpace       #  KeyWorkSpaceSize
 [ :DEF: ShowWS
      ! 0, "KeyWorkSpace          at ":CC::STR:(KeyWorkSpace)
 ]

; The following were reordered on 26-Jul-91. Old ordering was:
; GeneralMOSBuffer
; ModuleSWI_HashTab
; Module_List
; Curr_Active_Object
; VecPtrTab
; ExceptionDump

; SWI hash table moved to OldIRQ1Vspace on 12-Nov-97, for Ursula (wider hashing)
;
; !!!! Free Space
;
  [ ChocolateSysHeap
ChocolateBlockArrays  #  0
ChocolateCBBlocks     #  4            ; -> array of quick access blocks for Callback
ChocolateSVBlocks     #  4            ; -> array of quick access blocks for software vectors
ChocolateTKBlocks     #  4            ; -> array of quick access blocks for tickers
ChocolateMRBlocks     #  4            ; -> array of blocks for ROM module nodes (reduces no. of individual blocks in heap)
ChocolateMABlocks     #  4            ; -> array of blocks for active module nodes (reduces no. of individual blocks in heap)
ChocolateMSBlocks     #  4            ; -> array of blocks for module SWI hash nodes (reduces no. of individual blocks in heap)
 [ :DEF: ShowWS
      ! 0, "ChocolateCBBlocks     at ":CC::STR:(ChocolateCBBlocks)
      ! 0, "ChocolateSVBlocks     at ":CC::STR:(ChocolateSVBlocks)
      ! 0, "ChocolateTKBlocks     at ":CC::STR:(ChocolateTKBlocks)
      ! 0, "ChocolateMRBlocks     at ":CC::STR:(ChocolateMRBlocks)
      ! 0, "ChocolateMABlocks     at ":CC::STR:(ChocolateMABlocks)
      ! 0, "ChocolateMSBlocks     at ":CC::STR:(ChocolateMSBlocks)
 ]

; !!!! Free Space (40 bytes)
OldSWIHashspace    #  10*4
  |
; !!!! Free Space (64 bytes)
OldSWIHashspace    #  16*4
  ]

;
;was:
;ModuleSHT_Entries  *  16
;ModuleSWI_HashTab  #  4*ModuleSHT_Entries

Module_List        #  4
 [ :DEF: ShowWS
      ! 0, "Module_List           at ":CC::STR:(Module_List)
 ]

Curr_Active_Object #  4

; Vector Claim & Release tables etc

VecPtrTab          #  NVECTORS * 4

ExceptionDump      #  4

 # 68                       ; spare

 [ :DEF: ShowWS
 ! 0,"16 ":CC::STR:@@
 ]
            AlignSpace  16 ; Ensures we can MOV rn, #OsbyteVars if <=&1000

OsbyteVars      #       OSBYTEVarSize
 ASSERT OsbyteVars < &10000 ; Must keep in first 64K so address can be read by
                            ; (and stored in) OS_Bytes &A6,&A7. SKS

; These must be in first 4K
NBuffers        *       10
BuffInPtrs      #       4 * NBuffers
BuffOutPtrs     #       4 * NBuffers

VariableList    #       4

; Oscli stuff
OscliCBtopUID   #       4
OscliCBbotUID   #       4
OscliCBcurrend  #       4

ReturnCode      #       4
RCLimit         #       4

SpriteSize      #       4       ; saved on startup for Sprite code

TickNodeChain   #       4

PIRQ_Chain      #       4
PFIQasIRQ_Chain #       4

; Workspace

EnvTime            #    5

RedirectInHandle   #    1
        ASSERT  RedirectInHandle =  Legacy_RedirectInHandle
        ASSERT ?RedirectInHandle = ?Legacy_RedirectInHandle

RedirectOutHandle  #    1
        ASSERT  RedirectOutHandle =  Legacy_RedirectOutHandle
        ASSERT ?RedirectOutHandle = ?Legacy_RedirectOutHandle

MOShasFIQ          #    1
FIQclaim_interlock #    1
CallBack_Flag      #    1
IRQ_CallBack_Flag * CallBack_Flag
MonitorLeadType    #    1       ; some function of the monitor lead inputs, as yet undetermined
MentionCMOSReset   #    1       ; non zero reports CMOS resets prior to the start banner

                AlignSpace

DUMPER          #       17 * 4  ; now 17 words for 32-bit

                #       4       ; PxxxIRQ_Chain used to be here
Page_Size       #       4
CMOSRAMCache    #       256

; Was Free space (752 bytes) left by old IRQ despatch (new IRQ despatch moved as it required more space).
; Re-used for various purposes on 12-Nov-97, for Ursula
;
      ASSERT @@ = &C34                            ;if fails, may need to rearrange padding to sort hash table alignment
;
ModuleSHT_Entries  *  128
ModuleSHT_Padding0 #  12                         ;spare, so that SWI hashtable is aligned for easy immediate address load
ModuleSWI_HashTab  #  4*ModuleSHT_Entries
 [ :DEF: ShowWS
      ! 0, "ModuleSWI_HashTab     at ":CC::STR:(ModuleSWI_HashTab)
 ]
;
SysVars_StickyPointers # (10+1)*4                ;used if ChocolateSysVars is TRUE (1 dummy pointer for 0 size)
 [ :DEF: ShowWS
      ! 0, "SysVars_StickyPtrs    at ":CC::STR:(SysVars_StickyPointers)
 ]
;
Abort32_dumparea   # 6*4          ;info for OS_ReadSysInfo 7 - 32-bit PSR, fault address, 32-bit PC (room for two copies)
 [ :DEF: ShowWS
      ! 0, "Abort32_dumparea      at ":CC::STR:(Abort32_dumparea)
 ]
;
Help_guard         # 4            ;for *help, guard against foreground re-entrancy (multiple taskwindows)
Help_msgdescr      # 4*4          ;for *help, 4 words MessageTrans descriptor
 [ :DEF: ShowWS
      ! 0, "Help_guard            at ":CC::STR:(Help_guard)
 ]
;
PCI_status         # 4            ;bit 0 = 1 if PCI exists or 0 if PCI does not exist, bits 1..31 reserved (0)
 [ :DEF: ShowWS
      ! 0, "PCI_status            at ":CC::STR:(PCI_status)
 ]
IOMD_NoInterrupt          # 4     ;no. of irq devices for extant IOMD
IOMD_DefaultIRQ1Vcode     # 4     ;default irq code start address (ROM) for extant IOMD
IOMD_DefaultIRQ1Vcode_end # 4     ;default irq code end address (ROM)
IOMD_Devices              # 4     ;default irq devices table address (ROM)
 [ :DEF: ShowWS
      ! 0, "IOMD_NoInterrupt      at ":CC::STR:(IOMD_NoInterrupt)
 ]
;
  [ mjsSysHeapNodesTrace
mjsSHNodesTrace_ws # 0
mjsSHNT_hcl_total  # 4    ;total calls to ClaimSysHeapNode
mjsSHNT_hfr_total  # 4    ;total calls to FreeSysHeapNode
mjsSHNT_hop_total  # 4    ;total calls to DoSysHeapOpWithExpansion
mjsSHNT_ohc_total  # 4    ;total calls to OS_Heap for SysHeap claim
mjsSHNT_ohf_total  # 4    ;total calls to OS_Heap for SysHeap free
mjsSHNT_ohx_total  # 4    ;total calls to OS_Heap for SysHeap expand or shrink
mjsSHNT_vcs_total  # 4    ;total SysVar ClaimVNode calls that picked up a sticky node
mjsSHNT_vch_total  # 4    ;total SysVar ClaimVNode calls that went to the heap for a node
mjsSHNT_vxs_total  # 4    ;total SysVar ExpandOrShrinkVNode calls that tried to do sticky change
mjsSHNT_vxh_total  # 4    ;total SysVar ExpandOrShrinkVNode calls that went to the heap
mjsSHNT_vfs_total  # 4    ;total SysVar FreeVNode calls that stuck
mjsSHNT_vfh_total  # 4    ;total SysVar FreeVNode calls that dropped a node to the heap
 [ :DEF: ShowWS
      ! 0, ""
      ! 0, "**WARNING** compiling in code to trace some SysHeap node statistics (mjsSysHeapNodesTrace TRUE)"
      ! 0, ""
      ! 0, "mjsSHNodesTrace_ws    at ":CC::STR:(mjsSHNodesTrace_ws)
 ]
ModuleSHT_Padding1 #  752-12-4*ModuleSHT_Entries-11*4-6*4-5*4-4-4*4-12*4 ;spare
  |
ModuleSHT_Padding1 #  752-12-4*ModuleSHT_Entries-11*4-6*4-5*4-4-4*4      ;spare
  ]
;
      ASSERT @@ = &C34 + 752
;
;was:
;OldIRQ1Vspace       # 752


CallBack_Vector   #  4

; interruptible heap manager workspace

HeapSavedReg_R0     # 4
HeapSavedReg_R1     # 4
HeapSavedReg_R2     # 4
HeapSavedReg_R3     # 4
HeapSavedReg_R4     # 4
HeapSavedReg_R13    # 4
HeapReturnedReg_R0  # 4
HeapReturnedReg_R1  # 4
HeapReturnedReg_R2  # 4
HeapReturnedReg_R3  # 4
HeapReturnedReg_R4  # 4
HeapReturnedReg_R13 # 4
HeapReturnedReg_PSR # 4                 ; also acts as interlock

PrinterBufferAddr   #  4                ; holds address of printer buffer
PrinterBufferSize   #  4                ; size of printer buffer - not to be confused with PrintBuffSize
                                        ; which is the (constant) default size for the MOS's smallish buffer
RawMachineID        #  8                ; 64 bits for unique machine ID
KernelMessagesBlock #  20               ; 5 Words for messagetrans message block.
ErrorSemaphore      #  1                ; Error semaphore to avoid looping on error translation.
PortableFlags       #  1                ;
PowerSave * &80                         ; Gets set in PortableFlags when we've switched to slow speed

        AlignSpace

MOSConvertBuffer    #  12               ; Enough romm for 8 hex digits.
AbortIndirection    #  4                ; Pointer to list of addresses and trap routines
PreVeneerRegDump    #  17*4             ; room for r0-r15, spsr

 [ CacheCommonErrors
CachedErrorBlocks   #  4                ; pointer to sysheap node holding the error block cache
 ]

 [ :DEF: ShowWS
 ! 0, "low space free ":CC::STR:(&FE8-@@)
 ]
 ASSERT @@ < &FE8

; Words for old tools of assorted varieties
; Don't move the following as their positions are assumed by other modules

                        ^       &FE8
CLibCounter             #       1               ; Counter for Shared C Library tmpnam function
        ASSERT  CLibCounter =  Legacy_CLibCounter
        ASSERT ?CLibCounter = ?Legacy_CLibCounter

        AlignSpace

; ECN 17-Feb-92
; Added RISCOSLibWord and CLibWord. The ROM RISCOSLib and CLib must continue
; to work even when they are killed since ROM apps are hard linked to the
; ROM libraries. They cannot use the private word since the block pointed
; to by this will be freed.
RISCOSLibWord           #       4
        ASSERT  RISCOSLibWord =  Legacy_RISCOSLibWord
        ASSERT ?RISCOSLibWord = ?Legacy_RISCOSLibWord

CLibWord                #       4
        ASSERT  CLibWord =  Legacy_CLibWord
        ASSERT ?CLibWord = ?Legacy_CLibWord

FPEAnchor               #       4
        ASSERT  FPEAnchor =  Legacy_FPEAnchor
        ASSERT ?FPEAnchor = ?Legacy_FPEAnchor

DomainId                #       4       ; SKS added for domain identification
        ASSERT  DomainId =  Legacy_DomainId
        ASSERT ?DomainId = ?Legacy_DomainId

Modula2_Private         #       4       ; MICK has FFC and uses it it in USR mode

VduDriverWorkSpace      #       VDWSSize
        ASSERT  VduDriverWorkSpace =  Legacy_VduDriverWorkSpace
        ASSERT ?VduDriverWorkSpace = ?Legacy_VduDriverWorkSpace

 ASSERT (VduDriverWorkSpace :AND: 63) = 0 ; For Tim (VDU5)


 [ :DEF: ShowWS
 ! 0, "high space free ":CC::STR:(&4000-@@)
 ]

                        ^       &4000
ScratchSpaceSize        *       &4000

Export_ScratchSpace            #       ScratchSpaceSize
        ASSERT  Export_ScratchSpace =  ScratchSpace
        ASSERT ?Export_ScratchSpace = ?ScratchSpace

 ASSERT @@ <= &8000 ; Start of apl

; *****************************************************************************
; Users of ScratchSpace declare yourself here:

; NRaine: Filling a polygon uses ScratchSpace to flatten the path

; DSeal: Draw module uses ScratchSpace on fill operations (this supercedes
;   NRaine's declaration above).

; SKS: HeapSort with (r1 & 0x80000000) & ~(r1 & 0x20000000) & (r5 <= 16K)
;      uses ScratchSpace as a temp slot for data shuffling after sorting

; TMD: Flood fill uses ScratchSpace for the flood queue.

; Tidying the RMA uses ScratchSpace while all modules are dead

; LVR: ADFS uses scratch space to format floppies on 1772 based machines

; DDV: ColourTrans uses scratch space to build palette tables when in
;      ColourTrans_SelecTable/RetrunColourNumber and also whilst generating
;      stipple pattterns.

                        ^       0
GSNameBuff              #       &100
GS_Stack                #       &200
GS_StackPtr_Lim         *       &200 / 4        ; Number of words in stack.
GS_StackPtr             #       4
GSVarWSpace_Size        #       0

                        ^      @@ + ScratchSpace

; Pointers for SubstituteArgs: no external calls.
; Ensure these don't overlap FileSwitch's buffers below!

MacExStartPtrs          #       44
MacExEndPtrs            #       44

; OS_CLI has a buffer for alias expansion: ReadVarVal and SubstituteArgs
;    are called while the buffer is held. Also used for module prefixes:
;    Module called twice in this case.

OldAliasExpansionBuffer #       100     ;spare, mjs: shouldn't this have been &100 ??!??


; EvaluateExpression space. Calls ReadUnsigned, BinaryToDecimal and ReadVarVal.

ExprWSpace              *       @@

                        ^       0, R12
exprBracDif             #       2       ; keep exprSTRACC aligned
tos_op                  #       2       ; 1 byte for use as STRACC-1
ExprSVCstack            #       4

ExprStackLimit          *       @@ - exprBracDif + ExprWSpace + &100   ;keep 256 buffer zone for stack overflow
ExprStackStart          *       ScratchSpace + ScratchSpaceSize


; *****************************************************************************
; ***            Cursor, Sound DMA, SWI, and OSCLI workspace.               ***
; *****************************************************************************

TopOfDMAWorkSpace       *       CursorChunkAddress + 32*1024

                        ^       TopOfDMAWorkSpace ; Note we will be going down

; Sound

SoundWorkSpaceSize      *       &1000

Export_SoundDMABufferSize  *    &1000
        ASSERT  Export_SoundDMABufferSize =  SoundDMABufferSize

SoundEvtSize            *       &1000

Export_SoundDMABuffers         |#|     SoundDMABufferSize * 2
        ASSERT  Export_SoundDMABuffers =  SoundDMABuffers
        ASSERT ?Export_SoundDMABuffers = ?SoundDMABuffers

Export_SoundWorkSpace          |#|     SoundWorkSpaceSize + SoundEvtSize
        ASSERT  Export_SoundWorkSpace =  SoundWorkSpace
        ASSERT ?Export_SoundWorkSpace = ?SoundWorkSpace

; Cursor
; mjs Sep 2000, Kernel/HAL split
; Note that cursor data memory is expected to be uncacheable, since HAL may use it
; directly for h/w DMA. This may not be true since RO 3.7, but should be sorted
; eventually for next generation RO
;
; Currently (Jan 2013) only the sound DMA buffers are mapped in uncacheable.
; This means CursorData is mapped in cacheable, despite the OS treating it as
; uncacheable.

CursorDataSize          *       &600            ; four defined shapes, plus 2 holding shapes
CursorData              |#|     CursorDataSize
CursorSoundRAM          *       CursorData

SPARE_oldCursorSpace    |#|     &200            ; padding to avoid changing exported addresses for now

; SWI despatcher

BranchToSWIExit         |#|     4

SvcTable                |#|     &400

                        GBLA    SWIDespatch_Size
SWIDespatch_Size        SETA    38*4
 [ SupportARMT
SWIDespatch_Size        SETA    SWIDespatch_Size + 2*4
 ]
 [ ZeroPage <> 0
SWIDespatch_Size        SETA    SWIDespatch_Size + 4
 ]
 [ CheckErrorBlocks
SWIDespatch_Size        SETA    SWIDespatch_Size + 4
 ]

SWIDespatch             |#|     SWIDespatch_Size


; Buffers

KeyBuffSize             *       &100
RS423InBuffSize         *       &100
RS423OutBuffSize        *       &C0
PrintBuffSize           *       &400
Sound0BuffSize          *       4
Sound1BuffSize          *       4
Sound2BuffSize          *       4
Sound3BuffSize          *       4
SpeechBuffSize          *       4
MouseBuffSize           *       &40
KeyBuff                 |#|     KeyBuffSize
RS423InBuff             |#|     RS423InBuffSize
RS423OutBuff            |#|     RS423OutBuffSize
PrintBuff               |#|     PrintBuffSize
Sound0Buff              |#|     Sound0BuffSize
Sound1Buff              |#|     Sound1BuffSize
Sound2Buff              |#|     Sound2BuffSize
Sound3Buff              |#|     Sound3BuffSize
SpeechBuff              |#|     SpeechBuffSize
MouseBuff               |#|     MouseBuffSize

; IRQ despatch

MaxInterrupts           *       256     ; 256 needed by SMP i.MX6 quad. Increase in future if necessary.
DefIRQ1Vspace           *       12*MaxInterrupts+128

DefaultIRQ1V            |#|     DefIRQ1Vspace

 [ :DEF: ShowWS
 ! 0, "CursorChunkAddress free ":CC::STR:(@@-CursorChunkAddress)
 ]

 ASSERT @@ >= CursorChunkAddress

; *****************************************************************************
;                        High system workspace
; *****************************************************************************

                ^       SVCStackAddress

                       #       SVCStackSize    ; svcstk size. Overflow will give abort
SVCSTK                 #       0

SysHeapStart           *       SysHeapAddress


; *****************************************************************************

    ASSERT            LongCLISize >= 256+4     ;minimum size of GeneralMOSBuffer

;Kernel buffers area

                      ^  KbuffsBaseAddress

; GeneralMOSBuffer: re-use with caution!
; Here's just some of the users:
; user                  use(s)
; default error handler error buffer (must be 246+4 bytes big)
; *If                   expression to be evaluated to control the *If
;                       Command line to be submited on the expression
;                         evaluating to non-zero (the THEN clause).
GeneralMOSBuffer      #  LongCLISize

EnvString             #  LongCLISize

AliasExpansionBuffer  #  LongCLISize
ArgumentBuffer        *  AliasExpansionBuffer

ExprBuff              #  LongCLISize
exprSTRACC            #  LongCLISize

OscliBuffSize         *  LongCLISize
OscliNoBuffs          *  16
RedirectBuff          #  OscliBuffSize
OscliCircBuffStart    #  OscliBuffSize * OscliNoBuffs
OscliCircBuffLimit    #  0

GSVarWSpace           #  GSVarWSpace_Size

SysVarWorkSpace	      #  40             ; used by the sys$* variables for reading the current time into

ROMBuildDate          #  128
 [ UseNewFX0Error
NewFX0Error           #  64
 ]

HeapBackgroundError   #  256 ; For storing errors generated in the background by the forced completion of a foreground heap op

KbuffsEnd             #  0
KbuffsSize            *  KbuffsEnd - KbuffsBaseAddress  ;size of Kernel buffers area

    ASSERT            ((KbuffsSize + &FFF) :AND: &FFFFF000) <= KbuffsMaxSize

      ! 0, "Kbuffs                at ":CC::STR:(KbuffsBaseAddress)
      ! 0, "Kbuffs Size           is ":CC::STR:(KbuffsSize)

    [ {FALSE}
      ! 0, "GeneralMOSBuffer      at ":CC::STR:(GeneralMOSBuffer)
      ! 0, "EnvString             at ":CC::STR:(EnvString)
      ! 0, "AliasExpansionBuffer  at ":CC::STR:(AliasExpansionBuffer)
      ! 0, "ArgumentBuffer        at ":CC::STR:(ArgumentBuffer)
      ! 0, "ExprBuff              at ":CC::STR:(ExprBuff)
      ! 0, "exprSTRACC            at ":CC::STR:(exprSTRACC)
      ! 0, "RedirectBuff          at ":CC::STR:(RedirectBuff)
      ! 0, "OscliCircBuffStart    at ":CC::STR:(OscliCircBuffStart)
    ]


        OPT     OldOpt
        END
@


4.30
log
@Evict ECFIndex and PalIndex from VDU workspace
Detail:
  ECFIndex and PalIndex claim to be mode variables, but it's impossible for extension modes to specify their values.
  Since they're easy to calculate from the ModeFlags and Log2BPP values, drop them from the mode workspace (+ table of builtin modes) and calculate them on the fly instead.
  File changes:
  - hdr/KernelWS - Drop ECFIndex & PalIndex from workspace
  - s/vdu/vdumodes - Adjust workspace definition, drop ECFIndex & PalIndex values from VWSTAB
  - s/vdu/vdudriver - Remove now-redundant copy loop from ModeChangeSub. Remove code from GenerateModeSelectorVars that sets up the ECFIndex & PalIndex values on the stack
  - s/vdu/vdugrafl - Adjust copy loop in SwitchOutputToSprite/Mask
  - s/vdu/vdupalette, s/vdu/vdupalxx - Add GetPalIndex routine to generate PalIndex on the fly. Drop the obsolete 16bpp palette/gamma table and shuffle the other entries to simplify GetPalIndex a bit.
  - s/vdu/vduplot - Add GetECFIndex routine to generate ECFIndex on the fly. Also, fix things so that mode 0 isn't the only rectangular-pixel mode which uses the special rectangular-pixel ECF patterns (index 0 vs. index 4). Fiddle with ExportedHLine a bit to avoid an out-of-range ADR.
  - s/NewReset - Fix UAL warning for MOV R0, AppSpaceStart. Adjust memset to not assume 512KB is the correct amount
Admin:
  Tested on Raspberry Pi 3


Version 6.11. Tagged as 'Kernel-6_11'
@
text
@d961 7
a967 2
TempModeSelector * LargeCommon  ; (size = ModeSelector_MaxSize)
        ASSERT ?LargeCommon >= ModeSelector_MaxSize
@


4.29
log
@Merge SMP branch to trunk
Detail:
  Since the current SMP changes are fairly minor, and the trunk is seeing most development, from a maintenance perspective it makes sense to merge the changes to trunk. This will also make sure they get some wider testing ready for when the next round of SMP development takes place.
  Changes:
  - Docs/SMP - New docs folder describing SMP-related changes to the HAL and interrupt handling. Some of the IRQ changes can also be taken advantage of by single-core devices, since it introduces a way to describe which interrupt sources can be routed to IRQ & FIQ
  - Makefile, hdr/DBellDevice, hdr/HALDevice - New HAL device for an inter-processor software-generated interrupt source ("doorbell")
  - hdr/HALEntries - Reuse the unused matrix keyboard & touchscreen HAL entry points for the new IRQ handling & SMP-related HAL calls
  - hdr/KernelWS - Bump up MaxInterrupts
  - hdr/OSMem, s/MemInfo - Introduce OS_Memory 19, to allow for DMA to/from cacheable memory without actually altering the cacheability of the pages (which can be even more tricky in SMP systems than it is in uniprocessor systems)
  - hdr/Options - Introduce SMP build switch. Currently this controls whether the ARMops will operate in "SMP-friendly" mode or not (when running on MP processors)
  - s/ARMops, s/MemMap2 - Introduce the ARMv7MP ARMop implementation. Simplify DCache_LineLen / ICache_LineLen handling for WB_CR7_Lx so that it's the plain value rather than log2(n)-2
  - s/ExtraSWIs - If ARMops are in SMP-friendly mode, global OS_SynchroniseCodeAreas now only syncs application space and the RMA. This is because there is no trivial MP-safe global IMB operation available. This will also make global OS_SynchroniseCodeAreas significantly slower, but the documentation has always warned against performing a global IMB for just that reason, so code that suffers performance penalties should really try and switch to a ranged IMB.
  - s/NewIRQs - Update some comments regarding IRQ handler entry/exit conditions
Admin:
  Untested


Version 6.09. Tagged as 'Kernel-6_09'
@
text
@a544 2
; End of word mode variables

a563 2
ECFIndex # 4    ; Index into default ECF tables

d567 1
a567 1
PalIndex # 4    ; Index into palette tables (0,1,2,3)
d569 1
a569 1
; End of table-initialised workspace
@


4.28
log
@Disable error block validity checks
Detail:
  The error block checks introduced in Kernel-5_35-4_79_2_313 are generating a few too many false positives and edge cases, so take the safe option of just disabling them rather than trying to tweak the rules further. Error pointers will still be checked, but the content of the error blocks will not.
  hdr/Options - Add CheckErrorBlocks switch so we can easily turn the code back on again in the future if necessary
  s/Kernel - Switch out all the code relating to error number checks, except for the dummy load of the first word of the error block, since that's still useful as a pointer validity check
  hdr/KernelWS - Revise SWIDespatch_Size definition so it's easier for it to cope with the various factors which may affect the despatcher size
Admin:
  Tested on PandaBoard
  Relevant discussion:
  https://www.riscosopen.org/forum/forums/11/topics/11133


Version 6.04. Tagged as 'Kernel-6_04'
@
text
@d1765 1
a1765 1
MaxInterrupts           *       192     ; 192 needed by OMAP5. Increase in future if necessary.
@


4.27
log
@Increase number of vectors supported by the kernel to 96.

Version 6.03. Tagged as 'Kernel-6_03'
@
text
@d1725 2
d1728 1
a1728 7
   [ ZeroPage = 0
SWIDespatch_Size        *       41*4
   |
SWIDespatch_Size        *       42*4
   ]
 |
SWIDespatch_Size        *       39*4    ; can save 2 instructions if no Thumb
d1730 7
@


4.26
log
@Tweak handling of zero page compatibility page
Detail:
  s/MemInfo, hdr/KernelWS - Rather than peeking L2PT to determine if the compatibility page is enabled, use a workspace var to track its state. This ensures we won't get confused if other software decides to map something of its own to &0.
  s/NewReset - Ensure the CompatibilityPageEnabled flag is initialised correctly
Admin:
  Tested in Iyonix ROM softload


Version 5.90. Tagged as 'Kernel-5_90'
@
text
@d1396 1
a1396 1
OldGeneralMOSBuffer # 256+4      ;spare
@


4.25
log
@Change module initialisation to be a two pass scheme
Detail:
  To make it easier to support arbitrary complexity keyboard controllers (eg. USB via DWCDriver on the Pi) have the kernel do the early keyboard recovery key press detection instead of the HAL.
  During the first pass those modules used for reading the keyboard are started, ignoring the CMOS frugal bits.
  The keyboard is then scanned for 3s, during which time the RAM is cleared (unless the HAL indicated it has already been done).
  During the second pass the remaining modules are started respecting the CMOS frugal bits. Any which were already started in the first pass are inserted into the new chain, so the keyboard is reset once and only once.

  Boot times, with a 300cs key scan time in NewReset.
  Risc PC with 160MB RAM (128+32+0).
  Times from turning on power to initial "beep", using a stopwatch.
                RISC OS 3.70 RISC OS 5.22 This OS
  ARM610        12.5         10.4         10.3
  ARM710        11.8         10.2         9.7
  StrongARM 233 11.1         9.5          8.4

  In NewReset.s:
  Remove old KbdScan code (leave Reset_IRQ_Handler for IIC only)
  If HAL_KbdScanDependencies returns a null string then present KbdDone flag and skip to full init.
  A few vestiges of soft resets removed.
  Do RAM clear when waiting for INKEY (being careful not to trash the running modules...).
  Clearing just the freepool on a 2GB Titanium cleared 7EFD6 pages (99.2%).

  In ModHand.s:
  2nd pass need to sneaky renumber the nodes (so *ROMModules is in the right order, frugal bits line up) without resetting the chain

  In HAL.s:
  Change ClearPhysRAM to ClearWkspRAM, such that it only clears the kernel workspace rather than all RAM. The bulk of the RAM is cleared during the keyboard scan by new function ClearFreePoolSection.
  Add a variant of Init_MapInRAM which clears the mapped in RAM too (as these very early claims will not be in the free pool when the RAM is cleared later).
  Remove HAL keyboard scan setup & IRQ handler.
  Fix bug in HALDebugHexTX2, the input value needs pre-shifting by 16b before continuing.

  In GetAll.s, PMF/osbyte.s:
  Use Hdr:Countries and Hdr:OsBytes for constants.

  In PMF/key.s, PMF/osinit.s:
  Relocate the key post init from PostInit to KeyPostInit.
  Changed PostInit to not tail call KeyPostInit so they can be called independently.

  In hdr/KernelWs:
  Improve comments, add InitWsStart label to refer to.

  In hdr/HALEntries:
  Add HAL_KbdScanDependencies.
  Delete KbdFlag exports.
  Took the opportunity to reorder some of the higher numbered HAL entries and re-grouping, specifically (112,120) (84,106,108,117).
Admin:
  Tested on an ARM6/ARM7/SA Risc PC, BeagleBoard xM, Iyonix, Pandaboard ES, Wandboard Quad, IPEGv5, Titanium, Pi 2 and 3.
  Requires corresponding HAL change.
  Submission for USB bounty.

Version 5.89. Tagged as 'Kernel-5_89'
@
text
@d1238 5
@


4.24
log
@Add a compatibility page zero for high processor vectors / zero page relocation builds
Detail:
  When HiProcVecs is enabled, there will now be a read-only page located at &0 in order to ease compatibility with buggy software which reads from null pointers
  Although most of the page is zero-filled, the start of the page contains a few words which are invalid pointers, discouraging dereferencing them, and a warning message if the memory is interpreted as a string.
  On ARMv6+ the page is also made non-executable, to deal with branch-through-zero type situations
  OS_Memory 20 has been introduced as a way of determining whether the compatibility page is present, and also to enable/disable it
  File changes:
  - hdr/Options - Add CompatibilityPage option
  - hdr/OSMem - Declare OS_Memory reason code 20
  - hdr/KernelWS - When CompatibilityPage is enabled, make sure nothing else is located at &0
  - s/NewReset - Enable compatibility page just before Service_PostInit (try and keep zero-tolerance policy for null pointer dereferencing during ROM init)
  - s/MemInfo - OS_Memory 20 implementation. Add knowledge of the compatibility page to OS_Memory 16 and 24.
Admin:
  Tested on BB-xM


Version 5.87. Tagged as 'Kernel-5_87'
@
text
@d999 1
a999 1
; locations used during reset only. Not cleared by ClearPhysRAM, but
d1005 1
d1011 1
a1011 1
InitClearRamWs  #       10*4
@


4.23
log
@Initial support for the ExtraBytes VIDC control list item
Detail:
  The ExtraBytes control list item can be used to add padding between framebuffer rows.
  When the kernel sees a VIDC list containing this item, it will now adjust the LineLength and ScreenSize mode variables accordingly, with the end result that the correct amount of memory will be allocated for the framebuffer and the OS will render into it correctly.
  Files changed:
  - hdr/KernelWS - Add DisplayLineLength variable to allow the correct LineLength value to be preserved when screen output is redirected to a sprite
  - s/vdu/vdudriver - Make ModeChangeSub initialise DisplayLineLength before calling SwitchOutputToSprite. Update PushModeInfo to take ExtraBytes into account when calculating LineLength and ScreenSize.
  - s/vdu/vdugrafl - Adjust SwitchOutputToSprite to use DisplayLineLength when restoring screen output
  - s/vdu/vduwrch - Fix full-screen CLS to not write to the padding bytes
Admin:
  Tested on Raspberry Pi 3


Version 5.82. Tagged as 'Kernel-5_82'
@
text
@d254 4
@


4.23.2.1
log
@Initial SMP changes
Detail:
  This commit lays some of the groundwork for SMP support within the HAL, kernel, and OS.
  Makefile, hdr/HALDevice, hdr/DBellDevice - Add definitions for a doorbell HAL device, to allow CPU cores to signal each other via interrupts
  hdr/HALEntries - Repurpose HAL_Matrix and HAL_Touchscreen entry points for new SMP-related entry points. Add a couple of IRQ-related definitions.
  hdr/KernelWS - Boost MaxInterrupts to 256
  hdr/Options - Add new SMP build switch to control whether the kernel is built in SMP-friendly mode or not. SMP-friendly kernels should still run on single-core machines, but may behave slightly differently.
  s/ARMops - Make as many ARMops SMP-safe as possible, relying on hardware support for broadcasting of cache/TLB maintenance operations
  s/ExtraSWIs - Make SMP-friendly full OS_SynchroniseCodeAreas only sync application space and the RMA (full-cache IMB not really possible with SMP)
  s/NewIRQs - Update IRQ despatcher comments to (hopefully) reflect reality
  Docs/SMP/HAL, Docs/SMP/IRQ - Add documentation covering the new HAL calls and IRQ behaviour
Admin:
  Tested on Raspberry Pi 2, 3, OMAP4, iMX6


Version 5.86, 4.129.2.2. Tagged as 'Kernel-5_86-4_129_2_2'
@
text
@d1752 1
a1752 1
MaxInterrupts           *       256     ; 256 needed by SMP i.MX6 quad. Increase in future if necessary.
@


4.23.2.2
log
@Merge in latest changes from main branch


Version 5.88, 4.129.2.4. Tagged as 'Kernel-5_88-4_129_2_4'
@
text
@a253 4
 [ CompatibilityPage
        ASSERT ZeroPage != 0 :LAND: ProcVecs != 0
 ]

@


4.23.2.3
log
@Merge latest changes from main branch

Version 5.89, 4.129.2.6. Tagged as 'Kernel-5_89-4_129_2_6'
@
text
@d999 1
a999 1
; locations used during reset only. Not cleared by ClearWkspRAM, but
a1004 1
InitWsStart     #       0
d1010 1
a1010 1
InitClearRamWs  #       10*4            ; preserve registers during ClearPhysRAM
@


4.23.2.4
log
@Merge in latest changes from main branch

Version 5.97, 4.129.2.7. Tagged as 'Kernel-5_97-4_129_2_7'
@
text
@a1237 5

   [ CompatibilityPage
CompatibilityPageEnabled #      1       ; 0 or 1 as appropriate
   ]
                AlignSpace
@


4.23.2.5
log
@Merge in latest changes from main branch

Version 6.05, 4.129.2.8. Tagged as 'Kernel-6_05-4_129_2_8'
@
text
@d1396 1
a1396 1
 # 68                       ; spare
a1724 2
                        GBLA    SWIDespatch_Size
SWIDespatch_Size        SETA    38*4
d1726 7
a1732 1
SWIDespatch_Size        SETA    SWIDespatch_Size + 2*4
a1733 7
 [ ZeroPage <> 0
SWIDespatch_Size        SETA    SWIDespatch_Size + 4
 ]
 [ CheckErrorBlocks
SWIDespatch_Size        SETA    SWIDespatch_Size + 4
 ]

@


4.22
log
@Fix screen redirection when in teletext modes. Fix *ScreenLoad buffer overflow.
Detail:
  s/vdu/vdugrafl, s/vdu/vduttx - Adjust initialisation & shutdown of TTX workspace to fix workspace being erroneously freed/reinitialised when redirecting output to a sprite
  s/vdu/vdugrafk - If ScreenLoad needs to load one row at a time (e.g. when graphics window width != sprite width), allocate a block from the RMA instead of assuming that ScrLoaBuffer is large enough
  hdr/KernelWS - Get rid of ScrLoaBuffer, and shrink LargeCommon to a suitable size. Frees about 2K of VDU workspace.
  s/GetAll - Move Hdr:Sprite earlier in list of GETs
Admin:
  Tested on Raspberry Pi


Version 5.75. Tagged as 'Kernel-5_75'
@
text
@d589 1
a589 1
             # 4        ; SPARE (avoiding changes of exported addresses for now)
@


4.21
log
@Add support for custom teletext modes
Detail:
  This set of changes:
  * Adds support for the T, TX and TY mode string elements (as per RISCOS Ltd)
  * Adds support for entering arbitrary-resolution teletext modes by using mode selector blocks with the Teletext mode flag set
  * ScrRCol and ScrBRow mode variables can be provided in the mode selector in order to restrict the number of text rows/columns in teletext modes (as per RISCOS Ltd)
  * If the rows / columns are restricted in this manner then the text window will be centered on the screen, to try and avoid things looking too ugly (no variable text scaling implemented)
  * For HiResTTX, all colour depths >= 4bpp are now supported by teletext. This essentially makes the TTX256 switch obsolete.
  * If the "native" mode 7 is unavailable then the kernel will try a series of fallback resolutions & colour depths in an effort to find a combination that works
  Known bugs/issues:
  * Teletext column count has a max limit of 255 due to TTXDoubleCounts being a byte array
  * If there's a border around the text window, the border will not be refreshed when changing transparency modes using a VDU 23,18,0 sequence
  * ScreenLoad looks like it can overflow the LargeCommon buffer (no buffer size check) - needs fixing before LargeCommon can be safely shrunk below (Old)TTXMapSize
  File changes:
  - hdr/KernelWS - Make CharWidth non-conditional. Adjust handling of teletext workspace; it's now allocated from the system heap to allow it to cope with arbitrary screen sizes
  - s/vdu/vdu23 - Make CharWidth non-conditional
  - s/vdu/vducursoft - Make CursorTeletext cope with arbitrary colour depths, make CharWidth non-conditional, remove hard-coded teletext values
  - s/vdu/vdudriver - Deal with teletext workspace allocation during ModeChangeSub. Deal with selecting teletext modes (and validating colour depth) in GenerateModeSelectorVars.
  - s/vdu/vdugrafl - Make CharWidth non-conditional. Calculate offset required for text window centering.
  - s/vdu/vdumodes - Remove TTX256
  - s/vdu/vduswis - Try other teletext modes if native mode 7 not available. Extend OS_ScreenMode reason codes to cope with teletext mode strings.
  - s/vdu/vduttx - Update to use dynamic workspace. Replace various hardcoded values with variable lookups. Update character plotting + colour/palette selection to work with true-colour modes if HiResTTX.
  - s/vdu/vduwrch - Move some useful code into a subroutine. Update FastCLS to cope with true-colour teletext. Update AddressR0R1 to cope with text window centering offset. Make CharWidth non-conditional.
Admin:
  Tested on Raspberry Pi, BB-xM
  VDU 23,18,0 in 256-colour teletext now works correctly (previously 64-colour mode was in use, causing palette update to be ruined by VIDC1-mangling)


Version 5.74. Tagged as 'Kernel-5_74'
@
text
@d952 1
a952 1
; Teletext map and copy/move buffer are overlaid
d954 1
a954 2
OldTTXMapSize   * 41*25*4 ; (&1004 bytes)
LargeCommon     # OldTTXMapSize ; the largest area
d957 1
a957 1
ScrLoaBuffer    * LargeCommon   ; (size = one pixel row)
d960 1
d962 1
@


4.20
log
@Implement support for cacheable pagetables
Detail:
  Modern ARMs (ARMv6+) introduce the possibility for the page table walk hardware to make use of the data cache(s) when performing memory accesses. This can significantly reduce the cost of a TLB miss on the system, and since the accesses are cache-coherent with the CPU it allows us to make the page tables cacheable for CPU (program) accesses also, improving the performance of page table manipulation by the OS.
  Even on ARMs where the page table walk can't use the data cache, it's been measured that page table manipulation operations can still benefit from placing the page tables in write-through or bufferable memory.
  So with that in mind, this set of changes updates the OS to allow cacheable/bufferable page tables to be used by the OS + MMU, using a system-appropriate cache policy.
  File changes:
  - hdr/KernelWS - Allocate workspace for storing the page flags that are to be used by the page tables
  - hdr/OSMem - Re-specify CP_CB_AlternativeDCache as having a different behaviour on ARMv6+ (inner write-through, outer write-back)
  - hdr/Options - Add CacheablePageTables option to allow switching back to non-cacheable page tables if necessary. Add SyncPageTables var which will be set {TRUE} if either the OS or the architecture requires a DSB after writing to a faulting page table entry.
  - s/ARM600, s/VMSAv6 - Add new SetTTBR & GetPageFlagsForCacheablePageTables functions. Update VMSAv6 for wider XCBTable (now 2 bytes per element)
  - s/ARMops - Update pre-ARMv7 MMU_Changing ARMops to drain the write buffer on entry if cacheable pagetables are in use (ARMv7+ already has this behaviour due to architectural requirements). For VMSAv6 Normal memory, change the way that the OS encodes the cache policy in the page table entries so that it's more compatible with the encoding used in the TTBR.
  - s/ChangeDyn - Update page table page flag handling to use PageTable_PageFlags. Make use of new PageTableSync macro.
  - s/Exceptions, s/AMBControl/memmap - Make use of new PageTableSync macro.
  - s/HAL - Update MMU initialisation sequence to make use of PageTable_PageFlags + SetTTBR
  - s/Kernel - Add PageTableSync macro, to be used after any write to a faulting page table entry
  - s/MemInfo - Update OS_Memory 0 page flag conversion. Update OS_Memory 24 to use new symbol for page table access permissions.
  - s/MemMap2 - Use PageTableSync. Add routines to enable/disable cacheable pagetables
  - s/NewReset - Enable cacheable pagetables once we're fully clear of the MMU initialision sequence (doing earlier would be trickier due to potential double-mapping)
Admin:
  Tested on pretty much everything currently supported
  Delivers moderate performance benefits to page table ops on old systems (e.g. 10% faster), astronomical benefits on some new systems (up to 8x faster)
  Stats: https://www.riscosopen.org/forum/forums/3/topics/2728?page=2#posts-58015


Version 5.71. Tagged as 'Kernel-5_71'
@
text
@a856 1
 [ HiResTTX
d858 7
a864 2
                        ; in MODE 7, where characters are 16 pixels wide)
 ]
d885 1
a885 4
 [ :DEF: ShowWS
 ! 0,"16 ":CC::STR:@@
 ]
     AlignSpace 16      ; Align workspace to 16 bytes
d887 4
a890 1
TTXDoubleCounts # 25    ; Number of double height chars on each line
d954 2
a955 3
TTXMapSize      * 41*25*4       ; (&1004 bytes)
LargeCommon     # TTXMapSize    ; the largest area
TTXMap          * LargeCommon
d961 1
@


4.19
log
@Add new ARMops. Add macros which map the ARMv7/v8 cache/TLB maintenance mnemonics (as featured in recent ARM ARMs) to MCR ops.
Detail:
  - Docs/HAL/ARMop_API - Document the new ARMops. These ops are intended to help with future work (DMA without OS_Memory 0 "make temp uncacheable", and minimising cache maintenance when unmapping pages) and aren't in use just yet.
  - hdr/Copro15ops - Add new macros for ARMv7+ which map the mnemonics seen in recent ARM ARMs to the corresponding MCR ops. This should make things easier when cross-referencing docs and reduce the risk of typos.
  - hdr/KernelWS - Shuffle kernel workspace a bit to make room for the new ARMops
  - hdr/OSMisc - Expose new ARMops via OS_MMUControl 2
  - s/ARMops - Implement the new ARMops. Change the ARMv7+ ARMops to use the new mnemonic macros. Also get rid of myDSB / myISB usage from ARMv7+ code paths; use DSB/ISB/etc. directly to ensure correct behaviour
  - s/HAL - Mnemonic + ISB/DSB updates. Change software RAM clear to do 16 bytes at a time for kernel workspace instead of 32 to allow the kernel workspace tweaks to work.
Admin:
  Binary diff shows that mnemonics map to the original MCR ops correctly
  Note: Raspberry Pi builds will now emit lots of warnings due to increased DSB/ISB instruction use. However it should be safe to ignore these as they should only be present in v7+ code paths.
  Note: New ARMops haven't been tested yet, will be disabled (or at least hidden from user code) in a future checkin


Version 5.68. Tagged as 'Kernel-5_68'
@
text
@d1233 2
@


4.18
log
@Add support for shareable pages and additional access privileges
Detail:
  This set of changes:
  * Refactors page table entry encoding/decoding so that it's (mostly) performed via functions in the MMU files (s.ARM600, s.VMSAv6) rather than on an ad-hoc basis as was the case previously
  * Page table entry encoding/decoding performed during ROM init is also handled via the MMU functions, which resolves some cases where the wrong cache policy was in use on ARMv6+
  * Adds basic support for shareable pages - on non-uniprocessor systems all pages will be marked as shareable (however, we are currently lacking ARMops which broadcast cache maintenance operations to other cores, so safe sharing of cacheable regions isn't possible yet)
  * Adds support for the VMSA XN flag and the "privileged ROM" access permission. These are exposed via RISC OS access privileges 4 and above, taking advantage of the fact that 4 bits have always been reserved for AP values but only 4 values were defined
  * Adds OS_Memory 17 and 18 to convert RWX-style access flags to and from RISC OS access privelege numbers; this allows us to make arbitrary changes to the mappings of AP values 4+ between different OS/hardware versions, and allows software to more easily cope with cases where the most precise AP isn't available (e.g. no XN on <=ARMv5)
  * Extends OS_Memory 24 (CheckMemoryAccess) to return executability information
  * Adds exported OSMem header containing definitions for OS_Memory and OS_DynamicArea
  File changes:
  - Makefile - export C and assembler versions of hdr/OSMem
  - Resources/UK/Messages - Add more text for OS_Memory errors
  - hdr/KernelWS - Correct comment regarding DCacheCleanAddress. Allocate workspace for MMU_PPLTrans and MMU_PPLAccess.
  - hdr/OSMem - New file containing exported OS_Memory and OS_DynamicArea constants, and public page flags
  - hdr/Options - Reduce scope of ARM6support to only cover builds which require ARMv3 support
  - s/AMBControl/Workspace - Clarify AMBNode_PPL usage
  - s/AMBControl/growp, mapslot, mapsome, memmap - Use AreaFlags_ instead of AP_
  - s/AMBControl/main, memmap - Use GetPTE instead of generating page table entry manually
  - s/ARM600 - Remove old coments relating to lack of stack. Update BangCam to use GetPTE. Update PPL tables, removing PPLTransL1 (L1 entries are now derived from L2 table on demand) and adding a separate table for ARM6. Implement the ARM600 versions of the Get*PTE ('get page table entry') and Decode*Entry functions
  - s/ARMops - Add Init_PCBTrans function to allow relevant MMU_PPLTrans/MMU_PCBTrans pointers to be set up during the pre-MMU stage of ROM init. Update ARM_Analyse to set up the pointers that are used post MMU init.
  - s/ChangeDyn - Move a bunch of flags to hdr/OSMem. Rename the AP_ dynamic area flags to AreaFlags_ to avoid name clashes and confusion with the page table AP_ values exported by Hdr:MEMM.ARM600/Hdr:MEMM.VMSAv6. Also generate the relevant flags for OS_Memory 24 so that it can refer to the fixed areas by their name instead of hardcoding the permissions.
  - s/GetAll - GET Hdr:OSMem
  - s/HAL - Change initial page table setup to use DA/page flags and GetPTE instead of building page table entries manually. Simplify AllocateL2PT by removing the requirement for the user to supply the access perimssions that will be used for the area; instead for ARM6 we just assume that cacheable memory is the norm and set L1_U for any L1 entry we create here.
  - s/Kernel - Add GetPTE macro (for easier integration of Get*PTE functions) and GenPPLAccess macro (for easy generation of OS_Memory 24 flags)
  - s/MemInfo - Fixup OS_Memory 0 to not fail on seeing non-executable pages. Implement OS_Memory 17 & 18. Tidy up some error generation. Make OS_Memory 13 use GetPTE. Extend OS_Memory 24 to return (non-) executability information, to use the named CMA_ constants generated by s/ChangeDyn, and to use the Decode*Entry functions when it's necessary to decode page table entries.
  - s/NewReset - Use AreaFlags_ instead of AP_
  - s/VMSAv6 - Remove old comments relating to lack of stack. Update BangCam to use GetPTE. Update PPL tables, removing PPLTransL1 (L1 entries are now derived from L2 table on demand) and adding a separate table for shareable pages. Implement the VMSAv6 versions of the Get*PTE and Decode*Entry functions.
Admin:
  Tested on Raspberry Pi 1, Raspberry Pi 3, Iyonix, RPCEmu (ARM6 & ARM7), comparing before and after CAM and page table dumps to check for any unexpected differences


Version 5.55. Tagged as 'Kernel-5_55'
@
text
@d1077 10
a1086 1
                #       3*4     ; SPARE
a1092 1
SyncCodeA_sema  #       1       ; re-entrancy semaphore for SynchroniseCodeAreas (full address space version)
a1095 1
 ! 0, "SyncCodeA_sema (byte) at ":CC::STR:(SyncCodeA_sema)
a1097 1
                AlignSpace 4
a1104 8
Serv_SysChains          # 4          ;anchor for block handling 'system' service numbers, in range 1 to 255
Serv_UsrChains          # 4          ;anchor for block handling 'user' service numbers, > 255
Serv_AwkwardChain       # 4          ;anchor for chain handling non-compliant modules (no service table)
 [ :DEF: ShowWS
      ! 0, "Serv_SysChains        at ":CC::STR:(Serv_SysChains)
      ! 0, "Serv_UsrChains        at ":CC::STR:(Serv_UsrChains)
      ! 0, "Serv_AwkwardChain     at ":CC::STR:(Serv_AwkwardChain)
 ]
d1106 2
a1108 3
                AlignSpace 32   ; skipped bit must start on 32-byte boundary (due to speedup)

SkippedTables   #       0
d1173 1
d1175 1
d1178 2
d1233 1
a1233 1
                AlignSpace 32   ; skipped bit must end on 32-byte boundary (due to speedup)
@


4.17
log
@Delete lots of old switches
Detail:
  This change gets rid of the following switches from the source (picking appropriate code paths for a 32bit HAL build):
  * FixCallBacks
  * UseProcessTransfer
  * CanLiveOnROMCard
  * BleedinDaveBell
  * NewStyleEcfs
  * DoVdu23_0_12
  * LCDPowerCtrl
  * HostVdu
  * Print
  * EmulatorSupport
  * TubeInfo
  * AddTubeBashers
  * TubeChar, TubeString, TubeDumpNoStack, TubeNewlNoStack macros
  * FIQDebug
  * VCOstartfix
  * AssemblingArthur (n.b. still defined for safety with anything in Hdr: which uses it, but not used explicitly by the kernel)
  * MouseBufferFix
  * LCDInvert
  * LCDSupport
  * DoInitialiseMode
  * Interruptible32bitModes
  * MouseBufferManager
  * StrongARM (new CacheCleanerHack and InterruptDelay switches added to hdr/Options to cover some functionality that StrongARM previously covered)
  * SAcleanflushbroken
  * StrongARM_POST
  * IrqsInClaimRelease
  * CheckProtectionLink
  * GSWorkspaceInKernelBuffers
  * EarlierReentrancyInDAShrink
  * LongCommandLines
  * ECC
  * NoSPSRcorruption
  * RMTidyDoesNowt
  * RogerEXEY
  * StorkPowerSave
  * DebugForcedReset
  * AssembleKEYV
  * AssemblePointerV
  * ProcessorVectors
  * Keyboard_Type
  Assorted old files have also been deleted.
Admin:
  Identical binary to previous revision for IOMD & Raspberry Pi builds


Version 5.51. Tagged as 'Kernel-5_51'
@
text
@d280 1
a280 1
DCacheCleanAddress  * &FA600000 ; eg. for StrongARM, 256k of space, up to FAF40000
d1169 1
d1171 1
@


4.16
log
@Delete pre-HAL and 26bit code
Detail:
  This change gets rid of the following switches from the source (picking appropriate code paths for a 32bit HAL build):
  * HAL
  * HAL26
  * HAL32
  * No26bitCode
  * No32bitCode
  * IncludeTestSrc
  * FixR9CorruptionInExtensionSWI
  Various old files have also been removed (POST code, Arc/STB keyboard drivers, etc.)
Admin:
  Identical binary to previous revision for IOMD & Raspberry Pi builds


Version 5.49. Tagged as 'Kernel-5_49'
@
text
@d727 1
a727 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d811 1
a811 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d881 1
a881 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d888 1
a888 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d895 1
a895 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d911 1
a911 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d933 1
a933 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d943 1
a943 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d962 1
a962 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
a1083 1
                [ StrongARM
a1089 1
               ]
a1267 4
  [ :LNOT: LongCommandLines
EnvString          #    256
  ]

d1311 1
a1311 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
a1375 8
; GeneralMOSBuffer: re-use with caution!
; Here's just some of the users:
; user                  use(s)
; default error handler error buffer (must be 246+4 bytes big)
; *If                   expression to be evaluated to control the *If
;                       Command line to be submited on the expression
;                         evaluating to non-zero (the THEN clause).
  [ LongCommandLines
a1376 3
  |
GeneralMOSBuffer   #  256+4
  ]
d1378 1
a1378 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
a1530 1
 [ StorkPowerSave
d1532 1
a1532 4
PowerSave * &80
 |
PortableFlag        #  1                ; Non-zero => got an error from Portable_Speed, so don't try it again
 ]
d1544 1
a1544 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d1589 1
a1589 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
a1616 10
 [ GSWorkspaceInKernelBuffers
; the GSTrans workspace has now moved to the kernel buffers area
; GSInit and GSRead may now safely be called from USR mode wahey...
 |
; GSTRANS workspace: GSINIT puts state into the workspacem and GSREAD uses it.
; DO NOT do any operations between GSINIT/GSREAD SWIS.
; SWIs called: OSWord in time var code
;              BinaryToDecimal, ReadUnsigned
 ]

a1622 6
 [ GSWorkspaceInKernelBuffers
; GSVarWSpace is now in kernel buffers
 |
GSVarWSpace             *       ScratchSpace
 ]

d1628 1
a1628 3
 [ GSWorkspaceInKernelBuffers
GSVarWSpace_Size	#	0
 ]
a1641 1
  [ LongCommandLines
a1642 5
  |
AliasExpansionBuffer    #       100     ;mjs: shouldn't this be &100 ??!??
; *list/*type need an argument expansion buffer: ReadArgs called with it.
ArgumentBuffer          *       AliasExpansionBuffer
  ]
a1649 5
  [ LongCommandLines
    ;ExprBuff moved to Kernel buffers area
  |
ExprBuff                #       &100
  ]
a1653 2
  [ LongCommandLines
    ;exprSTRACC moved to Kernel buffers area
a1655 5
  |
exprSTRACC              *       @@ - ExprBuff + ExprWSpace
ExprStackLimit          *       exprSTRACC + &100
ExprStackStart          *       ScratchSpace + ScratchSpaceSize
  ]
d1747 1
a1747 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
a1766 2
  [ LongCommandLines

d1773 7
a1795 1
 [ GSWorkspaceInKernelBuffers
d1798 1
a1798 2
SysVarWorkSpace	      #  40		; used by the sys$* variables for reading the current time into
 ]
a1825 2
  ] ;LongCommandLines

@


4.15
log
@Merge HAL branch to trunk
Detail:
  This change merges the past 15+ years of HAL branch development back to the trunk.
  This is effectively the end for non-HAL builds of the kernel, as no attempt has been made to maintain it during this merge, and all non-HAL & non-32bit code will soon be removed anyway.
  Rather than list everything that's been added to the HAL branch, it's easier to describe the change in terms of the things that the HAL branch was lacking:
  * Trunk version of Docs/32bit contained updated comments for the SVC stack structure during ErrorV
  * Trunk version of s/HeapMan contained a tweak to try and reduce the number of small free blocks that are created
  * Trunk version of s/Kernel contained a change to only copy 248 bytes of the error string to the error buffer (down from 252 bytes), to take into account the extra 4 bytes needed by the PSR. However this goes against the decision that's been made in the HAL branch that the error buffer should be enlarged to 260 bytes instead (ref: https://www.riscosopen.org/tracker/tickets/201), so the HAL build will retain its current behaviour.
  * Trunk version of s/MsgCode had RMNot32bit error in the list of error messages to count when countmsgusage {TRUE}
  * Trunk version of s/PMF/i2cutils contained support for OS_Memory 5, "read/write value of NVRamWriteSize". Currently the HAL branch doesn't have a use for this (in particular, the correct NVRamWriteSize should be specified by the HAL, so there should be no need for software to change it at runtime), and so this code will remain switched out in the HAL build.
Admin:
  Tested on Raspberry Pi


Version 5.48. Tagged as 'Kernel-5_48'
@
text
@a253 1
 [ HAL
a293 35
 |
AplWorkMaxSize      * &01C00000 ; 28M
RMAAddress          * &02100000
RMAMaxSize          * &00B00000 ; 11M

SVCStackSize        * 8*1024

SysHeapChunkAddress * &01C00000
SVCStackAddress     * SysHeapChunkAddress
SysHeapAddress      * SysHeapChunkAddress+SVCStackSize
SysHeapMaxSize      * &00200000-SVCStackSize

CursorChunkAddress  * &01F00000 ; Fixed size 32K
DuffEntry           * &01F08000 ; No page ever mapped in here (L2PT entry always 0), also, all non mapped pages        
Nowhere             * DuffEntry ; use this as their CAM entry. There is only one 'Nowhere' (synonym).

ScreenEndAdr        * &05000000 ; was &02000000
ScreenMaxSize       * 480*1024

; FontCacheAddress    * &06000000 ; was &01E00000       ; now dynamic
; FontCacheMaxSize    * &01000000 ; 16M

; SpriteSpaceAddress  * &08000000 ; was &01400000       ; now dynamic
; SpriteSpaceMaxSize  * &01000000 ; 16M

; RAMDiscAddress      * &07000000 ; was &01000000       ; now dynamic
; RAMDiscMaxSize      * &03000000 ; 48M

FreePoolAddress     * &06000000 ; may still go lower!

PhysRam         *     &05000000
;following dynamic area only used if LongCommandLines is {TRUE}
KbuffsBaseAddress  * &2078000   ;just above reserved area for fake 480k screen
KbuffsMaxSize      * &0088000   ;544k (takes us up to start of RMA)
 ]
a1128 1
 [ HAL
a1129 7
 |
VRAMSize        #       4       ; Amount of VRAM (in bytes) (may be more than 2M) (at &200 last time I checked)
VideoBandwidth  #       4       ; video bandwidth in bytes/sec
L2PTSize        #       4       ; Amount of memory (in bytes) used for static L2PT
                                ; - this consists of fixed size first bit, plus variable size
                                ; bit for the free pool L2, which follows directly after it
 ]
a1131 16
 [ {FALSE}
InitKbdHandler  #       4       ; Address of interrupt routine
InitKbdWs       #       16      ; Workspace for reset keyboard IRQ code (was 12 changed for Morris)
 ]
 [ :LNOT: HAL
CLine_Softcopy  #        1      ; Added for Morris - Monitor id

VRAMWidth       #       1       ; 0 => no VRAM, 1 => 32-bits wide, 2 => 64-bits wide

LCD_Active      #       1       ; Added to support LCD/CRT switching. bm 6 bits 0=>External CRT in use, 1=>Mono, 2=>Passive colour, 3=>Active colour
                                ;                                     bit 7     unset=>single panel, set=>dual panel
LCD_Inverted    #       1       ; Added to support LCD palette inversion. 0=normal, 1=inverted. Note that the inversion is invisible to apps.
 [ :DEF: ShowWS
 ! 0, "LCD_Active flag byte held at  ":CC::STR:(LCD_Active)
 ]
 ]
a1132 1
 [ HAL
a1161 1
 ]
a1167 1
 [ HAL
a1201 1
 ]
a1251 1
 [ HAL
a1253 1
 ]
a1716 4
 [ :LNOT: HAL32
; ***        Sits in the 32K above 31M, ie. &01F000000..&01F07FFF           ***
; ***        Has the physical address &02078000, ie. 32M + 512K - 32K       ***
 ]
a1761 3
 [ :LNOT: HAL32
 ASSERT SvcTable = &01F033FC ; Required for SVC table pokers, 1.20 compatible
 ]
a1813 1
 [ HAL32
a1814 3
 |
                ^       SysHeapChunkAddress
 ]
a1818 1
 [ HAL32
a1819 3
 |
SysHeapStart           #       0
 ]
@


4.14
log
@  Fixed minor bug in module initialisation.
  Added common error cache.
Detail:
  Fixed module header validation code which was broken in 5.22.  This
    shouldn't have caused much of a problem as it was only a bizarre
    check (SWI chunk looked valid but SWI handler was 0) that would
    have failed - but be reported as a valid set of SWI entries.
  Added common error message cache.  Several common errors (Buffer
    overflow; Number not recognised; Bad vector release; and a couple
    of others) are now cached the first time they are translated into
    a block of memory in the system heap.
Admin:
  Tested in Ursula build - cacheing only active in Ursula build - change
    HdrSrc if you want it in your products too.
  Requires HdrSrc 0.94

Version 5.31. Tagged as 'Kernel-5_31'
@
text
@d216 26
a241 1
                ^       0
a242 10
DANode_Link     #       4               ; points to next node
DANode_Number   #       4               ; number of this area
DANode_Base     #       4               ; base address of area (points in middle of doubly-mapped areas)
DANode_Flags    #       4               ; various flags
DANode_Size     #       4               ; current size of area
DANode_MaxSize  #       4               ; maximum size of area
DANode_Workspace #      4               ; workspace pointer when calling handlers
DANode_Handler  #       4               ; pointer to handler routine for area
DANode_Title    #       4               ; pointer to area title (variable length)
DANode_NodeSize #       0
d246 49
a294 4
 [ :DEF: OldMemoryMap
AplWorkMaxSize      * &01000000 ; 16M
RMAAddress          * &01800000
RMAMaxSize          * &00400000 ; 4M
a298 1
 ]
d303 2
d308 2
d326 4
d524 15
d625 1
a625 1
CursorFudgeFactor # 4   ; Factor for horizontal cursor positioning
d702 3
a704 1
PointerXEigFactor # 4
d724 1
a724 1
VinitCopy # 4   ; Copy of Vinit for VDU 23;12 or 13
d734 5
d749 1
a749 1
VIDCClockSpeed # 4      ; current VIDC clock speed in kHz
a752 1
 [ STB
d754 5
a758 1
 ]
d763 1
a763 1
 [ AssemblingArthur
d784 1
a784 1
HLineAddr    # 4        ; address of exported HLine
d787 32
a818 4
FirPalSetting # 4*28            ; First palette settings (not used on VIDC20)
FirPalAddr * FirPalSetting      ; Address of block for first palette setting (only used on VIDC20)
SecPalSetting # 4*28            ; Second palette settings (not used on VIDC20)
SecPalAddr * SecPalSetting      ; Address of block for second palette setting (only used on VIDC20)
d831 1
a831 2
HSWRSoftCopy    #       4       ; soft copy of h.sync width register (for DPMS)
VSWRSoftCopy    #       4       ; soft copy of v.sync width register (for DPMS)
d833 1
a833 1
;ScreenBlankFlag # 1     ; 0 => unblanked, 1 => blanked
d835 2
a836 3
Export_ScreenBlankFlag      #       1
        ASSERT  Export_ScreenBlankFlag =  ScreenBlankFlag
        ASSERT ?Export_ScreenBlankFlag = ?ScreenBlankFlag
d838 4
a841 4
;ScreenBlankDPMSState # 1       ; 0 => just blank video
                                ; 1 => blank to stand-by (hsync off)
                                ; 2 => blank to suspend (vsync off)
                                ; 3 => blank to off (H+V off)
d843 2
a844 3
Export_ScreenBlankDPMSState      #       1
        ASSERT  Export_ScreenBlankDPMSState =  ScreenBlankDPMSState
        ASSERT ?Export_ScreenBlankDPMSState = ?ScreenBlankDPMSState
d847 1
a847 1
 [ AssemblingArthur
d852 7
a858 7
Export_FgEcfOraEor # 4*16      ; Interleaved zgora & zgeor
        ASSERT  Export_FgEcfOraEor =  FgEcfOraEor
        ASSERT ?Export_FgEcfOraEor = ?FgEcfOraEor

Export_BgEcfOraEor # 4*16      ; Interleaved zgora & zgeor
        ASSERT  Export_BgEcfOraEor =  BgEcfOraEor
        ASSERT ?Export_BgEcfOraEor = ?BgEcfOraEor
d875 11
a885 11
PointerHeights # 4      ; 4 x 1 byte
PointerActiveXs # 4     ; 4 x 1 byte
PointerActiveYs # 4     ; 4 x 1 byte
PointerShapeNumber # 1  ; includes bit 7 linkage flag
PointerShapeChanged # 1 ; non-zero: change shape next vsync
         # 2
PointerX # 4            ; co-ordinates of pointer (not always = mouse)
PointerY # 4

VIDCControlCopy # 4     ; Soft copy of VIDC control register
VertAdjust # 4          ; offset to add to vertical VIDC registers
d915 1
d917 1
a917 1
 [ AssemblingArthur
d924 1
a924 1
 [ AssemblingArthur
d931 1
a931 1
 [ AssemblingArthur
d947 1
a947 1
 [ AssemblingArthur
d964 1
a964 3
VIDCExternalSoftCopy #  4       ; soft copy of VIDCExternal
VIDCFSynSoftCopy     #  4       ; soft copy of VIDCFSyn
VIDCControlSoftCopy  #  4       ; soft copy of VIDCControl
d969 1
a969 1
 [ AssemblingArthur
d979 1
a979 1
 [ AssemblingArthur
d998 1
a998 1
 [ AssemblingArthur
d1013 8
d1026 18
d1049 7
a1055 7
Export_ESC_Status      #       1       ; &104
        ASSERT  Export_ESC_Status =  ESC_Status
        ASSERT ?Export_ESC_Status = ?ESC_Status

Export_LatchBSoftCopy  #       1       ; &105
        ASSERT  Export_LatchBSoftCopy =  LatchBSoftCopy
        ASSERT ?Export_LatchBSoftCopy = ?LatchBSoftCopy
d1059 7
a1065 7
Export_CannotReset     #       1       ; &107
        ASSERT  Export_CannotReset =  CannotReset
        ASSERT ?Export_CannotReset = ?CannotReset

Export_IRQsema         #       4       ; &108
        ASSERT  Export_IRQsema =  IRQsema
        ASSERT ?Export_IRQsema = ?IRQsema
d1068 3
d1073 3
a1075 3
Export_MEMC_CR_SoftCopy #      4       ; &114
        ASSERT  Export_MEMC_CR_SoftCopy =  MEMC_CR_SoftCopy
        ASSERT ?Export_MEMC_CR_SoftCopy = ?MEMC_CR_SoftCopy
d1113 1
a1113 3
VInitSoftCopy   #       4       ; soft copy of VInit so we can set L bit correctly
VEndSoftCopy    #       4       ; soft copy of VEnd  ------------""---------------
VStartSoftCopy  #       4       ; soft copy of VStart so we can calculate VIDINITB correctly
d1119 1
a1119 1
ARMA_Cleaner_flipflop # 4       ; address of 16k StrongARM data cache cleaner area (flip flops between two)
d1122 3
a1124 2
 ! 0, "AMBControl_ws  at  ":CC::STR:(AMBControl_ws)
 ! 0, "ARMA_Cleaner_flipflop at ":CC::STR:(ARMA_Cleaner_flipflop)
d1126 1
d1132 1
d1135 1
d1140 1
d1144 1
d1150 3
a1152 4
PhysRamTable    #       0       ; 6 pairs of words (physaddr, size) indicating
                                ; RAM present in machine (NB normally you would need at most 5
                                ; on IOMD machines, but the extra one is if a soft-loaded ROM image
                                ; causes a bank to split
d1154 4
a1157 15
VideoSize       #       4       ; this is actually a chunk out of DRAM)
DRAMPhysAddrA   #       4       ; Next the DRAM - note that any banks with no memory
DRAMSizeA       #       4       ; in them will be omitted from this table, so that
DRAMPhysAddrB   #       4       ; eg DRAMPhysAddrA corresponds to the first bank with
DRAMSizeB       #       4       ; DRAM in it, not necessarily bank 0
DRAMPhysAddrC   #       4       ; If not all the slots are occupied, then
DRAMSizeC       #       4       ; the remaining entries in this table have size fields
DRAMPhysAddrD   #       4       ; of zero (and probably addresses of zero too)
DRAMSizeD       #       4
DRAMPhysAddrE   #       4
DRAMSizeE       #       4
 [ MorrisSupport
DRAMPhysAddrExtra #     4 * 12  ; The DRAM used with MORRIS can fragment into four
DRAMSizeExtra     #     4 * 12  ; blocks so allocate 3 extra word pairs per bank
 ]
d1159 3
d1163 1
d1165 3
a1168 1
VRAMWidth       #       4       ; 0 => no VRAM, 1 => 32-bits wide, 2 => 64-bits wide
d1173 1
d1176 1
d1179 2
d1183 2
a1184 1
                [ :LNOT: STB
d1188 1
d1190 2
a1191 1
                ]
d1193 34
a1226 3
 [ StrongARM
ProcessorType   #       1       ; Processor type (handles 600 series onwards)
ProcessorFlags  #       1       ; Processor flags (IMB, Arch4 etc)
d1230 62
d1293 2
a1294 1
IOSystemType    #       1       ; 0 => old I/O subsystem, 1 => IOEB+82C710 system, 2..255 => ?
d1299 1
d1301 19
a1319 8

AppSpaceDANode  #       DANode_NodeSize ; Dummy area node for application space (not on list)
FreePoolDANode  #       DANode_NodeSize ; Area node for free pool
SysHeapDANode   #       DANode_NodeSize ; Area node for system heap
CDASemaphore    #       4               ; Semaphore for OS_ChangeDynamicArea - non-zero => routine threaded
MMUControlSoftCopy #    4               ; Soft copy of ARM600/700 control register

AplWorkSize * AppSpaceDANode + DANode_Size
d1327 1
a1327 1
ProcVec_AddrEx          #       4       ; Address exception vector (not useful on ARM600/700)
d1334 1
a1334 2
        ASSERT  @@ = &300
Export_DebuggerSpace    #       16*8    ; Debugger module needs some zero page
d1336 2
a1337 3
  [ E2ROMSupport
NVRamSize	#	1		; Size of NVRam (E2ROM & CMOS) fitted in 256byte units
RTCFitted	#	1		; flag =1 iff RTC is fitted
d1340 1
a1340 6
  [ E2ROMSupport
NVRamBase       #       1               ; Base of NVRam
NVRamSpeed      #       1               ; Clock hold time in 0.5s units
NVRamPageSize   #       1               ; Page size for writing (log2)
NVRamWriteSize  #       1               ; Size of writable region (256byte units)
  ]
d1342 1
d1344 3
a1346 5
                AlignSpace

EnvString         #     256

	! 0, "Free space after EnvString = ":CC::STR:(&500-@@)
d1353 3
a1355 1
	! 0, "Free space after CamMap debug block = ":CC::STR:((JordanWS+256*4)-@@)
d1370 1
a1370 1
                #       4       ; dummy slot where AplWorkSize used to be
d1383 1
a1383 1
 [ AssemblingArthur
d1390 1
d1392 1
d1414 1
d1421 2
d1436 1
d1438 1
d1455 3
d1459 1
d1461 1
a1461 1
 [ AssemblingArthur
d1496 7
a1502 7
Export_RedirectInHandle   #    1
        ASSERT  Export_RedirectInHandle =  RedirectInHandle
        ASSERT ?Export_RedirectInHandle = ?RedirectInHandle

Export_RedirectOutHandle  #    1
        ASSERT  Export_RedirectOutHandle =  RedirectOutHandle
        ASSERT ?Export_RedirectOutHandle = ?RedirectOutHandle
d1508 2
a1509 1
MonitorLeadType #       1       ; some function of the monitor lead inputs, as yet undetermined
d1527 1
d1529 1
d1532 1
d1534 1
d1537 1
d1539 1
d1543 1
d1545 1
d1548 1
d1550 1
d1555 1
d1557 1
d1573 1
d1578 1
d1631 1
a1631 1
 [ AssemblingArthur
d1641 2
d1652 3
d1656 3
d1660 2
d1663 3
a1665 3
Export_DomainId                #       4       ; SKS added for domain identification
        ASSERT  Export_DomainId =  DomainId
        ASSERT ?Export_DomainId = ?DomainId
d1669 3
a1671 3
Export_VduDriverWorkSpace      #       VDWSSize
        ASSERT  Export_VduDriverWorkSpace =  VduDriverWorkSpace
        ASSERT ?Export_VduDriverWorkSpace = ?VduDriverWorkSpace
d1676 1
a1676 1
 [ AssemblingArthur
d1704 4
d1712 1
d1720 3
d1724 1
d1731 3
d1747 4
a1750 2
AliasExpansionBuffer    #       100

d1752 2
a1754 1
ArgumentBuffer           *       AliasExpansionBuffer
d1761 3
d1765 1
d1769 6
a1775 1

d1778 1
a1780 14
; Tutu needs some for argument substitution + expansion for run/load types
; Only OS call during xform is XOS_SubstituteArgs and XOS_Heap(Claim,SysHeap)

                        ^       0 ; Offset from ScratchSpace
rav_substituted         #       256
rav_arglist             #       256

TopOfPageZero           #       0

                        ^       &8000 ; The actual top of Page Zero
EconetDebugSpace        |#|     &20 * 4 ; Thirty two words (&7F80)

                ASSERT  @@ > TopOfPageZero ; Make sure we don't clash

d1783 1
d1786 1
a1788 1
TopOfDMAPhysRAM         *       &80000            ; OFFSET in physram
a1789 1
OffsetLogicalToPhysical *       TopOfDMAPhysRAM - TopOfDMAWorkSpace
d1811 8
d1820 1
a1820 1
CursorDataSize          *       &800
d1823 2
a1824 1
CursorSoundPhysRAM      *       CursorSoundRAM + OffsetLogicalToPhysical
d1828 1
a1828 7
Export_BranchToSWIExit         |#|     4
        ASSERT  Export_BranchToSWIExit =  BranchToSWIExit
        ASSERT ?Export_BranchToSWIExit = ?BranchToSWIExit

Export_SvcTable                |#|     &400
        ASSERT  Export_SvcTable =  SvcTable
        ASSERT ?Export_SvcTable = ?SvcTable
d1830 3
d1834 7
a1840 2
 [ No26bitCode
SWIDespatch_Size        *       33*4
d1842 1
a1842 1
SWIDespatch_Size        *       31*4    ; can save 2 instructions if 26-bit (no Thumb)
d1870 4
a1873 1
; Oscli buffering
a1874 15
OscliBuffSize           *       &100
OscliNoBuffs            *       16
OscliCircBuffLimit      |#|     0
OscliCircBuffStart      |#|     OscliBuffSize * OscliNoBuffs
RedirectBuff            |#|     OscliBuffSize

; Default IRQ despatch moved here as a result of IOMD having an extra
; 6 interrupts for I/O and sound DMA (this is really IOMD specific, not
; ARM600/700 specific but for the moment it is assumed that they are
; used on the same machines).
 [ MorrisSupport
DefIRQ1Vspace           *       12*4+12*23+2*256+64 + 7*4+12*16+32+256 ;Morris adds 2 more IRQ registers
 |
DefIRQ1Vspace           *       12*4+12*23+2*256+64     ; for size checking in MOS
 ]
d1877 2
a1878 9
 [ AssemblingArthur
 ! 0, "Aligning IRQ stack from ":CC::STR:@@
 ]
 [ @@-7*4 :AND: 15 <> 0
                        |#|     (@@-7*4):AND:15
 ]
IRQSTK                  #       0       ; Overflow will give abort
 [ AssemblingArthur
 ! 0, "IRQ stack size ":CC::STR:(IRQSTK-CursorChunkAddress)
d1881 1
a1881 1
 ASSERT @@ > ( CursorChunkAddress + &1000 ) ; Check minimum stack
d1887 3
d1891 1
d1894 69
a1962 7
Export_SVCSTK          #       0
        ASSERT  Export_SVCSTK =  SVCSTK
        ASSERT ?Export_SVCSTK = ?SVCSTK

Export_SysHeapStart    #       0
        ASSERT  Export_SysHeapStart =  SysHeapStart
        ASSERT ?Export_SysHeapStart = ?SysHeapStart
@


4.14.2.1
log
@* Converted to building with ObjAsm (but still a single object file using ORG).
* Added ARM_IMB and ARM_IMBRange SWIs as recommended by ARMv5.
* Some early prototype HAL bits popped in - a lot of source restructuring still
  to come.
* New debug target creates an AIF image with debug information, and translates
  this into an ASCII object file for the 16702B logic analyser.

Version 5.35, 4.79.2.1. Tagged as 'Kernel-5_35-4_79_2_1'
@
text
@d231 4
a234 24
ZeroPage            * &00000000

 [ HAL
; Sort out 26/32 bit versions
SVCStackSize        * 32*1024

RMAAddress          * &80000000 ; temporary - run time allocate
ScreenEndAdr        * &A0000000 ; temporary - run time allocate
ScreenMaxSize       * 480*1024

RMAMaxSize          * -1

IO                  * &F0000000
HALWorkspace        * &FA000000
IRQStackAddress     * &FA100000
SVCStackAddress     * &FA200000
PhysicalAccess      * &FAE00000
CursorChunkAddress  * &FAFF0000
L2PT                * &FB000000
L1PT                * &FB400000
SysHeapChunkAddress * &FB404000
SysHeapAddress      * SysHeapChunkAddress
SysHeapMaxSize      * &FB800000 - SysHeapAddress
CAM                 * &FB800000
d239 1
a243 2
SVCStackAddress     * SysHeapChunkAddress
SysHeapAddress      * SysHeapChunkAddress+SVCStackSize
a262 1
 ]
a901 10
; locations used during reset only
                ^       ZeroPage+&20
InitKbdHandler  #       4
InitKbdWs       #       16
InitUsedStart   #       4
InitUsedEnd     #       4
InitClearRamWs  #       5*4
                AlignSpace 32           ; because we clear 32 at a time
InitWsEnd       #       0

d904 1
a904 1
                       ^       ZeroPage+&100
d1018 2
a1019 2
DRAMPhysAddrExtra #     8 * 12  ; The DRAM used with MORRIS can fragment into four
                                ; blocks so allocate 3 extra word pairs per bank
a1021 2
DRAMPhysTableSize *     (PhysRamTableEnd-DRAMPhysAddrA) / 8

a1023 1
 [ :LNOT: HAL
d1025 1
a1029 1
 ]
a1031 1
 [ {FALSE}
a1033 1
 ]
a1035 1
VRAMWidth       #       1       ; 0 => no VRAM, 1 => 32-bits wide, 2 => 64-bits wide
a1041 19
 [ HAL
                AlignSpace
HAL_EntryTable  #       4
HAL_WsSize      #       4
ICache_Info     #       0
ICache_NSets    #       4
ICache_Size     #       4
ICache_LineLen  #       1
ICache_Associativity #   1

Cache_Type      #       1
Cache_Flags     #       1

DCache_Info     #       4
DCache_NSets    #       4
DCache_Size     #       4
DCache_LineLen  #       1
DCache_Associativity #   1
 ]
d1078 1
a1078 2
        ASSERT  @@ <= &300
                        #       (&300-@@)
a1499 3
 [ HAL32
SoundDMABufferSize      *       &1000
 |
a1501 1
 ]
a1504 4
 [ HAL32
SoundDMABuffers         |#|     SoundDMABufferSize * 2
SoundWorkSpace          |#|     SoundWorkSpaceSize + SoundEvtSize
 |
a1511 1
 ]
a1529 1
 [ :LNOT: HAL32
a1530 1
 ]
a1597 3
 [ HAL32
                ^       SVCStackAddress
 |
a1598 1
 ]
a1604 3
 [ HAL32
Export_SysHeapStart    *       SysHeapAddress
 |
a1605 1
 ]
@


4.14.2.2
log
@More HAL work. IOMD HAL work in progress. Lots of my own little build
scripts. Don't touch this.

Version 5.35, 4.79.2.2. Tagged as 'Kernel-5_35-4_79_2_2'
@
text
@a235 3
IRQStackSize        *  8*1024
ABTStackSize        *  8*1024
UNDStackSize        *  8*1024
d243 1
a243 1
IO                  * &FA000000 ; works downwards
a246 2
ABTStackAddress     * &FA300000
UNDStackAddress     * &FA400000
a254 4

IRQSTK              * IRQStackAddress + IRQStackSize
ABTSTK              * ABTStackAddress + ABTStackSize
UNDSTK              * UNDStackAddress + UNDStackSize
d924 7
a930 11
; locations used during reset only. Not cleared by ClearPhysRAM, but
; cleared later (just before DEFHAN).

                ^       ZeroPage+&80    ; steer clear of FIQ code
InitKbdHandler  #       4               ; pointer to IRQ handler (LDR PC'ed from IRQ HW vector)
InitKbdWs       #       16              ; workspace for IRQ handler
InitUsedStart   #       4               ; start of used pages (L2PT etc) not to be cleared
InitUsedEnd     #       4               ; end of used pages
InitUsedBlock   #       4               ; can't remember
InitHALFlags    #       4               ; flags passed into OS_Start
InitClearRamWs  #       10*4
a933 2
        ASSERT  InitKbdHandler >= EndFiq - MOSROMVecs

d1082 1
a1082 2
HAL_Descriptor  #       4
HAL_Workspace   #       4
d1084 1
a1084 2

ICache_Info     #       4
a1099 2
IOSystemType    #       1       ; 0 => old I/O subsystem, 1 => IOEB+82C710 system, 2..255 => ?

d1102 1
a1102 2
                AlignSpace
ProcessorFlags  #       4       ; Processor flags (IMB, Arch4 etc)
d1107 2
d1114 8
a1134 2
        ! 0, "Free space before DebuggerSpace = ":CC::STR:(&300-@@)

a1153 8
AppSpaceDANode  #       DANode_NodeSize ; Dummy area node for application space (not on list)
FreePoolDANode  #       DANode_NodeSize ; Area node for free pool
SysHeapDANode   #       DANode_NodeSize ; Area node for system heap
CDASemaphore    #       4               ; Semaphore for OS_ChangeDynamicArea - non-zero => routine threaded
MMUControlSoftCopy #    4               ; Soft copy of ARM600/700 control register

AplWorkSize * AppSpaceDANode + DANode_Size

d1178 1
a1178 1
IOAllocPtr      #       4
a1655 1
 [ :LNOT: HAL32
a1658 1
 ]
@


4.14.2.3
log
@partial video changes for kernel/HAL split
near-HAL code for VIDC/IOMD in vdu.vduhint
briefly tested in Ursula desktop build
still some kernel workspace dependency in near-HAL code

Version 5.35, 4.79.2.3. Tagged as 'Kernel-5_35-4_79_2_3'
@
text
@a487 15
; *** layout of a descriptor block for a display pointer shape ***

                  ^  0
PointerBlkHAL     #  0  ; fields up to private part passed to HAL
PointerWidth      #  1  ; actual (unpadded) shape width in bytes (from OS_Word 21)
PointerHeight     #  1  ; shape height in pixels
                  #  2  ; alignment padding
PointerBuffLA     #  4  ; logical address of shape buffer (up to 8 * 32 bytes)
PointerBuffPA     #  4  ; physical address of shape buffer
PointerBlkPrivate #  0  ; fields below here not used by HAL
PointerActiveX    #  1  ; active x in pixels from left
PointerActiveY    #  1  ; active y in pixels from top
                  #  2  ; alignment padding
PointerBlkSize    #  0

d574 1
a574 1
             # 4        ; SPARE (avoiding changes of exported addresses for now)
d689 3
a691 1
TempPlain # 16  ; only used for MODE 10 
d695 1
d697 1
d723 1
a723 1
HLineAddr      # 4      ; address of exported HLine
d726 4
a729 24
BlankPalAddr  # 4       ; address of block for blank palette
FirPalAddr    # 4       ; address of block for first flash state palette
SecPalAddr    # 4       ; address of block for second flash state palette

PointerShapes      # 0
PointerShape1      # 4  ; pointers to defined shapes 1 to 4
PointerShape2      # 4
PointerShape3      # 4
PointerShape4      # 4
PointerShapesH     # 0
PointerShapeH1     # 4  ; pointers to holding shapes 1 and 2 (so updates never hit shape given to HAL)
PointerShapeH2     # 4

PointerShapeBlocks # 6*PointerBlkSize ; room for the 6 shape descriptors themselves

PointerShapeLA     # 4               ; logical address of current shape buffer (owned by HAL)
PointerShapeNumber # 1               ; includes bit 7 linkage flag
                   # 3               ; alignment padding
PointerX           # 4               ; co-ordinates of pointer (not always = mouse)
PointerY           # 4

  ! 0, "PointerShapes @@ ":CC::STR:(PointerShapes)

                # 43*4 - 6*PointerBlkSize ; SPARE (avoiding changes of exported addresses for now)
d742 2
a743 1
                 # 2*4   ; SPARE (avoiding changes of exported addresses for now)
d789 11
a799 1
           # 8*4        ; SPARE (avoiding changes of exported addresses for now)
d877 3
a879 1
                # 3*4   ; SPARE (avoiding changes of exported addresses for now)
d1152 2
a1153 2
NVRamSize       #       1               ; Size of NVRam (E2ROM & CMOS) fitted in 256byte units
RTCFitted       #       1               ; flag =1 iff RTC is fitted
d1176 1
a1176 1
        ! 0, "Free space after EnvString = ":CC::STR:(&500-@@)
d1183 1
a1183 1
        ! 0, "Free space after CamMap debug block = ":CC::STR:((JordanWS+256*4)-@@)
a1245 6
    [ {TRUE}
mjs_tempHALworkspace  #  4       ; required only temporarily for semi-HALised code still in RO kernel
      ! 0, "*** mjs_tempHALworkspace should be removed when kernel/HAL split permits" 
; !!!! Free Space (36 bytes)
OldSWIHashspace    #  9*4
    |
a1247 1
    ]
a1600 4
; mjs Sep 2000, Kernel/HAL split
; Note that cursor data memory is expected to be uncacheable, since HAL may use it
; directly for h/w DMA. This may not be true since RO 3.7, but should be sorted
; eventually for next generation RO
d1602 1
a1602 1
CursorDataSize          *       &600            ; four defined shapes, plus 2 holding shapes
a1605 2

SPARE_oldCursorSpace    |#|     &200            ; padding to avoid changing exported addresses for now
@


4.14.2.4
log
@further kernel/HAL split work in video area
almost-HAL code for VIDC20/IOMD in vdu.vduhint, now almost divorced
from kernel workspace
tested briefly in Ursula desktop environment

Version 5.35, 4.79.2.4. Tagged as 'Kernel-5_35-4_79_2_4'
@
text
@d686 1
a686 1
        # 4             ; SPARE
d1033 3
a1035 1
                #       3*4     ; SPARE
d1107 1
a1107 2

     [ {FALSE} ;;; mjsHAL no LCD support
d1112 1
a1112 4
     |
                # 2  ; SPARE
     ]

@


4.14.2.5
log
@More HAL work. IOMD HAL fleshed out somewhat - system gets most of the way
through initialisation.

Version 5.35, 4.79.2.5. Tagged as 'Kernel-5_35-4_79_2_5'
@
text
@a239 4
AplWorkMaxSize      * &20000000 ; 512M - temporary (need to decide this at boot time)
ScreenEndAdr        * &24000000 ; temporary - run time allocate
FreePoolAddress     * &28000000 ; ditto

d241 1
d704 1
a704 3
TempPlain # 16  ; only used for MODE 10

VIDCClockSpeed # 4      ; current VIDC clock speed in kHz
d1268 1
a1268 1
      ! 0, "*** mjs_tempHALworkspace should be removed when kernel/HAL split permits"
@


4.14.2.6
log
@mjs macros switch on HAL for calling video code in HAL/pseudo HAL cases
vduhint code even more almost ready to move to HAL

Version 5.35, 4.79.2.6. Tagged as 'Kernel-5_35-4_79_2_6'
@
text
@d1271 1
a1271 2

    [ :LNOT: HAL
d1273 1
a1273 1
      ! 0, "*** mjs_tempHALworkspace should be removed when kernel/HAL split permits" 
a1279 1

@


4.14.2.7
log
@  Added HAL NVRAM support
Detail:
  Added the HAL NVRAM entries.
  Modified i2cutils to use the HAL entries for NVRAM and behave sensibly if the HAL reports that there is no NVRAM, in which case there must be a forced reset_cmos call so that the cache gets set up sensibly.
Admin:
  Tested under the RPC emulator and appears to be working correctly, although some calls to IIC are still being made in the no nvram case.

Version 5.35, 4.79.2.8. Tagged as 'Kernel-5_35-4_79_2_8'
@
text
@d1176 4
a1179 1
; NVRAM support
d1181 1
a1181 2
NVRamSize	#	1		; Size of NVRam (E2ROM & CMOS) fitted in 256byte units
RTCFitted	#	1		; flag =1 iff RTC is fitted
d1186 2
d1274 1
a1274 1
      ! 0, "*** mjs_tempHALworkspace should be removed when kernel/HAL split permits"
@


4.14.2.8
log
@More L7200 HAL work
@
text
@d240 1
a240 3
SVCStackAddress     * &01C00000

AplWorkMaxSize      * &01F00000 ; 31M - temporary (need to decide this at boot time)
d244 1
a244 1
RMAAddress          * &02100000 ; temporary - run time allocate
d247 1
a247 1
RMAMaxSize          * &00F00000 ; temporary - should be max
a251 1
 [ {FALSE}
a252 1
 ]
a255 1
 [ {FALSE}
a256 3
 |
CursorChunkAddress  * &01F00000
 ]
a258 1
 [ {FALSE}
a261 5
 |
SysHeapChunkAddress * &01C08000
SysHeapAddress      * SysHeapChunkAddress
SysHeapMaxSize      * &001F8000
 ]
@


4.14.2.9
log
@add some HAL_Video calls, attempt to deal with lack of h/w scroll

Version 5.35, 4.79.2.9. Tagged as 'Kernel-5_35-4_79_2_9'
@
text
@d779 1
a779 5
HWPixelFormats     # 4               ; pixel formats word from HAL
HWVideoFeatures    # 4               ; features word from HAL
HWBufferAlign      # 4               ; buffer alignment word from HAL

                # 40*4 - 6*PointerBlkSize ; SPARE (avoiding changes of exported addresses for now)
@


4.14.2.10
log
@More stuff. Up to the desktop now; cache on, working keyboard. Some source
restructuring to start to make splitting it up into several object files more
feasible.
@
text
@d732 1
a732 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
a776 1
 [ :DEF: ShowWS
a777 1
 ]
d782 1
d814 1
a814 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d873 1
a873 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d880 1
a880 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d887 1
a887 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d903 1
a903 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d925 1
a925 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d935 1
a935 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d954 1
a954 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d983 1
d988 2
a1064 1
 [ :DEF: ShowWS
a1067 1
 ]
a1072 1
 [ :DEF: ShowWS
a1074 1
 ]
a1078 1
 [ :DEF: ShowWS
a1081 1
 ]
a1109 1
 [ :DEF: ShowWS
a1110 1
 ]
a1124 1
 [ :LNOT: HAL
a1132 1
 [ :DEF: ShowWS
a1133 1
 ]
a1136 1
 ]
a1139 1
HAL_StartFlags  #       4
d1144 1
a1144 1
ICache_Info     #       0
d1153 1
a1153 1
DCache_Info     #       0
a1157 16

ProcessorArch   #       1

                AlignSpace

Proc_Cache_CleanInvalidateAll   #       4
Proc_Cache_CleanAll             #       4
Proc_Cache_InvalidateAll        #       4
Proc_TLB_InvalidateAll          #       4
Proc_TLB_InvalidateEntry        #       4
Proc_WriteBuffer_Drain          #       4
Proc_IMB_Full                   #       4
Proc_IMB_Range                  #       4
Proc_MMU_Changing               #       4
Proc_MMU_ChangingEntry          #       4

a1165 1
 [ :DEF: ShowWS
a1168 1
 ]
a1187 1
 [ :DEF: ShowWS
a1188 1
 ]
a1214 1
 [ :DEF: ShowWS
a1215 1
 ]
a1221 1
 [ :DEF: ShowWS
a1222 1
 ]
d1250 1
a1250 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
a1256 1
 [ :DEF: ShowWS
a1257 1
 ]
a1278 1
 [ :DEF: ShowWS
a1284 1
 ]
a1287 1
 [ :DEF: ShowWS
a1288 1
 ]
a1306 1
 [ :DEF: ShowWS
a1307 1
 ]
d1326 1
a1326 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
a1390 1
 [ :DEF: ShowWS
a1391 1
 ]
a1393 1
 [ :DEF: ShowWS
a1394 1
 ]
a1396 1
 [ :DEF: ShowWS
a1397 1
 ]
a1400 1
 [ :DEF: ShowWS
a1401 1
 ]
a1403 1
 [ :DEF: ShowWS
a1404 1
 ]
a1408 1
 [ :DEF: ShowWS
a1409 1
 ]
a1424 1
 [ :DEF: ShowWS
a1428 1
 ]
d1481 1
a1481 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d1516 1
a1516 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d1724 1
a1724 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
d1732 1
a1732 1
 [ AssemblingArthur :LAND: :DEF: ShowWS
@


4.14.2.11
log
@Stuff. A bit of touchscreen, I expect, and probably some other bits too.
@
text
@d242 1
a242 1
AplWorkMaxSize      * &01C00000 ; 28M - temporary (need to decide this at boot time)
@


4.14.2.12
log
@more use of ARMops in page manipulation, change register usage of ARmops
tested by kernel boot to star prompt only

Version 5.35, 4.79.2.11. Tagged as 'Kernel-5_35-4_79_2_11'
@
text
@a1183 2
Proc_MMU_ChangingUncached       #       4
Proc_MMU_ChangingUncachedEntry  #       4
@


4.14.2.13
log
@reintroduce Ursula AMBControl, recoded with generic ARMop style, not debugged yet

Version 5.35, 4.79.2.12. Tagged as 'Kernel-5_35-4_79_2_12'
@
text
@d1174 12
a1185 15
Proc_Cache_CleanInvalidateAll     #       4
Proc_Cache_CleanAll               #       4
Proc_Cache_InvalidateAll          #       4
Proc_Cache_RangeThreshold         #       4
Proc_TLB_InvalidateAll            #       4
Proc_TLB_InvalidateEntry          #       4
Proc_WriteBuffer_Drain            #       4
Proc_IMB_Full                     #       4
Proc_IMB_Range                    #       4
Proc_MMU_Changing                 #       4
Proc_MMU_ChangingEntry            #       4
Proc_MMU_ChangingUncached         #       4
Proc_MMU_ChangingUncachedEntry    #       4
Proc_MMU_ChangingEntries          #       4
Proc_MMU_ChangingUncachedEntries  #       4
@


4.14.2.14
log
@Check-in of the few last-minute changes for the Customer L demo. Nothing
exciting, apart from an extended touchscreen API.

Version 5.35, 4.79.2.13. Tagged as 'Kernel-5_35-4_79_2_13'
@
text
@d1688 3
d1693 1
d1697 4
d1708 1
@


4.14.2.15
log
@First attempt at ARM9 support, and general clean-up of old ARM-specific
code, now using vectored ARMops.
Not tested.

Version 5.35, 4.79.2.14. Tagged as 'Kernel-5_35-4_79_2_14'
@
text
@a259 1
DCacheCleanAddress  * &FAF00000 ; eg. for StrongARM, 256k of space, up to FAF40000
d1155 14
a1168 18
ICache_Info            #  0
ICache_NSets           #  4
ICache_Size            #  4
ICache_LineLen         #  1
ICache_Associativity   #  1

Cache_Type             #  1
Cache_Flags            #  1

DCache_Info            #  0
DCache_NSets           #  4
DCache_Size            #  4
DCache_LineLen         #  1
DCache_Associativity   #  1
                       #  2
DCache_IndexBit        #  4
DCache_IndexSegStart   #  4
DCache_RangeThreshold  #  4
d1170 1
a1170 1
ProcessorArch          #  1
@


4.14.2.16
log
@Customer L-y HAL-y IIC-y type stuff. It's great.
@
text
@d724 1
a724 1
VIDCClockSpeed # 4      ; current VIDC clock speed in kHz (now always zero)
@


4.14.2.17
log
@spectacular new OS_Memory reason codes
13 map permanent I/O space, return logical address
14 access temporary physical mapping
15 release temporary physical mapping
DA creation and I/O space creation now avoid collision if address
space fills

Version 5.35, 4.79.2.28. Tagged as 'Kernel-5_35-4_79_2_28'
@
text
@a250 1
IOLimit             * &BA000000 ; initial lower limit on room for IO space (DA creation may move limit up)
d1237 2
a1238 2
NVRamSize       #       1               ; Size of NVRam (E2ROM & CMOS) fitted in 256byte units
RTCFitted       #       1               ; flag =1 iff RTC is fitted
a1264 3
IOAllocPtr      #       4               ; current lowpoint of mapped I/O space (also upper limit on DAs) 
IOAllocLimit    #       4               ; current lowest allowed I/O space (DA creation may move this up)

d1282 1
a1282 1
                #       4       ; spare
@


4.14.2.18
log
@Moved IOAllocPtr and IOAllocLimit to SkippedTables - the ARM9 got away with
it because of the writeback cache, but poor souls like Simon condemned to
an eternity of the ARM7 were a bit stuffed.

Version 5.35, 4.79.2.34. Tagged as 'Kernel-5_35-4_79_2_34'
@
text
@a1209 3
IOAllocPtr      #       4               ; current lowpoint of mapped I/O space (also upper limit on DAs)
IOAllocLimit    #       4               ; current lowest allowed I/O space (DA creation may move this up)

d1265 3
@


4.14.2.19
log
@Merge in long command line support from Ursula kernel.
Look for LongCommandLine flag, command line size currently
set at 1k.
For HAL/32bit builds, the kernel buffer space is at high
(top bit set) address, which may break some code using signed
comparisons. So *beware* that there may be some latent
bugs in old kernel code using these buffers, not yet found.
One such bug, in s.Arthur2 found and fixed.
Tested moderately on ARM9 desktop build.
Lovely to reimplement things I did two and half years ago.

Version 5.35, 4.79.2.37. Tagged as 'Kernel-5_35-4_79_2_37'
@
text
@d239 2
a240 1
KbuffsMaxSize       *  64*1024
a256 2
 |
SVCStackAddress     * &01C00000
a261 1
KbuffsBaseAddress   * &FAF40000 ; kernel buffers for long command lines, size KbuffsMaxSize
a311 3
;following dynamic area only used if LongCommandLines is {TRUE}
KbuffsBaseAddress  * &2078000   ;just above reserved area for fake 480k screen
KbuffsMaxSize      * &0088000   ;544k (takes us up to start of RMA)
a1257 3
  [ LongCommandLines
OldEnvString      #     256         ;spare
  |
a1258 1
  ]
a1380 3
  [ LongCommandLines
OldGeneralMOSBuffer # 256+4      ;spare
  |
a1381 1
  ]
d1646 2
a1647 4
  [ LongCommandLines
OldAliasExpansionBuffer #       100     ;spare, mjs: shouldn't this have been &100 ??!??
  |
AliasExpansionBuffer    #       100     ;mjs: shouldn't this be &100 ??!??
a1648 2
ArgumentBuffer          *       AliasExpansionBuffer
  ]
d1650 1
a1656 3
  [ LongCommandLines
    ;ExprBuff moved to Kernel buffers area
  |
a1657 1
  ]
d1661 1
a1662 6
  [ LongCommandLines
    ;exprSTRACC moved to Kernel buffers area
ExprStackLimit          *       @@ - exprBracDif + ExprWSpace + &100   ;keep 256 buffer zone for stack overflow
ExprStackStart          *       ScratchSpace + ScratchSpaceSize
  |
exprSTRACC              *       @@ - ExprBuff + ExprWSpace
a1664 1
  ]
a1768 3
  [ LongCommandLines
OldOscliBuffs           |#|     (16+1)*&100   ;spare
  |
a1773 1
  ]
a1822 47


; *****************************************************************************

  [ LongCommandLines

    ASSERT            LongCLISize >= 256+4     ;minimum size of GeneralMOSBuffer

;Kernel buffers area

                      ^  KbuffsBaseAddress

GeneralMOSBuffer      #  LongCLISize

EnvString             #  LongCLISize

AliasExpansionBuffer  #  LongCLISize
ArgumentBuffer        *  AliasExpansionBuffer

ExprBuff              #  LongCLISize
exprSTRACC            #  LongCLISize

OscliBuffSize         *  LongCLISize
OscliNoBuffs          *  16
RedirectBuff          #  OscliBuffSize
OscliCircBuffStart    #  OscliBuffSize * OscliNoBuffs
OscliCircBuffLimit    #  0

KbuffsEnd             #  0
KbuffsSize            *  KbuffsEnd - KbuffsBaseAddress  ;size of Kernel buffers area

    ASSERT            KbuffsSize <= KbuffsMaxSize

      ! 0, "Kbuffs                at ":CC::STR:(KbuffsBaseAddress)
      ! 0, "Kbuffs Size           is ":CC::STR:(KbuffsSize)

      ! 0, "GeneralMOSBuffer      at ":CC::STR:(GeneralMOSBuffer)
      ! 0, "EnvString             at ":CC::STR:(EnvString)
      ! 0, "AliasExpansionBuffer  at ":CC::STR:(AliasExpansionBuffer)
      ! 0, "ArgumentBuffer        at ":CC::STR:(ArgumentBuffer)
      ! 0, "ExprBuff              at ":CC::STR:(ExprBuff)
      ! 0, "exprSTRACC            at ":CC::STR:(exprSTRACC)
      ! 0, "RedirectBuff          at ":CC::STR:(RedirectBuff)
      ! 0, "OscliCircBuffStart    at ":CC::STR:(OscliCircBuffStart)

  ] ;LongCommandLines

@


4.14.2.20
log
@Reimplement enhancements to kernel Dynamic Area support from
Ursula. Quite a hairy code merge really, so let's hope it is
worth it to someone. What you get (back after 2 or 3 years):
- much more efficient for largish numbers of DAs (relevance
  to current build = approx 0)
- fancy reason codes to support fast update of
  Switcher bar display (relevance = 0)
- support for clamped maximum area sizes, to avoid address
  space exhaustion with big memory (relevance = 0)
- better implementation of shrinkable DAs, performance
  wise (if lots of DAs, relevance = approx 0)
- support for 'Sparse' DAs. Holey dynamic areas, Batman!
  (relevance, go on someone use the darned things)
Moderately development tested on HAL/32bit ARM9 desktop.
Note the Switcher should be compiled to use the new
reason codes 6&7, for fabled desktop builds.

Also, during this work, so I could see the wood for the
trees, redid some source code clean up, removing pre-Medusa
stuff (like I did about 3 years ago on Ursula, sigh). That's
why loads of source files have changed. The new DA stuff
is confined pretty much to hdr.KernelWS and s.ChangeDyn.

Ta.

Version 5.35, 4.79.2.38. Tagged as 'Kernel-5_35-4_79_2_38'
@
text
@d216 1
a216 14
                  ^     0
DANode_Link       #     4               ; points to next node
DANode_Number     #     4               ; number of this area
DANode_Base       #     4               ; base address of area (points in middle of doubly-mapped areas)
DANode_Flags      #     4               ; various flags
DANode_Size       #     4               ; current size of area (not counting holes, if Sparse area)
DANode_MaxSize    #     4               ; maximum size of area
DANode_Workspace  #     4               ; workspace pointer when calling handlers
DANode_Handler    #     4               ; pointer to handler routine for area
DANode_Title      #     4               ; pointer to area title
DANode_SubLink    #     4               ; next node in any disjoint sublist (currently used for Shrinkables only)
DANode_SparseHWM  #     4               ; high water mark, if Sparse area (highest base+size claimed for area)
DANode_SortLink   #     4               ; next node in alphabetically sorted list
DANode_NodeSize   #     0
d218 10
d1067 1
a1067 1
DynArea_ws      #       4       ; workspace anchor word for data structures to accelerate OS SWIs for dynamic areas
d1071 2
a1072 2
 ! 0, "AMBControl_ws         at ":CC::STR:(AMBControl_ws)
 ! 0, "DynArea_ws            at ":CC::STR:(DynArea_ws)
d1229 1
a1229 1
ProcVec_AddrEx          #       4       ; not used (was Address exception vector on 26-bit-only ARMs)
d1259 1
a1259 1
MMUControlSoftCopy #    4               ; Soft copy of ARM control register
d1263 3
a1265 1
  [ :LNOT: LongCommandLines
d1884 1
a1884 1
    ASSERT            ((KbuffsSize + &FFF) :AND: &FFFFF000) <= KbuffsMaxSize
a1888 1
    [ {FALSE}
a1896 1
    ]
@


4.14.2.21
log
@1) Bring IOMD HAL more up to date. Add support for new
call HAL_CleanerSpace (preparation for StrongARM kernel
support).

2) In kernel, add HAL_CleanerSpace call (preparation for
StrongARM and XScale core support). Fix bug found with
ARMv3 support during test on Risc PC.

3) Implement new API for kernel SWIs that have used top
bits of addresses as flags. The new API has an extra
flag that must be set, so kernel can distinguish and
support both APIs. The reason for all this is that
addresses are 32-bits now, people, keep up there. Briefly:

  OS_HeapSort
    bit 31 of r0 set for new API, r1 is full 32-bit address
    flags move from r1 bits 31-29 to r0 bits 30-28

  OS_ReadLine
    bit 31 of r1 set for new API, r0 is full 32-bit address
    flags move from bits 31,30 of r0 to bits 30,29 of r1

  OS_SubstituteArgs
    bit 31 of r2 set for new API, r0 is full 32-bit address
    flag moves from bit 31 of r0 to bit 30 of r2

Tested on Risc PC and briefly on Customer A 2

Ta

Version 5.35, 4.79.2.41. Tagged as 'Kernel-5_35-4_79_2_41'
@
text
@d238 4
a241 4
SVCStackSize        *  32*1024
IRQStackSize        *   8*1024
ABTStackSize        *   8*1024
UNDStackSize        *   8*1024
a242 1
DCacheCleanSize     * 256*1024  ;should be multiple of 64k
@


4.14.2.22
log
@StrongARM is back, and this time it's provisional!

IOMD HAL:
  enables fast clock for StrongARM on Medusa h/w

Kernel:
  ARMops for StrongARM implemented. Tested moderately on
  HAL/32-bit minimal desktop build for Risc PC. Could do
  with more testing later. eg. does reentrant cache
  cleaning support really work?
  Lazy task swapping is enabled for revT or later, wahey.

Version 5.35, 4.79.2.42. Tagged as 'Kernel-5_35-4_79_2_42'
@
text
@d1166 5
a1170 5
ICache_Info              #  0
ICache_NSets             #  4
ICache_Size              #  4
ICache_LineLen           #  1
ICache_Associativity     #  1
d1172 2
a1173 2
Cache_Type               #  1
Cache_Flags              #  1
d1175 9
a1183 6
DCache_Info              #  0
DCache_NSets             #  4
DCache_Size              #  4
DCache_LineLen           #  1
DCache_Associativity     #  1
                         #  2
d1185 1
a1185 7
DCache_CleanBaseAddress  #  0   ; word used either for IndexBit or CleanBaseAddress
DCache_IndexBit          #  4
DCache_CleanNextAddress  #  0   ; word used either for IndexSegStart or CleanNextAddress
DCache_IndexSegStart     #  4
DCache_RangeThreshold    #  4

ProcessorArch            #  1
@


4.14.2.23
log
@Lots of Tungsten work.

Version 5.35, 4.79.2.48. Tagged as 'Kernel-5_35-4_79_2_48'
@
text
@d246 1
a246 1
;ScreenEndAdr        * &24000000 ; temporary - run time allocate
d252 1
a252 1
RMAMaxSize          * &01700000 ; temporary - should be max
d714 1
a714 1
ScreenEndAddr # 4       ; Logical address of screen (start of 2nd copy)
a791 1
 [ :LNOT: UseGraphicsV
a795 3
 |
                # 43*4 - 6*PointerBlkSize ; SPARE (avoiding changes of exported addresses for now)
 ]
a883 1
ExternalFramestore # 1  ; NZ => using external framestore rather than screen memory DA
d990 2
a991 2
InitIRQHandler  #       4               ; pointer to IRQ handler (LDR PC'ed from IRQ HW vector)
InitIRQWs       #       16              ; workspace for IRQ handler
d1129 1
a1129 3
 [ HAL
VRAMFlags       #       4       ; Flags of VRAM block (from HAL's AddRAM call)
 |
a1191 2
MMU_PCBTrans             #  4

d1253 13
a1265 16
NVRamSize          #    1               ; Size of NVRam (E2ROM & CMOS) fitted in 256byte units
RTCFitted          #    1               ; flag non zero if RTC is fitted
NVRamBase          #    1               ; Base of NVRam
NVRamSpeed         #    1               ; Clock hold time in 0.5s units
NVRamPageSize      #    1               ; Page size for writing (log2)
NVRamWriteSize     #    1               ; Size of writable region (256byte units)

                   AlignSpace

IICType            #    4
IICStatus          #    4

AppSpaceDANode     #    DANode_NodeSize ; Dummy area node for application space (not on list)
FreePoolDANode     #    DANode_NodeSize ; Area node for free pool
SysHeapDANode      #    DANode_NodeSize ; Area node for system heap
CDASemaphore       #    4               ; Semaphore for OS_ChangeDynamicArea - non-zero => routine threaded
d1271 1
a1271 1
EnvString          #    256
d1768 1
a1768 1
SWIDespatch_Size        *       32*4
d1770 1
a1770 1
SWIDespatch_Size        *       30*4    ; can save 2 instructions if 26-bit (no Thumb)
@


4.14.2.24
log
@  Mostly device stuff.
Detail:
  * Implemented OS_Hardware 2, 3 and 4 as described in Docs.HAL.NewAPI.
  * Added new OS->HAL and HAL->OS routines to register HAL devices with the
    OS during hard resets.
  * Updated Docs.HAL.NewAPI to correct inconsistencies, fill in missing
    definitions, and allow for interrupt sharing.
  * Now uses OS_LeaveOS to trigger callbacks after ROM module init.
Admin:
  Untested. Requires new HAL.

Version 5.35, 4.79.2.49. Tagged as 'Kernel-5_35-4_79_2_49'
@
text
@a1278 4
 [ HAL
DeviceCount     #       4       ; size of our table of devices in the system heap
DeviceTable     #       4       ; pointer to table
 ]
@


4.14.2.25
log
@  Commit of kernel as featured in release 5.00.
Detail:
  Lots of changes since last version, at least the following:
  * Updated OS timestamp, removed alpha status
  * Negative INKEY OS version changed to &AA
  * GraphicsV is now alocated vector number &2A
  * ROM moved up to &FC000000
  * Max application slot increased to 512 Mbytes (for now)
  * Max size of RMA increased to 256 Mbytes
  * RMA is now first-created dynamic area (so it gets lowest address after
    top of application slot)
  * OS_Memory 10 reimplemeted
  * New OS_ReadSysInfo 6 values 18-22 added
  * OS_ReadSysInfo 8 gains flag bit to indicate soft power-off
  * Misc internal top-bit-set-address fixes
  * *ChangeDynamicArea can take sizes in megabytes or gigabytes
  * Magic word "&off" in R0 passed to OS_Reset powers down if possible
  * Added acceleration: block copy; CLS; text window scroll up; rectangle
    fill
  * Disabled LED flashing in page mode (liable to crash)
  * Masked sprite plot and VDU 5 text avoids reading the screen if possible
  * Framestore made USR mode accessible
  * Fix for VDU 5,127 bug - now relies on font definitions being in extreme
    quarters of memory, rather than bottom half
  * Allocated 64-bit OS_Convert... SWIs
  * IIC errors use allocated error numbers
  * Looks for Dallas RTC before Philips RTC because we're using a Philips
    NVRAM device with the same ID
  * Fix to bug that meant the oscillator in the Dallas RTC wasn't enabled
  * Default mouse type (USB) changed to allocated number
  * Ram disc max size increased to 128 Mbytes (Ursula merge) and made
    cacheable for StrongARMs (not XScale)
  * Branch through zero handler now works in USR mode, by use of a
    trampoline in the system stack to allow PC-relative register storage
  * Address exception handler changed to not use 0 as workspace
  * OS_Memory 13 extended to allow specification of cacheability and access
    privileges
  * Added OS_Memory 16 to return important memory addresses
  * RISCOS_MapInIO() takes cacheable flag in bit 3, access permissions in
    bits 10 and 11, doubly-mapped flag in bit 20, and access permissions
    specified flag in bit 21
  * Bug fix in last version for application abort handlers didn't quite
    work; register shuffle required
  * "Module is not 32-bit compatible" error now reports the module name
  * Default configured language changed from 10 to 11 (now Desktop again)

Version 5.35, 4.79.2.51. Tagged as 'Kernel-5_35-4_79_2_51'
@
text
@d245 1
a245 1
AplWorkMaxSize      * &20000000 ; 512M - temporary (need to decide this at boot time)
d247 1
d249 1
a249 1
RMAAddress          * AplWorkMaxSize ; temporary - run time allocate?
d252 1
a252 1
RMAMaxSize          * &10000000 ; 256M
a253 1
FreePoolAddress     * RMAAddress + RMAMaxSize
a256 1
HALWorkspaceSpace   * &00100000
d258 1
a258 1
 [ {TRUE}
d268 1
a268 1
 [ {TRUE}
d275 1
a275 1
 [ {TRUE}
a284 1
CAMspace            * 8*1024*1024 ; enough for 4GB of RAM
a1084 10
; [ this was used on Phoebe as described below, now only used for Wimp free pool lock ]
; word controlling rescue of VRAM that is not used by screen (and sorting into bottom of free pool) - VRAM is slower than SDRAM for Phoebe.
; word organised as 3 fields - control field (byte) is not written by interrupt routine, so can be safely manipulated by foreground with IRQs enabled
VRAMRescue_control    # 1            ; control bits manipulated by foreground, read by interrupt driven rescuer
                                     ; Bit fields of VRAMRescue_control (VRRc_...) defined as follows:
                                     ;
VRRc_disable            * &01        ;   control bit  0      slow page rescue from Free Pool disabled completely, if set (disabled for no VRAM)
VRRc_suspend            * &02        ;   control bit  1      slow page rescue suspended by outside agent, if set
VRRc_wimp_lock          * &04        ;   control bit  2      slow page rescue suspended because Wimp_ClaimFreeMemory has claimed free pool, if set
                                     ;   control bits 3..7   reserved (should be 0)
a1135 1
L2PTUsed        #       4       ; Amount of memory used for L2PT
a1195 10
 ]
IOSystemType             #  1   ; 0 => old I/O subsystem, 1 => IOEB+82C710 system, 2..255 => ?
ProcessorType            #  1   ; Processor type (handles 600 series onwards)
                AlignSpace
ProcessorFlags           #  4    ; Processor flags (IMB, Arch4 etc)
 [ :DEF: ShowWS
 ! 0, "ProcessorType  at  ":CC::STR:(ProcessorType)
 ! 0, "ProcessorFlags at  ":CC::STR:(ProcessorFlags)
 ]
 [ HAL
d1219 11
d1772 7
a1778 3
BranchToSWIExit         |#|     4

SvcTable                |#|     &400
d1863 3
a1865 1
SVCSTK                 #       0
d1868 1
a1868 1
SysHeapStart           *       SysHeapAddress
d1870 1
a1870 1
SysHeapStart           #       0
d1872 2
@


4.14.2.26
log
@Support for keys held down in the HAL at power on.
*Configure ANYTHINGsize was broken due to not setting R0 to ReadUnsigned
IIC ack message uninternationalised
OS_Memory was saying we only had 4M of RAM
VDU4 scrolling when output was switched to sprite was causing corruption
on use of CTRL-J and CTRL-K
Default SystemSize CMOS set to 32k

Version 5.35, 4.79.2.55. Tagged as 'Kernel-5_35-4_79_2_55'
@
text
@a268 1
HALWorkspaceNCNB    * &FAFE8000 ; 32K of uncacheable HAL workspace (if requested)
@


4.14.2.27
log
@  Miscellaneous stuff.
Detail:
  * Merged in the change to RISC OS 4.02 kernel that moved the GSTrans
    workspace out of scratch space.
  * Fixed a few bugs in callback postponement, and interrupt holes in
    callback dispatch. See Docs.CallbackChange for full info.
  * Fixed SystemSizeCMOS to SysHeapCMOS - wouldn't build as was.
  * Added an export of a C version of Hdr:HALDevice, based on the Hdr2H
    translation but with an additional struct definition. Required by
    SoundControl 1.00.
  * Added some additional location and ID allocations to Hdr:HALDevice.
    Required by today's HAL and SoundControl.
Admin:
  Partially tested.

Version 5.35, 4.79.2.56. Tagged as 'Kernel-5_35-4_79_2_56'
@
text
@a1661 4
 [ GSWorkspaceInKernelBuffers
; the GSTrans workspace has now moved to the kernel buffers area
; GSInit and GSRead may now safely be called from USR mode wahey...
 |
a1665 1
 ]
a1672 3
 [ GSWorkspaceInKernelBuffers
; GSVarWSpace is now in kernel buffers
 |
a1673 1
 ]
a1679 3
 [ GSWorkspaceInKernelBuffers
GSVarWSpace_Size	#	0
 ]
a1905 6

 [ GSWorkspaceInKernelBuffers
GSVarWSpace           #  GSVarWSpace_Size

SysVarWorkSpace	      #  40		; used by the sys$* variables for reading the current time into
 ]
@


4.14.2.28
log
@Huge update to L7200 HAL for Customer M 2 demo - now runs with 5.02 Kernel
used in Tungsten.
Added "fast" flash tool for Customer L, allowing ROMs to be sent serially at
115200 baud not 9600 baud.
Fix to VDU despatch for ARMv4 and later.
Fixes to power on delete keyboard and keyboard timeout
Implemented MemoryReadPhys and MemoryAmounts with the HAL.

Version 5.35, 4.79.2.59. Tagged as 'Kernel-5_35-4_79_2_59'
@
text
@d1329 1
a1329 1
ROMPhysAddr     #       4
@


4.14.2.29
log
@* HAL can choose to limit amount of screen memory to allocate
  [Not fully implemented - for now leaves at least 16MB free if only
  one RAM area; was 1MB].
* Added HAL_USBControllerInfo, HAL_MonitorLeadID and HAL_Video_Render.
* Added HAL->OS call OS_IICOpV.
* OS_MMUControl now allows independent control of I and C bits.
* Added facility to deactivate keyboard debounce (magic word "NoKd" in
  R2 in KeyV 0).
* Fixed problem with RAM amounts not a multiple of 4MB.
* Supremacy bit (in VDU 19) now sets all 8 bits of supremacy.
* Added PaletteV 14 (reads gamma tables).
* Added Supremacy transfer functions (like gamma correction, but for
  supremacy). Allows easy global supremacy effects in a mode-independent
  fashion. Controlled with PaletteV 15,16.
* Added modes 50-53 (320x240, 1,2,4,8bpp). Intended for small LCD.
* Added 13.5kHz versions of TV modes (selected by Hdr:Machine).
* Upped desktop version to 5.06.

Version 5.35, 4.79.2.66. Tagged as 'Kernel-5_35-4_79_2_66'
@
text
@a794 1
HALVideoFeatures   # 4               ; features word from HAL
d797 1
d801 1
a801 1
                # 42*4 - 6*PointerBlkSize ; SPARE (avoiding changes of exported addresses for now)
@


4.14.2.30
log
@  Added four new VDU variables.
Detail:
  174: left border size
  175: bottom border size
  176: right border size
  177: top border size
Admin:
  Not tested.

Version 5.35, 4.79.2.68. Tagged as 'Kernel-5_35-4_79_2_68'
@
text
@a742 5
BorderL # 4             ; Size of border
BorderB # 4
BorderR # 4
BorderT # 4

d799 1
a799 1
                # 36*4 - 6*PointerBlkSize ; SPARE (avoiding changes of exported addresses for now)
d801 1
a801 1
                # 38*4 - 6*PointerBlkSize ; SPARE (avoiding changes of exported addresses for now)
@


4.14.2.31
log
@Update the method the HAL kernel uses to determine the UtilityModule & ROM dates
Detail:
  Three main changes:
  * On odd-numbered (i.e. development) versions of the module, the UtilityModule will now take its date from the VersionNum file instead of using a hard-coded date
  * All build versions now look for the new "extended ROM footer" (as created by romlinker 0.04+) at the end of the ROM image and use it to determine the ROM build date for return by OS_ReadSysInfo 9,2. Failing to find the build date in the footer will cause OS_ReadSysInfo 9,2 to return 0.
  * On odd-numbered versions, OS_Byte 0 will now use the ROM build date (as found in the extended footer) to generate the error block that's returned to the user. This seems OK as the PRM describes OS_Byte 0 as returning the "creation date of the operating system". Plus it's a convenient way of getting the ROM build date into the Switcher, since the switcher uses OS_Byte 0. If the extended footer can't be found (or if the string isn't initialised yet, e.g. before Service_PostInit) the code falls back to a hard-coded string containing the date from the VersionNum file.
  File changes:
  Makefile - Updated to not create the obsolete Time+Date file (previously used for the ROM build date)
  Version - Use date from VersionNum file for development builds
  hdr/Options - New UseNewFX0Error variable/option to make it easy to check which OS_Byte 0 variant should be enabled
  hdr/KernelWS - Added new string buffers & extended ROM footer pointer to workspace
  s/Middle - Updated OS_ReadSysInfo 9 code, and added utility functions for searching the extended ROM footer for certain tags
  s/NewReset - Added a couple of calls to initialise the new string buffers just prior to Service_PostInit. This is required since OS_Byte/OS_ReadSysInfo shouldn't enable interrupts, but date conversion relies on the Territory module, which may enable interrupts.
  s/PMF/osbyte - Updated OS_Byte 0 code
Admin:
  Tested in Tungsten ROM, with and without the extended footer present.


Version 5.35, 4.79.2.115. Tagged as 'Kernel-5_35-4_79_2_115'
@
text
@a1307 2
ExtendedROMFooter # 4 ; Pointer to the extended ROM footer structure. 0 if not initialised, -1 if not found.

a1929 5
ROMBuildDate          #  128
 [ UseNewFX0Error
NewFX0Error           #  64
 ]

@


4.14.2.32
log
@Add new OS_ReadSysInfo 6 items codes. Change naming of PublicWS values.
Detail:
  s/Middle - Added some new OS_ReadSysInfo 6 items which are needed by the zero page relocation kernel. Also duplicated some existing entries to avoid conflicts with ROL's allocations.
  hdr/OSRSI6, Makefile - New header listing OS_ReadSysInfo 6 items
  hdr/PublicWS - Duplicated the workspace definitions for &0-&4000, but with a 'Legacy_' prefix to their names. Also added some new entries as needed by the zero page relocation kernel. Once existing modules have been updated to use OS_ReadSysInfo & the Legacy_ definitions, the old defs will be removed.
  hdr/KernelWS - Removed 'Export_' prefix from all the exported workspace values, since the kernel can now use the original names directly
  hdr/Options - Dummy HiProcVecs option so merging things will be a bit cleaner
Admin:
  Tested in ROM softload on Iyonix


Version 5.35, 4.79.2.118. Tagged as 'Kernel-5_35-4_79_2_118'
@
text
@a233 3
 [ HiProcVecs
ZeroPage            * &FFFF0000
 |
a234 1
 ]
d822 1
a822 4
ScreenBlankFlag # 1     ; 0 => unblanked, 1 => blanked

        ASSERT  ScreenBlankFlag =  Legacy_ScreenBlankFlag
        ASSERT ?ScreenBlankFlag = ?Legacy_ScreenBlankFlag
d824 12
a835 7
ScreenBlankDPMSState # 1       ; 0 => just blank video
                               ; 1 => blank to stand-by (hsync off)
                               ; 2 => blank to suspend (vsync off)
                               ; 3 => blank to off (H+V off)

        ASSERT  ScreenBlankDPMSState =  Legacy_ScreenBlankDPMSState
        ASSERT ?ScreenBlankDPMSState = ?Legacy_ScreenBlankDPMSState
d843 7
a849 7
FgEcfOraEor # 4*16      ; Interleaved zgora & zgeor
        ASSERT  FgEcfOraEor =  Legacy_FgEcfOraEor
        ASSERT ?FgEcfOraEor = ?Legacy_FgEcfOraEor

BgEcfOraEor # 4*16      ; Interleaved zgora & zgeor
        ASSERT  BgEcfOraEor =  Legacy_BgEcfOraEor
        ASSERT ?BgEcfOraEor = ?Legacy_BgEcfOraEor
d1002 1
a1002 3
; Note that these are all relative to ZeroPage!

                ^       &80             ; steer clear of FIQ code
d1014 1
a1014 1
                       ^       &100
d1017 7
a1023 7
ESC_Status             #       1       ; &104
        ASSERT  ESC_Status =  Legacy_ESC_Status
        ASSERT ?ESC_Status = ?Legacy_ESC_Status

LatchBSoftCopy         #       1       ; &105
        ASSERT  LatchBSoftCopy =  Legacy_LatchBSoftCopy
        ASSERT ?LatchBSoftCopy = ?Legacy_LatchBSoftCopy
d1027 7
a1033 7
CannotReset            #       1       ; &107
        ASSERT  CannotReset =  Legacy_CannotReset
        ASSERT ?CannotReset = ?Legacy_CannotReset

IRQsema                #       4       ; &108
        ASSERT  IRQsema =  Legacy_IRQsema
        ASSERT ?IRQsema = ?Legacy_IRQsema
a1035 3
        ASSERT  MetroGnome =  Legacy_MetroGnome
        ASSERT ?MetroGnome = ?Legacy_MetroGnome

d1038 3
a1040 3
MEMC_CR_SoftCopy       #      4       ; &114
        ASSERT  MEMC_CR_SoftCopy =  Legacy_MEMC_CR_SoftCopy
        ASSERT ?MEMC_CR_SoftCopy = ?Legacy_MEMC_CR_SoftCopy
d1276 1
a1276 10
 [ :LNOT: HiProcVecs
DebuggerSpace           #       16*8    ; Debugger module needs some zero page
DebuggerSpace_Size      *       ?DebuggerSpace

        ASSERT  DebuggerSpace =  Legacy_DebuggerSpace
        ASSERT ?DebuggerSpace = ?Legacy_DebuggerSpace
 |
DebuggerSpace           *       &2000   ; Debugger gets a page all to itself!
DebuggerSpace_Size      *       &1000
 ]
d1472 7
a1478 7
RedirectInHandle   #    1
        ASSERT  RedirectInHandle =  Legacy_RedirectInHandle
        ASSERT ?RedirectInHandle = ?Legacy_RedirectInHandle

RedirectOutHandle  #    1
        ASSERT  RedirectOutHandle =  Legacy_RedirectOutHandle
        ASSERT ?RedirectOutHandle = ?Legacy_RedirectOutHandle
a1615 2
        ASSERT  CLibCounter =  Legacy_CLibCounter
        ASSERT ?CLibCounter = ?Legacy_CLibCounter
a1624 3
        ASSERT  RISCOSLibWord =  Legacy_RISCOSLibWord
        ASSERT ?RISCOSLibWord = ?Legacy_RISCOSLibWord

a1625 3
        ASSERT  CLibWord =  Legacy_CLibWord
        ASSERT ?CLibWord = ?Legacy_CLibWord

a1626 2
        ASSERT  FPEAnchor =  Legacy_FPEAnchor
        ASSERT ?FPEAnchor = ?Legacy_FPEAnchor
d1628 3
a1630 3
DomainId                #       4       ; SKS added for domain identification
        ASSERT  DomainId =  Legacy_DomainId
        ASSERT ?DomainId = ?Legacy_DomainId
d1634 3
a1636 3
VduDriverWorkSpace      #       VDWSSize
        ASSERT  VduDriverWorkSpace =  Legacy_VduDriverWorkSpace
        ASSERT ?VduDriverWorkSpace = ?Legacy_VduDriverWorkSpace
a1811 1
   [ ZeroPage = 0
a1812 3
   |
SWIDespatch_Size        *       33*4
   ]
@


4.14.2.33
log
@Merge Cortex kernel into HAL branch
Detail:
  This is a full merge of the Cortex kernel back into the HAL branch. Since the Cortex kernel is/was just a superset of the HAL branch, at this point in time both branches are identical.
  Main features the HAL branch gains from this merge:
  - ARMv6/ARMv7 support
  - High processor vectors/zero page relocation support
  - objasm 4 warning fixes
  - Improved HAL related functionality:
    - Support for HAL-driven RTCs instead of kernel-driven IIC based ones
    - Support for arbitrary size machine IDs
    - Support for multiple IIC busses
    - Support for any HAL size, instead of hardcoded 64k size
    - Probably some other stuff I've forgotten
  - Probably a few bug fixes here and there
Admin:
  Tested on BB-xM & Iyonix.
  Was successfully flashed to ROM on an Iyonix to test the Cortex branch implementation of the 2010 RTC bug fix.
  IOMD build untested - but has been known to work in the past.


Version 5.35, 4.79.2.123. Tagged as 'Kernel-5_35-4_79_2_123'
@
text
@a995 8
; IIC bus info block

               ^ 0
IICBus_Type    # 4 ; Bus type (HAL_IICType)
IICBus_Status  # 4 ; Bus status (HAL_IICMonitorTransfer)
IICBus_Device  # 4 ; Bus device (HAL_IICDevice)
IICBus_Size    # 0

a1276 2
RTCFitted          #    4               ; =0 no RTC, <2048 = address of I2C RTC, >=2048 = HALDevice_RTC ptr

d1297 1
d1299 1
a1299 1
NVRamSpeed         #    1               ; Clock hold time in 0.5us units
d1305 2
a1306 2
IICBus_Count       *    3 ; 3 busses is enough for all current machines
IICBus_Base        #    IICBus_Size*IICBus_Count
a1315 3
Cache_Lx_Info   #       4       ; Cache level ID register
Cache_Lx_DTable #       4*7     ; Data/unified cache layout for all 7 levels
Cache_Lx_ITable #       4*7     ; Instruction cache layout for all 7 levels
a1887 3
 [ HAL :LAND: M_CortexA9
DefIRQ1Vspace           *       12*160+128
 |
a1892 1
 ] ; HAL :LAND: M_CortexA9
@


4.14.2.34
log
@Improve heap manager. Add heap testbed. Add dummy implementation of some OS_ScreenMode reason codes.
Detail:
  s/HeapMan, hdr/KernelWS - Heap manager improvements:
    - Errors generated by interrupted heap operations that are forced to complete by a OS_Heap call from the background are now cached in kernel workspace until the foreground task is resumed. This prevents them from being potentially overwritten by MessageTrans running out of background error buffers.
    - Added new OS_Heap reason code, #7 - Get area aligned. This allows areas of memory to be allocated at specific (power-of-2) alignments, and optionally without crossing a given (power-of-2) boundary. Alignment & boundary calculations are performed using logical addresses.
    - Removed the limitation that all free and allocated blocks must be a multiple of 8 bytes in length. This change was required in order to allow OS_Heap 7 to function correctly. Now the only requirements are that blocks must be multiples of 4 bytes in length, at 4 byte alignment, with a minimum length of 8 bytes. 4 extra padding bytes may still be added to the end of allocations in order to avoid creating 4-byte free blocks.
  s/HeapMan, TestSrc/HeapTest/Makefile, TestSrc/HeapTest/c/testbed, TestSrc/HeapTest/s/asm - Added heap testbed program. Can either use the OS_Heap SWI or directly include a copy of the Kernel's heap manager sources.
  s/vdudecl, s/vduswis - Added dummy implementations of OS_ScreenMode 4, 5 and 6. This prevents the Wimp generating lots of "Unknown OS_ScreenMode reason code" errors when redrawing the screen.
  s/Arthur3, s/Oscli - Moved dotstring closer to where it's used to avoid "ADRL out of range" errors in Tungsten build
Admin:
  Tested in OMAP3 ROM & Tungsten ROM softload.
  Heap testbed successfully performed over 400 million heap ops, so there shouldn't be any serious bugs in the new code (touch wood)


Version 5.35, 4.79.2.128. Tagged as 'Kernel-5_35-4_79_2_128'
@
text
@a1982 2
HeapBackgroundError   #  256 ; For storing errors generated in the background by the forced completion of a foreground heap op

@


4.14.2.34.2.1
log
@  Merged OS_Memory 8 changes across from HAL branch to RPi branch
Detail:
  Revisions Kernel-5_35-4_79_2_153 and Kernel-5_35-4_79_2_161 merged with one
  trivial conflict.
Admin:
  Confirmed that this builds, but not tested on hardware.

Version 5.35, 4.79.2.147.2.15. Tagged as 'Kernel-5_35-4_79_2_147_2_15'
@
text
@a246 1
ScreenMaxSize       * 480*1024
d250 2
d253 2
d256 1
a257 1

d261 1
a261 1
HALWorkspaceSize    * &00100000
d263 1
d265 3
d274 1
d276 3
d281 1
d285 5
@


4.14.2.34.2.2
log
@Fix addresses sent to GraphicsV_SetDMAAddress when external framestore in use. Add ID for BCM2835 VDU HAL device.
Detail:
  hdr/KernelWS, s/vdu/vdudriver, s/vdu/vduwrch - Fixed wrong addresses being sent to GraphicsV_SetDMAAddress when an external framestore is in use. Previously VideoPhysAddr was being treated as if it was the base of screen memory, but that's only the case if an internal framestore is in use. Since VideoPhysAddr is part of PhysRamTable it's not possible to change it to point to an external framestore, so a new workspace variable, TrueVideoPhysAddr, is used instead.
  hdr/HALDevice - Added device ID for BCM2835 VDU device
  s/PMF/IIC - Corrected an incorrect comment in IICDoOp
Admin:
  Tested on Raspberry Pi with high processor vectors


Version 5.35, 4.79.2.147.2.22. Tagged as 'Kernel-5_35-4_79_2_147_2_22'
@
text
@a787 1
TrueVideoPhysAddr  # 4               ; VideoPhysAddr is a lie, use this instead
d791 1
a791 1
                # 35*4 - 6*PointerBlkSize ; SPARE (avoiding changes of exported addresses for now)
d793 1
a793 1
                # 37*4 - 6*PointerBlkSize ; SPARE (avoiding changes of exported addresses for now)
@


4.14.2.34.2.3
log
@Merge with HAL branch
Detail:
  Merge the HAL branch into the RPi branch, prior to merging RPi to HAL
  Brief summary of main changes brought in:
  * Added *cache functionality previously provided by ARM module
  * Added "CMOS RAM reset" message on startup when CMOS has been wiped by keypress
  * Renamed HAL Video entries from HAL_Video_XXX to HAL_VideoXXX
  * Dropped mjsHAL macros, GRAB/STASH macros
  * Fixed pseudo-VRAM allocation when machine has exactly 16MB of RAM
  * Added OS_Hardware 5
  * Use OS_SerialOp GetDeviceName for getting serial device name
  * Drop HAL_MonitorLeadID
  * Rework default GraphicsV_IICOp handler
Admin:
  Tested on Raspberry Pi with high processor vectors


Version 5.35, 4.79.2.147.2.23. Tagged as 'Kernel-5_35-4_79_2_147_2_23'
@
text
@d1172 1
d1179 3
d1401 8
d1411 2
d1496 1
a1496 2
MonitorLeadType    #    1       ; some function of the monitor lead inputs, as yet undetermined
MentionCMOSReset   #    1       ; non zero reports CMOS resets prior to the start banner
@


4.14.2.35
log
@Make Mike's macros permanent.
While the HAL and kernel were being split some temporary macros were used for the bits being worked on, after 12 years of use they're probably safe to adopt.
mjsCallHAL -> CallHAL; mjsAddressHAL -> AddressHAL; mjsHAL -> HAL.
OS_VIDCDividerSWI code now always does NoSuchSWI (had been switched out previously).
File vduhint.s no longer assembled (was empty).


Version 5.35, 4.79.2.150. Tagged as 'Kernel-5_35-4_79_2_150'
@
text
@d1188 1
d1195 3
d1417 8
d1427 2
@


4.14.2.36
log
@Make OS_Memory 8 return more correct values
The only fake result now is the hard ROM amount, which is hardwired to 4MB and might not be correct.
Unrelated changes
 hdr.HALDevice: Assign a device for VIDC20.
 hdr.KernelWS: Reorder into ascending order, remove legacy addresses.
 s.ARM600: Move PhysSpaceSize inside :LNOT:HAL switch.
 s.Kernel: Move PhysSpaceSize inside :LNOT:HAL switch.

Version 5.35, 4.79.2.153. Tagged as 'Kernel-5_35-4_79_2_153'
@
text
@a246 1
ScreenMaxSize       * 480*1024
d250 2
d253 2
d256 1
a257 1

d261 1
a261 1
HALWorkspaceSize    * &00100000
d263 1
d265 3
d274 1
d276 3
d281 1
d285 5
@


4.14.2.37
log
@Sort out SetBorder
NewReset.s:
The one remaining use of SetBorder was to denote the user asked for and got a CMOS reset, which in the HAL case emitted a warning because setting the border is potentially complicated/slow.
To solve this, the reset is noted and replaces the normal RISC OS banner with a warning message. The behaviour and text for this comes from the BBC Master, though the escape key is used in place of break since a reset isn't actually needed.
Moved the unused cputable inside its corresponding switch.
Two occurrences of WriteS_Translated would have executed the message in the V=1 case.
KernelWS/Resources:
Flag added to workspace, translation added to messages files.
Heapman.s:
Commented out use of SetBorder removed.
Kernel.s:
SetBorder macro removed.
Middle.s:
Switched out use of SetBorder removed.
Super1.s:
Conditional WriteS_Translated would try to execute the message in the opposite condition case.


Version 5.35, 4.79.2.157. Tagged as 'Kernel-5_35-4_79_2_157'
@
text
@d1481 1
a1481 2
MonitorLeadType    #    1       ; some function of the monitor lead inputs, as yet undetermined
MentionCMOSReset   #    1       ; non zero reports CMOS resets prior to the start banner
@


4.14.2.38
log
@Merge with RPi branch
Detail:
  Merge the RPi branch with the HAL branch, ending RPi branch development
  Brief summary of changes brought in:
  * Added HAL_VideoStartupMode to allow the HAL to specify a startup mode for the OS
  * Fixed addresses being sent to GraphicsV_SetDMAAddress being wrong for external framestores (addresses were given as if internal framestore was in use)
  * Add InverseTextTransparency option for limited compile-time support for targets where framebuffer alpha channel is important
  * Fix ConfiguredLanguage for non-Tungsten builds
  * Update ARMv6 CPU detection to read cache parameters from cache type register instead of using KnownCPUTable
  * Add HALDebugHexTX/TX2/TX4 debug routines for writing out numbers via HAL
  * Use HAL_TimerIRQClear when clearing timer 0 interrupt instead of just HAL_IRQClear
  * Initialise FileLangCMOS using defines from Hdr:FSNumbers instead of magic numbers. Use SDFS on M_ARM11ZF.
  * Improved software mouse pointer support; software pointer now removed & restored in some of the same places the text cursor is
  * Improve support for external framestores; driver is now able to grow/shrink/move the framestore on mode changes if bit 5 of GraphicsV_DisplayFeatures R0 is set
  * GraphicsV_FramestoreAddress now has a default claimant which calls HAL_VideoFramestoreAddress
Admin:
  Tested on Raspberry Pi, Iyonix, OMAP3, IOMD


Version 5.35, 4.79.2.165. Tagged as 'Kernel-5_35-4_79_2_165'
@
text
@a787 1
TrueVideoPhysAddr  # 4               ; VideoPhysAddr is a lie, use this instead
d791 1
a791 1
                # 35*4 - 6*PointerBlkSize ; SPARE (avoiding changes of exported addresses for now)
d793 1
a793 1
                # 37*4 - 6*PointerBlkSize ; SPARE (avoiding changes of exported addresses for now)
@


4.14.2.39
log
@Add OS_NVMemory 6
Permits applications to query what value would be used in the event of a CMOS reset for a given configure value. Notably, the configure plugins will use this in favour of 'ResetCMOS'.
hdr/Options: retire the 'Select16BitSound' switch, add comment for ChecksumCMOS switch
hdr/KernelWS: DuffEntry and Nowhere moved here
Kernel.s: Unused OSMD removed, retire single use of SPIRQ in favour of r13_irq
Middle.s: Retire SPIRQ
NewReset.s: Trim out 300+ lines of CMOS reset defaults, call OS_NVMemory 6 instead
PMF/i2cutils.s: CMOS reset default code and table moved here with refactoring
Note, the previous code preserved YearCMOS during the zeroing, only to unconditionally write it later - so have removed it from the zeroing step.
Note, the locations 80-111 are now considered as system CMOS in the allocations hence are now wiped too (previously they got skipped as user CMOS during R-power-on).

Tested on OMAP3 ROM with delete-power-on and R-power-on variants, and a simple BASIC program to read locations 0-255 via OS_NVMemory.

Version 5.35, 4.79.2.180. Tagged as 'Kernel-5_35-4_79_2_180'
@
text
@a267 2
DuffEntry           * &FAFF8000 ; No page ever mapped in here (L2PT entry always 0), also, all non mapped pages
Nowhere             * DuffEntry ; use this as their CAM entry. There is only one 'Nowhere' (synonym).
a291 2
DuffEntry           * &01F08000 ; No page ever mapped in here (L2PT entry always 0), also, all non mapped pages        
Nowhere             * DuffEntry ; use this as their CAM entry. There is only one 'Nowhere' (synonym).
@


4.14.2.40
log
@Add new HAL call, HAL_IRQMax, to allow the kernel to determine the number of IRQ lines/devices at runtime
Detail:
  hdr/HALEntries - Reuse the old HAL_MonitorLeadID call number for HAL_IRQMax
  hdr/KernelWS - Rearrange CursorChunkAddress workspace a bit. Removed unused OldOscliBuffs and a couple of pre-HAL allocations, and made DefIRQ1Vspace the same size for all build configs. Add an IRQMax var to zero page workspace to cache the value returned by HAL_IRQMax.
  s/HAL - Initialise IRQMax shortly after HAL initialisation. Revise ClearPhysRAM comment to reflect which vars are preserved in the current version of the code.
  s/NewIRQs - Strip out a fair bit of pre-HAL code to make the file more readable. Update OS_ClaimDeviceVector/OS_ReleaseDeviceVector to check against IRQMax instead of the MaxInterrupts compile-time limit.
Admin:
  Tested on BB-xM, Iyonix, RiscPC, Pi
  Although the OS will now nominally adapt at runtime to how many IRQ devices there are, it's still using MaxInterrupts as an upper limit as the device claimant table has a fixed memory allocation.


Version 5.35, 4.79.2.182. Tagged as 'Kernel-5_35-4_79_2_182'
@
text
@a1269 1
IRQMax             #    4               ; from HAL_IRQMax
a1774 1
 [ :LNOT: HAL32
a1776 1
 ]
a1806 4
;
; Currently (Jan 2013) only the sound DMA buffers are mapped in uncacheable.
; This means CursorData is mapped in cacheable, despite the OS treating it as
; uncacheable.
d1859 1
a1859 1
; IRQ despatch
d1861 9
a1869 2
MaxInterrupts           *       160     ; 160 needed by OMAP4. Increase in future if necessary.
DefIRQ1Vspace           *       12*MaxInterrupts+128
d1871 13
d1887 10
a1896 1
 ! 0, "CursorChunkAddress free ":CC::STR:(@@-CursorChunkAddress)
d1899 1
a1899 1
 ASSERT @@ >= CursorChunkAddress
@


4.14.2.41
log
@Adopt some switches from Hdr:Machine/Machine
SystemName, ROMSizeOffset, HAL32, HAL26 only used here, moved here.
Remove uses of "M_" booleans, apparently that's bad form.
Fix SWIDespatch_Size for the non thumb capable case (was ASSERTing).
Swapped UserMemStart for AppSpaceStart.
Removed last use of OldComboSupport (pre Medusa!).
Removed switch 'CDVPoduleIRQs', a correction to the machine definitions mean this can now simply be switched on NumberOfPodules (previously, IOMD couldn't chain podule interrupts).
Take out disabled sub interrupt support - it's in CVS if you want to try to get it working.
Moved ConfiguredLang to 11 for everyone, it only matters if !Boot fails, and no harm in making it common for 5.xx onwards.

Version 5.35, 4.79.2.183. Tagged as 'Kernel-5_35-4_79_2_183'
@
text
@d1831 1
a1831 1
 [ SupportARMT
d1838 1
a1838 1
SWIDespatch_Size        *       30*4    ; can save 2 instructions if no Thumb
@


4.14.2.42
log
@Teach the kernel about different memory attributes
Detail:
  Briefly, this set of changes:
  * Adjusts PhysRamTable so that it retains the flags passed in by the HAL from OS_AddRAM (by storing them in the lower 12 bits of the size field)
  * Sorts the non-VRAM entries of PhysRamTable by speed and DMA capability, to ensure optimal memory allocation during OS startup.
  * Adjust the initial memory allocation logic to allow the cursor/sound chunk and HAL noncacheable workspace to come from DMA capable memory
  * Extends OS_Memory 12 to accept a 'must be DMA capable' flag in bit 8 of R0. This is the same as available in ROL's OS.
  * Extends OS_DynamicArea 0 to allow the creation of dynamic areas that automatically allocate from DMA capable memory. In ROL's OS this was done by setting bit 12 of R4, but we're using bits 12-14 for specifying the cache policy, so instead bit 15 is used.
  * Fixes OS_ReadSysInfo 6 to return the correct DevicesEnd value now that the IRQ/device limit is computed at runtime
  File changes:
  * hdr/OSEntries - Add definitions of the various flags passed to OS_AddRAM by the HAL. Add a new flag, NoDMA, for memory which can't be used for DMA.
  * hdr/KernelWS - Tidy PhysRamTable definition a bit by removing all the DRAM bank definitions except the first - this makes it easier to search for code which is interacting with the table. Remove VRAMFlags, it's redundant now that the flags are kept in the table. Add DMA allocation info to InitWs.
  * s/AMBControl/memmap - Updated to mask out the flags from PhysRamTable when reading RAM block sizes.
  * s/ARM600 - Strip out a lot of IOMD specific pre-HAL code.
  * s/ChangeDyn - Updated to cope with the flags stored in PhysRamTable. Implement support for DMA-capable dynamic areas. Rewrite InitDynamicAreas to insert pages into the free pool in the right order so that the fastest memory will be taken from it first.
  * s/GetAll, s/Middle - Fix OS_ReadSysInfo 6 to return the correct HAL-specific DevicesEnd value
  * s/HAL - Significant rework of initial RAM allocation code to allow the kernel workspace to come from the fastest DMA incapable RAM, while also allowing allocation of DMA capable memory for HAL NCNB workspace & kernel cursor/sound chunks. ClearPhysRAM rewritten as part of this.
  * s/MemInfo - Updated to cope with the flags stored in PhysRamTable. Add support for the new OS_Memory 12 flag. Update OS_Memory 7 to not assume PhysRamTable entries are sorted in address order, and rip out the old pre-HAL IOMD implementation.
  * s/NewReset - Remove GetPagesFromFreePool option, assume TRUE (as this has been the case for the past 10+ years). Revise a few comments and strip dead code. Update to cope with PhysRamTable flags.
  * s/VMSAv6 - Remove a couple of unused definitions
  * s/vdu/vdudriver - Update to cope with PhysRamTable flags
Admin:
  Tested in Kinetic RiscPC ROM softload, Iyonix softload, & OMAP3


Version 5.35, 4.79.2.186. Tagged as 'Kernel-5_35-4_79_2_186'
@
text
@d1007 1
a1007 1
InitUsedBlock   #       4               ; current block in PhysRamTable
a1008 3
InitDMABlock    #       8               ; block of DMAable memory extracted from PhysRamTable
InitDMAOffset   #       4               ; offset+8 into PhysRamTable where memory was taken
InitDMAEnd      #       4               ; current DMA alloc pos
d1128 4
a1131 3
PhysRamTable    #       0       ; Pairs of words (physaddr, size+flags)
                                ; indicating RAM present in machine
                                ; Unused entries have size of zero
d1133 15
a1147 4
VideoSizeFlags  #       4       ; this is actually a chunk out of DRAM)
DRAMPhysAddrA   #       4       ; Next the DRAM
DRAMSizeFlagsA  #       4
                #       8 * 16  ; Space for 17 DRAM banks + 1 VRAM bank total
d1156 1
@


4.14.2.43
log
@Header changes for OMAP4
GPIODevice: defines for OMAP4 targets
KernelWS: bump up the IICBus_Count from 3 to 4

Version 5.35, 4.79.2.187. Tagged as 'Kernel-5_35-4_79_2_187'
@
text
@d1289 1
a1289 1
IICBus_Count       *    4 ; 4 busses is enough for all current machines
@


4.14.2.44
log
@Add support for the new RISC OS 5 style sprite mode word. Add partial support for alpha channel sprite masks. Implement OS_ScreenMode reasons 13-15
Detail:
  ECFShift/ECFYOffset:
  - hdr/PublicWS - Add ECFShift and ECFYOffset to list of public exports (SpriteExtend was using hardcoded values). Rearrange exports so that VduWorkspace exports are now labelled as such.
  - hdr/KernelWS - Make sure ECFShift & ECFYOffset match their exported locations
  - hdr/OSRSI6, s/Middle - Add OS_ReadSysInfo 6 items 83 & 84, for reading ECFYOffset and ECFShift locations
  Mode flags/VDU variables:
  - Makefile - Add hdr/VduExt to the C header exports
  - hdr/VduExt - Get rid of NotRVVTBarWobblyBits macro and defined VDU variables manually so that Hdr2H will handle them. Begin replacing overly generic 'Flag_*' mode flag definitions with 'ModeFlag_*' instead. Define new flags as required by the new screen/sprite modes. Add OS_ScreenMode reason codes and mode selector format (from s.vdu.vdudecl)
  - NewModes/NEWF2, NewModes/OldPSSrc, NewModes/PSSrc, s.vdu.vdu23, s.vdu.vducursoft, s.vdu.vdudriver, s.vdu.vdugrafg, s.vdu.vdugrafj, s.vdu.vdugrafl, s.vdu.vdumodes, s.vdu.vdupal10, s.vdu.vdupal20, s.vdu.vdupalette, s.vdu.vdupalxx, s.vdu.vduwrch - Renaming Flag_* to ModeFlag_*
  - s.vdu.vdudecl - Remove OS_ScreenMode reason codes & mode selector format definitions; these are now in hdr/VduExt. Flag_* -> ModeFlag_* renaming.
  - s.vdu.vdupalxx - Apply a greyscale palette in PV_SetDefaultPalette if the greyscale mode flag is set
  New sprite types:
  - s.vdu.vdudriver - Extend GenerateModeSelectorVars to deal with the wide mask flag, 64K sprites, and the new RISC OS 5 sprite mode word format.
  - s.vdu.vdugrafdec - Store more information about the sprite in the SprReadNColour ... SprLog2BPC block.
  - s.vdu.vdugrafg - Update SpriteVecHandler to be able to detect whether RISC OS 5 format sprites are allowed palettes. Update SetupSprModeData to store the extra sprite info that's defined in vdugrafdec. Update PutSprite to fault any sprites with wide masks - SpriteExtend must be used for that (once implemented!)
  - s.vdu.vdugrafh - Update WritePixelColour to avoid temporary poking of NColour VDU variable for 8bpp sprites. Correctly replicate data when writing to RISC OS 5 format sprites. Update ReadPixelMask, WritePixelMask, SpriteMaskAddr, GetMaskspWidth to deal with wide masks. Delete obsolete bounce_new_format_masks routine.
  - s.vdu.vdugrafi - Comment updated to reflect new reality
  - s.vdu.vdugrafj - Get rid of unused code block in CreateHeader/PostCreateHeader. Update SanitizeSGetMode to generate RISC OS 5 style sprite mode words where applicable. Update DecideMaskSize to rely on GetMaskspWidth for calculating mask width.
  - s.vdu.vdugrafl - Update SwitchOutputToSprite/SwitchOutputToMask to deal with the new sprite formats. Allow PushModeInfoAnyMonitor to fail.
  - s.vdu.vduswis - Extended OS_ReadModeVariable to cope with new sprite types
  Misc:
  - s.vdu.vdudriver - Fixed bug with VIDCList copying where any -1 value in the structure would terminate the copy, instead of only -1 as a control item number
  - s.vdu.vduswis - Implemented OS_ScreenMode 13 (Mode string to specifier), 14 (mode specifier to string), and 15 (set mode by string). Mostly as per ROL's specs, but minus support for teletext attributes, and plus support for new RISC OS 5 attributes (L... layout specifier, 4096 & 24bpp packed modes, etc.)
  - s.vdu.vduwrch - Pick correct default text colours for the new modes
Admin:
  Tested on BB-xM
  Part of an implementation of the Extended Framebuffer Format spec:
  http://www.riscosopen.org/wiki/documentation/show/Extended%20Framebuffer%20Format%20Specification


Version 5.35, 4.79.2.194. Tagged as 'Kernel-5_35-4_79_2_194'
@
text
@a717 5
        ASSERT  ECFShift =  Legacy_ECFShift
        ASSERT ?ECFShift = ?Legacy_ECFShift
        ASSERT  ECFYOffset =  Legacy_ECFYOffset
        ASSERT ?ECFYOffset = ?Legacy_ECFYOffset

@


4.14.2.45
log
@Migrate RTC driver out of the kernel
The kernel will use RTC_Read and RTC_Write to access the hardware clock, while maintaining the software clock as before.
Makefile: header export is now in the RTC module's sources
KernelWS: remove RTCFitted flag
NewReset: sync the time after the module init
i2cutils: deleted clock chip code
osinit: move OS_ResyncTime into PMF/realtime
realtime: mostly packages up ordinals and calls the respective SWI

Tested on IOMD softload.

Version 5.35, 4.79.2.202. Tagged as 'Kernel-5_35-4_79_2_202'
@
text
@d1264 2
a1265 1
IRQMax          #       4               ; from HAL_IRQMax
@


4.14.2.46
log
@Assorted GraphicsV improvements
Detail:
  This set of changes:
  * Adds basic support for multiple GraphicsV drivers, by way of some new OS_ScreenMode reason codes for registering/deregistering, selecting and enumerating drivers (11, 64-68)
  * Tidies up handling of HAL video calls so that the HAL calls will be transformed into a bona fide GraphicsV driver if they're implemented
  * Changes handling of 16bpp gamma table entries so that they're sent to GraphicsV in a generic form instead of in a VIDC-specific form
  * Adds a new GraphicsV call and defines new VIDC list items to allow GraphicsV drivers to utilise the new pixel formats
  File changes:
  * h/VIDCList, hdr/VIDCList, Makefile - Add new header export containing VIDC list type 3 definitions, to avoid repeated definitions in other components
  * Resources/UK/Messages - Add new GraphicsV/OS_ScreenMode error strings and some missing processor type strings
  * hdr/KernelWS - Clean up some pre-GraphicsV definitions, and add new workspace locations for storing the current GraphicsV driver number and the driver list
  * hdr/Options - Remove obsolete InverseTextTransparency option
  * hdr/VduExt - Add VDU variable 192 for storing GraphicsV driver number (same as ROL's VideoV driver number). Remove old 'Flag_*' mode flag definitions (use new 'ModeFlag_*' defintions instead). Add new OS_ScreenMode reason codes.
  * s/ARM600, s/VMSAv6, s/vdu/vdu23, s/vdu/vdugrafa, s/vdu/vdugrafd, s/vdu/vdupalxx, s/vdu/vdupointer, s/vdu/vduwrch - Strip out pre-GraphicsV code. Update GraphicsV code to use correct driver number.
  * s/ArthurSWIs - Pass the default GraphicsV claimant the VduDriverWorkSpace instead of ZeroPage
  * s/Getall - Add Hdr:VIDCList and s/vdu/VduGrafHAL to list of GETs
  * s/NewIRQs - Remove HAL VSync IRQ initialisation, is now handled by grafvhal. Remove old HAL VsyncIRQ entry point, all VSyncs are now handled by VsyncIRQ_ExtEntry.
  * s/PMF/osbyte - Stop OS_Byte 19 waiting forever if no video driver is active
  * s/PMF/osinit - Remove HAL VSync IRQ initialisation, is now handled by grafvhal
  * s/vdu/vducursoft - Use new workspace variable names and flag names
  * s/vdu/vdudecl - Remove old HALDAG_* definitions, GVDAG_* definitions are used instead. Add definition of the per-driver workspace structure and flags.
  * s/vdu/vdudriver - Remove pre-GraphicsV code. Update InitialiseMode to check for and initialise a HAL driver. Use cached driver features word in a few places instead of calling GraphicsV each time. Update PalIndexTable to disable VIDC mangling of 16bpp gamma tables.
  * s/vdu/vdugrafv, s/vdu/vdugrafhal - HAL<->GraphicsV code split off into its own file (vdugrafhal). Default GraphicsV claimant now only deals with VSync events for the active driver.
  * s/vdu/vdumodes - Get rid of old VIDC List type 3 definiton; now in hdr/VIDCList
  * s/vdu/vduswis - Added OS_ScreenMode reason codes 11 and 64-68 for registering, deregistering, selecting and enumerating GraphicsV drivers. Update mode set code to not bother checking if the driver supports the pixel format; instead we assume that the driver's vet mode call will do the check for us.
Admin:
  Tested in Tungsten, IOMD, OMAP3 & BCM2835 ROMs
  Requires HdrSrc-2_38 and updated video driver modes


Version 5.35, 4.79.2.203. Tagged as 'Kernel-5_35-4_79_2_203'
@
text
@a774 2
CurrentGraphicsVDriver # 4 ; Current driver number

d796 1
a796 1
GraphicsVFeatures  # 4               ; features word from current driver, refreshed each mode change
d798 7
a804 3
MaxGraphicsVDrivers * 8
GraphicsVDrivers # MaxGraphicsVDrivers*4 ; List of drivers
                # 4*4                ; SPARE (avoiding changes of exported addresses for now)
d1264 1
a1264 1
IRQMax             #    4               ; from HAL_IRQMax
@


4.14.2.47
log
@Move Cache_Lx_ info inside SkippedTable region of workspace
ClearPhysRAM runs after ARM_Analyse and would wipe out the RAM copies of the various CP15 registers defining which caches are present, leading to the IMB_Full and IMB_Range operations skipping most of their job.
Space freed below DebuggerSpace by moving the RAM copies of the processor vectors up a bit.
Tested with a nobbled HAL which doesn't do the RAM clear, inspecting the workspace in a debugger to see it's preserved (only affects VSMAv6 models).

Version 5.35, 4.79.2.214. Tagged as 'Kernel-5_35-4_79_2_214'
@
text
@a1237 3
Cache_Lx_Info                     #       4       ; Cache level ID register
Cache_Lx_DTable                   #       4*7     ; Data/unified cache layout for all 7 levels
Cache_Lx_ITable                   #       4*7     ; Instruction cache layout for all 7 levels
d1248 17
a1264 1
  [ :DEF: ShowWS
a1298 1
IRQMax             #    4               ; from HAL_IRQMax
d1302 3
a1306 13
ProcVec_Start           #       0       ; Start of processor vector table
ProcVec_Branch0         #       4       ; Branch through zero
ProcVec_UndInst         #       4       ; Undefined instruction vector
ProcVec_SWI             #       4       ; SWI vector
ProcVec_PrefAb          #       4       ; Prefetch abort vector
ProcVec_DataAb          #       4       ; Data abort vector
ProcVec_AddrEx          #       4       ; not used (was Address exception vector on 26-bit-only ARMs)
ProcVec_IRQ             #       4       ; IRQ vector
ProcVec_End             #       0

ProcVecPreVeneersSize   *       4*4     ; Space for preveneers for loading handler addresses from 0 page.
ProcVecPreVeneers       #       ProcVecPreVeneersSize

@


4.14.2.48
log
@Add OS_Memory 24 implementation. Change OS_ValidateAddress to use it. Fix kernel leaving the physical access MB in a messy state. Try and protect against infinite abort loops caused by bad environment handlers.
Detail:
  s/MemInfo - Added an implementation of ROL's OS_Memory 24 call. Unlike the old OS_ValidateAddress call, this call should successfully report the presence of all memory areas known to the kernel. It should also correctly indicate which parts of a sparse DA are mapped in, unlike the old OS_ValidateAddress implementation.
  s/ChangeDyn - Update dynamic area handling to construct a lookup table for mapping logical addresses to dynamic areas; this is used by OS_Memory 24 to quickly locate which DA(s) hit a given region
  s/AMBControl/main - Make sure lazy task swapping is marked as disabled when AMB_LazyMapIn is {FALSE} - required so that OS_Memory 24 will give application space the correct flags
  s/ArthurSWIs - Switch OS_ValidateAddress over to using OS_Memory 24, as per ROL. For compatibility, Service_ValidateAddress is still issued for any areas which the kernel doesn't recognise (currently, OS_Memory 24 doesn't issue any service calls itself)
  s/Convrsions - ADR -> ADRL to keep things happy
  s/HAL - Fix L2PT page allocation and RAM clear to release the physical access region once they're done with it
  s/Kernel - Make the error dispatcher validate the error handler code ptr & error buffer using OS_Memory 24 before attempting to use them. If they look bad, reset to default. Should prevent getting stuck in an infinite abort loop in some situations (e.g. as was the case with ticket 279). The system might not fully recover, but it's better than a hard crash.
  s/Middle - Rework data/prefetch/etc. abort handlers so that DumpyTheRegisters can validate the exception dump area via OS_Memory 24 before anything gets written to it. Should also help to prevent some infinite abort loops. Strip 26bit/pre-HAL code to make things a bit more readable.
  hdr/KernelWS - Update comment
Admin:
  Tested on BB-xM, Raspberry Pi


Version 5.35, 4.79.2.222. Tagged as 'Kernel-5_35-4_79_2_222'
@
text
@d217 1
a217 1
DANode_Link       #     4               ; points to next node (in address order)
@


4.14.2.49
log
@Fix IIC bus information being wiped by RAM clear
Detail:
  hdr/KernelWS - Enlarge the SkippedTables area to encompass IICBus_Base
  s/PMF/IIC - Manually set IICBus_Status of each bus to 0 within IICInit
Admin:
  Bug was introduced in Kernel-5_35-4_79_2_168 when IIC initialisation was moved to earlier in the ROM init sequence, but has gone unnoticed due to it only really affecting the high-level API (and none of the relevant HALs were relying on the kernel for the RAM clear)
  Tested on BB-xM with kernel RAM clear


Version 5.35, 4.79.2.236. Tagged as 'Kernel-5_35-4_79_2_236'
@
text
@d1247 3
a1257 4
; Note that this is currently located within the skipped region, even though it
; doesn't need to be. It was just an easy way of adding the IIC bus info to the
; region. The debugger will initialise DebuggerSpace on startup, so it doesn't
; matter that it doesn't get cleared during the main RAM clear.
a1267 6
IICBus_Count       *    4 ; 4 busses is enough for all current machines
IICBus_Base        #    IICBus_Size*IICBus_Count

                AlignSpace 32   ; skipped bit must end on 32-byte boundary (due to speedup)
SkippedTablesEnd #      0

d1278 2
@


4.14.2.50
log
@Add ARMops for PL310 L2 cache controller
Detail:
  Unlike on the Cortex-A8 or Cortex-A15, the L2 cache that's used with the Cortex-A9 isn't hooked up to the standard ARMv7 CP15 cache maintenance ops. Instead, memory-mapped registers must be used to program and maintain the cache.
  Since the PL310 can't be detected automatically, this change adds support for a 'cache controller' HAL device which the HAL can use to advertise the presence of any external caches. If a cache device is registered during HAL_InitDevices the kernel will then check it against a list of known cache types and replace the appropriate ARMop routines with the alternatives for that controller.
  File changes:
  - hdr/PL310 - New header containing PL310 register listing
  - Makefile - Add export for PL310 header. Reorder exports to be alphabetical
  - hdr/HALDevice - Add cache controller device type, PL310 device
  - hdr/KernelWS - Allocate some workspace for storing a pointer to the current cache HAL device
  - s/ARMops - Add code for searching for known cache types, and implementation of PL310-specific ARMops
  - s/GetAll - Get Hdr:PL310
  - s/NewReset - Look for a cache controller after calling HAL_InitDevices
Admin:
  Tested on Pandaboard
  Fixes various assorted instability issues


Version 5.35, 4.79.2.252. Tagged as 'Kernel-5_35-4_79_2_252'
@
text
@a1240 1
Cache_HALDevice                   #       4       ; Pointer to any HAL cache device we're using
@


4.14.2.51
log
@Add builtin software pointer support
Detail:
  This set of changes adds support for rendering software mouse pointers directly in the kernel, rather than requiring graphics drivers to render them themselves as was the case previously.
  If a driver returns from GraphicsV_Features with the 'hardware pointer' bit clear, and a call to GraphicsV_UpdatePointer is returned unclaimed, then the kernel will step in and render a software pointer. This allows selective control over which areas of the screen the software pointer is used (e.g. if hardware only supports its use in some areas)
  hdr/KernelWS - Shrink PointerXEigFactor to 1 byte to free up some space for tracking the display log2bpp. Use 8 words of space for tracking software pointer state.
  s/vdu/vducursoft - Adjust existing the existing calls to the software pointer RemovePointer/RestorePointer functions so that they're called with IRQs enabled
  s/vdu/vdudriver - Keep track of display log2bpp. Claim/release memory needed for restoring pixels under software pointer.
  s/vdu/vdugrafhal - Update HAL_VideoUpdatePointer handling so that 0 can be returned in a1 to indicate the GraphicsV call should be left unclaimed.
  s/vdu/vdupalxx - Trigger updates of the cached software pointer palette whenever it's likely to become invalidated.
  s/vdu/vdupointer - Add software pointer implementation. Relying on a SpriteExtend OS_SpriteOp would be nice, but we're in the background so have to do plotting & unplotting manually. ColourTrans is used to cache the pointer palette colours for the current mode, although we're limited to calling it from a callback.
Admin:
  Tested on Raspberry Pi & BB-xM
  Pointer is very flickery under some circumstances (e.g. running !CloseUp) due to needing to plot/unplot around any VDU driver screen access (as per text cursor). So code may need revising in future once we can trap reads/writes from specific screen memory pages.


Version 5.35, 4.79.2.269. Tagged as 'Kernel-5_35-4_79_2_269'
@
text
@d688 1
a688 3
DisplayLog2BPP # 1
PointerXEigFactor # 1
                  # 2
d859 1
a859 11
SWP_W # 1               ; Width & height of image to restore
SWP_H # 1
SWP_Callback # 1        ; Nonzero if palette update callback registered
SWP_Mutex # 1           ; Mutex to prevent re-entrancy
SWP_Restore # 1         ; Nonzero if restore needed in RestorePointer
SWP_Dirty # 1           ; Nonzero if need replot due to palette change
          # 2
SWP_Coords # 4          ; Coordinates of last plot
SWP_Pos # 4             ; Address to restore pixels to, 0 if not displayed
SWP_Under # 4           ; Pointer to copy of screen pixels from under the pointer
SWP_Palette # 3*4       ; Pointer colours converted to pixel values for current mode
@


4.14.2.52
log
@Expose more areas via OS_ReadSysInfo 6 & OS_Memory 16. Expose processor vectors base + size via OS_PlatformFeatures.
Detail:
  hdr/KernelWS - Define processor vectors address. Currently same as ZeroPage, but in the future will differ for some machines.
  hdr/OSRSI6, s/Middle - Expose VecPtrTab & NVECTORS via OS_ReadSysInfo items 85 & 86
  s/Kernel - Add OS_PlatformFeatures 32, for returning the base + size of the processor vectors
  s/MemInfo - Add areas 12 thru 15 to OS_Memory 16, for reporting ZeroPage, ProcVecs, DebuggerSpace and ScratchSpace. The task manager can now use these for calculating memory usage instead of assuming 32K workspace from &0-&8000.
Admin:
  Tested on Raspberry Pi


Version 5.35, 4.79.2.271. Tagged as 'Kernel-5_35-4_79_2_271'
@
text
@d235 1
a235 1
ProcVecs            * &FFFF0000
d237 1
a237 1
ProcVecs            * &00000000
a238 2
; Currently, zero page must be located at the processor vectors
ZeroPage            * ProcVecs
@


4.14.2.53
log
@Improve support for VMSAv6 cache policies & memory types. Expose raw ARMops via OS_MMUControl & cache information via OS_PlatformFeatures.
Detail:
  Docs/HAL/ARMop_API - Document two new ARMops: Cache_Examine and IMB_List
  hdr/KernelWS - Shuffle workspace round a bit to allow space for the two new ARMops. IOSystemType now deleted (has been deprecated and fixed at 0 for some time)
  s/ARM600 - Cosmetic changes to BangCam to make it clearer what's going on. Add OS_MMUControl 2 (get ARMop) implementation.
  s/ARMops - Switch out different ARMop implementations and XCB tables depending on MMU model - helps reduce assembler warnings and make it clearer what code paths are and aren't possible. Add implementations of the two new ARMops. Simplify ARM_Analyse_Fancy by removing some tests which we know will have certain results. Use CCSIDR constants in ARMv7 ARMops instead of magic numbers. Update XCB table comments, and add a new table for VMSAv6
  s/ChangeDyn - Define constant for the new NCB 'idempotent' cache policy (VMSAv6 normal, non-cacheable memory)
  s/HAL - Use CCSIDR constants instead of magic numbers. Extend RISCOS_MapInIO to allow the TEX bits to be specified.
  s/Kernel - OS_PlatformFeatures 33 (read cache information) implementation (actually, just calls through to an ARMop)
  s/MemInfo - Modify VMSAv6 OS_Memory 0 cache/uncache implementation to use the XCB table instead of modifying L2_C directly. This allows the cacheability to be changed without affecting the memory type - important for e.g. unaligned accesses to work correctly. Implement cache policy support for OS_Memory 13.
  s/Middle - Remove IOSystemType from OS_ReadSysInfo 6.
  s/VMSAv6 - Make sure BangCam uses the XCB table for working out the attributes of temp-uncacheable pages instead of manipulating L2_C directly. Add OS_MMUControl 2 implementation.
  s/AMBControl/memmap - Update VMSAv6 page table pokeing to use XCB table
  s/PMF/osinit - Remove IOSystemType reference, and switch out some pre-HAL code that was trying to use IOSystemType.
Admin:
  Tested on Iyonix, ARM11, Cortex-A7, -A8, -A9, -A15
  Note that contrary to the comments in the source the default NCB policy currently maps to VMSAv6 Device memory type (as per previous kernel versions). This is just a temporary measure, and it will be switched over to Normal, non-cacheable once appropriate memory barriers have been added to the affected IO code.


Version 5.35, 4.79.2.273. Tagged as 'Kernel-5_35-4_79_2_273'
@
text
@d1212 1
a1212 3

ProcessorArch            #  1
ProcessorType            #  1   ; Processor type (handles 600 series onwards)
d1219 2
d1222 2
a1239 1
Proc_Cache_Examine                #       4
a1244 1
Proc_IMB_List                     #       4
@


4.14.2.54
log
@Replace WriteBuffer_Drain ARMop with a suite of memory barrier ARMops
Detail:
  - Docs/HAL/ARMop_API - Updated with documentation for the new ARMops.
  - s/ARMops - Set up pointers for the new memory barrier ARMops. Add full implementations for ARMv6 & ARMv7; older architectures should be able to get by with a mix of null ops & write buffer drain ops. Update ARMopPtrTable to validate structure against the list in hdr/OSMisc
  - hdr/KernelWS - Reserve workspace for new ARMops. Free up a bit of space by limiting ourselves to 2 cache levels with ARMv7. Remove some unused definitions.
  - hdr/OSMisc - New header defining OS_PlatformFeatures & OS_MMUControl reason codes, OS_PlatformFeatures 0 flags, and OS_MMUControl 2 ARMop indices
  - Makefile - Add export rules for OSMisc header
  - hdr/ARMops, s/ARM600, s/VMSAv6 - Remove CPUFlag_* and MMUCReason_* definitions. Update OS_MMUControl write buffer drain to use DSB_ReadWrite ARMop (which is what most existing write buffer drain implementations have been renamed to).
  - s/GetAll - Get Hdr:OSMisc
  - s/Kernel - Use OS_PlatformFeatures reason code symbols
  - s/vdu/vdudecl - Remove unused definition
Admin:
  Tested on ARM11, Cortex-A8, Cortex-A9


Version 5.35, 4.79.2.279. Tagged as 'Kernel-5_35-4_79_2_279'
@
text
@d1241 1
a1241 6
Proc_DSB_ReadWrite                #       4
Proc_DSB_Write                    #       4
Proc_DSB_Read                     #       4
Proc_DMB_ReadWrite                #       4
Proc_DMB_Write                    #       4
Proc_DMB_Read                     #       4
d1253 2
a1254 3
Cache_Lx_MaxLevel                 *       2       ; Current machines have max of 2 cache levels
Cache_Lx_DTable                   #       4*Cache_Lx_MaxLevel ; Data/unified cache layout for all supported levels
Cache_Lx_ITable                   #       4*Cache_Lx_MaxLevel ; Instruction cache layout for all supported levels
d1770 14
d1792 1
d1794 1
d1828 1
@


4.14.2.55
log
@Add initial support for "physical memory pools"
Detail:
  This set of changes adds support for "physical memory pools" (aka PMPs), a new type of dynamic area which allow physical pages to be claimed/allocated without mapping them in to the logical address space. PMPs have full control over which physical pages they use (similar to DAs which request specific physical pages), and also have full control over the logical mapping of their pages (which pages go where, and per-page access/cacheability control).
  Currently the OS makes use of two PMPs: one for the free pool (which now has a logical size of zero - freeing up gigabytes of logical space), and one for the RAM disc (logical size of 1MB, allowing for a physical size limited only by the amount of free memory)
  Implementing these changes has required a number of other changes to be made:
  * The CAM has been expanded from 8 bytes per entry to 16 bytes per entry, in order to allow each RAM page to store information about its PMP association
  * The system heap has been expanded to 32MB in size (from just under 4MB), in order to allow it to be used to store PMP page lists (1 word needed per page, but PMP pages may not always have physical pages assigned to them - so to allow multiple large PMPs to exist we need more than just 1 word per RAM page)
  * The &FA000000-&FBFFFFFF area of fixed kernel workspace has been shuffled around to accomodate the larger CAM, and the system heap is now located just above the RMA.
  * SoftResets code stripped out (unlikely we'll ever want to fix and re-enable it)
  * A couple of FastCDA options are now permanently on
  * Internal page flags shuffled around a bit. PageFlags_Unavailable now publicly exposed so that PMP clients can lock/unlock pages at will.
  * When OS_ChangeDynamicArea is asked to grow or shrink the free pool, it now implicitly converts it into a shrink or grow of application space (which is what would happen anyway). This simplifies the implementation; during a grow, pages (or replacement pages) are always sourced from the free pool, and during a shrink pages are always sent to the free pool.
  File changes:
  - hdr/KernelWS - Extend DANode structure. Describe CAM format. Adjust kernel workspace.
  - hdr/OSRSI6, s/Middle - Add new item to expose the CAM format
  - hdr/Options - Remove SoftResets switch. Add some PMP switches.
  - s/ARM600, s/VMSAv6 - Updated for new CAM format. Note that although the CAM stores PMP information, BangCamUpdate currently doesn't deal with updating that data - it's the caller's responsibility to do so where appropriate.
  - s/ChangeDyn - Lots of changes to implement PMP support, and to cope with the new CAM format.
  - s/HAL - Updated to cope with new CAM format, and lack of logical mapping of free pool.
  - s/MemInfo - Updated to cope with new CAM format. OS_Memory 0 updated to cope with converting PPN to PA for pages which are mapped out. OS_Memory 24 updated to decode the access permissions on a per-page basis for PMPs, and fixed its HWM usage for sparse DAs.
  - s/NewReset - Soft reset code and unused AddCamEntries function removed. Updated to cope with new CAM format, PMP free pool, PMP RAMFS
  - s/AMBControl/allocate - Update comment (RMA hasn't been used for AMBControl nodes for a long time)
  - s/AMBControl/growp, s/AMBControl/memmap, s/AMBControl/shrinkp - Update for new CAM format + PMP free pool
  - s/vdu/vdudriver - Strip out soft reset code.
Admin:
  Tested on Pandaboard
  This is just a first iteration of the PMP feature, with any luck future changes will improve functionality. This means APIs are subject to change as well.


Version 5.35, 4.79.2.284. Tagged as 'Kernel-5_35-4_79_2_284'
@
text
@d221 2
a222 2
DANode_Size       #     4               ; current logical size of area (not counting holes, if Sparse/PMP area)
DANode_MaxSize    #     4               ; maximum logical size of area
a228 3
DANode_PMP        #     4               ; pointer to physical memory pool - zero if not PMP or has been resized to zero
DANode_PMPSize    #     4               ; number of pages currently in phys pool
DANode_PMPMaxSize #     4               ; size of phys memory pool, in pages
a230 9
; CAM entry format
                  ^     0
CAM_LogAddr       #     4               ; Logical address page is assigned to (lower address if doubly mapped, Nowhere/DuffEntry if not mapped)
CAM_PageFlags     #     4               ; DynAreaFlags_* and PageFlags_*
CAM_PMP           #     4               ; Pointer to PMP (DANode ptr) if DynAreaFlags_PMP. 0 if not.
CAM_PMPIndex      #     4               ; Index of page in PMP page list. Invalid if not in PMP.
CAM_EntrySize     #     0
CAM_EntrySizeLog2 *     4

d255 1
a255 4
SysHeapChunkAddress * RMAAddress + RMAMaxSize
SysHeapAddress      * SysHeapChunkAddress
SysHeapMaxSize      * 32:SHL:20
FreePoolAddress     * 0
d265 4
a268 6
PhysicalAccess      * &FA500000
DCacheCleanAddress  * &FA600000 ; eg. for StrongARM, 256k of space, up to FAF40000
KbuffsBaseAddress   * &FA640000 ; kernel buffers for long command lines, size KbuffsMaxSize
HALWorkspaceNCNB    * &FA6E8000 ; 32K of uncacheable HAL workspace (if requested)
L2PT                * &FA800000
L1PT                * &FAC00000
d272 7
a278 2
CAM                 * &FB000000
CAMspace            * CAM_EntrySize*1024*1024 ; 1M entries = enough for 4GB of RAM
@


4.14.2.56
log
@Remove OS_Memory 10 and associated code
Detail:
  s/MemInfo - Remove OS_Memory 10 (free pool locking). Locking the free pool has never been a very nice thing to do, so now that there's no logical mapping of the free pool it seems like it's a good time to outlaw the behaviour altogether.
  s/ChangeDyn - No free pool locking means one less thing to check when claiming the OS_ChangeDynamicArea mutex.
  hdr/KernelWS - VRAMRescue_control workspace variable is no longer needed
Admin:
  Tested on Pandaboard


Version 5.35, 4.79.2.285. Tagged as 'Kernel-5_35-4_79_2_285'
@
text
@d1128 10
@


4.14.2.57
log
@Raise some workspace limits, define extra devices
Detail:
  Raise the maximum number of interrupts and IIC buses acceptable, to account for the OMAP5 port.
  Add TLV320/TLV320/SDMA/SDMA/AM572x/GC320/CPSW/SynopsisDWC for Titanium.
  Add OMAP5/OMAP5/OMAP5/TWL6037/OMAP5/OMAP5/SynopsisDWC for OMAP5.
Admin:
  There's likely some rationalisation to be had here, these controllers especially across the OMAP3/4/5 are probably the same thing really and don't merit individual allocations.

Version 5.35, 4.79.2.297. Tagged as 'Kernel-5_35-4_79_2_297'
@
text
@d1292 1
a1292 1
IICBus_Count       *    5 ; 5 buses is enough for all current machines
d1869 1
a1869 1
MaxInterrupts           *       192     ; 192 needed by OMAP5. Increase in future if necessary.
@


4.14.2.58
log
@Cache maintenance fixes
Detail:
  This set of changes tackles two main issues:
  * Before mapping out a cacheable page or making it uncacheable, the OS performs a cache clean+invalidate op. However this leaves a small window where data may be fetched back into the cache, either accidentally (dodgy interrupt handler) or via agressive prefetch (as allowed for by the architecture). This rogue data can then result in coherency issues once the pages are mapped out or made uncacheable a short time later.
    The fix for this is to make the page uncacheable before performing the cache maintenance (although this isn't ideal, as prior to ARMv7 it's implementation defined whether address-based cache maintenance ops affect uncacheable pages or not - and on ARM11 it seems that they don't, so for that CPU we currently force a full cache clean instead)
  * Modern ARMs generally ignore unexpected cache hits, so there's an interrupt hole in the current OS_Memory 0 "make temporarily uncacheable" implementation where the cache is being flushed after the page has been made uncacheable (consider the case of a page that's being used by an interrupt handler, but the page is being made uncacheable so it can also be used by DMA). As well as affecting ARMv7+ devices this was found to affect XScale (and ARM11, although untested for this issue, would have presumably suffered from the "can't clean uncacheable pages" limitation)
    The fix for this is to disable IRQs around the uncache sequence - however FIQs are currently not being dealt with, so there's still a potential issue there.
  File changes:
  - Docs/HAL/ARMop_API, hdr/KernelWS, hdr/OSMisc - Add new Cache_CleanInvalidateRange ARMop
  - s/ARM600, s/VMSAv6 - BangCam updated to make the page uncacheable prior to flushing the cache. Add GetTempUncache macro to help with calculating the page flags required for making pages uncacheable. Fix abort in OS_MMUControl on Raspberry Pi - MCR-based ISB was resetting ZeroPage pointer to 0
  - s/ARMops - Cache_CleanInvalidateRange implementations. PL310 MMU_ChangingEntry/MMU_ChangingEntries refactored to rely on Cache_CleanInvalidateRange_PL310, which should be a more optimal implementation of the cache cleaning code that was previously in MMU_ChangingEntry_PL310.
  - s/ChangeDyn - Rename FastCDA_UpFront to FastCDA_Bulk, since the cache maintenance is no longer performed upfront. CheckCacheabilityR0ByMinusR2 now becomes RemoveCacheabilityR0ByMinusR2. PMP LogOp implementation refactored quite a bit to perform cache/TLB maintenance after making page table changes instead of before. One flaw with this new implementation is that mapping out large areas of cacheable pages will result in multiple full cache cleans while the old implementation would have (generally) only performed one - a two-pass approach over the page list would be needed to solve this.
  - s/GetAll - Change file ordering so GetTempUncache macro is available earlier
  - s/HAL - ROM decompression changed to do full MMU_Changing instead of MMU_ChangingEntries, to make sure earlier cached data is truly gone from the cache. ClearPhysRAM changed to make page uncacheable before flushing cache.
  - s/MemInfo - OS_Memory 0 interrupt hole fix
  - s/AMBControl/memmap - AMB_movepagesout_L2PT now split into cacheable+non-cacheable variants. Sparse map out operation now does two passes through the page list so that they can all be made uncacheable prior to the cache flush + map out.
Admin:
  Tested on StrongARM, XScale, ARM11, Cortex-A7, Cortex-A9, Cortex-A15, Cortex-A53
  Appears to fix the major issues plaguing SATA on IGEPv5


Version 5.35, 4.79.2.306. Tagged as 'Kernel-5_35-4_79_2_306'
@
text
@a1236 1
Proc_Cache_CleanInvalidateRange   #       4
@


4.14.2.59
log
@Add SWI error pointer validation, SeriousErrorV hooks, and OS_ReadSysInfo 15
Detail:
  Resources/UK/Messages, hdr/KernelWS, s/Kernel - On return from a SWI with V set, do some basic validity checks on the error pointer in order to try and catch buggy SWIs that return bad pointers or invalid error blocks. If a bad pointer is found we'll substitute it with a pointer to a different error block, which has the SWI number in the error message, to allow the user to identify the source of the problem. (There's also a chance we'll crash when investigating a bad pointer, but crashing here in the kernel is preferable to crashing elsewhere because R12 should still contain the SWI number)
  hdr/OSMisc - Define SeriousErrorV reason codes and extended ROM footer entry IDs
  hdr/Options - Remove HangWatch integration flag, obsolete now that SeriousErrorV is available
  s/ArthurSWIs - Keep defaultvectab up to date with vector allocations
  s/Middle - Update serious error handling to call SeriousErrorV at several key points. This allows for accurate crash dumps to be obtained, along with a mechanism to warn low-level components such as RTSupport that the privileged mode stacks are being flattened.
  s/Middle - Add OS_ReadSysInfo 15, for enumerating extended ROM footer entries
  s/PMF/osbyte - Update InitNewFX0Error to use the ROM footer entry ID defined in hdr/OSMisc
Admin:
  Tested on Pi 1B, 2B, 3B


Version 5.35, 4.79.2.313. Tagged as 'Kernel-5_35-4_79_2_313'
@
text
@d1835 1
a1835 1
SWIDespatch_Size        *       38*4
d1837 1
a1837 1
SWIDespatch_Size        *       39*4
d1840 1
a1840 1
SWIDespatch_Size        *       36*4    ; can save 2 instructions if no Thumb
@


4.14.2.60
log
@Revise error pointer validity checks
Detail:
  s/Kernel, hdr/KernelWS - Avoid performing error pointer checks for XOS_GenerateError, since (a) it's a no-op as far as errors are concerned, and (b) many programs take advantage of that fact and abuse the SWI for other purposes (triggering callbacks, BASIC string conversion, etc.)
Admin:
  Tested on Raspberry Pi
  Fixes issue reported on forums with Sunfish crashing:
  https://www.riscosopen.org/forum/forums/5/topics/4060


Version 5.35, 4.79.2.314. Tagged as 'Kernel-5_35-4_79_2_314'
@
text
@d1835 1
a1835 1
SWIDespatch_Size        *       41*4
d1837 1
a1837 1
SWIDespatch_Size        *       42*4
d1840 1
a1840 1
SWIDespatch_Size        *       39*4    ; can save 2 instructions if no Thumb
@


4.14.2.61
log
@Add new OS_PlatformFeatures reason code for reading CPU features (inspired by ARMv6+ CPUID scheme). Add OS_ReadSysInfo 8 flags for indicating the alignment mode the ROM was built with. Fix long-standing bug with OS_PlatformFeatures when an unknown reason code is used.
Detail:
  s/CPUFeatures, hdr/OSMisc, hdr/KernelWS - Code and definitions for reading CPU features and reporting them via OS_PlatformFeatures 34. All the instruction set features which are exposed by the CPUID scheme and which are relevant to RISC OS are exposed, along with a few extra flags which we derive ourselves (e.g. things relating to < ARMv4, and some register usage restrictions in instructions). s/CPUFeatures is designed to be easily copyable into a future version of CallASWI without requiring any changes.
  s/ARMops - Read and cache CPU features during ARMop initialisation
  s/GetAll - GET new file
  s/Kernel - Hook up the CPU features code to OS_PlatformFeatures. Fix a long standing stack imbalance bug (fixed in RISC OS 3.8, but never merged back to our main branch) which meant that calling OS_PlatformFeatures with an invalid reason code would raise an error, even if it was the X form of the SWI that was called. Similar fix also applied to the unused service call code, along with a fix for the user's R1-R9 being corrupt (shuffled up one place) should an error have been generated.
  s/MemInfo - Extra LTORG needed to keep things happy
  s/Middle - Extend OS_ReadSysInfo 8 to include flags for indicating what memory alignment mode (if any) the OS relies upon. Together with OS_PlatformFeatures 34 this could e.g. be used by !CPUSetup to determine which options should be offered to the user.
Admin:
  Tested on Raspberry Pi 1, 2, 3


Version 5.35, 4.79.2.319. Tagged as 'Kernel-5_35-4_79_2_319'
@
text
@a1341 2
CPUFeatures # 2*4

@


4.14.2.30.2.1
log
@  Add support for Cortex cache type. Extend ARM_Analyse to, where appropriate, use CPU feature registers to identify CPU capabilities.
Detail:
  s/ARMops - Support for Cortex multi-level cache (CT_ctype_WB_CR7_Lx). New ARM_Analyse_Fancy to identify CPU capabilities using feature registers.
  s/HAL - Modify pre-ARMop cache code to handle Cortex-syle caches.
  s/MemInfo - Replace ARM_flush_TLB macro call with appropriate ARMop to provide Cortex compatability
  hdr/ARMops - Update list of ARM architectures
  hdr/CoPro15ops - Deprecate ARM_flush_* macros for HAL kernels, as they are no longer capable of flushing all cache types. ARMops should be used instead.
  hdr/KernelWS - Add storage space for multi-level cache properties required for new cache cleaning code.
Admin:
  Tested under qemu-omap3. Still unable to verify on real hardware due to lack of appropriate MMU code. However new OMAP3 HAL code that uses similar cache management functions appears to work fine on real hardware.


Version 5.35, 4.79.2.98.2.2. Tagged as 'Kernel-5_35-4_79_2_98_2_2'
@
text
@a1299 3
Cache_Lx_Info   #       4       ; Cache level ID register
Cache_Lx_DTable #       4*8     ; Data/unified cache layout for all 8 levels
Cache_Lx_ITable #       4*8     ; Instruction cache layout for all 8 levels
@


4.14.2.30.2.2
log
@Add HAL RTC support to Cortex branch of kernel, clean up RTCSupport code
Detail:
  HAL kernels (on the Cortex branch at least) now support HALDevice-based RTCs. If the kernels own RTC code is disabled or fails to detect an RTC, then after HAL_InitDevices is called the HALDevice list will be scanned for any HAL-resident RTC devices.
  Additionally, the RTCSupport flag (in Hdr:Machine.Machine), which was previously TRUE for all HAL kernels, can now be set to FALSE in HAL kernels to disable the kernels own IIC RTC code. This allows the unwanted legacy RTC code to be disabled for machines which are known to use HAL RTCs instead.
  hdr/RTCDevice - new header describing data structures used for HAL RTC device
  hdr/HALDevice - added RTCDevice device type, IIC serial bus type
  hdr/KernelWS - upgraded RTCFitted from a 1 byte field to 4 byte. It now stores either a null value (for no RTC), a value <2048 for an IIC RTC address, or a value >= 2048 for a RTCDevice ptr
  Makefile - added header export of hdr/RTCDevice
  s/GetAll - include hdr/RTCDevice
  s/NewReset - initialise HAL RTC after HAL_InitDevices if required
  s/PMF/i2cutils, s/PMF/osinit, s/PMF/osword - modifications to allow use of HAL RTC (and disallow use of builtin IIC RTC)
Admin:
  Tested on rev C2 beagleboard


Version 5.35, 4.79.2.98.2.11. Tagged as 'Kernel-5_35-4_79_2_98_2_11'
@
text
@a1269 2
RTCFitted          #    4               ; =0 no RTC, <2048 = address of I2C RTC, >=2048 = HALDevice_RTC ptr

d1281 1
@


4.14.2.30.2.3
log
@Update OS_IICOp to support multiple IIC buses
Detail:
  OS_IICOp (and in turn, RISCOS_IICOpV) now treat the top byte of R1 as containing the IIC bus number, allowing multiple buses to be used.
  hdr/KernelWS - Changed workspace a bit so that the kernel can support up to IICBus_Count buses (currently 3), each with its own IICBus_* block.
  s/HAL - Update Reset_IRQ_Handler to cope with interrupts from all IIC buses instead of just the first. Fix/update RISCOS_IICOpV description.
  s/NewIRQs - Update InitialiseIRQ1Vtable to set up interrupt handlers for all IRQ-supporting IIC buses
  s/NewReset - Get rid of the IICAbort call that was just before IICInit. IICInit now calls IICAbort itself.
  s/PMF/IIC - Bulk of the changes. Code now uses the IICBus_ structures instead of the IICStatus and IICType variables. Re-entrancy code has been updated to take into account the possiblity of multiple buses; when OS_IICOp calls are nested, the IIC transfers will be added to bus-specific queues instead of all going in the same queue. However only one queue will be processed at a time.
  s/ChangeDyn - Workspace shuffling means a couple of MOV's needed to be swapped with LDR's when getting immediate constants
Admin:
  Tested with OMAP & IOMD ROM builds.
  Both high & low-level bus types seem to work OK, along with re-entrancy, both on the same bus and on a different bus.


Version 5.35, 4.79.2.98.2.33. Tagged as 'Kernel-5_35-4_79_2_98_2_33'
@
text
@a993 8
; IIC bus info block

               ^ 0
IICBus_Type    # 4 ; Bus type (HAL_IICType)
IICBus_Status  # 4 ; Bus status (HAL_IICMonitorTransfer)
IICBus_Device  # 4 ; Bus device (HAL_IICDevice)
IICBus_Size    # 0

d1290 2
a1291 2
IICBus_Count       *    3 ; 3 busses is enough for all current machines
IICBus_Base        #    IICBus_Size*IICBus_Count
@


4.14.2.30.2.4
log
@Update the method the Cortex kernel uses to determine the UtilityModule & ROM dates
Detail:
  Three main changes:
  * On odd-numbered (i.e. development) versions of the module, the UtilityModule will now take its date from the VersionNum file instead of using a hard-coded date.
  * All build versions now look for the new "extended ROM footer" (as created by romlinker 0.04+) at the end of the ROM image and use it to determine the ROM build date for return by OS_ReadSysInfo 9,2. Failing to find the build date in the footer will cause OS_ReadSysInfo 9,2 to return 0.
  * On odd-numbered versions, OS_Byte 0 will now use the ROM build date (as found in the extended footer) to generate the error block that's returned to the user. This seems OK as the PRM describes OS_Byte 0 as returning the "creation date of the operation system". Plus it's a convenient way of getting the ROM build date into the Switcher, since the switcher uses OS_Byte 0. If the extended footer can't be found (or if the string hasn't been initialised yet, e.g. before Service_PostInit) the code falls back to a hard-coded string containing the date from the VersionNum file.
  File changes:
  Makefile - Updated to not create the obsolete Time+Date file (previously used for the ROM build date)
  Version - Use date from VersionNum file for development builds
  hdr/Options - New UseNewFX0Error variable/option to make it easy to check which OS_Byte 0 variant should be enabled
  hdr/KernelWS - Added new string buffers & extended ROM footer pointer to workspace
  s/Middle - Updated OS_ReadSysInfo 9 code, and added utility functions for searching the extended ROM footer for certain tags
  s/NewReset - Added a couple of calls to initialise the new string buffers just prior to Service_PostInit. This is required since OS_Byte/OS_ReadSysInfo shouldn't enable interrupts, but date conversion relies on the Territory module, which may enable interrupts.
  s/PMF/osbyte - Updated OS_Byte 0 code
Admin:
  Tested in OMAP ROM, with and without the extended footer present.


Version 5.35, 4.79.2.98.2.41. Tagged as 'Kernel-5_35-4_79_2_98_2_41'
@
text
@a1319 2
ExtendedROMFooter # 4 ; Pointer to the extended ROM footer structure. 0 if not initialised, -1 if not found.

a1941 5
ROMBuildDate          #  128
 [ UseNewFX0Error
NewFX0Error           #  64
 ]

@


4.14.2.30.2.5
log
@Add new OS_ReadSysInfo 6 items. Change naming of PublicWS values.
Detail:
  s/Middle - Added some new OS_ReadSysInfo 6 items which are needed by the zero page relocation kernel. Also duplicated some existing entries to avoid conflicts with ROL's allocations.
  hdr/OSRSI6, Makefile - New header listing OS_ReadSysInfo 6 items
  hdr/PublicWS - Duplicated the workspace definitions for &0-&4000, but with a 'Legacy_' prefix to their names. Also added some new entries as needed by the zero page relocation kernel. Once existing modules have been updated to use OS_ReadSysInfo 6 & the Legacy_ definitions, the old defs will be removed.
  hdr/KernelWS - Removed 'Export_' prefix from all the exported workspace values, since the kernel can now use the original names directly
  hdr/Options - Dummy HiProcVecs option so merging things will be a bit cleaner
Admin:
  Tested on rev A2 BB-xM


Version 5.35, 4.79.2.98.2.44. Tagged as 'Kernel-5_35-4_79_2_98_2_44'
@
text
@a233 3
 [ HiProcVecs
ZeroPage            * &FFFF0000
 |
a234 1
 ]
d822 1
a822 4
ScreenBlankFlag # 1     ; 0 => unblanked, 1 => blanked

        ASSERT  ScreenBlankFlag =  Legacy_ScreenBlankFlag
        ASSERT ?ScreenBlankFlag = ?Legacy_ScreenBlankFlag
d824 12
a835 7
ScreenBlankDPMSState # 1       ; 0 => just blank video
                               ; 1 => blank to stand-by (hsync off)
                               ; 2 => blank to suspend (vsync off)
                               ; 3 => blank to off (H+V off)

        ASSERT  ScreenBlankDPMSState =  Legacy_ScreenBlankDPMSState
        ASSERT ?ScreenBlankDPMSState = ?Legacy_ScreenBlankDPMSState
d843 7
a849 7
FgEcfOraEor # 4*16      ; Interleaved zgora & zgeor
        ASSERT  FgEcfOraEor =  Legacy_FgEcfOraEor
        ASSERT ?FgEcfOraEor = ?Legacy_FgEcfOraEor

BgEcfOraEor # 4*16      ; Interleaved zgora & zgeor
        ASSERT  BgEcfOraEor =  Legacy_BgEcfOraEor
        ASSERT ?BgEcfOraEor = ?Legacy_BgEcfOraEor
d1010 1
a1010 3
; Note that these are all relative to ZeroPage!

                ^       &80             ; steer clear of FIQ code
d1022 1
a1022 1
                       ^       &100
d1025 7
a1031 7
ESC_Status             #       1       ; &104
        ASSERT  ESC_Status =  Legacy_ESC_Status
        ASSERT ?ESC_Status = ?Legacy_ESC_Status

LatchBSoftCopy         #       1       ; &105
        ASSERT  LatchBSoftCopy =  Legacy_LatchBSoftCopy
        ASSERT ?LatchBSoftCopy = ?Legacy_LatchBSoftCopy
d1035 7
a1041 7
CannotReset            #       1       ; &107
        ASSERT  CannotReset =  Legacy_CannotReset
        ASSERT ?CannotReset = ?Legacy_CannotReset

IRQsema                #       4       ; &108
        ASSERT  IRQsema =  Legacy_IRQsema
        ASSERT ?IRQsema = ?Legacy_IRQsema
a1043 3
        ASSERT  MetroGnome =  Legacy_MetroGnome
        ASSERT ?MetroGnome = ?Legacy_MetroGnome

d1046 3
a1048 3
MEMC_CR_SoftCopy       #      4       ; &114
        ASSERT  MEMC_CR_SoftCopy =  Legacy_MEMC_CR_SoftCopy
        ASSERT ?MEMC_CR_SoftCopy = ?Legacy_MEMC_CR_SoftCopy
d1286 1
a1286 10
 [ :LNOT: HiProcVecs
DebuggerSpace           #       16*8    ; Debugger module needs some zero page
DebuggerSpace_Size      *       ?DebuggerSpace

        ASSERT  DebuggerSpace =  Legacy_DebuggerSpace
        ASSERT ?DebuggerSpace = ?Legacy_DebuggerSpace
 |
DebuggerSpace           *       &2000   ; Debugger gets a page all to itself!
DebuggerSpace_Size      *       &1000
 ]
d1484 7
a1490 7
RedirectInHandle   #    1
        ASSERT  RedirectInHandle =  Legacy_RedirectInHandle
        ASSERT ?RedirectInHandle = ?Legacy_RedirectInHandle

RedirectOutHandle  #    1
        ASSERT  RedirectOutHandle =  Legacy_RedirectOutHandle
        ASSERT ?RedirectOutHandle = ?Legacy_RedirectOutHandle
a1627 2
        ASSERT  CLibCounter =  Legacy_CLibCounter
        ASSERT ?CLibCounter = ?Legacy_CLibCounter
a1636 3
        ASSERT  RISCOSLibWord =  Legacy_RISCOSLibWord
        ASSERT ?RISCOSLibWord = ?Legacy_RISCOSLibWord

a1637 3
        ASSERT  CLibWord =  Legacy_CLibWord
        ASSERT ?CLibWord = ?Legacy_CLibWord

a1638 2
        ASSERT  FPEAnchor =  Legacy_FPEAnchor
        ASSERT ?FPEAnchor = ?Legacy_FPEAnchor
d1640 3
a1642 3
DomainId                #       4       ; SKS added for domain identification
        ASSERT  DomainId =  Legacy_DomainId
        ASSERT ?DomainId = ?Legacy_DomainId
d1646 3
a1648 3
VduDriverWorkSpace      #       VDWSSize
        ASSERT  VduDriverWorkSpace =  Legacy_VduDriverWorkSpace
        ASSERT ?VduDriverWorkSpace = ?Legacy_VduDriverWorkSpace
a1823 1
   [ ZeroPage = 0
a1824 3
   |
SWIDespatch_Size        *       33*4
   ]
@


4.14.2.30.2.6
log
@  Kernel updates to support Cortex-A9 CPUs
Detail:
  hdr.ARMops
    added Cortex_A9
  hdr.HALDevice
    added OMAP4 specific device IDs
  hdr.KernelWS
    changed definition of DefIRQ1Vspace for M_CortexA9
  s.ARMops
    added CortexA9 specific code for enabling L2 cache
    added CPUDesc Cortex_A9
  s.NewIRQs
    added CortexA9 specific definition of MaxInterrupts
  s.NewReset
    added M_CortexA9 options
    line 1444: corrected typo
    line 187: commented out unnecessary operation
Admin:
  Submission from Willi Thei

Version 5.35, 4.79.2.98.2.50. Tagged as 'Kernel-5_35-4_79_2_98_2_50'
@
text
@d1308 1
a1308 1
NVRamSpeed         #    1               ; Clock hold time in 0.5us units
a1899 3
 [ HAL :LAND: M_CortexA9
DefIRQ1Vspace           *       12*160+128
 |
a1904 1
 ] ; HAL :LAND: M_CortexA9
@


4.14.2.30.2.7
log
@ARMv7 fixes
Detail:
  hdr/Copro15ops:
    - Fixed incorrect encodings of ISH/ISHST variants of DMB/DSB instructions
  s/ARMops, s/HAL, hdr/KernelWS:
    - Replace the ARMv7 cache maintenance code with the example code from the ARMv7 ARM. This allows it to deal with caches with non power-of-two set/way counts, and caches with only one way.
    - Fixed Analyse_WB_CR7_Lx to use the cache level ID register to work out how many caches to query instead of just looking for a 0 result from CSSIDR.
    - Also only look for 7 cache levels, since level 8 doesn't exist according to the ARMv7 ARM.
  s/NewReset:
    - Removed some incorrect/misleading debug output
Admin:
  Tested on rev A2 BB-xM


Version 5.35, 4.79.2.98.2.51. Tagged as 'Kernel-5_35-4_79_2_98_2_51'
@
text
@d1326 2
a1327 2
Cache_Lx_DTable #       4*7     ; Data/unified cache layout for all 7 levels
Cache_Lx_ITable #       4*7     ; Instruction cache layout for all 7 levels
@


4.13
log
@  Added compile-time support for full-resolution teletext characters in
  teletext emulation mode (MODE 7) for that authentic BBC Micro feel.
  Also introduced a few useful teletext control features via VDU 23,18.
  Unrelatedly, fixed *ScreenLoad to work for interlaced displays.

Detail:
  The new typeface is designed on a 16x20 grid (previously we had used 8x10),
  so it uses a screen resolution of 640x500 pixels (rather than 320x250).
  Since we have been unable to source a genuine teletext font, and since
  examination of a BBC Micro suggests that the genuine font may not have been
  a power-of-2 pixels wide, I have designed one specially, based upon the one
  supplied in Zap distributions (a 12x20 font). Rather than increase the
  amount of workspace that the kernel requires for cacheing graphic
  characters, it now generates them on the fly, as they are required; this
  should only add about 25% to their rendering time.

  The new VDU 23 sequences are as follows:

  VDU 23,18,0,mode,0,0,0,0,0,0
    Switch transparency mode
      mode = 0: "Text" mode: the whole display is set opaque
      mode = 1: "Mix" mode: foreground colours, and both foreground and
        background of boxed text are opaque; non-boxed background colours are
        all transparent
      mode = 2: "Box" mode: boxed regions are opaque, others are transparent
      mode = 3: "TV" mode: the whole display is set transparent
    Default is mode = 0.

  VDU 23,18,1,suspend,0,0,0,0,0,0
    Suspend or resume bitmap updates
    This call allows an application to request that the kernel suspends
    updates to the framebuffer bitmap. This allows for a significant speed
    increase in the rendering time for a large amount of text, for example
    when redrawing a complete teletext page, because each time you plot a
    single character, it can cause the whole of the rest of the line to be
    re-rendered. When you switch out of suspend mode, the whole screen is
    refreshed in a single pass. Note that the appearance of the display is
    undefined is you cause a hardware scroll while in suspend mode.
      suspend = 0: screen update is enabled
      suspend = 1: screen update is suspended
    Default is suspend = 0.

  VDU 23,18,2,reveal,0,0,0,0,0,0
    Reveal/conceal
      reveal = 0: characters between the Conceal control code and the next
        colour control code are replaced by spaces
      reveal = 1: all characters are displayed
    Default is reveal = 0.

  VDU 23,18,3,black_emable,0,0,0,0,0,0
    Enable/disable black foreground colour control codes
      black_enable = 0: control codes &80 and &90 do nothing
      black_enable = 1: control code &80 selects black text, control code
        &90 selects black graphics
    Default is black_enable = 0.

  I have performed some timing tests on the rendering of complete teletext
  pages grabbed from the teletext server. These show that the new code
  generally imposes a 2x speed hit. However, when using the VDU 23,18,1
  suspend function, this improves to a 20% speed increase when compared to
  the old low-resolution code. Better still, because the framebuffer is only
  being updated for the final stage of this process, the screen *appears* to
  be updated some 3x faster than with the old code!

  A comment on the VDU variable Log2BPC is in order: in previous kernels,
  this was able unambiguously to refer to both the framebuffer width of a
  character in bytes, and the framebuffer width of an "addressable pixel" in
  bits; this no longer works with the 16-pixel wide teletext font. Bearing
  in mind that future kernels may support Unicode system fonts where the
  width varies from character to character, I have chosen to fix Log2BPC to
  the "addressable pixel" definition.

Admin:
  Requires HdrSrc 0.89 and (for non-desktop builds) Interlace 0.61. A monitor
  definition file containing a definition for a 640x500 screen mode is also
  required; version 0.40 of ModeFiles contains a suitable mode for STB-400.

  Tested fairly rigourously on an Ursula build, a Lazarus build and an
  STB-400 build, using genuine teletext pages and Yellow River Kingdom.

Version 5.30. Tagged as 'Kernel-5_30'
@
text
@d1351 4
@


4.12
log
@Had one of those weekend brainstorms - managed to speed up SWI despatcher
_and_ add Thumb support to it.
Fixed OS_BreakPt - was confused by PC/PSR split.

Version 5.24. Not tagged
@
text
@d540 1
a540 1
BytesPerChar # 4        ; Bytes per one line of character
d775 19
@


4.11
log
@  32-bit Kernel.

Details:
  The Kernel will now compile to produce a pure 32-bit system if No26bitCode is
  set to TRUE.
  If No26bitCode is FALSE, then the Kernel will be a standard 26-bit Kernel,
  although some internal changes have taken place to minimise compile
  switches between the two cases. See Docs.32bit for more technical info.

  The hardest part was the flood-fill...

Other changes:
  Pointer shape changes now take place on the next VSync, rather than actually
  WAITING for the VSync. Turning the Hourglass on shouldn't slow your machine
  down by 5% now :)

  Lots of really crusty pre-IOMD code removed.

Admin:
  Tested in 32 and 26-bit forms in a limited desktop build. Basically, this
  will need to see a lot of use to iron out difficulties. I'd like anyone who
  has a non-frozen project to at least attempt using this Kernel.

Version 5.23. Tagged as 'Kernel-5_23'
@
text
@d1508 1
d1510 3
@


4.10
log
@RCMM changes made the Kernel not report the type of I/O chip fitted correctly.
This has been fixed. In addition, SMC669 and UMC669 chips are reported as
a different chip configuration by OS_ReadSysInfo 3 (values 4 and 5
respectively).
A few assertions added to catch the remaining cases where the RCMM stuff
won't work - those cases will involve a bit more reordering of hardware
initialisation.

Version 5.00. Tagged as 'Kernel-5_00'
@
text
@d761 3
a763 1
PointerShapeNumber # 4  ; only bottom byte used
a953 5
 [ STB
Export_ResetType	#	1	; &174 ; bit 0 => 1 = por, 0 = not por ; bits 1-7 reserved (zero)
        ASSERT  Export_ResetType =  ResetType
        ASSERT ?Export_ResetType = ?ResetType
 ]
a977 6
 [ StorkPowerSave
;;;   AlignSpace 4
;;;VIDCExternalSoftCopy #  4       ; soft copy of VIDCExternal
;;;VIDCFSynSoftCopy     #  4       ; soft copy of VIDCFSyn
;;;VIDCControlSoftCopy  #  4       ; soft copy of VIDCControl
 ]
d1013 1
d1059 2
a1060 10
; [ StorkPowerSave
;;;VIDCExternalSoftCopy #  4       ; soft copy of VIDCExternal
;;;VIDCFSynSoftCopy     #  4       ; soft copy of VIDCFSyn
;;;VIDCControlSoftCopy  #  4       ; soft copy of VIDCControl
; ]

        ! 0, "Free space after ProcVec = ":CC::STR:(&320-@@)

        ASSERT  @@ <= &320
                #       &320-@@
d1205 1
a1205 3
SpriteSize      #       4       ; saved on startup for Sprite code and RAMFS
RAMDiscSize     #       4
FontCacheSize   #       4       ; and font manager
d1209 3
d1232 1
a1232 5
DUMPER            #     16 * 4

Page_Size         #  4
PIRQ_Chain        #  4
PFIQasIRQ_Chain   #  4
d1234 2
d1311 1
a1311 1
HeapReturnedReg_PC  # 4                 ; also acts as interlock
d1508 1
a1508 1
SWIDespatch_Size        *       29*4
@


4.9
log
@Fixed error in RDCH speed restoring logic.
When screen is blanked, DACs are turned off (60mA saving).
If DPMS state 3 comes on, sync lines are set low.

Version 4.96. Tagged as 'Kernel-4_96'
@
text
@d209 1
d1039 2
a1242 1
IOSystemType    #       1       ; 0 => old I/O subsystem, 1 => IOEB+82C710 system, 2..255 => ?
@


4.8
log
@Added support for ATMEL 4K and 8K EEPROM parts, including write protection
of top quarter. Untested.
Added support for ARM7500FE IO clock divide by 2.

Version 4.89. Tagged as 'Kernel-4_89'
@
text
@a823 1
 [ StorkPowerSave
a826 1
 ]
@


4.7
log
@ChocolateSysVars and ChocolateOscli merged from Ursula.

Version 4.84. Tagged as 'Kernel-4_84'
@
text
@d1086 1
@


4.6
log
@Ursula ChocolateSysHeap and 128-entry SWI hash table incorporated.

Version 4.83. Tagged as 'Kernel-4_83'
@
text
@d970 5
@


4.5
log
@* Added support for 24LC64 8K EEPROM (untested).
* Integrated Ursula fast service call dispatch code.
* Added Interruptible32bitModes from Ursula.
* Stopped allowing ROM modules (other than the Kernel/UtilityModule) to write
  to the hardware vectors in 26-bit mode.

Version 4.81. Tagged as 'Kernel-4_81'
@
text
@d1130 1
d1140 29
a1168 2
ModuleSHT_Entries  *  16
ModuleSWI_HashTab  #  4*ModuleSHT_Entries
d1171 2
d1249 56
a1304 7
; !!!! The following isn't going to work anymore !!!!
 [ med_00001_debug
 ! 0,"med-00001 queue start, queue size, cda amount at &" :CC: :STR:(OldIRQ1Vspace)
med_00001_debug_start * OldIRQ1Vspace
med_00001_debug_size * OldIRQ1Vspace+4
med_00001_debug_cda * OldIRQ1Vspace+8
 ]
@


4.4
log
@ROM speed not taken from the Machine header file.  POST can now exist
in a softloaded OS, since it searches for a zero word in the ROM
instead of using one within the POST when trying to communicate with
the POST adapter (the zero word must be in ROM).  Fixed to build on
non-chrontel STB/NC products.  Lots of duplicate code merged in
MemSize.  MemSize copes better with the softload case, and is less
willing to use the region the OS occupies as video memory, or
page tables.  POST is now ON (memory tests disabled).
OS_ReadSysInfo 4 now uses the NVRAM module to access the ethernet
address in NVRAM/CMOS, so that the availability/location of the
MAC address can be changed.  CMOS location 0 is now unprotected on
STB/NC products to try to stop people poking the hardware directly.
Fixed a CMOS resetting problem on STBs where the value expected in a
location was different from the value written on a CMOS reset, so the
CMOS would be reset every time...

Version 4.69. Tagged as 'Kernel-4_69'
@
text
@d968 9
@


4.3
log
@Spinner branch merged.
Bandwidth limit for 7500FE fixed.
RO371Timings flag set to :LNOT:STB

Version 4.64. Tagged as 'Kernel-4_64'
@
text
@d663 1
a663 1
 [ ChrontelSupport
@


4.2
log
@Kernel merged
@
text
@d208 1
a376 2
HardResetVars # 0              ; Reset to here on hard reset

d390 1
d663 3
a665 2
KernelModeSelector # 4  ; pointer to block in system heap where
                        ; current mode selector is copied
d830 3
a1028 7
CMOSRAMCache    #       240             ; Cache for CMOS RAM
  [ STB
   [ E2ROMSupport
NVRamSize	#	1		; Size of NVRam (E2ROM & CMOS) fitted in 256byte units
RTCFitted	#	1		; flag =1 iff RTC is fitted
   ]
  ]
a1029 1
                AlignSpace
d1058 23
d1086 2
d1200 1
a1200 4
                  AlignSpace

EnvString         #     256

a1203 1
; more system workspace
d1208 1
a1208 3
; !!!! Free space (752 bytes) left by old IRQ despatch (new IRQ despatch
; !!!! moved as it required more space).
OldIRQ1Vspace       # 752
d1210 1
a1216 1

@


4.2.2.1
log
@Added following enhancements:

 - Chocolate screen mapping (section mapped and cached), StrongARM only
   Phoebe h/w (IOMD 2) will have register to assist this, but code currently
   relies on data abort mechanism to keep screen up to date wrt write-back
   data cache.

 - Chocolate AMBControl task switching (lazy page mapping), StrongARM only
   Improves task swapping speed. There appears to be a StrongAEM silicon
   bug rev 2 and 3) which means that LDMIB rn, {regs includind rn} cannot
   be reliably restarted after a data abort. This stuffs Chocolate AMBControl
   (awaiting response from Digital).

Both enhancements need more work to complete for Phoebe. Chocolate AMBControl
may well have to be made dormant because of silicon bug.

Note that this kernel *will* cause problems with task switching on StrongARM,
unless Chocolate task switching is disabled via !Flavour application.
@
text
@a207 2
; 15 May 97  MJS         Replaced SyncCodeA_sema (byte) with ARMA_Cleaner_status (word) to
;                        support Chocolate flavour screen mapping on StrongARM
d950 1
a950 1
Export_ResetType        #       1       ; &174 ; bit 0 => 1 = por, 0 = not por ; bits 1-7 reserved (zero)
d957 7
a963 29
;
; next two words are for StrongARM data cache cleaning control - they should *never* be poked directly by non-kernel code
;
ARMA_Cleaner_flipflop # 4            ; address of 16k StrongARM data cache cleaner area for non-screen full cleans (NSC) - flipflops between two
;
ARMA_Cleaner_status   # 4            ; status for cleans - Allows vsync screen cleaner (VSC) to avoid cleans if foreground non-screen or screen
                                     ;                     clean (NSC or SC) already done by other processes. Uncommon NSC's needn't update
                                     ;                     status. SC's and common NSC's should, with interrupts disabled.
                                     ; bit fields of ARMA_Cleaner_status (ACS_...) defined as follows:
                                     ;
ACS_SCdisable          *  &80000000  ;   bit  31     SC disable flag  - VSC and foreground SC disabled at all times if set (must be set if not StrongARM)
ACS_SCsuspend          *  &40000000  ;   bit  30     SC suspend flag  - VSC and foreground SC suspended if set
ACS_NSCsemaphore       *  &20000000  ;   bit  29     NSC semaphore    - NSC in progress if set
ACS_SCsemaphore        *  &10000000  ;   bit  28     SC semaphore     - SC in progress if set (may be VSC or foreground SC)
ACS_VSClazy_MASK       *  &0C000000  ;   bits 26..27 VSC lazy         - vsyncs before each triggered VSC will be executed (1..3, 0 is undefined)
ACS_VSClazy_SHIFT      *  26
ACS_VSClazy_DEFAULT    *  2:SHL:26
ACS_VSCcountdown_MASK  *  &03000000  ;   bits 24..25 VSC countdown    - vsyncs before next VSC will execute (0..3, 0=none pending, 1=at next vsync)
ACS_VSCcountdown_SHIFT *  24
ACS_SCflipflop         *  &00800000  ;   bit  23     SC flipflip      - controls flipflop between two 16k cleaner areas for SC's
ACS_SCflipflop_SHIFT   *  23
ACS_SynchCAsemaphore   *  &00400000  ;   bit  22     SychCA semaphore - set during SynchroniseCodeAreas (re-entrancy guard)
ACS_Scacheflag         *  &00200000  ;   bit  21     Scache flag      - set if screen currently cacheable (mainly for info to OS_ScreenMode)
                                     ;   bit  0..20  reserved         - 0

      ! 0, "AMBControl_ws         at ":CC::STR:(AMBControl_ws)
      ! 0, "ARMA_Cleaner_flipflop at ":CC::STR:(ARMA_Cleaner_flipflop)
      ! 0, "ARMA_Cleaner_status   at ":CC::STR:(ARMA_Cleaner_status)

d1028 2
a1029 2
NVRamSize       #       1               ; Size of NVRam (E2ROM & CMOS) fitted in 256byte units
RTCFitted       #       1               ; flag =1 iff RTC is fitted
@


4.2.2.2
log
@Module SWI chunks added to end of linked list on grounds that first loaded
modules are probably more important, so should be checked first.
Some RISC OS 3.70 bits internationalised.
*ChangeDynamicArea moved into UtilityModule from TaskManager.
@
text
@d951 1
d955 1
d957 1
a957 1
                AlignSpace 4
d1087 1
a1087 1
                #       (&500 -@@)
@


4.2.2.3
log
@ 1 Simplify source by removing various long-standing compile flags
   and pre-Medusa h/w support

 2 Fix bug with Pages_Unsafe/Pages_Safe page moving for StrongARM
   (interrupt hole) - also better performance for StrongARM

 3 Improve perfromance of physical memory clear for StrongARM
   (make sure it uses burst write for STM)

 4 Suspend Chocolate task switching for StrongARM if SALDMIBbroken
   is TRUE
@
text
@d1217 8
@


4.2.2.4
log
@1) Fixes and tidy ups:
   - mapping of Cur/Sys/Sound area done more elegantly, and soft CAM info
     is now consistent with it
   - cached screen cleaning on VSync performed *after* VSync events
   - comments at top of ARM600 modernised
   - Pages_Unsafe/Safe code fixed to work properly on StrongARM with
     pages that are involved in interrupts (there is no fix for ARM8,
     since that is unlikely to be needed - an ASSERT checks use of ARM8
   - OS_DynamicArea code souped up, to be much more efficient for large
     numbers of dynamic areas (see comments near top of ChangeDyn)
   - cached screen is now suspended on h/w scroll (avoids possible cache
     incoherency)
2) API changes:
   - new OS_Memory reason code (10) allows Wimp to inform kernel of
     Wimp_ClaimFreeMemory, and can control VRAM rescue (see below)
   - new OS_ReadSysInfo reason code (6) allows reading of kernel values
     (reserved for Acorn use, eg. for SoftLoad, ROMPatch)
   - new OS_DynamicArea reason codes (6 and 7) allow for more efficient
     monitoring of dynamic areas by TaskManager (reserved for Acorn use)
3) Changes for Phoebe:
   - kernel runs a VRAM rescue process, which ensures that any VRAM not
     used for the screen is reclaimed if necessary and sinks to the bottom
     of the Free Pool. This is important for Phoebe, where VRAM is slower
     than SDRAM, but does no harm on other platforms.
   - logical copy of physical RAM is removed from memory map. This frees
     up 256M of address space that will later be used for PCI on Phoebe,
     but should do no harm on other platforms (this space is marked
     private in PRMs, so 3rd parties should not use it).
@
text
@d956 1
a956 1
AMBControl_ws         # 4            ; workspace anchor word for AMBControl
d967 13
a979 13
ACS_SCdisable           * &80000000  ;   bit  31     SC disable flag  - VSC and foreground SC disabled at all times if set (must be set if not StrongARM)
ACS_SCsuspend           * &40000000  ;   bit  30     SC suspend flag  - VSC and foreground SC suspended if set
ACS_NSCsemaphore        * &20000000  ;   bit  29     NSC semaphore    - NSC in progress if set
ACS_SCsemaphore         * &10000000  ;   bit  28     SC semaphore     - SC in progress if set (may be VSC or foreground SC)
ACS_VSClazy_MASK        * &0C000000  ;   bits 26..27 VSC lazy         - vsyncs before each triggered VSC will be executed (1..3, 0 is undefined)
ACS_VSClazy_SHIFT       * 26
ACS_VSClazy_DEFAULT     * 2:SHL:26
ACS_VSCcountdown_MASK   * &03000000  ;   bits 24..25 VSC countdown    - vsyncs before next VSC will execute (0..3, 0=none pending, 1=at next vsync)
ACS_VSCcountdown_SHIFT  * 24
ACS_SCflipflop          * &00800000  ;   bit  23     SC flipflop      - controls flipflop between two 16k cleaner areas for SC's
ACS_SCflipflop_SHIFT    * 23
ACS_SynchCAsemaphore    * &00400000  ;   bit  22     SychCA semaphore - set during SynchroniseCodeAreas (re-entrancy guard)
ACS_Scacheflag          * &00200000  ;   bit  21     Scache flag      - set if screen currently cacheable (mainly for info to OS_ScreenMode)
a984 31

; word controlling rescue of VRAM that is not used by screen (and sorting into bottom of free pool) - VRAM is slower than SDRAM for Phoebe.
; word organised as 3 fields - control field (byte) is not written by interrupt routine, so can be safely manipulated by foreground with IRQs enabled
VRAMRescue_control    # 1            ; control bits manipulated by foreground, read by interrupt driven rescuer
VRAMRescue_status     # 1            ; status bits manipulated by interrupt driven rescuer
VRAMRescue_nextVpage  # 2            ; page number of next VRAM page to check for rescue (VRAM pages run from 0 on Phoebe or Risc PC)
                                     ; Bit fields of VRAMRescue_control (VRRc_...) defined as follows:
                                     ;
VRRc_disable            * &01        ;   control bit  0      slow page rescue from Free Pool disabled completely, if set (disabled for no VRAM)
VRRc_suspend            * &02        ;   control bit  1      slow page rescue suspended by outside agent, if set
VRRc_wimp_lock          * &04        ;   control bit  2      slow page rescue suspended because Wimp_ClaimFreeMemory has claimed free pool, if set
                                     ;   control bits 3..7   reserved (should be 0)
                                     ; Bit fields of VRAMRescue_status (VRRs_...) defined as follows:
VRRs_CBpending          * &01        ;   status  bit  0      rescuer has CallBack pending
                                     ;   status  bits 1..7   reserved (should be 0)

      ! 0, "VRAMRescue word       at ":CC::STR:(VRAMRescue_control)

DynArea_ws              # 4          ; workspace anchor word for data structures to accelerate OS SWIs for dynamic areas
                                     ; (OSs up to 3.71 are horrendously slow when no. of dynamic reas is large)

      ! 0, "DynArea_ws            at ":CC::STR:(DynArea_ws)

  [ mjsServiceTrace
mjsServiceTrace_ws      # 4
      ! 0, ""
      ! 0, "**WARNING** compiling in code to trace service call statistics (mjsServiceTrace TRUE)"
      ! 0, ""
      ! 0, "mjsServiceTrace_ws    at ":CC::STR:(mjsServiceTrace_ws)
  ]

@


4.2.2.5
log
@Various speed ups
Memory map changes:
remove shadow ROM
move UNDEF stack, SoftCAM and MMU tables above 64M
expand RMA limit to 15M from 11M
expand SysHeap limit to 3M-32k from 2M-8k
expand SVC stack to 32k from 8k
partially protect kernel workspace from user access
protect SVC stack from user access
@
text
@d229 1
d231 5
d238 2
a239 1
RMAMaxSize          * &00F00000 ; 15M (changed for Ursula, was 11M)
d241 1
a241 1
SVCStackSize        * 32*1024   ; changed for Ursula, was 8*1024
d244 1
a244 1
SysHeapMaxSize      * &00300000-SVCStackSize  ; Changed for Ursula, was &00200000-SVCStackSize
d260 1
a260 1
FreePoolAddress     * &08800000 ; Changed for Ursula, was &06000000
d262 1
a262 1
; PhysRam         *     &05000000  Redundant (commented out for Ursula)
d1004 1
a1004 1
                                     ; (OSs up to 3.71 are horrendously slow when no. of dynamic areas is large)
a1007 11
  [ :LNOT: InternationaliseCommonSilentErrors
CommonSilentError_ws    # 4          ;workspace for common error handling, without huge MessageTrans overheads (currently
                                     ;only used by OS_ReadVarVal, since it needs to report name of var sometimes)
      ! 0, "CommonSilentError_ws  at ":CC::STR:(CommonSilentError_ws)
  ]

Oscli_CmdHashSum        # 4          ;for hashed command lookup
      ! 0, "Oscli_CmdHashSum      at ":CC::STR:(Oscli_CmdHashSum)
Oscli_CmdHashLists      # 4          ;anchor for hashed command lists structure
      ! 0, "Oscli_CmdHashLists    at ":CC::STR:(Oscli_CmdHashLists)

d1048 1
a1048 1
      ! 0, "VideoPhysAddr         at ":CC::STR:(VideoPhysAddr)
d1065 1
a1065 1
      ! 0, "LCD_Active flag byte  at ":CC::STR:(LCD_Active)
d1071 2
a1072 2
      ! 0, "ProcessorType         at ":CC::STR:(ProcessorType)
      ! 0, "ProcessorFlags        at ":CC::STR:(ProcessorFlags)
d1162 2
a1163 29
; SWI hash table moved to OldIRQ1Vspace on 12-Nov-97, for Ursula (wider hashing)
;
; !!!! Free Space
;
  [ ChocolateSysHeap
ChocolateBlockArrays  #  0
ChocolateCBBlocks     #  4            ; -> array of quick access blocks for Callback
ChocolateSVBlocks     #  4            ; -> array of quick access blocks for software vectors
ChocolateTKBlocks     #  4            ; -> array of quick access blocks for tickers
ChocolateMRBlocks     #  4            ; -> array of blocks for ROM module nodes (reduces no. of individual blocks in heap)
ChocolateMABlocks     #  4            ; -> array of blocks for active module nodes (reduces no. of individual blocks in heap)
ChocolateMSBlocks     #  4            ; -> array of blocks for module SWI hash nodes (reduces no. of individual blocks in heap)
      ! 0, "ChocolateCBBlocks     at ":CC::STR:(ChocolateCBBlocks)
      ! 0, "ChocolateSVBlocks     at ":CC::STR:(ChocolateSVBlocks)
      ! 0, "ChocolateTKBlocks     at ":CC::STR:(ChocolateTKBlocks)
      ! 0, "ChocolateMRBlocks     at ":CC::STR:(ChocolateMRBlocks)
      ! 0, "ChocolateMABlocks     at ":CC::STR:(ChocolateMABlocks)
      ! 0, "ChocolateMSBlocks     at ":CC::STR:(ChocolateMSBlocks)
; !!!! Free Space (40 bytes)
OldSWIHashspace    #  10*4
  |
; !!!! Free Space (64 bytes)
OldSWIHashspace    #  16*4
  ]

;
;was:
;ModuleSHT_Entries  *  16
;ModuleSWI_HashTab  #  4*ModuleSHT_Entries
a1165 2
      ! 0, "Module_List           at ":CC::STR:(Module_List)

a1197 1
      ! 0, "VariableList          at ":CC::STR:(VariableList)
d1244 3
a1246 41
; Was Free space (752 bytes) left by old IRQ despatch (new IRQ despatch moved as it required more space).
; Re-used for various purposes on 12-Nov-97, for Ursula
;
      ASSERT @@ = &C34                            ;if fails, may need to rearrange padding to sort hash table alignment
;
ModuleSHT_Entries  *  128
ModuleSHT_Padding0 #  12                         ;spare, so that SWI hashtable is aligned for easy immediate address load
ModuleSWI_HashTab  #  4*ModuleSHT_Entries
      ! 0, "ModuleSWI_HashTab     at ":CC::STR:(ModuleSWI_HashTab)
;
SysVars_StickyPointers # (10+1)*4                ;used if ChocolateSysVars is TRUE (1 dummy pointer for 0 size)
      ! 0, "SysVars_StickyPtrs    at ":CC::STR:(SysVars_StickyPointers) 
;
  [ mjsSysHeapNodesTrace
mjsSHNodesTrace_ws # 0
mjsSHNT_hcl_total  # 4    ;total calls to ClaimSysHeapNode
mjsSHNT_hfr_total  # 4    ;total calls to FreeSysHeapNode
mjsSHNT_hop_total  # 4    ;total calls to DoSysHeapOpWithExpansion
mjsSHNT_ohc_total  # 4    ;total calls to OS_Heap for SysHeap claim
mjsSHNT_ohf_total  # 4    ;total calls to OS_Heap for SysHeap free
mjsSHNT_ohx_total  # 4    ;total calls to OS_Heap for SysHeap expand or shrink
mjsSHNT_vcs_total  # 4    ;total SysVar ClaimVNode calls that picked up a sticky node
mjsSHNT_vch_total  # 4    ;total SysVar ClaimVNode calls that went to the heap for a node
mjsSHNT_vxs_total  # 4    ;total SysVar ExpandOrShrinkVNode calls that tried to do sticky change
mjsSHNT_vxh_total  # 4    ;total SysVar ExpandOrShrinkVNode calls that went to the heap
mjsSHNT_vfs_total  # 4    ;total SysVar FreeVNode calls that stuck
mjsSHNT_vfh_total  # 4    ;total SysVar FreeVNode calls that dropped a node to the heap
      ! 0, ""
      ! 0, "**WARNING** compiling in code to trace some SysHeap node statistics (mjsSysHeapNodesTrace TRUE)"
      ! 0, ""
      ! 0, "mjsSHNodesTrace_ws    at ":CC::STR:(mjsSHNodesTrace_ws)
ModuleSHT_Padding1 #  752-12-4*ModuleSHT_Entries-11*4-12*4 ;spare
  |
ModuleSHT_Padding1 #  752-12-4*ModuleSHT_Entries-11*4      ;spare
  ]
;
      ASSERT @@ = &C34 + 752
;
;was:
;OldIRQ1Vspace       # 752

d1461 1
a1461 1
SWIDespatch_Size        *       33*4
d1524 10
a1533 11
;;;mjs change for Ursula:
;;;SVCSTK and SysHeapStart are no longer exported, there is a run-time mechanism to get
;;;these values, via OS_ReadSysInfo 6, these values themselves have changed for Ursula

                    ^       SysHeapChunkAddress

                    #       SVCStackSize
SVCSTK              #       0
SysHeapStart        #       0
      ! 0, "SVCSTK                at ":CC::STR:(SVCSTK)
      ! 0, "SysHeapStart          at ":CC::STR:(SysHeapStart)
@


4.2.2.6
log
@added support for Sparse dynamic areas
fixed performance disaster caused by naff API for Shrinkable areas
implemented clamps for dynamic areas max size
configured kernel to not own or create RAMFS area (needs new RAMFS)
AMBControl now uses system heap for space, not RMA
AMBControl enables Lazy task swapping if running on rev T or better SA
kernel now assumes there could be code above 64M
SWIS for limited 32 bit user code support implemented
Long command lines implemented (1k instead of 256)
Fast service call distribution implemented (uses Ursula module format)
*fx,*key etc now allow missing space before first parameter
*configure is reinstated (bug fix)
@
text
@d218 10
a227 12
DANode_Link       #     4               ; points to next node
DANode_Number     #     4               ; number of this area
DANode_Base       #     4               ; base address of area (points in middle of doubly-mapped areas)
DANode_Flags      #     4               ; various flags
DANode_Size       #     4               ; current size of area (not counting holes, if Sparse area)
DANode_MaxSize    #     4               ; maximum size of area
DANode_Workspace  #     4               ; workspace pointer when calling handlers
DANode_Handler    #     4               ; pointer to handler routine for area
DANode_Title      #     4               ; pointer to area title
DANode_SubLink    #     4               ; next node in any disjoint sublist (currently used for Shrinkables only)
DANode_SparseHWM  #     4               ; high water mark, if Sparse area (highest base+size claimed for area)
DANode_NodeSize   #     0
a256 5
;Ursula
;following dynamic area only used if LongCommandLines is {TRUE}
KbuffsBaseAddress  * &2078000   ;just above reserved area for fake 480k screen
KbuffsMaxSize      * &0088000   ;544k (takes us up to start of RMA)

d1008 1
a1009 1
      ! 0, "Oscli_CmdHashSum      at ":CC::STR:(Oscli_CmdHashSum)
a1011 7
Serv_SysChains          # 4          ;anchor for block handling 'system' service numbers, in range 1 to 255
Serv_UsrChains          # 4          ;anchor for block handling 'user' service numbers, > 255
Serv_AwkwardChain       # 4          ;anchor for chain handling non-compliant modules (no service table)
      ! 0, "Serv_SysChains        at ":CC::STR:(Serv_SysChains)
      ! 0, "Serv_UsrChains        at ":CC::STR:(Serv_UsrChains)
      ! 0, "Serv_AwkwardChain     at ":CC::STR:(Serv_AwkwardChain)

a1156 1
      ! 0, "&&&KeyWorkSpace          at ":CC::STR:(KeyWorkSpace)
d1214 1
a1214 6
  [ LongCommandLines
OldGeneralMOSBuffer # 256+4      ;spare
  |
GeneralMOSBuffer    # 256+4
      ! 0, "&&&GeneralMOSBuffer      at ":CC::STR:(GeneralMOSBuffer)
  ]
a1267 3
  [ LongCommandLines
OldEnvString      #     256         ;spare
  |
a1268 2
      ! 0, "&&&EnvString             at ":CC::STR:(EnvString)
  ]
a1290 3
Abort32_dumparea   # 6*4          ;info for OS_ReadSysInfo 7 - 32-bit PSR, fault address, 32-bit PC (room for two copies)
      ! 0, "Abort32_dumparea      at ":CC::STR:(Abort32_dumparea) 
;
d1309 1
a1309 1
ModuleSHT_Padding1 #  752-12-4*ModuleSHT_Entries-11*4-6*4-12*4 ;spare
d1311 1
a1311 1
ModuleSHT_Padding1 #  752-12-4*ModuleSHT_Entries-11*4-6*4      ;spare
d1451 2
a1452 5
  [ LongCommandLines
OldAliasExpansionBuffer #       100     ;spare, mjs: shouldn't this have been &100 ??!??
  |
AliasExpansionBuffer    #       100     ;mjs: shouldn't this be &100 ??!??
      ! 0, "&&&AliasExpansionBuffer     at ":CC::STR:(AliasExpansionBuffer)
a1453 2
ArgumentBuffer          *       AliasExpansionBuffer
  ]
d1455 1
a1459 1
      ! 0, "&&&ExprWSpace               at ":CC::STR:(ExprWSpace)
a1461 3
  [ LongCommandLines
    ;ExprBuff moved to Kernel buffers area
  |
a1462 1
  ]
d1466 1
a1467 6
  [ LongCommandLines
    ;exprSTRACC moved to Kernel buffers area
ExprStackLimit          *       @@ - exprBracDif + ExprWSpace + &100   ;keep 256 buffer zone for stack overflow
ExprStackStart          *       ScratchSpace + ScratchSpaceSize
  |
exprSTRACC              *       @@ - ExprBuff + ExprWSpace
a1469 1
  ]
a1470 2
      ! 0, "&&&ExprStackLimit           at ":CC::STR:(ExprStackLimit)
      ! 0, "&&&ExprStackStart           at ":CC::STR:(ExprStackStart)
a1549 1
      ! 0, "&&&KeyBuff               at ":CC::STR:(KeyBuff)
a1561 3
  [ LongCommandLines
OldOscliBuffs           |#|     (16+1)*&100   ;spare
  |
a1566 2
      ! 0, "&&&OscliCircBuffStart    at ":CC::STR:(OscliCircBuffStart)
  ]
d1596 9
a1604 12
                ^       SysHeapChunkAddress

                       #       SVCStackSize    ; svcstk size. Overflow will give abort
Export_SVCSTK          #       0
        ASSERT  Export_SVCSTK =  SVCSTK
        ASSERT ?Export_SVCSTK = ?SVCSTK

Export_SysHeapStart    #       0
        ASSERT  Export_SysHeapStart =  SysHeapStart
        ASSERT ?Export_SysHeapStart = ?SysHeapStart


a1606 45

; *****************************************************************************

  [ LongCommandLines

    ASSERT            LongCLISize >= 256+4     ;minimum size of GeneralMOSBuffer

;Kernel buffers area

                      ^  KbuffsBaseAddress

GeneralMOSBuffer      #  LongCLISize

EnvString             #  LongCLISize

AliasExpansionBuffer  #  LongCLISize
ArgumentBuffer        *  AliasExpansionBuffer

ExprBuff              #  LongCLISize
exprSTRACC            #  LongCLISize

OscliBuffSize         *  LongCLISize
OscliNoBuffs          *  16
RedirectBuff          #  OscliBuffSize
OscliCircBuffStart    #  OscliBuffSize * OscliNoBuffs
OscliCircBuffLimit    #  0

KbuffsEnd             #  0
KbuffsSize            *  KbuffsEnd - KbuffsBaseAddress  ;size of Kernel buffers area

    ASSERT            KbuffsSize <= KbuffsMaxSize

      ! 0, "Kbuffs                at ":CC::STR:(KbuffsBaseAddress)
      ! 0, "Kbuffs Size           is ":CC::STR:(KbuffsSize)

      ! 0, "&&&GeneralMOSBuffer      at ":CC::STR:(GeneralMOSBuffer)
      ! 0, "&&&EnvString             at ":CC::STR:(EnvString)
      ! 0, "&&&AliasExpansionBuffer  at ":CC::STR:(AliasExpansionBuffer)
      ! 0, "&&&ArgumentBuffer        at ":CC::STR:(ArgumentBuffer)
      ! 0, "&&&ExprBuff              at ":CC::STR:(ExprBuff)
      ! 0, "&&&exprSTRACC            at ":CC::STR:(exprSTRACC)
      ! 0, "&&&RedirectBuff          at ":CC::STR:(RedirectBuff)
      ! 0, "&&&OscliCircBuffStart    at ":CC::STR:(OscliCircBuffStart)

  ] ;LongCommandLines
@


4.2.2.7
log
@ - reestablish ownership of RAMFS dynamic area by kernel; this may be
   switched out again later, if new RAMFS takes over ownership
 - make ChangeDynamicArea allow re-entrancy slightly earlier on a shrink;
   now allows re-enter after page moves but before calling any post-shrink
   handler; this should fix problem with RAMFS and new FileCore (that now
   itself uses dynamic areas); needs testing once we pull a ROM together
 - Fix following bugs:
    - (new) kernel was keeping modules on active service chains during
      call to their finalise, now temporarily delinks them, as the API
      says it should; symptom eg. Zap 1.39 fails to quit (module Zap)
    - (longstanding) *help in a taskwindow was very dangerous (eg quit
      window, run other *help, start new window can all take out OS,
      by fundamentally cracking MessageTrans); fix: *help now does not
      keep MessageTrans descriptor on SVC stack (swapped out on pre-empt),
      now has re-entrancy guard, gives 'busy' error if reentered; minor
      infelicity is that busy message may be given on new *help after
      abandoning old one in taskwindow, but the next *help will work
    - (longstanding) *time could occasionally give a scrambled message on
      first call in a taskwindow (caused by multiple use of a general
      buffer)
@
text
@d1171 1
a1171 1
      ! 0, "KeyWorkSpace          at ":CC::STR:(KeyWorkSpace)
d1233 1
a1233 1
      ! 0, "GeneralMOSBuffer      at ":CC::STR:(GeneralMOSBuffer)
d1292 1
a1292 1
      ! 0, "EnvString             at ":CC::STR:(EnvString)
d1317 1
a1317 5
      ! 0, "Abort32_dumparea      at ":CC::STR:(Abort32_dumparea)
;
Help_guard         # 4            ;for *help, guard against foreground re-entrancy (multiple taskwindows)
Help_msgdescr      # 4*4          ;for *help, 4 words MessageTrans descriptor
      ! 0, "Help_guard            at ":CC::STR:(Help_guard)
d1337 1
a1337 1
ModuleSHT_Padding1 #  752-12-4*ModuleSHT_Entries-11*4-6*4-5*4-12*4 ;spare
d1339 1
a1339 1
ModuleSHT_Padding1 #  752-12-4*ModuleSHT_Entries-11*4-6*4-5*4      ;spare
d1483 1
a1483 1
      ! 0, "AliasExpansionBuffer     at ":CC::STR:(AliasExpansionBuffer)
d1492 1
a1492 1
      ! 0, "ExprWSpace            at ":CC::STR:(ExprWSpace)
d1514 2
a1515 2
      ! 0, "ExprStackLimit        at ":CC::STR:(ExprStackLimit)
      ! 0, "ExprStackStart        at ":CC::STR:(ExprStackStart)
d1595 1
a1595 1
      ! 0, "KeyBuff               at ":CC::STR:(KeyBuff)
d1616 1
a1616 1
      ! 0, "OscliCircBuffStart    at ":CC::STR:(OscliCircBuffStart)
d1696 8
a1703 8
      ! 0, "GeneralMOSBuffer      at ":CC::STR:(GeneralMOSBuffer)
      ! 0, "EnvString             at ":CC::STR:(EnvString)
      ! 0, "AliasExpansionBuffer  at ":CC::STR:(AliasExpansionBuffer)
      ! 0, "ArgumentBuffer        at ":CC::STR:(ArgumentBuffer)
      ! 0, "ExprBuff              at ":CC::STR:(ExprBuff)
      ! 0, "exprSTRACC            at ":CC::STR:(exprSTRACC)
      ! 0, "RedirectBuff          at ":CC::STR:(RedirectBuff)
      ! 0, "OscliCircBuffStart    at ":CC::STR:(OscliCircBuffStart)
@


4.2.2.8
log
@ - Fix problem with OS_DynamicArea 8 (clamps on maximum size).
   If clamp was less than requested initial size, clamp was still being
   applied, which breaks API of OS_DynamicArea 0 by giving less than
   requested size without returning error.
   Fix is to allow requested initial size to defeat clamp, which is also
   much more useful (allows max size to float up to what client obviously
   needs).
 - Kernel now enumerates dynamic areas in alphabetical order - gives much
   neater switcher display with only small extra cost on area creation
   (getting switcher to do sort would be expensive/messy). Performance
   here still wipes the floor with old kernels.
@
text
@a228 1
DANode_SortLink   #     4               ; next node in alphabetically sorted list
@


4.2.2.8.2.1
log
@Changed compile switches, to build Ursula kernel for RPC and A7000(+),
switches now set as follows:
  ARM67Support      TRUE  (for 610,710,7500,7500FE)
  ARMSASupport      TRUE  (for StrongARM)
  ARMSASupport_RevS FALSE (for StrongARMs before rev S)
  IOMD1Support      TRUE  (for old machines)
  IOMD2Support      FALSE (They killed Phoebe!)
Version set to 4.00 (RISC OS 4)
This is the same as my last commit to the Ursula branch
@
text
@d981 1
a981 7
ACS_SoftVIDMRD          * &00100000  ;   bit  20     VIDMRD emulate   - if no h/w VIDMRD, abort mechanism emulates 'dirty screen' flag here
                                     ;                                  if h/w VIDMRD, used as sticky soft copy of 'dirty screen' flag in bit 0 of h/w VIDMRD
                                     ;                                  (sticky because h/w flag clears on read, but s/w flag may need to persist)
ACS_VSCpending_MASK     * &03100000  ;               VSCcountdown OR SoftVIDMRD
ACS_HardVIDMRD          * &00080000  ;   bit  19     VIDMRD present   - set only if VIDMRD h/w register available (IOMD2)
ACS_MiniDataCache       * &00040000  ;   bit  18     mini cache       - clear for SA-110, set for SA-120 (has 1k mini data cache, kernel uses it for screen)
                                     ;   bit  0..17  reserved         - 0
a1049 2
                                ; mjs: Ursula needs to support an extra 4 pairs for Phoebe, since each SDRAM bank
                                ;      appears as two fragments - this is accommodated by extra pairs allocated for Morris
d1062 1
d1065 1
d1068 1
a1068 2
SoftROMaddr     #       4       ; reserved physical adddress for soft ROM (0 if none, currently non-0 for Phoebe only)
      ! 0, "SoftROMaddr           at ":CC::STR:(SoftROMaddr)
d1080 1
d1085 3
d1092 1
a1095 1
      ! 0, "SkippedTablesEnd      at ":CC::STR:(SkippedTablesEnd)
d1098 6
a1323 8
PCI_status         # 4            ;bit 0 = 1 if PCI exists or 0 if PCI does not exist, bits 1..31 reserved (0)
      ! 0, "PCI_status            at ":CC::STR:(PCI_status)
IOMD_NoInterrupt          # 4     ;no. of irq devices for extant IOMD
IOMD_DefaultIRQ1Vcode     # 4     ;default irq code start address (ROM) for extant IOMD
IOMD_DefaultIRQ1Vcode_end # 4     ;default irq code end address (ROM)
IOMD_Devices              # 4     ;default irq devices table address (ROM)
      ! 0, "IOMD_NoInterrupt      at ":CC::STR:(IOMD_NoInterrupt)
;
d1342 1
a1342 1
ModuleSHT_Padding1 #  752-12-4*ModuleSHT_Entries-11*4-6*4-5*4-4-4*4-12*4 ;spare
d1344 1
a1344 1
ModuleSHT_Padding1 #  752-12-4*ModuleSHT_Entries-11*4-6*4-5*4-4-4*4      ;spare
d1628 1
d1630 3
@


4.2.2.9
log
@Phoebe aware version of kernel
Source currently builds for Phoebe only. Flipping source switches will
build for Risc PC and/or A7000(+) as well (or instead). Not tested
much on older platforms.
Known issues remaining:
 - on Phoebe, kernel does not always set up the video (new VCO)
   properly. It appears that anything via the display manager is ok,
   old modes are ok before a monitor definition is seen, but mode
   changes via applications in the desktop always/often (?) aren't.
   Most likely area for investigation is whether kernel catches all
   mode change routes for ensuring it programs the new VCO.
 - on Phoebe, kernel does not yet have the hooks to support multiple
   CPU(s) (to park the slaves and allow them to be used later). I
   have a technical note on this, which should be archived as part of
   the Ursula burial work.
 - on older platforms, the areas that need checking most are CMOS
   power on reset (when in ROM) and mode changes by all routes (since
   these areas are bent by Phoebe support)
Note that kernel currently builds for rev S or better StrongARM. The
switch ARMSASupport_RevS should be set false if building for Risc PC.
@
text
@d981 1
a981 7
ACS_SoftVIDMRD          * &00100000  ;   bit  20     VIDMRD emulate   - if no h/w VIDMRD, abort mechanism emulates 'dirty screen' flag here
                                     ;                                  if h/w VIDMRD, used as sticky soft copy of 'dirty screen' flag in bit 0 of h/w VIDMRD
                                     ;                                  (sticky because h/w flag clears on read, but s/w flag may need to persist)
ACS_VSCpending_MASK     * &03100000  ;               VSCcountdown OR SoftVIDMRD
ACS_HardVIDMRD          * &00080000  ;   bit  19     VIDMRD present   - set only if VIDMRD h/w register available (IOMD2)
ACS_MiniDataCache       * &00040000  ;   bit  18     mini cache       - clear for SA-110, set for SA-120 (has 1k mini data cache, kernel uses it for screen)
                                     ;   bit  0..17  reserved         - 0
a1049 2
                                ; mjs: Ursula needs to support an extra 4 pairs for Phoebe, since each SDRAM bank
                                ;      appears as two fragments - this is accommodated by extra pairs allocated for Morris
d1062 1
d1065 1
d1068 1
a1068 2
SoftROMaddr     #       4       ; reserved physical adddress for soft ROM (0 if none, currently non-0 for Phoebe only)
      ! 0, "SoftROMaddr           at ":CC::STR:(SoftROMaddr)
d1080 1
d1085 3
d1092 1
a1095 1
      ! 0, "SkippedTablesEnd      at ":CC::STR:(SkippedTablesEnd)
d1098 6
a1323 8
PCI_status         # 4            ;bit 0 = 1 if PCI exists or 0 if PCI does not exist, bits 1..31 reserved (0)
      ! 0, "PCI_status            at ":CC::STR:(PCI_status)
IOMD_NoInterrupt          # 4     ;no. of irq devices for extant IOMD
IOMD_DefaultIRQ1Vcode     # 4     ;default irq code start address (ROM) for extant IOMD
IOMD_DefaultIRQ1Vcode_end # 4     ;default irq code end address (ROM)
IOMD_Devices              # 4     ;default irq devices table address (ROM)
      ! 0, "IOMD_NoInterrupt      at ":CC::STR:(IOMD_NoInterrupt)
;
d1342 1
a1342 1
ModuleSHT_Padding1 #  752-12-4*ModuleSHT_Entries-11*4-6*4-5*4-4-4*4-12*4 ;spare
d1344 1
a1344 1
ModuleSHT_Padding1 #  752-12-4*ModuleSHT_Entries-11*4-6*4-5*4-4-4*4      ;spare
d1628 1
d1630 3
@


4.2.4.1
log
@File merged from Spinner branch
@
text
@d949 5
d1025 8
a1055 20
        ! 0, "Free space after ProcVec = ":CC::STR:(&320-@@)

        ASSERT  @@ <= &320
                #       &320-@@
  [ STB
    [	E2ROMSupport
NVRamSize	#	1		; Size of NVRam (E2ROM & CMOS) fitted in 256byte units
RTCFitted	#	1		; flag =1 iff RTC is fitted
    ]
Export_ResetType	#	1	; &322 ; bit 0 => 1 = por, 0 = not por ; bits 1-7 reserved (zero)
        ASSERT  Export_ResetType =  ResetType
        ASSERT ?Export_ResetType = ?ResetType
  ]

                AlignSpace

EnvString         #     256

	! 0, "Free space after EnvString = ":CC::STR:(&500-@@)

a1066 2
	! 0, "Free space after CamMap debug block = ":CC::STR:((JordanWS+256*4)-@@)

d1179 4
a1182 1
                AlignSpace
d1186 1
d1191 3
a1193 8
 [ FullCMOSRAMCache
CMOSRAMCache    #       1008
 |
CMOSRAMCache    #       240

 ! 0, "CMOSRAMCache only ":CC::STR:(@@-CMOSRAMCache):CC:" bytes"

CMOSRAMCacheNotUsed # 1008-240
a1194 4
 ! 0, "Hence free space after CMOSRAMCache = ":CC::STR:(@@-CMOSRAMCacheNotUsed)
 ]

; !!!! The following isn't going to work anymore !!!!
d1201 1
@


4.1
log
@Initial revision
@
text
@d197 1
d199 9
d702 1
a702 1
; buffer used for VDU 4 / 5 text plotting.  
d823 6
d880 1
a880 1
                       ^       &100 
d946 1
d949 23
a971 1
                AlignSpace 16   ; skipped bit must start on 16-byte boundary
d997 1
a997 1
VRAMSize        #       4       ; Amount of VRAM (in bytes) (may be more than 2M)
d1006 1
d1008 13
a1020 1
CLine_Softcopy  #        1      ; Added for Morris - Monitor id
d1022 1
a1022 1
                AlignSpace 16   ; skipped bit must end on 16-byte boundary
d1026 9
d1056 6
d1193 1
a1193 1
OldIRQ1Vspace       # 752                                  
d1375 1
a1375 1
TopOfDMAPhysRAM         *       &80000            ; OFFSET in physram 
d1456 1
a1456 1
DefIRQ1Vspace           *       12*4+12*23+2*256+64 + 5*12+3*4+32 ;Morris adds 5 more
@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@a196 1
; 28-Mar-95  JRH         Added NVRamSize and RTCFitted, conditioned on E2ROMSupport
a197 2
; 18-Jan-96  JRH         Removed CLine_Softcopy cos not needed
; 06-Feb-96  SMC         Increased DefIRQ1Vspace for IRQC registers
d692 1
a692 1
; buffer used for VDU 4 / 5 text plotting.
d864 1
a864 1
                       ^       &100
d958 1
a958 1
VRAMSize        #       4       ; Amount of VRAM (in bytes) (may be more than 2M) (at &200 last time I checked)
d967 1
a973 10
  [	E2ROMSupport
NVRamSize	#	1		; Size of NVRam (E2ROM & CMOS) fitted in 256byte units
RTCFitted	#	1		; flag =1 iff RTC is fitted
  ]
Export_ResetType	#	1	; &322 ; bit 0 => 1 = por, 0 = not por ; bits 1-7 reserved (zero)
        ASSERT  Export_ResetType =  ResetType
        ASSERT ?Export_ResetType = ?ResetType

                AlignSpace

d1126 1
a1126 1
OldIRQ1Vspace       # 752
d1308 1
a1308 1
TopOfDMAPhysRAM         *       &80000            ; OFFSET in physram
d1389 1
a1389 1
DefIRQ1Vspace           *       12*4+12*23+2*256+64 + 7*4+12*16+32+256 ;Morris adds 2 more IRQ registers
@


4.1.7.2
log
@Extended CMOSRAMCache to 1008 bytes but only if FullCMOSRAMCache is true.
@
text
@d935 1
a935 1
                AlignSpace 32   ; skipped bit must start on 16-byte boundary
d972 13
a984 2
                AlignSpace 32   ; skipped bit must end on 16-byte boundary
SkippedTablesEnd  #      0
a1006 19
        ! 0, "Free space after ProcVec = ":CC::STR:(&320-@@)

        ASSERT  @@ <= &320
                #       &320-@@

  [	E2ROMSupport
NVRamSize	#	1		; Size of NVRam (E2ROM & CMOS) fitted in 256byte units
RTCFitted	#	1		; flag =1 iff RTC is fitted
  ]
Export_ResetType	#	1	; &322 ; bit 0 => 1 = por, 0 = not por ; bits 1-7 reserved (zero)
        ASSERT  Export_ResetType =  ResetType
        ASSERT ?Export_ResetType = ?ResetType

                AlignSpace

EnvString         #     256

	! 0, "Free space after EnvString = ":CC::STR:(&500-@@)

a1011 2
	! 0, "Free space after CamMap debug block = ":CC::STR:((JordanWS+256*4)-@@)

d1124 4
a1127 1
                AlignSpace
d1131 1
d1136 3
a1138 6
 [ FullCMOSRAMCache
CMOSRAMCache    #       1008
 |
CMOSRAMCache    #       240

 ! 0, "CMOSRAMCache only ":CC::STR:(@@-CMOSRAMCache):CC:" bytes"
a1139 6
CMOSRAMCacheNotUsed # 1008-240

 ! 0, "Hence free space after CMOSRAMCache = ":CC::STR:(@@-CMOSRAMCacheNotUsed)
 ]

; !!!! The following isn't going to work anymore !!!!
d1146 1
@


4.1.7.3
log
@Added support for 2K EEPROM.
@
text
@d1001 1
a1001 1
  [ E2ROMSupport
a1004 1

a1007 4

  [ E2ROMSupport
NVRamBase       #       1               ; Base of NVRam
  ]
@


4.1.7.4
log
@Removed FullCMOSRAMCache support.
Increased CMOSRAMCache to 256 bytes.
@
text
@d1147 11
a1157 1
CMOSRAMCache    #       256
@


4.1.7.5
log
@Reset all OSByte variables on Hard Reset
@
text
@d369 2
a383 1
HardResetVars # 0              ; Reset to here on hard reset
@


4.1.7.6
log
@Added SWI OS_VIDCDivider, and vdu variable PixelRate for better video mode
support.  Fixed to build for Risc PC.
@
text
@a200 1
; 21-Jul-98  NDT         Added PixelRate.  Moved KernelModeSelector to make space.
d655 2
a656 3
 [ ChrontelSupport
PixelRate # 4   ; Pixel Rate in kHz
 ]
a814 3
KernelModeSelector # 4  ; pointer to block in system heap where
                        ; current mode selector is copied

a1004 1
  [ STB
a1007 1
 ]
@


4.1.7.7
log
@Support added for 24LC128 16K EEPROM device.
OS_NVMemory SWI added to allow block operations on non-volatile memory.
Kernel can clock memory device at 400kHz for greater throughput.
Safeguards added to stop the device being accessed when the clock is changed
and the device doesn't have an RTC.
Changed to use srccommit.

Version 4.63, 1.1.2.2. Tagged as 'Kernel-4_63-1_1_2_2'
@
text
@a1017 2
NVRamSpeed      #       1               ; Clock hold time in 0.5s units
NVRamPageSize   #       1               ; Page size for writing (log2)
a1018 1

@


4.1.5.1
log
@Import from SrcFiler
@
text
@a196 1
; 28-Mar-95  JRH         Added NVRamSize and RTCFitted, conditioned on E2ROMSupport
a197 2
; 18-Jan-96  JRH         Removed CLine_Softcopy cos not needed
; 06-Feb-96  SMC         Increased DefIRQ1Vspace for IRQC registers
d692 1
a692 1
; buffer used for VDU 4 / 5 text plotting.
d864 1
a864 1
                       ^       &100
d958 1
a958 1
VRAMSize        #       4       ; Amount of VRAM (in bytes) (may be more than 2M) (at &200 last time I checked)
d967 1
a973 10
  [	E2ROMSupport
NVRamSize	#	1		; Size of NVRam (E2ROM & CMOS) fitted in 256byte units
RTCFitted	#	1		; flag =1 iff RTC is fitted
  ]
Export_ResetType	#	1	; &322 ; bit 0 => 1 = por, 0 = not por ; bits 1-7 reserved (zero)
        ASSERT  Export_ResetType =  ResetType
        ASSERT ?Export_ResetType = ?ResetType

                AlignSpace

d1126 1
a1126 1
OldIRQ1Vspace       # 752
d1308 1
a1308 1
TopOfDMAPhysRAM         *       &80000            ; OFFSET in physram
d1389 1
a1389 1
DefIRQ1Vspace           *       12*4+12*23+2*256+64 + 7*4+12*16+32+256 ;Morris adds 2 more IRQ registers
@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@a197 4
; 07-Feb-95  WT          Added LCD_Active for LCD/CRT dynamic switching support
; 07-Feb-95  WT          Added VStartSoftCopy for dual-panel LCD support
; 18-May-95  WT          Added LCD_Inverted for LCD inversion (well, surprise surprise!)
; 05-Dec-95  WT          Added ProcessorType and ProcessorFlags (1 byte each)
d692 1
a692 1
; buffer used for VDU 4 / 5 text plotting.
d864 1
a864 1
                       ^       &100
a929 1
VStartSoftCopy  #       4       ; soft copy of VStart so we can calculate VIDINITB correctly
a930 12
AMBControl_ws   #       4       ; workspace anchor word for AMBControl
ARMA_Cleaner_flipflop # 4       ; address of 16k StrongARM data cache cleaner area (flip flops between two)
SyncCodeA_sema  #       1       ; re-entrancy semaphore for SynchroniseCodeAreas (full address space version)
 ! 0, "AMBControl_ws  at  ":CC::STR:(AMBControl_ws)
 ! 0, "ARMA_Cleaner_flipflop at ":CC::STR:(ARMA_Cleaner_flipflop)
 ! 0, "SyncCodeA_sema (byte) at ":CC::STR:(SyncCodeA_sema)
 [ StorkPowerSave
;;;   AlignSpace 4
;;;VIDCExternalSoftCopy #  4       ; soft copy of VIDCExternal
;;;VIDCFSynSoftCopy     #  4       ; soft copy of VIDCFSyn
;;;VIDCControlSoftCopy  #  4       ; soft copy of VIDCControl
 ]
d968 1
a968 13
CLine_Softcopy  #       1       ; Added for Morris - Monitor id

LCD_Active      #       1       ; Added to support LCD/CRT switching. bm 6 bits 0=>External CRT in use, 1=>Mono, 2=>Passive colour, 3=>Active colour
                                ;                                     bit 7     unset=>single panel, set=>dual panel
LCD_Inverted    #       1       ; Added to support LCD palette inversion. 0=normal, 1=inverted. Note that the inversion is invisible to apps.
 ! 0, "LCD_Active flag byte held at  ":CC::STR:(LCD_Active)

 [ StrongARM
ProcessorType   #       1       ; Processor type (handles 600 series onwards)
ProcessorFlags  #       1       ; Processor flags (IMB, Arch4 etc)
 ! 0, "ProcessorType  at  ":CC::STR:(ProcessorType)
 ! 0, "ProcessorFlags at  ":CC::STR:(ProcessorFlags)
 ]
a994 6
 [ StorkPowerSave
VIDCExternalSoftCopy #  4       ; soft copy of VIDCExternal
VIDCFSynSoftCopy     #  4       ; soft copy of VIDCFSyn
VIDCControlSoftCopy  #  4       ; soft copy of VIDCControl
 ]

d1126 1
a1126 1
OldIRQ1Vspace       # 752
d1308 1
a1308 1
TopOfDMAPhysRAM         *       &80000            ; OFFSET in physram
d1351 1
@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
