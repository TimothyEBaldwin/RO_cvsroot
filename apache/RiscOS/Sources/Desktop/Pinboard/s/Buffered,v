head	4.7;
access;
symbols
	Pinboard-1_04:4.7
	Pinboard-1_03:4.7
	Pinboard-1_02:4.7
	Pinboard-1_01:4.7
	Pinboard-1_00:4.7
	Pinboard-0_99:4.7
	Pinboard-0_98:4.7
	Pinboard-0_97:4.7
	Pinboard-0_96:4.7
	Pinboard-0_95:4.7
	Pinboard-0_94:4.7
	Pinboard-0_93:4.7
	Pinboard-0_92:4.5
	Pinboard-0_91:4.4
	Pinboard-0_90:4.4
	Pinboard-0_89:4.4
	Pinboard-0_88:4.4
	Pinboard-0_87:4.4
	Pinboard-0_86:4.4
	Pinboard-0_85:4.4
	Pinboard-0_84:4.4
	Pinboard-0_83:4.4
	Pinboard-0_82:4.4
	RO_5_07:4.4
	Pinboard-0_81:4.4
	Pinboard-0_80:4.4
	Pinboard-0_79:4.4
	Pinboard-0_78:4.4
	Pinboard-0_77:4.3
	Pinboard-0_76:4.3
	Ursula_merge:4.1.4.5
	Pinboard-0_75:4.2
	mstphens_UrsulaRiscPCBuild_20Nov98:4.1.4.5
	Ursula_RiscPC:4.1.4.5.0.2
	rleggett_Pinboard-0_75d:4.1.4.5
	rthornb_UrsulaBuild-19Aug1998:4.1.4.5
	UrsulaBuild_FinalSoftload:4.1.4.5
	rthornb_UrsulaBuild-12Aug1998:4.1.4.5
	aglover_UrsulaBuild-05Aug1998:4.1.4.5
	rthornb_UrsulaBuild-29Jul1998:4.1.4.5
	rthornb_UrsulaBuild-22Jul1998:4.1.4.5
	rleggett_Pinboard-0_75c:4.1.4.5
	rleggett_Pinboard-0_75b:4.1.4.5
	rleggett_Pinboard-0_75:4.1.4.5
	rthornb_UrsulaBuild-15Jul1998:4.1.4.5
	rthornb_UrsulaBuild-07Jul1998:4.1.4.5
	rthornb_UrsulaBuild-17Jun1998:4.1.4.5
	rthornb_UrsulaBuild-03Jun1998:4.1.4.5
	rthornb_UrsulaBuild-27May1998:4.1.4.5
	rthornb_UrsulaBuild-21May1998:4.1.4.4
	rleggett_Pinboard-0_74:4.1.4.4
	rthornb_UrsulaBuild_01May1998:4.1.4.4
	Spinner_B20_2:4.1.7.1
	Spinner_19_3:4.1.7.1
	Spinner_B18:4.1.7.1
	Spinner_B17:4.1.7.1
	Spinner_B15:4.1.7.1
	Spinner_B14:4.1.7.1
	Spinner_B13:4.1.7.1
	Spinner_B12:4.1.7.1
	Spinner_B10:4.1.7.1
	Daytona:4.1.0.6
	Daytona_bp:4.1
	Ursula:4.1.0.4
	Ursula_bp:4.1
	Spinner_B7:4.1.7.1
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	ARTtmp:4.1.7.1.0.2
	Spin_merge:4.1.7.1
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.7
date	2011.09.24.07.31.19;	author rsprowson;	state Exp;
branches;
next	4.6;
commitid	nRjnbtmOSxK1BIAv;

4.6
date	2011.09.24.07.25.50;	author rsprowson;	state Exp;
branches;
next	4.5;
commitid	NapphrXjtkIXyIAv;

4.5
date	2011.09.19.07.41.57;	author rsprowson;	state Exp;
branches;
next	4.4;
commitid	90jvproiNPICO4Av;

4.4
date	2002.11.11.12.34.51;	author rsprowson;	state Exp;
branches;
next	4.3;

4.3
date	2001.03.16.17.07.02;	author sbrodie;	state Exp;
branches;
next	4.2;

4.2
date	99.08.17.19.05.16;	author sbrodie;	state Exp;
branches;
next	4.1;

4.1
date	96.11.05.09.29.58;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.4.1
	4.1.5.1
	4.1.7.1;
next	;

4.1.1.1
date	96.11.05.09.29.58;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.05.23.29.42;	author nturton;	state Exp;
branches;
next	;

4.1.4.1
date	97.10.21.09.56.53;	author rleggett;	state Exp;
branches;
next	4.1.4.2;

4.1.4.2
date	97.12.05.09.39.59;	author rleggett;	state Exp;
branches;
next	4.1.4.3;

4.1.4.3
date	98.03.27.09.36.27;	author rleggett;	state Exp;
branches;
next	4.1.4.4;

4.1.4.4
date	98.04.15.11.24.38;	author rleggett;	state Exp;
branches;
next	4.1.4.5;

4.1.4.5
date	98.05.26.11.14.25;	author rleggett;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.12.20.46;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.20.18.39;	author nturton;	state Exp;
branches;
next	;


desc
@@


4.7
log
@Shade "Configure..." when boot was unsuccessful.
When BootResources$Path is unset the option to run the configure plugin is no longer available.
Shared a "Filer_Run " string in 3x places.
Replaced most occurrences of calling XOS_ReadModeVariable of the current mode's XEig and YEig factors to use the cached copy sitting unloved in the workspace. Should thrash less during redraw.

Version 0.93. Tagged as 'Pinboard-0_93'
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
; s.Buffered
;
; Handle buffered list of actions
;
;


;------------------------------------
; ReadBufferedList
; Reads and acts on the buffered list actions.
;
;
ReadBufferedList ROUT

        Push    "LR"

01
        Pull    "PC",VS
        LDR     r2,Buffered_list
        CMP     r2,#0
        Pull    "PC",EQ                 ; No more in list

        LDR     r14,[r2,#ic_next]
        Debug   sa,"Next block is ",r14
        STR     r14,Buffered_list       ; Unlink from list

        LDR     r0,[r2,#ic_action]
        Debug   sa,"Action is ",r0

        MOV     LR,PC
        ADD     PC,PC,r0,ASL #2
        B       %BT01
        B       AddIconXY               ; 0 = Add icon at x y
        B       RemoveIcon              ; 1 = Remove icon given path.
        B       AddTinyDirs             ; 2 = Add TinyDirs icon.
        B       AddIconXY               ; 3 = Add new TinyDir to icon bar.
        B       RemoveAllTinyDirs
        B       RemoveAllPinboard
        B       AddIconXY

RemoveAllPinboard
        Push "LR"

        MOV     r0,#ModHandReason_Free
        SWI     XOS_Module
        Pull    "PC",VS

        Debug   sa,"Remove all pinboard icons"
        LDR     r0,backdrop_handle
        BL      SelectFileIcons
        LDR     r0,backdrop_handle
        BL      RemoveIcons

        ;LDR     r0,poll_word
        ;TST     r0,#PollWordReason_Recache
        ;BLEQ    ClearBackdrop           ; Clear the backdrop if no recache pending

        Pull    "PC"

RemoveAllTinyDirs

        Push "LR"

        Debug   td,"Remove all TDs"

        MOV     r0,#ModHandReason_Free
        SWI     XOS_Module
        Pull    "PC",VS

        MOV     r0,#-2
        BL      SelectFileIcons
        MOV     r0,#-2
        BL      RemoveIcons

        Pull    "PC"


AddTinyDirs
        Push    "LR"

        MOV     r0, #ModHandReason_Free         ; Delete buffered icon block
        SWI     XOS_Module
        Pull    "PC",VS

        Debug   sa,"Block deleted"
Int_AddTinyDirs
        LDR     r0, TinyDirs_Handle             ; Do nothing if already exists
        CMP     r0, #0
        Debug   sa,"Handle is ",r0
        Pull    "PC",GE

        Debug   sa,"Doesn't already exist"


        LDR     r0,TinyDirs_Icons
        CMP     r0,#0
        Pull    "PC",GT                         ; Do nothing if there are other icons.

        Debug   sa,"number of icons is 0"

        ADR     r2, tinydirs_icon_name          ; Add Tinydirs icon
        MOV     r0, #SpriteReason_ReadSpriteSize
        SWI     XWimp_SpriteOp
        Pull    "PC",VS

        Debug   sa,"Sprite found"

        MOV     r0, r6                          ; creation mode of sprite
        MOV     r1, #VduExt_XEigFactor
        SWI     XOS_ReadModeVariable
        MOVVC   r5, r3, LSL r2
        MOVVC   r3, #0
        MOVVC   r1, #VduExt_YEigFactor
        SWIVC   XOS_ReadModeVariable
        Pull    "PC",VS
        MOV     r6, r4, LSL r2
        ADD     r6, r6, #20
        MOV     r4, #20
        Debug   sa,"Creating icon"

        ADR     r1, tinydirs_icon_block         ; Transfer data
        LDMIA   r1, {r7,r8,r9,r10}
        ADR     r1, dataarea
        MOV     r2, #-2
        STMIA   r1, {r2,r3,r4,r5,r6,r7,r8,r9,r10}
        SWI     XWimp_CreateIcon
        Pull    "PC",VS

        Debug   sa,"Icon created"

        STR     r0, TinyDirs_Handle
        Pull    "PC"

tinydirs_icon_block
        DCD     &0000301A
tinydirs_icon_name
        DCB     "Directory",0,0,0
        ALIGN


; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; AddIconXY
;
; The buffered list contained an AddIcon reason code. Add the icon!

AddIconXY       ROUT
                Entry

        MOV     r10, r2
        MOV     r11, r0
        Debug   im,"Add icon at x, y"
        BL      GetIconSprite

        [ truncate_filenames
        LDR     r9, [r10, #ic_icontext] ; pointer to text to display for icon.
        ]

        ADD     r2,r10,#ic_spritename+1 ; Point at sprite
        MOV     r0,#40                  ; Get sprite info
        SWI     XWimp_SpriteOp
        EXIT    VS

        ; At this point, r6 = sprite mode r3=width r4=height (in pixels)
        ; Read X and Y eigen factors.
        MOV     r0,r6
        MOV     r1, #VduExt_XEigFactor
        SWI     XOS_ReadModeVariable
        MOVVC   r3,r3,ASL r2            ; r3 = width in OS units
        MOVVC   r1, #VduExt_YEigFactor
        SWIVC   XOS_ReadModeVariable
        MOVVC   r4,r4,ASL r2            ; r4 = height in OS units
        ADDVC   r4,r4,#&28
        EXIT    VS

        ; Get width of leafname in current desktop font
        MOV     r8,r9
        MOV     R0,#1
        MOV     R1,R9
        Push    "r2"
        MOV     R2,#0
        SWI     XWimp_TextOp
        Pull    "r2"
        CMP     r3,r0
        MOVLT   r3,r0

        CMP     r3, #grid_x_spacing
        MOVGT   r3, #grid_x_spacing
        SUBGT   r3, r3, #8

        ; See if icon is being placed on iconbar
        ADR     r1,dataarea
        LDR     r14,[r10,#ic_window]
        STR     r14,[r1]
        Debug   im,"Window ",r14
        CMP     r14,#0
        BGE     %FT01                   ; Not on iconbar

        ; On iconbar - tinydirs
        MOV     r0,#0
        STR     r0,[r1,#4]              ; x0 = 0
        MOV     r0,#-16                 ; y0 =-16
        STR     r0,[r1,#8]
        STR     r3,[r1,#12]             ; x1
        ADD     r0,r0,r4                ; y1
        STR     r0,[r1,#16]
        LDR     r14,tinydirs_icon_flags
        STR     r14,[r1,#20]
        B       %FT20

; Work out bounding box for icon
01
         LDR     r5, [r10, #ic_x]
         LDR     r6, [r10, #ic_y]
         CMP     r11, #BufferReason_AddAtXYWithoutLock
         BLNE    AddIcon_LockToGrid
         STR     r5, [r1, #4]
         STR     r6, [r1, #8]
         ADD     r5, r5, r3
         ADD     r6, r6, r4
         STR     r5, [r1, #12]
         STR     r6, [r1, #16]

;        LDR     r0,[r10,#ic_x]          ; x0
;        LDR     r14,Pinboard_options
;        TST     r14,#PinboardOption_Grid
;        MOV     r14,#grid_x_spacing
;        BEQ     %FT02
;        ADD     r0,r0,r14,LSR #1
;        DivRem  r5,r0,r14,r6
;        MUL     r0,r5,r14
;        STR     r0,[r10,#ic_x]

;02
;        SUBS    r5,r14,r3
;        ADDPL   r0,r0,r5,LSR #1         ; Centre in grid box

;        Debug   im,"X0 ",r0
;        STR     r0,[r1,#4]

;        ADD     r0,r0,r3                ; x1
;        Debug   im,"X1 ",r0
;        STR     r0,[r1,#12]

;        LDR     r0,[r10,#ic_y]          ;y1

;        LDR     r14,Pinboard_options
;        TST     r14,#PinboardOption_Grid
;        MOV     r14,#grid_y_spacing
;        BEQ     %FT03

;        LDR     r2,Screen_y1
;        SUB     r3,r2,r0
;        ADD     r3,r3,r14,LSR #1
;        DivRem  r5,r3,r14,r6
;        MUL     r0,r5,r14
;        SUB     r0,r2,r0
;        STR     r0,[r10,#ic_y]

;03
;        SUBS    r5,r14,r4
;        SUBPL   r0,r0,r5,LSR #1         ; Centre in grid box

;        SUB     r0,r0,r4
;        LDR     R14,icon_bar_height
;        CMP     R14,R0
;        MOVGT   R0,R14

;        Debug   im,"Y0 ",r0
;        STR     r0,[r1,#8]             ; y0

;        ADD     r0,r0,r4
;        Debug   im,"Y1 ",r0
;        STR     r0,[r1,#16]              ; y1

        LDR     r14,icon_flags
        STR     r14,[r1,#20]

20      ; Create icon
        STR     r9,[r1,#24]             ; -> Leaf Name
 [ technicolour_text
        LDR     r14,[r10,#ic_window]
        CMP     r14,#0
        ADDGE   r14,r10,#ic_valid_string
        ADDLT   r14,r10,#ic_spritename
 |
        ADD     r14,r10,#ic_spritename
 ]

        STR     r14,[r1,#28]            ; -> Validation string.
        MOV     r14,#14
        STR     r14,[r1,#32]            ; Length of sprite name
        SWI     XWimp_CreateIcon        ; Create the icon
        EXIT    VS
        STR     r0,[r10,#ic_icon]       ; Store the icon's handle

        ; Make sure ic_x and ic_y are correct
        LDR     r14, [r1, #4]
        STR     r14, [r10, #ic_x]
        LDR     r14, [r1, #8]
        STR     r14, [r10, #ic_y]

        ; Set icon state
        STR     r0,[r1,#4]
        MOV     r0,#0
        STR     r0,[r1,#8]
        STR     r0,[r1,#12]
        SWI     XWimp_SetIconState
        EXIT    VS

        ; Increment number of icons.
        LDR     r0,[r10,#ic_window]
        CMP     r0,#0                   ; if window handle is zero, it's a tinydir
        LDRLT   r0,TinyDirs_Icons
        LDRGE   r0,Pinboard_Icons
        ADD     r0,r0,#1
        STRLT   r0,TinyDirs_Icons
        STRGE   r0,Pinboard_Icons

        ; Now link the icon to the active icon list * AT END *
        ADR     r14,Icon_list
04
        LDR     r2,[r14,#ic_next]
        CMP     r2,#0
        MOVNE   r14,r2
        BNE     %BT04

        ; r14 -> Last item.
        STR     r10,[r14,#ic_next]
        STR     r14,[r10,#ic_prev]
        MOV     r0,#0
        STR     r0,[r10,#ic_next]

        LDR     r0,Pinboard_options
        TST     r0,#PinboardOption_TinyDirs
        EXIT    EQ                              ; No TinyDirs icon.

        LDR     r0,TinyDirs_Icons
        CMP     r0,#0
        EXIT    EQ                              ; No icons on icon bar.

        LDR     r0,TinyDirs_Handle
        CMP     r0,#0
        EXIT    LT                              ; No TinyDirs icon.

        ADR     r1,dataarea
        MOV     r14,#-2
        STR     r14,[r1]
        STR     r0,[r1,#4]
        SWI     XWimp_DeleteIcon
        MOV     r0,#-1
        STR     r0,TinyDirs_Handle
        EXIT

; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; AddIcon_LockToGrid
;
; Work out where to place an icon on the grid.
;
; In: r3, r4 - icon width and height
;     r5, r6 - x and y co-ord
;
; Out: r5, r6 - new x and y co-ord

AddIcon_LockToGrid Entry "r0"

        ; Check for Grid lock
        LDR     r0, Pinboard_options
        TST     r0, #PinboardOption_Grid
        BLNE    FindNearestGridXY

        ; No grid lock, so centre and return
        MOV     r0, #grid_x_spacing
        SUBS    r0, r0, r3
        MOVMI   r0, #0
        ADD     r5, r5, r0, LSR #1
        MOV     r0, #grid_y_spacing
        SUBS    r0, r0, r4
        MOVMI   r0, #0
        ADD     r6, r6, r0, LSR #1
        EXIT


;--------------------------------------------------------------------------
;Remove icon given path in icon block.
;Frees the input block, and the icon's block.
;
RemoveIcon      ROUT

        Push    "r0-r4,LR"

        LDR     r0,Icon_list
01
        Debug   pi,"Next icon is ",r0
        CMP     r0,#0
        Pull    "r0-r4,PC",EQ   ; End of list

        ADD     r1,r0,#ic_path
        ADD     r3,r2,#ic_path
        DebugS  pi,"First path is ",r1
        DebugS  pi,"Second path is ",r3
02
        LDRB    r14,[r1],#1
        BIC     r14,r14,#&20
        LDRB    r4 ,[r3],#1
        BIC     r4,r4,#&20
        TEQ     r4,r14
        LDRNE   r0,[r0,#ic_next]
        BNE     %BT01           ; Not equal, check next block.

        CMP     r14,#0          ; At end ?
        BNE     %BT02           ; No, check next character.

; Found icon, delete it.

        MOV     r4,r0

        ADR     r1,dataarea
        LDR     r0,[r4,#ic_window]
        STR     r0,[r1]
        LDR     r0,[r4,#ic_icon]
        STR     r0,[r1,#4]
        MOV     r0,#1:SHL:23
        ORR     r0,r0,#1:SHL:7
        STR     r0,[r1,#8]
        STR     r0,[r1,#12]
        SWI     XWimp_SetIconState
        STRVS   r0,[sp]
        Pull    "r0-r4,PC",VS

        ADR     r1,dataarea
        SWI     XWimp_DeleteIcon

        LDR     r0,[r1]
        CMP     r0,#0
        LDRLT   r0,TinyDirs_Icons
        LDRGE   r0,Pinboard_Icons
        SUB     r0,r0,#1
        STRLT   r0,TinyDirs_Icons
        STRGE   r0,Pinboard_Icons

        MOV     r0,#ModHandReason_Free
        SWI     XOS_Module

        LDR     r1,[r4,#ic_next]
        LDR     r2,[r4,#ic_prev]
        CMP     r2,#0
        STREQ   r1,Icon_list
        STRNE   r1,[r2,#ic_next]
        CMP     r1,#0
        STRNE   r2,[r1,#ic_prev]

        MOV     r2,r4
        SWI     XOS_Module
        STRVS   r0,[sp]
        Pull    "r0-r4,PC",VS

        BL      Redraw

        LDR     r0,Pinboard_options
        TST     r0,#PinboardOption_TinyDirs
        Pull    "r0-r4,PC",EQ

        LDR     r0,TinyDirs_Icons
        CMP     r0,#0
        Pull    "r0-r4,PC",NE

        MOV     r1,#-2
        MOV     r0,#BufferReason_AddTinyDirsIcon
        BL      BufferIcon
        STRVS   r0,[sp]
        Pull    "r0-r4,PC"


; GetIconSprite
;
; Entry
;       r2 -> Icon block
; Exit
;       r9 -> Leaf name.
;       Sprite name filled in icon block.

GetIconSprite   ROUT

        Push    "r0-r10,LR"

        MOV     r10,r2

        ADD     r9,r2,#ic_path
        MOV     r8,r9
01
        LDRB    r14,[r8],#1
        CMP     r14,#"."
        MOVEQ   r9,r8
        CMP     r14,#0
        BNE     %BT01

        DebugS  pi,"Leaf is ",r9

        LDR     r0,[r2,#ic_filetype]
        CMP     r0,#-1
        ADREQL  r0,SpriteName_Untyped
        BEQ     %FT10

        CMP     r0,#&1000               ; Directory ?
        BEQ     resolve_directorysprite

        CMP     r0,#&2000               ; Application.
        BNE     %FT01

        ; It's an application  Filer_Boot it to make sure we have the sprite.

        ADRL    r0,FilerBoot_command
        ADR     r1,dataarea
        BL      Copy_r0r1

        ADD     r0,r10,#ic_path
        BL      Copy_r0r1
        ADR     r0,dataarea
        DebugS  pi,"Boot command is ",r0
        SWI     XOS_CLI
        Debug   pi,"Returned from OS_CLI"
        Pull    "r0-r10,PC",VS

; Check that this sprite exists

        MOV     r0,#40                  ; Get sprite info
        MOV     r2,r9                   ; Sprite name = leaf name.
        SWI     XWimp_SpriteOp
        ADRVSL  r0,SpriteName_Application
        MOVVC   r0,r9

        B       %FT10

01                                      ; It's a file build name.
        Debug   pi,"Its a file"

        ADRL    r0,SpriteName_File
        ADR     r1,dataarea
        BL      Copy_r0r1
        LDR     r0,[r2,#ic_filetype]
        SUB     r1,r1,#1
        MOV     r2,#32
        SWI     XOS_ConvertHex4
        Pull    "r0-r10,PC",VS
        MOV     r14,#"_"
        STRB    r14,[r0]

; Check that this sprite exists

        MOV     r0,#40                  ; Get sprite info
        ADR     r2,dataarea
        DebugS  pi,"Check for ",r2
        SWI     XWimp_SpriteOp
        ADRVC   r0,dataarea
        ADRVS   r0,SpriteName_Untyped

10                                      ; r0 -> sprite name
 [ technicolour_text
        ADDS    r1,r10,#ic_valid_string
        BL      write_icon_valid_string
 |
        ADDS    r1,r10,#ic_spritename   ; Clears V
        MOV     r14,#"S"                ; "S" for validation string
        STR     r14,[r1],#1
        BL      Copy_r0r1
 ]
        STR     r9,[sp,#9*4]

        Debug   pi,"Returning"
        Pull    "r0-r10,PC"


resolve_directorysprite
; this is required as 'typed' directories (eg. archives and dos discs) get passed
; accross as ordinary directories.
        Push    "R1-R5"
        ADD     R1,R2,#ic_path
        MOV     R0,#OSFile_ReadNoPath
        SWI     XOS_File
        ADRVS   r0,SpriteName_Directory
        BVS     %FT80
        TEQ     R0,#3                                   ; image file?
        ADRNE   r0,SpriteName_Directory
        BNE     %FT80
        LDR     R4,=&fff00000
        AND     R3,R2,R4
        TEQ     R3,R4
        ADRNE   r0,SpriteName_Directory                 ; load/exec only!
        BNE     %FT80
; R2 bits 19...8 are the real type
        AND     R2,R2,R4, LSR #12
        ADR     r0,SpriteName_File
        ADR     r1,dataarea
        BL      Copy_r0r1
        MOV     r0,r2, LSR #8
        SUB     r1,r1,#1
        MOV     r2,#32
        SWI     XOS_ConvertHex4
        ADRVS   r0,SpriteName_Directory
        BVS     %FT80
        MOV     r14,#"_"
        STRB    r14,[r0]

; Check that this sprite exists

        MOV     r0,#40                  ; Get sprite info
        ADR     r2,dataarea

        SWI     XWimp_SpriteOp
        ADRVC   r0,dataarea
        ADRVS   r0,SpriteName_Directory
80
        Pull    "R1-R5"
        B       %BT10


SpriteName_Untyped      DCB     "File_xxx",0
SpriteName_Directory    DCB     "Directory",0
SpriteName_File         DCB     "File_",0
SpriteName_Application  DCB     "Application",0
FilerBoot_command       DCB     "Filer_Boot ",0
                        ALIGN
icon_flags              DCD     &4000A50B
tinydirs_icon_flags     DCD     &1700A50B



        LNK     Mouse.s
@


4.6
log
@Replace magic numbers with sumbols from header files for OS_ calls.
Same binary as 0.92, not tagged.
@
text
@d122 3
a124 3
        MOVVC   r0, r6                          ; creation mode of sprite
        MOVVC   r1, #VduExt_XEigFactor
        SWIVC   XOS_ReadModeVariable
@


4.5
log
@Restore *AddTinyDir <nothing> functionality.
See ticket #283.
Moved 'Status' document into Docs.
Merged 'Changes' into 'BlackLog' and delete.
Expanded 2x POPs of lr/pc cos ARM deprecated it.
Combined 2x MUL/ADD into MLA so the module is the same size.

Version 0.92. Tagged as 'Pinboard-0_92'
@
text
@d592 1
a592 1
        MOV     R0,#17
@


4.4
log
@Commented out "proginfo" string,no longer used.
Prefixed the pin and addtinydir commands that get saved in the
pinboard file with "X " so your pinboard setup continues even if a file
is no longer available.ROL did this with a new XPin command,not taken.
Merged changes from ROL to allow the icon text to be an arbitary colour
though this can be switched out with "technicolour_text" for the
purists.
Help entry added to the pinboard selection submenu,this will be greyed
out except when
 it's an app
 and it has a !help file
 and it is the only object selected
like the filer does.
Updated messages file accordingly.
Menu clicking on the "save pinboard settings" OK button no longer saves
the file,and adjust clicking keeps the menu tree open
 -> fixes bug report from 1998,now removed from "Status" file
Saveas template resized to match !Edit.
Fixed problem of select dragging a file to an app leaving the icon
selected (due to two conditional MOV R0's being followed by an
unconditional one for some reason).
 -> fixes bug report from 1998,now removed from "Status" file
Tweaked a few CMP#0 BLT's to test specifically for the iconbar handle.
The bug report in "Status" about bits of filenames being left on the
pinboard can be bodged by popping an ADD r0,r0,#16 after the XWimp_TextOp
in s.buffered but I've not done this yet.

Version 0.78. Tagged as 'Pinboard-0_78'
@
text
@d111 1
a111 1
        Pull    "PC",GE                         ; Do nothing if there are other icons.
@


4.3
log
@  Updated build structure to use the shared AAsmModule makefile.
  Updated to build using objasm instead of aasm.
  Sources changed to be objasm-compatible.
Admin:
  Requires Library 0.71 or later.
  Requires BuildSys 3.06 or later.
  Requires Env 0.65 or later.

Version 0.76. Tagged as 'Pinboard-0_76'
@
text
@d111 1
a111 1
        Pull    "PC",GT                         ; Do nothing if there are other icons.
d294 6
d301 1
d571 5
a575 1
10                                      ; r1 -> sprite name
d580 1
a580 1

@


4.2
log
@Ursula branch merged.
Added inclusion of Machine header for new CMOS header
Moved to srccommit.
Templates contain hardwired version/date information which is a long
  way out of date.  This has not been fixed in this checkin.

Version 0.75. Tagged as 'Pinboard-0_75'
@
text
@d29 1
a29 1
        Push    "LR" 
d31 1
a31 1
01        
d43 1
a43 1
        
d55 2
a56 2
RemoveAllPinboard             
        Push "LR"                 
d75 1
a75 1
                 
d92 1
a92 1
AddTinyDirs    
d97 1
a97 1
        Pull    "PC",VS 
d102 1
a102 1
        CMP     r0, #0      
d104 1
a104 1
        Pull    "PC",GE     
d110 1
a110 1
        CMP     r0,#0                 
d141 1
a141 1
        Pull    "PC",VS   
d161 1
a161 1
                ENTRY
d175 1
a175 1
        EXIT    VS         
d199 1
a199 1
        
d207 1
a207 1
        STR     r14,[r1]  
d210 1
a210 1
        BGE     %FT01                   ; Not on iconbar      
d216 1
a216 1
        STR     r0,[r1,#8] 
d241 1
a241 1
;        BEQ     %FT02  
d259 1
a259 1
        
d291 1
a291 1
                                        
d295 1
a295 1
        
d316 1
a316 1
                                 
d332 2
a333 2
        BNE     %BT04    
            
d350 1
a350 1
        EXIT    LT                              ; No TinyDirs icon. 
d365 1
a365 1
; 
d371 2
a372 2
AddIcon_LockToGrid ENTRY "r0"
        
d388 2
a389 2
                
      
d464 1
a464 1
        BL      Redraw           
d469 1
a469 1
          
d515 1
a515 1
        BNE     %FT01    
d543 1
a543 1
                  
d563 1
a563 1
        
d584 1
a584 1
        BVS     %FT80   
d622 1
a622 1
SpriteName_File         DCB     "File_",0   
d631 1
a631 1
        LNK     s.Mouse
@


4.1
log
@Initial revision
@
text
@d43 1
d53 1
d64 1
a64 1
        BL      SelectIcons
d68 3
a70 3
        LDR     r0,poll_word
        TST     r0,#PollWordReason_Recache
        BLEQ    ClearBackdrop           ; Clear the backdrop if no recache pending
d85 1
a85 1
        BL      SelectIcons
d155 5
d161 1
a161 1
        Push    "LR"
d163 2
a164 1
        MOV     r10,r2
d168 4
d175 1
a175 3
        Pull    "PC",VS         

; r6 = sprite mode r3=width r4=height (in pixels)
d177 2
d182 1
a182 1
        MOVVC   r3,r3,ASL r2             ; r3 = width in OS units
d185 1
a185 1
        MOVVC   r4,r4,ASL r2             ; r4 = height in OS units
d187 1
a187 1
        Pull    "PC",VS
d189 1
a190 10
01
        [ {FALSE}
        LDRB    r14,[r8],#1
        CMP     r14,#0
        BNE     %BT01
        SUB     r8,r8,r9
        SUB     r8,r8,#1
        CMP     r3,r8,ASL #4
        MOVLT   r3,r8,ASL #4            ; If name is longer, width = name.
        |
d199 4
a202 1
        ]
d204 1
a208 1

d212 1
d224 1
a224 1

d226 31
a256 1
        LDR     r0,[r10,#ic_x]          ; x0
d258 1
a258 20
        LDR     r14,Pinboard_options
        TST     r14,#PinboardOption_Grid
        MOV     r14,#grid_x_spacing
        BEQ     %FT01  
        ADD     r0,r0,r14,LSR #1
        DivRem  r5,r0,r14,r6
        MUL     r0,r5,r14
        STR     r0,[r10,#ic_x]
01
        SUBS    r5,r14,r3
        ADDPL   r0,r0,r5,LSR #1         ; Centre in grid box

        Debug   im,"X0 ",r0
        STR     r0,[r1,#4]

        ADD     r0,r0,r3                ; x1
        Debug   im,"X1 ",r0
        STR     r0,[r1,#12]

        LDR     r0,[r10,#ic_y]          ;y1
d260 28
a287 27
        LDR     r14,Pinboard_options
        TST     r14,#PinboardOption_Grid
        MOV     r14,#grid_y_spacing
        BEQ     %FT01

        LDR     r2,Screen_y1
        SUB     r3,r2,r0
        ADD     r3,r3,r14,LSR #1
        DivRem  r5,r3,r14,r6
        MUL     r0,r5,r14
        SUB     r0,r2,r0
        STR     r0,[r10,#ic_y]
01
        SUBS    r5,r14,r4
        SUBPL   r0,r0,r5,LSR #1         ; Centre in grid box

        SUB     r0,r0,r4
        LDR     R14,icon_bar_height
        CMP     R14,R0
        MOVGT   R0,R14

        Debug   im,"Y0 ",r0
        STR     r0,[r1,#8]             ; y0

        ADD     r0,r0,r4
        Debug   im,"Y1 ",r0
        STR     r0,[r1,#16]              ; y1
d292 1
a292 1
20
d295 1
d299 9
d309 1
a309 5
        SWI     XWimp_CreateIcon
        Pull    "PC",VS
        Debug   pi,"Icon handle is ",r0
        STR     r0,[r10,#ic_icon]

d315 1
a315 1
        Pull    "PC",VS
d317 3
a319 3

        LDR     r0,[r10,#ic_window]     ; Increment number of icons.
        CMP     r0,#0
a326 3

        ASSERT  ic_next =0

d328 1
a328 1
01
d332 1
a332 1
        BNE     %BT01    
d334 1
a334 2
;r14 -> Last item.

d342 1
a342 1
        Pull    "PC",EQ                         ; No TinyDirs icon.
d346 1
a346 1
        Pull    "PC",EQ                         ; No icons on icon bar.
d350 1
a350 1
        Pull    "PC",LT                         ; No TinyDirs icon. 
d359 31
a389 1
        Pull    "PC"       
@


4.1.4.1
log
@Windows, as well as files, can be selected, plus new menu structure and options
@
text
@a42 1
        
a51 1
        B       AddIconXY
d62 1
a62 1
        BL      SelectFileIcons
d83 1
a83 1
        BL      SelectFileIcons
a152 5
; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; AddIconXY
;
; The buffered list contained an AddIcon reason code. Add the icon!

d154 1
a154 1
                ENTRY
d156 1
a156 2
        MOV     r10, r2
        MOV     r11, r0
d163 3
a165 1
        EXIT    VS         
a166 2
        ; At this point, r6 = sprite mode r3=width r4=height (in pixels)
        ; Read X and Y eigen factors.
d170 1
a170 1
        MOVVC   r3,r3,ASL r2            ; r3 = width in OS units
d173 1
a173 1
        MOVVC   r4,r4,ASL r2            ; r4 = height in OS units
d175 1
a175 1
        EXIT    VS
a176 1
        ; Get width of leafname in current desktop font
d178 10
d196 1
a197 1
        ; See if icon is being placed on iconbar
d202 1
a205 1
        ; On iconbar - tinydirs
d217 12
a228 1
; Work out bounding box for icon
d230 9
a238 31
         LDR     r5, [r10, #ic_x]
         LDR     r6, [r10, #ic_y]
         CMP     r11, #BufferReason_AddAtXYWithoutLock
         BLNE    AddIcon_LockToGrid
         STR     r5, [r1, #4]
         STR     r6, [r1, #8]
         ADD     r5, r5, r3
         ADD     r6, r6, r4
         STR     r5, [r1, #12]
         STR     r6, [r1, #16]

;        LDR     r0,[r10,#ic_x]          ; x0
;        LDR     r14,Pinboard_options
;        TST     r14,#PinboardOption_Grid
;        MOV     r14,#grid_x_spacing
;        BEQ     %FT02  
;        ADD     r0,r0,r14,LSR #1
;        DivRem  r5,r0,r14,r6
;        MUL     r0,r5,r14
;        STR     r0,[r10,#ic_x]

;02
;        SUBS    r5,r14,r3
;        ADDPL   r0,r0,r5,LSR #1         ; Centre in grid box

;        Debug   im,"X0 ",r0
;        STR     r0,[r1,#4]

;        ADD     r0,r0,r3                ; x1
;        Debug   im,"X1 ",r0
;        STR     r0,[r1,#12]
d240 1
a240 1
;        LDR     r0,[r10,#ic_y]          ;y1
d242 27
a268 28
;        LDR     r14,Pinboard_options
;        TST     r14,#PinboardOption_Grid
;        MOV     r14,#grid_y_spacing
;        BEQ     %FT03

;        LDR     r2,Screen_y1
;        SUB     r3,r2,r0
;        ADD     r3,r3,r14,LSR #1
;        DivRem  r5,r3,r14,r6
;        MUL     r0,r5,r14
;        SUB     r0,r2,r0
;        STR     r0,[r10,#ic_y]

;03
;        SUBS    r5,r14,r4
;        SUBPL   r0,r0,r5,LSR #1         ; Centre in grid box

;        SUB     r0,r0,r4
;        LDR     R14,icon_bar_height
;        CMP     R14,R0
;        MOVGT   R0,R14

;        Debug   im,"Y0 ",r0
;        STR     r0,[r1,#8]             ; y0

;        ADD     r0,r0,r4
;        Debug   im,"Y1 ",r0
;        STR     r0,[r1,#16]              ; y1
d273 1
a273 1
20      ; Create icon
a278 9
        SWI     XWimp_CreateIcon        ; Create the icon
        EXIT    VS
        STR     r0,[r10,#ic_icon]       ; Store the icon's handle

        ; Make sure ic_x and ic_y are correct
        LDR     r14, [r1, #4]
        STR     r14, [r10, #ic_x]
        LDR     r14, [r1, #8]
        STR     r14, [r10, #ic_y]
d280 5
a284 1
        ; Set icon state
d290 1
a290 1
        EXIT    VS
d292 3
a294 3
        ; Increment number of icons.
        LDR     r0,[r10,#ic_window]
        CMP     r0,#0                   ; if window handle is zero, it's a tinydir
d302 3
d306 1
a306 1
04
d310 1
a310 1
        BNE     %BT04    
d312 2
a313 1
        ; r14 -> Last item.
d321 1
a321 1
        EXIT    EQ                              ; No TinyDirs icon.
d325 1
a325 1
        EXIT    EQ                              ; No icons on icon bar.
d329 1
a329 1
        EXIT    LT                              ; No TinyDirs icon. 
d338 1
a338 30
        EXIT
        

; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; AddIcon_LockToGrid
;
; Work out where to place an icon on the grid.
; 
; In: r3, r4 - icon width and height
;     r5, r6 - x and y co-ord
;
; Out: r5, r6 - new x and y co-ord

AddIcon_LockToGrid ENTRY "r0"
        
        ; Check for Grid lock
        LDR     r0, Pinboard_options
        TST     r0, #PinboardOption_Grid
        BLNE    FindNearestGridXY

        ; No grid lock, so centre and return
        MOV     r0, #grid_x_spacing
        SUB     r0, r0, r3
        ADD     r5, r5, r0, LSR #1
        MOV     r0, #grid_y_spacing
        SUB     r0, r0, r4
        ADD     r6, r6, r0, LSR #1
        EXIT
                
      
@


4.1.4.2
log
@Pinboard options now set via a *PinboardOptions command.
Backdrop command now includes a -Colour &GGBBRR00 switch to set background
colour.
Save now only saves a Pinboard command, followed by Pin commands. Options
and backdrops are instead set by Configure.
A click on 'Save' (as opposed to opening the saveas box) will save the
pinboard under the current filename.
@
text
@d68 3
a70 3
        ;LDR     r0,poll_word
        ;TST     r0,#PollWordReason_Recache
        ;BLEQ    ClearBackdrop           ; Clear the backdrop if no recache pending
@


4.1.4.3
log
@Bug fixes.
Turned off defaultbackdrop and UseECFforLCD. Only needed on A4.
Updated service call handling to use new Ursula tables.
@
text
@d372 1
a372 2
        SUBS    r0, r0, r3
        MOVMI   r0, #0
d375 1
a375 2
        SUBS    r0, r0, r4
        MOVMI   r0, #0
@


4.1.4.4
log
@Fixed a couple of bugs.
Improved tidying code.
Filenames are now truncated.
@
text
@a167 4
        [ truncate_filenames
        LDR     r9, [r10, #ic_icontext] ; pointer to text to display for icon.
        ]

a194 4
        
        CMP     r3, #grid_x_spacing
        MOVGT   r3, #grid_x_spacing
        SUBGT   r3, r3, #8
@


4.1.4.5
log
@Backdrop images that have a mask now have the chosen background colour
showing through (rather than just grey as before).
Added noiconbar compile-time flag (for DiTV demo).
@
text
@a294 1
        
d359 1
@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@@


4.1.5.1
log
@Import from SrcFiler
@
text
@@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
