head	4.10;
access;
symbols
	Pinboard-1_04:4.10
	Pinboard-1_03:4.10
	Pinboard-1_02:4.10
	Pinboard-1_01:4.10
	Pinboard-1_00:4.10
	Pinboard-0_99:4.10
	Pinboard-0_98:4.10
	Pinboard-0_97:4.10
	Pinboard-0_96:4.10
	Pinboard-0_95:4.10
	Pinboard-0_94:4.9
	Pinboard-0_93:4.9
	Pinboard-0_92:4.6
	Pinboard-0_91:4.6
	Pinboard-0_90:4.6
	Pinboard-0_89:4.6
	Pinboard-0_88:4.6
	Pinboard-0_87:4.6
	Pinboard-0_86:4.6
	Pinboard-0_85:4.6
	Pinboard-0_84:4.5
	Pinboard-0_83:4.4
	Pinboard-0_82:4.4
	RO_5_07:4.4
	Pinboard-0_81:4.4
	Pinboard-0_80:4.3
	Pinboard-0_79:4.3
	Pinboard-0_78:4.3
	Pinboard-0_77:4.2
	Pinboard-0_76:4.2
	Ursula_merge:4.1.4.8
	Pinboard-0_75:4.2
	mstphens_UrsulaRiscPCBuild_20Nov98:4.1.4.7
	Ursula_RiscPC:4.1.4.7.0.2
	rleggett_Pinboard-0_75d:4.1.4.8
	rthornb_UrsulaBuild-19Aug1998:4.1.4.7
	UrsulaBuild_FinalSoftload:4.1.4.7
	rthornb_UrsulaBuild-12Aug1998:4.1.4.7
	aglover_UrsulaBuild-05Aug1998:4.1.4.7
	rthornb_UrsulaBuild-29Jul1998:4.1.4.7
	rthornb_UrsulaBuild-22Jul1998:4.1.4.7
	rleggett_Pinboard-0_75c:4.1.4.7
	rleggett_Pinboard-0_75b:4.1.4.7
	rleggett_Pinboard-0_75:4.1.4.7
	rthornb_UrsulaBuild-15Jul1998:4.1.4.7
	rthornb_UrsulaBuild-07Jul1998:4.1.4.7
	rthornb_UrsulaBuild-17Jun1998:4.1.4.7
	rthornb_UrsulaBuild-03Jun1998:4.1.4.7
	rthornb_UrsulaBuild-27May1998:4.1.4.7
	rthornb_UrsulaBuild-21May1998:4.1.4.7
	rleggett_Pinboard-0_74:4.1.4.7
	rthornb_UrsulaBuild_01May1998:4.1.4.7
	Spinner_B20_2:4.1.7.1
	Spinner_19_3:4.1.7.1
	Spinner_B18:4.1.7.1
	Spinner_B17:4.1.7.1
	Spinner_B15:4.1.7.1
	Spinner_B14:4.1.7.1
	Spinner_B13:4.1.7.1
	Spinner_B12:4.1.7.1
	Spinner_B10:4.1.7.1
	Daytona:4.1.0.6
	Daytona_bp:4.1
	Ursula:4.1.0.4
	Ursula_bp:4.1
	Spinner_B7:4.1.7.1
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	ARTtmp:4.1.7.1.0.2
	Spin_merge:4.1.7.1
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.10
date	2012.08.23.19.59.08;	author rsprowson;	state Exp;
branches;
next	4.9;
commitid	rztFpV1VBvCVZHhw;

4.9
date	2011.09.24.07.31.19;	author rsprowson;	state Exp;
branches;
next	4.8;
commitid	nRjnbtmOSxK1BIAv;

4.8
date	2011.09.24.07.25.50;	author rsprowson;	state Exp;
branches;
next	4.7;
commitid	NapphrXjtkIXyIAv;

4.7
date	2011.09.24.07.23.44;	author rsprowson;	state Exp;
branches;
next	4.6;
commitid	U6nT8u4TlrjayIAv;

4.6
date	2007.09.19.01.58.44;	author srevill;	state Exp;
branches;
next	4.5;

4.5
date	2007.09.18.13.28.38;	author srevill;	state Exp;
branches;
next	4.4;

4.4
date	2003.07.31.12.55.12;	author rsprowson;	state Exp;
branches;
next	4.3;

4.3
date	2002.11.11.12.34.51;	author rsprowson;	state Exp;
branches;
next	4.2;

4.2
date	99.08.17.19.05.19;	author sbrodie;	state Exp;
branches;
next	4.1;

4.1
date	96.11.05.09.30.01;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.4.1
	4.1.5.1
	4.1.7.1;
next	;

4.1.1.1
date	96.11.05.09.30.01;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.05.23.29.51;	author nturton;	state Exp;
branches;
next	;

4.1.4.1
date	97.06.13.08.40.27;	author rleggett;	state Exp;
branches;
next	4.1.4.2;

4.1.4.2
date	97.08.04.11.50.10;	author rleggett;	state Exp;
branches;
next	4.1.4.3;

4.1.4.3
date	97.09.24.15.29.15;	author rleggett;	state Exp;
branches;
next	4.1.4.4;

4.1.4.4
date	97.10.21.09.56.59;	author rleggett;	state Exp;
branches;
next	4.1.4.5;

4.1.4.5
date	97.10.22.09.33.23;	author rleggett;	state Exp;
branches;
next	4.1.4.6;

4.1.4.6
date	98.01.07.10.28.36;	author rleggett;	state Exp;
branches;
next	4.1.4.7;

4.1.4.7
date	98.04.15.11.24.43;	author rleggett;	state Exp;
branches;
next	4.1.4.8;

4.1.4.8
date	98.09.18.10.18.13;	author rleggett;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.12.20.56;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.20.18.50;	author nturton;	state Exp;
branches;
next	;


desc
@@


4.10
log
@Fix for patchy tiled backdrops on changing to non EX1/EY1 mode
Pinboard keeps a note of the mode (from OS_Byte 135) that the backdrop sprite tile was last cached in, to avoid having to recache it all the time. However, the comparison fails when the mode specifier block (ie. when OS_Byte 135 is not reporting a numeric screen mode) is static since although the mode might have changed Pinboard would not think it had and hence not recache the sprite.
The result is a patchy desktop, for example changing from EX1/EY1 to EX0/EY0 would leave a quadrant arrangement of 1 redrawn patch and 3 not redrawn.
Backdrop.s:
Line 151 onwards, when a mode specifier is used, build a magic mode word combining EX EY and BPP (the 3 parameters the cache sprite function cares about), as a stronger check.
Tail.s:
Line 130 onwards, calculate the iconbar height properly (previously used 134 pixels for EY0 modes, 1 too high, leading to a thin strip of background colour above the iconbar.
Other changes
 - Use sprite area offset names from Hdr:Sprites rather than magic numbers
 - Use OS_Byte reasons from Hdr:OsBytes
 - Use "file.s" style names in LNK commands
 - Move BadOptions/NotASprite error blocks to avoid range error when assembling debug versions
 - true and false for objasm {TRUE} and {FALSE}

Version 0.95. Tagged as 'Pinboard-0_95'
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
; s.Menu
;
; Handle the menus.
;
Menu_Pinboard           *       1
Menu_TinyDirs           *       2
Menu_TinyDirsIcon       *       3


        ^ :INDEX:menu_store, workspace

tinydirs_menu_layout    #       28+24*4
rom_tinydirs_menu
tinydirs_menu_layout    Menu    T1
tm_selectall            Item    M11
tm_clearselection       Item    M12
tm_removeselection      Item    M13
tm_openparent           Item    M14
        DCB 0

        ^ :INDEX:menu_store, workspace

tinydirs_icon_menu_layout    #       28+24*1
rom_tinydirs_icon_menu
tinydirs_icon_menu_layout    Menu    T2
;tim_info                Item    M21, tinydirs_menu_layout
tim_quit                Item    M22, tinydirs_menu_layout
        DCB 0

        ^ :INDEX:menu_store, workspace

pinboard_menu_offset    *       0

 [ show_backdrop_options
pinboard_menu_size      *       28+24*7         ; (FG) size of menu with backdrop options
 |
pinboard_menu_size      *       28+24*5         ; (FG) size of menu without backdrop options
 ]

pinboard_menu_layout    #       pinboard_menu_size
rom_pinboard_menu
pinboard_menu_layout    Menu    T3
pm_selection            Item    M31, selection_menu_layout
pm_selectall            Item    M33, selectall_menu_layout
pm_clear_selection      Item    M34
pm_configure            Item    M35
pm_save                 Item    M36
 [ show_backdrop_options
pm_backdrop             Item    M37, backdrop_menu_layout
pm_nobackdrop           Item    M38
 ]
        DCB 0

backdrop_menu_offset    *       pinboard_menu_offset + pinboard_menu_size
backdrop_menu_size      *       28+24*3
backdrop_menu_layout    #       backdrop_menu_size
rom_backdrop_menu
backdrop_menu_layout    Menu    T4
bm_scaled               Item    M41
bm_tiled                Item    M42
bm_centred              Item    M43
        DCB 0

selection_menu_offset   *       backdrop_menu_offset + backdrop_menu_size
selection_menu_size     *       28+24*4
selection_menu_layout   #       selection_menu_size
rom_selection_menu
selection_menu_layout   Menu    T9
se_tidy                 Item    M91
se_open                 Item    M92
se_remove               Item    M93
se_helpapp              Item    M94
        DCB 0

selectall_menu_offset   *       selection_menu_offset + selection_menu_size
selectall_menu_size     *       28+24*3
selectall_menu_layout   #       selectall_menu_size
rom_selectall_menu
selectall_menu_layout   Menu    T10
sa_files                Item    M101
sa_windows              Item    M102
sa_windowsandfiles      Item    M103
        DCB 0

totalmenusize           *       selectall_menu_offset + selectall_menu_size

 ! 0, "Menu data size is ":CC:(:STR:(totalmenusize)):CC:" bytes"

        ALIGN


create_menu          ROUT

; r1 = window
; r2 = icon
; r10 = x
; r11 = y

        Debug   pi,"Create menu w,i",r1,r2

        Push    "r1-r11"
        BL      IntMenuDeleted
        Pull    "r1-r11"

        LDR     r14,backdrop_handle
        TEQ     r1,r14
        BEQ     create_pinboard_menu
        CMP     r1,#-2
        Pull    "PC",NE

 [ iconise_to_iconbar
        ;LDR     lr, Pinboard_options
        ;TST     lr, #PinboardOption_IconiseToIconBar
        ;BEQ     %FT00

        Push    "r6,r7"
        MOV     r6, r2
        BL      find_iconized
        TEQ     r7, #0
        Pull    "r6,r7"
        Pull    "PC",NE
00
 ]

create_iconbar_menu      ROUT

        LDR     r14,TinyDirs_Handle
        CMP     r2,r14
        BEQ     TinyDirsIcon_Menu



        LDR     r14,TinyDirs_Selected
        CMP     r14,#0
        BNE     %FT01

        Debug   pi,"No selected icons, do soft selection"

        STR     r1,soft_selection_window
        STR     r2,soft_selection_icon

        MOV     r14,r1
        ADR     r1,dataarea
        STR     r14,[r1]
        STR     r2,[r1,#4]
        MOV     r14,#is_selected
        STR     r14,[r1,#8]
        STR     r14,[r1,#12]
        SWI     XWimp_SetIconState
        Pull    "PC",VS

        MOV     r14,#1
        STR     r14,TinyDirs_Selected

recreate_iconbar_menu
01
        ADR     r0, message_file_block + 4
        ADRL    r1, rom_tinydirs_menu
        ADRL    r2, tinydirs_menu_layout
        MOV     r3, #menu_space
        SWI     XMessageTrans_MakeMenus
        Pull    "PC",VS

        LDR     r0,TinyDirs_Selected
        CMP     r0,#1                                   ; Is there more than one selected icon ?
                                                        ; Grey out the 'open parent entry'  if so

        LDR     r14,menu_store+28+tm_openparent*24+8          ;
        ORRNE   r14,r14,#is_shaded
        BICEQ   r14,r14,#is_shaded
        STR     r14,menu_store+28+tm_openparent*24+8

        LDR     r14,menu_store+28+tm_clearselection*24+8          ;
        ORRLT   r14,r14,#is_shaded
        BICGE   r14,r14,#is_shaded
        STR     r14,menu_store+28+tm_clearselection*24+8
        LDR     r14,menu_store+28+tm_removeselection*24+8          ;
        ORRLT   r14,r14,#is_shaded
        BICGE   r14,r14,#is_shaded
        STR     r14,menu_store+28+tm_removeselection*24+8
        BLE     %FT01

        ADR     r0,message_file_block+4                 ; Change to remove selection if more than
        ADRL    r1,remove_selection_token               ; one selected icon.
        ADRL    r2,menu_store+400
        MOV     r3,#menu_space-400
        SWI     XMessageTrans_Lookup
        Pull    "PC",VS


        MOV     r1,#12
        ADD     r1, r1, r3, LSL #4
        LDR     r4, menu_store+16
        CMP     r1, r4
        STRGT   r1, menu_store+16

        DebugS  pi,"String is ",r2
        CMP     r2,#0
        STR     r2,menu_store+28+tm_removeselection*24+12
        ADD     r3,r3,#1
        STR     r3,menu_store+28+tm_removeselection*24+20
        MOV     r2,#0
        STR     r2,menu_store+28+tm_removeselection*24+16

        LDR     r14,menu_store+28+tm_removeselection*24+8
        ORR     r14,r14,#if_indirected
        STR     r14,menu_store+28+tm_removeselection*24+8



01
        ADR     r1,menu_store
        SUB     r2,r10,#144
        MOV     r3,#96+4*44
        SWI     XWimp_CreateMenu

        MOV     r14,#Menu_TinyDirs
        STR     r14,CurrentMenu

        Pull    "PC"


TinyDirsIcon_Menu       ROUT

        ADR     r0, message_file_block + 4
        ADRL    r1, rom_tinydirs_icon_menu
        ADRL    r2, tinydirs_icon_menu_layout
        MOV     r3, #menu_space
        SWI     XMessageTrans_MakeMenus
        Pull    "PC",VS

        ADR     r1,menu_store
        SUB     r2,r10,#64
        MOV     r3,#96+1*44
        SWI     XWimp_CreateMenu

        MOV     r14,#Menu_TinyDirsIcon
        STR     r14,CurrentMenu

        Pull    "PC"

create_pinboard_menu ROUT

        Debug   pi,"Create pinboard menu"

        CMP     r2,#-1
        BEQ     %FT01

        Debug   pi,"Menu on an icon"

        MOV     R6,R2
        BL      find_iconized
        CMP     r7,#0
        BEQ     %FT01

        Push    "r1,r2"                         ; (FG) preserve these registers
        MOV     r0,#OsByte_ScanKeyboard         ; If an iconized window check for Shift to produce app. menu.
        MOV     r1,#&80
        SWI     XOS_Byte
        CMP     r1,#&FF
        Pull    "r1,r2"                         ; (FG) restore these registers
        BEQ     app_menu

01
        LDR     r14,Pinboard_Selected           ; (FG) no of filer-icons selected
        LDR     r0, Windows_Selected            ; (FG) no of iconized windows selected
        CMP     r14,#0                          ; (FG) any filer-icons selected?
        CMPEQ   r0,#0                           ; (FG) or any iconized windows?
        BNE     %FT01                           ; (FG) if so, skip soft-selection

        ;------ Nothing selected, see if there's an icon at the position clicked.
        ; (FG)  If so, soft-select it.

        Push    "r1,r2"                         ; (FG) keep these registers safe
        BL      FindIconBoth                    ; (FG) look through both lists for our icon
        Pull    "r1,r2"                         ; (FG) restore registers
        BNE     %FT01                           ; (FG) no icon found, skip soft-selection

        Debug   pi,"No selected icons, do soft selection"

        MOV     R14,R0                          ; (FG) keep type of icon safe, 1 = iconized window, 2 = filer-icon

        STR     r1,soft_selection_window
        STR     r2,soft_selection_icon

        MOV     r0,r1                           ; (FG)
        ADR     r1,dataarea                     ; (FG)
        STR     r0,[r1]                         ; (FG)
        STR     r2,[r1,#4]                      ; (FG)
        MOV     r0,#is_selected                 ; (FG)
        STR     r0,[r1,#8]                      ; (FG)
        STR     r0,[r1,#12]                     ; (FG)
        SWI     XWimp_SetIconState
        Pull    "PC",VS

        MOV     r0,#1                           ; (FG) say there's 1 icon selected
        CMP     R14,#1                          ; (FG) is it an iconized window?
        STREQ   r0,Windows_Selected             ; (FG) if so, an iconized window is selected
        STRHI   r0,Pinboard_Selected            ; (FG) if not, a filer-icon is selected

recreate_pinboard_menu
01
        ADR     r0, message_file_block + 4
        ADRL    r1, rom_backdrop_menu
        ADRL    r2, backdrop_menu_layout
        MOV     r3, #menu_space
        SWI     XMessageTrans_MakeMenus
        Pull    "PC",VS

        ADR     r0, message_file_block + 4
        ADRL    r1, rom_selection_menu
        ADRL    r2, selection_menu_layout
        MOV     r3, #menu_space
        SWI     XMessageTrans_MakeMenus
        Pull    "PC",VS

        ADR     r0, message_file_block + 4
        ADRL    r1, rom_selectall_menu
        ADRL    r2, selectall_menu_layout
        MOV     r3, #menu_space
        SWI     XMessageTrans_MakeMenus
        Pull    "PC",VS

        ADR     r0, message_file_block + 4
        ADRL    r1, rom_pinboard_menu
        ADR     r2, menu_store
        MOV     r3, #menu_space
        SWI     XMessageTrans_MakeMenus
        Pull    "PC",VS

        LDR     r14,saveas_handle                       ; Point save entry at save box.
        STR     r14,menu_store+28+pm_save*24+4

        Push    "r4"
        ADRL    r0, OpenCfgPath
        MOV     r2, #-1
        MOV     r3, #0
        MOV     r4, #VarType_Expanded
        SWI     XOS_ReadVarVal                          ; Has !Boot been run (to have a !PinSetup)
        Pull    "r4"
        TEQ     r2, #0
        LDR     r14, menu_store+28+pm_configure*24+8
        ORREQ   r14, r14, #is_shaded                    ; Shade the 'Configure...' entry
        BICNE   r14, r14, #is_shaded
        STR     r14, menu_store+28+pm_configure*24+8

        LDR     r0, Window_Icons
        LDR     r14, Iconbar_Icons
        SUB     r0, r0, r14
        LDR     r14,Pinboard_Icons
        ADDS    r14, r14, r0                            ; Are there any icons on the pinboard ?

        LDR     r14, menu_store+28+pm_selectall*24+8
        ORREQ   r14, r14, #is_shaded
        BICNE   r14, r14, #is_shaded
        STR     r14, menu_store+28+pm_selectall*24+8

        LDR     r0,Pinboard_Selected
        LDR     r14, Windows_Selected
        ADDS    r0, r0, r14                             ; Are there any selected icons on the pinboard ?

        LDR     r14, menu_store+28+pm_selection*24+8
        ORREQ   r14, r14, #is_shaded
        BICNE   r14, r14, #is_shaded
        STR     r14, menu_store+28+pm_selection*24+8

        LDR     r14,menu_store+28+pm_clear_selection*24+8       ; Shade 'Clear Selection' if no selected icons.
        ORREQ   r14,r14,#is_shaded
        BICNE   r14,r14,#is_shaded
        STR     r14,menu_store+28+pm_clear_selection*24+8

 [ show_backdrop_options
        CMP     r0,#1                                   ; Is there more than one selected icon ?
        LDR     r14,menu_store+28+pm_backdrop*24+8      ; Shade 'Make Backdrop' if not 1 icon selected.
        ORRNE   r14,r14,#is_shaded
        BICEQ   r14,r14,#is_shaded
        STR     r14,menu_store+28+pm_backdrop*24+8

        BNE     %FT03

        LDR     r0,backdrop_handle
        ADR     r1,dataarea
        MOV     r2,#is_selected
        MOV     r3,#is_selected
        SWI     XWimp_WhichIcon
        Pull    "PC",VS


        LDR     r2,[r1]
        LDR     r1,backdrop_handle
        Debug   pi,"Find icon ",r1,r2
        BL      FindIcon                                ; r2 -> Icon block or 0 if not found.
        BNE     %FT01

        Debug   pi,"Icon found."

        LDR     r2,[r2,#ic_filetype]
        LDR     r14,=&ff9
        TEQ     r2,r14
        BEQ     %FT03

        LDR     r14, =&C85
        TEQ     r2, r14
        BEQ     %FT03

01
        LDR     r14,menu_store+28+pm_backdrop*24+8      ; Shade 'Make Backdrop' if selected icon is not a sprite.
        ORR     r14,r14,#is_shaded
        STR     r14,menu_store+28+pm_backdrop*24+8

03
        LDR     r0,backdrop_options
        TST     r0,#bd_OptionActive
        LDR     r14,menu_store+28+pm_nobackdrop*24+8    ; Shade 'Remove backdrop' if no backdrop.
        ORREQ   r14,r14,#is_shaded
        BICNE   r14,r14,#is_shaded
        STR     r14,menu_store+28+pm_nobackdrop*24+8
 ]

        ; Shade Selection->Remove if any windows are selected
        LDR     r0, Windows_Selected
        LDR     r14, menu_store + selection_menu_offset + 28 + se_remove*24+8
        CMP     r0, #0
        ORRNE   r14, r14, #is_shaded
        BICEQ   r14, r14, #is_shaded
        STR     r14, menu_store + selection_menu_offset + 28 + se_remove*24+8

        ; Shade Selection->Help unless it's an app,AND has help,AND its on the backdrop,AND is the only thing selected
        LDR     r14, menu_store + selection_menu_offset + 28 + se_helpapp*24+8
        ORR     r14, r14, #is_shaded                    ; in most cases it will be shaded
        LDR     r0, Pinboard_Selected
        TEQ     r0, #1
        BNE     %FT09
        Push    "r7"
        LDR     r7, Icon_list
        ADR     r1, dataarea
        LDR     r2, backdrop_handle
        STR     r2, [r1, #0]
05
        CMP     r7, #0                                  ; that's odd,we searched the whole list and never found it
        BEQ     %FT08
        LDR     r0, [r7, #ic_window]
        CMP     r0, r2
        BNE     %FT07                                   ; not on the backdrop
        LDR     r0, [r7, #ic_icon]
        STR     r0, [r1, #4]
        SWI     XWimp_GetIconState
        LDR     r0, [r1, #8+16]
        TST     r0, #is_selected                        ; see if we've got the one selected icon
        BEQ     %FT07
        LDR     r0, [r7, #ic_filetype]
        CMP     r0, #&2000
        BNE     %FT08                                   ; disappointing,it wasn't an app
        Push    "r4-r6,r14"
        ADD     r0, r7, #ic_path                        ; filename
        BL      Copy_r0r1
        ADRL    r0, plinghelp                           ; append help filename
        BL      Copy_r0r1
        ADR     r1, dataarea
        MOV     r0, #OSFile_ReadWithTypeNoPath
        SWI     XOS_File
        Pull    "r4-r6,r14"
        TEQ     r0, #0
        BICNE   r14, r14, #is_shaded                    ; has a !help file of some form
        B       %FT08
07
        LDR     r7, [r7, #ic_next]
        B       %BT05
08
        Pull    "r7"
09
        STR     r14, menu_store + selection_menu_offset + 28 + se_helpapp*24+8
        CLRV

        ; Shade 'Select all->Windows' if no windows on backdrop
        LDR     r0, Window_Icons
        LDR     r14, Iconbar_Icons
        SUB     r0, r0, r14
        LDR     r14, menu_store + selectall_menu_offset + 28 + sa_windows*24+8
        CMP     r0, #0
        ORREQ   r14, r14, #is_shaded
        BICNE   r14, r14, #is_shaded
        STR     r14, menu_store + selectall_menu_offset + 28 + sa_windows*24+8

        ; Shade 'Select all->Files' if no files on backdrop
        LDR     r0, Pinboard_Icons
        LDR     r14, menu_store + selectall_menu_offset + 28 + sa_files*24+8
        CMP     r0, #0
        ORREQ   r14, r14, #is_shaded
        BICNE   r14, r14, #is_shaded
        STR     r14, menu_store + selectall_menu_offset + 28 + sa_files*24+8

        ; Shade 'Select all->Windows and files' if there's either no files or no windows
        LDR     r0, Pinboard_Icons
        CMP     r0, #0
        LDRNE   r0, Window_Icons
        LDR     r14, menu_store + selectall_menu_offset + 28 + sa_windowsandfiles*24+8
        CMP     r0, #0
        ORREQ   r14, r14, #is_shaded
        BICNE   r14, r14, #is_shaded
        STR     r14, menu_store + selectall_menu_offset + 28 + sa_windowsandfiles*24+8

        ADR     r1,menu_store
        SUBS    r2,r10,#64
        MOVMI   r2,#0
        MOV     r3,r11
        SWI     XWimp_CreateMenu

        MOV     r14,#Menu_Pinboard
        STR     r14,CurrentMenu

        Pull    "PC"

; ----------------------------------------------------------------------------------------------------------------------
; app_menu, send menu message to application.
;
app_menu
        ADR     r1,dataarea
        MOV     r2,r10
        MOV     r3,r11
        MOV     r4,#2
        LDR     r5,[r7,#w_window_handle]
        MOV     r6,#-1
        STMIA   r1,{r2-r6}
        MOV     r0,#6      ; fake mouse event
        LDR     r2,[r7,#w_task]
        SWI     XWimp_SendMessage

        Pull    "PC"

remove_selection_token  DCB     "M34s",0
        ALIGN

        LNK     MenuSelect.s
@


4.9
log
@Shade "Configure..." when boot was unsuccessful.
When BootResources$Path is unset the option to run the configure plugin is no longer available.
Shared a "Filer_Run " string in 3x places.
Replaced most occurrences of calling XOS_ReadModeVariable of the current mode's XEig and YEig factors to use the cached copy sitting unloved in the workspace. Should thrash less during redraw.

Version 0.93. Tagged as 'Pinboard-0_93'
@
text
@d271 1
a271 1
        MOV     r0,#&79                         ; If an iconized window check for Shift to produce app. menu.
d548 1
a548 1
        LNK     s.MenuSelect
@


4.8
log
@Replace magic numbers with sumbols from header files for OS_ calls.
Same binary as 0.92, not tagged.
@
text
@a245 3
        ;LDR     r14,info_dbox_handle                    ; Point info entry at info box.
        ;STR     r14,menu_store+28+tim_info*24+4

a344 3
        ;LDR     r14,info_dbox_handle                    ; Point info entry at info box.
        ;STR     r14,menu_store+28+pm_info*24+4

d348 13
a371 5
        ;LDR     r14,menu_store+28+pm_select_all*24+8    ; Shade 'Select all' if no icons.
        ;ORREQ   r14,r14,#is_shaded
        ;BICNE   r14,r14,#is_shaded
        ;STR     r14,menu_store+28+pm_select_all*24+8

d386 1
a386 5
        ;LDR     r14,menu_store+28+pm_remove*24+8        ; Shade 'Remove icon' if no selected icons.
        ;ORREQ   r14,r14,#is_shaded
        ;BICNE   r14,r14,#is_shaded
        ;STR     r14,menu_store+28+pm_remove*24+8

a387 33
        ;BLE     %FT01

        ;ADR     r0,message_file_block+4                 ; Change to remove selection if more than
        ;ADR     r1,remove_selection_token               ; one selected icon.
        ;ADRL    r2,menu_store+400
        ;MOV     r3,#menu_space-400
        ;ADRL    r2,menu_store+1024-112
        ;MOV     r3,#112
        ;SWI     XMessageTrans_Lookup
        ;Pull    "PC",VS


        ;MOV     r1,#12
        ;ADD     r1, r1, r3, LSL #4
        ;LDR     r4, menu_store+16
        ;CMP     r1, r4
        ;STRGT   r1, menu_store+16

        ;DebugS  pi,"String is ",r2
        ;CMP     r2,#0
        ;STR     r2,menu_store+28+pm_remove*24+12
        ;ADD     r3,r3,#1
        ;STR     r3,menu_store+28+pm_remove*24+20
        ;MOV     r2,#0
        ;STR     r2,menu_store+28+pm_remove*24+16

        ;LDR     r14,menu_store+28+pm_remove*24+8
        ;ORR     r14,r14,#if_indirected
        ;STR     r14,menu_store+28+pm_remove*24+8


01
 [ show_backdrop_options
@


4.7
log
@Collapse dead switches.
Same binary as 0.92, not tagged.
@
text
@d509 1
a509 1
        MOV     r0, #23                                 ; Read catalogue info with type / no
@


4.6
log
@  Enable opening of pinboard configure plugin directly from the Pinboard.
Details:
  Replaced the 'Options' menu item with the 'Configure...' menu item
  which opens the Pinboard configure plugin directly from the Pinboard.
  This is achieved by running a *command that checks if the plugin is
  there and filer-runs it if so.

  All the code and help messages relating to the 'Options' menu item
  and its submenus has been removed.
Admin:
  Tested on Iyonix RO5.11
Notes:
  Changes by Fred Graute.

Version 0.85. Tagged as 'Pinboard-0_85'
@
text
@a359 7
       [ Version < 68
        LDR     r14,menu_store+28+pm_tidy*24+8          ; Shade 'Tidy' if no icons.
        ORREQ   r14,r14,#is_shaded
        BICNE   r14,r14,#is_shaded
        STR     r14,menu_store+28+pm_tidy*24+8
       ]

@


4.5
log
@  Enable soft-selection of iconized window icons.
Detail:
  Clicking Menu over a filer-icon will cause it to be soft-selected if
  no icons have been selected. For iconized window icons this doesn't
  work.
  This changeset removes this limitation. The Selection -> Remove menu
  item will be corectly shaded (for iconized-icons) or unshaded (for
  filer-icons).
Admin:
  Tested on Iyonix RO5.11
Notes:
  Changes by Fred Graute.

Version 0.84. Tagged as 'Pinboard-0_84'
@
text
@d49 1
a49 1
pinboard_menu_size      *       28+24*7
d51 1
a51 1
pinboard_menu_size      *       28+24*5
d60 1
a60 1
pm_options              Item    M35, options_menu_layout
d78 1
a78 39
iconise_menu_offset     *       backdrop_menu_offset + backdrop_menu_size
iconise_menu_size       *       28+24*8
iconise_menu_layout     #       iconise_menu_size
rom_iconise_menu
iconise_menu_layout     Menu    T6
im_atclose              Item    M61
im_to_iconbar           Item    M62
im_to_topleft           Item    M63
im_to_bottomleft        Item    M64
im_to_topright          Item    M65
im_to_bottomright       Item    M66,,"-"
im_stackhorizontally    Item    M67
im_stackvertically      Item    M68
        DCB 0

tidy_menu_offset        *       iconise_menu_offset + iconise_menu_size
tidy_menu_size          *       28+24*6
tidy_menu_layout        #       tidy_menu_size
rom_tidy_menu
tidy_menu_layout        Menu    T7
tm_to_topleft           Item    M71
tm_to_bottomleft        Item    M72
tm_to_topright          Item    M73
tm_to_bottomright       Item    M74,,"-"
tm_stackhorizontally    Item    M75
tm_stackvertically      Item    M76
        DCB 0

options_menu_offset     *       tidy_menu_offset + tidy_menu_size
options_menu_size       *       28+24*3
options_menu_layout     #       options_menu_size
rom_options_menu
options_menu_layout     Menu    T8
om_iconisewindows       Item    M81, iconise_menu_layout
om_tidyfiles            Item    M82, tidy_menu_layout
om_gridlock             Item    M83
        DCB 0

selection_menu_offset   *       options_menu_offset + options_menu_size
a281 1
01
a327 21
        ADRL    r1, rom_iconise_menu
        ADRL    r2, iconise_menu_layout
        MOV     r3, #menu_space
        SWI     XMessageTrans_MakeMenus
        Pull    "PC",VS

        ADR     r0, message_file_block + 4
        ADRL    r1, rom_tidy_menu
        ADRL    r2, tidy_menu_layout
        MOV     r3, #menu_space
        SWI     XMessageTrans_MakeMenus
        Pull    "PC",VS

        ADR     r0, message_file_block + 4
        ADRL    r1, rom_options_menu
        ADRL    r2, options_menu_layout
        MOV     r3, #menu_space
        SWI     XMessageTrans_MakeMenus
        Pull    "PC",VS

        ADR     r0, message_file_block + 4
a558 120
        ; Tick 'Grid' if grid enabled.
        LDR     r0,Pinboard_options
        TST     r0,#PinboardOption_Grid
        LDR     r14, menu_store+options_menu_offset+28+om_gridlock*24+0
        ORRNE   r14,r14,#1
        BICEQ   r14,r14,#1
        STR     r14,menu_store+options_menu_offset+28+om_gridlock*24+0

        ; Shade the "Iconise to..." if the Wimp has iconise buttons off
        MOV     r0, #ReadCMOS
        MOV     r1, #WimpDragMoveLimitCMOS
        SWI     XOS_Byte
        MOVVS   r2, #0
        TST     r2, #1:SHL:7                            ; look at "has iconise" button bit
        LDR     r14, menu_store+options_menu_offset+28+om_iconisewindows*24+8
        ORREQ   r14, r14, #is_shaded
        BICNE   r14, r14, #is_shaded
        STR     r14, menu_store+options_menu_offset+28+om_iconisewindows*24+8
        BEQ     %FT30                                   ; no need to bother ticking the menu if it's shaded

        ; Now tick the options on the Iconise to... menu
        ; Work out where the menu data is - there's two menu's before it.
        ADR     r2, menu_store
        ADD     r2, r2, #iconise_menu_offset+28

        ; Get rid of all current ticks on iconise window menu
        MOV     r3, #0
10
        LDR     r14, [r2]
        BIC     r14, r14, #1
        STR     r14, [r2]
        ADD     r3, r3, #1
        ADD     r2, r2, #24
        CMP     r3, #8
        BLT     %BT10
        SUB     r2, r2, #(8*24)

        ; Now decide which options to tick
        LDR     r0, Pinboard_options
        TST     r0, #PinboardOption_UseWinToCorner
        BEQ     %FT20

        ; Calculate which corner we're in (0-3)
        MOV     r1, #0
        TST     r0, #PinboardOption_WinToCornerLR
        ADDNE   r1, r1, #2
        TST     r0, #PinboardOption_WinToCornerTB
        ADDNE   r1, r1, #1
        ADD     r1, r1, #2

        ; Work our which menu option to tick
        MOV     r0, #24
        MUL     r3, r1, r0
        LDR     r14, [r2, r3]
        ORR     r14, r14, #1
        STR     r14, [r2, r3]

        ; Work out which of horizontal or vertical to tick
        LDR     r0, Pinboard_options
        TST     r0, #PinboardOption_WinToCornerHV
        MOVNE   r1, #7
        MOVEQ   r1, #6
        MOV     r0, #24
        MUL     r3, r1, r0
        LDR     r14, [r2, r3]
        ORR     r14, r14, #1
        STR     r14, [r2, r3]
        B       %FT30

20      ; Tick Iconise to iconbar?
        TST     r0, #PinboardOption_IconiseToIconBar
        ADDNE   r2, r2, #24
        LDR     r14, [r2]
        ORR     r14, r14, #1
        STR     r14, [r2]
30
        ; Now tick the options on the Tidy to... menu
        ; Work out where the menu data is - there's two menu's before it.
        ADR     r2, menu_store
        ADD     r2, r2, #tidy_menu_offset + 28

        ; Get rid of all current ticks on iconise window menu
        LDR     r0, Pinboard_options
        MOV     r3, #0
40
        LDR     r14, [r2]
        BIC     r14, r14, #1
        STR     r14, [r2]
        ADD     r3, r3, #1
        ADD     r2, r2, #24
        CMP     r3, #6
        BLT     %BT40
        SUB     r2, r2, #(6*24)

        ; Now decide which options to tick
        ; Calculate which corner we're in (0-3)
        MOV     r1, #0
        TST     r0, #PinboardOption_TidyToCornerLR
        ADDNE   r1, r1, #2
        TST     r0, #PinboardOption_TidyToCornerTB
        ADDNE   r1, r1, #1

        ; Work our which menu option to tick
        MOV     r0, #24
        MUL     r3, r1, r0
        LDR     r14, [r2, r3]
        ORR     r14, r14, #1
        STR     r14, [r2, r3]

        ; Work out which of horizontal or vertical to tick
        LDR     r0, Pinboard_options
        TST     r0, #PinboardOption_TidyToCornerHV
        MOVNE   r1, #5
        MOVEQ   r1, #4
        MOV     r0, #24
        MUL     r3, r1, r0
        LDR     r14, [r2, r3]
        ORR     r14, r14, #1
        STR     r14, [r2, r3]

@


4.4
log
@A few assumptions about SWIs preserving flags remained: nuked.
A few TEQ Rn,#0 changed to use 'S' and save an instruction.
Fix for misscaled tiled backdrop sprite in EX/EY0 mode - an 'out by 1'
error meant that some of the background colour shone through when the
tile sprite got resized to be too short.In any other EX/EY mode you never
noticed it due to rounding errors in the scaling.
The "Iconise to..." options submenu is now shaded if the Wimp has the
iconise buttons turned off: this minimises confusion for anyone who
hasn't realised that shift-close and iconise are subtley different in that
only the iconise button obeys the "Iconise to..." options,whereas
shift-close iconises at the point of application.

Version 0.81. Tagged as 'Pinboard-0_81'
@
text
@d92 1
a92 1
        
d126 1
a126 1
        
d311 2
a312 1
        MOV     r0,#&79                 ; If an iconized window check for Shift to produce app. menu.
d316 1
d320 14
a333 3
        LDR     r14,Pinboard_Selected
        CMP     r14,#0
        BNE     %FT01
d335 1
a335 4
        Push    "r1,r2"
        BL      FindIcon
        Pull    "r1,r2"
        BNE     %FT01
d337 1
a337 1
        Debug   pi,"No selected icons, do soft selection"
d342 7
a348 7
        MOV     r14,r1
        ADR     r1,dataarea
        STR     r14,[r1]
        STR     r2,[r1,#4]
        MOV     r14,#is_selected
        STR     r14,[r1,#8]
        STR     r14,[r1,#12]
d352 4
a355 2
        MOV     r14,#1
        STR     r14,Pinboard_Selected
d440 1
a440 1
        
d517 1
a517 1
        
d590 1
a590 1
        
d618 1
a618 1
        
d638 1
a638 1
        
d668 1
a668 1
        
d675 1
a675 1
      
d720 1
a720 1
        
@


4.3
log
@Commented out "proginfo" string,no longer used.
Prefixed the pin and addtinydir commands that get saved in the
pinboard file with "X " so your pinboard setup continues even if a file
is no longer available.ROL did this with a new XPin command,not taken.
Merged changes from ROL to allow the icon text to be an arbitary colour
though this can be switched out with "technicolour_text" for the
purists.
Help entry added to the pinboard selection submenu,this will be greyed
out except when
 it's an app
 and it has a !help file
 and it is the only object selected
like the filer does.
Updated messages file accordingly.
Menu clicking on the "save pinboard settings" OK button no longer saves
the file,and adjust clicking keeps the menu tree open
 -> fixes bug report from 1998,now removed from "Status" file
Saveas template resized to match !Edit.
Fixed problem of select dragging a file to an app leaving the icon
selected (due to two conditional MOV R0's being followed by an
unconditional one for some reason).
 -> fixes bug report from 1998,now removed from "Status" file
Tweaked a few CMP#0 BLT's to test specifically for the iconbar handle.
The bug report in "Status" about bits of filenames being left on the
pinboard can be bodged by popping an ADD r0,r0,#16 after the XWimp_TextOp
in s.buffered but I've not done this yet.

Version 0.78. Tagged as 'Pinboard-0_78'
@
text
@d406 1
a406 2
        ADD     r14, r14, r0
        TEQ     r14,#0                                  ; Are there any icons on the pinboard ?
d427 1
a427 2
        ADD     r0, r0, r14
        TEQ     r0,#0                                   ; Are there any selected icons on the pinboard ?
d615 12
d631 1
a631 1
        
@


4.2
log
@Ursula branch merged.
Added inclusion of Machine header for new CMOS header
Moved to srccommit.
Templates contain hardwired version/date information which is a long
  way out of date.  This has not been fixed in this checkin.

Version 0.75. Tagged as 'Pinboard-0_75'
@
text
@d117 1
a117 1
selection_menu_size     *       28+24*3
d124 1
d447 1
a447 1
        BLE     %FT01
d534 47
@


4.1
log
@Initial revision
@
text
@d24 1
a25 1
        ^ :INDEX:menu_store, workspace
d31 1
a31 1
tm_removeselection      Item    M34
d36 2
a37 1
tinydirs_icon_menu_layout    #       28+24*2
d40 2
a41 2
tim_info                Item    M21, tinydirs_menu_layout
tim_quit                Item    M22
d44 3
d48 5
a52 1
        ^ :INDEX:menu_store, workspace
d54 1
a54 1
pinboard_menu_layout    #       28+24*9
d56 7
a62 7
pinboard_menu_layout    Menu    TaskID
pm_info                 Item    M31, tinydirs_menu_layout
pm_tidy                 Item    M32
pm_grid                 Item    M33
pm_remove               Item    M34
pm_select_all           Item    M35
pm_clear_selection      Item    M36
d65 1
a65 1
pm_save                 Item    M39
d68 3
a70 1
backdrop_menu_layout    #       28+24*3
d78 37
d116 23
d163 3
a165 3
        LDR     lr, Pinboard_options
        TST     lr, #PinboardOption_IconiseToIconBar
        BEQ     %FT00
d283 2
a284 3
        LDR     r14,info_dbox_handle                    ; Point info entry at info box.
        STR     r14,menu_store+28+tim_info*24+4

d288 1
a288 1
        MOV     r3,#96+2*44
d354 35
d395 2
a396 2
        LDR     r14,info_dbox_handle                    ; Point info entry at info box.
        STR     r14,menu_store+28+pm_info*24+4
d401 3
d405 1
d408 1
d413 1
d415 9
a423 4
        LDR     r14,menu_store+28+pm_select_all*24+8    ; Shade 'Select all' if no icons.
        ORREQ   r14,r14,#is_shaded
        BICNE   r14,r14,#is_shaded
        STR     r14,menu_store+28+pm_select_all*24+8
d426 2
d429 5
d440 4
a443 4
        LDR     r14,menu_store+28+pm_remove*24+8        ; Shade 'Remove icon' if no selected icons.
        ORREQ   r14,r14,#is_shaded
        BICNE   r14,r14,#is_shaded
        STR     r14,menu_store+28+pm_remove*24+8
d448 27
a474 25
        ADR     r0,message_file_block+4                 ; Change to remove selection if more than
        ADR     r1,remove_selection_token               ; one selected icon.
        ADRL    r2,menu_store+400
        MOV     r3,#menu_space-400
        SWI     XMessageTrans_Lookup
        Pull    "PC",VS


        MOV     r1,#12
        ADD     r1, r1, r3, LSL #4
        LDR     r4, menu_store+16
        CMP     r1, r4
        STRGT   r1, menu_store+16

        DebugS  pi,"String is ",r2
        CMP     r2,#0
        STR     r2,menu_store+28+pm_remove*24+12
        ADD     r3,r3,#1
        STR     r3,menu_store+28+pm_remove*24+20
        MOV     r2,#0
        STR     r2,menu_store+28+pm_remove*24+16

        LDR     r14,menu_store+28+pm_remove*24+8
        ORR     r14,r14,#if_indirected
        STR     r14,menu_store+28+pm_remove*24+8
d478 1
d506 4
d523 1
d525 37
d564 1
a564 1
        LDR     r14,menu_store+28+pm_grid*24+0    ; Tick 'Grid' if grid enabled.
d567 62
a628 1
        STR     r14,menu_store+28+pm_grid*24+0
d630 38
@


4.1.4.1
log
@Added option to iconise windows to a corner
@
text
@d46 1
a46 1
pinboard_menu_layout    #       28+24*10
a51 1
pm_iconisewindows       Item    M40, iconise_menu_layout
a67 14
 [ Version >= 67
iconise_menu_layout     #       28+24*8
rom_iconise_menu
iconise_menu_layout     Menu    T6
im_atclose              Item    T61
im_to_iconbar           Item    T62
im_to_topleft           Item    T63
im_to_bottomleft        Item    T64
im_to_topright          Item    T65
im_to_bottomright       Item    T66,,"-"
im_stackhorizontally    Item    T67
im_stackvertically      Item    T68
        DCB 0
 ]
d283 1
a283 10
        
      [ Version >= 67
        ADR     r0, message_file_block + 4
        ADRL    r1, rom_iconise_menu
        ADRL    r2, iconise_menu_layout
        MOV     r3, #menu_space
        SWI     XMessageTrans_MakeMenus
        Pull    "PC",VS
      ]
        
a401 60

      [ Version >= 67
        ADR     r2, menu_store
        ADD     r2, r2, #(28+24*10)
        ADD     r2, r2, #(28+24*3)
        ADD     r2, r2, #(28)
        
        ; Get rid of all current ticks on iconise window menu
        MOV     r3, #0
10
        LDR     r14, [r2]
        BIC     r14, r14, #1
        STR     r14, [r2]
        ADD     r3, r3, #1
        ADD     r2, r2, #24
        CMP     r3, #8
        BLT     %BT10

        SUB     r2, r2, #(8*24)

        LDR     r0, Pinboard_options
        TST     r0, #PinboardOption_UseWinToCorner
        BEQ     %FT20

        ; Calculate which corner we're in (0-3)
        MOV     r1, #0
        TST     r0, #PinboardOption_WinToCornerLR
        ADDNE   r1, r1, #2
        TST     r0, #PinboardOption_WinToCornerTB
        ADDNE   r1, r1, #1
        ADD     r1, r1, #2
        
        ; Work our which menu option to tick
        MOV     r0, #24
        MUL     r3, r1, r0
        LDR     r14, [r2, r3]
        ORR     r14, r14, #1
        STR     r14, [r2, r3]
      
        ; Work out which of horizontal or vertical to tick
        LDR     r0, Pinboard_options
        TST     r0, #PinboardOption_WinToCornerHV
        MOVNE   r1, #7
        MOVEQ   r1, #6
        MOV     r0, #24
        MUL     r3, r1, r0
        LDR     r14, [r2, r3]
        ORR     r14, r14, #1
        STR     r14, [r2, r3]
        B       %FT30

20
        TST     r0, #PinboardOption_IconiseToIconBar
        ADDNE   r2, r2, #24
        LDR     r14, [r2]
        ORR     r14, r14, #1
        STR     r14, [r2]

30
      ]
@


4.1.4.2
log
@Improved consistency of files/windows, plus JPEG backdrops
@
text
@d46 1
a46 1
pinboard_menu_layout    #       28+24*11
d52 1
a58 2
pm_iconise              Item    M45, iconise_menu_layout
pm_tidyto               Item    M46, tidy_menu_layout
a81 11
        
tidy_menu_layout        #       28+24*6
rom_tidy_menu
tidy_menu_layout        Menu    T7
tm_to_topleft           Item    T71
tm_to_bottomleft        Item    T72
tm_to_topright          Item    T73
tm_to_bottomright       Item    T74,,"-"
tm_stackhorizontally    Item    T75
tm_stackvertically      Item    T76
        DCB 0
a305 7
        
        ADR     r0, message_file_block + 4
        ADRL    r1, rom_tidy_menu
        ADRL    r2, tidy_menu_layout
        MOV     r3, #menu_space
        SWI     XMessageTrans_MakeMenus
        Pull    "PC",VS
a323 1
       [ Version < 68
a327 1
       ]
a347 1
        B       %FT01
a404 6
        
        [ Version >= 67
        LDR     r14, =&C85
        TEQ     r2, r14
        BEQ     %FT03
        ]
d426 2
a427 3
 [ Version >= 67
        ; Now tick the options on the Iconise to... menu
        ; Work out where the menu data is - there's two menu's before it.
d429 3
a431 1
        ADD     r2, r2, #( (28+24*11) + (28+24*3) + 28 )
d443 1
a445 1
        ; Now decide which options to tick
d477 1
a477 1
20      ; Tick Iconise to iconbar?
d483 1
d485 1
a485 44
        ; Now tick the options on the Tidy to... menu
        ; Work out where the menu data is - there's two menu's before it.
        ADR     r2, menu_store
        ADD     r2, r2, #( (28+24*11) + (28+24*3) + (28+24*8) + 28 )

        ; Get rid of all current ticks on iconise window menu
        LDR     r0, Pinboard_options
        MOV     r3, #0
40
        LDR     r14, [r2]
        BIC     r14, r14, #1
        STR     r14, [r2]
        ADD     r3, r3, #1
        ADD     r2, r2, #24
        CMP     r3, #6
        BLT     %BT40
        SUB     r2, r2, #(6*24)

        ; Now decide which options to tick
        ; Calculate which corner we're in (0-3)
        MOV     r1, #0
        TST     r0, #PinboardOption_TidyToCornerLR
        ADDNE   r1, r1, #2
        TST     r0, #PinboardOption_TidyToCornerTB
        ADDNE   r1, r1, #1
        
        ; Work our which menu option to tick
        MOV     r0, #24
        MUL     r3, r1, r0
        LDR     r14, [r2, r3]
        ORR     r14, r14, #1
        STR     r14, [r2, r3]

        ; Work out which of horizontal or vertical to tick
        LDR     r0, Pinboard_options
        TST     r0, #PinboardOption_TidyToCornerHV
        MOVNE   r1, #5
        MOVEQ   r1, #4
        MOV     r0, #24
        MUL     r3, r1, r0
        LDR     r14, [r2, r3]
        ORR     r14, r14, #1
        STR     r14, [r2, r3]
 ]
@


4.1.4.3
log
@Fixed bug which can corrupt IconiseTo submenu.
@
text
@d369 1
d374 2
a375 4
        ;ADRL    r2,menu_store+400
        ;MOV     r3,#menu_space-400
        ADRL    r2,menu_store+1024-112
        MOV     r3,#112
@


4.1.4.4
log
@Windows, as well as files, can be selected, plus new menu structure and options
@
text
@d24 1
a25 1

a35 1

d43 1
d46 1
a46 7
pinboard_menu_offset    *       0
 [ show_backdrop_options
pinboard_menu_size      *       28+24*7
 |
pinboard_menu_size      *       28+24*5
 ]
pinboard_menu_layout    #       pinboard_menu_size
d48 7
a54 7
pinboard_menu_layout    Menu    T3
pm_selection            Item    M31, selection_menu_layout
pm_selectall            Item    M33, selectall_menu_layout
pm_clear_selection      Item    M34
pm_options              Item    M35, options_menu_layout
pm_save                 Item    M36
 [ show_backdrop_options
d57 3
a59 1
 ]
d62 1
a62 3
backdrop_menu_offset    *       pinboard_menu_offset + pinboard_menu_size
backdrop_menu_size      *       28+24*3
backdrop_menu_layout    #       backdrop_menu_size
d70 2
a71 3
iconise_menu_offset     *       backdrop_menu_offset + backdrop_menu_size
iconise_menu_size       *       28+24*8
iconise_menu_layout     #       iconise_menu_size
d74 8
a81 8
im_atclose              Item    M61
im_to_iconbar           Item    M62
im_to_topleft           Item    M63
im_to_bottomleft        Item    M64
im_to_topright          Item    M65
im_to_bottomright       Item    M66,,"-"
im_stackhorizontally    Item    M67
im_stackvertically      Item    M68
d84 1
a84 3
tidy_menu_offset        *       iconise_menu_offset + iconise_menu_size
tidy_menu_size          *       28+24*6
tidy_menu_layout        #       tidy_menu_size
d87 6
a92 6
tm_to_topleft           Item    M71
tm_to_bottomleft        Item    M72
tm_to_topright          Item    M73
tm_to_bottomright       Item    M74,,"-"
tm_stackhorizontally    Item    M75
tm_stackvertically      Item    M76
d94 1
a95 33
options_menu_offset     *       tidy_menu_offset + tidy_menu_size
options_menu_size       *       28+24*3
options_menu_layout     #       options_menu_size
rom_options_menu
options_menu_layout     Menu    T8
om_iconisewindows       Item    M81, iconise_menu_layout
om_tidyfiles            Item    M82, tidy_menu_layout
om_gridlock             Item    M83
        DCB 0

selection_menu_offset   *       options_menu_offset + options_menu_size
selection_menu_size     *       28+24*3
selection_menu_layout   #       selection_menu_size
rom_selection_menu
selection_menu_layout   Menu    T9
se_tidy                 Item    M91
se_open                 Item    M92
se_remove               Item    M93
        DCB 0
        
selectall_menu_offset   *       selection_menu_offset + selection_menu_size
selectall_menu_size     *       28+24*3
selectall_menu_layout   #       selectall_menu_size
rom_selectall_menu
selectall_menu_layout   Menu    T10
sa_files                Item    M101
sa_windows              Item    M102
sa_windowsandfiles      Item    M103
        DCB 0

totalmenusize           *       selectall_menu_offset + selectall_menu_size

 ! 0, "Menu data size is ":CC:(:STR:(totalmenusize)):CC:" bytes"
d240 2
a241 2
        ;LDR     r14,info_dbox_handle                    ; Point info entry at info box.
        ;STR     r14,menu_store+28+tim_info*24+4
d310 2
a311 1

d318 1
a318 1

d325 2
a326 22

        ADR     r0, message_file_block + 4
        ADRL    r1, rom_options_menu
        ADRL    r2, options_menu_layout
        MOV     r3, #menu_space
        SWI     XMessageTrans_MakeMenus
        Pull    "PC",VS

        ADR     r0, message_file_block + 4
        ADRL    r1, rom_selection_menu
        ADRL    r2, selection_menu_layout
        MOV     r3, #menu_space
        SWI     XMessageTrans_MakeMenus
        Pull    "PC",VS

        ADR     r0, message_file_block + 4
        ADRL    r1, rom_selectall_menu
        ADRL    r2, selectall_menu_layout
        MOV     r3, #menu_space
        SWI     XMessageTrans_MakeMenus
        Pull    "PC",VS

d334 2
a335 2
        ;LDR     r14,info_dbox_handle                    ; Point info entry at info box.
        ;STR     r14,menu_store+28+pm_info*24+4
a340 2
        LDR     r0, Window_Icons
        ADD     r14, r14, r0
d350 4
a353 9
        LDR     r14, menu_store+28+pm_selectall*24+8
        ORREQ   r14, r14, #is_shaded
        BICNE   r14, r14, #is_shaded
        STR     r14, menu_store+28+pm_selectall*24+8

        ;LDR     r14,menu_store+28+pm_select_all*24+8    ; Shade 'Select all' if no icons.
        ;ORREQ   r14,r14,#is_shaded
        ;BICNE   r14,r14,#is_shaded
        ;STR     r14,menu_store+28+pm_select_all*24+8
a355 2
        LDR     r14, Windows_Selected
        ADD     r0, r0, r14
a356 5
        
        LDR     r14, menu_store+28+pm_selection*24+8
        ORREQ   r14, r14, #is_shaded
        BICNE   r14, r14, #is_shaded
        STR     r14, menu_store+28+pm_selection*24+8
d363 4
a366 4
        ;LDR     r14,menu_store+28+pm_remove*24+8        ; Shade 'Remove icon' if no selected icons.
        ;ORREQ   r14,r14,#is_shaded
        ;BICNE   r14,r14,#is_shaded
        ;STR     r14,menu_store+28+pm_remove*24+8
d371 2
a372 2
        ;ADR     r0,message_file_block+4                 ; Change to remove selection if more than
        ;ADR     r1,remove_selection_token               ; one selected icon.
d375 23
a397 23
        ;ADRL    r2,menu_store+1024-112
        ;MOV     r3,#112
        ;SWI     XMessageTrans_Lookup
        ;Pull    "PC",VS


        ;MOV     r1,#12
        ;ADD     r1, r1, r3, LSL #4
        ;LDR     r4, menu_store+16
        ;CMP     r1, r4
        ;STRGT   r1, menu_store+16

        ;DebugS  pi,"String is ",r2
        ;CMP     r2,#0
        ;STR     r2,menu_store+28+pm_remove*24+12
        ;ADD     r3,r3,#1
        ;STR     r3,menu_store+28+pm_remove*24+20
        ;MOV     r2,#0
        ;STR     r2,menu_store+28+pm_remove*24+16

        ;LDR     r14,menu_store+28+pm_remove*24+8
        ;ORR     r14,r14,#if_indirected
        ;STR     r14,menu_store+28+pm_remove*24+8
a400 1
 [ show_backdrop_options
d429 1
d433 1
a446 1
 ]
a447 35
        ; Shade Selection->Remove if any windows are selected
        LDR     r0, Windows_Selected
        LDR     r14, menu_store + selection_menu_offset + 28 + se_remove*24+8
        CMP     r0, #0
        ORRNE   r14, r14, #is_shaded
        BICEQ   r14, r14, #is_shaded
        STR     r14, menu_store + selection_menu_offset + 28 + se_remove*24+8

        ; Shade 'Select all->Windows' if no windows on backdrop
        LDR     r0, Window_Icons
        LDR     r14, menu_store + selectall_menu_offset + 28 + sa_windows*24+8
        CMP     r0, #0
        ORREQ   r14, r14, #is_shaded
        BICNE   r14, r14, #is_shaded
        STR     r14, menu_store + selectall_menu_offset + 28 + sa_windows*24+8

        ; Shade 'Select all->Files' if no files on backdrop
        LDR     r0, Pinboard_Icons
        LDR     r14, menu_store + selectall_menu_offset + 28 + sa_files*24+8
        CMP     r0, #0
        ORREQ   r14, r14, #is_shaded
        BICNE   r14, r14, #is_shaded
        STR     r14, menu_store + selectall_menu_offset + 28 + sa_files*24+8

        ; Shade 'Select all->Windows and files' if there's either no files or no windows
        LDR     r0, Pinboard_Icons
        CMP     r0, #0
        LDRNE   r0, Window_Icons
        LDR     r14, menu_store + selectall_menu_offset + 28 + sa_windowsandfiles*24+8
        CMP     r0, #0
        ORREQ   r14, r14, #is_shaded
        BICNE   r14, r14, #is_shaded
        STR     r14, menu_store + selectall_menu_offset + 28 + sa_windowsandfiles*24+8
        
        ; Tick 'Grid' if grid enabled.
d450 1
a450 1
        LDR     r14, menu_store+options_menu_offset+28+om_gridlock*24+0
d453 1
a453 1
        STR     r14,menu_store+options_menu_offset+28+om_gridlock*24+0
d455 1
d459 1
a459 1
        ADD     r2, r2, #iconise_menu_offset+28
d515 1
a515 1
        ADD     r2, r2, #tidy_menu_offset + 28
d555 1
@


4.1.4.5
log
@Fixed bug which can cause Pinboard to die when dragging icons to other apps
@
text
@a46 1

a51 1

@


4.1.4.6
log
@Removed Info option on TinyDirs menu.
Updated interactive help messages.
Shift+Click on close icon now ALWAYS iconises the window underneath the icon
(old behaviour), while a click on iconise button iconises according to the
IconiseTo corner.
@
text
@d31 1
a31 1
tm_removeselection      Item    M13
d37 1
a37 1
tinydirs_icon_menu_layout    #       28+24*1
d40 2
a41 2
;tim_info                Item    M21, tinydirs_menu_layout
tim_quit                Item    M22, tinydirs_menu_layout
d286 1
d289 1
a289 1
        MOV     r3,#96+1*44
@


4.1.4.7
log
@Fixed a couple of bugs.
Improved tidying code.
Filenames are now truncated.
@
text
@d163 3
a165 3
        ;LDR     lr, Pinboard_options
        ;TST     lr, #PinboardOption_IconiseToIconBar
        ;BEQ     %FT00
@


4.1.4.8
log
@When the only window icons are on the iconbar, grey out the 'Select all'
menu item.
File 'Status' added giving Pinboard status after RPC2 cancellation.
@
text
@d401 1
a402 3
        LDR     r14, Iconbar_Icons
        SUB     r0, r0, r14
        LDR     r14,Pinboard_Icons
a532 2
        LDR     r14, Iconbar_Icons
        SUB     r0, r0, r14
@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@@


4.1.5.1
log
@Import from SrcFiler
@
text
@@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
