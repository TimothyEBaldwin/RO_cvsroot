head	4.15;
access;
symbols
	Pinboard-1_04:4.15
	Pinboard-1_03:4.15
	Pinboard-1_02:4.14
	Pinboard-1_01:4.14
	Pinboard-1_00:4.13
	Pinboard-0_99:4.13
	Pinboard-0_98:4.13
	Pinboard-0_97:4.13
	Pinboard-0_96:4.13
	Pinboard-0_95:4.12
	Pinboard-0_94:4.11
	Pinboard-0_93:4.11
	Pinboard-0_92:4.8
	Pinboard-0_91:4.8
	Pinboard-0_90:4.8
	Pinboard-0_89:4.8
	Pinboard-0_88:4.8
	Pinboard-0_87:4.8
	Pinboard-0_86:4.7
	Pinboard-0_85:4.7
	Pinboard-0_84:4.7
	Pinboard-0_83:4.7
	Pinboard-0_82:4.6
	RO_5_07:4.5
	Pinboard-0_81:4.5
	Pinboard-0_80:4.5
	Pinboard-0_79:4.5
	Pinboard-0_78:4.5
	Pinboard-0_77:4.4
	Pinboard-0_76:4.4
	Ursula_merge:4.1.4.15
	Pinboard-0_75:4.3
	mstphens_UrsulaRiscPCBuild_20Nov98:4.1.4.14
	Ursula_RiscPC:4.1.4.14.0.2
	rleggett_Pinboard-0_75d:4.1.4.15
	rthornb_UrsulaBuild-19Aug1998:4.1.4.14
	UrsulaBuild_FinalSoftload:4.1.4.14
	rthornb_UrsulaBuild-12Aug1998:4.1.4.14
	aglover_UrsulaBuild-05Aug1998:4.1.4.14
	rthornb_UrsulaBuild-29Jul1998:4.1.4.14
	rthornb_UrsulaBuild-22Jul1998:4.1.4.14
	rleggett_Pinboard-0_75c:4.1.4.14
	rleggett_Pinboard-0_75b:4.1.4.14
	rleggett_Pinboard-0_75:4.1.4.13
	rthornb_UrsulaBuild-15Jul1998:4.1.4.12
	rthornb_UrsulaBuild-07Jul1998:4.1.4.12
	rthornb_UrsulaBuild-17Jun1998:4.1.4.12
	rthornb_UrsulaBuild-03Jun1998:4.1.4.12
	rthornb_UrsulaBuild-27May1998:4.1.4.12
	rthornb_UrsulaBuild-21May1998:4.1.4.11
	rleggett_Pinboard-0_74:4.1.4.11
	rthornb_UrsulaBuild_01May1998:4.1.4.10
	Spinner_B20_2:4.1.7.1
	Spinner_19_3:4.1.7.1
	Spinner_B18:4.1.7.1
	Spinner_B17:4.1.7.1
	Spinner_B15:4.1.7.1
	Spinner_B14:4.1.7.1
	Spinner_B13:4.1.7.1
	Spinner_B12:4.1.7.1
	Spinner_B10:4.1.7.1
	Daytona:4.1.0.6
	Daytona_bp:4.1
	Ursula:4.1.0.4
	Ursula_bp:4.1
	Spinner_B7:4.1.7.1
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	ARTtmp:4.1.7.1.0.2
	Spin_merge:4.1.7.1
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.15
date	2017.05.06.09.46.26;	author rool;	state Exp;
branches;
next	4.14;
commitid	0B1LpIyDG92VpjQz;

4.14
date	2016.05.10.21.05.00;	author rsprowson;	state Exp;
branches;
next	4.13;
commitid	O1qMSkbGF6eaMY5z;

4.13
date	2012.09.11.19.31.14;	author rsprowson;	state Exp;
branches;
next	4.12;
commitid	wgigNNHV7grve9kw;

4.12
date	2012.08.23.19.59.13;	author rsprowson;	state Exp;
branches;
next	4.11;
commitid	rztFpV1VBvCVZHhw;

4.11
date	2011.09.24.07.31.20;	author rsprowson;	state Exp;
branches;
next	4.10;
commitid	nRjnbtmOSxK1BIAv;

4.10
date	2011.09.24.07.25.50;	author rsprowson;	state Exp;
branches;
next	4.9;
commitid	NapphrXjtkIXyIAv;

4.9
date	2011.09.24.07.23.44;	author rsprowson;	state Exp;
branches;
next	4.8;
commitid	U6nT8u4TlrjayIAv;

4.8
date	2007.11.05.17.25.53;	author srevill;	state Exp;
branches;
next	4.7;

4.7
date	2006.03.14.18.45.07;	author srevill;	state Exp;
branches;
next	4.6;

4.6
date	2006.03.14.15.32.36;	author srevill;	state Exp;
branches;
next	4.5;

4.5
date	2002.11.11.12.34.51;	author rsprowson;	state Exp;
branches;
next	4.4;

4.4
date	2001.03.16.17.07.04;	author sbrodie;	state Exp;
branches;
next	4.3;

4.3
date	99.08.17.20.38.25;	author sbrodie;	state Exp;
branches;
next	4.2;

4.2
date	99.08.17.19.05.22;	author sbrodie;	state Exp;
branches;
next	4.1;

4.1
date	96.11.05.09.30.04;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.4.1
	4.1.5.1
	4.1.7.1;
next	;

4.1.1.1
date	96.11.05.09.30.04;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.05.23.29.56;	author nturton;	state Exp;
branches;
next	;

4.1.4.1
date	97.06.13.08.40.34;	author rleggett;	state Exp;
branches;
next	4.1.4.2;

4.1.4.2
date	97.08.04.11.50.37;	author rleggett;	state Exp;
branches;
next	4.1.4.3;

4.1.4.3
date	97.09.24.15.29.17;	author rleggett;	state Exp;
branches;
next	4.1.4.4;

4.1.4.4
date	97.10.21.09.57.06;	author rleggett;	state Exp;
branches;
next	4.1.4.5;

4.1.4.5
date	97.10.22.09.33.30;	author rleggett;	state Exp;
branches;
next	4.1.4.6;

4.1.4.6
date	97.12.05.09.40.05;	author rleggett;	state Exp;
branches;
next	4.1.4.7;

4.1.4.7
date	98.01.07.10.28.42;	author rleggett;	state Exp;
branches;
next	4.1.4.8;

4.1.4.8
date	98.03.27.09.36.39;	author rleggett;	state Exp;
branches;
next	4.1.4.9;

4.1.4.9
date	98.04.15.11.24.52;	author rleggett;	state Exp;
branches;
next	4.1.4.10;

4.1.4.10
date	98.04.27.17.41.20;	author rleggett;	state Exp;
branches;
next	4.1.4.11;

4.1.4.11
date	98.05.06.08.54.17;	author rleggett;	state Exp;
branches;
next	4.1.4.12;

4.1.4.12
date	98.05.26.11.14.26;	author rleggett;	state Exp;
branches;
next	4.1.4.13;

4.1.4.13
date	98.07.22.09.30.06;	author rleggett;	state Exp;
branches;
next	4.1.4.14;

4.1.4.14
date	98.07.22.09.34.26;	author rleggett;	state Exp;
branches;
next	4.1.4.15;

4.1.4.15
date	98.09.18.10.18.16;	author rleggett;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.12.21.03;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.20.18.56;	author nturton;	state Exp;
branches;
next	;


desc
@@


4.15
log
@Fixes for pinboard backdrop sprite changing
Detail:
  Fix out-by-1 error in MakeCompactModeWord, the palette checksum read from array index -1 due to the loop construction.
  Consider the x/y size as well as the compact mode word when deciding whether to recache the backdrop sprite.
  Don't assume the screen byte size is equivalent to working out the sprite byte size, due to word rounding at the end of each line. Calculate it properly.
  Allow the Wimp_SlotSize to exactly equal the required memory (previously, had to be larger).
Admin:
  Submission from Timothy Baldwin, with minor refactoring.

Version 1.03. Tagged as 'Pinboard-1_03'
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
; > s.Pinboard

;;-----------------------------------------------------------------------------
;; Wimp utility:  Pinboard
;;
;; Change list
;;              16-Jun-91 : Created.
;;
;;-----------------------------------------------------------------------------

        AREA    |Pinboard$$Code|, CODE, READONLY, PIC

Module_BaseAddr

        GET     hdr:ListOpts
        GET     hdr:Macros
        GET     hdr:System
        GET     hdr:ModHand
        GET     hdr:Services
        GET     hdr:VduExt
        GET     hdr:FSNumbers
        GET     hdr:NewErrors
        GET     hdr:Territory
        GET     hdr:Variables
        GET     hdr:Proc
        GET     hdr:Sprite
        GET     hdr:Wimp
        GET     hdr:WimpSpace
        GET     hdr:Messages
        GET     hdr:FilerAct
        GET     hdr:Machine.<Machine>
        GET     hdr:CMOS
        GET     hdr:HighFSI
        GET     hdr:FileTypes
        GET     hdr:MsgTrans
        GET     hdr:MsgMenus
        GET     hdr:ResourceFS
        GET     hdr:ColourTran
        GET     hdr:DragASprit
        GET     hdr:Hourglass
        GET     hdr:HostFS
        GET     hdr:NdrDebug
        GET     hdr:Switcher
        GET     Hdr:Font
        GET     Hdr:SprExtend
        GET     Hdr:OSBytes
        GET     VersionASM

        GBLS    RESPATH
RESPATH SETS    "Resources:$.Resources.Pinboard."

        GBLL    standalonemessages
        [ :DEF: standalone
standalonemessages      SETL    standalone
        |
standalonemessages      SETL    {FALSE} ; build resources into module?
        ]

        GBLL    UseResize
UseResize       SETL    {TRUE}          ; use Wimp_ResizeIcon

        GBLL    defaultbackdrop
defaultbackdrop SETL    {FALSE}         ; use default backdrop for portable?

        GBLL    useECFforLCD
useECFforLCD    SETL    {FALSE}         ; use ECF to do LCD background
                                        ; Service calls are hammered if set to TRUE because an
                                        ; OS_ReadSysInfo of monitor type is done EVERY redraw.

      [ defaultbackdrop
useECFforLCD    SETL    {FALSE}
      ]

        GBLL    drag_on_iconise
drag_on_iconise SETL    {FALSE}         ; pick up window icon immediately on iconise

        GBLL    iconise_to_iconbar
iconise_to_iconbar SETL {TRUE}

        GBLL    show_backdrop_options   ; does menu show 'Make backdrop', 'Remove backdrop' etc.
show_backdrop_options SETL {FALSE}

        GBLL    debug_commands          ; provide *commands for debugging
debug_commands  SETL {FALSE}

        GBLL    truncate_filenames      ; truncate filenames and add ellipsis
truncate_filenames SETL {TRUE}

        GBLL    ursulawimp              ; using an Ursula WIMP?
ursulawimp      SETL {TRUE}

        GBLL    noiconbar               ; If there's no icon bar, then stretch pinboard to bottom of screen.
noiconbar       SETL {FALSE}

        GBLL    technicolour_text       ; The text for the icon can be set with backdrop -textcolour
technicolour_text  SETL {TRUE}

        GBLL    hostvdu
        GBLL    debugbd
        GBLL    debugpi
        GBLL    debugtd
        GBLL    debugic
        GBLL    debugsa
        GBLL    debugme
        GBLL    debugim
        GBLL    debughe
        GBLL    debugspr
        GBLL    debugtmp
        GBLL    debugnk

debug    SETL   {FALSE}
debugnk  SETL   {FALSE}
debugbd  SETL   {FALSE}         ; Backdrop picture
debugpi  SETL   {FALSE}         ; Pinboard icons
debugtd  SETL   {FALSE}         ; TinyDirs
debugic  SETL   {FALSE}         ; Iconize
debugsa  SETL   {FALSE}         ; Save
debugme  SETL   {FALSE}         ; Menus
debugim  SETL   {FALSE}         ; Impression bug.
debughe  SETL   {FALSE}         ; Interactive Help
debugspr SETL   {FALSE}         ; Backdrop sprite
debugtmp SETL   {FALSE}         ; Temporary debug
hostvdu  SETL   {TRUE}

    [ ursulawimp
      ! 0, ""
      ! 0, "WARNING - this version only suitable for use with Ursula WIMP or later"
      ! 0, ""
    |
      ! 0, ""
      ! 0, "WARNING - Why aren't you using the ursula WIMP?"
      ! 0, ""
    ]

    [ debug_commands :LOR: debug
      ! 0, ""
      ! 0, "WARNING - debugging options still switched on."
      ! 0, ""
    ]


; ----------------------------------------------------------------------------------------------------------------------
        MACRO
$label  ALIGNHASH  $o,$m
      [ ((@@-$o):AND:($m-1))<>0
$label  #          $m-((@@-$o):AND:($m-1))
      |
$label  #          0
      ]
        MEND


space   *       " "
delete  *       127


bd_OptionCentred                *       1 :SHL:   0
bd_OptionTiled                  *       1 :SHL:   1
bd_OptionScaled                 *       1 :SHL:   2
bd_OptionRecache                *       1 :SHL:   3
bd_OptionActive                 *       1 :SHL:  31
bd_OptionJPEG                   *       1 :SHL:   4

PinboardOption_Grid             *       1 :SHL:   0
PinboardOption_TinyDirs         *       1 :SHL:   1
PinboardOption_NoIconize        *       1 :SHL:   2
PinboardOption_IconiseToIconBar *       1 :SHL:   3
PinboardOption_UseWinToCorner   *       1 :SHL:   4
PinboardOption_WinToCornerHV    *       1 :SHL:   5
PinboardOption_WinToCornerLR    *       1 :SHL:   6
PinboardOption_WinToCornerTB    *       1 :SHL:   7
PinboardOption_TidyToCornerHV   *       1 :SHL:   8
PinboardOption_TidyToCornerLR   *       1 :SHL:   9
PinboardOption_TidyToCornerTB   *       1 :SHL:   10
PinboardFlag_TidyWindows        *       1 :SHL:   12
PinboardFlag_UseWindowList      *       1 :SHL:   14
PinboardFlag_PinboardFull       *       1 :SHL:   15
PinboardFlag_SkipSelected       *       1 :SHL:   16

IconizeAtFlag_ShiftCloseIcon    *       1 :SHL:   0

DragType_NoDrag                 *       0
DragType_SelectDrag             *       1
DragType_AdjustDrag             *       2
DragType_SelectDragIcon         *       3
DragType_AdjustDragIcon         *       4
DragType_Iconized               *       5
DragType_Save                   *       6

grid_x_spacing          *       192
grid_y_spacing          *       128

default_icon_bar_height *       132

; ----------------------------------------------------------------------------------------------------------------------
;       Workspace layout
indirected_space        *       256

workspace       RN      R12
                ^       0,workspace
wsorigin                #       0
mytaskhandle            #       4               ; put here so we know where it is
saveas_handle           #       4               ; handle of saveas dbox
bounding_box            #       4*4             ; Screen x0 y0 x1 y1
backdrop_handle         #       4               ; Backdrop window's handle
Filer_taskid            #       4               ; Filer's task handle.
backdrop_path           #       4               ; Full pathname of backdrop file.
backdrop_options        #       4               ; Options for backdrop picture.
poll_word               #       4               ; Poll word for Wimp_Poll
PollWordReason_Recache  *       1               ; Re-cache backdrop sprite.
PollWordReason_Buffered *       2               ; Buffered list not empty.
PollWordReason_Remove   *       4
slot_size               #       4               ; Current slot size.
tmp_slot_size           #       4               ; Tmp slot size while scaling sprite.
default_palette         #       20*4            ; Default wimp palette
file_size               #       4               ; Sprite file size.
ScaleFactors            #       4*8             ; For sprite scaling.
scale_x1                #       4               ; x1,y1 for sprite in OS units.
scale_y1                #       4               ;
Sprite_x                #       4               ; x,y coordinates for redraw.
Sprite_y                #       4               ;
Screen_x1               #       4               ; Screen size in OS Units
Screen_y1               #       4
XEig                    #       4               ; X and Y Eig factors for
YEig                    #       4               ; current mode.
CachedBackdropMode      #       4               ; Mode for which the backdrop sprite was cached.
CachedBackdrop_x1       #       4               ;
CachedBackdrop_y1       #       4               ;
Buffered_list           #       4               ; Buffered list of icons.
Icon_list               #       4               ; List of active icons.
MonotonicID             #       4               ; Monotonic ID for icons.
Pinboard_options        #       4               ; Pinboard options
IconizeAtX              #       4               ; X co-ordinate sent by message IconizeAt
IconizeAtY              #       4               ; Y co-ordinate sent by message IconizeAt
IconizeAtFlags          #       4               ; flags word sent by message IconizeAt
Pinboard_Icons          #       4               ; Number of icons on pinboard
Iconbar_Icons           #       4               ; Number of iconised window icons on the icon bar
Window_Icons            #       4               ; Number of window icons on pinboard
All_PB_Icons            #       4               ; total no. of icons
TinyDirs_Icons          #       4               ; Number of icons on icon bar.
DragBBox                #       4*4             ; x0,y0,x1,y1 of drag box from filer.
NextPosition            #       4*2             ; x0,y1 of next icon to place.
Pinboard_Selected       #       4               ; No. of selected icons on pinboard
TinyDirs_Selected       #       4               ; No. of selected icons on icon bar
Windows_Selected        #       4               ; No. of iconised windows selected on pinboard
DragType                #       4               ; Type of current drag.
DragBBOX                #       4*4             ; Coordinates the drag started from.
DragWindow              #       4               ; Window from which the drag started.
PointerInfo             #       4*5             ; Pointer info at end of drag.
filer_action_copy_options       #       4       ; Copy options for filer action window.
copy_options            #       20              ; Copy options for *Copy
TinyDirs_Handle         #       4               ; Handle of TinyDirs icon.
message_file_block      #       5*4
soft_selection_icon     #       4               ; icon for soft (menu) selection
soft_selection_window   #       4               ; Window handle for soft selection
CurrentMenu             #       4               ; Menu currently open
iconized_window         #       4               ; Handle of window being iconized

ellipsis_width          #       4               ; width of an ellipsis (Œ) in the desktop font

iconized_task           #       4               ; Handle of task of window being iconized.
window_title            #       12              ; Title of window being iconized
iconize_x               #       4
iconize_y               #       4
iconized_ptr            #       4
drag_start              #       8               ; x,y of iconized drag start
drag_window             #       4
drag_icon               #       4
save_filename_address   #       4
save_boot_length        #       4
save_boothat_length     #       4
icon_bar_height         #       4
;EventV_Claimed          #       4               ; non-zero when we have EventV claimed
CaretPos                #       4*6             ; stored caret position (e.g. who we took it from)
      [ useECFforLCD
backdropECF             #       32
      ]
ConversionSpace         #       12
GotToClearBackdrop      #       4               ; need to clear the backdrop
background_colour       #       4               ; Colour of background
      [ technicolour_text
foreground_colour       #       4               ; Colour of the icon text
      ]
indirected_data_offset * (@@-wsorigin)
indirected_data         #       indirected_space ; Data area for indirected data from the template file
save_filename_offset * (@@-wsorigin)
save_filename           #       &180              ; Data area for indirected data from the template file

Default_IconizeAtFlags  * 1

        ALIGNHASH       wsorigin,16

colourtrans     #       0       ; start of the colourtrans area
dataarea        #       &100    ; wimp data block
dest_directory  #       &100    ; Destination directory for copy.
temp_buffer     #       &40     ; Temporary buffer for various bits

menu_space      *       &500

menu_store      #       menu_space    ; RAM copy of menu data
colourtrans_end #       0

stackbot        #       &100    ;  stack at most 256 bytes long
stacktop        #       0

max_running_work   *       (@@-wsorigin)


; ----------------------------------------------------------------------------------------------------------------------
; Linked iconized window block structure
                  ^       0
w_next_ptr        #       4       ; Pointer to next in chain                (-1 if none)
w_prev_ptr        #       4       ; Pointer to previous entry in chain      (-1 if none)
w_icon_handle     #       4       ; Handle of icon representing window
w_icon_id         #       4       ; Handle of window in which iconised icon is placed.
      [ technicolour_text
w_valid_string    #       33      ; CBBGGRR/BBGGRR/////BBGGRR/BBGGRR;
w_sprite_prefix   #       1       ; "S" for validation string.
w_sprite_name     #       14      ; Sprite name to use.
      |
w_sprite_prefix   #       1       ; "S" for validation string.
w_sprite_name     #       15      ; Sprite name to use.
      ]
w_task            #       4       ; Task ID.
w_window_handle   #       4       ; Window handle (of the iconised window).
w_window_pos      #       24      ; Original window position, scroll pos.
w_window_title    #       20      ; Title of the window.
w_block_size      *      (@@-w_next_ptr)

        ASSERT  w_next_ptr=0
        ASSERT  (w_window_pos-w_window_handle) = 4

; ----------------------------------------------------------------------------------------------------------------------
; Linked icon block structure

                ^       0
ic_next         #       4       ; Pointer to next icon
ic_prev         #       4       ; Pounter to prev icon
ic_icon         #       4       ; Icon handle for this icon.
ic_window       #       4       ; Window handle for this icon.
      [ technicolour_text
ic_valid_string #       33      ; CBBGGRR/BBGGRR/////BBGGRR/BBGGRR;
ic_spritename   #       15      ; S<spritename>
      |
ic_spritename   #       16      ; Sprite name to use.
      ]
ic_id           #       4       ; Monotonic icon ID
ic_action       #       4       ; What to do with this icon (For buffered icons)
ic_filetype     #       4       ; File type of icon's file (For any other icon).
ic_x            #       4       ; X and Y positions in window.
ic_y            #       4       ;
ic_icontext     #       4       ; pointer to the text to display for the icon.
ic_path         #       0       ; Full path for this icon.
ic_block_size   *       @@-ic_next

        ASSERT  ic_next = 0
        ASSERT  (ic_y-ic_x) = 4

; RML: Pinboard's icon and window structures really ought to be merged into one structure. As
; a start towards this aim, we make sure that various common paramaters (icon handle, window
; handle etc.) are at the same offset within each structure, via the ASSERTs below. The code
; makes use of this assumption to simplify.

        ASSERT  w_next_ptr      = ic_next
        ASSERT  w_prev_ptr      = ic_prev
        ASSERT  w_icon_handle   = ic_icon
        ASSERT  w_icon_id       = ic_window
 [ :LNOT: technicolour_text
        ASSERT  w_sprite_prefix = ic_spritename
 ]

; ----------------------------------------------------------------------------------------------------------------------
        LNK     ModHead.s

@


4.14
log
@Emit boot relative Pin/AddTinyDir commands where possible
When saving the desktop settings, use the same substring matching logic that !Configure's boot addapps/lookat/run uses, and replace the base of the name with Boot: or Boot:^.
This means that if the boot drive is renamed the pinboard still starts up with the same items on it.
Ditch support for Message_SaveDesktop - the code's been a NOP since Ursula (circa 1998).
Tested on a Raspberry Pi, renaming the SD card.

Version 1.01. Tagged as 'Pinboard-1_01'
@
text
@d241 2
@


4.13
log
@Fix for not recalculating pixel translation on backdrop tile going from G256 to C256 (or G16 to C16) mode specifier
The change in Pinboard-0_95 to get eigen factor rescaling right included a quick exit when neither the bpp nor eigen factors had changed.
However, changing from a greyscale to colour 8bpp or 4bpp mode falls fouls of this (since bpp and eigen are the same), so the backdrop sprite was not recached.
There was code to collect Message_PaletteChanged, however the Wimp hasn't sent this round since pre RISC OS 3.60, additionally the mode change code was manually disabling it (not required since Message_ModeChange was never accompanied by Message_PaletteChange according to PRM3-230). This has been switched out.
Now, the 'have I already done this sprite' flag includes the bpp and eigen factors plus a 13 bit hash of the desktop palette.

Version 0.96. Tagged as 'Pinboard-0_96'
@
text
@d282 2
@


4.12
log
@Fix for patchy tiled backdrops on changing to non EX1/EY1 mode
Pinboard keeps a note of the mode (from OS_Byte 135) that the backdrop sprite tile was last cached in, to avoid having to recache it all the time. However, the comparison fails when the mode specifier block (ie. when OS_Byte 135 is not reporting a numeric screen mode) is static since although the mode might have changed Pinboard would not think it had and hence not recache the sprite.
The result is a patchy desktop, for example changing from EX1/EY1 to EX0/EY0 would leave a quadrant arrangement of 1 redrawn patch and 3 not redrawn.
Backdrop.s:
Line 151 onwards, when a mode specifier is used, build a magic mode word combining EX EY and BPP (the 3 parameters the cache sprite function cares about), as a stronger check.
Tail.s:
Line 130 onwards, calculate the iconbar height properly (previously used 134 pixels for EY0 modes, 1 too high, leading to a thin strip of background colour above the iconbar.
Other changes
 - Use sprite area offset names from Hdr:Sprites rather than magic numbers
 - Use OS_Byte reasons from Hdr:OsBytes
 - Use "file.s" style names in LNK commands
 - Move BadOptions/NotASprite error blocks to avoid range error when assembling debug versions
 - true and false for objasm {TRUE} and {FALSE}

Version 0.95. Tagged as 'Pinboard-0_95'
@
text
@a174 1
bd_OptionIgnorePaletteChange    *       1 :SHL:  30
@


4.11
log
@Shade "Configure..." when boot was unsuccessful.
When BootResources$Path is unset the option to run the configure plugin is no longer available.
Shared a "Filer_Run " string in 3x places.
Replaced most occurrences of calling XOS_ReadModeVariable of the current mode's XEig and YEig factors to use the cached copy sitting unloved in the workspace. Should thrash less during redraw.

Version 0.93. Tagged as 'Pinboard-0_93'
@
text
@d60 1
d70 1
a70 1
standalonemessages      SETL    false   ; build resources into module?
d74 1
a74 1
UseResize       SETL    true            ; use Wimp_ResizeIcon
d77 1
a77 1
defaultbackdrop SETL    false           ; use default backdrop for portable?
d80 1
a80 1
useECFforLCD    SETL    false           ; use ECF to do LCD background
d85 1
a85 1
useECFforLCD    SETL    false
d89 1
a89 1
drag_on_iconise SETL    false           ; pick up window icon immediately on iconise
d92 1
a92 1
iconise_to_iconbar SETL true
d95 1
a95 1
show_backdrop_options SETL false
d98 1
a98 1
debug_commands  SETL false
d101 1
a101 1
truncate_filenames SETL true
d104 1
a104 1
ursulawimp      SETL true
d107 1
a107 1
noiconbar       SETL false
d110 1
a110 1
technicolour_text  SETL true
d125 13
a137 14
debug    SETL   false
debugnk  SETL   false
debugbd  SETL   false           ; Backdrop picture
debugpi  SETL   false           ; Pinboard icons
debugtd  SETL   false           ; TinyDirs
debugic  SETL   false           ; Iconize
debugsa  SETL   false           ; Save
debugme  SETL   false           ; Menus
debugim  SETL   false           ; Impression bug.
debughe  SETL   false           ; Interactive Help
debugspr SETL   false           ; Backdrop sprite
debugtmp SETL   false           ; Temporary debug
hostvdu  SETL   true

d208 1
a208 1
default_icon_bar_height *       134
d384 1
a384 1
        LNK     s.ModHead
@


4.10
log
@Replace magic numbers with sumbols from header files for OS_ calls.
Same binary as 0.92, not tagged.
@
text
@a217 1
;info_dbox_handle        #       4               ; handle for ingo dbox.
@


4.9
log
@Collapse dead switches.
Same binary as 0.92, not tagged.
@
text
@d47 2
@


4.8
log
@  Prevent icons from overlapping when tidying a selection of icons.
Details:
  Tidying a selection of icons could result in icons being placed at locations
  already occupied by other icons. The reason for this is that tidying iconised
  window icons didn't check at all whether a position was occupied or not, and
  tidying file icons only checked against the list of iconised window icons.
  Essentially the code was designed for tidying all icons on the Pinboard, not
  selections.
Admin:
  Tested on Iyonix RO5.11
Changes by:
  Fred Graute

Version 0.87. Tagged as 'Pinboard-0_87'
@
text
@d15 1
a15 1
; > s.Front
a57 1

a59 3
        GBLA    Version
Version SETA    Module_Version

d106 1
a106 1
        GBLL    technicolour_text       ; The text can for the icon can be set with backdrop -textcolour
@


4.7
log
@  Different way of doing escape-aborts-drag implementation
Detail:
  Although the previous check-in works, it uses EventV to trap escape key
  press events. This mechanism doesn't stop them from being passed on to
  whoever has input focus (e.g. a task window).

  The new way to do things is to grab input focus when a drag starts and
  to restore it (if possible) when the drag f we abort the drag (and restore focus). All other keys
  are passed on to the Wimp.

  The side-effect is that any window which has focus will temporarily lose
  focus for the duration of a Pinboard drag op I think we can
  live with that.
Admin:
  Tested on Iyonix and works fine. Now, if only the Filer did this, too...

Version 0.83. Tagged as 'Pinboard-0_83'
@
text
@d195 1
d207 2
a208 2
grid_x_spacing          *       188
grid_y_spacing          *       116
@


4.6
log
@  Escape cancels drags
Detail:
  Pressing escape will cancel any current drag operation for the pinboard.
  At long bleedin' last!
Admin:
  Tested on my Iyonix. Seems to work.

Version 0.82. Tagged as 'Pinboard-0_82'
@
text
@d286 2
a287 1
EventV_Claimed          #       4               ; non-zero when we have EventV claimed
@


4.5
log
@Commented out "proginfo" string,no longer used.
Prefixed the pin and addtinydir commands that get saved in the
pinboard file with "X " so your pinboard setup continues even if a file
is no longer available.ROL did this with a new XPin command,not taken.
Merged changes from ROL to allow the icon text to be an arbitary colour
though this can be switched out with "technicolour_text" for the
purists.
Help entry added to the pinboard selection submenu,this will be greyed
out except when
 it's an app
 and it has a !help file
 and it is the only object selected
like the filer does.
Updated messages file accordingly.
Menu clicking on the "save pinboard settings" OK button no longer saves
the file,and adjust clicking keeps the menu tree open
 -> fixes bug report from 1998,now removed from "Status" file
Saveas template resized to match !Edit.
Fixed problem of select dragging a file to an app leaving the icon
selected (due to two conditional MOV R0's being followed by an
unconditional one for some reason).
 -> fixes bug report from 1998,now removed from "Status" file
Tweaked a few CMP#0 BLT's to test specifically for the iconbar handle.
The bug report in "Status" about bits of filenames being left on the
pinboard can be bodged by popping an ADD r0,r0,#16 after the XWimp_TextOp
in s.buffered but I've not done this yet.

Version 0.78. Tagged as 'Pinboard-0_78'
@
text
@d286 1
@


4.4
log
@  Updated build structure to use the shared AAsmModule makefile.
  Updated to build using objasm instead of aasm.
  Sources changed to be objasm-compatible.
Admin:
  Requires Library 0.71 or later.
  Requires BuildSys 3.06 or later.
  Requires Env 0.65 or later.

Version 0.76. Tagged as 'Pinboard-0_76'
@
text
@d45 1
a45 1
	GET	hdr:Machine.<Machine>
d61 2
a62 2
	GBLA	Version
Version	SETA	Module_Version
d81 3
a83 3
useECFforLCD    SETL    false            ; use ECF to do LCD background
                                         ; Service calls are hammered if set to TRUE because an
                                         ; OS_ReadSysInfo of monitor type is done EVERY redraw.
d110 3
d292 3
a294 1

d327 5
d333 2
a334 1
w_sprite_name     #       15      ; Sprite name
d352 4
d357 1
d379 1
d381 1
@


4.3
log
@Switched off debugging build option
@
text
@d25 2
d68 3
d72 1
@


4.2
log
@Ursula branch merged.
Added inclusion of Machine header for new CMOS header
Moved to srccommit.
Templates contain hardwired version/date information which is a long
  way out of date.  This has not been fixed in this checkin.

Version 0.75. Tagged as 'Pinboard-0_75'
@
text
@d93 1
a93 1
debug_commands  SETL true
d170 1
a170 1
bd_OptionJPEG                   *       1 :SHL:   4 
d299 1
a299 1
 
@


4.1
log
@Initial revision
@
text
@d43 1
d54 2
d57 4
a60 1
        GET     Version
a63 1
;RESPATH SETS    "scsi::4.$.Work.Modules.Pinboard."
d75 3
a77 1
useECFforLCD    SETL    true            ; use ECF to do LCD background
d89 14
d131 18
d159 5
d170 1
d176 12
d189 1
d210 1
a210 1
info_dbox_handle        #       4               ; handle for ingo dbox.
d239 3
d243 2
d251 1
d265 2
d273 1
d282 1
d289 2
d296 4
a299 1
menu_space      *       512
d308 1
d310 12
a321 12
;       Linked iconized window block structure
                ^       0
w_next_ptr        #       4       ;       Pointer to next in chain                (-1 if none)
w_prev_ptr        #       4       ;       Pointer to previous entry in chain      (-1 if none)
w_icon_handle     #       4       ;       Icon handle
w_icon_id         #       4       ;       Icon identifier
w_task            #       4       ;       Task ID.
w_window_handle   #       4       ;       Window handle.
w_window_pos      #       24      ;       Original window position, scroll pos.
w_sprite_prefix   #       1       ;       "S" for validation string.
w_sprite_name     #       14      ;       Sprite name
w_window_title    #       20      ;       Title of the window.
d327 31
@


4.1.4.1
log
@Added option to iconise windows to a corner
@
text
@a131 7
 [ Version >=67
PinboardOption_UseWinToCorner   *       1 :SHL:   4
PinboardOption_WinToCornerHV    *       1 :SHL:   5
PinboardOption_WinToCornerLR    *       1 :SHL:   6
PinboardOption_WinToCornerTB    *       1 :SHL:   7
 ]

a180 4
 [ Version >= 67
IconizeAtX              #       4               ; X co-ordinate sent by message IconizeAt
IconizeAtY              #       4               ; Y co-ordinate sent by message IconizeAt
 ]
a225 4

 [ Version >= 67
menu_space      *       640
 |
a226 2
 ]
 
@


4.1.4.2
log
@Improved consistency of files/windows, plus JPEG backdrops
@
text
@a125 3
 [ Version >=67
bd_OptionJPEG                   *       1 :SHL:   4
 ] 
a136 6
PinboardOption_TidyToCornerHV   *       1 :SHL:   8
PinboardOption_TidyToCornerLR   *       1 :SHL:   9
PinboardOption_TidyToCornerTB   *       1 :SHL:   10

PinboardFlag_TidyWindows        *       1 :SHL:   12
PinboardFlag_UseWindowList      *       1 :SHL:   14
d258 1
a258 1
w_icon_id         #       4       ;       Was Icon identifier (unused), now window handle of icon.
@


4.1.4.3
log
@Fixed bug which can corrupt IconiseTo submenu.
@
text
@d247 5
a251 1
menu_space      *       1024
@


4.1.4.4
log
@Windows, as well as files, can be selected, plus new menu structure and options
@
text
@a81 2
        GBLL    show_backdrop_options   ; does menu show 'Make backdrop', 'Remove backdrop' etc.
show_backdrop_options SETL false
d126 3
a128 1
bd_OptionJPEG                   *       1 :SHL:   4 
d134 2
d143 1
d146 1
d168 1
a168 1
;info_dbox_handle        #       4               ; handle for ingo dbox.
d197 1
d200 1
a201 1
Window_Icons            #       4               ; Number of window icons on pinboard
a207 1
Windows_Selected        #       4               ; No. of iconised windows selected on pinboard
a226 1
drag_window             #       4
d247 1
a247 1
menu_space      *       &500
a256 1

d258 12
a269 12
; Linked iconized window block structure
                  ^       0
w_next_ptr        #       4       ; Pointer to next in chain                (-1 if none)
w_prev_ptr        #       4       ; Pointer to previous entry in chain      (-1 if none)
w_icon_handle     #       4       ; Handle of icon representing window
w_icon_id         #       4       ; Handle of window in which iconised icon is placed.
w_sprite_prefix   #       1       ; "S" for validation string.
w_sprite_name     #       15      ; Sprite name
w_task            #       4       ; Task ID.
w_window_handle   #       4       ; Window handle (of the iconised window).
w_window_pos      #       24      ; Original window position, scroll pos.
w_window_title    #       20      ; Title of the window.
a274 30
; ----------------------------------------------------------------------------------------------------------------------
; Linked icon block structure

                ^       0
ic_next         #       4       ; Pointer to next icon
ic_prev         #       4       ; Pounter to prev icon
ic_icon         #       4       ; Icon handle for this icon.
ic_window       #       4       ; Window handle for this icon.
ic_spritename   #       16      ; Sprite name to use.
ic_id           #       4       ; Monotonic icon ID
ic_action       #       4       ; What to do with this icon (For buffered icons)
ic_filetype     #       4       ; File type of icon's file (For any other icon).
ic_x            #       4       ; X and Y positions in window.
ic_y            #       4       ;
ic_path         #       0       ; Full path for this icon.
ic_block_size   *       @@-ic_next

        ASSERT  ic_next = 0
        ASSERT  (ic_y-ic_x) = 4

; RML: Pinboard's icon and window structures really ought to be merged into one structure. As
; a start towards this aim, we make sure that various common paramaters (icon handle, window
; handle etc.) are at the same offset within each structure, via the ASSERTs below. The code
; makes use of this assumption to simplify.

        ASSERT  w_next_ptr      = ic_next
        ASSERT  w_prev_ptr      = ic_prev
        ASSERT  w_icon_handle   = ic_icon
        ASSERT  w_icon_id       = ic_window
        ASSERT  w_sprite_prefix = ic_spritename
@


4.1.4.5
log
@Fixed bug which can cause Pinboard to die when dragging icons to other apps
@
text
@d83 1
a83 1
show_backdrop_options SETL true
a143 1
DragType_NoDrag                 *       0
@


4.1.4.6
log
@Pinboard options now set via a *PinboardOptions command.
Backdrop command now includes a -Colour &GGBBRR00 switch to set background
colour.
Save now only saves a Pinboard command, followed by Pin commands. Options
and backdrops are instead set by Configure.
A click on 'Save' (as opposed to opening the saveas box) will save the
pinboard under the current filename.
@
text
@d67 1
a67 1
defaultbackdrop SETL    true           ; use default backdrop for portable?
d83 1
a83 1
show_backdrop_options SETL false
a121 5

space   *       " "
delete  *       127


a232 1
background_colour       #       4               ; Colour of background
a243 1
temp_buffer     #       &40     ; Temporary buffer for various bits
@


4.1.4.7
log
@Removed Info option on TinyDirs menu.
Updated interactive help messages.
Shift+Click on close icon now ALWAYS iconises the window underneath the icon
(old behaviour), while a click on iconise button iconises according to the
IconiseTo corner.
@
text
@a148 2
IconizeAtFlag_ShiftCloseIcon    *       1 :SHL:   0

a200 1
IconizeAtFlags          #       4               ; flags word sent by message IconizeAt
@


4.1.4.8
log
@Bug fixes.
Turned off defaultbackdrop and UseECFforLCD. Only needed on A4.
Updated service call handling to use new Ursula tables.
@
text
@d67 1
a67 1
defaultbackdrop SETL    false           ; use default backdrop for portable?
d70 1
a70 3
useECFforLCD    SETL    false            ; use ECF to do LCD background
                                         ; Service calls are hammered if set to TRUE because an
                                         ; OS_ReadSysInfo of monitor type is done EVERY redraw.
@


4.1.4.9
log
@Fixed a couple of bugs.
Improved tidying code.
Filenames are now truncated.
@
text
@a52 2
        GET     Hdr:Font
        GET     Hdr:SprExtend
a86 3
        GBLL    truncate_filenames
truncate_filenames SETL true

a149 1
PinboardFlag_PinboardFull       *       1 :SHL:   15
a227 2
ellipsis_width          #       4               ; width of an ellipsis (Œ) in the desktop font

a299 1
ic_icontext     #       4       ; pointer to the text to display for the icon.
@


4.1.4.10
log
@Wimp_DragBox for selections of icons now clipped to pinboard window.
@
text
@a91 4
        GBLL    ursulawimp
ursulawimp      SETL true


@


4.1.4.11
log
@Bug fix: sometimes thought there was a selection when no icons were selected.
@
text
@d89 1
a89 4
        GBLL    debug_commands          ; provide *commands for debugging
debug_commands  SETL true

        GBLL    truncate_filenames      ; truncate filenames and add ellipsis
d92 1
a92 1
        GBLL    ursulawimp              ; using an Ursula WIMP?
a121 18


    [ ursulawimp
      ! 0, ""
      ! 0, "WARNING - this version only suitable for use with Ursula WIMP or later"
      ! 0, ""
    |
      ! 0, ""
      ! 0, "WARNING - Why aren't you using the ursula WIMP?"
      ! 0, ""
    ]

    [ debug_commands :LOR: debug
      ! 0, ""
      ! 0, "WARNING - debugging options still switched on."
      ! 0, ""
    ]

@


4.1.4.12
log
@Backdrop images that have a mask now have the chosen background colour
showing through (rather than just grey as before).
Added noiconbar compile-time flag (for DiTV demo).
@
text
@a97 2
        GBLL    noiconbar               ; If there's no icon bar, then stretch pinboard to bottom of screen.
noiconbar       SETL false
@


4.1.4.13
log
@* If Ursula window manager not present, always iconises to close icon.
* Sorted problem with spacing of icons dragged from long filename dir viewers.
* If the co-ordinates for Message_IconizeAt put an icon off screen, it is
  pushed back on screen by Pinboard.
@
text
@d96 1
a96 1
ursulawimp      SETL false
a283 2

Default_IconizeAtFlags  * 1
@


4.1.4.14
log
@Forgot to set ursulawimp flag on last check in.
@
text
@d96 1
a96 1
ursulawimp      SETL true
@


4.1.4.15
log
@When the only window icons are on the iconbar, grey out the 'Select all'
menu item.
File 'Status' added giving Pinboard status after RPC2 cancellation.
@
text
@a239 1
Iconbar_Icons           #       4               ; Number of iconised window icons on the icon bar
@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@@


4.1.5.1
log
@Import from SrcFiler
@
text
@@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
