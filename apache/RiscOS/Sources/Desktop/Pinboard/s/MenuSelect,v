head	4.11;
access;
symbols
	Pinboard-1_04:4.11
	Pinboard-1_03:4.11
	Pinboard-1_02:4.11
	Pinboard-1_01:4.11
	Pinboard-1_00:4.11
	Pinboard-0_99:4.11
	Pinboard-0_98:4.10
	Pinboard-0_97:4.9
	Pinboard-0_96:4.9
	Pinboard-0_95:4.9
	Pinboard-0_94:4.9
	Pinboard-0_93:4.9
	Pinboard-0_92:4.7
	Pinboard-0_91:4.6
	Pinboard-0_90:4.6
	Pinboard-0_89:4.6
	Pinboard-0_88:4.6
	Pinboard-0_87:4.6
	Pinboard-0_86:4.5
	Pinboard-0_85:4.5
	Pinboard-0_84:4.4
	Pinboard-0_83:4.4
	Pinboard-0_82:4.4
	RO_5_07:4.4
	Pinboard-0_81:4.4
	Pinboard-0_80:4.4
	Pinboard-0_79:4.4
	Pinboard-0_78:4.4
	Pinboard-0_77:4.3
	Pinboard-0_76:4.3
	Ursula_merge:4.1.4.9
	Pinboard-0_75:4.2
	mstphens_UrsulaRiscPCBuild_20Nov98:4.1.4.9
	Ursula_RiscPC:4.1.4.9.0.2
	rleggett_Pinboard-0_75d:4.1.4.9
	rthornb_UrsulaBuild-19Aug1998:4.1.4.9
	UrsulaBuild_FinalSoftload:4.1.4.9
	rthornb_UrsulaBuild-12Aug1998:4.1.4.9
	aglover_UrsulaBuild-05Aug1998:4.1.4.9
	rthornb_UrsulaBuild-29Jul1998:4.1.4.9
	rthornb_UrsulaBuild-22Jul1998:4.1.4.9
	rleggett_Pinboard-0_75c:4.1.4.9
	rleggett_Pinboard-0_75b:4.1.4.9
	rleggett_Pinboard-0_75:4.1.4.9
	rthornb_UrsulaBuild-15Jul1998:4.1.4.9
	rthornb_UrsulaBuild-07Jul1998:4.1.4.9
	rthornb_UrsulaBuild-17Jun1998:4.1.4.9
	rthornb_UrsulaBuild-03Jun1998:4.1.4.8
	rthornb_UrsulaBuild-27May1998:4.1.4.8
	rthornb_UrsulaBuild-21May1998:4.1.4.8
	rleggett_Pinboard-0_74:4.1.4.8
	rthornb_UrsulaBuild_01May1998:4.1.4.8
	Spinner_B20_2:4.1.7.1
	Spinner_19_3:4.1.7.1
	Spinner_B18:4.1.7.1
	Spinner_B17:4.1.7.1
	Spinner_B15:4.1.7.1
	Spinner_B14:4.1.7.1
	Spinner_B13:4.1.7.1
	Spinner_B12:4.1.7.1
	Spinner_B10:4.1.7.1
	Daytona:4.1.0.6
	Daytona_bp:4.1
	Ursula:4.1.0.4
	Ursula_bp:4.1
	Spinner_B7:4.1.7.1
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	ARTtmp:4.1.7.1.0.2
	Spin_merge:4.1.7.1
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.11
date	2015.09.29.17.21.11;	author rsprowson;	state Exp;
branches;
next	4.10;
commitid	3lSYPb0RZWJLJaDy;

4.10
date	2015.01.16.00.19.39;	author jlee;	state Exp;
branches;
next	4.9;
commitid	e8KqBkhpmH3yjb6y;

4.9
date	2011.09.24.07.31.20;	author rsprowson;	state Exp;
branches;
next	4.8;
commitid	nRjnbtmOSxK1BIAv;

4.8
date	2011.09.24.07.23.44;	author rsprowson;	state Exp;
branches;
next	4.7;
commitid	U6nT8u4TlrjayIAv;

4.7
date	2011.09.19.07.41.57;	author rsprowson;	state Exp;
branches;
next	4.6;
commitid	90jvproiNPICO4Av;

4.6
date	2007.11.05.17.25.53;	author srevill;	state Exp;
branches;
next	4.5;

4.5
date	2007.09.19.01.58.44;	author srevill;	state Exp;
branches;
next	4.4;

4.4
date	2002.11.11.12.34.51;	author rsprowson;	state Exp;
branches;
next	4.3;

4.3
date	2001.03.16.17.07.03;	author sbrodie;	state Exp;
branches;
next	4.2;

4.2
date	99.08.17.19.05.20;	author sbrodie;	state Exp;
branches;
next	4.1;

4.1
date	96.11.05.09.30.01;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.4.1
	4.1.5.1
	4.1.7.1;
next	;

4.1.1.1
date	96.11.05.09.30.01;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.05.23.29.52;	author nturton;	state Exp;
branches;
next	;

4.1.4.1
date	97.06.13.08.40.29;	author rleggett;	state Exp;
branches;
next	4.1.4.2;

4.1.4.2
date	97.08.04.11.50.16;	author rleggett;	state Exp;
branches;
next	4.1.4.3;

4.1.4.3
date	97.10.21.09.57.00;	author rleggett;	state Exp;
branches;
next	4.1.4.4;

4.1.4.4
date	97.10.22.09.33.25;	author rleggett;	state Exp;
branches;
next	4.1.4.5;

4.1.4.5
date	97.12.05.09.40.01;	author rleggett;	state Exp;
branches;
next	4.1.4.6;

4.1.4.6
date	98.01.07.10.28.38;	author rleggett;	state Exp;
branches;
next	4.1.4.7;

4.1.4.7
date	98.03.27.09.36.31;	author rleggett;	state Exp;
branches;
next	4.1.4.8;

4.1.4.8
date	98.04.15.11.24.45;	author rleggett;	state Exp;
branches;
next	4.1.4.9;

4.1.4.9
date	98.06.17.09.43.25;	author rleggett;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.12.20.58;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.20.18.51;	author nturton;	state Exp;
branches;
next	;


desc
@@


4.11
log
@Explicitly test shift when Filer_Run-ning something on the Pinboard
Filer-2_40 and later require explicit opt in, otherwise it's just a normal Filer_Run.

Version 0.99. Tagged as 'Pinboard-0_99'
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
; s.MenuSelect
;
; Handle menu selections

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; menu_selection
;
; In: r1 -> 256 byte block returned by Wimp_Poll, of which...
;                r1+0 item in main menu which was selected
;                r1+4 item in first submenu which was selected
;                r1+8 item in second submenu which was selected
;                etc.
;
; Out: registers may be corrupted - returning to wimp poll.

menu_selection ROUT

        Push    "LR"

        Debug   pi,"Menu selection"

        ADR     r1,PointerInfo
        SWI     XWimp_GetPointerInfo
        Pull    "PC",VS
        ADR     r1,dataarea

        LDR     r14,CurrentMenu
        TEQ     r14,#Menu_Pinboard
        BEQ     pinboard_menu_selection
        TEQ     r14,#Menu_TinyDirs
        BEQ     tinydirs_menu_selection
        TEQ     r14,#Menu_TinyDirsIcon
        BEQ     tinydirs_icon_menu_selection

        Pull    "PC"

reopen_tinydirs_icon_menu

        Debug   pi,"Reopen tinydirs icon menu"

        LDR     r14,PointerInfo+8
        Debug   pi,"buttons ",r14
        TST     r14,#1
        BNE     TinyDirsIcon_Menu
        Pull    "PC"

tinydirs_icon_menu_selection ROUT

        ADR     r2,reopen_tinydirs_icon_menu
        Push    "r2"

        LDR     r14,[r1]
        ADD     PC,PC,R14,ASL #2
        Pull    "PC"
        B       QuitTinyDirs

QuitTinyDirs
        LDR     r0,Pinboard_options
        BIC     r0,r0,#PinboardOption_TinyDirs
        STR     r0,Pinboard_options

        LDR     r0,TinyDirs_Handle
        CMP     r0,#0
        Pull    "PC",LT

        ADR     r1,dataarea
        STR     r0,[r1,#4]
        MOV     r0,#-2
        STR     r0,[r1]
        SWI     XWimp_DeleteIcon

        MOV     r0,#-1
        STR     r0,TinyDirs_Handle
        Pull    "lr"
        Pull    "PC"

reopen_tinydirs_menu

        Debug   pi,"Reopen tinydirs menu"

        LDR     r14,PointerInfo+8
        Debug   pi,"buttons ",r14
        TST     r14,#1
        BNE     recreate_iconbar_menu
        Pull    "PC"

tinydirs_menu_selection ROUT

        ADR     r2,reopen_tinydirs_menu
        Push    "r2"

        LDR     r14,[r1]
        ADD     PC,PC,R14,ASL #2
        Pull    "PC"

        B       SelectAllIconbar        ; 1
        B       ClearIconbarSelection   ; 2
        B       RemoveIconbarSelection  ; 3
        B       OpenParent              ; 4

SelectAllIconbar ROUT
        Debug   pi,"SelectAllIconbar"

        MOV     r0,#-2
        BL      SelectFileIcons
        Pull    "PC"

ClearIconbarSelection

        Debug   pi,"CleariconbarSelection"
        MOV     r0,#-2
        BL      DeselectFileIcons
        Pull    "PC"

RemoveIconbarSelection
        Debug   pi,"Remove Iconbar"

        MOV     r0,#-2
        BL      RemoveIcons

        Pull    "PC"

OpenParent      ROUT

        LDR     r5,[r1,#4]

        MOV     r0,#-2
        ADR     r1,dataarea
        MOV     r2,#is_selected
        MOV     r3,#is_selected
        SWI     XWimp_WhichIcon
        Pull    "PC",VS

01
        LDR     r2,[r1],#4
        MOV     r1,#-2
        BL      FindIcon
        BNE     %BT01

        ADR     r1,dataarea
        ADR     r0,OpenParent_command
        BL      Copy_r0r1

        ADD     r0,r2,#ic_path
        BL      Copy_r0r1

        MOV     r2,#-1
        ADR     r0,dataarea
02
        LDRB    r14,[r0],#1
        CMP     r14,#"."
        SUBEQ   r2,r0,#1
        CMP     r14,#32
        BGE     %BT02

        MOV     r0,#0
        CMP     r2,#-1
        STRNEB  r0,[r2]

        ADR     r0,dataarea
        DebugS  td,"Command is ",r0
        SWI     XOS_CLI

        Pull    "PC"

OpenParent_command      DCB     "Filer_OpenDir ",0
                        ALIGN


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; reopen_pinboard_menu
;
; Called after dealing with a menu selection, to reopen the menu if a
; right mouse click was used on the selection.

reopen_pinboard_menu

        Debug   pi,"Reopen pinboard menu"

        LDR     r14,PointerInfo+8
        Debug   pi,"buttons ",r14
        TST     r14,#1
        BNE     recreate_pinboard_menu
        Pull    "PC"


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; pinboard_menu_selection
;
; Deal with selections from the pinboard menu
;
; In: r1 -> Wimp_Poll block, specifically R1+0 contains the number of the
;           item in the main pinboard menu which was selected.

pinboard_menu_selection

        ADR     r2,reopen_pinboard_menu ; Make sure this function is called when we've dealt with
        Push    "r2"                    ; selection, so that menu is reopened if Right button was used

        LDR     r14,[r1]
        ADD     PC,PC,R14,ASL #2
        Pull    "PC"

        B       selection_menu_selection ; 0
        B       selectall_menu_selection ; 1
        B       ClearSelection           ; 2
        B       OpenConfigure            ; 3
        B       Save                     ; 4
        [ show_backdrop_options
        B       MakeBackdrop             ; 5
        B       RemoveBackdrop           ; 6
        ]


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; selectall_menu_selection
;
; Deal with a selection from the Select all submenu.
;
; In: r1 -> Wimp_Poll bloc, specifically, R1 + 4 contains the number of
;           the item selected from the Select all submenu.

selectall_menu_selection

        LDR     r14, [r1, #4]
        ADD     pc, pc, r14, ASL #2
        B       SelectAll                ; -1 - Just a click on SelectAll without moving to the menu

        B       SelectAllFiles           ; 0 - Select files
        B       SelectAllWindows         ; 1 - Select windows
        B       SelectAll                ; 2


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; selection_menu_selection
;
; Deal with a selection from the Selection submenu.
;
; In: r1 -> Wimp_Poll bloc, specifically, R1 + 4 contains the number of
;           the item selected from the Selection submenu.

selection_menu_selection

        LDR     r14, [r1, #4]
        ADD     pc, pc, r14, ASL #2
        Pull    "pc"

        B      Tidy                     ; 0
        B      OpenSelection            ; 1 - Open
        B      Remove                   ; 2
        B      HelpFromApp              ; 3


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; OpenConfigure
;
; The 'Configure...' option was selected.
; Open the configure plugin for the Pinboard, if present.

OpenConfigure

        ADR     R0,OpenCfgCmd                   ; (FG) -> command to run Pinboard plugin
        SWI     XWimp_StartTask                 ; (FG) start command as a task
        Pull    "PC"                            ; (FG) say bye bye

OpenCfgPath     DCB "BootResources$$Path",0
OpenCfgCmd      DCB "IfThere BootResources:Configure.!PinSetup Then Filer_Run BootResources:Configure.!PinSetup",0
                ALIGN


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; Tidy
;
; The 'Tidy' option was selected.

Tidy
        Debug   pi,"Tidy"

        LDR     r0, Pinboard_options
        ORR     r0, r0, #PinboardFlag_UseWindowList
        STR     r0, Pinboard_options
        BL      tidy_icons

        LDR     r0, Pinboard_options
        BIC     r0, r0, #PinboardFlag_UseWindowList
        STR     r0, Pinboard_options
        BL      tidy_icons

        ;MOV     r0,r5
        LDR     r0,backdrop_handle
        MOV     r1,#-1
        MOV     r2,#-1
        MOV     r3,#&80000
        MOV     r4,#&80000
        SWI     XWimp_ForceRedraw

        Pull    "PC"


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Remove
        Debug   pi,"Remove"

        LDR     r0,backdrop_handle
        BL      RemoveIcons

        Pull    "PC"

SelectAll

        Debug   pi,"SelectAll"

        LDR     r0,backdrop_handle
        BL      SelectAllIcons
        Pull    "PC"

SelectAllFiles

        LDR     r0, backdrop_handle
        BL      DeselectAllIcons
        LDR     r0, backdrop_handle
        BL      SelectFileIcons
        Pull    "PC"

SelectAllWindows

        LDR     r0, backdrop_handle
        BL      DeselectAllIcons
        LDR     r0, backdrop_handle
        BL      SelectWindowIcons
        Pull    "PC"

ClearSelection

        Debug   pi,"ClearSelection"
        LDR     r0,backdrop_handle
        BL      DeselectAllIcons
        Pull    "PC"

MakeBackdrop

        Debug   pi,"MakeBackdrop"

        LDR     r5,[r1,#4]

        LDR     r0,backdrop_handle
        ADR     r1,dataarea
        MOV     r2,#is_selected
        MOV     r3,#is_selected
        SWI     XWimp_WhichIcon
        Pull    "PC",VS

        LDR     r2,[r1]
        LDR     r1,backdrop_handle
        BL      FindIcon
        Pull    "PC",NE

        ADR     r1,dataarea
        ADR     r0,backdrop_command
        BL      Copy_r0r1

        ADD     r0,r2,#ic_path
        BL      Copy_r0r1

        ADR     r0,dataarea
        MOV     r1,#"s"
        TEQ     r5,#1
        MOVEQ   r1,#"c"
        TEQ     r5,#2
        MOVEQ   r1,#"t"
        STRB    r1,[r0,#10]
        DebugS  pi,"Command is ",r0
        SWI     XOS_CLI
        BVC     %FT01

        Push    "r0"                    ; Preserve error
        LDR     r0,backdrop_handle
        MOV     r1,#0
        MOV     r2,#0
        MOV     r3,#&80000
        MOV     r4,#&80000
        SWI     XWimp_ForceRedraw
        Pull    "r0"
        SETV

01
        Pull    "PC"

RemoveBackdrop
        BL      ClearBackdrop
        Pull    "PC"

Save
        BL      IntSave_KeyPressed
        Debug   pi,"Save"
        Pull    "PC"


backdrop_command        DCB     "Backdrop -? ",0
        ALIGN


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; OpenSelection
;
; Called when user clicks on Selection->Open to open all selected windows/files

OpenSelection

        BL      OpenWindows
        BL      OpenFiles
        BL      ClearSelection
        Pull    "pc"


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; OpenWindows
;
; Open all selected iconised windows on the backdrop

OpenWindows Entry

01
        ADR     r1, dataarea
        LDR     r7, iconized_ptr
02
        CMP     r7, #0                   ; Have we reached end of list?
        EXIT    EQ
        LDR     r0, [r7, #ic_window]     ; Get handle of window which this icon is in
        LDR     r2, backdrop_handle
        CMP     r0, r2                   ; Check it's the backdrop
        BNE     %FT05

        STR     r0, [r1]
        LDR     r0, [r7, #ic_icon]
        STR     r0, [r1, #4]
        SWI     XWimp_GetIconState       ; Get state of the icon
        EXIT    VS

        LDR     r0, [r1, #24]
        TST     r0, #is_selected         ; Check it's selected
        BEQ     %FT05
        BL      reopen_window            ; If it is, reopen the window. Go back and start again from
        ;LDR     r0, Window_Icons
        ;SUB     r0, r0, #1               ; Update number of window icons
        ;STR     r0, Window_Icons
        ;LDR     r0, Windows_Selected
        ;SUB     r0, r0, #1
        ;STR     r0, Windows_Selected

        B       %BT01                    ; first icon (because list has changed).

05
        LDR     r7, [r7, #ic_next]       ; Get next icon
        B       %BT02


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; OpenFiles
;
; Open all selected files on the backdrop

OpenFiles Entry

        LDR     r7, Icon_list

02
        CMP     r7, #0                   ; is this the last icon?
        EXIT    EQ
        LDR     r0, [r7, #ic_window]
        LDR     r2, backdrop_handle
        CMP     r0, r2                   ; check icon is on backdrop
        BNE     %FT05

        ADR     r1, dataarea
        STR     r0, [r1]
        LDR     r0, [r7, #ic_icon]
        STR     r0, [r1, #4]
        SWI     XWimp_GetIconState       ; get icon's state
        EXIT    VS

        LDR     r0, [r1, #24]
        TST     r0, #is_selected         ; check if icon is selected
        BEQ     %FT05

        ; Filer_Run the file
        ADR     r1, dataarea
        ADR     r0, FilerRunCom          ; Filer_Run
        BL      Copy_r0r1
        ADD     r0, r7, #ic_path         ; filename
        BL      Copy_r0r1
        ADR     r0, dataarea
        SWI     XOS_CLI
        EXIT    VS

05
        LDR     r7, [r7, #ic_next]
        B       %BT02

FilerRunCom        DCB     "Filer_Run -Shift ",0
                   ALIGN

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; HelpFromApp
;
; Where the icon is an !app,get help on it by seeing if anyone will open its !Help

HelpFromApp
        ROUT
        LDR     r7, Icon_list
        ADR     r1, dataarea
        LDR     r2, backdrop_handle
        STR     r2, [r1, #0]
05
        CMP     r7, #0                   ; is this the last icon?
        Pull    "PC",EQ
        LDR     r0, [r7, #ic_window]
        CMP     r0, r2
        BNE     %FT08                    ; not on the backdrop
        LDR     r0, [r7, #ic_icon]
        STR     r0, [r1, #4]
        SWI     XWimp_GetIconState
        LDR     r0, [r1, #8+16]
        TST     r0, #is_selected         ; see if we've got the one selected icon
        BEQ     %FT08

        ; Filer_Run the file
        ADR     r1, dataarea
        ADR     r0, FilerRunCom          ; Filer_Run
        BL      Copy_r0r1
        ADD     r0, r7, #ic_path         ; filename
        BL      Copy_r0r1
        ADR     r0, plinghelp            ; append help filename
        BL      Copy_r0r1
        ADR     r0, dataarea
        SWI     XOS_CLI
        CLRV                             ; if someone managed to delete the file in the time it took
                                         ; to open the menu,then we'll not worry about it
        B       ClearSelection
08
        LDR     r7, [r7, #ic_next]
        B       %BT05

plinghelp       DCB     ".!Help",0
                ALIGN

        LNK     Tidy.s
@


4.10
log
@Escape some dollars
Detail:
  s/MenuSelect, s/ModHead - Escape some dollars contained in strings to avoid warnings from objasm
Admin:
  Resulting binary unchanged


Version 0.98. Retagged as 'Pinboard-0_98'
@
text
@d515 1
a515 1
FilerRunCom        DCB     "Filer_Run ",0
@


4.9
log
@Shade "Configure..." when boot was unsuccessful.
When BootResources$Path is unset the option to run the configure plugin is no longer available.
Shared a "Filer_Run " string in 3x places.
Replaced most occurrences of calling XOS_ReadModeVariable of the current mode's XEig and YEig factors to use the cached copy sitting unloved in the workspace. Should thrash less during redraw.

Version 0.93. Tagged as 'Pinboard-0_93'
@
text
@d280 1
a280 1
OpenCfgPath     DCB "BootResources$Path",0
@


4.8
log
@Collapse dead switches.
Same binary as 0.92, not tagged.
@
text
@d280 1
@


4.7
log
@Restore *AddTinyDir <nothing> functionality.
See ticket #283.
Moved 'Status' document into Docs.
Merged 'Changes' into 'BlackLog' and delete.
Expanded 2x POPs of lr/pc cos ARM deprecated it.
Combined 2x MUL/ADD into MLA so the module is the same size.

Version 0.92. Tagged as 'Pinboard-0_92'
@
text
@d211 1
a211 1
        ADR     r2,reopen_pinboard_menu ; Make sure this function is called when we've delt with
@


4.6
log
@  Prevent icons from overlapping when tidying a selection of icons.
Details:
  Tidying a selection of icons could result in icons being placed at locations
  already occupied by other icons. The reason for this is that tidying iconised
  window icons didn't check at all whether a position was occupied or not, and
  tidying file icons only checked against the list of iconised window icons.
  Essentially the code was designed for tidying all icons on the Pinboard, not
  selections.
Admin:
  Tested on Iyonix RO5.11
Changes by:
  Fred Graute

Version 0.87. Tagged as 'Pinboard-0_87'
@
text
@a68 2

        ;Pull    "PC"
d88 2
a89 1
        Pull    "r14,PC"
@


4.5
log
@  Enable opening of pinboard configure plugin directly from the Pinboard.
Details:
  Replaced the 'Options' menu item with the 'Configure...' menu item
  which opens the Pinboard configure plugin directly from the Pinboard.
  This is achieved by running a *command that checks if the plugin is
  there and filer-runs it if so.

  All the code and help messages relating to the 'Options' menu item
  and its submenus has been removed.
Admin:
  Tested on Iyonix RO5.11
Notes:
  Changes by Fred Graute.

Version 0.85. Tagged as 'Pinboard-0_85'
@
text
@d294 1
a294 1
        ORR     r0, r0, #PinboardFlag_TidyWindows
d299 1
a299 1
        BIC     r0, r0, #PinboardFlag_TidyWindows
@


4.4
log
@Commented out "proginfo" string,no longer used.
Prefixed the pin and addtinydir commands that get saved in the
pinboard file with "X " so your pinboard setup continues even if a file
is no longer available.ROL did this with a new XPin command,not taken.
Merged changes from ROL to allow the icon text to be an arbitary colour
though this can be switched out with "technicolour_text" for the
purists.
Help entry added to the pinboard selection submenu,this will be greyed
out except when
 it's an app
 and it has a !help file
 and it is the only object selected
like the filer does.
Updated messages file accordingly.
Menu clicking on the "save pinboard settings" OK button no longer saves
the file,and adjust clicking keeps the menu tree open
 -> fixes bug report from 1998,now removed from "Status" file
Saveas template resized to match !Edit.
Fixed problem of select dragging a file to an app leaving the icon
selected (due to two conditional MOV R0's being followed by an
unconditional one for some reason).
 -> fixes bug report from 1998,now removed from "Status" file
Tweaked a few CMP#0 BLT's to test specifically for the iconbar handle.
The bug report in "Status" about bits of filenames being left on the
pinboard can be bodged by popping an ADD r0,r0,#16 after the XWimp_TextOp
in s.buffered but I've not done this yet.

Version 0.78. Tagged as 'Pinboard-0_78'
@
text
@d222 1
a222 1
        B       options_menu_selection   ; 3
d268 1
d270 1
a270 3
; option_menu_selection
;
; Deal with a selection from the options submenu.
d272 2
a273 2
; In: r1 -> Wimp_Poll bloc, specifically, R1 + 4 contains the number of
;           the item selected from the options submenu.
d275 1
a275 1
options_menu_selection
d277 3
a279 3
        LDR     r14, [r1, #4]
        ADD     PC, PC, R14, ASL #2
        Pull    "PC"
d281 2
a282 3
        B       IconiseWindowOpt    ; 0
        B       TidyToMenuOpt       ; 1
        B       Grid                ; 2
a314 12
; Grid
;
; The 'Grid lock' option was selected.

Grid
        Debug   pi,"Grid"

        LDR     r14,Pinboard_options
        EOR     r14,r14,#PinboardOption_Grid
        STR     r14,Pinboard_options

        Pull    "PC"
a418 85
; IconiseWindowOpt
;
; Handles a click on the 'Iconise' submenu.
;
; In: r1-> Wimp_Poll block, specifically, R1 + 8 contains the item within
;          the iconise submenu which was selected.

IconiseWindowOpt

        LDR     r0, Pinboard_options
        LDR     r5, [r1, #8]

        CMP     r5, #2
        BLT     %FT10
        CMP     r5, #6
        BLT     %FT20

        ; Clcik on 'Stack horizontally' or 'Stack vertically'
        CMP     r5, #6
        BICEQ   r0, r0, #PinboardOption_WinToCornerHV
        CMP     r5, #7
        ORREQ   r0, r0, #PinboardOption_WinToCornerHV

        B       %FT50

10      ; Click on either 'At close icon' or 'To iconbar'
        BICLT   r0, r0, #PinboardOption_UseWinToCorner
        CMP     r5, #0
        BICEQ   r0, r0, #PinboardOption_IconiseToIconBar
        CMP     r5, #1
        ORREQ   r0, r0, #PinboardOption_IconiseToIconBar
        B       %FT50

20      ; Click on a corner option
        BIC     r0, r0, #PinboardOption_IconiseToIconBar
        SUB     r5, r5, #2
        TST     r5, #1
        ORRNE   r0, r0, #PinboardOption_WinToCornerTB
        BICEQ   r0, r0, #PinboardOption_WinToCornerTB
        TST     r5, #2
        ORRNE   r0, r0, #PinboardOption_WinToCornerLR
        BICEQ   r0, r0, #PinboardOption_WinToCornerLR

        ORR     r0, r0, #PinboardOption_UseWinToCorner

50
        STR     r0, Pinboard_options
        Pull    "PC"


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; TidyToMenuOpt
;
; Handles a click on the 'Tidy to' submenu.
;
; In: r1-> Wimp_Poll block, specifically R1+8 stores the item within the
;          Tidy to submenu which was selected.

TidyToMenuOpt

        LDR     r0, Pinboard_options
        LDR     r5, [r1, #8]
        CMP     r5, #4
        BLT     %FT20
10
        CMP     r5, #4
        BICEQ   r0, r0, #PinboardOption_TidyToCornerHV
        CMP     r5, #5
        ORREQ   r0, r0, #PinboardOption_TidyToCornerHV
        B       %FT30
20
        TST     r5, #1
        ORRNE   r0, r0, #PinboardOption_TidyToCornerTB
        BICEQ   r0, r0, #PinboardOption_TidyToCornerTB
        TST     r5, #2
        ORRNE   r0, r0, #PinboardOption_TidyToCornerLR
        BICEQ   r0, r0, #PinboardOption_TidyToCornerLR
30
        STR     r0, Pinboard_options
        Pull    "PC"




; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
d517 1
a517 1
                   
@


4.3
log
@  Updated build structure to use the shared AAsmModule makefile.
  Updated to build using objasm instead of aasm.
  Sources changed to be objasm-compatible.
Admin:
  Requires Library 0.71 or later.
  Requires BuildSys 3.06 or later.
  Requires Env 0.65 or later.

Version 0.76. Tagged as 'Pinboard-0_76'
@
text
@d266 1
a266 1

d615 45
a661 1

@


4.2
log
@Ursula branch merged.
Added inclusion of Machine header for new CMOS header
Moved to srccommit.
Templates contain hardwired version/date information which is a long
  way out of date.  This has not been fixed in this checkin.

Version 0.75. Tagged as 'Pinboard-0_75'
@
text
@d16 1
a16 1
;                 
d42 1
a42 1
        TEQ     r14,#Menu_Pinboard  
d45 1
a45 1
        BEQ     tinydirs_menu_selection                
d49 1
a49 1
        Pull    "PC"     
d68 3
a70 3
        Pull    "PC"  
        
        ;Pull    "PC"                    
d77 1
a77 1
         
d87 1
a87 1
               
d89 1
a89 1
        STR     r0,TinyDirs_Handle   
d102 1
a102 1
tinydirs_menu_selection ROUT 
d114 1
a114 1
        B       OpenParent              ; 4   
d148 1
a148 1
                          
d161 1
a161 1
                           
d174 1
a174 1
                      
d180 1
a180 1
                       
d243 1
a243 1
        
d262 1
a262 1
        
d281 1
a281 1
        
d292 1
a292 1
Tidy               
d311 1
a311 1
        SWI     XWimp_ForceRedraw                                
d339 1
a339 1
        
d341 1
a341 1
        
d345 1
a345 1
        
d347 1
a347 1
       
d353 1
a353 1
        
d360 1
a360 1
        Pull    "PC"        
d382 1
a382 1
        LDR     r2,[r1]           
d393 1
a393 1
                      
d396 1
a396 1
        TEQ     r5,#1 
d427 1
a427 1
           
d444 1
a444 1
        
d455 1
a455 1
        
d457 1
a457 1
        
d465 1
a465 1
        
d475 1
a475 1
         
d478 1
a478 1
50        
d510 1
a510 1
30        
d535 1
a535 1
OpenWindows ENTRY
d547 1
a547 1
        
d569 1
a569 1
        B       %BT02        
d577 1
a577 1
OpenFiles ENTRY
d580 1
a580 1
        
d588 1
a588 1
      
d595 1
a595 1
        
d609 1
a609 1
        
d616 2
a617 2
        LNK     s.Tidy
        
@


4.1
log
@Initial revision
@
text
@d15 1
a15 1
;s.MenuSelect
d17 12
a28 1
;Handle menu selections
a50 2


d70 1
a70 1
        Pull    "PC"                    ; 1  Info
d101 1
d120 1
a120 1
        BL      SelectIcons
d127 1
a127 1
        BL      DeselectIcons
d183 8
d201 9
d212 2
a213 2
        ADR     r2,reopen_pinboard_menu
        Push    "r2"
d219 56
a274 9
        Pull    "PC"                    ; 0 - Info clicked
        B       Tidy                    ; 1
        B       Grid                    ; 2
        B       Remove                  ; 3
        B       SelectAll               ; 4
        B       ClearSelection          ; 5
        B       MakeBackdrop            ; 6
        B       RemoveBackdrop          ; 7
        B       Save                    ; 8
d276 9
a284 2
Tidy               
        Debug   pi,"Tidy"
a285 13
        ADR     r8,Icon_list-ic_next
        LDR     r5,backdrop_handle
        MOV     r9,#0                   ; Current start x
        MOV     r6,#0                   ; Current x0.
        LDR     r7,Screen_y1            ; Current y1.
01        
        LDR     r8,[r8,#ic_next]
        CMP     r8,#0
        BEQ     %FT02                   ; That's it.
                
        LDR     r14,[r8,#ic_window]
        TEQ     r14,r5
        BNE     %BT01                   ; not on backdrop.
d287 4
a290 21
        ADR     r1,dataarea
        STR     r5,[r1]
        LDR     r14,[r8,#ic_icon]
        STR     r14,[r1,#4]
        SWI     XWimp_GetIconState
        [ :LNOT: UseResize
        SWIVC   XWimp_DeleteIcon
        Pull    "PC",VS         
        ]
                             
        ADD     r1,r1,#4
        STR     r5,[r1] 
        LDR     r3,[r1,#12]             ; old x1
        LDR     r14,[r1,#4]             ; old x0
        SUB     r3,r3,r14               ; Width
        LDR     r4,[r1,#16]             ; old y1
        LDR     r14,[r1,#8]             ; old y0
        SUB     r4,r4,r14               ; Height
                          
        STR     r6,[r8,#ic_x]
        STR     r7,[r8,#ic_y]
d292 2
a293 25
        RSBS    r2,r3,#grid_x_spacing
        ADDPL   r2,r6,r2,LSR #1
        MOVMI   r2,r6
        STR     r2,[r1,#4]              ; x0  (Centred in grid)
        ADD     r2,r2,r3
        STR     r2,[r1,#12]             ; x1

        RSBS    r2,r4,#grid_y_spacing
        SUBPL   r2,r7,r2,LSR #1
        MOVMI   r2,r7
        STR     r2,[r1,#16]             ; y1 (Centred in grid)
        SUB     r2,r2,r4
        STR     r2,[r1,#8]              ; y0

        [ UseResize
        Push    "R0-R5"
        LDMIA   R1,{R0,R2-R5}
        LDR     R1,[R8,#ic_icon]
        SWI     Wimp_ResizeIcon
        Pull    "R0-R5"
        |
        SWI     XWimp_CreateIcon
        Pull    "PC",VS
        STR     r0,[r8,#ic_icon]
        ]
d295 9
a303 12
        ADD     r6,r6,#grid_x_spacing
        LDR     r14,Screen_x1
        ADD     r2,r6,#grid_x_spacing
        CMP     r2,r14
        MOVGT   r6,r9
        SUBGT   r7,r7,#grid_y_spacing
        LDR     r14,icon_bar_height  
        CMP     r7,r14
        LDRLE   r7,Screen_y1
        ADDLE   r9,r9,#30
        MOVLE   r6,r9
        B       %BT01
d305 2
a306 2
02
        MOV     r0,r5
d315 6
d329 1
d341 1
a341 1

d343 1
a343 1
        BL      SelectIcons
d345 16
d366 1
a366 1
        BL      DeselectIcons
d423 1
a430 1
        LNK     s.Tail
d432 186
@


4.1.4.1
log
@Added option to iconise windows to a corner
@
text
@a194 3
      [ Version >= 67
        B       IconiseWindowOpt
      ]
a297 44

 [ Version >= 67
IconiseWindowOpt
        LDR     r0, Pinboard_options
        LDR     r5, [r1, #4]
        
        CMP     r5, #2
        BLT     %FT10
        CMP     r5, #6
        BLT     %FT20

        ; Clcik on 'Stack horizontally' or 'Stack vertically'
        CMP     r5, #6
        BICEQ   r0, r0, #PinboardOption_WinToCornerHV
        CMP     r5, #7
        ORREQ   r0, r0, #PinboardOption_WinToCornerHV
        
        B       %FT50
        
10      ; Click on either 'At close icon' or 'To iconbar'
        BICLT   r0, r0, #PinboardOption_UseWinToCorner
        CMP     r5, #0
        BICEQ   r0, r0, #PinboardOption_IconiseToIconBar
        CMP     r5, #1
        ORREQ   r0, r0, #PinboardOption_IconiseToIconBar
        B       %FT50
        
20      ; Click on a corner option
        BIC     r0, r0, #PinboardOption_IconiseToIconBar
        SUB     r5, r5, #2
        TST     r5, #1
        ORRNE   r0, r0, #PinboardOption_WinToCornerTB
        BICEQ   r0, r0, #PinboardOption_WinToCornerTB
        TST     r5, #2
        ORRNE   r0, r0, #PinboardOption_WinToCornerLR
        BICEQ   r0, r0, #PinboardOption_WinToCornerLR
         
        ORR     r0, r0, #PinboardOption_UseWinToCorner

50        
        STR     r0, Pinboard_options
        Pull    "PC"
 ]

@


4.1.4.2
log
@Improved consistency of files/windows, plus JPEG backdrops
@
text
@d40 2
d195 3
a203 4
      [ Version >= 67
        B       IconiseWindowOpt        ; 9
        B       TidyToMenuOpt           ; 10
      ]
a207 13
   [ Version >= 67
        LDR     r0, Pinboard_options
        ORR     r0, r0, #PinboardFlag_TidyWindows
        STR     r0, Pinboard_options
        BL      tidy_icons

        LDR     r0, Pinboard_options
        BIC     r0, r0, #PinboardFlag_TidyWindows
        STR     r0, Pinboard_options
        BL      tidy_icons
           
   |

d284 1
a284 4
   ]

        ;MOV     r0,r5
        LDR     r0,backdrop_handle
d302 43
a427 417



 [ Version >= 67
; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; IconiseWindowOpt
;
; Handles a click on the 'Iconise' submenu.

IconiseWindowOpt

        LDR     r0, Pinboard_options
        LDR     r5, [r1, #4]
        
        CMP     r5, #2
        BLT     %FT10
        CMP     r5, #6
        BLT     %FT20

        ; Clcik on 'Stack horizontally' or 'Stack vertically'
        CMP     r5, #6
        BICEQ   r0, r0, #PinboardOption_WinToCornerHV
        CMP     r5, #7
        ORREQ   r0, r0, #PinboardOption_WinToCornerHV
        
        B       %FT50
        
10      ; Click on either 'At close icon' or 'To iconbar'
        BICLT   r0, r0, #PinboardOption_UseWinToCorner
        CMP     r5, #0
        BICEQ   r0, r0, #PinboardOption_IconiseToIconBar
        CMP     r5, #1
        ORREQ   r0, r0, #PinboardOption_IconiseToIconBar
        B       %FT50
        
20      ; Click on a corner option
        BIC     r0, r0, #PinboardOption_IconiseToIconBar
        SUB     r5, r5, #2
        TST     r5, #1
        ORRNE   r0, r0, #PinboardOption_WinToCornerTB
        BICEQ   r0, r0, #PinboardOption_WinToCornerTB
        TST     r5, #2
        ORRNE   r0, r0, #PinboardOption_WinToCornerLR
        BICEQ   r0, r0, #PinboardOption_WinToCornerLR
         
        ORR     r0, r0, #PinboardOption_UseWinToCorner

50        
        STR     r0, Pinboard_options
        Pull    "PC"


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; TidyToMenuOpt
;
; Handles a click on the 'Tidy to' submenu.

TidyToMenuOpt

        LDR     r0, Pinboard_options
        LDR     r5, [r1, #4]
        CMP     r5, #4
        BLT     %FT20
10
        CMP     r5, #4
        BICEQ   r0, r0, #PinboardOption_TidyToCornerHV
        CMP     r5, #5
        ORREQ   r0, r0, #PinboardOption_TidyToCornerHV
        B       %FT30
20
        TST     r5, #1
        ORRNE   r0, r0, #PinboardOption_TidyToCornerTB
        BICEQ   r0, r0, #PinboardOption_TidyToCornerTB
        TST     r5, #2
        ORRNE   r0, r0, #PinboardOption_TidyToCornerLR
        BICEQ   r0, r0, #PinboardOption_TidyToCornerLR
30        
        STR     r0, Pinboard_options
        Pull    "PC"


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; tidy_icons
;
; Tidies either the file icons or the window icons. Which is done depends
; on the value PinboardFlag_TidyWindows (set tidy window icons, clear
; tidy files).
;
; In:  Nothing.
;
; Out: All regs preserved.

tidy_icons ENTRY

        Push    "r0-r11"                            ; Preserve registers

        LDR     r8, Pinboard_options                ; Pinboard options
        TST     r8, #PinboardFlag_TidyWindows
        BICNE   r8, r8, #PinboardFlag_UseWindowList ; Set UseWindowList flag for later (oposite
        ORREQ   r8, r8, #PinboardFlag_UseWindowList ; of TidyWindows flag)
        STR     r8, Pinboard_options
        
        ADR     r0, bounding_box                    ; Screen bouding box
        SUB     sp, sp, #48                         ; Increase stack (we'll use it for getting icon data)
        MOV     r9, sp                              ; r9 is now data pointer

08 ; Decide on initial Left/Right positioning
        LDR     r1, [r0, #8]
        TST     r8, #PinboardFlag_TidyWindows       ; 1 = Tidy windows (NE), 0 = Tidy file icons (EQ)
        BEQ     %FT10

        ; Windows
        TST     r8, #PinboardOption_WinToCornerLR
        MOVEQ   r2, #0
        SUBNE   r2, r1, #grid_x_spacing
        B       %FT20

10      ; Files
        TST   r8, #PinboardOption_TidyToCornerLR
        MOVEQ   r2, #0
        SUBNE   r2, r1, #grid_x_spacing 

20 ; Decide on initial Up/Down positioning
        LDR     r1, [r0, #12] 
        TST     r8, #PinboardFlag_TidyWindows       ; 1 = Tidy windows (NE), 0 = Tidy file icons (EQ)
        BEQ     %FT30

        ; Windows
        TST     r8, #PinboardOption_WinToCornerTB
        SUBEQ   r3, r1, #grid_y_spacing
        LDRNE   r3, icon_bar_height
        B       %FT40

30      ; Files             
        TST     r8, #PinboardOption_TidyToCornerTB
        SUBEQ   r3, r1, #grid_y_spacing
        LDRNE   r3, icon_bar_height        

40 ; Check initial position

        TST     r8, #PinboardFlag_TidyWindows
        BNE     %F44
        MOV     r4, r3
        MOV     r3, r2
        BL      tidy_find_next_free
        MOV     r2, r3
        MOV     r3, r4

44 ; Where's the icon data?
        TST     r8, #PinboardFlag_TidyWindows
        LDRNE   r11, iconized_ptr                   ; First window icon in list
        LDREQ   r11, Icon_list                      ; First file icon in list

; At this point:  r2, r3 - x & y
;                 r9     - 48 byte data pointer
;                 r8     - Options
;                 r11    - icon data
        
50 ; Get next
        CMP     r11, #0                             ; end of list?
        BEQ     %FT80
        
        LDR     r0, backdrop_handle                 ; What's the backdrop handle
        TST     r8, #PinboardFlag_TidyWindows       ; 1 = Tidy windows (NE), 0 = Tidy file icons (EQ)
        LDRNE   r1, [r11, #w_icon_id]               ; (if tidying window icons)
        LDREQ   r1, [r11, #ic_window]               ; (if tidying file icons)
        CMP     r0, r1                              ; Is the icon on the backdrop?
        BNE     %FT70                               ; Not on backdrop, jump ahead
        
        MOV     r1, r9                              ; Find icon handle of next icon
        STR     r0, [r1]                            
        TST     r8, #PinboardFlag_TidyWindows       ; 1 = Tidy windows (NE), 0 = Tidy file icons (EQ)
        LDRNE   r0, [r11, #w_icon_handle]           ; (if tidying window icons)
        LDREQ   r0, [r11, #ic_icon]                 ; (if tidying file icons)
        STR     r0, [r1, #4]                        
        SWI     Wimp_GetIconState                   

        LDR     r4, [r1, #8]                        ; How wide is the icon?
        LDR     r5, [r1, #16]
        SUB     r6, r5, r4

        LDR     r4, [r1, #12]                       ; How tall is the icon?
        LDR     r5, [r1, #20]
        SUB     r7, r5, r4

        Push    "r2"
        TST     r8, #PinboardFlag_TidyWindows
        BNE     %FT60

        STR     r2, [r11, #ic_x]                    ; store x and y
        ADD     r0, r3, #grid_y_spacing
        STR     r0, [r11, #ic_y]
60
        MOV     r0, #grid_x_spacing                 ; Adjust for centre alignment
        SUBS    r1, r0, r6
        ADDS    r2, r2, r1, LSR #1

        ADD     r4, r2, r6                          ; x2
        ADD     r5, r3, r7                          ; y2

        TST     r8, #PinboardFlag_TidyWindows
        STREQ   r5, [r11, #ic_y]
 
        LDR     r0, backdrop_handle
        TST     r8, #PinboardFlag_TidyWindows       ; 1 = Tidy windows (NE), 0 = Tidy file icons (EQ)
        LDRNE   r1, [r11, #w_icon_handle]           ; (if tidying window icons)
        LDREQ   r1, [r11, #ic_icon]                 ; (if tidying file icons)
        SWI     Wimp_ResizeIcon                     ; Move icon to new x and y
        Pull    "r2"
                                                    
        MOV     r4, r3                              ; Register swapping - r3, r4 should contain x, y
        MOV     r3, r2
        TST     r8, #PinboardFlag_TidyWindows
        MOVEQ   r2, r8, LSR #3
        MOVNE   r2, r8
        BL      find_next_x_and_y
        BL      tidy_find_next_free
        MOV     r2, r3
        MOV     r3, r4

70      ; next_icon
        TST     r8, #PinboardFlag_TidyWindows
        LDRNE   r11, [r11, #w_next_ptr]             ; Find next icon in list
        LDREQ   r11, [r11, #ic_next]
        B       %BT50

80      ; Exit
        ADD     sp, sp, #48
        Pull    "r0-r11"

        EXIT


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; tidy_find_next_free
;
; Given an initial grid position, check if it's space is occupied. If it
; is, then move to the next position and try again.
;
; In: r3, r4 = x and y co-ordinates
;
; Out: r3, r4  = next free slot
;      r0 - r2 = corrupted.

tidy_find_next_free ENTRY

        LDR     r2, Pinboard_options
        TST     r2, #PinboardFlag_TidyWindows
        EXIT    NE

10
        LDR     r2, Pinboard_options
        BL      is_something_there
        EXIT    NE
        MOV     r2, r2, LSR #3
        BL      find_next_x_and_y
        B       %BT10
        
        EXIT


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; is_something_there
;
; Test if a grid position is occupied. As to which list of icons is
; checked depends on the value of PinboardFlag_UseWindowList. If set,
; then the window list is searched, else the file list.
;
; In: r3, r4 = x and y co-ordinate of grid position
;
; Out: EQ if something there, NE if not.
;      All regs. preserved.

is_something_there ENTRY

        Push    "r2"
        Push    "r5-r11"

        LDR     r2, Pinboard_options
        TST     r2, #PinboardFlag_UseWindowList
        LDRNE   r11, iconized_ptr                 ; first window in list?
        LDREQ   r11, Icon_list                    ; or first icon in list?
        SUB     sp, sp, #40                       ; grab some stack space to put data block
        MOV     r9, sp

20      ; next icon
        CMP     r11, #0                           ; is this the end of the linked list?
        BEQ     %FT90
        BL      get_next_icon_bbox                ; get the icon's bounding box
        CMP     r10, #0                           ; icon not on backdrop if r10 is zero
        BEQ     %FT80
        
        ADD     r5, r3, #grid_x_spacing           ; make r3, r4, r5, r6 the proposed bounding box.
        ADD     r6, r4, #grid_y_spacing

        ; Check the proposed icon's left and right bounds against the current stored icon
        LDR     r7, [r10] 
        CMP     r5, r7                            ; Check proposed x2 <= icon x1
        BLE     %FT80                             ; If it is, then this icon presents no problems - try next
        LDR     r7, [r10, #8]
        CMP     r3, r7                            ; Check proposed x1 >= icon x2
        BGE     %FT80                             ; If it is, then this icon presents no problems - try next
        
        ; Check the proposed icon's top and bottom bounds against the current stored icon
        LDR     r7, [r10, #4]
        CMP     r6, r7                            ; Check proposed y2 <= icon y1
        BLE     %FT80                             ; If it is, then this icon present no problems.
        LDR     r7, [r10, #12]
        CMP     r4, r7                            ; Check proposed y1 >= store y2
        BGE     %FT80                             ; If it is, then this icon presents no problems
        
70      ; something IS there - exit

        ;Push    "r0-r10"
        ;MOV     r0, #7
        ;SWI     OS_WriteC
        ;MOV     r0, #26
        ;SWI     OS_WriteC
        ;MOV     r0, #0
        ;MOV     r1, #32
        ;SWI     OS_SetColour
        ;MOV     r0, #69
        ;MOV     r1, r3
        ;MOV     r2, r4
        ;SWI     OS_Plot
        ;MOV     r0, #101
        ;MOV     r1, r5
        ;MOV     r2, r6
        ;SWI     OS_Plot
        ;SWI     OS_ReadC
        ;Pull    "r0-r10"        
    
        ADD     sp, sp, #40
        Pull    "r5-r11"
        Pull    "r2"
        CMP     sp, sp
        EXIT

80      ; this icon doesn't occupy the space - try next
        TST     r2, #PinboardFlag_UseWindowList
        LDRNE   r11, [r11, #w_next_ptr]
        LDREQ   r11, [r11, #ic_next]
        B       %BT20

90      ; something ISN'T there - exit
        ADD     sp, sp, #40
        Pull    "r5-r11"
        Pull    "r2"
        CMP     sp, #0
        EXIT        


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; next_grid_row_or_column
;
; Depending on PinboardOption_WinToCornerXX, return the X and Y
; co-ordinate of the start of the next row or column.
;
; In: r2     = options
;     r3, r4 = x and y co-ordinate of grid position

;
; Out: r3, r4 = x and y co-ordinate of next row or column

next_grid_row_or_column ENTRY

        Push    "r5"
        ADR     r5, bounding_box
        TST     r2, #PinboardOption_WinToCornerHV ; Are we dealing with rows or columns?
        BNE     %FT20
        
10      ; rows - reset x to left/right and move up/down a row
        LDR     r0, [r5, #8] ; x2
        TST     r2, #PinboardOption_WinToCornerLR
        SUBNE   r3, r0, #grid_x_spacing
        MOVEQ   r3, #0

        TST     r2, #PinboardOption_WinToCornerTB
        ADDNE   r4, r4, #grid_y_spacing
        SUBEQ   r4, r4, #grid_y_spacing

        ; Check we haven't moved up/down too far
        LDR     r0, [r5, #12] ; y2
        SUB     r0, r0, #grid_y_spacing
        CMP     r4, r0
        SUBGT   r4, r4, #grid_y_spacing

        LDR     r0, icon_bar_height
        CMP     r4, r0
        ADDLT   r4, r4, #grid_y_spacing
        
        B       %FT50

20      ; columns - reset y to top/bottom and move left/right a column
        LDR     r0, [r5, #12] ; y2
        TST     r2, #PinboardOption_WinToCornerTB
        LDRNE   r4, icon_bar_height
        SUBEQ   r4, r0, #grid_y_spacing
        
        TST     r2, #PinboardOption_WinToCornerLR
        SUBNE   r3, r3, #grid_x_spacing
        ADDEQ   r3, r3, #grid_x_spacing

        ; Check we haven't moved left/right too far
        LDR     r0, [r5, #8] ; x2
        SUB     r0, r0, #grid_x_spacing
        CMP     r3, r0
        SUBGT   r3, r3, #grid_x_spacing
        
        CMP     r3, #0
        ADDLT   r3, r3, #grid_x_spacing
        
50
        Pull    "r5"
        EXIT
 ]

@


4.1.4.3
log
@Windows, as well as files, can be selected, plus new menu structure and options
@
text
@d15 1
a15 1
; s.MenuSelect
d17 1
a17 12
; Handle menu selections

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; menu_selection
;
; In: r1 -> 256 byte block returned by Wimp_Poll, of which...
;                r1+0 item in main menu which was selected
;                r1+4 item in first submenu which was selected
;                r1+8 item in second submenu which was selected
;                etc.
;
; Out: registers may be corrupted - returning to wimp poll.
a89 1

d108 1
a108 1
        BL      SelectFileIcons
d115 1
a115 1
        BL      DeselectFileIcons
a170 8


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; reopen_pinboard_menu
;
; Called after dealing with a menu selection, to reopen the menu if a
; right mouse click was used on the selection.

a180 9

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; pinboard_menu_selection
;
; Deal with selections from the pinboard menu
;
; In: r1 -> Wimp_Poll block, specifically R1+0 contains the number of the
;           item in the main pinboard menu which was selected.

d183 2
a184 2
        ADR     r2,reopen_pinboard_menu ; Make sure this function is called when we've delt with
        Push    "r2"                    ; selection, so that menu is reopened if Right button was used
d190 13
a202 72
        B       selection_menu_selection ; 0
        B       selectall_menu_selection ; 1
        B       ClearSelection           ; 2
        B       options_menu_selection   ; 3
        B       Save                     ; 4
        [ show_backdrop_options
        B       MakeBackdrop             ; 5
        B       RemoveBackdrop           ; 6
        ]


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; selectall_menu_selection
;
; Deal with a selection from the Select all submenu.
;
; In: r1 -> Wimp_Poll bloc, specifically, R1 + 4 contains the number of
;           the item selected from the Select all submenu.

selectall_menu_selection

        LDR     r14, [r1, #4]
        ADD     pc, pc, r14, ASL #2
        B       SelectAll                ; -1 - Just a click on SelectAll without moving to the menu
        
        B       SelectAllFiles           ; 0 - Select files
        B       SelectAllWindows         ; 1 - Select windows
        B       SelectAll                ; 2


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; selection_menu_selection
;
; Deal with a selection from the Selection submenu.
;
; In: r1 -> Wimp_Poll bloc, specifically, R1 + 4 contains the number of
;           the item selected from the Selection submenu.

selection_menu_selection

        LDR     r14, [r1, #4]
        ADD     pc, pc, r14, ASL #2
        Pull    "pc"
        
        B      Tidy                     ; 0
        B      OpenSelection            ; 1 - Open
        B      Remove                   ; 2


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; option_menu_selection
;
; Deal with a selection from the options submenu.
;
; In: r1 -> Wimp_Poll bloc, specifically, R1 + 4 contains the number of
;           the item selected from the options submenu.

options_menu_selection

        LDR     r14, [r1, #4]
        ADD     PC, PC, R14, ASL #2
        Pull    "PC"
        
        B       IconiseWindowOpt    ; 0
        B       TidyToMenuOpt       ; 1
        B       Grid                ; 2


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; Tidy
;
; The 'Tidy' option was selected.
d207 1
d217 80
a307 6

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; Grid
;
; The 'Grid lock' option was selected.

d328 1
a328 1
        
d330 1
a330 8
        BL      SelectAllIcons
        Pull    "PC"
        
SelectAllFiles
       
        LDR     r0, backdrop_handle
        BL      DeselectAllIcons
        BL      SelectFileIcons
a331 7
        
SelectAllWindows

        LDR     r0, backdrop_handle
        BL      DeselectAllIcons
        BL      SelectWindowIcons
        Pull    "PC"        
d337 1
a337 1
        BL      DeselectAllIcons
d402 2
a407 3
;
; In: r1-> Wimp_Poll block, specifically, R1 + 8 contains the item within
;          the iconise submenu which was selected.
d412 1
a412 1
        LDR     r5, [r1, #8]
a455 3
;
; In: r1-> Wimp_Poll block, specifically R1+8 stores the item within the
;          Tidy to submenu which was selected.
d460 1
a460 1
        LDR     r5, [r1, #8]
d492 3
a494 1
tidy_icons ENTRY "r0-r11"
d506 31
a536 17
        ; Decide on initial left/right positioning
        LDR     r1, [r0, #8]                        ; load screen max_x
        TST     r8, #PinboardFlag_TidyWindows       ; see if we're dealing with windows or files
        MOVNE   r2, #PinboardOption_WinToCornerLR   ; if windows, then we'll test WinToCornerLR bit
        MOVEQ   r2, #PinboardOption_TidyToCornerLR  ; if files, then we'll test TidyToCornerLR bit
        TST     r8, r2                              ; test the bit
        MOVEQ   r2, #0                              ; if not set, then use left of screen
        SUBNE   r2, r1, #grid_x_spacing             ; if set, then use right of screen

        ; Decide on initial up/down positiong
        LDR    r1, [r0, #12]                        ; load screen max_y
        TST    r8, #PinboardFlag_TidyWindows        ; see if we're dealing with windows or files 
        MOVNE  r3, #PinboardOption_WinToCornerTB    ; if windows, then we'll test WinToCornerTB
        MOVEQ  r3, #PinboardOption_TidyToCornerTB   ; if files, then we'll test TidyToCornerTB
        TST    r8, r3                               ; test the bit
        SUBEQ  r3, r1, #grid_y_spacing              ; if not set, then use top of screen
        LDRNE  r3, icon_bar_height                  ; if set, then use bottom of screen
d538 1
a539 1
        ; Check initial position for clash, if we're doing files.
d563 3
a565 1
        LDR     r1, [r11, #ic_window]               ; What's the window handle
d571 3
a573 1
        LDR     r0, [r11, #ic_icon]
a576 4
        LDR     r4, [r1, #24]                       ; icon flags
        TST     r4, #is_selected                    ; check if selected
        BEQ     %FT70                               ; if not, skip

d580 1
d586 7
d594 3
a596 2
        SUBS    r1, r0, r6                          ; x1
        ADDS    r2, r2, r1, LSR #1                  ; x2
d601 2
a602 3
        STREQ   r2, [r11, #ic_x]                    ; store x
        STREQ   r3, [r11, #ic_y]                    ; store y

d604 3
a606 1
        LDR     r1, [r11, #ic_icon]
d621 3
a623 1
        LDR     r11, [r11, #ic_next]
d628 2
d673 4
a676 1
is_something_there ENTRY "r2, r5-r11"
d711 21
a731 1
70      ; Exit EQ
d733 2
d739 3
a741 1
        LDR     r11, [r11, #ic_next]
d744 1
a744 1
90      ; something ISN'T there - Exit NE
d746 2
d764 1
a764 1
next_grid_row_or_column ENTRY "r5"
d766 1
d790 2
a791 1
        EXIT
d811 3
d815 1
d818 1
a818 53
; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; OpenSelection
;
; Called when user clicks on Selection->Open to open all selected windows/files

OpenSelection

        BL      OpenWindows
        BL      OpenFiles
        BL      ClearSelection
        EXIT


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; OpenWindows
;
; Open all selected iconised windows on the backdrop

OpenWindows ENTRY

01
        ADR     r1, dataarea
        LDR     r7, iconized_ptr
02
        CMP     r7, #0                   ; Have we reached end of list?
        EXIT    EQ
        LDR     r0, [r7, #ic_window]     ; Get handle of window which this icon is in
        LDR     r2, backdrop_handle
        CMP     r0, r2                   ; Check it's the backdrop
        BNE     %FT05
        
        STR     r0, [r1]
        LDR     r0, [r7, #ic_icon]
        STR     r0, [r1, #4]
        SWI     XWimp_GetIconState       ; Get state of the icon
        EXIT    VS

        LDR     r0, [r1, #24]
        TST     r0, #is_selected         ; Check it's selected
        BEQ     %FT05
        BL      reopen_window            ; If it is, reopen the window. Go back and start again from
        LDR     r0, Window_Icons
        SUB     r0, r0, #1               ; Update number of window icons
        STR     r0, Window_Icons
        LDR     r0, Windows_Selected
        SUB     r0, r0, #1
        STR     r0, Windows_Selected

        B       %BT01                    ; first icon (because list has changed).

05
        LDR     r7, [r7, #ic_next]       ; Get next icon
        B       %BT02        
a819 47

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; OpenFiles
;
; Open all selected files on the backdrop

OpenFiles ENTRY

        LDR     r7, Icon_list
        
02
        CMP     r7, #0                   ; is this the last icon?
        EXIT    EQ
        LDR     r0, [r7, #ic_window]
        LDR     r2, backdrop_handle
        CMP     r0, r2                   ; check icon is on backdrop
        BNE     %FT05
      
        ADR     r1, dataarea
        STR     r0, [r1]
        LDR     r0, [r7, #ic_icon]
        STR     r0, [r1, #4]
        SWI     XWimp_GetIconState       ; get icon's state
        EXIT    VS
        
        LDR     r0, [r1, #24]
        TST     r0, #is_selected         ; check if icon is selected
        BEQ     %FT05

        ; Filer_Run the file
        ADR     r1, dataarea
        ADR     r0, FilerRunCom          ; Filer_Run
        BL      Copy_r0r1
        ADD     r0, r7, #ic_path         ; filename
        BL      Copy_r0r1
        ADR     r0, dataarea
        SWI     XOS_CLI
        EXIT    VS
        
05
        LDR     r7, [r7, #ic_next]
        B       %BT02

FilerRunCom        DCB     "Filer_Run ",0

        LNK     s.Tail
        
@


4.1.4.4
log
@Fixed bug which can cause Pinboard to die when dragging icons to other apps
@
text
@d794 1
a794 1
        Pull    "pc"
@


4.1.4.5
log
@Pinboard options now set via a *PinboardOptions command.
Backdrop command now includes a -Colour &GGBBRR00 switch to set background
colour.
Save now only saves a Pinboard command, followed by Pin commands. Options
and backdrops are instead set by Configure.
A click on 'Save' (as opposed to opening the saveas box) will save the
pinboard under the current filename.
@
text
@a420 1
        BL      IntSave_KeyPressed
@


4.1.4.6
log
@Removed Info option on TinyDirs menu.
Updated interactive help messages.
Shift+Click on close icon now ALWAYS iconises the window underneath the icon
(old behaviour), while a click on iconise button iconises according to the
IconiseTo corner.
@
text
@d70 1
a70 1
        ;Pull    "PC"                    
@


4.1.4.7
log
@Bug fixes.
Turned off defaultbackdrop and UseECFforLCD. Only needed on A4.
Updated service call handling to use new Ursula tables.
@
text
@d826 6
a831 6
        ;LDR     r0, Window_Icons
        ;SUB     r0, r0, #1               ; Update number of window icons
        ;STR     r0, Window_Icons
        ;LDR     r0, Windows_Selected
        ;SUB     r0, r0, #1
        ;STR     r0, Windows_Selected
@


4.1.4.8
log
@Fixed a couple of bugs.
Improved tidying code.
Filenames are now truncated.
@
text
@d513 270
d884 1
a884 1
        LNK     s.Tidy
@


4.1.4.9
log
@Bug fix:Select all windows and select all files now work correctly.
@
text
@a349 1
        LDR     r0, backdrop_handle
a356 1
        LDR     r0, backdrop_handle
@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@@


4.1.5.1
log
@Import from SrcFiler
@
text
@@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
