head	4.2;
access;
symbols
	Wimp-5_62:4.2
	Wimp-5_61:4.2
	Wimp-5_60:4.2
	Wimp-5_59:4.2
	Wimp-5_58:4.2
	Wimp-5_57:4.2
	Wimp-5_56:4.2
	Wimp-5_55:4.2
	Wimp-5_54:4.2
	Wimp-5_53:4.2
	Wimp-5_52:4.2
	Wimp-5_51:4.2
	Wimp-5_50:4.2
	Wimp-5_49:4.2
	Wimp-5_48:4.2
	Wimp-5_47-file1ad:4.2
	Wimp-5_47:4.2
	Wimp-5_46:4.2
	Wimp-5_45:4.2
	Wimp-5_44:4.2
	Wimp-5_43:4.2
	Wimp-5_42:4.2
	Wimp-5_41:4.2
	Wimp-5_40:4.2
	Wimp-5_39:4.2
	Wimp-5_38:4.2
	Wimp-5_37:4.2
	Wimp-5_36:4.2
	Wimp-5_35:4.2
	Wimp-5_34:4.2
	Wimp-5_33:4.2
	Wimp-5_32:4.2
	Wimp-5_31:4.2
	Wimp-5_30:4.2
	Wimp-530-pre4:4.2
	Wimp-5_30-pre3:4.2
	Wimp-5_30-pre2:4.2
	Wimp-5_30-pre1:4.2
	Wimp-5_29:4.2
	Wimp-5_28:4.2
	Wimp-5_27:4.2
	Wimp-5_26:4.2
	Wimp-5_25:4.2
	Wimp-5_24:4.2
	Wimp-5_23:4.2
	Wimp-5_22:4.2
	Wimp-5_21:4.2
	Wimp-5_20:4.2
	Wimp-5_19:4.2
	Wimp-5_18:4.2
	Wimp-5_17:4.2
	Wimp-5_16:4.2
	Wimp-5_15:4.2
	Wimp-5_14:4.2
	Wimp-5_13:4.2
	Wimp-5_12:4.2
	Wimp-5_11:4.2
	Wimp-5_10:4.2
	Wimp-5_09:4.2
	Wimp-5_08:4.2
	Wimp-5_07:4.2
	Wimp-5_06:4.2
	Wimp-5_05:4.2
	Wimp-5_04:4.2
	Wimp-5_03:4.2
	Wimp-5_02:4.2
	Wimp-5_01:4.2
	Wimp-4_66-4_77_2_1:4.2
	bavison_Threads_dev:4.2.0.4
	bavison_Threads_dev_bp:4.2
	Wimp-5_00:4.2
	Wimp-4_100:4.2
	Wimp-4_99:4.2
	Wimp-4_98:4.2
	Wimp-4_97:4.2
	Wimp-4_96:4.2
	Wimp-4_95:4.2
	Wimp-4_94:4.2
	RO_5_07:4.2
	Wimp-4_93:4.2
	Wimp-4_92:4.2
	Wimp-4_91:4.2
	Wimp-4_90:4.2
	Wimp-4_89:4.2
	Wimp-4_88:4.2
	Wimp-4_87:4.2
	Wimp-4_86:4.2
	Wimp-4_85:4.2
	Wimp-4_84:4.2
	Wimp-4_83:4.2
	Wimp-4_82:4.2
	Wimp-4_81:4.2
	Wimp-4_80:4.2
	Wimp-4_79:4.2
	Wimp-4_78:4.2
	Wimp-4_77:4.2
	Wimp-4_76:4.2
	Wimp-4_75:4.2
	Wimp-4_74:4.2
	Wimp-4_73:4.2
	Wimp-4_72:4.2
	Wimp-4_71:4.2
	Wimp-4_70:4.2
	Wimp-4_69:4.2
	Wimp-4_68:4.2
	Wimp-4_67:4.2
	Wimp-4_66:4.2
	Wimp-4_65:4.2
	Wimp-4_64:4.2
	Wimp-4_63:4.2
	Wimp-4_62:4.2
	Wimp-4_61:4.2
	Wimp-4_60:4.2
	Wimp-4_59:4.2
	Wimp-4_58:4.2
	Wimp-4_36-4_46_2_6:4.2
	Wimp-4_57:4.2
	Alpnet_approved:4.2
	Wimp-4_36-4_46_2_5:4.2
	Wimp-4_56:4.2
	dellis_autobuild_BaseSW:4.2
	Wimp-4_36-4_46_2_4:4.2
	Wimp-4_36-4_46_2_3:4.2
	Wimp-4_55:4.2
	Wimp-4_54:4.2
	Wimp-4_36-4_46_2_2:4.2
	Wimp-4_53:4.2
	Wimp-4_36-4_46_2_1:4.2
	Bethany:4.2.0.2
	Wimp-4_52:4.2
	Wimp-4_51:4.2
	Wimp-4_50:4.2
	Wimp-4_49:4.2
	Wimp-4_48:4.2
	Wimp-4_47:4.2
	Wimp-4_46:4.2
	Wimp-4_45:4.2
	Wimp-4_44:4.2
	Wimp-4_43:4.2
	Wimp-4_42:4.2
	sbrodie_sedwards_16Mar2000:4.2
	Wimp-4_41:4.2
	Wimp-4_40:4.2
	Wimp-4_39:4.2
	Wimp-4_38:4.2
	Wimp-4_37:4.2
	Wimp-4_36:4.2
	Wimp-4_35:4.2
	Wimp-4_34:4.2
	Wimp-4_33:4.2
	Wimp-4_32:4.2
	Wimp-4_31:4.2
	dcotton_autobuild_BaseSW:4.2
	Wimp-4_30:4.2
	Wimp-4_29:4.2
	Wimp-4_28:4.2
	Wimp-4_27:4.2
	Wimp-4_26:4.2
	Wimp-4_25:4.2
	Wimp-4_24:4.2
	Wimp-4_23:4.2
	Wimp-4_22:4.2
	Wimp-4_21:4.2
	Wimp-4_20:4.2
	Wimp-4_19:4.2
	Wimp-4_18:4.2
	Wimp-4_17:4.2
	Wimp-4_16:4.2
	Wimp-4_15:4.2
	Wimp-4_14:4.2
	Wimp-4_13:4.2
	Wimp-4_12:4.2
	mstphens_UrsulaRiscPCBuild_20Nov98:4.1
	bavison_Wimp-4_11:4.2
	Ursula_RiscPC:4.1.0.8
	Wimp-4_11:4.2
	Wimp-4_10:4.2
	Wimp-4_09:4.2
	Wimp-4_08:4.1
	Wimp-4_07:4.1
	Wimp-4_06:4.1
	Wimp-4_05:4.1
	Wimp-4_04:4.1
	bavison_Wimp-4_03_noshrinkables:4.1
	Wimp-4_03:4.1
	Wimp-4_02:4.1
	Ursula_merge:4.1
	bavison_Wimp-4_01:4.1
	Wimp-4_01:4.1
	nicke_Wimp_3_96M:4.1.7.1
	bavison_Wimp-4_00_TRUNK:4.1
	bavison_Wimp-4_00:4.1
	nicke_Wimp_3_96:4.1.7.1
	mjrobert_Wimp_3_98:4.1
	rthornb_UrsulaBuild-19Aug1998:4.1
	UrsulaBuild_FinalSoftload:4.1
	bavison_Wimp-3_99t:4.1
	rthornb_UrsulaBuild-12Aug1998:4.1
	bavison_Wimp-3_99s:4.1
	aglover_UrsulaBuild-05Aug1998:4.1
	bavison_Wimp-3_99r:4.1
	rthornb_UrsulaBuild-29Jul1998:4.1
	bavison_Wimp-3_99q:4.1
	jfarrell_NCWimp_3_96:4.1.7.1
	rthornb_UrsulaBuild-22Jul1998:4.1
	bavison_Wimp-3_99p:4.1
	rthornb_UrsulaBuild-15Jul1998:4.1
	bavison_Wimp-3_99o:4.1
	bavison_Wimp-3_99n:4.1
	rthornb_UrsulaBuild-07Jul1998:4.1
	bavison_Wimp-3_99m:4.1
	rthornb_UrsulaBuild-17Jun1998:4.1
	rthornb_UrsulaBuild-03Jun1998:4.1
	bavison_Wimp-3_99l:4.1
	rthornb_UrsulaBuild-27May1998:4.1
	rthornb_UrsulaBuild-21May1998:4.1
	bavison_Wimp-3_99k:4.1
	bavison_Wimp-3_99j:4.1
	bavison_Wimp-3_99i:4.1
	bavison_Wimp-3_99h:4.1
	rthornb_UrsulaBuild_01May1998:4.1
	bavison_Wimp_399g:4.1
	bavison_Wimp_399f:4.1
	afrost_NC2_Generic:4.1.7.1
	bavison_Wimp_399e:4.1
	bavison_Wimp_399d:4.1
	bavison_Wimp_399c:4.1
	Wimp_3_98:4.1
	kbracey_AW97:4.1
	Spinner_B20_2:4.1.7.1
	Spinner_19_3:4.1.7.1
	Spinner_B18:4.1.7.1
	Spinner_B17:4.1.7.1
	Spinner_B15:4.1.7.1
	Spinner_B14:4.1.7.1
	Spinner_B13:4.1.7.1
	Spinner_B12:4.1.7.1
	Spinner_B10:4.1.7.1
	Daytona:4.1.0.6
	Daytona_bp:4.1
	Ursula:4.1.0.4
	Ursula_bp:4.1
	Wimp_3_91:4.1
	Spin_merge_7May97:4.1.7.1
	ARTtmp_bp:4.1.7.1
	Spinner_B7:4.1.7.1
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	ARTtmp:4.1.7.1.0.2
	Spin_merge:4.1.7.1
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.2
date	98.10.23.15.48.19;	author bavison;	state Exp;
branches;
next	4.1;

4.1
date	96.11.05.09.30.47;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.5.1
	4.1.7.1;
next	;

4.1.1.1
date	96.11.05.09.30.47;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.05.23.32.56;	author nturton;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.12.24.34;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.20.22.08;	author nturton;	state Exp;
branches;
next	;


desc
@@


4.2
log
@Adapted assembly process so that the choice of Options file (previously based
purely on the "System" variable) can be overridden by passing "OPTIONS=foo" as
an argument to either MkRom, or to amu/amu_machine directly, or indirectly,
by specifying it in the components file for a build. To accomplish this, it
was necessary to switch from using aasm to objasm - hence the large number of
source files affected in this commit.

Version 4.09. Tagged as 'Wimp-4_09'
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
; this OS_Module equivalent looks at ptr-4 which the Heap Manager uses
; to store the real size of the block. In this way the memory use is
; more efficient (especially when extending a block) and RMA should
; fragment less often.

        [ DebugMemory

XROS_Module Entry 
        TEQ     R0,#6
        TEQNE   R0,#7
        TEQNE   R0,#13
        SWINE   XOS_Module
        EXIT    NE
        TEQ     R0,#6
        BEQ     ros_claim
        TEQ     R0,#7
        BEQ     ros_free
; extend

; check to see if on claim list
        CMP     R2,#-1
        MOVEQ   R0,#ModHandReason_Claim
        BLEQ    XROS_Module
        MOVEQ   R0,#ModHandReason_ExtendBlock
        EXITS   EQ

        Push    R0
        ADRL    R0,memory_claims
05
        LDR     R14,[R0],#8
        TEQ     R14,R2
        Push    R0,EQ

        BEQ     %FT09

        CMP     R14,#-1
        BNE     %BT05
        B       %FT07
09
        Push    "R3-R5"
        LDR     R4,[R2,#-8]
        LDR     R5,[R2,#-4]!
        ADD     R5,R5,R3                        ; R5 is proposed new size

        [ true
        CMP     R5,#4
        BLE     extend_to_zero                    ; shrunk to zero size.
        ]

        SUB     R4,R4,#4
        CMP     R4,R5
        CMPGE   R3,#0
        BLT     %FT02
        STR     R5,[R2],#4                      ; enough space so just store
        Pull    "R3-R5"
        CLRV            

        ADD     SP,SP,#4
        Pull    R0

        EXITS
02                                                                            
        SUB     R3,R5,R4
        MOV     R0,#ModHandReason_ExtendBlock
        SWI     XOS_Module
        STRVC   R5,[R2],#4
        Pull    "R3-R5"
        Pull    R0,VC
        STRVC   R2,[R0,#-8]
        Pull    R0,VC
        EXITS   VC
        ADD     sp,sp,#8
        EXIT              
           
extend_to_zero
        Pull    "R3-R5"
        CLRV
        ADD     SP,SP,#4
        ADD     R2,R2,#4
        MOV     R0,#ModHandReason_Free
        BL      XROS_Module
        MOV     R2,#-1
        Pull    R0
        EXITS

ros_free
;        STR     R2,[R2,#-4]!           ; uncomment for debugging 

; check to see if on claim list
        Push    R0
        ADRL    R0,memory_claims
05
        LDR     R14,[R0],#8
        TEQ     R14,R2
        BEQ     %FT09

        CMP     R14,#-1
        BNE     %BT05
07
; oh dear, trying to free something that didn't exist
        LDR     R0,[SP,#4]                 ; pc
        BIC     R0,R0,#&fc000003

        Push    R1-R7  
        SUB     SP,SP,#256
        MOV     R1,SP
        MOV     R2,#16
        SWI     XOS_ConvertHex8
        ADD     R1,sp,#16
        MOV     R2,#16
        LDR     R0,[sp,#256+4]
        SWI     XOS_ConvertHex8
        ADR     R1,noclaim+4
        MOV     R0,#0
        ADD     R2,SP,#32
        MOV     R3,#224
        ADD     R4,SP,#16
        MOV     R5,sp
        MOV     R6,#0
        MOV     R7,#0
        SWI     XMessageTrans_Lookup
        ADD     R0,SP,#28
        MOV     R1,#1
        MOV     R2,#0
        SWI     Wimp_ReportError
        ADD     SP,SP,#256
        Pull    R1-R7
        SETV            
        ADD     SP,SP,#4
        EXIT
                       
09                    
        Push    R1
        SUB     R1,R0,#8                        ; remove entry
14
        LDR     R14,[R0],#4
        STR     R14,[R1],#4
        CMP     R14,#-1
        BNE     %BT14
        Pull    R1
        Pull    R0                                            

        SUB     R2,R2,#4
        SWI     XOS_Module
        EXITS   VC
        EXIT

ros_claim
        ADD     R3,R3,#4
        SWI     XOS_Module
        EXIT    VS

        STR     R3,[R2],#4                      ; so modptr-4 = ammount asked for + 4
        SUB     R3,R3,#4                        ; needs to be preserved

; add address to list of claims
        Push    R0-R1
        ADRL    R0,memory_claims
05
        LDR     R14,[R0],#8
        CMP     R14,#-1
        BNE     %BT05
        ADRL    R1,end_of_claims
        TEQ     R0,R1
        BEQ     %FT08
        STR     R2,[R0,#-8]
        LDR     R1,[sp,#8]                      ; pc
        STR     R1,[R0,#-4]
        STR     R14,[R0]
08
        Pull    R0-R1

        EXITS

noclaim
        DCD     0
        DCB     "DF:An area (%0) which has already been freed (or not previously claimed) has tried to be freed from %1.",0

        |

XROS_Module Entry 
        TEQ     R0,#6
        TEQNE   R0,#7
        TEQNE   R0,#13
        SWINE   XOS_Module
        EXIT    NE
        TEQ     R0,#6
        BEQ     ros_claim
        TEQ     R0,#7
        BEQ     ros_free
; extend
        Push    "R3-R5"
        LDR     R4,[R2,#-8]
        LDR     R5,[R2,#-4]!
        ADD     R5,R5,R3                        ; R5 is proposed new size
        SUB     R4,R4,#4
        CMP     R4,R5
        CMPGE   R3,#0
        BLT     %FT02
        STR     R5,[R2],#4                      ; enough space so just store
        Pull    "R3-R5"
; can never error
        EXITS
02                                                                            
        SUB     R3,R5,R4
        SWI     XOS_Module
        STRVC   R5,[R2],#4
        Pull    "R3-R5"
        EXITS   VC
        EXIT              


ros_free
        SUB     R2,R2,#4
        SWI     XOS_Module
        EXITS   VC
        EXIT

ros_claim
        ADD     R3,R3,#4
        SWI     XOS_Module
        STRVC   R3,[R2],#4                      ; so modptr-4 = ammount asked for + 4
        SUB     R3,R3,#4                        ; needs to be preserved
        EXITS   VC
        EXIT
        ]

        END

@


4.1
log
@Initial revision
@
text
@d22 1
a22 1
XROS_Module ENTRY 
d195 1
a195 1
XROS_Module ENTRY 
@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@@


4.1.5.1
log
@Import from SrcFiler
@
text
@@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
