head	4.11;
access;
symbols
	Filer-2_43:4.11
	Filer-2_42:4.11
	Filer-2_41:4.11
	Filer-2_40:4.11
	Filer-2_39:4.11
	Filer-2_38:4.11
	Filer-2_37:4.10
	Filer-2_36:4.10
	Filer-2_35:4.10
	Filer-2_34:4.10
	Filer-2_33:4.9
	Filer-2_32:4.9
	Filer-2_31:4.9
	Filer-2_30:4.9
	Filer-2_29:4.9
	Filer-2_28:4.8
	Filer-2_27:4.8
	Filer-2_26:4.8
	Filer-2_25:4.7
	Filer-2_24:4.7
	Filer-2_23:4.7
	Filer-2_22:4.6
	Filer-2_21:4.5
	Filer-2_20:4.4
	Filer-2_19:4.4
	Filer-2_18:4.4
	Filer-2_17:4.4
	Filer-2_16:4.4
	Filer-2_15:4.4
	Filer-2_14:4.4
	Filer-2_13:4.4
	Filer-2_12:4.4
	Filer-2_11:4.3
	Filer-2_10:4.3
	Filer-2_09:4.3
	RO_5_07:4.3
	Filer-2_08:4.3
	Filer-2_07:4.2
	Filer-2_06:4.2
	Filer-2_05:4.2
	Filer-2_04:4.2
	Filer-2_03:4.2
	Filer-2_02:4.2
	Filer-2_01:4.2
	Filer-2_00:4.2
	Filer-1_99:4.2
	Filer-1_98:4.2
	Filer-1_97:4.2
	Ursula_merge:4.1.4.9
	Filer-1_96:4.2
	Filer-1_95:4.1.4.9
	nturton_Filer-1_85:4.1
	mstphens_UrsulaRiscPCBuild_20Nov98:4.1.4.9
	Ursula_RiscPC:4.1.4.9.0.2
	rthornb_UrsulaBuild-19Aug1998:4.1.4.9
	UrsulaBuild_FinalSoftload:4.1.4.9
	rthornb_UrsulaBuild-12Aug1998:4.1.4.9
	aglover_UrsulaBuild-05Aug1998:4.1.4.9
	rthornb_UrsulaBuild-29Jul1998:4.1.4.9
	rthornb_UrsulaBuild-22Jul1998:4.1.4.9
	rleggett_Filer-1_94:4.1.4.9
	rthornb_UrsulaBuild-15Jul1998:4.1.4.9
	rthornb_UrsulaBuild-07Jul1998:4.1.4.9
	rthornb_UrsulaBuild-17Jun1998:4.1.4.9
	rthornb_UrsulaBuild-03Jun1998:4.1.4.9
	rthornb_UrsulaBuild-27May1998:4.1.4.9
	rleggett_Filer-1_93:4.1.4.9
	rthornb_UrsulaBuild-21May1998:4.1.4.9
	rthornb_UrsulaBuild_01May1998:4.1.4.9
	Spinner_B20_2:4.1.7.1
	Spinner_19_3:4.1.7.1
	Spinner_B18:4.1.7.1
	Spinner_B17:4.1.7.1
	Spinner_B15:4.1.7.1
	Spinner_B14:4.1.7.1
	Spinner_B13:4.1.7.1
	Spinner_B12:4.1.7.1
	Spinner_B10:4.1.7.1
	Daytona:4.1.0.6
	Daytona_bp:4.1
	Ursula:4.1.0.4
	Ursula_bp:4.1
	Spinner_B7:4.1.7.1
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	ARTtmp:4.1.7.1.0.2
	Spin_merge:4.1.7.1
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.11
date	2014.11.10.08.50.21;	author jballance;	state Exp;
branches;
next	4.10;
commitid	9dugk2OAYtifiCXx;

4.10
date	2013.11.24.12.33.03;	author rsprowson;	state Exp;
branches;
next	4.9;
commitid	qgjIfJ3IKLI7Owex;

4.9
date	2012.03.24.10.40.02;	author jlee;	state Exp;
branches;
next	4.8;
commitid	SdFshmol26J4N7Yv;

4.8
date	2010.10.23.18.02.28;	author rsprowson;	state Exp;
branches;
next	4.7;

4.7
date	2010.01.30.14.33.43;	author jlee;	state Exp;
branches;
next	4.6;

4.6
date	2010.01.07.21.52.58;	author rool;	state Exp;
branches;
next	4.5;

4.5
date	2010.01.07.21.43.30;	author rool;	state Exp;
branches;
next	4.4;

4.4
date	2007.09.18.13.23.30;	author srevill;	state Exp;
branches;
next	4.3;

4.3
date	2003.02.04.14.30.59;	author bavison;	state Exp;
branches;
next	4.2;

4.2
date	99.08.17.11.56.48;	author sbrodie;	state Exp;
branches;
next	4.1;

4.1
date	96.11.05.09.29.33;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.4.1
	4.1.5.1
	4.1.7.1;
next	;

4.1.1.1
date	96.11.05.09.29.33;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.05.23.27.51;	author nturton;	state Exp;
branches;
next	;

4.1.4.1
date	97.05.27.11.13.32;	author rleggett;	state Exp;
branches;
next	4.1.4.2;

4.1.4.2
date	97.05.28.08.44.08;	author rleggett;	state Exp;
branches;
next	4.1.4.3;

4.1.4.3
date	97.08.27.09.09.11;	author rleggett;	state Exp;
branches;
next	4.1.4.4;

4.1.4.4
date	97.09.12.09.17.34;	author rleggett;	state Exp;
branches;
next	4.1.4.5;

4.1.4.5
date	97.09.24.13.26.45;	author rleggett;	state Exp;
branches;
next	4.1.4.6;

4.1.4.6
date	97.10.21.09.38.43;	author rleggett;	state Exp;
branches;
next	4.1.4.7;

4.1.4.7
date	98.01.07.10.28.00;	author rleggett;	state Exp;
branches;
next	4.1.4.8;

4.1.4.8
date	98.04.15.11.27.50;	author rleggett;	state Exp;
branches;
next	4.1.4.9;

4.1.4.9
date	98.04.27.10.26.17;	author rleggett;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.12.17.38;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.20.16.33;	author nturton;	state Exp;
branches;
next	;


desc
@@


4.11
log
@  Increased size of stackbot in s.WkspEtc to allow space for longer file/path
names. changed from &200 to &400. This extends the max length the filer can
handle from approx 250 chars to at least double that.


Version 2.38. Tagged as 'Filer-2_38'
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; Register names
; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

; sp            RN      r13             ; FD stack
; wp            RN      r12

scy             RN      r11
scx             RN      r10
y1              RN      r9
x1              RN      r8
y0              RN      r7
x0              RN      r6
cy1             RN      r5              ; Order important for LDM/STM
cx1             RN      r4
cy0             RN      r3
cx0             RN      r2

; fileinfoblock RN      r5
; dirviewerblock RN     r4

; r0,r1 not named

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; Macro definitions
; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

        MACRO
        max     $a, $b
        CMP     $a, $b
        MOVLT   $a, $b
        MEND

        MACRO
        min     $a, $b
        CMP     $a, $b
        MOVGT   $a, $b
        MEND

        MACRO
$lab    InvSmiWidth     $dirv
$lab    Push    "R0"
        MOV     R0,#0
        STR     R0,[$dirv,#d_smiwidth]
        STR     R0,[$dirv,#d_lgiwidth]
        Pull    "R0"
        MEND

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; Constants
; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

TAB     *       9
LF      *       10
CR      *       13
space   *       " "
quote   *       """"
delete  *       127

Nowt    *       &40000001

bignum  *       &0FFFFFFF

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

charx_shf *     4
charx     *     1 :SHL: charx_shf
chary_shf *     5
chary     *     1 :SHL: chary_shf


; Buttons for ReportError

ok_button       *       2_001
cancel_button   *       2_010


 [ AltRenaming
; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; Memory required for alt click renaming
                   ^       0
re_windowhandle    #       4    ; The handle of the window the writeable icon is in
re_iconhandle      #       4    ; The icon handle of the writeable icon
re_createiconblock #       0    ; A block for creating the icon...
re_createwhandle   #       4    ;   - handle to create in
re_icondata        #       0    ;   - 32 byte icon data...
re_minx            #       4    ;       - bounding box
re_miny            #       4    ;
re_maxx            #       4    ;
re_maxy            #       4    ;
re_flags           #       4    ;       - flags
re_textptr         #       4    ;       - pointer to text buffer
re_validptr        #       4    ;       - pointer to validation string
re_bufflength      #       4    ;       - buffersize
re_textstring      #       256  ; Memory to hold the icon's text
re_validstring     #       48   ; Memory to hold icon's validation string
re_tempdata        #       32   ; Temporary data store
re_dirblock        #       4    ; pointer to directory block for the file being renamed
re_fileblock       #       4    ; pointer to file block for the file being renamed
re_chunksize       *       :INDEX: @@
 ]

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; Format of an application

                ^       0
a_link          #       4       ; points to next applic or Nowt
a_dir           #       4       ; points to application directory
a_wasbooted     #       1       ; Indicates that app was !Booted
a_leafname      #       0       ; Application name
a_headersize    *       :INDEX: @@

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; Format of a directory

                ^       0
ad_link         #       4       ; points to next application directory or Nowt
ad_usage        #       4       ; number of usages of this directory
ad_name         #       0       ; Full directory name
ad_headersize   *       :INDEX: @@

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; Format of a dirviewer
;
; Overview:
;
; Suppose there are N files in the directory, then this is the construction
; of the dirviewer block:
;
; <header>[<df_size>*N]<FS#Special::Disc.$.blah.yak.waffle (A500)><Special>[<name>*N]
;           ...-------> ...------->                     ...------>
;           d_dirname   d_stripname                     d_special
;
; |-------------------------------------------------------------------------------->
; d_size
;
; An arrow like this: |-----> indicates an offset.
; An arrow like this: ...---> indicates an absolute address

                ^       0
; Section set up by OpenDir/RecacheDir
d_link          #       4               ; Link to next DirViewer block
d_dirnamestore  #       4               ; contains window title - separate block so it doesn't move
d_handle        #       4               ; window handle of dirviewer
 [ hastiny
d_iconhandle    #       4               ; Icon handle of tinydir icon
 ]
d_sortlink      #       4               ; new link when sorting by stacking
d_smiwidth      #       4               ; width of icon columns (NK new wimp release)
d_lgiwidth      #       4
; Section set up by CacheDir acting on state
d_filesystem    #       4               ; what filing system we are on
                                        ; (file system info word)
d_filenames     #       0
d_dirname       #       4               ; address of start of dirname as stored in this block
d_special       #       4               ; address of special field
d_stripname     #       4               ; address of stripped name
d_nfiles        #       4               ; number of objects in dirviewer
d_size          #       4               ; number of bytes used for storing data in this block
d_viewmode      #       1               ; display mode/sort type
; End of above section
d_filesperrow   #       1               ; number of objects per row: 0 -> redo
d_nchildren     #       1               ; number of children that have been
                                        ; opened; may not all be alive still
d_unsure        #       1               ; whether contents are possibly invalid
           AlignSpace   4
d_headersize    *       :INDEX: @@


; Objects within directory follow ...

; These are followed by the fullname of the dir, then subsequent filenames

 [ ShowOpenDirs
refresh_open    *       1 :SHL: 0       ; Chris's refresh routines need these flags
refresh_close   *       1 :SHL: 1       ; to indicate what to set the dfs_state to.
 ]

; Filesystem word - low 8 bits = fs number

fod_readonly            *       1 :SHL: 16 ; You have no write access here or
                                           ; can't write anyway (eg. rom:)
fscb_infoword           *       32         ; Offset into fscb of info word

; Offsets/fields within d_viewmode byte, and OpenDirAt viewmode byte

dbb_displaymode *       0
db_displaymode  *       2_11 :SHL: dbb_displaymode
dbb_sortmode    *       2
db_sortmode     *       2_11 :SHL: dbb_sortmode
 [ openat
dbu_displaymode *       4
dbu_sortmode    *       5
 ]
dbb_sortorder   *       6
db_sortorder    *       2_1 :SHL: dbb_sortorder
dbb_sortnumeric *       7
db_sortnumeric  *       2_1 :SHL: dbb_sortnumeric

; Values that db_displaymode field can take

db_dm_largeicon *       0
db_dm_smallicon *       1
db_dm_fullinfo  *       2

; Values that db_sortmode field can take (before shifting into place)

db_sm_name      *       0
db_sm_type      *       1
db_sm_size      *       2
db_sm_date      *       3

 [ centralwrap
; Values with special meanings that d_filesperrow can take

db_fpr_invalid  *       0       ; Invalid window size, reset on open request
db_fpr_reshape  *       &fe     ; Valid(ish) filesperrow to cause a reshape
                                ; of contents, leaving window where it was
db_fpr_stuffed  *       &ff     ; Error, viewer stuffed
 ]

; Fields within fileinfo blocks

                ^       0
df_load         #       4
df_exec         #       4
df_length       #       4
df_attr         #       4
df_helptype     #       4
 [ not_16bit_offsets
df_fileptr      #       4
df_type         #	1
df_state        #	1
df_spare	#	2
 |
df_fileptr      #       4                 ; Offset from dirname to filename is [df_fileptr] >> 16
df_type         *       df_fileptr        ; LSB thereof (use LDRB/STRB)
df_state        *       df_fileptr + 1
 ]
df_size         #       0


; Values that df_type byte can take

dft_file        *       1
dft_dir         *       2
dft_partition   *       3
dft_applic      *       4

; Fields within df_state byte

dfs_selected    *       2_00000001
 [ ShowOpenDirs
dfs_opened      *       2_00000010 ; Added by Chris Murray
 ]
dfs_wasselected *       2_00000100


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; Filer global workspace allocation
; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

                        ^       0, wp

mytaskhandle            #       4       ; id so we can kill ourselves
privatewordaddr         #       4       ; so we can zap it

ViewerList              #       4
 ASSERT :INDEX: ViewerList = 8          ; Keep at offset 8 for ShowHeap
DirRequestList          #       4
 ASSERT :INDEX: DirRequestList = 12     ; Keep at offset 12 for ShowHeap
DirRequestEndLink       #       4       ; Pointer to last link in list

ApplicList              #       4       ; List of applications
ApplicListEndPointer    #       4       ; Pointer to pointer on end of chain.
ApplicDirList           #       4       ; List of directories containing applications
        [ version >= 130
ctrl_pressed            #       4       ; Was CTRL pressed when directory opened ?
        ]
initshiftstate          #       4       ; shiftstate when initiated operation
msgtrans_blockptr       #       4       ; pointer to message file block or 0 (not open, use global)

wimpextend              #       4
wimpr12                 #       4
wimplistat              #       4
wimpsprname             #       4

filetype_cache          #       4
redraw_all              #       4

lower_case_table        #       4       ; Pointer to Territory Manager lower case table.

fileraction_options     #       2       ; Options for Filer Action
layout_options          #       2       ; Options for layout
dclickhold_delay        #       4       ; Delay in cs for Double-Click-Hold

Filer_SmallWorkspaceSize *      :INDEX: @@

large_workspace_size    #       4       ; OSS Holds the actual size

; Keep tables within easy ADR range

mousedata               #       0
absmousex               #       4
absmousey               #       4
buttonstate             #       4

windowhandle            #       4
iconhandle              #       4

filebox1                #       4*4     ; x0,y0, x1,y1 for icon box
filebox3                #       4*4     ; x0,y0, x1,y1 for info box
; offsets in a filebox
fb_x0   *       0
fb_y0   *       4
fb_x1   *       8
fb_y1   *       12

initwindowinfo          #       0
initwindowx             #       4       ; where root dirviewers are displayed
initwindowy             #       4
initwindowwidth         #       4
initwindowheight        #       4
initwindow_xoff         #       4
initwindow_yoff         #       4


ms_writeable_filetype   #       8 + 1   ; Buffer for SetType
                 AlignSpace

; Variables need to be kept within LDR range

TempString              #       4       ; Pointer to temp string in Heap
                                        ; No reentrancy problems in Filer!

h_menuwindow_loc        #       4       ; 0 or pointer to location of Menu window handle
                                        ;       (one window created for whole menu tree)
type_menuwindow         #       4       ; Which window is the current menu window
menuwindow_displaysave  *       1
menuwindow_copysave     *       2
menuwindow_setaccess    *       3
menuwindow_infobox      *       4
menuwindow_newdir       *       5

csavebox_text           #       4       ; Pointer to copy save box text
newdirbox_text          #       4       ; Pointer to new dir save box text

;       Information for the poll_word processing
poll_word               #       4
poll_word_command_waiting *     1 :SHL: 0
poll_word_upcall_waiting *      1 :SHL: 1
poll_word_messagefile_closed *  1 :SHL: 2
 [ version >= 153
poll_word_recache_pending *     1 :SHL: 3
poll_word_force_poll    *       1 :SHL: 4
recache_delay           #       4
 ]
next_null_event_not_before_time # 4

messagetrans_struct     #       4*4

xwindsize               #       4       ; XMax (OS units)
ywindsize               #       4       ; YMax (OS units)

relmousex               #       4
relmousey               #       4

windowx                 #       4
windowy                 #       4

current_x0              #       4       ; NK used for system font printing
current_y0              #       4
current_justified       #       4
string_length           #       4
access_length           #       4
size_length             #       4
length_length           #       4
applic_length           #       4
char_length             #       4
date_length             #       4

init_buttonstate        #       0       ; Either need init buttonstate
dirtoclose              #       4       ; or dir to close, but not both

 [ version < 139
setplusfilesystem       #       4       ; info retained over opening dir
                                        ; to myself (not in broadcast)
 ]

dirnamelength           #       4
pboxwidth               #       4
maxwidth                #       4

 [ hastiny
tinydir                 #       4       ; Pointer to tinydir icon
 ]

sel_whandle             #       4       ; window handle where selection is
sel_dir                 #       4       ; -> dirviewer block where selection is
sel_dirname             #       4       ; -> dirname (in sel_dir block)
sel_fileblock           #       4       ; -> fileblock, Nowt otherwise
sel_filenumber          #       4
sel_filetype            #       4
sel_leafname            #       4       ; -> leafname or empty string

next_nullcount          #       4       ; number of bytes to ignore in next
                                        ; savedisplay transfer
first_viewerno          #       4       ; number of first viewer in next
                                        ; savedisplay transfer
displaysave_bufferp     # 4             ; pointer to displaysave buffer
displaysave_buffers     * &100          ; size of displaysave buffer
displaysave_buffer_rover # 4            ; rover through buffer
displaysave_buffer_bytes_in_it # 4      ; number of bytes in buffer.

menu_relmousex          #       4
menu_relmousey          #       4

ram_menustart           #       0

m_display               #       m_headersize + mi_size*9
m_options               #       m_headersize + mi_size*6
m_writeable_filename    #       m_headersize + mi_size*1
;m_writeable_cdirname    #       m_headersize + mi_size*1
m_writeable_filetype    #       m_headersize + mi_size*1
 [ version >= 155
m_writeable_findname    #       m_headersize + mi_size*1
 ]
m_file_access           #       m_headersize + mi_size*5
m_file                  #       m_headersize + mi_size*10
 [ AddSetDirectory
m_main                  #       m_headersize + mi_size*9
 |
m_main                  #       m_headersize + mi_size*8
 ]

ram_menuend             #       0

dvoffsetx               #       4       ; offset to next dirviewer
dvoffsety               #       4
mydateformat            #       48      ; Date format string
mydateformatlen         #       4       ; Length in OS units


lgi_height              #       4
lgi_width               #       4
smi_height              #       4
smi_width               #       4
i_textbuffer_size       *       256+20
;i_textbuffer            #       64      ; Icon text part
;i_textbuffer_end        #       0
i_spritebuffer          #       20      ; Icon sprite part
i_textbuffer_ptr        #       4       ; Pointer to icon text part
max_text_size           *       255
;max_text_size           *       i_textbuffer_end - i_textbuffer

dirnamebuffer           #       4      ; location of dirnamebuffer
dirnamebuffer_size      *       &800   ; size of dirnamebuffer

; Byte size variables
text_fgcolour           # 1
text_bgcolour           # 1
menu_reopen             # 1
menu_causedselection    # 1
menu_selchar            # 1     ; Indicates the state of the selection when the menu opened
hourglassstate          # 1

; drag_type holds which type of drag was last started
drag_type               # 1
drag_ignore             * 0
drag_file               * 1
drag_displaysave        * 2
drag_copysave           * 3
drag_selectmany         * 4
drag_adjustmany         * 5
drag_newdirsave         * 6


           AlignSpace   16

userdata_size           *       &400                  ; Handle on userdata size
userdata                #       userdata_size         ; nasty gp block

sortingbuffer_size      *       userdata_size         ; Reuse userdata for OS_HeapSort array pointers
sortingbuffer_entries   *       256                   ; Number of entries we can fit in buffer
sortingbuffer           *       userdata

           AlignSpace   16

 [ fonthack
fontrefarray            #       256
 ]

                 AlignSpace     16

ms_writeable_leafname   #       256 + 4 ; Buffer for Rename/CDir
                 AlignSpace     16
 [ version >= 138
ms_writeable_dirname   #        256 + 4 ; Buffer for CDir
                 AlignSpace     16
 ]

 [ version >= 155
ms_writeable_findname   #       32 + 4  ; Buffer for find; seems big enough since wildcards now allowed
 ]


; OSS pointers to templates and indirect icon buffers. The window must
; follow the indirected data, as we use the pointer to the window as the
; limit of the indirected data.

ind_faccesswindow_ptr   #       4
faccesswindow_ptr       #       4

ind_csavebox_ptr        #       4
csavebox_ptr            #       4

ind_newdirbox_ptr       #       4
newdirbox_ptr           #       4

ind_infobox_ptr         #       4
infobox_ptr             #       4

 [ :LNOT: actionwind
ind_daccesswindow_ptr   #       4
daccesswindow_ptr       #       4
  [ debug
dacstring               #       4
  ]
 ]

 [ AltRenaming
renaming_chunkaddr      #       4      ; address of the memory used by Alt+Select renaming
 ]
largeicon_truncation    #       4      ; maximum width (OS units) allowed for a filename in large icon display
largeicon_truncation_mp #       4      ; maximum width in milipoints
smallicon_truncation    #       4      ; maximum width allowed for a small icon display filename
smallicon_truncation_mp #       4
fullinfo_truncation     #       4      ; maximum width allowed for a full info display filename
fullinfo_truncation_mp  #       4
ellipsis_width          #       4      ; width of an ellipsis (Œ) in the desktop font
was_seldir              #       4      ; The last directory selected.
last_drag_type          #       4      ; The type of the last drag
 [ ursulawimp
titlebartoolwidth       #       4      ; width taken up by tool icons in title bar
 ]
           AlignSpace   16
 [ debug
stackcheck              #       0
 ]
stackbot                #       &400
stacktop                #       0




; Dir window is inline on the end so we can still "wsaddr" it, since it is
; the most heavily used window. The indirected icons for it are thrown away.

ms_main_filexxx         #       63 + 1 ; for the terminator

CanonicalSpace          #       256

dirwindow               #       0

Filer_WorkspaceSize     *       :INDEX: @@


 ! 0, "Filer workspace is ":CC:(:STR:(:INDEX:@@)):CC:" bytes"
 ! 0, "Other workspace is ":CC:(:STR:(re_chunksize+dirnamebuffer_size+i_textbuffer_size)):CC:" bytes"

        END
@


4.10
log
@Add support for sorting dir contents numerically as well as alphabetically
New option to the display menu "Numerical sort" modifies the existing 4 sort methods (name, size, type, date) to sort by interpreting any numbers as cardinals. This modifier only really has effect on "Sort by name" since the other three already sort numerically.
This means for example a dir containing "File9,File10,File11" will appear in that order, whereas sorting by name alone would show "File10,File11,File9".

SelStuff0.s/SelStuff.s/Gets.s: Removed. Single function placed into SelStuff.
ModHdr.s/OpenDir.s/Commands.s/DebugFlags.s: Decoding of -NumericalSort switch, switched out undocumented 'Query' flags.
DecodeMenu.s/MenuCreate.s: Handle menu entry, simplify rename code a little.
HelpSrc.s/Messages: Extra help text.
SortDir.s: Pass option flag to Territory_Collate.
WkspEtc.s: Corrected definition of db_sm_type and db_sm_size.

Version 2.34. Tagged as 'Filer-2_34'
@
text
@a501 5
 [ debug
stackcheck              #       0
 ]
stackbot                #       &200
stacktop                #       0
d560 8
@


4.9
log
@Fix asasm 2.00 error
Detail:
  s/WkspEtc - Fixed missing colon on end of :LNOT:
Admin:
  No change to binary under objasm


Version 2.29. Retagged as 'Filer-2_29'
@
text
@d211 2
d223 2
a224 2
db_sm_size      *       1
db_sm_type      *       2
d434 1
a434 1
m_display               #       m_headersize + mi_size*8
@


4.8
log
@Fix for 'set type' writeable icon being out of step with the disc.
Adjust clicking would recreate the menu immediately after the operation but before the next wimp poll when the directory gets recached, so the first entry in the cache is manually fixed up so the recreated menu is right (the files all get refreshed later anyway).
Collapsed switch 'Fix003', after 21 years of testing it's safe to assume it's good.
Reinstated ExtractCMOSOptions conditional on not OptionsAreInRAM so that combination still assembles.
Optimise MUL/ADD into MLA where possible, and set 'S' flag on ALU operations when followed by TEQ#0.
Tested with & without filer action running, fixes ticket 254.

Version 2.26. Tagged as 'Filer-2_26'
@
text
@d540 1
a540 1
 [ :LNOT actionwind
@


4.7
log
@Fix missing 'Refresh' option in filer menu
Detail:
  A bad merge of some kind meant that the size of m_main was decreased by one entry between revisions 4.5 and 4.6 of s/WkspEtc, causing the menu code to chop the last item off of the menu (the 'Refresh' item, as listed in s/MenuCreate).
  This change fixes the size of m_main so that the number of items matches the number in s/MenuCreate.
Admin:
  Tested on rev C2 beagleboard.
  Fixes bug #233.


Version 2.23. Tagged as 'Filer-2_23'
@
text
@a54 7
$label  FixDCB  $n, $string
        ASSERT  ((:LEN:"$string")<$n)
$label  DCB     "$string", 13
        %       ($n-1-(:LEN:"$string"))
        MEND

        MACRO
d242 1
a243 1
 [ not_16bit_offsets
d248 1
a269 1
; Offset from dirname to filename is [df_fileptr] >> 16
@


4.6
log
@  Add the ability to sort Filer objects in reverse order
Detail:
  It's been possible to sort Filer objects using various criteria for a long
  time but sorting objects in reverse order was not possible. This change aims
  to remedy that omission.
  The option 'Reverse sort' has been added to the 'Display' submenu of the
  Filer menu, allowing the sort order of individual directory viewers to be
  changed dynamically.
  The switch -ReverseSort has been added to the command Filer_OpenDir to allow
  it to open directories with the sort order reversed.
  The switch -ReverseSort has been added to the Filer_Layout command so that
  reverse sort order can be set as default for new directory viewers. The
  Filer_Layout command is also written to the FlrSetup file in Choices:Boot.
  Tasks by the Filer configure plug-in (which has been also updated to allow
  -ReverseSort).
Admin:
  Tested on Iyonix RO5.14


Version 2.22. Tagged as 'Filer-2_22'
@
text
@d450 2
a452 2
 |
m_main                  #       m_headersize + mi_size*7
@


4.5
log
@  Make doubleclick-and-hold configurable
Detail:
  Added the command Filer_DClickHold to the Filer.
  It allows you to specify how long the second click of a doubleclick must be
  held down for before it is seen as a doubleclick-and-hold.
  The delay is specified in centiseconds, setting the delay to zero turns
  doubleclick-and-hold off.
Admin:
  Tested on Iyonix RO5.14
  Submitted by Fred Graute, mid-December 2009

Version 2.21. Tagged as 'Filer-2_21'
@
text
@d216 2
d439 1
a439 1
m_display               #       m_headersize + mi_size*7
d450 1
a450 1
m_main                  #       m_headersize + mi_size*9
d452 1
a452 1
m_main                  #       m_headersize + mi_size*8
@


4.4
log
@  Added a refresh item to the filer main menu.
Detail:
  When viewing directories on some network filing systems it is possible
  for the directory contents to change without the client knowing, and
  therefore the filer window becomes out of date. This refresh option
  can be used by the user to bring the window up to date without having
  to close and reopen it.
  It matches the same option provided on later versions of RISC OS 4.
Admin:
  Tested on Iyonix RISC OS 5.11
Notes:
  Changed by Alex Waugh.

Version 2.12. Tagged as 'Filer-2_12'
@
text
@d312 1
@


4.3
log
@  Misc bugfixes.
Detail:
  * Mered in RISCOS Ltd's fix for directory displays with more than 65536
    bytes of leafnames.
  * Tries to use Wimp_TextOp 4 to do ellipsis truncation. As a result, it
    can now cope properly with:
    + multibyte UTF-8 characters in leafnames (previously this caused
      problems even if not truncated)
    + WimpSymbol character substitution in leafnames
    + alphabets without an ellipsis character
    + fonts without an ellipsis character
  * Sprite icons in 'Copy as' and 'New directory' dialogue boxes are no
    longer filled.
Admin:
  Tested on Tungsten.

Version 2.08. Tagged as 'Filer-2_08'
@
text
@d447 2
a449 2
 |
m_main                  #       m_headersize + mi_size*7
@


4.2
log
@Merged Ursula branch.
Moved to srccommit.

Version 1.96. Tagged as 'Filer-1_96'
@
text
@d68 1
a68 1
        MEND            
d154 1
a154 1
; 
d157 1
a157 1
; 
d170 1
a170 1
d_smiwidth      #       4               ; width of icon columns (NK new wimp release)   
d248 5
d255 1
d315 1
a315 1
large_workspace_size    #       4       ; OSS Holds the actual size 
d392 1
a392 1
size_length             #       4       
d501 1
a501 1
sortingbuffer           *       userdata 
d509 1
a509 1
 
d517 1
a517 1
                 AlignSpace     16    
@


4.1
log
@Initial revision
@
text
@d98 26
d266 1
d304 3
d317 1
d337 1
d353 1
d356 1
a371 1

d431 1
a431 1
m_options               #       m_headersize + mi_size*4
d433 1
a433 1
m_writeable_cdirname    #       m_headersize + mi_size*1
d458 3
a460 2
i_textbuffer            #       64      ; Icon text part
i_textbuffer_end        #       0
d462 6
a467 1
max_text_size           *       i_textbuffer_end - i_textbuffer
a469 1

d476 1
d485 1
d490 2
d493 3
a495 10

dirnamebuffer           #       &100

 [ openat
userdata_size           *       &400    ; Handle on userdata size
 ]
userdata                #       userdata_size   ; nasty gp block
sortingbuffer           *       userdata        ; reused - need at least 256 words
                                        ; for the sorting array pointers

d532 3
d546 16
d574 1
d576 1
@


4.1.4.1
log
@Alt + Select renaming added
@
text
@a98 29
; Memory required for alt click renaming

 [ version >=186

                   ^       0
re_windowhandle    #       4    ; The handle of the window the writeable icon is in
re_iconhandle      #       4    ; The icon handle of the writeable icon
re_createiconblock #       0    ; A block for creating the icon...
re_createwhandle   #       4    ;   - handle to create in
re_icondata        #       0    ;   - 32 byte icon data...
re_minx            #       4    ;       - bounding box
re_miny            #       4    ;
re_maxx            #       4    ;
re_maxy            #       4    ;
re_flags           #       4    ;       - flags
re_textptr         #       4    ;       - pointer to text buffer
re_validptr        #       4    ;       - pointer to validation string
re_bufflength      #       4    ;       - buffersize
re_textstring      #       256  ; Memory to hold the icon's text
re_validstring     #       32   ; Memory to hold icon's validation string
re_tempdata        #       32   ; Temporary data store
re_dirblock        #       4    ; pointer to directory block for the file being renamed
re_fileblock       #       4    ; pointer to file block for the file being renamed
re_chunksize       *       :INDEX: @@

 ! 0, "Renaming workspace is ":CC:(:STR:(:INDEX:@@)):CC:" bytes"
 ]

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
a286 1

a305 1

d338 1
a507 4
; Writeable rename stuff
 [ version >=186
renaming_chunkaddr     #        4
 ]
a518 1

@


4.1.4.2
log
@A few changes to Alt+Select renaming
@
text
@d118 1
a118 1
re_validstring     #       48   ; Memory to hold icon's validation string
@


4.1.4.3
log
@Long filename support and SaveAs style new directory creation
@
text
@d101 2
d125 1
a305 1

a351 1
menuwindow_newdir       *       5
a353 1
newdirbox_text          #       4       ; Pointer to new dir save box text
d430 1
a430 1
;m_writeable_cdirname    #       m_headersize + mi_size*1
d455 2
a456 2
;i_textbuffer            #       64      ; Icon text part
;i_textbuffer_end        #       0
d458 1
a458 3
i_textbuffer_ptr        #       4       ; Pointer to icon text part
max_text_size           *       255
;max_text_size           *       i_textbuffer_end - i_textbuffer
a475 1
drag_newdirsave         * 6
a526 3
ind_newdirbox_ptr       #       4
newdirbox_ptr           #       4

d538 4
a541 8
renaming_chunkaddr      #       4      ; address of the memory used by Alt+Select renaming
largeicon_truncation    #       4      ; maximum width (OS units) allowed for a filename in large icon display
largeicon_truncation_mp #       4      ; maximum width in milipoints
smallicon_truncation    #       4      ; maximum width allowed for a small icon display filename
smallicon_truncation_mp #       4
fullinfo_truncation     #       4      ; maximum width allowed for a full info display filename
fullinfo_truncation_mp  #       4
ellipsis_width          #       4      ; width of an ellipsis (Œ) in the desktop font
@


4.1.4.4
log
@Added code to enable files to be copied to icon bar device icons
@
text
@a265 1
dfs_wasselected *       2_00000100
a551 2
was_seldir              #       4      ; The last directory selected.
last_drag_type          #       4
@


4.1.4.5
log
@Add new options to Options menu, plus fixed bugs
@
text
@a303 1
fileraction_options     #       4      ; Options for Filer Action
d429 1
a429 1
m_options               #       m_headersize + mi_size*6
d554 1
a554 1
last_drag_type          #       4      ; The type of the last drag
@


4.1.4.6
log
@Fixed bug with system font in Filer windows, plus redraw of highlighted icons.
@
text
@d122 2
a456 1
i_textbuffer_size       *       256+20
d464 1
a464 2
dirnamebuffer           #       4      ; location of dirnamebuffer
dirnamebuffer_size      *       &400   ; size of dirnamebuffer
a465 1
; Byte size variables
a471 1

d485 4
d495 2
a569 1
 ! 0, "Other workspace is ":CC:(:STR:(re_chunksize+dirnamebuffer_size+i_textbuffer_size)):CC:" bytes"
@


4.1.4.7
log
@A *Filer_Layout command now replaces CMOS setting of the display options.
Fixed bug which meant dirviews weren't sorted if they had >256 entries.
Increased dirnamebuffer to 2K to cope with long pathname renames.
@
text
@d302 1
a302 2
fileraction_options     #       2       ; Options for Filer Action
layout_options          #       2       ; Options for layout
d464 1
a464 1
dirnamebuffer_size      *       &800   ; size of dirnamebuffer
d487 6
a492 7
userdata_size           *       &400                  ; Handle on userdata size
userdata                #       userdata_size         ; nasty gp block

sortingbuffer_size      *       userdata_size         ; Reuse userdata for OS_HeapSort array pointers
sortingbuffer_entries   *       256                   ; Number of entries we can fit in buffer
sortingbuffer           *       userdata 

@


4.1.4.8
log
@Changed font width calculation code.
@
text
@a97 2

 [ AltRenaming
d100 1
a120 1
 ]
a543 1
 [ AltRenaming
a544 1
 ]
@


4.1.4.9
log
@Autoscrolling windows added.
Now reads icon bar tool widths so window title isn't obscured by iconise tool.
@
text
@a557 4
 [ ursulawimp
titlebartoolwidth       #       4      ; width taken up by tool icons in title bar
 ]

@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@@


4.1.5.1
log
@Import from SrcFiler
@
text
@@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
