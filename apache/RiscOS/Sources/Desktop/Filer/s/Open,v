head	4.6;
access;
symbols
	Filer-2_43:4.6
	Filer-2_42:4.6
	Filer-2_41:4.5
	Filer-2_40:4.5
	Filer-2_39:4.5
	Filer-2_38:4.5
	Filer-2_37:4.5
	Filer-2_36:4.4
	Filer-2_35:4.4
	Filer-2_34:4.4
	Filer-2_33:4.4
	Filer-2_32:4.4
	Filer-2_31:4.4
	Filer-2_30:4.4
	Filer-2_29:4.4
	Filer-2_28:4.4
	Filer-2_27:4.4
	Filer-2_26:4.4
	Filer-2_25:4.4
	Filer-2_24:4.4
	Filer-2_23:4.4
	Filer-2_22:4.4
	Filer-2_21:4.4
	Filer-2_20:4.4
	Filer-2_19:4.4
	Filer-2_18:4.4
	Filer-2_17:4.4
	Filer-2_16:4.4
	Filer-2_15:4.4
	Filer-2_14:4.4
	Filer-2_13:4.4
	Filer-2_12:4.4
	Filer-2_11:4.4
	Filer-2_10:4.4
	Filer-2_09:4.4
	RO_5_07:4.4
	Filer-2_08:4.4
	Filer-2_07:4.4
	Filer-2_06:4.4
	Filer-2_05:4.4
	Filer-2_04:4.3
	Filer-2_03:4.3
	Filer-2_02:4.3
	Filer-2_01:4.3
	Filer-2_00:4.2
	Filer-1_99:4.2
	Filer-1_98:4.2
	Filer-1_97:4.2
	Ursula_merge:4.1.4.6
	Filer-1_96:4.2
	Filer-1_95:4.1.4.6
	nturton_Filer-1_85:4.1
	mstphens_UrsulaRiscPCBuild_20Nov98:4.1.4.6
	Ursula_RiscPC:4.1.4.6.0.2
	rthornb_UrsulaBuild-19Aug1998:4.1.4.6
	UrsulaBuild_FinalSoftload:4.1.4.6
	rthornb_UrsulaBuild-12Aug1998:4.1.4.6
	aglover_UrsulaBuild-05Aug1998:4.1.4.6
	rthornb_UrsulaBuild-29Jul1998:4.1.4.6
	rthornb_UrsulaBuild-22Jul1998:4.1.4.6
	rleggett_Filer-1_94:4.1.4.6
	rthornb_UrsulaBuild-15Jul1998:4.1.4.6
	rthornb_UrsulaBuild-07Jul1998:4.1.4.6
	rthornb_UrsulaBuild-17Jun1998:4.1.4.6
	rthornb_UrsulaBuild-03Jun1998:4.1.4.6
	rthornb_UrsulaBuild-27May1998:4.1.4.6
	rleggett_Filer-1_93:4.1.4.6
	rthornb_UrsulaBuild-21May1998:4.1.4.6
	rthornb_UrsulaBuild_01May1998:4.1.4.6
	Spinner_B20_2:4.1.7.1
	Spinner_19_3:4.1.7.1
	Spinner_B18:4.1.7.1
	Spinner_B17:4.1.7.1
	Spinner_B15:4.1.7.1
	Spinner_B14:4.1.7.1
	Spinner_B13:4.1.7.1
	Spinner_B12:4.1.7.1
	Spinner_B10:4.1.7.1
	Daytona:4.1.0.6
	Daytona_bp:4.1
	Ursula:4.1.0.4
	Ursula_bp:4.1
	Spinner_B7:4.1.7.1
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	ARTtmp:4.1.7.1.0.2
	Spin_merge:4.1.7.1
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.6
date	2016.05.08.16.40.49;	author jlee;	state Exp;
branches;
next	4.5;
commitid	jgXcaWoXY2TwnH5z;

4.5
date	2014.06.29.10.37.14;	author jlee;	state Exp;
branches;
next	4.4;
commitid	4jLNa6WihVxYbpGx;

4.4
date	2002.11.12.20.43.55;	author rsprowson;	state Exp;
branches;
next	4.3;

4.3
date	2001.03.16.17.09.23;	author sbrodie;	state Exp;
branches;
next	4.2;

4.2
date	99.08.17.11.56.37;	author sbrodie;	state Exp;
branches;
next	4.1;

4.1
date	96.11.05.09.29.26;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.4.1
	4.1.5.1
	4.1.7.1;
next	;

4.1.1.1
date	96.11.05.09.29.26;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.05.23.27.28;	author nturton;	state Exp;
branches;
next	;

4.1.4.1
date	97.05.21.16.25.26;	author kbracey;	state Exp;
branches;
next	4.1.4.2;

4.1.4.2
date	97.05.27.11.13.29;	author rleggett;	state Exp;
branches;
next	4.1.4.3;

4.1.4.3
date	97.08.27.09.09.05;	author rleggett;	state Exp;
branches;
next	4.1.4.4;

4.1.4.4
date	97.10.21.09.38.33;	author rleggett;	state Exp;
branches;
next	4.1.4.5;

4.1.4.5
date	98.03.27.09.26.16;	author rleggett;	state Exp;
branches;
next	4.1.4.6;

4.1.4.6
date	98.04.27.10.26.12;	author rleggett;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.12.16.48;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.20.16.10;	author nturton;	state Exp;
branches;
next	;


desc
@@


4.6
log
@Avoid unnecessary remainder calculations
Detail:
  s/Open - Avoid unnecessary remainder calculations in DivRem macro
Admin:
  Tested on Cortex-A15


Version 2.42. Tagged as 'Filer-2_42'
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
;
; event_open_window
; =================

; In    r1 -> wimp_eventstr (not necessarily in userdata)
;             [r1, #0]  window handle
;             [r1, #4]  window x0
;             [r1, #8]         y0
;             [r1, #12]        x1
;             [r1, #16]        y1
;             [r1, #20] scroll x
;             [r1, #24] scroll y
;             [r1, #28] behind handle

; Out   regs preserved as we are called from other places as well as from Poll

event_open_window Entry "r1-r11"

        LDR     r0, [r1, #u_handle]     ; r0 = window handle to open
 [ debugredraw
 DREG r0, "open_window: window ",,Integer
 ]
        BL      FindDir                 ; r4 -> dirviewer block
        BNE     %FT80                   ; [not a dirviewer; just open it]


        LDR     r9, [r1, #u_wax0]       ; keep for below
        LDR     r8, [r1, #u_wax1]
        SUB     r8, r8, r9              ; r8 := requested width of window

; Need to know size of dirname in OS units


        LDR     r10, [r4, #d_dirnamestore] ; r10 -> dirname

 [ ursulawimp
        LDR     r0, titlebartoolwidth
 |
        MOV     r0, #6*charx            ; add 6 as we have back + close boxes
 ]
01
        [ {FALSE}
        LDRB    r14, [r10], #1          ; and lhs/rhs gaps to consider too
        CMP     r14, #space             ; spaces are included here
        ADDHS   r0, r0, #charx
        BHS     %BT01
        |
        MOV     R14,R1
        MOV     R1,r10
        MOV     R10,r0
        MOV     R0,#1
        Push    "R2"
        MOV     R2,#0
        SWI     XWimp_TextOp
        Pull    "R2"
        MOV     R1,R14
        ADD     R0,R0,R10
        ]
        STR     r0, dirnamelength

        BL      GetItemBoxSize          ; r11,r14 := item box size (x, y)
        STR     r11, pboxwidth          ; r14 is not needed here

        ; Find the number of columns which fit into the screen width, less
        ; the width of the vertical scroll bar and the directory viewer
        ; right hand side gap. Minimum allowed 0. Result in r7.
        LDR     r2, xwindsize
 [ bug1596
        SUB     r2, r2, #vscroll_width+dvr_rhsgap
 |
        SUB     r2, r2, #vscroll_width
 ]
        DivRem  r7, r2, r11, r14, norem
        CMP     r7, #1
        MOVLT   r7, #1

        ; From the number of columns, calculate the maximum window width
        ; we're going to allow as
        ; number_of_columns*width_of_column + dvr_rhsgap
        ; Answer stored in maxwidth and r2.
        MUL     r2, r7, r11
        ADD     r2, r2, #dvr_rhsgap
        STR     r2, maxwidth

 [ debugredraw
 DREG r8, "requested window width = ",,Integer
 DREG r0, "dirname length = ",,Integer
 DREG r11, "one object width = ",,Integer
 DREG r7, "max. objects = ",,Integer
 DREG r2, "maxwidth to clip = ",,Integer
 ]
        ; If width requested exceeds maxwidth, then limit it to maxwidth
        ; and set d_filesperrow to 0 to force a re-evaluation of the columns
        ; and window extents.
        CMP     r8, r2
        MOVHI   r8, r2
 [ centralwrap
        MOVHI   r14, #db_fpr_invalid
 |
        MOVHI   r14, #0
 ]
        STRHIB  r14, [r4, #d_filesperrow]
 [ debugredraw
 BLS %FT00
 DREG r8,"reduced window width = ",,Integer
00
 ]

        ; If d_filesperrow if 0 or &ff then recalculate window width, and
        ; force it to be that.
        LDRB    r14, [r4, #d_filesperrow] ; If 0, need a rethink
 [ centralwrap
        TEQ     r14, #db_fpr_invalid
        TEQNE   r14, #db_fpr_stuffed
 |
        TEQ     r14, #0
        TEQNE   r14, #&FF               ; or if stuffed
 ]
        BNE     %FT10

; Ensure dirname and one object always visible when first pop up window
; or go reshape

 [ debugredraw
 DLINE "Need a serious rethink"
 ]
 [ bug1596
        SUB     r8, r8, #dvr_rhsgap     ; Don't include the rhsgap when dividing
 ]
        DivRem  r7, r8, r11, r14, norem ; r7 := no of boxes that fit across
        CMP     r7, #1                  ; in requested width of window
        MOVLT   r7, #1                  ; at least 1 column! Rounding down
        MUL     r8, r7, r11             ; Set width to accomodate an integer no
 [ bug1596
        ADD     r8, r8, #dvr_rhsgap     ; Add the rhsgap back in.
 ]

        max     r8, r0                  ; r8 = max(dirname, adjusted request)
        CMP     r8, r2
        MOVHI   r8, r2                  ; reapply maxwidth, dirname might be wider than screen

 [ debugredraw
 DREG r8,"adjusted window width = ",,Integer
 ]
        ADD     r14, r9, r8             ; Adjust width in window block
        STR     r14, [r1, #u_wax1]


10 ; Work out how many objects fit across dirviewer at current window width

 [ bug1596
        ; Remove rhs gap for calculation, include rhs slack to avoid
        ; immediate reshape when user narrows viewer.
        SUB     r8, r8, #dvr_rhsgap-dvr_rhsslack
 |
        ADD     r8, r8, #dvr_rhsgap     ; Nobble rhs gap
 ]
        DivRem  r7, r8, r11, r14, norem ; r7 := no of boxes that fit across
        CMP     r7, #1                  ; in this width of window
        MOVLT   r7, #1                  ; at least 1 column!

; If this is different to that from last time, then we must reshape contents

        LDRB    r14, [r4, #d_filesperrow]
 [ debugredraw
 DREG r7,"we could filesperrow = ",,Integer
 DREG r14,"old filesperrow = ",,Integer
 ]
        CMP     r14, r7
        BEQ     %FT80                   ; [don't reshape window, just open]

        LDR     r14,renaming_chunkaddr
        LDR     r14,[r14,#re_windowhandle]
        LDR     r0, [r4, #d_handle]
        TEQ     r0,r14
        BLEQ    remove_rename_writeable ; only remove the rename writeable if the window it is in is being
                                        ; reopened

 [ debugredraw
 DREG r7,"Need contents reshaping; new filesperrow := ",,Integer
 ]
        STRB    r7, [r4, #d_filesperrow]

; Calculate new y extent of window (for v scroll bar)

        LDR     r14, [r4, #d_nfiles]    ; If empty directory, set extent
 [ centralwrap
        TEQ     r14, #0                 ; to the same as the minimum height
        MOVEQ   r9, #0
 |
        TEQ     r14, #0                 ; to the same as the requested height
        LDREQ   r9, [r1, #u_way0]
 ]
        BEQ     %FT70

        MOV     r5, #df_size            ; Get at the last file in dirviewer
        MUL     r5, r14, r5
        ADD     r5, r5, #d_headersize - df_size ; File 1 is at offset 0 etc.
        MOV     r3, #1                  ; last file in list!
        BL      GetFileBox              ; get relative to work area origin

        LDR     r9, filebox1 + fb_y0    ; by := y0 of last file
        SUB     r9, r9, #dvr_botgap     ; small gap at bottom of dirviewer


 [ version >= 113
70 ; Calculate new x extent of window:
; min( maxwidth, max( dirnamelength, col_width*nfiles))

        ; r10 = col_width * nfiles + edge gap
        LDR     r14, [r4, #d_nfiles]
        LDR     r10, pboxwidth
        MUL     r10, r14, r10
        ADD     r10, r10, #dvr_rhsgap

        ; r10 = max( r10, dirnamelength )
        LDR     r14, dirnamelength
        max     r10, r14

        ; r10 = min( r10, maxwidth )
        LDR     r14, maxwidth
        min     r10, r14
 |
70 ; Calculate new x extent of window. Never less than dirnamewidth

        ; r10 = dirviewer->nfiles * pboxwidth + dvr_rhsgap
        LDR     r14, [r4, #d_nfiles]
        LDR     r10, pboxwidth
        MUL     r10, r14, r10
   [ bug1596
        ADD     r10, r10, #dvr_rhsgap
   ]

        ; r10 = min( r10, maxwidth ) to clip against screen edge
        LDR     r14, maxwidth
        min     r10, r14

        ; r10 = max( r10, dirnamelength ) to ensure is at least as wide
        ; as title
        LDR     r14, dirnamelength      ; OS units
        max     r10, r14
 ]

        MOV     r8, #0                  ; lx := 0
        MOV     r11, #0                 ; ty := 0

        LDR     r0, [r4, #d_handle]
        STR     r0, [sp, #-80-4]!       ; remember for forcing redraw
        ADD     r1, sp, #4              ; create temp frame
        STMIA   r1, {r8-r11}
 [ debugredraw
 DREG r0,  "Wimp_SetExtent: window ",cc,Integer
 DREG r8,  " lx ",cc,Integer
 DREG r9,  " by ",cc,Integer
 DREG r10, " rx ",cc,Integer
 DREG r11, " ty ",,Integer
 ]
        SWI     XWimp_SetExtent         ; reset size of window
        LDR     r0, [sp], #80+4         ; restore stack, r0

        MOV     r1, #-bignum            ; All of this window needs repainting
        MOV     r2, #-bignum
        MOV     r3, #bignum
        MOV     r4, #bignum
        SWI     XWimp_ForceRedraw


80      LDRVC   r1, [sp, #0*4]
        SWIVC   XWimp_OpenWindow
        EXIT

        END
@


4.5
log
@Fix incorrect d_filesperrow calculation when directory path name is wider than the screen
Detail:
  s/Open - When widening the viewer width so that the full directory name is visible, clamp the value to the screen width before calculating d_filesperrow. Without this fix the window width will get clamped to the screen width (by the Wimp?), but d_filesperrow will reflect the pre-clamp value, potentially causing one or more columns of files to be placed outside the window bounds until the window is next resized.
  s/Errors, s/GoFiler, s/Redraw - Swap some ADRs for ADRL and fix a typo that prevented the module from building when debugging was enabled
Admin:
  Tested on BB-xM with some long path names and 640x480 screen


Version 2.37. Tagged as 'Filer-2_37'
@
text
@d88 1
a88 1
        DivRem  r7, r2, r11, r14
d145 1
a145 1
        DivRem  r7, r8, r11, r14        ; r7 := no of boxes that fit across
d173 1
a173 1
        DivRem  r7, r8, r11, r14        ; r7 := no of boxes that fit across
@


4.4
log
@Picked up bug fix from ROL,in 2.04 you could select a file in one viewer
and then adjust select a group in another viewer without the first
file becoming unselected.
Added test so you're less likely to lose the "rename" writeable icon
when someone's updating filer windows.Now,only if the window being
reopened also has the writeable in it will you lose it.
Adjust dragging dirs to the icon bar will now close the parent (was
only files and apps before).
Create dir and Copy as templates tweaked for 3d borders in UK only as
the German ones are very out of date anyway.

Version 2.05. Tagged as 'Filer-2_05'
@
text
@d154 2
@


4.3
log
@  Updated build structure to use the shared AAsmModule makefile.
  Updated to build using objasm instead of aasm.
  Sources changed to be objasm-compatible.
Admin:
  Requires Library 0.71 or later.
  Requires BuildSys 3.06 or later.
  Requires Env 0.65 or later.

Version 2.01. Tagged as 'Filer-2_01'
@
text
@d185 6
a190 1
        BL      remove_rename_writeable
@


4.2
log
@Merged Ursula branch.
Moved to srccommit.

Version 1.96. Tagged as 'Filer-1_96'
@
text
@d32 2
a33 2
event_open_window ENTRY "r1-r11"
        
d48 1
a48 1
 
d56 1
a56 1
01      
@


4.1
log
@Initial revision
@
text
@d33 1
a33 1

d48 1
d50 4
d55 1
d184 2
@


4.1.4.1
log
@Made to check for iconise button when widthing windows
@
text
@d49 2
a50 5
	MOV	r0, #WimpSysInfo_IconiseButton
	SWI	XWimp_ReadSysInfo
	MOVVS	r0, #0
        ADD     r0, r0, #6*charx        ; add 6 as we have back + close boxes
01
@


4.1.4.2
log
@Alt + Select renaming added
@
text
@a33 4
        [ version >=186
        BL      remove_rename_writeable
        ]
        
@


4.1.4.3
log
@Long filename support and SaveAs style new directory creation
@
text
@d33 4
d53 5
a57 2
        MOV     r0, #6*charx            ; add 6 as we have back + close boxes
01      
a184 4

        [ version >=186
        BL      remove_rename_writeable
        ]
@


4.1.4.4
log
@Fixed bug with system font in Filer windows, plus redraw of highlighted icons.
@
text
@d179 1
d181 1
@


4.1.4.5
log
@Added service call table, used by Ursula kernel.
@
text
@a49 1
        ADD     r0, r0, #3*charx        ; RML: bodge for iconise icon
@


4.1.4.6
log
@Autoscrolling windows added.
Now reads icon bar tool widths so window title isn't obscured by iconise tool.
@
text
@a47 1
 
a48 4

 [ ursulawimp
        LDR     r0, titlebartoolwidth
 |
d50 1
a50 1
 ]
@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@@


4.1.5.1
log
@Import from SrcFiler
@
text
@@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
