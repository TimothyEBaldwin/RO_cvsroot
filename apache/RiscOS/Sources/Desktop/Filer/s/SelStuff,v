head	4.5;
access;
symbols
	Filer-2_43:4.5
	Filer-2_42:4.5
	Filer-2_41:4.5
	Filer-2_40:4.5
	Filer-2_39:4.5
	Filer-2_38:4.5
	Filer-2_37:4.5
	Filer-2_36:4.5
	Filer-2_35:4.5
	Filer-2_34:4.5
	Filer-2_33:4.4
	Filer-2_32:4.4
	Filer-2_31:4.4
	Filer-2_30:4.4
	Filer-2_29:4.4
	Filer-2_28:4.4
	Filer-2_27:4.4
	Filer-2_26:4.4
	Filer-2_25:4.4
	Filer-2_24:4.4
	Filer-2_23:4.4
	Filer-2_22:4.4
	Filer-2_21:4.4
	Filer-2_20:4.4
	Filer-2_19:4.4
	Filer-2_18:4.4
	Filer-2_17:4.4
	Filer-2_16:4.4
	Filer-2_15:4.4
	Filer-2_14:4.4
	Filer-2_13:4.4
	Filer-2_12:4.4
	Filer-2_11:4.4
	Filer-2_10:4.4
	Filer-2_09:4.4
	RO_5_07:4.4
	Filer-2_08:4.4
	Filer-2_07:4.3
	Filer-2_06:4.3
	Filer-2_05:4.3
	Filer-2_04:4.3
	Filer-2_03:4.3
	Filer-2_02:4.3
	Filer-2_01:4.3
	Filer-2_00:4.2
	Filer-1_99:4.2
	Filer-1_98:4.2
	Filer-1_97:4.2
	Ursula_merge:4.1.4.1
	Filer-1_96:4.2
	Filer-1_95:4.1.4.1
	nturton_Filer-1_85:4.1
	mstphens_UrsulaRiscPCBuild_20Nov98:4.1.4.1
	Ursula_RiscPC:4.1.4.1.0.2
	rthornb_UrsulaBuild-19Aug1998:4.1.4.1
	UrsulaBuild_FinalSoftload:4.1.4.1
	rthornb_UrsulaBuild-12Aug1998:4.1.4.1
	aglover_UrsulaBuild-05Aug1998:4.1.4.1
	rthornb_UrsulaBuild-29Jul1998:4.1.4.1
	rthornb_UrsulaBuild-22Jul1998:4.1.4.1
	rleggett_Filer-1_94:4.1.4.1
	rthornb_UrsulaBuild-15Jul1998:4.1.4.1
	rthornb_UrsulaBuild-07Jul1998:4.1.4.1
	rthornb_UrsulaBuild-17Jun1998:4.1.4.1
	rthornb_UrsulaBuild-03Jun1998:4.1.4.1
	rthornb_UrsulaBuild-27May1998:4.1.4.1
	rleggett_Filer-1_93:4.1.4.1
	rthornb_UrsulaBuild-21May1998:4.1.4.1
	rthornb_UrsulaBuild_01May1998:4.1.4.1
	Spinner_B20_2:4.1.7.1
	Spinner_19_3:4.1.7.1
	Spinner_B18:4.1.7.1
	Spinner_B17:4.1.7.1
	Spinner_B15:4.1.7.1
	Spinner_B14:4.1.7.1
	Spinner_B13:4.1.7.1
	Spinner_B12:4.1.7.1
	Spinner_B10:4.1.7.1
	Daytona:4.1.0.6
	Daytona_bp:4.1
	Ursula:4.1.0.4
	Ursula_bp:4.1
	Spinner_B7:4.1.7.1
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	ARTtmp:4.1.7.1.0.2
	Spin_merge:4.1.7.1
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.5
date	2013.11.24.12.33.02;	author rsprowson;	state Exp;
branches;
next	4.4;
commitid	qgjIfJ3IKLI7Owex;

4.4
date	2003.02.04.14.30.59;	author bavison;	state Exp;
branches;
next	4.3;

4.3
date	2001.03.16.17.09.23;	author sbrodie;	state Exp;
branches;
next	4.2;

4.2
date	99.08.17.11.56.43;	author sbrodie;	state Exp;
branches;
next	4.1;

4.1
date	96.11.05.09.29.31;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.4.1
	4.1.5.1
	4.1.7.1;
next	;

4.1.1.1
date	96.11.05.09.29.31;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.05.23.27.39;	author nturton;	state Exp;
branches;
next	;

4.1.4.1
date	97.09.12.09.17.33;	author rleggett;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.12.17.13;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.20.16.21;	author nturton;	state Exp;
branches;
next	;


desc
@@


4.5
log
@Add support for sorting dir contents numerically as well as alphabetically
New option to the display menu "Numerical sort" modifies the existing 4 sort methods (name, size, type, date) to sort by interpreting any numbers as cardinals. This modifier only really has effect on "Sort by name" since the other three already sort numerically.
This means for example a dir containing "File9,File10,File11" will appear in that order, whereas sorting by name alone would show "File10,File11,File9".

SelStuff0.s/SelStuff.s/Gets.s: Removed. Single function placed into SelStuff.
ModHdr.s/OpenDir.s/Commands.s/DebugFlags.s: Decoding of -NumericalSort switch, switched out undocumented 'Query' flags.
DecodeMenu.s/MenuCreate.s: Handle menu entry, simplify rename code a little.
HelpSrc.s/Messages: Extra help text.
SortDir.s: Pass option flag to Territory_Collate.
WkspEtc.s: Corrected definition of db_sm_type and db_sm_size.

Version 2.34. Tagged as 'Filer-2_34'
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
 [ retainsel
; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; In    r4 -> old directory viewer
;       r7 -> new directory viewer

; For each object in the new directory, look it up in the old directory
; and copy across its selection state

CopySelectionStateAcross Entry "r1, r3, r5, r6"

        LDR     r3, [r7, #d_nfiles]     ; r3 = no of files to do
        CMP     r3, #0
        EXIT    EQ                      ; [nothing in this new viewer]
                                        ; eg. everything's been deleted

        LDR     r6, [r7, #d_dirname]
        ADD     r5, r7, #d_headersize   ; first fileinfo^

90      LDR     r1, [r5, #df_fileptr]
 [ not_16bit_offsets
        ADD     r1, r6, r1              ; leafname^
 |
        ADD     r1, r6, r1, LSR #16     ; leafname^
 ]
        BL      CopySelectionStateForFile

        SUBS    r3, r3, #1
        ADDNE   r5, r5, #df_size        ; next fileinfo^
        BNE     %BT90

        EXIT

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; In    r1 -> new file leafname
;       r4 -> old dirviewer block
;       r5 -> new fileinfo block

; Loop over files in old dirviewer, see if any match

CopySelectionStateForFile Entry "r2, r3, r6, r8"

        LDR     r3, [r4, #d_nfiles]     ; r3 = no of files to do
        CMP     r3, #0
        EXIT    EQ                      ; [nothing in this old viewer]
                                        ; rarer: nothing there to start with

        LDR     r6, [r4, #d_dirname]
        ADD     r8, r4, #d_headersize   ; first fileinfo^

90      LDR     r2, [r8, #df_fileptr]
 [ not_16bit_offsets
        ADD     r2, r6, r2              ; leafname^
 |
        ADD     r2, r6, r2, LSR #16     ; leafname^
 ]
        BL      strcmp

        LDREQB  r14, [r8, #df_state]    ; Copy over state byte
        STREQB  r14, [r5, #df_state]
        EXIT    EQ

        SUBS    r3, r3, #1
        ADDNE   r8, r8, #df_size        ; next fileinfo^
        BNE     %BT90

        EXIT
 ]

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; In    r4 -> dirviewer block

InitSelection ROUT

        STR     r4, sel_dir

        LDR     r2, [r4, #d_dirnamestore] ; r2 -> dirname
        STR     r2, sel_dirname

        LDR     r3, [r4, #d_nfiles]
        ADD     r3, r3, #1              ; will be adjusted below
        STR     r3, sel_filenumber

        ADD     r5, r4, #d_headersize - df_size ; ditto
        STR     r5, sel_fileblock

; .............................................................................
; Out   NE: r5 = Nowt if nothing doing
;       EQ: selection set up
;           r2 -> selected leafname
;           r3  = selected file number
;           r4 -> selected dirviewer block
;           r5 -> selected fileinfo block

GetSelection Entry

        LDR     r3, sel_filenumber
        LDR     r4, sel_dir
        LDR     r5, sel_fileblock

10      SUBS    r3, r3, #1
        BLE     %FA90

        ADD     r5, r5, #df_size

        LDRB    r14, [r5, #df_state]    ; Is it selected ?
        TST     r14, #dfs_selected
        BEQ     %BT10

; Found one

        STR     r3, sel_filenumber
        STR     r5, sel_fileblock

        LDR     r2, sel_dirname
 [ debugsel
 DREG r5,"Returing selection: ",cc
 DSTRING r2,", dirname ",cc
 ]
        LDR     r14, [r5, #df_fileptr]
        LDR     r2, [r4, #d_filenames]
 [ not_16bit_offsets
        ADD     r2, r2, r14            ; r2 -> leafname
 |
        ADD     r2, r2, r14, LSR #16    ; r2 -> leafname
 ]
        STR     r2, sel_leafname

        BL      FindFileType
;      [ version >= 143
;        LDRB    r14,[r5,#df_type]
;        TEQ     r14,#dft_partition
;        MOVEQ   r3,#filetype_directory
;      ]
        STR     r3, sel_filetype
 [ debugsel
 DSTRING r2,", leafname ",cc
 DREG r3,", filetype ",cc
 ]

        LDR     r3, sel_filenumber
 [ debugsel
 DREG r3,", file number "
 ]

        CMP     r0, r0                  ; EQ
        EXIT


90      addr    r2, anull
        STR     r2, sel_leafname

        MOV     r14, #-2
        STR     r14, sel_filetype

 [ debugsel
 DLINE "No selection found"
 ]
        MOVS    r5, #Nowt               ; NE
        EXIT


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; The WasSelection functions are used when a Message_FilerDevicePath is
; received, meaning that we have to copy/move all the files that we
; unselected when we originally sent a DataLoad message.

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; In    r4 -> dirviewer block

InitWasSelection ROUT

        STR     r4, sel_dir

        LDR     r2, [r4, #d_dirnamestore] ; r2 -> dirname
        STR     r2, sel_dirname

        LDR     r3, [r4, #d_nfiles]
        ADD     r3, r3, #1              ; will be adjusted below
        STR     r3, sel_filenumber

        ADD     r5, r4, #d_headersize - df_size ; ditto
        STR     r5, sel_fileblock


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
;
; Find the next file that WAS selected.
;
; Out   NE: r5 = Nowt if nothing doing
;       EQ: selection set up
;           r2 -> selected leafname
;           r3  = selected file number
;           r4 -> selected dirviewer block
;           r5 -> selected fileinfo block

GetWasSelection Entry

        LDR     r3, sel_filenumber
        LDR     r4, sel_dir
        LDR     r5, sel_fileblock

10      SUBS    r3, r3, #1              ; Check if there's...
        BLE     %FA90                   ; ...no more files in this dirviewer
        ADD     r5, r5, #df_size        ; Move to the next file in the viewer
        LDRB    r14, [r5, #df_state]    ; Is it (was it) selected ?
        TST     r14, #dfs_wasselected
        BEQ     %BT10                   ; No? Try next.

        ; Found one
        STR     r3, sel_filenumber
        STR     r5, sel_fileblock
        LDR     r2, sel_dirname
        LDR     r14, [r5, #df_fileptr]
        LDR     r2, [r4, #d_filenames]
 [ not_16bit_offsets
        ADD     r2, r2, r14             ; r2 -> leafname
 |
        ADD     r2, r2, r14, LSR #16    ; r2 -> leafname
 ]
        STR     r2, sel_leafname
        BL      FindFileType
        STR     r3, sel_filetype
        LDR     r3, sel_filenumber
        CMP     r0, r0                  ; EQ
        EXIT


90      ; No more files in this dirviewer
        addr    r2, anull
        STR     r2, sel_leafname
        MOV     r14, #-2
        STR     r14, sel_filetype
        MOVS    r5, #Nowt               ; NE
        EXIT

; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
;
; ClearAllWasSelections
;
; Unmark any wasselected files in the current dir viewer
;
;  In: r4 -> dirviewer block
;
; Out: All registers preserved.

ClearAllWasSelections Entry "r0-r2"

        LDR     r4, was_seldir
        LDR     r1, [r4, #d_nfiles]
        ADD     r0, r4, #d_headersize
01
        CMP     r1, #0
        BEQ     %FT10

        LDRB    r2, [r0, #df_state]
        BIC     r2, r2, #dfs_wasselected
        STRB    r2, [r0, #df_state]
        ADD     r0, r0, #df_size
        SUB     r1, r1, #1
        B       %BT01
10
        MOV     r0, #0
        STR     r0, was_seldir
        EXIT

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; In    r2 -> command to append things to
;
; Out   r1 -> dirnamebuffer containing command+dirname+leafname

PutSelNamesInBuffer Entry "r3"

        LDR     r1, dirnamebuffer
        BL      strcpy                  ; Including spaces
        LDR     r2, sel_dirname
        BL      strcat_excludingspaces
        LDR     r2, sel_leafname
        BL      AppendLeafnameToDirname
        EXIT

        END
@


4.4
log
@  Misc bugfixes.
Detail:
  * Mered in RISCOS Ltd's fix for directory displays with more than 65536
    bytes of leafnames.
  * Tries to use Wimp_TextOp 4 to do ellipsis truncation. As a result, it
    can now cope properly with:
    + multibyte UTF-8 characters in leafnames (previously this caused
      problems even if not truncated)
    + WimpSymbol character substitution in leafnames
    + alphabets without an ellipsis character
    + fonts without an ellipsis character
  * Sprite icons in 'Copy as' and 'New directory' dialogue boxes are no
    longer filled.
Admin:
  Tested on Tungsten.

Version 2.08. Tagged as 'Filer-2_08'
@
text
@d280 14
@


4.3
log
@  Updated build structure to use the shared AAsmModule makefile.
  Updated to build using objasm instead of aasm.
  Sources changed to be objasm-compatible.
Admin:
  Requires Library 0.71 or later.
  Requires BuildSys 3.06 or later.
  Requires Env 0.65 or later.

Version 2.01. Tagged as 'Filer-2_01'
@
text
@d34 3
d38 1
d65 3
d69 1
d135 3
d139 1
d229 3
d233 1
@


4.2
log
@Merged Ursula branch.
Moved to srccommit.

Version 1.96. Tagged as 'Filer-1_96'
@
text
@d23 1
a23 1
CopySelectionStateAcross ENTRY "r1, r3, r5, r6"
d50 1
a50 1
CopySelectionStateForFile ENTRY "r2, r3, r6, r8"
d100 1
a100 1
GetSelection ENTRY
d112 1
a112 1
        TST     r14, #dfs_selected            
d198 1
a198 1
GetWasSelection ENTRY
d208 1
a208 1
        TST     r14, #dfs_wasselected            
d212 1
a212 1
        STR     r3, sel_filenumber      
d244 1
a244 1
ClearAllWasSelections ENTRY "r0-r2"
d252 1
a252 1
        
d259 1
a259 1
10                 
@


4.1
log
@Initial revision
@
text
@d112 1
a112 1
        TST     r14, #dfs_selected
d162 103
@


4.1.4.1
log
@Added code to enable files to be copied to icon bar device icons
@
text
@d112 1
a112 1
        TST     r14, #dfs_selected            
a161 103


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; The WasSelection functions are used when a Message_FilerDevicePath is
; received, meaning that we have to copy/move all the files that we
; unselected when we originally sent a DataLoad message.

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
; In    r4 -> dirviewer block

InitWasSelection ROUT

        STR     r4, sel_dir

        LDR     r2, [r4, #d_dirnamestore] ; r2 -> dirname
        STR     r2, sel_dirname

        LDR     r3, [r4, #d_nfiles]
        ADD     r3, r3, #1              ; will be adjusted below
        STR     r3, sel_filenumber

        ADD     r5, r4, #d_headersize - df_size ; ditto
        STR     r5, sel_fileblock


; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
;
; Find the next file that WAS selected.
;
; Out   NE: r5 = Nowt if nothing doing
;       EQ: selection set up
;           r2 -> selected leafname
;           r3  = selected file number
;           r4 -> selected dirviewer block
;           r5 -> selected fileinfo block

GetWasSelection ENTRY

        LDR     r3, sel_filenumber
        LDR     r4, sel_dir
        LDR     r5, sel_fileblock

10      SUBS    r3, r3, #1              ; Check if there's...
        BLE     %FA90                   ; ...no more files in this dirviewer
        ADD     r5, r5, #df_size        ; Move to the next file in the viewer
        LDRB    r14, [r5, #df_state]    ; Is it (was it) selected ?
        TST     r14, #dfs_wasselected            
        BEQ     %BT10                   ; No? Try next.

        ; Found one
        STR     r3, sel_filenumber      
        STR     r5, sel_fileblock
        LDR     r2, sel_dirname
        LDR     r14, [r5, #df_fileptr]
        LDR     r2, [r4, #d_filenames]
        ADD     r2, r2, r14, LSR #16    ; r2 -> leafname
        STR     r2, sel_leafname
        BL      FindFileType
        STR     r3, sel_filetype
        LDR     r3, sel_filenumber
        CMP     r0, r0                  ; EQ
        EXIT


90      ; No more files in this dirviewer
        addr    r2, anull
        STR     r2, sel_leafname
        MOV     r14, #-2
        STR     r14, sel_filetype
        MOVS    r5, #Nowt               ; NE
        EXIT

; ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
;
; ClearAllWasSelections
;
; Unmark any wasselected files in the current dir viewer
;
;  In: r4 -> dirviewer block
;
; Out: All registers preserved.

ClearAllWasSelections ENTRY "r0-r2"

        LDR     r4, was_seldir
        LDR     r1, [r4, #d_nfiles]
        ADD     r0, r4, #d_headersize
01
        CMP     r1, #0
        BEQ     %FT10
        
        LDRB    r2, [r0, #df_state]
        BIC     r2, r2, #dfs_wasselected
        STRB    r2, [r0, #df_state]
        ADD     r0, r0, #df_size
        SUB     r1, r1, #1
        B       %BT01
10                 
        MOV     r0, #0
        STR     r0, was_seldir
        EXIT


@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@@


4.1.5.1
log
@Import from SrcFiler
@
text
@@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
