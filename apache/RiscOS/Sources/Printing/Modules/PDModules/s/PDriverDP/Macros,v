head	4.8;
access;
symbols
	PDModules-4_64:4.8
	PDModules-4_63:4.8
	PDModules-4_62:4.8
	PDModules-4_61:4.8
	PDModules-4_60:4.8
	PDModules-4_59:4.8
	PDModules-4_58:4.7
	PDModules-4_57:4.7
	PDModules-4_56:4.7
	PDModules-4_55:4.7
	PDModules-4_54:4.7
	PDModules-4_53:4.7
	PDModules-4_52:4.7
	PDModules-4_51:4.7
	PDModules-4_50:4.6
	PDModules-4_49:4.6
	PDModules-4_48:4.6
	PDModules-4_47:4.6
	PDModules-4_46:4.5
	kbracey_32bit_merge:4.4.2.1
	PDModules-4_45:4.5
	PDModules-4_44-4_1_2_7:4.4.2.1
	PDModules-4_44-4_1_2_6:4.4.2.1
	PDModules-4_44-4_1_2_5:4.4.2.1
	PDModules-4_44-4_1_2_4:4.4.2.1
	PDModules-4_44-4_1_2_3:4.4.2.1
	PDModules-4_44-4_1_2_2:4.4.2.1
	PDModules-4_44-4_1_2_1:4.4.2.1
	kbracey_32bit:4.4.0.2
	kbracey_32bit_bp:4.4
	dellis_autobuild_BaseSW:4.4
	Ursula_merge:4.1.7.5
	PDModules-4_44:4.4
	sbrodie_sedwards_16Mar2000:4.4
	dcotton_autobuild_BaseSW:4.5
	mstphens_UrsulaRiscPCBuild_20Nov98:4.1.7.5
	Ursula_RiscPC:4.1.7.5.0.4
	rthornb_UrsulaBuild-19Aug1998:4.1.7.5
	UrsulaBuild_FinalSoftload:4.1.7.5
	rthornb_UrsulaBuild-12Aug1998:4.1.7.5
	aglover_UrsulaBuild-05Aug1998:4.1.7.5
	rthornb_UrsulaBuild-29Jul1998:4.1.7.5
	rthornb_UrsulaBuild-22Jul1998:4.1.7.5
	hsimons_BOCA-1_2-Release:4.1.7.5
	rthornb_UrsulaBuild-15Jul1998:4.1.7.5
	rthornb_UrsulaBuild-07Jul1998:4.1.7.5
	rthornb_UrsulaBuild-17Jun1998:4.1.7.5
	rthornb_UrsulaBuild-03Jun1998:4.1.7.5
	rthornb_UrsulaBuild-27May1998:4.1.7.5
	rthornb_UrsulaBuild-21May1998:4.1.7.5
	rthornb_UrsulaBuild_01May1998:4.1.7.5
	afrost_NC2_Generic:4.1.7.5
	afrost_Funai01-33:4.1.7.5
	Ursula:4.1.7.5.0.2
	Ursula_bp:4.1.7.5
	Ursula_31Mar1998:4.4
	Spinner_RCA116:4.1.7.5
	Spinner_B20_2:4.1.7.5
	Spinner_19_3:4.1.7.5
	Spinner_B18:4.1.7.5
	Spinner_B17:4.1.7.5
	Spinner_B15:4.1.7.4
	Spinner_B14:4.1.7.4
	Spinner_B13:4.1.7.4
	Spinner_B12:4.1.7.4
	Spin_merge_28May97:4.1.7.3
	Spinner_B10:4.1.7.4
	Spin_merge_16May97:4.1.7.1
	Daytona:4.2.0.6
	Daytona_bp:4.2
	Spinner_B7:4.1.7.2
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	RCA_bp:4.2
	ARTtmp:4.1.7.1.0.2
	RCA:4.2.0.4
	Spin_merge:4.1.7.4
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.8
date	2014.10.20.21.53.05;	author rsprowson;	state Exp;
branches;
next	4.7;
commitid	kYvwc1FHitWAiZUx;

4.7
date	2003.07.11.18.10.21;	author rsprowson;	state Exp;
branches;
next	4.6;

4.6
date	2002.12.05.20.45.09;	author srevill;	state Exp;
branches;
next	4.5;

4.5
date	2001.01.09.13.59.39;	author sbrodie;	state Exp;
branches;
next	4.4;

4.4
date	97.05.28.12.18.35;	author kbracey;	state Exp;
branches
	4.4.2.1;
next	4.3;

4.3
date	97.05.16.12.55.45;	author kbracey;	state Exp;
branches;
next	4.2;

4.2
date	97.01.21.17.07.46;	author nturton;	state Exp;
branches;
next	4.1;

4.1
date	96.11.05.09.48.37;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.5.1
	4.1.7.1;
next	;

4.4.2.1
date	2000.10.18.11.32.02;	author sbrodie;	state Exp;
branches;
next	;

4.1.1.1
date	96.11.05.09.48.37;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.06.03.04.56;	author nturton;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.13.27.25;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.21.31.07;	author nturton;	state Exp;
branches;
next	4.1.7.2;

4.1.7.2
date	97.04.30.17.46.09;	author scormie;	state Exp;
branches;
next	4.1.7.3;

4.1.7.3
date	97.05.14.09.36.24;	author jcoxhead;	state Exp;
branches;
next	4.1.7.4;

4.1.7.4
date	97.05.22.10.46.49;	author jcoxhead;	state Exp;
branches;
next	4.1.7.5;

4.1.7.5
date	97.07.09.15.31.09;	author arodger;	state Exp;
branches;
next	;


desc
@@


4.8
log
@Some PDModule tidy ups
Core/FontSWI.s & PDriverDP/Font.s:
 The pointer compares are now unsigned, so raise the limit for printing strings in top bit set addresses when no length is passed in R7.
 Couple of comment typos.
Core/Header.s:
 A CVS merge mistake left behind two copies of Push/return sequence.
Core/PDriver.s:
 Unused VersionString removed.
PDriverDP/Macros.s & PDriverDP/ManageJob.s:
 Single use unhelpful debug message removed.
PDriverDP/Private2.s & Sprite.s & TranSprite.s:
 Use some of the defines from Hdr:Sprite.
Makefile:
 For ROMming, explicitly state there's no resources phase
PDriverDP/PageBox.s:
 Unjumble the set_sprite_output_state data. The MonoBufferOK and Libra1 switch happen to work when both are {TRUE} but other combinations would output a silly table. Let ObjAsm work out the size instead.

Tested briefly, still printed OK.

Version 4.59. Tagged as 'PDModules-4_59'
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
; > Sources.PDriverDP.Macros

                GET     hdr:DDVMacros

Philip          SETD    {FALSE}   ; Philip's Random debugging messages
Colour          SETD    {FALSE}
Configure       SETD    {TRUE}
Draw            SETD    {FALSE}
Font            SETD    {FALSE}
FontSlaving     SETD    {FALSE}
ManageJob       SETD    {FALSE}
PageBox         SETD    {FALSE}
PageBoxMem      SETD    {FALSE}
Plot            SETD    {FALSE}
Private         SETD    {FALSE}
Privatemjs      SETD    {FALSE}
Sprite          SETD    {FALSE}
Vdu5            SETD    {FALSE}
Info            SETD    {FALSE}
TransSprite     SETD    {FALSE}
CallPDumper     SETD    {TRUE}
Dump            SETD    {FALSE}
JPEG            SETD    {FALSE}
mjs             SETD    {FALSE}
misc            SETD    {FALSE}
svc             SETD    {FALSE} ;service calls

                GBLL    DescribeWS
                GBLL    GammaCorrect
                GBLL    Libra1
                GBLA    MaxColour

GammaCorrect    SETL    {FALSE} ; should be true - except should also the ungamma-correct
                                ; for the printer which is more or less the same as the
                                ; monitor correction - so they CANCEL OUT!
MaxColour       SETA    255

Libra1          SETL    {TRUE}  ; turn on 24bit tony cheal stuff - and other improvements since
DescribeWS      SETL    {FALSE} ; Describe the workspace (useful when building ShowHeap info)

; macro to load the "dump depth" into a register; used in pagebox


                MACRO
$l              LoadDumpDepth $r, $cc
$l;              MOV$cc  $r, #8
                LDR$cc.B $r, job_dump_depth
                MEND


; macro to convert a height in dots in r0 to a height in strips

                MACRO
                ReduceDotsToStrips
                LDRB    R1, job_dump_depth
                BL      Divide
                MEND



; macro to multiply by the depth of a strip.

                MACRO
$l              MultiplyByDumpDepth $rd,$rs,$cc
$l              LoadDumpDepth $rd,$cc
                MUL$cc   $rd, $rs, $rd
                MEND



; macro to deal with page end. Inspect pagebox carefully to see what
; environment it gets.

                MACRO
$l              FinishPage
$l              Push    "r1-r3,r9,lr"

                Debug   PageBox, "+FinishPage"

                LDR     r1, jobhandle
                LDRB    r2, job_strip_type
                ADR     r3, job_pdumper_word
                ADR     r4, job_dump_depth

                MOV     r9, #PDumperReason_EndPage
                BL      CallPDumperForJob

                Debug   PageBox, "-FinishPage"

                Pull    "r1-r3,r9,lr"
                BVS     %FA99

                SUBS    r0,r0, #1
                BNE     pagebox_morepages

                MEND


                MACRO
$l              StartAnotherCopy
$l              BL      start_page            ; print the top margin
                MEND



; Macro to assemble the routine that sets up the printer for the next page.

                MACRO
$l              BuildStartPageCode
$l
                DebugEscState BuildStartPageCode
                Push   "r1-r5, r9, lr"

                Debug   PageBox, "+BuildStartPageCode"

                LDR     r1, jobhandle
                LDRB    r2, job_strip_type
                LDR     r3, job_topmargin
                ADR     r4, job_pdumper_word
                ADR     r5, job_dump_depth
                LDR     r6, job_leftmargin
                LDR     r7, info_xpixelres
                LDR     lr, info_ypixelres
                ORR     r7, r7, lr, LSL #16             ; pack resolution into single word

                MOV     r9, #PDumperReason_StartPage
                Debug   PageBox, "calling CallPDumperForJob"
                BL      CallPDumperForJob
                Debug   PageBox, "called CallPDumperForJob"

                RSBVC   r3, r3, #0
                STRVC   r3, job_currentline

                Debug   PageBox, "-BuildStartPageCode"

                Pull    "r1-r5, r9, pc"

                MEND

;..............................................................................

; Describe the workspace if required for ShowHeap to use

              [ DescribeWS

                MACRO
$l              Show    $string,$var
                ! 0,"$string &":CC::STR::INDEX:$var
                MEND

                Show    "Start of job list ",printjoblist
                Show    "Printer name ",info_globalprintername
                Show    "Font list ",fontlist
                Show    "Temp block claimed ",temprmablock
                Show    "Next job ",joblink
                Show    "Rectangle list ",rectlist
                Show    "Local printer name copy ",info_nameat
                Show    "Local font list copy ",jobfontlist
                Show    "Next rectangle offset ",nextrectangle
                Show    "PDumper list at ",pdumper_list
                Show    "PDumper local workspace starts at ",job_pdumper_word

              ]

        MACRO
$l      DebugEscState   $fn
        [               debug
$l      Push            "r0-r2, lr"
        SavePSR         lr
        Push            "lr"                    ;save flags
        MOV             r0, #229
        MOV             r1, #0
        MOV             r2, #255
        SWI             XOS_Byte
        Debug           misc, "$fn: esc disabled", r1
        Pull            "lr"
        RestPSR         lr,,f                   ;restore flags
        Pull            "r0-r2, lr"             ;restore everything else
        ]
        MEND

        END
@


4.7
log
@Unoptimised a RMA clearing loop: went mad if the workspace was not a
multiple of 3.
Changed PDumper Upcall stuff to pass R0-R12 on the stack - curiously this
fixes the RMA corruption and instability of !Printers (as does switching
the UpCalls off.

Version 4.51. Tagged as 'PDModules-4_51'
@
text
@a34 1
xx              SETD    {FALSE}
@


4.6
log
@Changed to use objasm to avoid any LDR rN,[rN],#0 problems
Changed to use shared Makefiles
Numerous small 32 bit conversion improvements
Bugfix to PDriverPS,it was pulling LR not PC - this has been the case for
many years so not sure how it ever worked.
Due to a bug in objasm 3.27 this checkin will infact not build directly.
You must first
 - rename the PDriverDP dir to PDriverDP2
 - rename the PDriverPS dir to PDriverPS2
 - move the 2 source files of the same name up a directory
checked in in this way to minimise messing in CVS.

Version 4.47. Tagged as 'PDModules-4_47'
@
text
@d21 1
a21 1
Configure       SETD    {FALSE}
d26 1
a26 1
PageBox         SETD    {TRUE}
d40 2
a41 2
misc		SETD	{TRUE}
svc		SETD	{TRUE}	;service calls
d93 1
a93 1
		Debug	PageBox, "+FinishPage"
d103 1
a103 1
		Debug	PageBox, "-FinishPage"
d126 1
a126 1
		DebugEscState BuildStartPageCode
d129 1
a129 1
                Debug	PageBox, "+BuildStartPageCode"
d142 1
a142 1
                Debug	PageBox, "calling CallPDumperForJob"
d144 1
a144 1
                Debug	PageBox, "called CallPDumperForJob"
d149 1
a149 1
                Debug	PageBox, "-BuildStartPageCode"
d180 4
a183 4
	MACRO
$l	DebugEscState	$fn
	[		debug
$l	Push		"r0-r2, lr"
d185 11
a195 11
	Push		"lr"			;save flags
	MOV		r0, #229
	MOV		r1, #0
	MOV		r2, #255
	SWI		XOS_Byte
	Debug		misc, "$fn: esc disabled", r1
	Pull		"lr"
	RestPSR         lr,,f			;restore flags
	Pull		"r0-r2, lr"		;restore everything else
	]
	MEND
@


4.5
log
@  Merge of 32-bit branch.
Detail:
  These modules are now thought to work.
Admin:
  This module has received some testing of both 26-bit and 32-bit
    builds and is believed to function correctly.

Version 4.45. Tagged as 'PDModules-4_45'
@
text
@d19 23
a41 23
Philip          SETD    false   ; Philip's Random debugging messages
Colour          SETD    false
Configure       SETD    false
Draw            SETD    false
Font            SETD    false
FontSlaving     SETD    false
ManageJob       SETD    false
PageBox         SETD    true
PageBoxMem      SETD    false
Plot            SETD    false
Private         SETD    false
Privatemjs      SETD    false
Sprite          SETD    false
Vdu5            SETD    false
Info            SETD    false
TransSprite     SETD    false
xx              SETD    false
CallPDumper     SETD    true
Dump            SETD    false
JPEG            SETD    false
mjs             SETD    false
misc		SETD	true
svc		SETD	true	;service calls
@


4.4
log
@Spinner branch taken
@
text
@d16 1
a16 1
                
d35 1
a35 1
xx              SETD    false 
d59 1
a59 1
                MACRO   
d128 1
a128 1
                
d145 1
a145 1
 
d160 1
a160 1
                
d184 2
a185 1
	Push		"pc"			;save flags
d192 1
a192 1
	TEQP		lr, #0			;restore flags
@


4.4.2.1
log
@  First attempt at 32-bit compatible modules.
Admin:
  Tested that modules build 26-bit and 32-bit.
  Requires HdrSrc-1_05 or later.

Version 4.44, 4.1.2.1. Tagged as 'PDModules-4_44-4_1_2_1'
@
text
@d16 1
a16 1

d35 1
a35 1
xx              SETD    false
d59 1
a59 1
                MACRO
d128 1
a128 1

d145 1
a145 1

d160 1
a160 1

d184 1
a184 2
        SavePSR         lr
	Push		"lr"			;save flags
d191 1
a191 1
	RestPSR         lr,,f			;restore flags
@


4.3
log
@Spinner branch merged
@
text
@a95 3
                [ Libra1
                LDR     r2, job_strip_type
                |
a96 1
                ]
a131 3
                [ Libra1
                LDR     r2, job_strip_type
                |
a132 1
                ]
@


4.2
log
@Version Spin_merge taken
@
text
@d21 1
a21 1
Configure       SETD    false    
d26 1
a26 1
PageBox         SETD    false
d30 1
a30 1
Privatemjs      SETD    true
d36 1
a36 1
CallPDumper     SETD    false 
d40 2
d93 2
d106 3
a108 1
                  
d130 1
d132 2
d150 1
d152 1
d157 2
d188 17
a204 1
                END
@


4.1
log
@Initial revision
@
text
@d27 1
a27 1
PageBoxMem      SETD    true
d31 1
a31 1
Sprite          SETD    false    
d37 2
a38 2
Dump            SETD    true
JPEG            SETD    true
@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@d27 1
a27 1
PageBoxMem      SETD    false
d31 1
a31 1
Sprite          SETD    false
d37 2
a38 2
Dump            SETD    false
JPEG            SETD    false
@


4.1.7.2
log
@   Use buffer in workspace for MessageTrans.
   Added 'Colour' debugging flag.
   Do not pass SpriteV calls to pdriver if a Wimp error box is open.
@
text
@d20 2
a21 2
Colour          SETD    true
Configure       SETD    false
d26 2
a27 2
PageBox         SETD    true	;JRC
PageBoxMem      SETD    true	;JRC
d30 1
a30 1
Privatemjs      SETD    false
d36 1
a36 1
CallPDumper     SETD    true	;JRC
a90 2
		Debug	PageBox, "+FinishPage"

d102 1
a102 3

		Debug	PageBox, "-FinishPage"

a124 2
                
                Debug	PageBox, "+BuildStartPageCode"
a140 1
                Debug	PageBox, "calling CallPDumperForJob"
a141 1
                Debug	PageBox, "called CallPDumperForJob"
a144 2

                Debug	PageBox, "-BuildStartPageCode"
@


4.1.7.3
log
@   Enable escapes round all calls to PDumper.
   Replace the caller's escape handler with a NOP. Otherwise, we end
up calling the current escape handler when we acknowledge the escape,
which has potentially horrible consequences. In the case of the C
library, the escape handler is expecting to have to raise a signal,
and if it can't do this is generates an error instead.
@
text
@d20 1
a20 1
Colour          SETD    false
d26 2
a27 2
PageBox         SETD    true
PageBoxMem      SETD    false
d36 1
a36 1
CallPDumper     SETD    true
a39 2
misc		SETD	true
svc		SETD	true	;service calls
a127 1
		DebugEscState BuildStartPageCode
d185 1
a185 17
	MACRO
$l	DebugEscState	$fn
	[		debug
$l	Push		"r0-r2, lr"
	Push		"pc"			;save flags
	MOV		r0, #229
	MOV		r1, #0
	MOV		r2, #255
	SWI		XOS_Byte
	Debug		misc, "$fn: esc disabled", r1
	Pull		"lr"
	TEQP		lr, #0			;restore flags
	Pull		"r0-r2, lr"		;restore everything else
	]
	MEND

        END
@


4.1.7.4
log
@   Just pass in job_strip_type to the PDumper: it doesn't use anything else
anyway. (Used to pass in 4 bytes from that location.)
@
text
@d96 3
d100 1
d136 3
d140 1
@


4.1.7.5
log
@Placed code in redirect output to check for the current state, so as not to duplicate the present output direction(jobspriteparams)
@
text
@d25 2
a26 2
ManageJob       SETD    true
PageBox         SETD    false
d36 1
a36 1
CallPDumper     SETD    false
d40 2
a41 2
misc		SETD	false
svc		SETD	false	;service calls
@


4.1.5.1
log
@Import from SrcFiler
@
text
@d27 1
a27 1
PageBoxMem      SETD    false
d31 1
a31 1
Sprite          SETD    false
d37 2
a38 2
Dump            SETD    false
JPEG            SETD    false
@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@d27 1
a27 1
PageBoxMem      SETD    false
d31 1
a31 1
Sprite          SETD    false
d37 2
a38 2
Dump            SETD    false
JPEG            SETD    false
@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
