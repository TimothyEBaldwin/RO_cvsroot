head	4.5;
access;
symbols
	PDModules-4_64:4.5
	PDModules-4_63:4.5
	PDModules-4_62:4.5
	PDModules-4_61:4.5
	PDModules-4_60:4.5
	PDModules-4_59:4.5
	PDModules-4_58:4.5
	PDModules-4_57:4.5
	PDModules-4_56:4.5
	PDModules-4_55:4.5
	PDModules-4_54:4.5
	PDModules-4_53:4.5
	PDModules-4_52:4.5
	PDModules-4_51:4.5
	PDModules-4_50:4.5
	PDModules-4_49:4.4
	PDModules-4_48:4.4
	PDModules-4_47:4.4
	PDModules-4_46:4.4
	kbracey_32bit_merge:4.3.2.3
	PDModules-4_45:4.4
	PDModules-4_44-4_1_2_7:4.3.2.3
	PDModules-4_44-4_1_2_6:4.3.2.3
	PDModules-4_44-4_1_2_5:4.3.2.3
	PDModules-4_44-4_1_2_4:4.3.2.3
	PDModules-4_44-4_1_2_3:4.3.2.3
	PDModules-4_44-4_1_2_2:4.3.2.2
	PDModules-4_44-4_1_2_1:4.3.2.1
	kbracey_32bit:4.3.0.2
	kbracey_32bit_bp:4.3
	dellis_autobuild_BaseSW:4.3
	Ursula_merge:4.1.7.2
	PDModules-4_44:4.3
	sbrodie_sedwards_16Mar2000:4.3
	dcotton_autobuild_BaseSW:4.4
	mstphens_UrsulaRiscPCBuild_20Nov98:4.1.7.2
	Ursula_RiscPC:4.1.7.2.0.4
	rthornb_UrsulaBuild-19Aug1998:4.1.7.2
	UrsulaBuild_FinalSoftload:4.1.7.2
	rthornb_UrsulaBuild-12Aug1998:4.1.7.2
	aglover_UrsulaBuild-05Aug1998:4.1.7.2
	rthornb_UrsulaBuild-29Jul1998:4.1.7.2
	rthornb_UrsulaBuild-22Jul1998:4.1.7.2
	hsimons_BOCA-1_2-Release:4.1.7.2
	rthornb_UrsulaBuild-15Jul1998:4.1.7.2
	rthornb_UrsulaBuild-07Jul1998:4.1.7.2
	rthornb_UrsulaBuild-17Jun1998:4.1.7.2
	rthornb_UrsulaBuild-03Jun1998:4.1.7.2
	rthornb_UrsulaBuild-27May1998:4.1.7.2
	rthornb_UrsulaBuild-21May1998:4.1.7.2
	rthornb_UrsulaBuild_01May1998:4.1.7.2
	afrost_NC2_Generic:4.1.7.2
	afrost_Funai01-33:4.1.7.2
	Ursula:4.1.7.2.0.2
	Ursula_bp:4.1.7.2
	Ursula_31Mar1998:4.3
	Spinner_RCA116:4.1.7.2
	Spinner_B20_2:4.1.7.2
	Spinner_19_3:4.1.7.2
	Spinner_B18:4.1.7.2
	Spinner_B17:4.1.7.2
	Spinner_B15:4.1.7.2
	Spinner_B14:4.1.7.2
	Spinner_B13:4.1.7.2
	Spinner_B12:4.1.7.2
	Spin_merge_28May97:4.1.7.2
	Spinner_B10:4.1.7.2
	Spin_merge_16May97:4.1.7.1
	Daytona:4.2.0.6
	Daytona_bp:4.2
	Spinner_B7:4.1.7.2
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	RCA_bp:4.2
	ARTtmp:4.1.7.1.0.2
	RCA:4.2.0.4
	Spin_merge:4.1.7.2
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.5
date	2003.03.10.11.33.29;	author rsprowson;	state Exp;
branches;
next	4.4;

4.4
date	2001.01.09.13.59.43;	author sbrodie;	state Exp;
branches;
next	4.3;

4.3
date	97.05.16.12.55.54;	author kbracey;	state Exp;
branches
	4.3.2.1;
next	4.2;

4.2
date	97.01.21.17.07.51;	author nturton;	state Exp;
branches;
next	4.1;

4.1
date	96.11.05.09.48.41;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.5.1
	4.1.7.1;
next	;

4.3.2.1
date	2000.10.18.11.32.02;	author sbrodie;	state Exp;
branches;
next	4.3.2.2;

4.3.2.2
date	2000.11.24.13.27.32;	author sbrodie;	state Exp;
branches;
next	4.3.2.3;

4.3.2.3
date	2000.11.30.12.13.40;	author sbrodie;	state Exp;
branches;
next	;

4.1.1.1
date	96.11.05.09.48.41;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.06.03.05.44;	author nturton;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.13.27.54;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.21.31.33;	author nturton;	state Exp;
branches;
next	4.1.7.2;

4.1.7.2
date	97.05.01.12.38.42;	author nturton;	state Exp;
branches;
next	;


desc
@@


4.5
log
@Fix for the thingy which sits on SpriteV,it got optimised sometime round
2000 which led to it getting the "redirected to sprite" switch in a
muddle so printing from some apps ended up on the screen not in the
postscript file.
Changed the "%%Creator" string a bit.
Took the opportunity to eliminate all the signed pointer comparisons.
Tightened up the checking of pointers to palettes and translation tables
so that "0 or -1" means to use the default,not <= 0.

Version 4.50. Tagged as 'PDModules-4_50'
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
; > Sources.PDriverPS.ManageJob

; Job management routines for the PostScript printer driver

;----------------------------------------------------------------------------
;
; The print job workspace allocation routine
;
;----------------------------------------------------------------------------

managejob_allocate
        Push    "R0-R4,LR"
        MOV     R0,#ModHandReason_Claim ;Claim workspace
        LDR     R4,info_globalfeatures  ;If output destined for a colour
        TST     R4,#1                   ;  printer, allocate the
        LDR     R3,=jobwslength         ;  'pixelvalues' table as well as
        ADDNE   R3,R3,#4*&100           ;  the standard amount of workspace.
        SWI     XOS_Module
        MOV     R11,R2
        BLVC    managejob_allocate_inittable
        STRVS   R0,[R13]
        Pull    "R0-R4,PC"

        LTORG

        ; V will be clear on entry to this routine - guaranteed above
managejob_allocate_inittable            ;Subroutine to initialise the
        TST     R4,#1                   ;  'pixelvalues' table if necessary
        MOVEQ   pc, lr                  ;Return if monochrome output
        ADRL    R0,pixelvalues
        MOV     R1,#255                 ;Start at entry 255
        MOV     R4,#3
managejob_allocate_initloop
        AND     R2,R4,R1                ;Construct red component from bottom
        ADD     R2,R2,R2,LSL #2         ;  two bits of index by multiplying
        ADD     R2,R2,R2,LSL #4         ;  by &55
        MOV     R3,R2,LSL #8
        AND     R2,R4,R1,LSR #2         ;Construct green component from next
        ADD     R2,R2,R2,LSL #2         ;  two bits of index by multiplying
        ADD     R2,R2,R2,LSL #4         ;  by &55
        ORR     R3,R3,R2,LSL #16
        AND     R2,R4,R1,LSR #4         ;Construct blue component from next
        ADD     R2,R2,R2,LSL #2         ;  two bits of index by multiplying
        ADD     R2,R2,R2,LSL #4         ;  by &55
        ORR     R3,R3,R2,LSL #24
        AND     R2,R4,R1,LSR #6         ;Make this entry undefined if top
        TEQ     R2,#3                   ;  two bits of index are not both set
        ORRNE   R3,R3,#&FF
        STR     R3,[R0,R1,LSL #2]       ;Store the result
        SUBS    R1,R1,#1                ;Then loop if necessary (will not set V)
        BGE     managejob_allocate_initloop
        MOV     pc, lr

for_name        DCB     "PDriver$For",0
                ALIGN

address_name    DCB     "PDriver$Address",0
                ALIGN

;----------------------------------------------------------------------------
;
; The print job initialisation routine
;
;----------------------------------------------------------------------------

managejob_init
        Push    "R0-R4,LR"
        PrError managejob_init_return           ;Set up error label
        [       PSDebugManageJ
        PrLnIm  "% managejob_init"
        ]

; Record whether this job requires a CTRL-D at its end.
 [ 1=1
; SMC: We want a CTRL-D if it's not an illustration job but not if it is.
        LDRB    r14, illustrationjob
        TEQ     r14, #0
        MOVEQ   r14, #-1
        MOVNE   r14, #0
 |
        LDRB    r14, globalusectrld
 ]
        STRB    r14, jobusectrld

; Record the prologue verbosity

        LDRB    r14, globalverbose
        STRB    r14, jobverbose

; Record whether accent generation is needed

        LDRB    r14, globalaccents
        STRB    r14, jobaccents

;record whether Level 2
        LDRB    r14, globallevel2
        STRB    r14, joblevel2

; Current colour is unknown.

        ADR     r14, currentcols
        STR     r14, currentcolptr
        MOV     r14, #-1
        STR     r14, currentcols

; Initialise the list of declared fonts to "no list"

        STR     r14,  declaredfonts

; Initialise the flag that says we should send a prologue out to TRUE

        STRB    r14,  sendprologue

        [       PSTextSpeedUps

; Current font is unknown.

        ADR     r14, currentfonts
        STR     r14, currentfontptr
        MOV     r14, #-1
        STR     r14, currentfonts

        ]

; Zero the font mapping table

        ADR     r14, fontmapping
        MOV     r0, #0
        MOV     r2, #255
00      STR     r0, [r14, r2, LSL #2]
        SUBS    r2, r2, #1
        BPL     %BT00

;initialise bput buffering
        MOV     R14,#0
        STRB    R14,bputNbuff

; Output print job header comments. First the version identifier and creating
; program. OSS Changed version numbers. Used to be the latest version of
; Postscript and EPSF that we knew about. This has been changed to the
; earliest version of Postscript and EPSF to which our output conforms.
; This is important - applications accepting encapsulated Postscript check
; these numbers.

        PrStrIm "%!PS-Adobe-2.0"
        LDRB    r14, illustrationjob
        TEQ     r14, #0
        BEQ     managejob_init_notanillustration
        PrStrIm " EPSF-1.2"
managejob_init_notanillustration
        PrNewLn
        PrLnIm  "%%Creator: RISC OS PDriverPS $Module_FullVersion"

; Next the creation time and date.  This used to use the rune
; PrGLnIm "%%CreationDate: <Sys$Time> <Sys$Date> <Sys$Year>"
; but that sometimes provoked a re-entrancy problem in OS_GSTrans.
; It has been rewritten to use OS_ReadVarVal instead.

        PrStrIm "%%CreationDate: "
        PrVarIm "Sys$Time"
        PrStrIm " "
        PrVarIm "Sys$Date"
        PrStrIm " "
        PrVarIm "Sys$Year"
        PrNewLn

; Next the title string pointed to by R1, if it exists.

        TEQ     R1,#0
        BEQ     managejob_init_untitled
        PrStrIm "%%Title: "
        PrLn    R1,32,126
managejob_init_untitled

; Now the intended recipient in PDriver$For, if it exists.

        ADR     R0,for_name
        MOV     R2,#-1
        MOV     R3,#0
        SWI     XOS_ReadVarVal
        CMP     R2,#0           ;Clears V, sets EQ if non-existent variable
        BEQ     managejob_init_nofor
        PrGLnIm "%%For: <PDriver$For>"
managejob_init_nofor

; And the intended address/routing in PDriver$Address, if that exists.

        ADRL    R0,address_name
        MOV     R2,#-1
        MOV     R3,#0
        SWI     XOS_ReadVarVal
        CMP     R2,#0           ;Clears V, sets EQ if non-existent variable
        BEQ     managejob_init_noaddress
        PrGLnIm "%%Routing: <PDriver$Address>"
managejob_init_noaddress

; Number of pages, bounding box and font comments will only
; appear at the end of output.

        PrLnIm  "%%Pages: (atend)"
        PrLnIm  "%%BoundingBox: (atend)"
        PrLnIm  "%%DocumentFonts: (atend)"
        PrLnIm  "%%DocumentSuppliedFonts: (atend)"

; Initialise job bounding boxes.

        MOV     R0,#&7FFFFFFF
        MOV     R1,#&7FFFFFFF
        MOV     R2,#&80000000
        MOV     R3,#&80000000
        ADR     r14, jobboundingbox
        STMIA   r14, {R0-R3}

        PrError                                 ;Cancel error label
managejob_init_return
        STRVS   R0,[R13]
        Pull    "R0-R4,PC"

;----------------------------------------------------------------------------
;
; The print job finalisation routine
;
;----------------------------------------------------------------------------

managejob_finalise
        Push    "R0-R7,LR"
        PrError managejob_finalise_return       ;Set up error label
        [       PSDebugManageJ
        PrLnIm  "% managejob_finalise"
        ]

; Start the trailer section

        PrLnIm  "%%Trailer"

; Give the number of pages produced

        PrStrIm "%%Pages: "
        LDR     r0, numberofpages
        PrNum   r0, CorruptR0
        PrNewLn

; Give the resulting bounding box. If nothing printed, produce a null
; bounding box rather than a contradictory one.

        ADR     r14, jobboundingbox
        LDMIA   r14, { r0-r3 }
        CMP     R0, R2
        MOVGT   R0, #0
        MOVGT   R1, #0
        MOVGT   R2, #0
        MOVGT   R3, #0
        PrStrIm "%%BoundingBox: "
        PrPair  R0, R1, CorruptR0andR1
        PrNumSp R2, CorruptR0
        PrNum   R3, CorruptR0
        PrNewLn

; Output the DocumentFonts stuff.  We only do this if we're not
; verbose (ie declaredfonts >= 0), and if there is a font list,
; ie. (declaredfonts > 0).  Note that we don't actually get the fonts
; from declaredfont; we get them from the MiscOp list.

        LDR     r0, declaredfonts
        CMP     r0, #0
        BLT     managejob_finalise_terminate    ;;; was BLE

        MOV     r6, #0                  ; DocumentFonts
        BL      managejob_outputfontcomment
        MOV     r6, #1                  ; DocumentSuppliedFonts
        BL      managejob_outputfontcomment


managejob_finalise_terminate

; Output the Epilogue file (if present)

        ADRL    r0, epilogue_filename
        BL      pagebox_insertfile      ; Ignore errors

; And terminate with a CTRL-D if required.

        LDRB    r14, jobusectrld
        TEQ     r14, #0
        BEQ     managejob_finalise_freefonts
        PrChr   #4

; Now free the list of declared fonts

managejob_finalise_freefonts
        MOV     r0, #ModHandReason_Free
        ADR     r1, declaredfonts
        LDR     r2, [ r1, #0 ]
managejob_finalise_freefontsloop
        CMP     r2, #0
        BLE     managejob_finalise_return
        LDR     r1, [ r2, #0 ]
        SWI     XOS_Module
        BVS     managejob_finalise_return
        MOVS    r2, r1
        BNE     managejob_finalise_freefontsloop

        PrError                                 ;Cancel error label

managejob_finalise_return
;make sure output is flushed
        BLVC    bput_flush
        STRVS   r0, [ sp, #0 ]
        Pull    "r0-r7, pc"


; Output DocumentFonts or DocumentSuppliedFonts comments.  Do this
; by scanning the MiscOp list for entries with appropriate values
; in the flags word.
; On entry, r6 is 0 for DocumentFonts, 1 for DocumentSuppliedFonts.
;
; REGISTERS R0-R5,R7 CORRUPTED.

managejob_outputfontcomment
        Push    "lr"

        PrError managejob_outputfontcomment_end
        PrStrIm "%%Document"
        TEQ     r6, #0                  ; is it DocumentFonts
        BEQ     %FT00                   ; yes, so don't print Supplied
        PrStrIm "Supplied"
00
        PrStrIm "Fonts: "

        ADRL    r5, enumeration_buf
        MOV     r3, #0                  ; first handle
        MOV     r4, #0                  ; flags
        MOV     r7, #0
        B       %FT02

01      TEQ     r3, #0                  ; was returned handle 0?
        BEQ     %FT04                   ; yes, then done

02      MOV     r0, #2                  ; enumerate fonts
        MOV     r1, r5                  ; clobbered by the call
        MOV     r2, #12                 ; size is clobbered too
        SWI     XPDriver_MiscOp
        BVS     %FT04                   ; if there was an error, or
        TEQ     r2, #0                  ; remaining size is nonzero
        BNE     %FT04                   ; then there are no more

        LDR     r1, [r5, #8]            ; check flags word
        LDR     r2, [r5, #0]

        TEQ     r6, #1                          ; if we're doing DocumentSuppliedFonts...
        BEQ     %FT05                           ; then skip the first test
        TEQ     r1, #PDriverMiscOp_PS_DF        ; is it DocumentFonts?
        BEQ     %FT06
05      TEQ     r1, #PDriverMiscOp_PS_DSF       ; ...then is it DocumentSuppliedFonts?
        BNE     %BT01

06      TEQ     r7, #0                  ; don't do %%+ for the first line
        ADD     r7, r7, #1
        BEQ     %FT03
        PrStrIm "%%+ "
03
        PrLn    r2,32,126

        B       %BT01                   ; go back for the next entry

04
        PrNewLn

managejob_outputfontcomment_end
        PrError
        Pull    "pc"


managejob_suspend
        Push    "LR"
        BL      bput_flush
        Pull    "PC"

managejob_resume
        RETURNVC

managejob_abort
        ; set the output stream to 0 if the job is aborted
        ; this stops pages being printed if background printing
        ; is on!

        Push    "R0-R2,LR"
        MOV     R0, #3
        MOV     R1, R10
        MOV     R2, #0
        SWI     XOS_Args
        Pull    "R0-R2,PC"


        END

@


4.4
log
@  Merge of 32-bit branch.
Detail:
  These modules are now thought to work.
Admin:
  This module has received some testing of both 26-bit and 32-bit
    builds and is believed to function correctly.

Version 4.45. Tagged as 'PDModules-4_45'
@
text
@d159 1
a159 1
        PrStrIm "%!PS-Adobe-2.0"        ; OSS Was 2.1
d163 1
a163 1
        PrStrIm " EPSF-1.2"             ; OSS Was 2.0
d166 1
a166 1
        PrLnIm  "%%Creator: $PrinterType PDriver module $VersionString"
@


4.3
log
@Spinner branch merged
@
text
@d40 1
d43 1
a43 1
        Return  EQ                      ;Return if monochrome output
d64 1
a64 1
        SUBS    R1,R1,#1                ;Then loop if necessary
d66 1
a66 1
        Return
d272 1
a272 1
        
d352 1
a352 1
        
d394 1
a394 1
        Return
@


4.3.2.1
log
@  First attempt at 32-bit compatible modules.
Admin:
  Tested that modules build 26-bit and 32-bit.
  Requires HdrSrc-1_05 or later.

Version 4.44, 4.1.2.1. Tagged as 'PDModules-4_44-4_1_2_1'
@
text
@a39 1
        ; V will be clear on entry to this routine - guaranteed above
d42 1
a42 1
        MOV     pc, lr                  ;Return if monochrome output
d63 1
a63 1
        SUBS    R1,R1,#1                ;Then loop if necessary (will not set V)
d65 1
a65 1
        MOV     pc, lr
d271 1
a271 1

d351 1
a351 1

d393 1
a393 2
        CLRV
        MOV     pc, lr
@


4.3.2.2
log
@  Lots of fixes.
Detail:
  Several stack imbalances and missing conditions on instructions fixed.
  Some flag removal code sequences improved (RSB rn,pc,pc:SUB rn,lr,rn)
Admin:
  Built both 26 and 32-bit versions - neither tested.

Version 4.44, 4.1.2.2. Tagged as 'PDModules-4_44-4_1_2_2'
@
text
@d43 1
a43 1
        MOVEQ   pc, lr                  ;Return if monochrome output
@


4.3.2.3
log
@  More fixes.
Detail:
  26-bit builds work again - a stack imbalance in PDriverDP has been fixed.
  Tidied up some nasty code that effected an EOR in a convoluted manner.  It
    now uses an EOR instruction instead of loads of TSTs and TEQP.
Admin:
  26-bit build tested very briefly - no longer dies.
  32-bit build dies still.

Version 4.44, 4.1.2.3. Tagged as 'PDModules-4_44-4_1_2_3'
@
text
@d394 2
a395 1
        RETURNVC
@


4.2
log
@Version Spin_merge taken
@
text
@d343 1
a343 1
        ADR     r5, enumeration_buf
@


4.1
log
@Initial revision
@
text
@d108 4
d147 4
d319 2
d388 4
@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@a107 4
;record whether Level 2
        LDRB    r14, globallevel2
        STRB    r14, joblevel2

a142 4
;initialise bput buffering
        MOV     R14,#0
        STRB    R14,bputNbuff

a310 2
;make sure output is flushed
        BLVC    bput_flush
a377 4
        Push    "LR"
        BL      bput_flush
        Pull    "PC"

@


4.1.7.2
log
@Fixed data abort on init
@
text
@d343 1
a343 1
        ADRL    r5, enumeration_buf
@


4.1.5.1
log
@Import from SrcFiler
@
text
@a107 4
;record whether Level 2
        LDRB    r14, globallevel2
        STRB    r14, joblevel2

a142 4
;initialise bput buffering
        MOV     R14,#0
        STRB    R14,bputNbuff

a310 2
;make sure output is flushed
        BLVC    bput_flush
a377 4
        Push    "LR"
        BL      bput_flush
        Pull    "PC"

@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@a107 4
;record whether Level 2
        LDRB    r14, globallevel2
        STRB    r14, joblevel2

a142 4
;initialise bput buffering
        MOV     R14,#0
        STRB    R14,bputNbuff

a310 2
;make sure output is flushed
        BLVC    bput_flush
a377 4
        Push    "LR"
        BL      bput_flush
        Pull    "PC"

@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
