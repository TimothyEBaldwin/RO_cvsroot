head	4.10;
access;
symbols
	PDModules-4_64:4.10
	PDModules-4_63:4.10
	PDModules-4_62:4.10
	PDModules-4_61:4.10
	PDModules-4_60:4.10
	PDModules-4_59:4.10
	PDModules-4_58:4.9
	PDModules-4_57:4.9
	PDModules-4_56:4.9
	PDModules-4_55:4.9
	PDModules-4_54:4.9
	PDModules-4_53:4.9
	PDModules-4_52:4.8
	PDModules-4_51:4.8
	PDModules-4_50:4.7
	PDModules-4_49:4.6
	PDModules-4_48:4.6
	PDModules-4_47:4.6
	PDModules-4_46:4.5
	kbracey_32bit_merge:4.4
	PDModules-4_45:4.4
	PDModules-4_44-4_1_2_7:4.4
	PDModules-4_44-4_1_2_6:4.4
	PDModules-4_44-4_1_2_5:4.4
	PDModules-4_44-4_1_2_4:4.4
	PDModules-4_44-4_1_2_3:4.4
	PDModules-4_44-4_1_2_2:4.4
	PDModules-4_44-4_1_2_1:4.4
	kbracey_32bit:4.4.0.2
	kbracey_32bit_bp:4.4
	dellis_autobuild_BaseSW:4.4
	Ursula_merge:4.1.7.4
	PDModules-4_44:4.4
	sbrodie_sedwards_16Mar2000:4.3
	dcotton_autobuild_BaseSW:4.5
	mstphens_UrsulaRiscPCBuild_20Nov98:4.1.7.4
	Ursula_RiscPC:4.1.7.4.0.4
	rthornb_UrsulaBuild-19Aug1998:4.1.7.4
	UrsulaBuild_FinalSoftload:4.1.7.4
	rthornb_UrsulaBuild-12Aug1998:4.1.7.4
	aglover_UrsulaBuild-05Aug1998:4.1.7.4
	rthornb_UrsulaBuild-29Jul1998:4.1.7.4
	rthornb_UrsulaBuild-22Jul1998:4.1.7.4
	hsimons_BOCA-1_2-Release:4.1.7.4
	rthornb_UrsulaBuild-15Jul1998:4.1.7.4
	rthornb_UrsulaBuild-07Jul1998:4.1.7.4
	rthornb_UrsulaBuild-17Jun1998:4.1.7.4
	rthornb_UrsulaBuild-03Jun1998:4.1.7.4
	rthornb_UrsulaBuild-27May1998:4.1.7.4
	rthornb_UrsulaBuild-21May1998:4.1.7.4
	rthornb_UrsulaBuild_01May1998:4.1.7.4
	afrost_NC2_Generic:4.1.7.4
	afrost_Funai01-33:4.1.7.4
	Ursula:4.1.7.4.0.2
	Ursula_bp:4.1.7.4
	Ursula_31Mar1998:4.3
	Spinner_RCA116:4.1.7.4
	Spinner_B20_2:4.1.7.4
	Spinner_19_3:4.1.7.4
	Spinner_B18:4.1.7.4
	Spinner_B17:4.1.7.4
	Spinner_B15:4.1.7.3
	Spinner_B14:4.1.7.3
	Spinner_B13:4.1.7.3
	Spinner_B12:4.1.7.3
	Spin_merge_28May97:4.1.7.3
	Spinner_B10:4.1.7.3
	Spin_merge_16May97:4.1.7.1
	Daytona:4.2.0.6
	Daytona_bp:4.2
	Spinner_B7:4.1.7.2
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	RCA_bp:4.2
	ARTtmp:4.1.7.1.0.2
	RCA:4.2.0.4
	Spin_merge:4.1.7.3
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.10
date	2014.10.20.21.53.02;	author rsprowson;	state Exp;
branches;
next	4.9;
commitid	kYvwc1FHitWAiZUx;

4.9
date	2007.11.05.17.15.42;	author srevill;	state Exp;
branches;
next	4.8;

4.8
date	2003.07.11.18.10.20;	author rsprowson;	state Exp;
branches;
next	4.7;

4.7
date	2003.03.10.11.33.27;	author rsprowson;	state Exp;
branches;
next	4.6;

4.6
date	2002.12.05.20.45.09;	author srevill;	state Exp;
branches;
next	4.5;

4.5
date	2001.09.18.16.09.01;	author mboura;	state Exp;
branches;
next	4.4;

4.4
date	2000.07.10.12.26.09;	author sbrodie;	state Exp;
branches;
next	4.3;

4.3
date	97.05.16.12.55.37;	author kbracey;	state Exp;
branches;
next	4.2;

4.2
date	97.01.21.17.07.43;	author nturton;	state Exp;
branches;
next	4.1;

4.1
date	96.11.05.09.48.34;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.5.1
	4.1.7.1;
next	;

4.1.1.1
date	96.11.05.09.48.34;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.06.03.04.10;	author nturton;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.13.27.06;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.21.30.51;	author nturton;	state Exp;
branches;
next	4.1.7.2;

4.1.7.2
date	97.04.30.17.46.03;	author scormie;	state Exp;
branches;
next	4.1.7.3;

4.1.7.3
date	97.05.14.09.36.02;	author jcoxhead;	state Exp;
branches;
next	4.1.7.4;

4.1.7.4
date	97.07.09.15.30.54;	author arodger;	state Exp;
branches;
next	;


desc
@@


4.10
log
@Some PDModule tidy ups
Core/FontSWI.s & PDriverDP/Font.s:
 The pointer compares are now unsigned, so raise the limit for printing strings in top bit set addresses when no length is passed in R7.
 Couple of comment typos.
Core/Header.s:
 A CVS merge mistake left behind two copies of Push/return sequence.
Core/PDriver.s:
 Unused VersionString removed.
PDriverDP/Macros.s & PDriverDP/ManageJob.s:
 Single use unhelpful debug message removed.
PDriverDP/Private2.s & Sprite.s & TranSprite.s:
 Use some of the defines from Hdr:Sprite.
Makefile:
 For ROMming, explicitly state there's no resources phase
PDriverDP/PageBox.s:
 Unjumble the set_sprite_output_state data. The MonoBufferOK and Libra1 switch happen to work when both are {TRUE} but other combinations would output a silly table. Let ObjAsm work out the size instead.

Tested briefly, still printed OK.

Version 4.59. Tagged as 'PDModules-4_59'
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
; > Core.PDriver

;;---------------------------------------------------------------------------
;;
;; New printer driver module
;;
;; This is version 4.00 (09-Jul-93) of the printer-independent source file.
;;   This version number exists purely for administrative purposes for this
;; file. It does not appear in the assembled module. The assembled module's
;; version number is set up in a previously assembled file (see below) and
;; is constrained to have the same major version number as this file (i.e.
;; to lie in the range 4.00 to 4.99).
;;
;;---------------------------------------------------------------------------

                GBLA    PISourceVersion
PISourceVersion SETA    400

; Note on the source file structure:
;   This source file contains those parts of the printer driver source that
; are common to all printer drivers, and GET directives to obtain the printer
; specific parts. All the printer specific parts for a particular printer are
; to be found in a subdirectory PDriver<some suffix> of &.sources - e.g. the
; PostScript specific parts are found in directory &.sources.PDriverPS2.
;   This source file attempts to document (near each of the appropriate GET
; directives) what each of these included source files should provide. Each
; of these places is marked with "***PRINTER SPECIFIC INFORMATION***" in this
; source file.

; This file should not be the first file in an assembly. A preceding file
; should have set up the following assembly time variables:
;
;    PrinterType     A string containing an adjectival description of the
;                      printers driven.
;    PrinterNumber   An integer containing the number returned in the top
;                      16 bits of R0 by PDriver_Info.
;    VersionNumber   An integer containing 100 times the version number of
;                      the printer driver concerned. Printer drivers based
;                      on this version of the printer-independent code
;                      should be given version numbers in the range 3.00 to
;                      3.99 (this is to help applications which need and/or
;                      can use the facilities supplied in this interface
;                      and not in the original printer driver interface).
;    DirSuffix       A 2 character string - this specifies the directory
;                      &.sources.PDriver<DirSuffix>, which contains all the
;                      printer-dependent source files.
;
; The preceding file may also have set up other assembly time variables to
; control options in the printer-dependent code.

                GBLA    VersionNumber
VersionNumber   SETA    Module_Version

                [       VersionNumber < 100*(PISourceVersion/100)
                !       8,"Version number too low for this source file"
                ]

                [       VersionNumber > 100*(PISourceVersion/100)+99
                !       8,"Version number too high for this source file"
                ]

                ASSERT  VersionNumber < &10000
                ASSERT  PrinterNumber < &10000
                GBLA    FullVersion
FullVersion     SETA    (PrinterNumber:SHL:16) + VersionNumber


; Set this to build in support for Medusa screen modes & sprites.  The module
; thus formed should run on non-Medusa platforms, but only to the extent that
; the rest of the OS allows (e.g. no truecolour support).

                GBLL    Medusa
Medusa          SETL    VersionNumber >= 400


; Set this to build in support for UCS text strings
                GBLL        UCSText
UCSText         SETL        {TRUE}


; The following conditional assembly flags are to do with whether various
; features of the full printer driver spec are implemented.
;   N.B. At present these are here mainly for documentation purposes, to
; describe the plotting calls that could be implemented but haven't been.
; I do not recommend changing them.

                GBLL    RealDottedLines
RealDottedLines SETL    {FALSE}                 ;VDU dotted lines will be
                                                ;  plotted solid.
;RealDottedLines SETL    {TRUE}                  ;VDU dotted lines will be
;                                                ;  plotted properly.

                GBLL    DoFontSpriteVdu
DoFontSpriteVdu SETL    {FALSE}                 ;Font and sprite VDU 23 and
                                                ;  25 sequences not done
;DoFontSpriteVdu SETL    {TRUE}                  ;Font and sprite VDU 23 and
;                                                ;  25 sequences are done

                GBLL    DoPaintCharSc
DoPaintCharSc   SETL    {FALSE}                 ;OS_SpriteOp with reason
                                                ;  PaintCharScaled not done
;DoPaintCharSc   SETL    {TRUE}                  ;OS_SpriteOp with reason
;                                                ;  PaintCharScaled is done

; Whether various bug fixes to do with font colours have been applied.
; (30-08-89: these bug found and fixed.)

                GBLL    FontColourFixes
FontColourFixes SETL    {TRUE}                  ;Apply the fixes
;FontColourFixes SETL    {FALSE}                 ;Apply the fixes

; Bug fix - bitmap printers used to set the background colour and then
; call Draw to fill background rectangles, which was intercepted and
; set the colour to the foreground before plotting. This is avoided by
; using a reserved bit in the draw fill style (bit 16). These switches
; allow the use of this new bit

                GBLL    PrinterDrawBit
PrinterDrawBit  SETL    {TRUE}                  ;True if 'printer internal call' draw bit is to be used
;PrinterDrawBit  SETL    {FALSE}                 ;True if 'printer internal call' draw bit is to be used


; Whether various errors are returned on vector interception, this
; flags when True allows errors to be returned on ColourV, SpriteV
; and DrawV.  These were removed to make compatiblity with future
; versions of the OS possible without having to re-issue versions
; of the printer drivers.

                GBLL    VectorErrors
VectorErrors    SETL    {FALSE}                 ;Don't generate vector errors
;VectorErrors    SETL    {TRUE}                  ;Do generate vector errors.

; Apply bug fix for font handles on ColourTrans_SetFontColours ensures
; that the handle is valid.

                GBLL    FontHandleEnsure
FontHandleEnsure SETL   {TRUE}                  ;Apply the bug fix
;FontHandleEnsure SETL   {FALSE}                 ;Don't apply it

;;---------------------------------------------------------------------------

        GET     Hdr:ListOpts
        GET     Hdr:Macros
        GET     Hdr:System
        GET     Hdr:ModHand
        GET     Hdr:Services
        GET     Hdr:Symbols
        GET     Hdr:FSNumbers
        GET     Hdr:HighFSI
        GET     Hdr:NewErrors
        GET     Hdr:Variables
        GET     Hdr:PDriver
        GET     Hdr:VduExt
        GET     Hdr:ColourTran
        GET     Hdr:Draw
        GET     Hdr:Sprite
        GET     Hdr:SprExtend
        GET     Hdr:Font
        GET     Hdr:PDumper
        GET     Hdr:Proc
        GET     Hdr:MsgTrans
        GET     Hdr:PaletteV
        GET     Hdr:EnvNumbers
        GET     Hdr:UpCall

;
; Host Debug stuff; I have moved this into the Core section so that the Core
; routines can be debugged.

        GBLL    debug
        GBLL    hostvdu
        GBLL    debugCoreFont
        GBLL    debugMedusa

        GET     hdr:HostFS
        GET     hdr:NDRDebug

; Setting the 'debug' variable to FALSE will turn off all NDR debugging

debug           SETL    {TRUE} :LAND: BeingDeveloped
hostvdu         SETL    {FALSE}
debug_flush     SETL    {FALSE} :LAND: (:LNOT: hostvdu)
debug_file      SETS    "<PDrvDebug>"   ; JRC
;debug_module    SETL    {TRUE}

; NDRDebug ensures that the following only take effect if debug is TRUE

debugCoreFont   SETL    {FALSE}
debugMedusa     SETL    {FALSE} :LAND: Medusa


        GET     s.Core.Constants
        GET     s.Core.Workspace
        GET     s.Core.Header
        GET     s.Core.SWIs
        GET     s.Core.Colour
        GET     s.Core.Vdu5
        GET     s.Core.JobManager
        GET     s.Core.Intercept
        GET     s.Core.Wrch
        GET     s.Core.ColTrans
        GET     s.Core.Draw
        GET     s.Core.Sprite
        GET     s.Core.OSByte
        GET     s.Core.FontSWI
        GET     s.Core.JPEGSWI
        GET     s.Core.Device
        GET     s.Core.Error
        GET     s.Core.MsgCode

        END
@


4.9
log
@Fixed printing of UTF-8, UTF-16 and UCS-4 encoded text strings for bitmap
  printers (PDriverDP).
Detail:
  The device-independent part of the PDriver code processes command
  sequences in text strings. Additionally, it modifies the flags passed
  to Font_Paint by the client application. This resulted in the character
  width bits (12 and 13) of the Font_Paint flags being stripped and
  command sequences being mis-recognised when UTF-16 or UCS-4 text
  strings were printed.
 
  The PDriverDP device-specific part of the PDriver code prepends an
  underline command sequence (25,position,thickness) to the printed
  string. This resulted in 8bit data being prepended to a potentially
  16bit or 32bit string.
 
  The device-independent part has been fixed to preserve the character
  width bits in the Font_Paint flags. It has also gained the ability to
  process UTF-8, UTF-16 and UCS-4 characters correctly.
 
  The PDriverDP device-specific part has been fixed to insert commands of
  the correct bit-width for the text encoding being used.
Admin:
  PDriverDP tested on Iyonix RO 5.11 with NetSurf for UTF-16 text printing
  and Draw for UTF-8 printing (drawfile exported from NetSurf) and non-UCS
  printing to ensure no regressions occurred.
  PDriverPS tested on Iyonix RO 5.11 with NetSurf and Draw to ensure no
  regression in behaviour. Note that printing of UCS text with PDriverPS
  is not fixed by these changes.
Notes:
  Changes by John-Mark Bell

Version 4.53. Tagged as 'PDModules-4_53'
@
text
@a75 13
                GBLS   VersionString
VersionString   SETS   :CHR:("0"+VersionNumber:MOD:10)
VersionString   SETS   :CHR:("0"+VersionNumber/10:MOD:10):CC:VersionString
VersionString   SETS   ".":CC:VersionString
VersionString   SETS   :CHR:("0"+VersionNumber/100:MOD:10):CC:VersionString
                [      VersionNumber > 999
VersionString   SETS   :CHR:("0"+VersionNumber/1000:MOD:10):CC:VersionString
                ]
                [      VersionNumber > 9999
VersionString   SETS   :CHR:("0"+VersionNumber/10000:MOD:10):CC:VersionString
                ]
                ASSERT VersionNumber < 100000

@


4.8
log
@Unoptimised a RMA clearing loop: went mad if the workspace was not a
multiple of 3.
Changed PDumper Upcall stuff to pass R0-R12 on the stack - curiously this
fixes the RMA corruption and instability of !Printers (as does switching
the UpCalls off.

Version 4.51. Tagged as 'PDModules-4_51'
@
text
@d103 5
@


4.7
log
@Fix for the thingy which sits on SpriteV,it got optimised sometime round
2000 which led to it getting the "redirected to sprite" switch in a
muddle so printing from some apps ended up on the screen not in the
postscript file.
Changed the "%%Creator" string a bit.
Took the opportunity to eliminate all the signed pointer comparisons.
Tightened up the checking of pointers to palettes and translation tables
so that "0 or -1" means to use the default,not <= 0.

Version 4.50. Tagged as 'PDModules-4_50'
@
text
@a205 2
;debug_flush     SETL    {TRUE}
;debug_file     SETS    "ADFS::4.$.PDrvDbg2"
@


4.6
log
@Changed to use objasm to avoid any LDR rN,[rN],#0 problems
Changed to use shared Makefiles
Numerous small 32 bit conversion improvements
Bugfix to PDriverPS,it was pulling LR not PC - this has been the case for
many years so not sure how it ever worked.
Due to a bug in objasm 3.27 this checkin will infact not build directly.
You must first
 - rename the PDriverDP dir to PDriverDP2
 - rename the PDriverPS dir to PDriverPS2
 - move the 2 source files of the same name up a directory
checked in in this way to minimise messing in CVS.

Version 4.47. Tagged as 'PDModules-4_47'
@
text
@a166 1
;        GET     Hdr:NewSpace
d204 2
a205 2
debug_flush     SETL    {FALSE}    :LAND: (:LNOT: hostvdu)
debug_file	SETS	"<PDrvDebug>"	; JRC
d207 1
a207 1
;debug_file	SETS	"ADFS::4.$.PDrvDbg2"
@


4.5
log
@Added UpCall to provide information about what the dumper is doing.
Detail:
UpCall made at exit from dumper routines to enable page counting. Could also be used for things like progress indication. Code is in place for UpCall at entry to dumper, but not assembled at present.
Admin:
Tested with module provisionally called PMonitor.

Version 4.46. Tagged as 'PDModules-4_46'
@
text
@d27 1
a27 1
;;         
d38 1
a38 1
; PostScript specific parts are found in directory &.sources.PDriverPS.
d133 1
a133 1
                                                  
d188 1
a188 1
                       
d197 1
a197 1
                             
d203 2
a204 2
debug           SETL    true :LAND: BeingDeveloped
hostvdu         SETL    false
d207 3
a209 1
debug_module    SETL    {TRUE}
d214 2
a215 1
debugMedusa     SETL    false :LAND: Medusa
d220 1
a220 1
        GET     s.Core.SWIs 
@


4.4
log
@  Merged Ursula branch.
  Moved to srccommit.
Detail:
  Added fast service call table.
Admin:
  Tested briefly.

Version 4.44. Tagged as 'PDModules-4_44'
@
text
@d187 1
d207 1
@


4.3
log
@Spinner branch merged
@
text
@d65 3
@


4.2
log
@Version Spin_merge taken
@
text
@d183 1
d199 2
a200 3
debug           SETL    {FALSE}   :LAND: BeingDeveloped
;debug           SETL    {TRUE}
hostvdu         SETL    {TRUE}
d202 1
d207 1
a207 1
debugMedusa     SETL    {TRUE}    :LAND: Medusa
@


4.1
log
@Initial revision
@
text
@d199 1
@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@a198 1
;debug           SETL    {TRUE}
@


4.1.7.2
log
@   Use buffer in workspace for MessageTrans.
   Added 'Colour' debugging flag.
   Do not pass SpriteV calls to pdriver if a Wimp error box is open.
@
text
@d198 3
a200 2
debug           SETL    true :LAND: BeingDeveloped
hostvdu         SETL    false
a201 1
debug_file	SETS	"<PDrvDebug>"	; JRC
d206 1
a206 1
debugMedusa     SETL    false :LAND: Medusa
@


4.1.7.3
log
@   Enable escapes round all calls to PDumper.
   Replace the caller's escape handler with a NOP. Otherwise, we end
up calling the current escape handler when we acknowledge the escape,
which has potentially horrible consequences. In the case of the C
library, the escape handler is expecting to have to raise a signal,
and if it can't do this is generates an error instead.
@
text
@a182 1
        GET     Hdr:EnvNumbers
@


4.1.7.4
log
@Placed code in redirect output to check for the current state, so as not to duplicate the present output direction(jobspriteparams)
@
text
@d199 1
a199 1
debug           SETL    false :LAND: BeingDeveloped
d202 1
a202 1
debug_file	SETS	"Custom:Debug.parallel"	; JRC
@


4.1.5.1
log
@Import from SrcFiler
@
text
@a198 1
;debug           SETL    {TRUE}
@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@a198 1
;debug           SETL    {TRUE}
@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@
