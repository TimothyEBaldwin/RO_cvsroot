head	4.9;
access;
symbols
	PDumpers-1_46:4.9
	PDumpers-1_45:4.9
	PDumpers-1_44:4.9
	PDumpers-1_43:4.9
	PDumpers-1_42:4.9
	PDumpers-1_41:4.9
	RO_5_07:4.9
	PDumpers-1_40:4.9
	PDumpers-1_39:4.8
	PDumpers-1_38:4.8
	PDumpers-1_37:4.7
	PDumpers-1_36:4.6
	PDumpers-1_35:4.6
	PDumpers-1_33:4.5
	PDumpers-1_32:4.5
	PDumpers-1_31:4.5
	PDumpers-1_30:4.5
	PDumpers-1_29:4.5
	PDumpers-1_28:4.5
	PDumpers-1_27:4.5
	PDumpers-1_26:4.5
	PDumpers-1_25:4.5
	Spin_merge-1_21:4.1.7.2
	PDumpers-1_24:4.4
	PDumpers-1_23:4.4
	PDumpers-1_22:4.4
	dellis_autobuild_BaseSW:4.4
	PDumpers-1_21:4.4
	sbrodie_sedwards_16Mar2000:4.3
	dcotton_autobuild_BaseSW:4.5
	dcotton_MPT2_build_16061999:4.1.7.3
	dcotton_MPT_Build_10061999:4.1.7.3
	mstphens_UrsulaRiscPCBuild_20Nov98:4.1.7.2.2.2
	Ursula_RiscPC:4.1.7.2.2.2.0.2
	nicke_PDumpers-1_21:4.1.7.2
	rthornb_UrsulaBuild-19Aug1998:4.1.7.2.2.2
	UrsulaBuild_FinalSoftload:4.1.7.2.2.2
	rthornb_UrsulaBuild-12Aug1998:4.1.7.2.2.2
	aglover_UrsulaBuild-05Aug1998:4.1.7.2.2.2
	rthornb_UrsulaBuild-29Jul1998:4.1.7.2.2.2
	rthornb_UrsulaBuild-22Jul1998:4.1.7.2.2.2
	hsimons_BOCA-1_2-Release:4.1.7.2
	rthornb_UrsulaBuild-15Jul1998:4.1.7.2.2.2
	rthornb_UrsulaBuild-07Jul1998:4.1.7.2.2.2
	rthornb_UrsulaBuild-17Jun1998:4.1.7.2.2.1
	rthornb_UrsulaBuild-03Jun1998:4.1.7.2.2.1
	rthornb_UrsulaBuild-27May1998:4.1.7.2.2.1
	rthornb_UrsulaBuild-21May1998:4.1.7.2.2.1
	rthornb_UrsulaBuild_01May1998:4.1.7.2.2.1
	afrost_NC2_Generic:4.1.7.2
	afrost_Funai01-33:4.1.7.2
	Ursula:4.1.7.2.0.2
	Ursula_bp:4.1.7.2
	Ursula_31Mar1998:4.3
	Spinner_RCA116:4.1.7.2
	Spinner_B20_2:4.1.7.2
	Spinner_19_3:4.1.7.2
	Spinner_B18:4.1.7.2
	Spinner_B17:4.1.7.2
	Spinner_B15:4.1.7.2
	Spinner_B14:4.1.7.2
	Spinner_B13:4.1.7.2
	Spinner_B12:4.1.7.2
	Spin_merge_28May97:4.1.7.1
	Spinner_B10:4.1.7.2
	Spin_merge_16May97:4.1.7.1
	Daytona:4.2.0.6
	Daytona_bp:4.2
	Spinner_B7:4.1.7.1
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.1
	Spin_3Apr97:4.1.7.1
	RCA_bp:4.2
	ARTtmp:4.1.7.1.0.2
	RCA:4.2.0.4
	Spin_merge:4.1.7.3
	MergeFiles:4.1.3.1
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spinner:4.1.7
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	StrongARM:4.1.3;
locks; strict;
comment	@# @;


4.9
date	2004.08.12.15.38.04;	author jballance;	state Exp;
branches;
next	4.8;

4.8
date	2002.12.17.18.54.46;	author srevill;	state Exp;
branches;
next	4.7;

4.7
date	2002.12.14.11.41.56;	author rsprowson;	state Exp;
branches;
next	4.6;

4.6
date	2002.11.15.16.05.26;	author srevill;	state Exp;
branches;
next	4.5;

4.5
date	2001.01.03.16.30.02;	author sbrodie;	state Exp;
branches;
next	4.4;

4.4
date	2000.06.09.11.08.00;	author sbrodie;	state Exp;
branches;
next	4.3;

4.3
date	97.05.28.12.20.01;	author kbracey;	state Exp;
branches;
next	4.2;

4.2
date	97.01.21.10.02.46;	author nturton;	state Exp;
branches;
next	4.1;

4.1
date	96.11.06.03.11.21;	author nturton;	state Exp;
branches
	4.1.3.1
	4.1.5.1
	4.1.7.1;
next	;

4.1.3.1
date	96.11.06.03.11.21;	author nturton;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.21.13.32.20;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.21.34.06;	author nturton;	state Exp;
branches;
next	4.1.7.2;

4.1.7.2
date	97.05.22.10.49.12;	author jcoxhead;	state Exp;
branches
	4.1.7.2.2.1;
next	4.1.7.3;

4.1.7.3
date	99.06.10.12.54.33;	author dcotton;	state Exp;
branches;
next	;

4.1.7.2.2.1
date	98.04.28.12.45.56;	author rthornb;	state Exp;
branches;
next	4.1.7.2.2.2;

4.1.7.2.2.2
date	98.06.18.12.29.54;	author arodger;	state Exp;
branches;
next	;


desc
@@


4.9
log
@ Mod to PDumperCX to allow wider page printing than A4, and change
 to !MkInstall to build and install both PDumperCX and PDumperCX2
Detail:

Admin:
Tested at Castle


Version 1.40. Tagged as 'PDumpers-1_40'
@
text
@; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
; > StartPage



; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
;
; call: StartPage_Code
;
; in:   r0   = copies to do
;       r1   = file handle
;       r2   = strip type
;       r3   = number of blank pixel rows before start of data
;       r4  -> our private pdumper word for job
;       r5   = job workspace
;       r6   = number of blank pixels before start of line
;       r7   = horizontal and vertical resolution packed into a single word.
;
; out:  V clear;
;         r0 = number of copies to be performed
;         r3 = number of blank pixel rows before start of of image
;
;       V set;
;         r0 -> error block.
;
; This routine is called at the start of the page.  The routine will allow
; the PDumper to setup the printer and skip to the correct print position,
; the driver is also passed the number of copies to be performed.  Both
; of these values can be modified.  The device is also passed the horizontal
; margin for its own reference, this cannot be modified and it is assumed
; that the dumping routine will pad the line start with null bytes.
;
; The number of copies when returned should be non-zero, but the vertical
; skip should just be be +VE.
;

StartPage_Monochrome ROUT
StartPage_Grey ROUT
StartPage_Colour256 ROUT
StartPage_Multi         ROUT
StartPage_16Bit         ROUT
StartPage_24Bit         ROUT

        PDumper_Entry "R0-R2,R4,R6-R8"

        Debug   StartPage,"Copies to do",R0
        Debug   StartPage,"Vertical skip of",R3
        Debug   StartPage,"Left margin is",R6
        Debug   StartPage,"Packed resolution is",R7

        PDumper_Reset

        STR     R1,FileHandle          ;Stash the stream handle
        ADD     R5,R5,#pd_data          ;And point R5 at the configuration data

      [ Module_Version >= 012
        BL      sendextra               ;Stream out the extra sequence
      ]

        PDumper_AdjustFeed R6,R3,R5,R14

        MOV     R0, #0
        STR     R0, pending_line_ends

        LDRB    R0,[R5,#pd_data_version - pd_data]
        TEQ     R0,#0                   ;Is version number zero?
        LDRNEB  R0,[R5,#pd_data_set_lines]
        TEQNE   R0,#0                   ;Is there a set lines string?
        LDRNEB  R8,[R5,#pd_data_num_lines]
        TEQNE   R8,#0                   ;Is the number of lines zero?
        BEQ     %FT12

        ADD     R0,R5,R0                ;Output the set lines string
        PDumper_PrintCountedString R0,R1,R2
        PDumper_OutputReg R8            ; Output the number of lines
12
        LDRB    R0,[R5,#pd_data_page_start]
        TEQ     R0,#0                   ;Is there any page start sequences?
        BEQ     %FT10

        ADD     R0,R5,R0
        PDumper_PrintCountedString R0,R1,R2
10
        LDRB    R8,[R5,#pd_private_flags -pd_data]
        TST     R8,#df_NoPageAdvance    ;Is full page advance allowed?
        MOVNE   r3, #0                  ; No - default skip to zero
        LDRNEB  r0, [r5, #pd_data_version - pd_data]
        TEQNE   r0, #0                  ; Is data version zero?
        LDRNE   r3, [r5, #pd_data_roll_advance] ; No - load small skip

;set left margin
      [ :DEF: BuildCX2
        Push    "R0-R2,R7-R8"
        ADR     R0,cx_page_margins
      |
        Push    "R0-R2,R7"
        ADR     R0,cx_left_margin
      ]
        PDumper_PrintCountedString R0,R1,R2
        BIC     R7,R7,#&FF000000
        BIC     R7,R7,#&00FF0000  ;select just the horizontal resolution
      [ :DEF: BuildCX2
        MOV     R2,#120           ;we can set left margin in 1/60'ths inch - allow for rounding
                                  ; AND we divide by 2 later!!
        MUL     R6,R2,R6
        MOV     R0,#&8000         ; default the page length
        PDumper_PrintBinaryPair_HighFirst R0,R8
      |
        MOV     R2,#20            ;we can set left margin in 1/10'ths inch - allow for rounding
        MUL     R6,R2,R6
      ]
        DivRem  R0,R6,R7,R1
        ADD     R0,R0,#1          ;round to nearest
        MOV     R0,R0,LSR #1
      [ :DEF: BuildCX2
        PDumper_PrintBinaryPair_HighFirst R0,R8 ; Left margin
        MOV     R2, #&8000        ; default the right margin huge
;        MOV     R2, #480          ; right margin =8inch at 60dpi
        PDumper_PrintBinaryPair_HighFirst R2,R8 ; Right Margin
        MOV     R0,#0             ; default the offset
        PDumper_PrintBinaryPair_HighFirst R0,R8
        Pull    "R0-R2,R7-R8"
      |
        PDumper_OutputReg R0      ; Left margin
        MOV     R2, #80
        PDumper_OutputReg R2      ; Right Margin
        Pull    "R0-R2,R7"
      ]

;vertical skip to start
        CMP     R3,#0
        BLE     %FT20
        Push    "R0-R2"
        ADR     R0,cx_vertskip
        PDumper_PrintCountedString R0,R1,R2
        PDumper_PrintBinaryPair_HighFirst R3,R1
        MOV     R3,#0                   ;we've handled initial skip
        Pull    "R0-R2"

20
        PDumper_EmptyBuffer
        PDumper_Exit                    ;Flush the buffer and then return
 
 [ :DEF: BuildCX2
; sets extended page margins, need
; page length hi..lo   n/60 inch .. undef = maxpagelen
; left margin hi..lo   n/60 inch .. from first printable position + offset (default 0)
; right margin hi..lo  n/60 inch .. undef = max width (default 0x8000)
; offset hi..lo        n/60 inch .. from first printable position (default 0)
cx_page_margins = 5,27,"(","p",8,0
        ALIGN
 |
;sets 0 for page length, which should leave length at current setting
cx_left_margin = 6,27,"(","g",3,0,0
        ALIGN
 ]
cx_vertskip = 5,27,"(","e",2,0
        ALIGN

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

        GetIf   ^.Generic.SendExtra.s, Module_Version >= 012
$GetConditionally

; +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

        END

@


4.8
log
@Build changes,no code changes.
Took out the bodge of prefixing all the files GOT from the Generic
directory with a G,and replaced it with use of new flag "-J" in objasm.
Improved clean rule in top MakeFile.
Deleted some unused !Mk files.

Version 1.38. Tagged as 'PDumpers-1_38'
@
text
@d130 2
a131 1
        MOV     R2, #480          ; right margin =8inch at 60dpi
@


4.7
log
@Turned off 10k leading zero switch in PDumperLJ,this broke more than
it fixed but will almost certainly mean HP810C's wont work now.
Added PDumperCX2 dumper,infact this is derived from PDumperCX since
they're closely related - new Canon printers use 16 bit margin setup
code whereas old ones used 8 bit margin setup.

Version 1.37. Tagged as 'PDumpers-1_37'
@
text
@d174 1
a174 1
        GetIf   ^.Generic.GSendExtra.s, Module_Version >= 012
@


4.6
log
@Renamed generic driver sources
Makefiles rewritten
Converted to use objasm
First pass at 32 bit compatibility.

Version 1.34. Tagged as 'PDumpers-1_34'
@
text
@d53 3
a55 3
StartPage_Multi		ROUT
StartPage_16Bit		ROUT
StartPage_24Bit		ROUT
d105 4
d111 1
d115 7
d124 1
d128 11
a138 3
        PDumper_OutputReg R0	; Left margin
        MOV	R2, #80
 	PDumper_OutputReg R2    ; Right Margin
d140 1
d155 10
a164 1

d168 1
a168 1

@


4.5
log
@  Merge of Spinner branch.
Detail:
  All Makefiles now export the PDumper header.
Admin:
  Fixes from the spinner branch have been merged in.
  Should now build in the build system.

Version 1.25. Tagged as 'PDumpers-1_25'
@
text
@d143 1
a143 1
        GetIf   ^.Generic.s.SendExtra, Module_Version >= 012
@


4.4
log
@32-bit compatible.

Version 1.21. Tagged as 'PDumpers-1_21'
@
text
@d115 3
a117 1
        PDumper_OutputReg R0
d135 1
a135 1
cx_left_margin = 6,27,"(","g",2,0,0
@


4.3
log
@Spinner branch taken
@
text
@d68 2
a69 2
                         
      [ Version >= 012
d141 1
a141 1
        GetIf   ^.Generic.s.SendExtra, Version >= 012
@


4.2
log
@Module merged
@
text
@d53 3
d105 1
a105 22
;
;if there is a pd_data_zero_skip 'string' it is actually parameters for the Esc ( g
;command: byte 0 = page length value (1/10 inch units)
;              1 = max allowable left margin value (1/10 inch) (currently ignored)
;              2 = no. of other parameters to send (nx = 0,1 or 2)
;              3 = right margin value (1/10 inch) (if nx > 0)
;              4 = offset value (1/60 inch) (if nx > 1)
;the max left margin (if not ignored) could fix the problem of printer ignoring
;settings if right-left is less than 1 inch - luckily this typically only arises for
;printouts with left margin of 7 inches or more
;
;if there is no pd_data_zero_skip 'string', a default (2 parameter) Esc ( g is sent
;to set the left margin (this is as version 1.17 would always do
;
        Push    "R0-R4,R7,R8"
        LDRB    R3,[R5,#pd_data_zero_skip]  ;is there a zero-skip string?
        ADD     R4,R5,R3          ;point to string count byte, if any
        ADD     R4,R4,#1          ;point to first useful byte (page length)
        TEQ     R3,#0
        MOVEQ   R8,#2             ;no. of params, defaults to 2
        LDRNEB  R8,[R4,#2]
        ADDNE   R8,R8,#2          ;else, no. of params is nx+2
a107 7
        PDumper_OutputReg R8      ; = no. of params
        MOV     R0,#0
        PDumper_OutputReg R0      ; = high byte of (no. of params)
        TEQ     R3,#0
        MOVEQ   R0,#0             ;default to page-length=0 - should mean no change
        LDRNEB  R0,[R4]
        PDumper_OutputReg R0      ; = page length
d115 2
a116 14
        PDumper_OutputReg R0      ; = left margin
        TEQ     R3,#0
        BEQ     %FT15
        ADD     R4,R4,#3          ;point to right margin value
        CMP     R8,#3
        BLT     %FT15
        LDRB    R0,[R4],#1
        PDumper_OutputReg R0      ; = right margin
        CMP     R8,#4
        BLT     %FT15
        LDRB    R0,[R4],#1
        PDumper_OutputReg R0      ; = offset
15
        Pull    "R0-R4,R7,R8"
d132 2
a133 1
cx_left_margin = 3,27,"(","g"
@


4.1
log
@Initial revision
@
text
@@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@d102 22
a123 1
        Push    "R0-R2,R7"
d126 7
d140 14
a153 2
        PDumper_OutputReg R0
        Pull    "R0-R2,R7"
d169 1
a169 2
;sets 0 for page length, which should leave length at current setting
cx_left_margin = 6,27,"(","g",2,0,0
@


4.1.7.2
log
@   Unbreak 15- and 24-bit strip-type code.
@
text
@a52 3
StartPage_Multi		ROUT
StartPage_16Bit		ROUT
StartPage_24Bit		ROUT
@


4.1.7.3
log
@Fixed margins bug.
@
text
@d68 1
a68 1

d115 1
a115 3
        PDumper_OutputReg R0	; Left margin
        MOV	R2, #80
 	PDumper_OutputReg R2    ; Right Margin
d133 1
a133 1
cx_left_margin = 6,27,"(","g",3,0,0
@


4.1.7.2.2.1
log
@Modified for Ursula
@
text
@a89 3
        ADR     R0, cx_reset
        PDumper_PrintCountedString R0,R1,R2
        
d133 1
a133 4
cx_reset = 7,27,"[","K",2,0,0,15
	ALIGN
	
cx_left_margin = 6,27,"(","g",2,0,0	; (page length), (LM), (RM), (OFFSET)
@


4.1.7.2.2.2
log
@fixed horozontal shift, added right margin to (g command.  This must be greater
than the left margin or this command is ignored.
@
text
@d118 1
a118 3
        PDumper_OutputReg R0	; Left margin
        MOV	R2, #80
 	PDumper_OutputReg R2    ; Right Margin
d139 1
a139 1
cx_left_margin = 6,27,"(","g",3,0,0	; (page length), (LM), (RM), (OFFSET)
@


4.1.5.1
log
@Import from SrcFiler
@
text
@d102 22
a123 1
        Push    "R0-R2,R7"
d126 7
d140 14
a153 2
        PDumper_OutputReg R0
        Pull    "R0-R2,R7"
d169 1
a169 2
;sets 0 for page length, which should leave length at current setting
cx_left_margin = 6,27,"(","g",2,0,0
@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@@
