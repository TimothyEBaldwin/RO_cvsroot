head	1.14;
access;
symbols
	BCM2835-0_71-1_70_2_2:1.13
	BCM2835-0_71:1.13
	BCM2835-0_70-1_70_2_1:1.13
	SMP:1.13.0.2
	SMP_bp:1.13
	BCM2835-0_70:1.13
	BCM2835-0_69:1.13
	BCM2835-0_68:1.13
	BCM2835-0_67:1.13
	BCM2835-0_66:1.13
	BCM2835-0_65:1.13
	BCM2835-0_64:1.13
	BCM2835-0_63:1.13
	BCM2835-0_62:1.13
	BCM2835-0_61:1.13
	BCM2835-0_60:1.13
	BCM2835-0_59:1.12
	BCM2835-0_58:1.12
	BCM2835-0_57:1.12
	BCM2835-0_56:1.12
	BCM2835-0_55:1.12
	BCM2835-0_53:1.12
	BCM2835-0_52:1.12
	BCM2835-0_51:1.12
	BCM2835-0_50:1.11
	BCM2835-0_49:1.11
	BCM2835-0_48:1.11
	BCM2835-0_47:1.11
	BCM2835-0_46:1.11
	BCM2835-0_45:1.11
	BCM2835-0_44:1.11
	BCM2835-0_43:1.11
	BCM2835-0_42:1.11
	BCM2835-0_41:1.11
	BCM2835-0_40:1.11
	BCM2835-0_39:1.11
	BCM2835-0_38:1.11
	BCM2835-0_37:1.11
	BCM2835-0_36:1.11
	BCM2835-0_35:1.11
	BCM2835-0_34:1.11
	BCM2835-0_33:1.11
	BCM2835-0_32:1.10
	BCM2835-0_31:1.10
	BCM2835-0_30:1.10
	BCM2835-0_29:1.10
	BCM2835-0_28:1.10
	BCM2835-0_27:1.10
	BCM2835-0_26:1.10
	BCM2835-0_25:1.10
	BCM2835-0_24:1.10
	BCM2835-0_23:1.10
	BCM2835-0_22:1.9
	BCM2835-0_21:1.9
	BCM2835-0_20:1.8
	BCM2835-0_19:1.7
	BCM2835-0_18:1.7
	BCM2835-0_17:1.7
	BCM2835-0_16:1.7
	BCM2835-0_15:1.7
	BCM2835-0_14:1.7
	BCM2835-0_13:1.7
	BCM2835-0_12:1.7
	BCM2835-0_11:1.6
	BCM2835-0_10:1.6
	BCM2835-0_09:1.6
	BCM2835-0_08:1.5
	BCM2835-0_07:1.5
	BCM2835-0_06:1.5
	BCM2835-0_05:1.4
	BCM2835-0_04:1.4
	BCM2835-0_03:1.3
	BCM2835-0_02:1.2
	BCM2835-0_01:1.1.1.1
	initial:1.1.1.1
	Vendor:1.1.1;
locks; strict;
comment	@# @;


1.14
date	2017.09.09.11.03.34;	author rool;	state dead;
branches;
next	1.13;
commitid	APWc8oJjayEiNv6A;

1.13
date	2016.10.15.14.05.06;	author rsprowson;	state Exp;
branches
	1.13.2.1;
next	1.12;
commitid	YmZHhYYljHDenfqz;

1.12
date	2016.01.08.21.37.44;	author jlee;	state Exp;
branches;
next	1.11;
commitid	7xtchPkzB0cvUaQy;

1.11
date	2014.04.29.13.11.43;	author bavison;	state Exp;
branches;
next	1.10;
commitid	XTukLgbliNPw0Ayx;

1.10
date	2012.09.08.23.39.47;	author jlee;	state Exp;
branches;
next	1.9;
commitid	5mzVM9Zii5AKHMjw;

1.9
date	2012.09.02.20.03.43;	author jlee;	state Exp;
branches;
next	1.8;
commitid	FetF3i2OxxUzHZiw;

1.8
date	2012.08.28.23.12.44;	author bavison;	state Exp;
branches;
next	1.7;
commitid	BMUpqstey7aoUmiw;

1.7
date	2012.07.15.12.00.54;	author bavison;	state Exp;
branches;
next	1.6;
commitid	MovUER9fG0yBBEcw;

1.6
date	2012.06.15.14.40.20;	author bavison;	state Exp;
branches;
next	1.5;
commitid	GozidpkBTrLSrO8w;

1.5
date	2012.05.24.11.30.09;	author bavison;	state Exp;
branches;
next	1.4;
commitid	ktC5TlFk2flF6Y5w;

1.4
date	2012.05.23.21.45.10;	author bavison;	state Exp;
branches;
next	1.3;
commitid	dyGUTwLbAf3ExT5w;

1.3
date	2012.05.22.23.56.21;	author jballance;	state Exp;
branches;
next	1.2;
commitid	9zrOo5VjFU0EiM5w;

1.2
date	2012.05.20.20.52.51;	author jballance;	state Exp;
branches;
next	1.1;
commitid	2BhE7hfsP23Glv5w;

1.1
date	2012.05.10.14.53.41;	author bavison;	state Exp;
branches
	1.1.1.1;
next	;
commitid	9gwxHjLZncMLBb4w;

1.13.2.1
date	2017.09.10.11.28.56;	author jlee;	state dead;
branches;
next	;
commitid	4Ldk9lS2jPl0UD6A;

1.1.1.1
date	2012.05.10.14.53.41;	author bavison;	state Exp;
branches;
next	;
commitid	9gwxHjLZncMLBb4w;


desc
@@


1.14
log
@Participate in keyboard scan dependencies
Detail:
  Add keyboard scan code with list of modules that the kernel needs to do the same.
  Reorder the HALEntries to match Kernel-5_89.
  Remove unused stub functions (now KbdScan exists).
Admin:
  Submission for USB bounty.

Version 0.72. Tagged as 'BCM2835-0_72'
@
text
@;
; Copyright (c) 2012, RISC OS Open Ltd
; Copyright (c) 2012, Adrian Lees
; All rights reserved.
;
; Redistribution and use in source and binary forms, with or without
; modification, are permitted provided that the following conditions are met: 
;     * Redistributions of source code must retain the above copyright
;       notice, this list of conditions and the following disclaimer.
;     * Redistributions in binary form must reproduce the above copyright
;       notice, this list of conditions and the following disclaimer in the
;       documentation and/or other materials provided with the distribution.
;     * Neither the name of RISC OS Open Ltd nor the names of its contributors
;       may be used to endorse or promote products derived from this software
;       without specific prior written permission.
; 
; THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
; IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
; ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
; LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
; CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
; SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
; INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
; CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
; ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
; POSSIBILITY OF SUCH DAMAGE.
;
; With many thanks to Broadcom Europe Ltd for releasing the source code to
; its Linux drivers, thus making this port possible.
;

        AREA    |ARM$$code|, CODE, READONLY, PIC

        GET     Hdr:ListOpts
        GET     Hdr:HALEntries
        GET     hdr.BCM2835
        GET     hdr.StaticWS

        EXPORT   HAL_KbdScanSetup
        EXPORT   HAL_KbdScan
        EXPORT   HAL_KbdScanFinish
        EXPORT   HAL_KbdScanInterrupt

        MACRO
        HALStub $str
        ; Might want to make this do something again?
        MEND

HAL_KbdScanSetup
        HALStub "HAL_KbdScanSetup"
        MOV     pc,lr

HAL_KbdScan
        HALStub "HAL_KbdScan"
        MOV     a1,#KbdFlag_Present :OR: KbdFlag_Done   ; signal keyboard scan complete
        MOV     pc,lr

HAL_KbdScanFinish
        HALStub "Hal_KbdScanFinish"
        MOV     pc,lr

HAL_KbdScanInterrupt
        HALStub "HAL_KbdScanInterrupt"
        MOV     pc,lr

        END

@


1.13
log
@Groundwork
IIC.s/Stubs.s:
Don't import workspace when it's not used
Top.s:
Move the dead loops to just after the vectors. In practice these are ineffectual because the firmware (now) loads the image at &8000 to please Linux, so we're mostly wasting our time producing ROM images with vectors at the start.
Pad image to &8000 so it can be loaded at 0 (using Kernel_Old=1 in config.txt) or &8000 (default).
Line up/capitalise a few stray mnemonics, use APCS register naming.
Call HAL_DebugTXStrInline for "HAL Init completed" rather than an inline loop, since earlier in the same function we called HAL_DebugTXStrInline happily.

Version 0.60. Tagged as 'BCM2835-0_60'
@
text
@@


1.13.2.1
log
@Merge latest changes from main branch

Version 0.73, 1.70.2.3. Tagged as 'BCM2835-0_73-1_70_2_3'
@
text
@@


1.12
log
@Fix build error. Add HAL_PlatformName implementation.
Detail:
  s/Stubs, s/Top - Remove references to deleted HAL ATA calls
  s/GPIO, s/Top - Add implementation of HAL_PlatformName. Located in s/GPIO to allow easy re-use of the board revision table.
Admin:
  Tested on Pi 2 Model B


Version 0.51. Tagged as 'BCM2835-0_51'
@
text
@a39 2
        IMPORT  workspace

d67 1
a67 1
                END
@


1.11
log
@  Make HAL report keyboard present during boot
Detail:
  Given the complexity of the USB system on the BCM2835, it seems unlikely
  that the HAL keyboard scan will ever be implemented. Not only does this
  mean it doesn't honour any of the CMOS reset or monitor configuration keys,
  but it means the kernel will always attempt to boot the configured
  filing system and drive, irrespective of the *Configure [No]Boot setting,
  after printing "No keyboard present - autobooting". By changing the HAL
  to report a keyboard present but with no keys held down, we at least get
  the [No]Boot option honoured again (even if the Shift key can't be used
  to invert its sense), and have the message suppressed.
Admin:
  Tested on a Raspberry Pi.

Version 0.33. Tagged as 'BCM2835-0_33'
@
text
@a41 2
        EXPORT   HAL_ATAControllerInfo

a51 5

HAL_ATAControllerInfo
        HALStub "HAL_ATAControllerInfo"
        MOV     pc,lr

@


1.10
log
@Implement HAL_PhysInfo. Other misc tweaks.
Detail:
  s/Top - Added HAL_PhysInfo implementation. Tweaked HAL_Reset to reduce chances of failure.
  s/Stubs - Removed obsolete, unused UART stubs. Use KbdFlag_Done instead of magic number.
Admin:
  Tested on Raspberry Pi


Version 0.23. Tagged as 'BCM2835-0_23'
@
text
@d65 1
a65 1
        MOV     a1,#KbdFlag_Done   ; signal keyboard scan complete
@


1.9
log
@Strip out video code & on-screen debug
Detail:
  Makefile, s/Display - Deleted on-screen debug code
  hdr/BCM2835, hdr/StaticWS, s/IIC, s/Messaging, s/Stubs, s/Top, s/UART - Strip out calls to on-screen debug code, and a few bits of video code
  s/Video - Video code removed and replaced with stub functions similar to other HALs. Only remaining useful code is HAL_Video_StartupMode, which in time should probably be moved to BCMVideo as well.
Admin:
  Tested on Raspberry Pi with high processor vectors


Version 0.21. Tagged as 'BCM2835-0_21'
@
text
@d36 1
a53 26
HAL_UARTPorts
        HALStub "HAL_UARTPorts"
        MOV     a1,#0
        MOV     pc,lr

HAL_UARTStartUp
HAL_UARTShutdown
HAL_UARTFeatures
HAL_UARTReceiveByte
HAL_UARTTransmitByte
HAL_UARTLineStatus
HAL_UARTInterruptEnable
HAL_UARTRate
HAL_UARTFormat
HAL_UARTFIFOSize
HAL_UARTFIFOClear
HAL_UARTFIFOEnable
HAL_UARTFIFOThreshold
HAL_UARTInterruptID
HAL_UARTBreak
HAL_UARTModemControl
HAL_UARTModemStatus
HAL_UARTDevice
        HALStub "HAL_UART<>"
        MOV     pc,lr

d65 1
a65 1
        MOV     a1,#&80000000   ; signal keyboard scan complete
@


1.8
log
@  Addition of I2C support
Detail:
  Implementation of the high-level HAL IIC interface provided by Dave Higton.
Admin:
  Checked it builds and runs at ROOL.

Version 0.20. Tagged as 'BCM2835-0_20'
@
text
@a40 8
     [ HALDebug
        IMPORT  output_hex8
        IMPORT  output_newline
        IMPORT  output_text
        IMPORT  output_text_at
     ]


d50 1
a50 12
    [  HALDebug
        STMFD   sp!,{a1,lr}
        ADR     a1,%FT01
        ADR     lr,%FT02
        B       output_text
01      =       "$str called from "
        ALIGN
02      LDR     a1,[sp,#4]
        BL      output_hex8
        BL      output_newline
        LDMFD   sp!,{a1,lr}
    ]
@


1.7
log
@  Support for reading (fake) CMOS
Detail:
  * Moved the NVMemory entries out of s.Stubs into s.CMOS.
  * Removed default list of CMOS contents and replaced with a block of zeros.
    It was never in physical address order and wasn't being used anyway.
    Default CMOS belongs in the kernel in any case.
  * Reports NVMemory type 3 (HAL calls) rather than 0 (no CMOS).
  * No longer reports a Delete power-on (CMOS reset) on every boot.
Admin:
  Tested on Raspberry Pi

Version 0.12. Tagged as 'BCM2835-0_12'
@
text
@a47 5
        EXPORT   HAL_IICBuses
        EXPORT   HAL_IICType
        EXPORT   HAL_IICDevice
        EXPORT   HAL_IICTransfer
        EXPORT   HAL_IICMonitorTransfer
a71 20
HAL_IICBuses
        MOV     a1,#0
        MOV     pc,lr

HAL_IICType
        HALStub "HAL_IICType"
        MOV     pc,lr

HAL_IICDevice
        HALStub "HAL_IICDevice"
        MOV     pc,lr

HAL_IICTransfer
        HALStub "HAL_IICTransfer"
        MOV     pc,lr

HAL_IICMonitorTransfer
        HALStub "HAL_IICMonitorTransfer"
        MOV     pc,lr

@


1.6
log
@  SD support, and miscellaneous other changes
Detail:
  * Bugfix to HAL_FIQDisableAll - it wasn't clearing the FIQ register (would
    only have caused trouble in practice if the same device was subsequently
    enabled as an IRQ).
  * Added a load of memory barriers to s.Interrupts and s.Timers to conform
    to the requirement stated in 1.3 of the datasheet.
  * Added a HAL device for the Arasan SDHCI controller. Note that this does
    not currently work reliably, and results vary from card to card. High
    speed support is currently disabled until we are able to verify that it
    works reliably.
  * Added a sprinkling of "GET Hdr:ListOpts" because the space reserved for
    the SDHCI HAL device in hdr.StaticWS is determined by including
    Hdr:HALDevice and Hdr:SDHCIDevice, which need it.
  * When support for saving "CMOS" to the SD card is added, the ROM image
    file (kernel.img) is the only one we can count on the bootloader
    installing in memory, so I think we're going to have to work using the
    table in s.CMOS. Broadcom seems to like messing around with the space
    just after the processor vector table, so rather than adding a pointer
    to the table there, I've opted to mark it using a magic word.
Admin:
  Tested on a Raspberry Pi - as noted above, there are reliability issues.

Version 0.09. Tagged as 'BCM2835-0_09'
@
text
@a38 2
        IMPORT  cmos

a53 8
        EXPORT   HAL_NVMemoryType
        EXPORT   HAL_NVMemorySize
        EXPORT   HAL_NVMemoryPageSize
        EXPORT   HAL_NVMemoryProtectedSize
        EXPORT   HAL_NVMemoryProtection
        EXPORT   HAL_NVMemoryRead
        EXPORT   HAL_NVMemoryWrite

a96 32
HAL_NVMemoryType
        HALStub "HAL_NVMemoryType"
        MOV     a1,#0
        MOV     pc,lr

HAL_NVMemorySize
        MOV     a1,#2048
        MOV     pc,lr
HAL_NVMemoryPageSize
        MOV     a1,#2048
        MOV     pc,lr
HAL_NVMemoryProtectedSize
        MOV     a1,#0
        MOV     pc,lr
HAL_NVMemoryProtection
        MOV     a1,#0
        MOV     pc,lr
HAL_NVMemoryRead
        ADRL    ip,cmos
        ADD     ip,ip,a1
        MOVS    a1,a3
nvr_lp  LDRNEB  a4,[ip],#1
        STRNEB  a4,[a2],#1
        SUBNES  a3,a3,#1
        BNE     nvr_lp
        MOV     pc,lr

HAL_NVMemoryWrite
;       HALStub "HAL_NVMemoryWrite"
        MOV     a1,a3
        MOV     pc,lr

a134 1
        ORR     a1,a1,#&00040   ; .. Del pressed
@


1.5
log
@  Whitespace changes
Detail:
  Substituted remaining hard spaces with normal ones and expanded tabs.
  This now matches the de facto standard for other components, and also looks
  better in the CVS web viewer.
Admin:
  No code changes

Version 0.06. Tagged as 'BCM2835-0_06'
@
text
@d35 1
@


1.4
log
@  Complete rework of timer and interrupt code
Detail:
 * Moved interrupt and timer code out of s.Stubs - they're not stubs any more.
 * Rewrote timer and counter code to use GPU system timer 1 for our Timer0
   rather than the ARM timer. This is recommended in the Broadcom datasheet
   because it's driven from the APB clock and so its speed will vary in
   reduced or low power mode.
 * HAL_CounterDelay now, well, does a delay!
 * Added a Timer1, driven from GPU system timer 3 - common code with Timer0.
 * Reshuffled device numbers so the GPU interrupts are at the bottom. This
   works better for FIQs and makes Timer0 the lowest priority interrupt.
 * Higher device numbers are now consistently treated as higher priority.
 * Stopped using bits 8-31 of the basic interrupt registers. These can't be
   masked, so they cause the kernel to lock up if generated, which happens
   if the GPU interrupt which they alias is generated (which appears to
   include the timers even though this is not documented).
 * Added definitions for all the interrupts, including those redacted from the
   datasheet - we need them at least for timers, USB and SD.
 * Stopped HAL_IRQClear from doing anything - this interrupt controller
   doesn't do latching. To acknowledge timer interrupts, you should use
   HAL_TimerIRQClear (and HAL_IRQClear too for compatibility with other ports).
 * Implemented HAL_IRQStatus and all the FIQ control routines.
 * Offsets to interrupt controller registers now use symbolic names.
 * Replaced some hard spaces in sources with normal ones.
Admin:
  Tested on a beta Raspberry Pi. Confirmed that interrupt handlers for both
  ARM and GPU sources can both be operational simultaneuosly. However, the FIQ
  code has not been tested. Timer0 is verified as running at the correct
  speed and reporting a count *down* in the correct range (not a count up as
  some previous versions did). HAL_CounterDelay appears correct also.

Version 0.04. Tagged as 'BCM2835-0_04'
@
text
@d33 1
a33 1
	AREA	|ARM$$code|, CODE, READONLY, PIC
d35 2
a36 2
	GET	hdr.BCM2835
	GET	hdr.StaticWS
d38 1
a38 1
	IMPORT	cmos
d40 1
a40 1
	IMPORT	workspace
d43 4
a46 4
	IMPORT	output_hex8
	IMPORT	output_newline
	IMPORT	output_text
	IMPORT	output_text_at
d70 2
a71 2
	MACRO
	HALStub	$str
d73 10
a82 10
	STMFD	sp!,{a1,lr}
	ADR	a1,%FT01
	ADR	lr,%FT02
	B	output_text
01	=	"$str called from "
	ALIGN
02	LDR	a1,[sp,#4]
	BL	output_hex8
	BL	output_newline
	LDMFD	sp!,{a1,lr}
d84 1
a84 1
	MEND
d87 2
a88 2
	MOV	a1,#0
	MOV	pc,lr
d91 2
a92 2
	HALStub "HAL_IICType"
	MOV	pc,lr
d95 2
a96 2
	HALStub	"HAL_IICDevice"
	MOV	pc,lr
d99 2
a100 2
	HALStub	"HAL_IICTransfer"
	MOV	pc,lr
d103 2
a104 2
	HALStub	"HAL_IICMonitorTransfer"
	MOV	pc,lr
d107 3
a109 3
	HALStub	"HAL_NVMemoryType"
	MOV	a1,#0
	MOV	pc,lr
d112 2
a113 2
	MOV	a1,#2048
	MOV	pc,lr
d115 2
a116 2
	MOV	a1,#2048
	MOV	pc,lr
d118 2
a119 2
	MOV	a1,#0
	MOV	pc,lr
d121 2
a122 2
	MOV	a1,#0
	MOV	pc,lr
d124 8
a131 8
	ADRL	ip,cmos
	ADD	ip,ip,a1
	MOVS	a1,a3
nvr_lp	LDRNEB	a4,[ip],#1
	STRNEB	a4,[a2],#1
	SUBNES	a3,a3,#1
	BNE	nvr_lp
	MOV	pc,lr
d134 3
a136 3
;	HALStub	"HAL_NVMemoryWrite"
	MOV	a1,a3
	MOV	pc,lr
d139 3
a141 3
	HALStub	"HAL_UARTPorts"
	MOV	a1,#0
	MOV	pc,lr
d161 2
a162 2
	HALStub	"HAL_UART<>"
	MOV	pc,lr
d166 2
a167 2
	HALStub	"HAL_ATAControllerInfo"
	MOV	pc,lr
d170 2
a171 2
	HALStub	"HAL_KbdScanSetup"
	MOV	pc,lr
d174 4
a177 4
	HALStub	"HAL_KbdScan"
	MOV	a1,#&80000000	; signal keyboard scan complete
	ORR	a1,a1,#&00040   ; .. Del pressed
	MOV	pc,lr
d180 2
a181 2
	HALStub	"Hal_KbdScanFinish"
	MOV	pc,lr
d184 2
a185 2
	HALStub	"HAL_KbdScanInterrupt"
	MOV	pc,lr
d187 1
a187 1
		END
@


1.3
log
@   Boots with May17th start.elf
Detail:
   Recent changes in the broadcom startup code now accomodated. frame buffer
   will now determine whether it is L2 cached or not, and be set up accordingly.
   ATAGs not currently read, so ram size defaulted.
  ** note that there will be further updates to this over the following days
  ** trackikng startup code changes.
   added HAL_TimerIRQClear entry
Admin:
  (highlight level of testing that has taken place)
  (bugfix number if appropriate)


Version 0.03. Tagged as 'BCM2835-0_03'
@
text
@d2 1
a2 1
; Copyright (c) 2012, RISC OS Open Ltd
d4 1
a4 1
; All rights reserved.
a47 27
        EXPORT   Interrupt_Init
        EXPORT   HAL_IRQEnable
        EXPORT   HAL_IRQDisable
        EXPORT   HAL_IRQClear
        EXPORT   HAL_IRQSource
        EXPORT   HAL_IRQStatus
        EXPORT   HAL_FIQEnable
        EXPORT   HAL_FIQDisable
        EXPORT   HAL_FIQDisableAll
        EXPORT   HAL_FIQClear
        EXPORT   HAL_FIQSource
        EXPORT   HAL_FIQStatus

        EXPORT   Timer_Init
        EXPORT   HAL_Timers
        EXPORT   HAL_TimerDevice
        EXPORT   HAL_TimerGranularity
        EXPORT   HAL_TimerMaxPeriod
        EXPORT   HAL_TimerSetPeriod
        EXPORT   HAL_TimerPeriod
        EXPORT   HAL_TimerReadCountdown
        EXPORT   HAL_TimerIRQClear
        
        EXPORT   HAL_CounterRate
        EXPORT   HAL_CounterPeriod
        EXPORT   HAL_CounterRead
        EXPORT   HAL_CounterDelay
a85 207
; interrupt pending registers are
;  basic & 0ffset 0, pending 1 @@ +4 and pending 2 @@ +8
; set amd clear are pending 1 @@ +0 and pending 2 @@ +4 and basic @@ +8
; device numbering is optimised for handling irqs


Interrupt_Init
        LDR     R0,PeriBase
        ADD     R0,R0,#IRQ_Base
        STR     R0,IRQ_Base_Address      
        MOV     pc, lr


HAL_IRQEnable
	CMN	a1,#1
	MOVEQ	pc,lr

        LDR     R12,IRQ_Base_Address
        ADD     R12,R12,#&10       ;   IRQ_Enables1
        MOV     R1,#1               
        MOV     R3,R0,LSR #5       ; shift to get relevant register
        SUBS    R3,R3,#1
        MOVMI   r3,#2              ; reorder which register
        AND     R2,R0,#&1F         ; get bit in register
        MOV     R1,R1,LSL R2
        DataSyncBarrier r2         ; resync before writing peripheral
        LDR     R2,[R12,R3,LSL #2]
        ORR     R0, R2, R1      
        STR     R0,[R12,R3,LSL #2] ; set the bit
        DataSyncBarrier r0         ; resync after reading peripheral
        MOV     PC,R14              

HAL_IRQDisable
	CMN	a1,#1
	MOVEQ	pc,lr

        LDR     R12,IRQ_Base_Address         
        ADD     R12,R12,#&1C       ;   IRQ_Disables1
        MOV     R1,#1               
        MOV     R3,R0,LSR #5        
        SUBS    R3,R3,#1
        MOVMI   r3,#2              ; reorder which register
        DataSyncBarrier r2         ; resync before writing peripheral
        AND     R2,R0,#&1F         ;
        MOV     R1,R1,LSL R2        
        LDR     R2,[R12,R3,LSL #2]
        ORR     R0, R2, R1      
        STR     R0,[R12,R3,LSL #2] ; set the bit
        DataSyncBarrier r0         ; resync after reading peripheral
        MOV     R0,#1               
        MOV     PC,R14              

; used only to clear any IRQs latched in the irq controller itself
HAL_IRQClear
        mov     pc, lr

; This (inefficiently) assumes a device num to each of the 96 possible IRQ bits 
HAL_IRQSource
        DataSyncBarrier a2          ; resync peripheral
        LDR     a2,IRQ_Base_Address
        LDR     a1,[a2]             ; Read IRQ_Pending register
        CLZ     a1, a1
        RSB     a1, a1, #31         ; first irq bit set
        DataSyncBarrier a2          ; resync peripheral
        TEQ     a1, #6
        BEQ     SourceGPOI1
        TEQ     a1, #7
        MOVNE   PC, R14
SourceGPOI2
        LDR     a1, [a2,#8]       ; pending reg 2
        CLZ     a1, a1
        RSB     a1, a1, #31       ; first irq bit set
        ADD     a1, a1, #64
        MOV     PC, R14    
SourceGPOI1   
        LDR     a1, [a2,#4]       ; pending reg 1
        CLZ     a1, a1
        RSB     a1, a1, #31       ; first irq bit set
        ADD     a1, a1, #32
        MOV     PC, R14    

HAL_IRQStatus
;	HALStub	"HAL_IRQStatus"
	MOV	a1,#0
	MOV	pc,lr

HAL_FIQEnable
;	HALStub	"HAL_FIQEnable"
	MOV	pc,lr

HAL_FIQDisable
;	HALStub	"HAL_FIQDisable"
	MOV	a1,#0
	MOV	pc,lr

HAL_FIQDisableAll
;	HALStub	"HAL_FIQDisableAll"
	MOV	pc,lr

HAL_FIQClear
;	HALStub	"HAL_FIQClear"
	MOV	pc,lr

HAL_FIQSource
;	HALStub	"HAL_FIQSource"
	MOV	a1,#-1
	MOV	pc,lr

HAL_FIQStatus
;	HALStub	"HAL_FIQStatus"
	MOV	a1,#0
	MOV	pc,lr

Timer_Init
        DataSyncBarrier r0             ; resync before writing peripheral
        LDR     R0,PeriBase
        ADD     R1,R0,#Timer_Base      ; system timer/counter base address
        STR     R1,ARM_Counter_IO_Address
        ADD     R1,R0,#ARM_Timer_Base  ; arm timer base address
        STR     R1,ARM_Timer_IO_Address
        LDR     r2, =&000102a0         ; set prescaler and set timer going
        STR     r2,[r1,#8]             ; turn timer on
        MOV     pc, lr


HAL_Timers
;	HALStub	"HAL_Timers"
	MOV	a1,#1
	MOV	pc,lr

HAL_TimerDevice
;	HALStub	"HAL_TimerDevice"
        MOV     a1,#iDev_ARM_Timer
	MOV	pc,lr

HAL_TimerGranularity
;	HALStub	"HAL_TimerGranularity"
        LDR     a1,=TIMER_RATE
	MOV	pc,lr

HAL_TimerMaxPeriod
;	HALStub	"HAL_TimerMaxPeriod"
	MOV	a1,#&10000
	MOV	pc,lr

HAL_TimerSetPeriod
;	HALStub	"HAL_TimerSetPeriod"
        teq     a1, #0                  ; only understand timer 0
        movne   pc, lr
        DataSyncBarrier r0              ; resync before writing peripheral
        LDR     R0,ARM_Timer_IO_Address
        STR     R1,[R0,#0]
	MOV	pc,lr

HAL_TimerPeriod
;	HALStub "HAL_TimerPeriod"
	MOV	a1,#&10000
	MOV	pc,lr

HAL_TimerReadCountdown
;	HALStub	"HAL_TimerReadCountdown"
        LDR     a1,ARM_Counter_IO_Address
	LDR	a1,[a1,#4]
	MOV	a2,#1
	MVN	a1,a1,LSL #16
	ADD	a1,a2,a1,LSR #16
        DataSyncBarrier a2             ; resync after reading peripheral
	MOV	pc,lr

; a0 is timer to clear =0 for system timer
HAL_TimerIRQClear
        DataSyncBarrier a2           ; resync before writing peripheral
        ldr     a2, ARM_Timer_IO_Address
        mov     a1, #1               ; timer device irq bit
        str     a1, [a2,#12]         ; clear the timer irq
        mov     pc,lr

HAL_CounterRate
;	HALStub "HAL_CounterRate"
	LDR	a1,=1000000
	MOV	pc,lr

HAL_CounterPeriod
;	HALStub "HAL_CounterPeriod"
	;!!! can we specify a period of 2^32?
	MOV	a1,#&10000
	MOV	pc,lr

HAL_CounterRead
;	HALStub "HAL_CounterRead"
        LDR     a1,ARM_Counter_IO_Address
	LDR	a1,[a1,#4]
	MOV	a1,a1,LSL #16
	MOV	a1,a1,LSR #16
	MOV	pc,lr


HAL_CounterDelay
;	HALStub "HAL_CounterDelay"
        LDR     a4,ARM_Counter_IO_Address
	LDR	a2,[a4,#4]
01	LDR	a3,[a4,#4]
	SUB	a3,a3,a2
        DataSyncBarrier r1             ; resync after reading peripheral
	CMP	a3,a1
	MOV	pc,lr

@


1.2
log
@
  Update of HAL to incorporate separate development of HAL by J Ballance
  Will now compile against initial developemnt start.elf, and against the
  start.elf in general release at this date. (compile switch UseALBlob in
  hdr.BCM2835). Extended header defs, Updated IRQ stuff, HAL_FramebufferAddress
  Reworked Timers, + a number of other bits. Still work in progress.
Detail:
  (list files and functions that have changed)
Admin:
  Compiled and working - as far as it goes -. Will enable use with the current
  start.elf, and is (subject to any minor changes introduced) ready for use with the
  version due for release shortly which will provide the correct transparency operation,
  and a better aligned frame buffer

Version 0.02. Tagged as 'BCM2835-0_02'
@
text
@d69 2
a70 1

d165 1
d167 1
a167 16
        DataSyncBarrier a2           ; resync before writing peripheral
        teq     a1, #iDev_ARM_Timer  ; timer device
        ldreq   a2, ARM_Timer_IO_Address
        moveq   a1, #1               ; timer device irq bit
        streq   a1, [a2,#12]         ; clear the timer irq
        moveq   pc,lr
; code below needs to catch other devices
        MOV     R2, R0, LSR #32      ; which register?
        MOV     R2, R2, LSL #2       ; word offset         
        LDR     R1,IRQ_Base_Address
        AND     R0, R0, #&1f         ; isolate to within register
        MOV     R3,#1
        MOV     R3,R3,LSL R0
        STR     R3,[R1,R2]
        DataSyncBarrier r3           ; resync before writing peripheral
        MOV     PC,R14
d282 8
@


1.1
log
@Initial revision
@
text
@d48 1
a48 1

d61 1
a88 2
        EXPORT   HAL_DebugRX

d112 12
a123 2
INTERRUPT_TIMER		*	3
INTERRUPT_FLYBACK	*	-1
d129 14
a142 10
	LDR	ip, PeriBase
	ADD	ip, ip, #INTC_BASE
	ADD	ip, ip, #&10
	MOV	a2, #1
	MOV	a4, a1, LSR #5
	AND	a3, a1, #31
	MOV	a2, a2, LSL a3
	STR	a2, [ip, a4, LSL #2]
	MOV	a1, #0	; how do we get the previous state without using a cache?
	MOV	pc, lr
d148 15
a162 10
	LDR	ip, PeriBase
	ADD	ip, ip, #INTC_BASE
	ADD	ip, ip, #&1C
	MOV	a2, #1
	MOV	a4, a1, LSR #5
	AND	a3, a1, #31
	MOV	a2, a2, LSL a3
	STR	a2, [ip, a4, LSL #2]
	MOV	a1, #1	;!!! previous state
	MOV	pc,lr
d165 16
a180 8
	CMP	a1, #4
	LDRLS	a2, PeriBase
	ADDLS	a2, a2, #ST_BASE
	MOVLS	a3, #1
	MOVLS	a3, a3, LSL a1
	STRLS	a3, [a2]
	MOVLS	pc, lr
	MOV	pc,lr
d182 1
d184 22
a205 16
	; !!! single interrupt in use currently
	MOV	a1,#3
	MOV	pc,lr

;	LDR	a2, PeriBase
;	ADD	a2, a2, #ST_BASE
;	ANDS	a2, a2, #&F
;	MOVEQ	a1, #-1
;	MOVNE	a1, #0
;	TST	a2, #2
;	MOVNE	a1, #1
;	TST	a2, #4
;	MOVNE	a1, #2
;	TST	a2, #8
;	MOVNE	a1, #3
;	MOV	pc,lr
d239 12
d258 1
a258 1
	MOV	a1,#INTERRUPT_TIMER
d263 1
a263 1
	LDR	a1,=1000000
d273 5
d287 1
a287 2
	LDR	a1,PeriBase
	ADD	a1,a1,#ST_BASE
d292 1
d308 1
a308 2
	LDR	a1,PeriBase
	ADD	a1,a1,#ST_BASE
d317 1
a317 2
	LDR	a4,PeriBase
	ADD	a4,a4,#ST_BASE
d321 1
a322 3
;!!! removed - suspected of hanging?!
;	BLS	%BT01
;	HALStub "HAL_CounterDelay_done"
a402 3
HAL_DebugRX
	MOV	a1,#-1
	MOV	pc,lr
@


1.1.1.1
log
@  Initial import of BCM2835 (Raspberry Pi) HAL
Detail:
  Covers the basic functionality, but does require a customised start.elf
  to function. The vast majority is an entirely new implementation and is
  BSD licenced, but 4% (the Makefile and a handful of simple macros) are
  copied from pre-existing Castle-licenced code, so it lives under the
  "mixed" hierarchy. If other HALs are anything to go by, we'll end up
  having to add more Castle code (at least some C runtime functions) so it's
  probably juast as well.
Admin:
  Code received from Adrian Lees
@
text
@@
