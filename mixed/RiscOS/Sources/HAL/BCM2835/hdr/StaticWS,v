head	1.28;
access;
symbols
	BCM2835-0_75-1:1.27
	BCM2835-0_76:1.28
	BCM2835-0_75-1_70_2_4:1.26.2.2
	BCM2835-0_75:1.27
	BCM2835-0_74:1.27
	BCM2835-0_73-1_70_2_3:1.26.2.2
	BCM2835-0_73:1.27
	BCM2835-0_72:1.27
	BCM2835-0_71-1_70_2_2:1.26.2.2
	BCM2835-0_71:1.27
	BCM2835-0_70-1_70_2_1:1.26.2.1
	SMP:1.26.0.2
	SMP_bp:1.26
	BCM2835-0_70:1.26
	BCM2835-0_69:1.26
	BCM2835-0_68:1.25
	BCM2835-0_67:1.25
	BCM2835-0_66:1.24
	BCM2835-0_65:1.24
	BCM2835-0_64:1.24
	BCM2835-0_63:1.24
	BCM2835-0_62:1.24
	BCM2835-0_61:1.24
	BCM2835-0_60:1.23
	BCM2835-0_59:1.23
	BCM2835-0_58:1.22
	BCM2835-0_57:1.22
	BCM2835-0_56:1.22
	BCM2835-0_55:1.22
	BCM2835-0_53:1.21
	BCM2835-0_52:1.21
	BCM2835-0_51:1.20
	BCM2835-0_50:1.20
	BCM2835-0_49:1.19
	BCM2835-0_48:1.19
	BCM2835-0_47:1.19
	BCM2835-0_46:1.19
	BCM2835-0_45:1.18
	BCM2835-0_44:1.17
	BCM2835-0_43:1.17
	BCM2835-0_42:1.17
	BCM2835-0_41:1.17
	BCM2835-0_40:1.17
	BCM2835-0_39:1.17
	BCM2835-0_38:1.17
	BCM2835-0_37:1.17
	BCM2835-0_36:1.17
	BCM2835-0_35:1.17
	BCM2835-0_34:1.17
	BCM2835-0_33:1.17
	BCM2835-0_32:1.17
	BCM2835-0_31:1.17
	BCM2835-0_30:1.16
	BCM2835-0_29:1.16
	BCM2835-0_28:1.16
	BCM2835-0_27:1.16
	BCM2835-0_26:1.16
	BCM2835-0_25:1.16
	BCM2835-0_24:1.15
	BCM2835-0_23:1.14
	BCM2835-0_22:1.14
	BCM2835-0_21:1.13
	BCM2835-0_20:1.12
	BCM2835-0_19:1.11
	BCM2835-0_18:1.11
	BCM2835-0_17:1.11
	BCM2835-0_16:1.10
	BCM2835-0_15:1.10
	BCM2835-0_14:1.9
	BCM2835-0_13:1.8
	BCM2835-0_12:1.8
	BCM2835-0_11:1.8
	BCM2835-0_10:1.7
	BCM2835-0_09:1.6
	BCM2835-0_08:1.5
	BCM2835-0_07:1.5
	BCM2835-0_06:1.5
	BCM2835-0_05:1.4
	BCM2835-0_04:1.4
	BCM2835-0_03:1.3
	BCM2835-0_02:1.2
	BCM2835-0_01:1.1.1.1
	initial:1.1.1.1
	Vendor:1.1.1;
locks; strict;
comment	@# @;


1.28
date	2018.07.07.14.26.21;	author jlee;	state Exp;
branches;
next	1.27;
commitid	VQCRRsJLbDt0fdJA;

1.27
date	2017.07.31.22.09.50;	author jlee;	state Exp;
branches;
next	1.26;
commitid	xk6viwRsoGpALq1A;

1.26
date	2017.02.21.22.10.53;	author rsprowson;	state Exp;
branches
	1.26.2.1;
next	1.25;
commitid	vR1YulJPaRxOURGz;

1.25
date	2017.02.11.15.29.55;	author rool;	state Exp;
branches;
next	1.24;
commitid	zDDt6chYlHWb1yFz;

1.24
date	2016.10.15.14.30.23;	author rsprowson;	state Exp;
branches;
next	1.23;
commitid	bv5F1PmPdmWUvfqz;

1.23
date	2016.10.09.12.23.47;	author jlee;	state Exp;
branches;
next	1.22;
commitid	AegGZ5wtYn4r0tpz;

1.22
date	2016.03.26.21.29.30;	author jlee;	state Exp;
branches;
next	1.21;
commitid	R20Od6NioP8emc0z;

1.21
date	2016.03.25.19.59.11;	author jlee;	state Exp;
branches;
next	1.20;
commitid	ZKDMXPRZKhDfT30z;

1.20
date	2015.11.15.00.09.54;	author jlee;	state Exp;
branches;
next	1.19;
commitid	oJ6rSmtkg3Ajw7Jy;

1.19
date	2015.08.05.22.00.14;	author jlee;	state Exp;
branches;
next	1.18;
commitid	tfiAygPuGDQ738wy;

1.18
date	2015.07.26.18.58.01;	author jlee;	state Exp;
branches;
next	1.17;
commitid	n3kZvFwWGn3xmPuy;

1.17
date	2013.12.19.01.29.12;	author jlee;	state Exp;
branches;
next	1.16;
commitid	9aIOPJd7daoBkGhx;

1.16
date	2012.09.18.13.49.15;	author jlee;	state Exp;
branches;
next	1.15;
commitid	kPVw3k71agHe71lw;

1.15
date	2012.09.10.21.32.46;	author jlee;	state Exp;
branches;
next	1.14;
commitid	L45O4zI0nGicW1kw;

1.14
date	2012.09.08.12.46.10;	author jlee;	state Exp;
branches;
next	1.13;
commitid	B5V3jq9teWHw5Jjw;

1.13
date	2012.09.02.20.03.41;	author jlee;	state Exp;
branches;
next	1.12;
commitid	FetF3i2OxxUzHZiw;

1.12
date	2012.08.28.23.12.41;	author bavison;	state Exp;
branches;
next	1.11;
commitid	BMUpqstey7aoUmiw;

1.11
date	2012.08.02.00.43.29;	author jlee;	state Exp;
branches;
next	1.10;
commitid	p73b1WEma91lhUew;

1.10
date	2012.07.22.22.32.51;	author jballance;	state Exp;
branches;
next	1.9;
commitid	6IVuPWq7pOksSBdw;

1.9
date	2012.07.19.10.29.25;	author jballance;	state Exp;
branches;
next	1.8;
commitid	7w2Uohftp8BdY9dw;

1.8
date	2012.07.07.19.46.23;	author jlee;	state Exp;
branches;
next	1.7;
commitid	qeOmpWpRzmnerFbw;

1.7
date	2012.07.01.20.26.38;	author bavison;	state Exp;
branches;
next	1.6;
commitid	WH7Fa39f5fh0RTaw;

1.6
date	2012.06.15.14.40.16;	author bavison;	state Exp;
branches;
next	1.5;
commitid	GozidpkBTrLSrO8w;

1.5
date	2012.05.24.11.30.06;	author bavison;	state Exp;
branches;
next	1.4;
commitid	ktC5TlFk2flF6Y5w;

1.4
date	2012.05.23.21.45.07;	author bavison;	state Exp;
branches;
next	1.3;
commitid	dyGUTwLbAf3ExT5w;

1.3
date	2012.05.22.23.56.18;	author jballance;	state Exp;
branches;
next	1.2;
commitid	9zrOo5VjFU0EiM5w;

1.2
date	2012.05.20.20.52.48;	author jballance;	state Exp;
branches;
next	1.1;
commitid	2BhE7hfsP23Glv5w;

1.1
date	2012.05.10.14.53.41;	author bavison;	state Exp;
branches
	1.1.1.1;
next	;
commitid	9gwxHjLZncMLBb4w;

1.26.2.1
date	2017.07.29.11.37.41;	author jlee;	state Exp;
branches;
next	1.26.2.2;
commitid	leIbdlwVfACHk71A;

1.26.2.2
date	2017.07.31.22.18.15;	author jlee;	state Exp;
branches;
next	;
commitid	VmVokWQ7fiZsOq1A;

1.1.1.1
date	2012.05.10.14.53.41;	author bavison;	state Exp;
branches;
next	;
commitid	9gwxHjLZncMLBb4w;


desc
@@


1.28
log
@Merge SMP branch to trunk
Detail:
  hdr/StaticWS - Reserve workspace for QA7 peripheral address, HAL-wide spinlock, and doorbell device
  Makefile, s/DBell - Add doorbell device implementation
  hdr/BCM2835 - Clean up dead macros, add new macros for spinlock claim/release and basic CPU detection. Define new IRQ numbers for the "QA7" peripheral.
  hdr/CastleMacros, s/Top - Generate two HAL descriptors and entry point tables: One for single-core machines and one for multi-core machines. This avoids some MP-related overheads on ARM11 models of Pi. Implement SMP HAL entry points.
  s/Interrupts - Add support for the QA7 interrupts. Although some interrupts can be flexibly routed to different cores, we currently stick with a static scheme.
  s/Messaging - Use CPUDetect macro
Admin:
  Untested
  Requires Kernel-6_09


Version 0.76. Tagged as 'BCM2835-0_76'
@
text
@;
; Copyright (c) 2012, RISC OS Open Ltd
; Copyright (c) 2012, Adrian Lees
; All rights reserved.
;
; Redistribution and use in source and binary forms, with or without
; modification, are permitted provided that the following conditions are met:
;     * Redistributions of source code must retain the above copyright
;       notice, this list of conditions and the following disclaimer.
;     * Redistributions in binary form must reproduce the above copyright
;       notice, this list of conditions and the following disclaimer in the
;       documentation and/or other materials provided with the distribution.
;     * Neither the name of RISC OS Open Ltd nor the names of its contributors
;       may be used to endorse or promote products derived from this software
;       without specific prior written permission.
;
; THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
; IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
; ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
; LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
; CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
; SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
; INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
; CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
; ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
; POSSIBILITY OF SUCH DAMAGE.
;
; With many thanks to Broadcom Europe Ltd for releasing the source code to
; its Linux drivers, thus making this port possible.
;

                GET     Hdr:OSEntries
                GET     Hdr:HALDevice
                GET     Hdr:SDHCIDevice
                GET     Hdr:DMADevice
                GET     Hdr:GPIODevice
                GET     Hdr:VideoDevice
                GET     Hdr:DBellDevice
                GET     hdr.BCM2835

; Per-timer workspace layout
                            ^             0
Timer_Reload                #             4       ; interval between interrupts
Timer_Compare               #             4       ; soft copy of most recently programmed compare value
Timer_Register              #             4       ; address of compare register
Timer_Device                #             4       ; device number
TimerWsSize                 *             :INDEX: @@

; Per-DMA channel workspace
                       ^ 0, a1
DMACDevice             # HALDevice_DMAL_Size
DMACWorkspace          # 4 ; HAL workspace ptr
DMACChanMask           # 4 ; DMA_ENABLE bit for this channel
DMACDREQ               # 4 ; Peripheral/DREQ this channel is servicing
DMACOptions            # 4 ; Options set by SetOptions
DMACPeriAddress        # 4 ; VC phys addr of peripheral - i.e. at &7e......
DMACLastProgress       # 4 ; Last progress value
DMACLastCONBLK_AD      # 4 ; Last control block seen executing
DMACLastTXFR_LEN       # 4 ; Last transfer length remaining seen
DMACCBOffset           # 4 ; Address offset to convert DMA CB addr to ARM CB addr
DMACDesc               # 32 ; Buffer for description string
DMAC_DeviceSize        * :INDEX: @@

; VCHIQ HAL device layout

                                 ^ 0
                                 # HALDeviceSize
HALDevice_VCHIQARMToVCOffset     # 4
HALDevice_VCHIQVCDoorbell        # 4 ; Doorbell to interrupt VC
HALDevice_VCHIQARMDoorbell       # 4 ; Doorbell to interrupt us
HALDevice_VCHIQInitVC            # 4
HALDevice_VCHIQ_Size             * :INDEX: @@

; Device-specific struct for the VDU device

                        ^ 0
VDUDevSpec_SizeField    # 4 ; Size field
VDUDevSpec_DMAChan      # 4 ; Pointer to DMA channel
VDUDevSpec_BurstLen     # 4 ; Burst length for use with DMA channel
VDUDevSpec_Size         # 0 ; Size value to write to size field
                        
; Main workspace layout

sb              RN      9

                ^       0,sb

PeriBase        #       4
IRQ_Base_Address #      4
QA7_Base        #       4
ARM_Counter_IO_Address # 4
ARM_Timer_IO_Address #  4
UARTOldModemStatus #    4
MMUOffBaseAddr  #       4                    ; original address kernel was loaded from
MachineID       #       8                    ; derived from MAC address if there
Spinlock        #       4 ; Spinlock used for any atomic ops

IIC_Status      #       4 ; Non-zero if an IIC transfer is going on
; NOTE - The following locations are for the base addresses of the
; controllers that RISC OS uses for bus 0 and bus 1.  The use is
; dependent on board revision.  Revision 1 boards (Board_Revision
; values 0..3) use Broadcom controller 0 for RISC OS bus 0 and
; Broadcom 1 for RISC OS 1.  Revision 2 boards (Board_Revision
; values 4 upwards) use Broadcom controller 1 for RISC OS bus 0
; and Broadcom controller 0 for RISC OS bus 1, because the PCB
; layout exchanged the busses.
IIC_Base        #       4 ; Base address of IIC controller for RO bus 0
;               #       4 ; Base address of IIC controller for RO bus 1
; NOTE - Bus 1 isn't yet implemented!

Timer   SETA    0
        WHILE   Timer < NumTimers
Timer$Timer.Ws  #       TimerWsSize
Timer   SETA    Timer + 1
        WEND

FB_CacheMode    #       4

; info interrogated from the VC side
ARM_Base        #       4
ARM_Size        #       4
VC_Base         #       4
VC_Size         #       4
Board_Model     #       4
Board_Revision  #       4
ARM_DMAChannels #       4
VirtGPIOBuf     #       4
SafetyCatch     #       4 ; Only valid on Compute Module 3

; align to 16 byte boundary NB this isnt aligned once hal initialised
                #       (((:INDEX:@@)+15):AND::NOT:15)-(:INDEX:@@)
tagbuffer       #       300 ; platform query buffer

NCNBAddr        #       4       ;NCNB workspace
NCNBPhysAddr    #       4       ;VC physical address of NCNB workspace

OSheader        #       4
OSentries       #       4*(HighestOSEntry+1)

SimulatedCMOS   #       2048+4  ;Usual 2k plus version word (as appended by *SaveCMOS)

SDHCIWriteInterval #    4 ; minimum counter ticks between writes
SDHCILastWriteCount #   4 ; counter value at last write
SDHCIInputClock #       4 ; estimated speed of input clock to SDHCI block
                #       (16-:INDEX:@@):AND:15         ; align nicely
SDHCIDevice     #       HALDevice_SDHCISize          ; see Hdr:SDHCIDevice
SDHCISlotInfo   #       HALDeviceSDHCI_SlotInfo_Size ; the controller has just the 1 slot

DMAFreeChannels #       4 ; Mask of which physical DMA channels are free
DMANumChannels  #       4 ; Count of how many channel devices exist
DMAChannelList  #       DMA_CH_Count*4 ; List of channel devices for Enumerate
                #       (16-:INDEX:@@):AND:15         ; align nicely
DMAController   #       HALDevice_DMAC_Size_0_1      ; see Hdr:HALDevice
DMAChannels     #       DMAC_DeviceSize*DMA_CH_Count ; List of channel devices (indexed by physical channel #)

VCHIQDevice     #       HALDevice_VCHIQ_Size
GPIO0Device     #       HALDevice_GPIO_Size_1_0 + 16
GPIO1Device     #       HALDevice_GPIO_Size_1_0 + 16
VDUDevice       #       HALDevice_VDU_Size
VDUDevSpec      #       VDUDevSpec_Size
RTCDeviceStruct #       80
SPI0Device      #       HALDeviceSize
SPI1Device      #       HALDeviceSize
SPI2Device      #       HALDeviceSize
TouchDevice     #       HALDeviceSize
MBoxDevice      #       HALDeviceSize
DBellDevice     #       HALDevice_DBell_Size

HAL_WsSize              *       :INDEX:@@
sizeof_workspace        *       :INDEX:@@

                END
@


1.27
log
@Fix compatibility with latest firmware
Detail:
  Firmware as of 28th July will allow the GPU to make use of the top 16MB of RAM in 1GB machines. This overlaps the ARM's IO space, essentially making that area of memory inaccessible to us.
  This causes problems because we rely on a couple of buffers which are located in VC memory (virtual GPIO buffer & FT5406 touchscreen buffer)
  At some point extra mailbox messages were added to allow the ARM to dictate the location of these buffers; so make use of those messages wherever possible.
  File changes:
  s/Messaging - Remove VirtGPIOBuf and TouchBuf related tags from the initialisation tag sequence. Add new GetVCBuffer function that can be called post-MMU init to deal with getting/setting the buffer addresses.
  s/Top - Use GetVCBuffer to initialise VirtGPIOBuf
  s/Touch - Use GetVCBuffer to get touchscreen buffer
  hdr/StaticWS - Remove TouchBuf from workspace, no longer needed
Admin:
  Tested on Raspberry Pi 3 with firmware from March 2016 (Set commands not supported), 21st July 2017 (set commands supported, but upper 16MB not used), 28th July 2017 (set commands supported and necessary)


Version 0.71. Tagged as 'BCM2835-0_71'
@
text
@d39 1
d91 1
d97 1
d168 1
@


1.26
log
@Add support for CM3 and CM3L with or without eMMC
The SDIO HAL device reports when it is sure fixed disc media is attached (ie. eMMC soldered on the same PCB) which causes SDFS to report this to FileCore as a fixed disc, skipping the removable safety checks.
However, CM3 and CM3L both return the same board id so we can't work out which is which. Additionally, someone could attach an external eMMC in theory on a custom expansion board (instead of an SD card socket like the CMIO has).
To resolve this, we assign IO expander line 6 of U8 to be a safety catch. If that line is held low, it signifies this is definitely a CM3 - in effect this is a "definitely has eMMC" or "maybe has eMMC" switch.

Tested on CM1, CM3, CM3L, and a suitably modified CM3 with the help of Chris Hall.

Version 0.69. Tagged as 'BCM2835-0_69'
@
text
@a124 1
TouchBuf        #       4
@


1.26.2.1
log
@Initial SMP support
Detail:
  hdr/BCM2835 - Delete unused timer macros. Add basic spinlock claim/release macros. Add CPUDetect macro to encapsulate ARM11 vs. A7/A53 detection. Add definitions for the "QA7" interrupts.
  Makefile, s/DBell - Add doorbell device driver
  hdr/StaticWS - Reserve workspace for doorbell device, QA7 interrupt controller ptr, spinlock
  s/Top, hdr/CastleMacros - Generate two HAL entry point tables, one for ARM11, one for A7/A53. Use CPUDetect macro. Implement new SMP-related HAL entry points.
  s/Interrupts - Implement support for the QA7 interrupt controller and the new IRQ-related HAL entry points
  s/Messaging - Use CPUDetect macro
Admin:
  Tested on Raspberry Pi 1, 2, 3


Version 0.70, 1.70.2.1. Tagged as 'BCM2835-0_70-1_70_2_1'
@
text
@a38 1
                GET     Hdr:DBellDevice
a89 1
QA7_Base        #       4
a94 1
Spinlock        #       4 ; Spinlock used for any atomic ops
a165 1
DBellDevice     #       HALDevice_DBell_Size
@


1.26.2.2
log
@Merge in latest HEAD
Detail:
  Merge in changes since BCM2835-0_70 to keep SMP branch up to date
Admin:
  Untested


Version 0.71, 1.70.2.2. Tagged as 'BCM2835-0_71-1_70_2_2'
@
text
@d128 1
@


1.25
log
@Transition Pi HAL to GPIO API 1.00
Detail:
  Move the register accesses for GPIO to the HAL, since they are hardware specific.
  Add recognition of board types for Pi 3, Compute module 3, rev 3 Pi 0's, and the newer Pi 2's with BCM2837 on them.
Admin:
  Based in part on a submission from Tank.
  Tested on a Pi 2. Requires corresponding GPIO module (tag GPIO-1_00-1_11_2_1 or later).

Version 0.67. Tagged as 'BCM2835-0_67'
@
text
@d127 1
@


1.24
log
@Move CMOS settings out of riscos.img
The Pi is unusual in self modifying the ROM image when a CMOS setting was changed (due to there being none on the PCB), with the potential of ending up with a corrupt OS image on disc.
Remove this code and emulate the CMOS using normal RAM, and using the Pi firmware to load the CMOS file in for us (like fatload does on OMAP based designs) by using its ability to load a second arbitrary file at an address, intended in the Linux world to load a disc image.

To use this you will need to add
  ramfsfile=CMOS
  ramfsaddr=0x508000
to config.txt which loads it 5MB (ie. ImageSize) above the default load address (&8000), though as noted in the changes to BCM2835-0_60 we don't really need to load at offset &8000 but generally do since that's the Pi firmware's default.

hdr/StaticWS:
New workspace to hold our CMOS copy.
CMOS.s:
Remove the 2k magic block, add a simple bytewise copy loop implementation.
SDIO.s:
Extend ADR range.
Top.s:
Copy what the Pi firmware loads somewhere safe until the MMU is on, then copy it back (converting from logical to physical order along the way).
Change other values recovered from pre-MMU times using advanced post indexed addressing technology (TM) rather than switching around sb a lot.

Tested on a Pi 3, with and without an initial CMOS file present.

Version 0.61. Tagged as 'BCM2835-0_61'
@
text
@d155 2
a156 1
GPIODevice      #       HALDevice_GPIO_Size
@


1.23
log
@Implement HAL UART API. Tidy up debug output.
Detail:
  hdr/BCM2835, hdr/StaticWS, s/Debug, s/Top, s/Video - Fix up the two serial debug switches to work correctly. Disable debug by default.
  s/UART, hdr/UART - Implement HAL UART API, for the PL011 UART.
Admin:
  Tested on Raspberry Pi 1 B
  Requires DualSerial 0.25 to work correctly


Version 0.59. Tagged as 'BCM2835-0_59'
@
text
@d138 2
@


1.22
log
@Fix SD card activity LED on Pi 3B
Detail:
  hdr/BCM2835 - Remove mailbox definitions - use the ones exported by BCMSupport to avoid needless duplication
  hdr/StaticWS, s/Messaging, s/Top - Use the mailbox property interface to request & map in the virtual GPIO buffer (if present)
  s/SDIO - On the Pi 3B, the GPIO that was used for the SD activity GPIO is now used for a different purpose. To control the activity LED we need to go via an I2C attached GPIO extender, which itself is exposed to the ARM via the new "virtual GPIO" buffer
  s/VCHIQ - Update to use BCMSupport mailbox definitions
Admin:
  Tested on Pi 1B, 3B


Version 0.54. Tagged as 'BCM2835-0_54'
@
text
@d92 1
a92 1
UARTFCRSoftCopy #       4
a129 1
 ! 0,"tagbuffer at ":CC::STR:(&fc001000+:INDEX:@@),0
a137 3


 ! 0,"SDHCI at ":CC::STR:(&FC0001D8+:INDEX:@@),0
@


1.21
log
@Fix Pi 3 UART clock rate. Add HAL device for the GPU mailboxes.
Detail:
  s/Messaging - Ensure the PL011 UART module clock is set to 3MHz on startup, in order to allow the debug terminal to work
  hdr/StaticWS, s/Top - Add a basic HAL device to expose the GPU mailboxes
Admin:
  Tested on Raspberry Pi 1B/2B/3B
  Fixes garbled debug terminal input/output on Pi 3


Version 0.52. Tagged as 'BCM2835-0_52'
@
text
@d126 1
@


1.20
log
@Add basic HAL device for the official DSI display/touchscreen. Delete superfluous code.
Detail:
  Makefile, s/Touch - Basic HAL device for the official touchscreen, which just exposes the address of the buffer which the GPU periodically fills with a register dump of the touchscreen controller.
  hdr/BCM2835 - Remove old comment. Add new tag for getting the touchscreen buffer address.
  hdr/StaticWS - Remove old workspace entries. Add new entries for touchscreen.
  s/Messaging - Remove the messagebox tags which set a screen mode on startup (BCMVideo will handle that for us), and just blank the screen instead (to stop the GPU displaying a coloured square). Add tag to get the touchscreen buffer address.
  s/Top - Register touchscreen HAL device during HAL_InitDevices. Remove more old code.
Admin:
  Tested on Raspberry Pi 1 B


Version 0.50. Tagged as 'BCM2835-0_50'
@
text
@d164 1
@


1.19
log
@Don't map in VC memory
Detail:
  hdr/StaticWS, s/Top - Removed code to map in all of VC memory. Currently nothing needs it, and the code was broken anyway (debug output would corrupt a1 value given to OS_MapInIO)
Admin:
  Tested on Raspberry Pi


Version 0.46. Tagged as 'BCM2835-0_46'
@
text
@a114 2
FB_Base         #       4
FB_Size         #       4
d125 1
d163 1
@


1.18
log
@Add basic HAL devices for the SPI controllers
Detail:
  s/SPI - Basic HAL devices for the 3 SPI controllers. These expose the register addresses & IRQ numbers, and (for SPI1 & SPI2) deal with enabling/disabling the hardware and the shared IRQ line. GPIO mapping currently isn't dealt with - we don't know which pin group to use (SPI0 can use two different sets on the compute) or how many chip select lines are desired.
  Makefile - Add SPI source
  hdr/BCM2835 - Add aux SPI registers
  hdr/StaticWS - Reserve workspace for the HAL devices
  s/Top - Register new devices in HAL_InitDevices
Admin:
  Tested on Raspberry Pi B & 2 B


Version 0.45. Tagged as 'BCM2835-0_45'
@
text
@a123 1
VC_Logical      #       4
@


1.17
log
@Add RTC HAL device
Detail:
  CJE's RTC module uses a DS1307-compatible RTC chip similar to the one used in the Iyonix. Previously the kernel handled talking to it, but now that low-level RTC handling has been moved out of the kernel we need an RTC HAL device in the BCM2835 HAL instead.
  s/RTC - A copy of s.RTC from the Tungsten HAL, relicensed as BSD with permission from Rob Sprowson
  Makefile, hdr/StaticWS, s/Top - Additional changes needed to hook the code into the HAL
Admin:
  Tested on Raspberry Pi, but without an RTC module fitted
  However the similarity of the clock chip to the one in the Iyonix should mean there's little chance of this code failing to work correctly when an RTC is fitted


Version 0.31. Tagged as 'BCM2835-0_31'
@
text
@d162 3
@


1.16
log
@Add a video HAL device to allow BCMVideo to determine which DMA channel it can use for render ops
Detail:
  hdr/StaticWS, s/Top, s/Video - Added a simple VDU HAL device that exposes a DMA channel to BCMVideo for use with GraphicsV_Render
  hdr/BCM2835 - Don't allow DMA channel 12 to be used; latest firmware seems to have a bug which claims its free when in reality it isn't.
  s/Messaging, s/DMA - Adjust DMA init to allow the video device to claim a DMA channel before the DMA devices are initialised
Admin:
  Tested on Raspberry Pi with high processor vectors


Version 0.25. Tagged as 'BCM2835-0_25'
@
text
@d161 1
@


1.15
log
@Use BCS1 instead of BCS0 for IIC when running on rev 2 boards
Detail:
  hdr/BCM2835, hdr/StaticWS, s/IIC - On rev 2 boards the usage of BSC0 and BSC1 have been swapped, such that BSC1 is now sent to the expansion header instead of BSC0.
  To allow RISC OS to continue to work with clock chips and other hardware fitted to the header, expose BSC1 to RISC OS if on a rev 2 board, or BSC0 if on a rev 1.
Admin:
  Changes received from Dave Higton
  Tested by Dave on rev 1 & rev 2 boards, with IIC devices
  Tested by me on rev 1 board (with no IIC devices fitted)


Version 0.24. Tagged as 'BCM2835-0_24'
@
text
@d38 1
d74 8
a157 1

d159 2
@


1.14
log
@Read board model, revision, and available DMA channels from messaging channel. Report board revision via GPIO HAL device. Recover lost ROM relocation code.
Detail:
  hdr/StaticWS, s/Messaging, s/Top - Now reads board model, revision and available DMA channels from messaging channel
  hdr/StaticWS, s/GPIO - Updated GPIO HAL device to report board revision instead of a generic response of 'unknown'
  s/Top - Recovered ROM relocation code that got lost during a merge. End of ROM image no longer being corrupted, and RISC OS now sees correct amount of RAM.
  s/DMA - Ditch old code to read available DMA channels and use value read by HAL_QueryPlatform instead.
Admin:
  Tested on Raspberry Pi (B rev 1) with various start.elf sizes & versions
  DMA channel reporting only available with latest firmware (i.e. 8th Sep)
  Board revision number read by messaging channel seems to match that returned by /proc/cpuinfo on Linux


Version 0.22. Tagged as 'BCM2835-0_22'
@
text
@d7 1
a7 1
; modification, are permitted provided that the following conditions are met: 
d16 1
a16 1
; 
d88 11
@


1.13
log
@Strip out video code & on-screen debug
Detail:
  Makefile, s/Display - Deleted on-screen debug code
  hdr/BCM2835, hdr/StaticWS, s/IIC, s/Messaging, s/Stubs, s/Top, s/UART - Strip out calls to on-screen debug code, and a few bits of video code
  s/Video - Video code removed and replaced with stub functions similar to other HALs. Only remaining useful code is HAL_Video_StartupMode, which in time should probably be moved to BCMVideo as well.
Admin:
  Tested on Raspberry Pi with high processor vectors


Version 0.21. Tagged as 'BCM2835-0_21'
@
text
@d37 1
d105 3
d112 1
a112 1
tagbuffer       #       256 ;; for now                      ; platform query buffer
d139 2
@


1.12
log
@  Addition of I2C support
Detail:
  Implementation of the high-level HAL IIC interface provided by Dave Higton.
Admin:
  Checked it builds and runs at ROOL.

Version 0.20. Tagged as 'BCM2835-0_20'
@
text
@d99 5
a103 2
VC_Memory       #       4
ARM_Memory      #       4
a109 40
; align to 16 byte boundary  NB this isnt aligned once hal initialised      
                #       (((:INDEX:@@)+15):AND::NOT:15)-(:INDEX:@@)
mbram           # 0                   ; structure needed for frame buffer descriptor
mbxres          #       4
mbyres          #       4
mbxvres         #       4
mbyvres         #       4
mbpitch         #       4
mbbpp           #       4
mbxoff          #       4
mbyoff          #       4
mbbase          #       4
mbscrsz         #       4

ScreenBase      #       4
FTextPixel      #       4
BTextPixel      #       4
FTextPixRepl    #       4
BTextPixRepl    #       4
BitsPerPixel    #       4
InvertFont      #       4
InvertPixel     #       4
Columns         #       4
Rows            #       4
OutputX         #       4
OutputY         #       4
BytesPerRow     #       4
BytesPerChar    #       4
LastInt         #       4
KM_State        #       4
KM_Num          #       4
KM_NumY         #       4
PixelTable      #       256*4

CurAddr         #       4
CurHeight       #       4
CurPalette      #       4*4
vrmsize         *       :INDEX: @@ - :INDEX:mbram


a132 3
CurUnder        #       32*4*32
CurShape        #       32/4*32

@


1.11
log
@Add GPIO & VCHIQ HAL devices. Fix FlushDataCache macro to perform a clean & invalidate instead of just an invalidate.
Detail:
  s/GPIO - Basic implementation of the GPIO HAL device to allow the GPIO module to detect the board type
  s/VCHIQ, hdr/StaticWS - New VCHIQ HAL device which exposes the functionality required by the work-in-progress VCHIQ driver.
  Makefile, s/Top - Hook up the new files/devices
  hdr/BCM2835 - Make the FlushDataCache macro perform a clean & invalidate, to match the behaviour of FlushDataCacheRange
Admin:
  Tested on Raspberry Pi with high processor vectors


Version 0.17. Tagged as 'BCM2835-0_17'
@
text
@d86 2
@


1.10
log
@Detail:  Frame buffer allocation via message channel almost complete. working
        HAL_MachineID functioning correctly
Admin:


Version 0.15. Tagged as 'BCM2835-0_15'
@
text
@d62 9
d171 2
@


1.9
log
@
	Various updates to do with the messaging channel, HAL_MachineID, and HAL_Reset

Detail:
	HAL_Reset now causes a complete reboot of the machiine. It isnt yet properly called from
	the kernel.. I've not investigated why yet. Behaviour tested using OS_Hardware call

	HAL_MachineID, with the github start.elf from 18 July 2012 will provide a valid MAC address ..
	i.e. that specific to this machine. The a1 value in HAL_ExtendedID needs to be set 0 for this to be reported
	by OS_ReadSysInfo .. unfortunately, again at this stage, it stalls the boot when set 0, so just for now
	the committed value for a1 in HAL_ExtendedID is not 0 .

	centralised messaging routine added. This is used a fair bit in acquiring the operating environment
	Not yet used in the DMA stuff. probably ought to be. At present the messaging channel this mainly
	handles is not complete, so information from this code is still WIP

Admin:
  (highlight level of testing that has taken place)
  (bugfix number if appropriate)


Version 0.14. Tagged as 'BCM2835-0_14'
@
text
@d75 1
d91 1
a91 1
; align to 16 byte boundary
d96 1
a96 1
; align to 16 byte boundary        
d106 1
a106 1
myyoff          #       4
d133 2
d142 2
@


1.8
log
@Add DMA driver
Detail:
  s/DMA, hdr/DMA, Makefile - DMA driver, as an implementation of the DMA controller and list type DMA channel HAL devices
  hdr/StaticWS - Added DMA workspace definition
  hdr/BCM2835 - Removed DMA control block definition (now in hdr/DMA). Add definitions for the mailbox property interface, which should be supported by the GPU firmware sometime soon.
  s/Top - Export a couple of the debug functions. Store logical & physical address of NCNB workspace instead of hackily getting phys addr of the (cacheable) HAL workspace. Call DMA_InitDevices in HAL_InitDevices.
Admin:
  Tested in BCM2835 ROM
  DMA driver hasn't received large amounts of testing, lacks support for finite-length circular transfers, and currently only has one DMA channel enabled
  More DMA channels should be available once the mailbox property interface is functional and we know which channels the GPU does and doesn't use.


Version 0.11. Tagged as 'BCM2835-0_11'
@
text
@d74 1
d85 10
@


1.7
log
@  Fixes for SD support
Detail:
  * Engage the GPIO controller's pull-up resistors on SDCLK, CMD and DAT0-DAT3.
    In tests, this seems to address the worst of the unreliability we have
    seen previously.
  * Remove the entry to change the bus between push-pull and open-drain modes.
    The BCM2835 simply doesn't seem to be able to do this. Fortunately, all
    the cards I have tested seem to be OK with the GPIO controller's pull-up
    on the CMD line (however strong that is - it's undocumented) engaged at
    all times.
  * Time a dummy command in order to calculate the speed of the input clock
    to the SD controller block (there doesn't appear to be any way to read
    its speed directly!) This is necessary because recent versions of the
    firmware have not only changed the default clock speed, but even made it
    a user-configurable option in config.txt. It's very important that we
    know how fast it is - if we set the dividers so SDCLK is too slow, then
    the workaround for the register write bug won't work, too fast and we
    overclock the cards, potentially damaging them.
  * Re-enable high speed mode. As long as we don't use the High Speed Enable
    bit in Host Control 1 (see change in SDIODriver 0.03) this seems to work
    for me.
Admin:
  Tested against my collection of test cards on a Raspberry Pi with the
  firmware from the 2012-06-22 commit on github, and with
  init_emmc_clock=100000000 in config.txt (though other values, or the
  absence of that line, or the entire file, should also work). The only
  issues I had appeared to be due to mechanical problems with the SD socket,
  and went away after the card was reseated one or more times.

Version 0.10. Tagged as 'BCM2835-0_10'
@
text
@d36 1
d47 15
a74 2
DMAcb           #       sizeof_DMAcb

d122 2
a123 1
WSPhysAddr      #       4       ;physical address of HAL workspace
d136 7
@


1.6
log
@  SD support, and miscellaneous other changes
Detail:
  * Bugfix to HAL_FIQDisableAll - it wasn't clearing the FIQ register (would
    only have caused trouble in practice if the same device was subsequently
    enabled as an IRQ).
  * Added a load of memory barriers to s.Interrupts and s.Timers to conform
    to the requirement stated in 1.3 of the datasheet.
  * Added a HAL device for the Arasan SDHCI controller. Note that this does
    not currently work reliably, and results vary from card to card. High
    speed support is currently disabled until we are able to verify that it
    works reliably.
  * Added a sprinkling of "GET Hdr:ListOpts" because the space reserved for
    the SDHCI HAL device in hdr.StaticWS is determined by including
    Hdr:HALDevice and Hdr:SDHCIDevice, which need it.
  * When support for saving "CMOS" to the SD card is added, the ROM image
    file (kernel.img) is the only one we can count on the bootloader
    installing in memory, so I think we're going to have to work using the
    table in s.CMOS. Broadcom seems to like messing around with the space
    just after the processor vector table, so rather than adding a pointer
    to the table there, I've opted to mark it using a magic word.
Admin:
  Tested on a Raspberry Pi - as noted above, there are reliability issues.

Version 0.09. Tagged as 'BCM2835-0_09'
@
text
@d113 1
d116 1
@


1.5
log
@  Whitespace changes
Detail:
  Substituted remaining hard spaces with normal ones and expanded tabs.
  This now matches the de facto standard for other components, and also looks
  better in the CVS web viewer.
Admin:
  No code changes

Version 0.06. Tagged as 'BCM2835-0_06'
@
text
@d34 2
d113 6
@


1.4
log
@  Complete rework of timer and interrupt code
Detail:
 * Moved interrupt and timer code out of s.Stubs - they're not stubs any more.
 * Rewrote timer and counter code to use GPU system timer 1 for our Timer0
   rather than the ARM timer. This is recommended in the Broadcom datasheet
   because it's driven from the APB clock and so its speed will vary in
   reduced or low power mode.
 * HAL_CounterDelay now, well, does a delay!
 * Added a Timer1, driven from GPU system timer 3 - common code with Timer0.
 * Reshuffled device numbers so the GPU interrupts are at the bottom. This
   works better for FIQs and makes Timer0 the lowest priority interrupt.
 * Higher device numbers are now consistently treated as higher priority.
 * Stopped using bits 8-31 of the basic interrupt registers. These can't be
   masked, so they cause the kernel to lock up if generated, which happens
   if the GPU interrupt which they alias is generated (which appears to
   include the timers even though this is not documented).
 * Added definitions for all the interrupts, including those redacted from the
   datasheet - we need them at least for timers, USB and SD.
 * Stopped HAL_IRQClear from doing anything - this interrupt controller
   doesn't do latching. To acknowledge timer interrupts, you should use
   HAL_TimerIRQClear (and HAL_IRQClear too for compatibility with other ports).
 * Implemented HAL_IRQStatus and all the FIQ control routines.
 * Offsets to interrupt controller registers now use symbolic names.
 * Replaced some hard spaces in sources with normal ones.
Admin:
  Tested on a beta Raspberry Pi. Confirmed that interrupt handlers for both
  ARM and GPU sources can both be operational simultaneuosly. However, the FIQ
  code has not been tested. Timer0 is verified as running at the correct
  speed and reporting a count *down* in the correct range (not a count up as
  some previous versions did). HAL_CounterDelay appears correct also.

Version 0.04. Tagged as 'BCM2835-0_04'
@
text
@d33 2
a34 2
		GET	Hdr:OSEntries
		GET	hdr.BCM2835
d47 1
a47 1
sb		RN	9
d49 1
a49 1
		^	0,sb
d51 1
a51 1
PeriBase	#	4
d57 1
a57 1
DMAcb		#	sizeof_DMAcb
d82 23
a104 23
ScreenBase	#	4
FTextPixel	#	4
BTextPixel	#	4
FTextPixRepl	#	4
BTextPixRepl	#	4
BitsPerPixel	#	4
InvertFont	#	4
InvertPixel	#	4
Columns		#	4
Rows		#	4
OutputX		#	4
OutputY		#	4
BytesPerRow	#	4
BytesPerChar	#	4
LastInt		#	4
KM_State	#	4
KM_Num		#	4
KM_NumY		#	4
PixelTable	#	256*4

CurAddr		#	4
CurHeight	#	4
CurPalette	#	4*4
d106 1
a106 1
WSPhysAddr	#	4	;physical address of HAL workspace
d108 1
a108 1
OSheader	#	4
d111 2
a112 2
CurUnder	#	32*4*32
CurShape	#	32/4*32
d114 2
a115 2
HAL_WsSize 		*	:INDEX:@@
sizeof_workspace	*	:INDEX:@@
d117 1
a117 1
		END
@


1.3
log
@   Boots with May17th start.elf
Detail:
   Recent changes in the broadcom startup code now accomodated. frame buffer
   will now determine whether it is L2 cached or not, and be set up accordingly.
   ATAGs not currently read, so ram size defaulted.
  ** note that there will be further updates to this over the following days
  ** trackikng startup code changes.
   added HAL_TimerIRQClear entry
Admin:
  (highlight level of testing that has taken place)
  (bugfix number if appropriate)


Version 0.03. Tagged as 'BCM2835-0_03'
@
text
@d2 1
a2 1
; Copyright (c) 2012, RISC OS Open Ltd
d4 1
a4 1
; All rights reserved.
d36 10
d59 6
@


1.2
log
@
  Update of HAL to incorporate separate development of HAL by J Ballance
  Will now compile against initial developemnt start.elf, and against the
  start.elf in general release at this date. (compile switch UseALBlob in
  hdr.BCM2835). Extended header defs, Updated IRQ stuff, HAL_FramebufferAddress
  Reworked Timers, + a number of other bits. Still work in progress.
Detail:
  (list files and functions that have changed)
Admin:
  Compiled and working - as far as it goes -. Will enable use with the current
  start.elf, and is (subject to any minor changes introduced) ready for use with the
  version due for release shortly which will provide the correct transparency operation,
  and a better aligned frame buffer

Version 0.02. Tagged as 'BCM2835-0_02'
@
text
@d51 1
@


1.1
log
@Initial revision
@
text
@a35 2
		GBLL	SCR32
SCR32		SETL {TRUE}
d42 3
a44 2
;Peri2Base	#	4

d49 16
@


1.1.1.1
log
@  Initial import of BCM2835 (Raspberry Pi) HAL
Detail:
  Covers the basic functionality, but does require a customised start.elf
  to function. The vast majority is an entirely new implementation and is
  BSD licenced, but 4% (the Makefile and a handful of simple macros) are
  copied from pre-existing Castle-licenced code, so it lives under the
  "mixed" hierarchy. If other HALs are anything to go by, we'll end up
  having to add more Castle code (at least some C runtime functions) so it's
  probably juast as well.
Admin:
  Code received from Adrian Lees
@
text
@@
