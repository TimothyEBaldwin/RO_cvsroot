head	4.4;
access;
symbols
	Internet-5_65:4.4
	Internet-5_64:4.4
	Internet-5_63:4.4
	Internet-5_62:4.4
	Internet-5_61:4.4
	Internet-5_60:4.4
	Internet-5_59:4.4
	Internet-5_58:4.4
	Internet-5_57:4.4
	Internet-5_56:4.4
	Internet-5_55:4.4
	Internet-5_54:4.4
	Internet-5_53:4.4
	Internet-5_52:4.4
	Internet-5_51:4.4
	Internet-5_50:4.4
	RO_5_07:4.4
	Internet-5_49:4.4
	Internet-5_48:4.4
	Internet-5_47:4.4
	Internet-5_46:4.4
	Internet-5_45:4.4
	Internet-5_44:4.4
	Internet-5_43:4.4
	Internet-5_42:4.4
	Internet-5_41:4.4
	Internet-5_40:4.4
	Internet-5_39:4.4
	Internet-5_38:4.4
	Internet-5_37:4.4
	Internet-5_36:4.4
	Internet-5_35:4.4
	Internet-5_34:4.4
	Internet-5_33:4.4
	Internet-5_32:4.4
	Internet-5_31:4.4
	Internet-5_30:4.4
	Internet-5_29:4.4
	Internet-5_27:4.3
	Internet-5_26:4.3
	Internet-5_25:4.3
	Internet-5_24:4.3
	Internet-5_23:4.3
	Internet-5_22:4.3
	Internet-5_21:4.3
	Internet-5_20:4.3
	Internet-5_19:4.3
	Internet-5_18:4.3
	Internet-5_17:4.3
	Internet-5_16:4.2
	mstphens_UrsulaRiscPCBuild_20Nov98:4.2
	Ursula_RiscPC:4.2.0.8
	Internet-5_15:4.2
	Internet-5_14:4.2
	Internet-5_13:4.2
	sforrest_daytona_appflash-0_31:4.2
	Internet-5_12:4.2
	Internet-5_11:4.2
	celkins_Internet-5_10:4.2
	nicke_Internat_25-9-98:4.2
	Internet-5_09:4.2
	blaughto_daytona_appflash-0_30:4.2
	rthornb_UrsulaBuild-19Aug1998:4.2
	UrsulaBuild_FinalSoftload:4.2
	rthornb_UrsulaBuild-12Aug1998:4.2
	aglover_UrsulaBuild-05Aug1998:4.2
	rthornb_UrsulaBuild-29Jul1998:4.2
	rthornb_UrsulaBuild-22Jul1998:4.2
	rwarren_Internet-5_08:4.2
	Spinner:4.2
	Internet_5_07:4.2
	rthornb_UrsulaBuild-15Jul1998:4.2
	rthornb_UrsulaBuild-07Jul1998:4.2
	rthornb_UrsulaBuild-17Jun1998:4.2
	rthornb_UrsulaBuild-03Jun1998:4.2
	rthornb_UrsulaBuild-27May1998:4.2
	rthornb_UrsulaBuild-21May1998:4.2
	Ursula_bp:4.2
	Ursula:4.2.0.6
	Ursula_13May1998_bp:4.2
	Ursula_13May1998:4.2.0.2
	rthornb_UrsulaBuild_01May1998:4.2
	celkins_Internet_506:4.2
	afrost_NC2_Generic:4.1.4.1
	afrost_Funai01-33:4.1.4.1
	Internet_505:4.2
	Spin_old:4.1.7
	Spinner_RCA116:4.1.4.1
	Spinner_B20_2:4.1.4.1
	Spinner_19_3:4.1.4.1
	Spinner_B18:4.1.4.1
	Spinner_B17:4.1.4.1
	Spinner_B15:4.1.4.1
	Spinner_B14:4.1.4.1
	Spinner_B13:4.1.4.1
	Spinner_B12:4.1.4.1
	Spinner_B10:4.1.4.1
	Daytona:4.2.0.4
	Daytona_bp:4.2
	Spin_merge_12May97:4.1.7.2
	Spinner_B7:4.1.4.1
	RO_3_71:4.1.3.1
	ARTtmp_merge:4.1.7.2
	nturton_inet_4_9:4.1.7.3
	nturton_inet_4_8:4.1.7.2
	Spin_3Apr97:4.1.7.2
	RCA_bp:4.1
	ARTtmp:4.1.7.2.0.2
	RCA:4.1.0.2
	Spin_merge:4.1.4.1
	MergeFiles:4.1.3.2
	RO_3_70:4.1.3.1
	NC_1_06:4.1.7.1
	Spin_xx:4.1.5
	NC_xx:4.1.5.1
	RO_3_60:4.1.1.1
	StrongARM:4.1.3
	Black:4.1.1;
locks; strict;
comment	@# @;


4.4
date	99.07.08.15.25.47;	author kbracey;	state Exp;
branches;
next	4.3;

4.3
date	98.11.27.14.49.10;	author kbracey;	state Exp;
branches;
next	4.2;

4.2
date	97.05.12.22.59.08;	author kbracey;	state Exp;
branches;
next	4.1;

4.1
date	96.11.05.09.28.11;	author nturton;	state Exp;
branches
	4.1.1.1
	4.1.3.1
	4.1.4.1
	4.1.5.1
	4.1.7.1;
next	;

4.1.1.1
date	96.11.05.09.28.11;	author nturton;	state Exp;
branches;
next	4.1.1.2;

4.1.1.2
date	96.11.05.16.20.29;	author nturton;	state Exp;
branches;
next	;

4.1.3.1
date	96.11.05.22.30.43;	author nturton;	state Exp;
branches;
next	4.1.3.2;

4.1.3.2
date	96.11.08.17.23.25;	author nturton;	state Exp;
branches;
next	;

4.1.4.1
date	97.04.11.10.07.06;	author kbracey;	state Exp;
branches;
next	;

4.1.5.1
date	96.11.22.14.56.39;	author nturton;	state Exp;
branches;
next	4.1.5.2;

4.1.5.2
date	96.11.25.15.07.07;	author nturton;	state Exp;
branches;
next	;

4.1.7.1
date	96.11.29.19.59.51;	author nturton;	state Exp;
branches;
next	4.1.7.2;

4.1.7.2
date	96.12.02.20.38.53;	author nturton;	state Exp;
branches;
next	4.1.7.3;

4.1.7.3
date	97.04.09.15.27.30;	author nturton;	state Exp;
branches;
next	;


desc
@@


4.4
log
@* Dynamic ports now assigned in range 49152-65535.
* IP_RECVDSTADDR works for non-unicast packets.
* SO_TIMESTAMP added.
* IP_RECVIF added.
* Various other internal changes merged in from FreeBSD sources.

Version 5.29. Tagged as 'Internet-5_29'
@
text
@/* Copyright 1996 Acorn Computers Ltd
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/*
 * Software Interrupt Setup
 *
 * Copyright (c) 1988 Acorn Computers Ltd., Cambridge, England
 *
 */

#include "kernel.h"
#include "ioc.h"
#include "int_hndlr.h"

#include "sys/param.h"
#include "sys/socket.h"
#include "sys/time.h"

#include "net/netisr.h"

#include "net/if.h"
#include "net/if_arp.h"

#include "netinet/in.h"
#include "netinet/if_ether.h"
#include "netinet/ip_var.h"

#include "module.h"

void softnet(void)
{
	if ((netisr & (1 << NETISR_IP)) != 0) {
		netisr &= ~(1 << NETISR_IP);
		ipintr();
	}

	if ((netisr & (1 << NETISR_ARP)) != 0) {
		netisr &= ~(1 << NETISR_ARP);
		arpintr();
	}

	if ((netisr & (1 << NETISR_REVARP)) != 0) {
		netisr &= ~(1 << NETISR_REVARP);
		revarpintr();
	}

	if ((netisr & (1 << NETISR_CALLO)) != 0) {
		netisr &= ~(1 << NETISR_CALLO);
		callo_handler();
	}
}

extern int callbackflag;
extern int callbackerr;

void setsoftnet(void)
{
    if( callbackflag == 0 )
    {
	int s = splimp();
	callbackflag = 1;
	splx(s);

	if( callback(CALLB_CALLB) != 0 )
	{
	    callbackflag = 0;
	    callbackerr = 1;
	}
    }
}

int callb_handler(int *r)
{
    callback_entered(CALLB_CALLB);

    if( callbackflag != 0 )
    {
	int s = splimp();
	callbackflag = 0;
	splx(s);
	softnet();
    }

#ifdef DELAY_EVENTS
    sendallsignals();
#endif

    return(1);
}

/* EOF setsoft.c */
@


4.3
log
@Removed limitation on length of IP interrupt queue, and made psignal
generate events immediately, rather than at the end of callbacks.
In both respects, the behaviour is restored to that of Internet 4. This
fixes some performance problems with data streaming near the limit of the
machine's capability.

Version 5.17. Tagged as 'Internet-5_17'
@
text
@d27 1
@


4.2
log
@Version Spinner_B7 taken
@
text
@d94 1
d96 1
@


4.1
log
@Initial revision
@
text
@d15 1
a15 5
/* -*-C-*-
 *
 * $Header: /ax/networking:Internet/riscos/setsoft.c:networking  1.2  $
 * $Source: /ax/networking:Internet/riscos/setsoft.c: $
 *
a19 7
 * $Log:	setsoft.c,v $
 * Revision 1.2  95/03/31  12:03:11  kwelton
 * Callback scheme has changed - see log for ../lib/unixenv.c.
 * 
 * Revision 1.1  94/12/02  11:45:37  kwelton
 * Initial revision
 * 
d31 7
a39 2
extern int netisr;

d42 9
a50 5
    if( (netisr & (1 << NETISR_IP)) != 0 )
    {
	netisr &= ~(1 << NETISR_IP);
	if_callb();
    }
d52 4
a55 5
    if( (netisr & (1 << NETISR_RAW)) != 0 )
    {
	netisr &= ~(1 << NETISR_RAW);
	rawintr();
    }
d57 4
a60 5
    if( (netisr & (1 << NETISR_CALLO)) != 0 )
    {
	netisr &= ~(1 << NETISR_CALLO);
	callo_handler();
    }
a62 1
extern int callb_entry();
d93 2
@


4.1.4.1
log
@Internet 5.04 merged from Internet 5.03 on Networking source tree with
Internet 4.08 BOOTP extensions from Spinner.
@
text
@d15 5
a19 1
/*
d24 7
d42 1
a42 2
#include "net/if.h"
#include "net/if_arp.h"
d44 1
a44 5
#include "netinet/in.h"
#include "netinet/if_ether.h"
#include "netinet/ip_var.h"

#include "module.h"
d48 5
a52 4
	if ((netisr & (1 << NETISR_IP)) != 0) {
		netisr &= ~(1 << NETISR_IP);
		ipintr();
	}
d54 5
a58 4
	if ((netisr & (1 << NETISR_ARP)) != 0) {
		netisr &= ~(1 << NETISR_ARP);
		arpintr();
	}
d60 5
a64 9
	if ((netisr & (1 << NETISR_REVARP)) != 0) {
		netisr &= ~(1 << NETISR_REVARP);
		revarpintr();
	}

	if ((netisr & (1 << NETISR_CALLO)) != 0) {
		netisr &= ~(1 << NETISR_CALLO);
		callo_handler();
	}
d67 1
a97 2

    sendallsignals();
@


4.1.7.1
log
@NCOS 1.06 Imported from Zip drive
@
text
@@


4.1.7.2
log
@RCS log keyword removed
@
text
@d24 1
a24 1
 * :RCS Log discontinued:
@


4.1.7.3
log
@BootP patch incorporated
@
text
@@


4.1.5.1
log
@Import from SrcFiler
@
text
@@


4.1.5.2
log
@RCS Log keyword removed
@
text
@d24 1
a24 1
 * :RCS Log discontinued:
@


4.1.3.1
log
@Import from cleaned 370 CD
@
text
@d27 1
a27 1
 *
d30 1
a30 1
 *
d44 2
d48 5
a52 4
	if ((netisr & (1 << NETISR_IP)) != 0) {
		netisr &= ~(1 << NETISR_IP);
		ipintr();
	}
d54 5
a58 4
	if ((netisr & (1 << NETISR_ARP)) != 0) {
		netisr &= ~(1 << NETISR_ARP);
		arpintr();
	}
d60 5
a64 9
	if ((netisr & (1 << NETISR_REVARP)) != 0) {
		netisr &= ~(1 << NETISR_REVARP);
		revarpintr();
	}

	if ((netisr & (1 << NETISR_CALLO)) != 0) {
		netisr &= ~(1 << NETISR_CALLO);
		callo_handler();
	}
a97 2

    sendallsignals();
@


4.1.3.2
log
@RCS Log keyword removed
@
text
@d24 1
a24 1
 * :RCS Log discontinued:
@


4.1.1.1
log
@Import from cleaned 360 CD
@
text
@@


4.1.1.2
log
@Log keyword removed
@
text
@d24 1
a24 1
 * :RCS Log discontinued:
@
