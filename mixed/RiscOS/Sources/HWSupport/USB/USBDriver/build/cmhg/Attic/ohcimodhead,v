head	1.10;
access;
symbols
	USBDriver-1_19:1.9
	NetBSD-1_19:1.9
	NetBSD-1_18:1.9
	NetBSD-1_17:1.8
	NetBSD-1_16:1.8
	NetBSD-1_15:1.8
	NetBSD-1_14:1.8
	NetBSD-1_13:1.8
	NetBSD-1_12:1.8
	NetBSD-1_09-1:1.8
	NetBSD-1_11:1.8
	NetBSD-1_10:1.8
	NetBSD-1_09:1.8
	NetBSD-1_08:1.8
	NetBSD-1_07:1.8
	NetBSD-1_06:1.8
	NetBSD-1_05:1.8
	NetBSD-1_04:1.8
	NetBSD-1_03:1.8
	NetBSD-1_02:1.8
	NetBSD-1_01:1.8
	NetBSD-1_00:1.8
	NetBSD-0_99:1.8
	NetBSD-0_98:1.8
	NetBSD-0_97:1.8
	NetBSD-0_96:1.8
	NetBSD-0_95:1.8
	NetBSD-0_94:1.8
	NetBSD-0_93:1.8
	NetBSD-0_92:1.8
	NetBSD-0_91:1.8
	NetBSD-0_90:1.8
	NetBSD-0_89:1.8
	NetBSD-0_88:1.7
	NetBSD-0_87:1.7
	NetBSD-0_86:1.7
	NetBSD-0_85:1.7
	NetBSD-0_84:1.7
	NetBSD-0_83:1.7
	NetBSD-0_82:1.7
	NetBSD-0_81:1.7
	NetBSD-0_80:1.7
	NetBSD-0_79:1.7
	NetBSD-0_78:1.7
	NetBSD-0_77:1.7
	NetBSD-0_76:1.7
	NetBSD-0_75:1.7
	NetBSD-0_74:1.7
	NetBSD-0_73:1.7
	NetBSD-0_72:1.7
	NetBSD-0_71:1.7
	NetBSD-0_70:1.6
	NetBSD-0_69:1.6
	NetBSD-0_68:1.6
	NetBSD-0_67:1.6
	NetBSD-0_66:1.6
	NetBSD-0_65:1.6
	NetBSD-0_64:1.6
	NetBSD-0_63:1.6
	NetBSD-0_62:1.6
	NetBSD-0_61:1.6
	NetBSD-0_60:1.6
	NetBSD-0_59:1.6
	NetBSD-0_58:1.6
	NetBSD-0_57:1.6
	NetBSD-0_56:1.6
	NetBSD-0_55:1.6
	NetBSD-0_54:1.6
	NetBSD-0_53:1.6
	NetBSD-0_52:1.6
	NetBSD-0_51:1.6
	NetBSD-0_50:1.6
	NetBSD-0_49:1.5
	NetBSD-0_48:1.5
	NetBSD-0_47:1.5
	NetBSD-0_46:1.5
	NetBSD-0_45:1.5
	NetBSD-0_44:1.5
	NetBSD-0_43:1.5
	NetBSD-0_42:1.5
	NetBSD-0_41:1.5
	NetBSD-0_40:1.5
	NetBSD-0_39:1.5
	NetBSD-0_38:1.5
	NetBSD-0_37:1.5
	NetBSD-0_36:1.5
	NetBSD-0_35:1.5
	NetBSD-0_34:1.5
	NetBSD-0_33:1.5
	NetBSD-0_32:1.5
	NetBSD-0_31:1.5
	NetBSD-0_30:1.5
	NetBSD-0_29:1.5
	RO_5_07:1.5
	NetBSD-0_28:1.5
	NetBSD-0_27:1.5
	NetBSD-0_26:1.5
	NetBSD-0_25:1.4
	NetBSD-0_24:1.4
	NetBSD-0_23:1.4
	NetBSD-0_21-1_22_2_1:1.3
	NetBSD-0_22:1.4
	USB1:1.3.0.2
	NetBSD-0_21:1.3
	NetBSD-0_20:1.3
	NetBSD-0_19:1.3
	NetBSD-0_18:1.3
	NetBSD-0_17:1.3
	NetBSD-0_16:1.3
	NetBSD-0_15:1.3
	NetBSD-0_14:1.3
	NetBSD-0_13:1.3
	NetBSD-0_12:1.3
	NetBSD-0_11:1.3
	NetBSD-0_10:1.2
	NetBSD-0_09:1.2
	NetBSD-0_08:1.2
	NetBSD-0_07:1.2
	NetBSD-0_06:1.2
	NetBSD-0_05:1.2
	NetBSD-0_04:1.2
	NetBSD-0_03:1.2
	NetBSD-0_02:1.2
	NetBSD-0_01:1.1;
locks; strict;
comment	@# @;


1.10
date	2017.07.30.11.37.17;	author rool;	state dead;
branches;
next	1.9;
commitid	0fHS8wSWQgNvif1A;

1.9
date	2016.12.17.10.12.59;	author rool;	state Exp;
branches;
next	1.8;
commitid	yws6HYEy6os04kyz;

1.8
date	2014.10.25.18.43.39;	author rsprowson;	state Exp;
branches;
next	1.7;
commitid	SYXBVhhWAW5D5CVx;

1.7
date	2012.06.07.00.11.08;	author jlee;	state Exp;
branches;
next	1.6;
commitid	LkYeKFZjKWlNTH7w;

1.6
date	2010.01.30.17.37.54;	author jlee;	state Exp;
branches;
next	1.5;

1.5
date	2004.06.30.14.50.35;	author kbracey;	state Exp;
branches;
next	1.4;

1.4
date	2004.01.21.20.49.16;	author bavison;	state Exp;
branches;
next	1.3;

1.3
date	2003.04.10.14.07.18;	author kbracey;	state Exp;
branches;
next	1.2;

1.2
date	2003.01.28.10.25.50;	author dellis;	state Exp;
branches;
next	1.1;

1.1
date	2003.01.28.09.55.14;	author dellis;	state Exp;
branches;
next	;


desc
@@


1.10
log
@Remove OHCIDriver & EHCIDriver as targets
Detail:
  Makefile and !Mk* updated, and corresponding unused files put in the attic.
  Add an interim OHCIHALLib and EHCIHALLib target so that the HAL library variant still builds.
  Split messages into CmdHelp and Messages per a normal C component.
  Remove unused wsconsio/wsmousevar porting headers, no longer used.
Admin:
  Submission for USB bounty.
  Note, the version number of the resulting module will jump to match the top level VersionNum file.

Version 1.20. Tagged as 'USBDriver-1_20'
@
text
@; Copyright 2003 Tematic Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
#include "Global/RISCOS.h"
#include "Global/Services.h"
#include "../Version"

initialisation-code:	module_init

finalisation-code:  	module_final

service-call-handler:	module_services Service_ResourceFSStarting,
                                        Service_USB,
                                        Service_PreReset,
                                        Service_PCI

title-string:	    	OHCIDriver

help-string:	     	OHCIDriver  OHCIDriverModule_MajorVersion_CMHG

date-string:	    	OHCIDriverModule_Module_Date_CMHG

international-help-file: "Resources:$.Resources.OHCIDriver.Messages"

#ifdef OHCI_DEBUG
command-keyword-table:	module_commands

OHCIRegs(   min-args:0, max-args:0,
            help-text: "*OHCIRegs reads the registers from the OHCI controller\n",
            add-syntax:, invalid-syntax: "Syntax: *OHCIRegs"),

OHCIEDS(),

OHCIWrite(  min-args:2, max-args:2,
            help-text: "*OHCIWrite writes to a register in the OHCI controller.\n",
            add-syntax:, invalid-syntax: "Syntax: *OHCIWrite <offset> <value>"),

OHCIDebug(  min-args:1, max-args:2,
            help-text: "*OHCIDebug sets the debug level for debuglib output, optionally also setting the debug level for output controlled by the usbdebug variable within the ohcidriver.\n",
            add-syntax:, invalid-syntax: "Syntax: OHCIDebug <ohci> [<usb>]"),

TargetFM(   min-args:1, max-args:1,
            help-text: "*TargetFM sets the frame interval that will be targeted for phase synchronisation.\n",
            add-syntax:, invalid-syntax: "Syntax: TargetFM <n>");
#endif


;swi-chunk-base-number:	0x54ac0

;swi-handler-code:   	module_swis

;swi-decoding-table: 	OHCI_

#ifdef OHCI_DEBUG
event-handler:		vsync_entry/vsync Event_VSync
#endif

vector-handlers:    	usb_irq_entry/usb_irq_handler,
			usb_overcurrent_entry/usb_overcurrent_handler,
			softintr_entry/softintr
generic-veneers:    	callout_entry/callout_handler
@


1.9
log
@Messages fixes, internationalisation, minor clean ups
Detail:
  USBDriver was performing unnecessary messages file reopening on Service_ResourceFSStarted (MessageTrans does this itself), remove this.
  Internationalised USBDriver, in particular its *Commands.
  Fixed standalone builds to output the messages file objects in the right place (Makefile mistake).
  Changed OHCIDriver and EHCIDriver to use allocated error bases rather than 0.
  Sync'd, where possible, the OHCIDriver and EHCIDriver sources which share a common heritage. Tentative shared interrupt support fixes for non-PCI attached controllers. Comment blocks & indentation improved.
  Export min() macro in usb_port.h.
  CMHG updated to not listen for unwanted services.
Admin:
  Submission for USB bounty.
  Tested on Pandaboard and Pi 2. OHCIDriver untested but low risk.

Version 1.18. Tagged as 'NetBSD-1_18'
@
text
@@


1.8
log
@Update to use rationalised power and overcurrent API
OHCIDriver (only) had sketchy support for a HAL based scheme for controlling the port power and monitor overcurrent. However the implementation was limited to supporting the single port required for an embedded product (aka Rhenium in the CVS history). The change makes it follow a model much more akin to the HAL_TimerDevice/HAL_TimerIRQStatus/HAL_TimerIRQClear set of functions.
Version:
  Bumped OHCIDriver and USBDriver version numbers.
ohcimodule.c:
  Use some defines from OsBytes.h.
  Group the debug variables within the OHCI_DEBUG define so they go away in the release case.
  Allow for up to 15 ports to be controlled via the revised HAL API, and pass something other than a hardwired controller of 0 when controlling/monitoring power.
  Enumerate the device numbers for overcurrent monitoring on startup.
  Deal with the possibility of one (or more) of the device numbers being shared interrupts.
  Squash a few trivial compiler warnings.
ohcimodhead.cmhg:
  rename the handler/entry to reflect their use for overcurrent
ohci.c:
  Allow for up to 15 ports to be controlled by passing in the port index where needed.
usb_subr.c/usbdivar.h:
  Remove a RISC OS-ism in datatoggle, to converge with NetBSD a bit.
ehcivar.h/usb_port.h:
  Relocate the overrides for mutex_ functions here since this is the only controller using them. Previously when in "usb_port.h" they would indirectly get dragged in ia the nested include in "usb.h". The could in fact now be implemented using SyncLib, an exercise left to the reader.
usb.h
  Merge some of the device classes and other allocations from NetBSD.

While it's not been possible to test the revised API, due to not having sight of the original platform on which it was implemented, none of the actively maintained HALs currently use the HAL based power and overcurrent scheme anyway, so the new code never gets called. In that respect, it's no more broken then the previous single port-single controller version.

Version 0.89. Tagged as 'NetBSD-0_89'
@
text
@d23 1
a23 2
service-call-handler:	module_services Service_ResourceFSStarted,
                                        Service_ResourceFSStarting,
@


1.7
log
@Make RHENIUM build switch go away. Misc housekeeping
Detail:
  build/Makefile, build/!MkDebug,fd7 - Debug versions of the modules can now be built just by passing "DEBUG=TRUE" to amu
  build/!MkRhenium,fd7 - Deleted obsolete file
  build/Version - Increased version numbers
  build/c/ehcihal, build/c/ehcimodule, build/c/ohcimodule - Only accept USB controllers if HAL_USBControllerInfo says the struct size is an exact match with what we expect. Rework USB controller enumeration to allow modules to properly support both PCI and HAL controllers being available on the same machine, and without RHENIUM switch (module sources only).
  build/c/ehcimodule - Get rid of remaining RHENIUM bits; RHENIUM flag no longer needed for 32bit wide register reads/writes to be supported
  build/c/ohcimodule, build/cmhg/ohcimodhead, dev/usb/c/ohci - Get rid of remaining RHENIUM bits; RHENIUM flag no longer needed for HAL port power controls to be supported.
  build/c/usbhal, build/c/usbmodule, dev/usb/c/uhub, dev/usb/h/usb_port - Get rid of empty riscos_failed_device function
  build/s/call_veneer, build/s/triggercbs - Use Entry/EXIT macros to avoid single-reg LDM/STM performance warnings. Convert tabs to spaces.
  dev/usb/h/usb - Get rid of RHENIUM switch on USB_PORT_RESET_DELAY. Now always uses non-RHENIUM value of 100ms.
Admin:
  Tested on rev A2 BB-xM, Iyonix, Raspberry Pi


Version 0.71. Tagged as 'NetBSD-0_71'
@
text
@d71 1
a71 1
			usb_irq_port_error_entry/usb_irq_port_error_handler,
@


1.6
log
@Rework USB driver makefile & cmhg files to avoid constant rebuilds of USBDriver.h
Detail:
  Limitations in the way CMHG was being told which message file to use meant that the makefile was constructed in a way that would automatically delete usbmodhead.h/.o after they were built, to protect against OHCIDriver or EHCIDriver causing the file to be built referencing the wrong messages file.
  However since each component uses a unique messages filename, and each component has its own CMHG file, there was absolutely no need for this - all that was needed was to update the CMHG files to reference the correct messages file directly.
  ROM builds are now a minute or two faster because of this, which is quite welcome since I can often find myself doing 30+ builds a day.
Admin:
  Tested by building Tungsten ROM and diffing new modules against old; no differences detected.
  Not tagged.


Version 0.49. Not tagged
@
text
@a70 1
#ifdef RHENIUM
a71 1
#endif /*RHENIUM*/
@


1.5
log
@Latest stuff from John - mainly Rhenium improvements.

Version 0.26. Tagged as 'NetBSD-0_26'
@
text
@d35 1
a35 3
#define HELPFILE(M) "Resources:$." #M
#define XHELPFILE(M) HELPFILE(M)
international-help-file: XHELPFILE(MSGLOC)
@


1.4
log
@Merge of Dan Ellis's USB2 sources.

Version 0.22. Tagged as 'NetBSD-0_22'
@
text
@d73 3
@


1.3
log
@Fix for erratic behaviour after having unplugged hubs: TAILQ was
being given an entry which wasn't on its list, and the behaviour was to
break the list and poke a zero into the reset vector!
Also, some extra IFDEF's so that debug builds will work again.
A few typos/spelling errors changed.

Version 0.11. Tagged as 'NetBSD-0_11'
@
text
@d72 2
a73 1
vector-handlers:    	usb_irq_entry/usb_irq_handler
@


1.2
log
@Fix to interrupt hole in mouse driver.
Version number now got from Version file,not hand tweaked CMHG file.
Timer was a factor 10 out in previous version due to typo.

Version 0.02. Tagged as 'NetBSD-0_02'
@
text
@d37 1
a37 1
international-help-file: XHELPFILE(MESSAGELOCATION)
@


1.1
log
@Import of USB driver suitable for generic PCI based OHCI controllers.
Correction of spelling of busses to buses (noun plural).
OHCIdriver only responds to PCI service call to lookup vendor name when
the device is of class OHCI controller.

Version 0.01. Tagged as 'NetBSD-0_01'
@
text
@d17 1
d31 1
a31 1
help-string:	     	OHCIDriver  0.09
d33 1
a33 1
date-string:	    	24 Jan 2003
@

