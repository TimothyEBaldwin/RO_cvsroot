head	1.15;
access;
symbols
	USBDriver-1_19:1.14
	NetBSD-1_19:1.14
	NetBSD-1_18:1.14
	NetBSD-1_17:1.13
	NetBSD-1_16:1.12
	NetBSD-1_15:1.12
	NetBSD-1_14:1.12
	NetBSD-1_13:1.12
	NetBSD-1_12:1.12
	NetBSD-1_09-1:1.12
	NetBSD-1_11:1.12
	NetBSD-1_10:1.12
	NetBSD-1_09:1.12
	NetBSD-1_08:1.12
	NetBSD-1_07:1.12
	NetBSD-1_06:1.12
	NetBSD-1_05:1.12
	NetBSD-1_04:1.12
	NetBSD-1_03:1.11
	NetBSD-1_02:1.11
	NetBSD-1_01:1.11
	NetBSD-1_00:1.11
	NetBSD-0_99:1.11
	NetBSD-0_98:1.11
	NetBSD-0_97:1.11
	NetBSD-0_96:1.11
	NetBSD-0_95:1.11
	NetBSD-0_94:1.11
	NetBSD-0_93:1.11
	NetBSD-0_92:1.11
	NetBSD-0_91:1.11
	NetBSD-0_90:1.11
	NetBSD-0_89:1.11
	NetBSD-0_88:1.11
	NetBSD-0_87:1.11
	NetBSD-0_86:1.11
	NetBSD-0_85:1.11
	NetBSD-0_84:1.11
	NetBSD-0_83:1.11
	NetBSD-0_82:1.11
	NetBSD-0_81:1.11
	NetBSD-0_80:1.11
	NetBSD-0_79:1.11
	NetBSD-0_78:1.11
	NetBSD-0_77:1.11
	NetBSD-0_76:1.11
	NetBSD-0_75:1.11
	NetBSD-0_74:1.11
	NetBSD-0_73:1.11
	NetBSD-0_72:1.11
	NetBSD-0_71:1.11
	NetBSD-0_70:1.11
	NetBSD-0_69:1.11
	NetBSD-0_68:1.11
	NetBSD-0_67:1.11
	NetBSD-0_66:1.11
	NetBSD-0_65:1.11
	NetBSD-0_64:1.11
	NetBSD-0_63:1.11
	NetBSD-0_62:1.11
	NetBSD-0_61:1.11
	NetBSD-0_60:1.11
	NetBSD-0_59:1.11
	NetBSD-0_58:1.11
	NetBSD-0_57:1.11
	NetBSD-0_56:1.11
	NetBSD-0_55:1.11
	NetBSD-0_54:1.11
	NetBSD-0_53:1.11
	NetBSD-0_52:1.11
	NetBSD-0_51:1.10
	NetBSD-0_50:1.10
	NetBSD-0_49:1.9
	NetBSD-0_48:1.9
	NetBSD-0_47:1.9
	NetBSD-0_46:1.9
	NetBSD-0_45:1.9
	NetBSD-0_44:1.9
	NetBSD-0_43:1.9
	NetBSD-0_42:1.9
	NetBSD-0_41:1.9
	NetBSD-0_40:1.9
	NetBSD-0_39:1.8
	NetBSD-0_38:1.8
	NetBSD-0_37:1.8
	NetBSD-0_36:1.7
	NetBSD-0_35:1.7
	NetBSD-0_34:1.7
	NetBSD-0_33:1.7
	NetBSD-0_32:1.7
	NetBSD-0_31:1.7
	NetBSD-0_30:1.7
	NetBSD-0_29:1.7
	RO_5_07:1.7
	NetBSD-0_28:1.7
	NetBSD-0_27:1.6
	NetBSD-0_26:1.6
	NetBSD-0_25:1.5
	NetBSD-0_24:1.5
	NetBSD-0_23:1.5
	NetBSD-0_21-1_22_2_1:1.4
	NetBSD-0_22:1.5
	USB1:1.4.0.2
	NetBSD-0_21:1.4
	NetBSD-0_20:1.4
	NetBSD-0_19:1.4
	NetBSD-0_18:1.4
	NetBSD-0_17:1.4
	NetBSD-0_16:1.4
	NetBSD-0_15:1.4
	NetBSD-0_14:1.4
	NetBSD-0_13:1.4
	NetBSD-0_12:1.4
	NetBSD-0_11:1.4
	NetBSD-0_10:1.3
	NetBSD-0_09:1.3
	NetBSD-0_08:1.3
	NetBSD-0_07:1.2
	NetBSD-0_06:1.2
	NetBSD-0_05:1.2
	NetBSD-0_04:1.2
	NetBSD-0_03:1.2
	NetBSD-0_02:1.2
	NetBSD-0_01:1.1;
locks; strict;
comment	@# @;


1.15
date	2017.07.30.11.37.17;	author rool;	state dead;
branches;
next	1.14;
commitid	0fHS8wSWQgNvif1A;

1.14
date	2016.12.17.10.12.59;	author rool;	state Exp;
branches;
next	1.13;
commitid	yws6HYEy6os04kyz;

1.13
date	2016.12.10.12.54.26;	author rool;	state Exp;
branches;
next	1.12;
commitid	zPShgPr6RkVlbrxz;

1.12
date	2015.09.28.19.53.49;	author rsprowson;	state Exp;
branches;
next	1.11;
commitid	uzkkBixTPwO3C3Dy;

1.11
date	2010.07.21.23.57.12;	author jlee;	state Exp;
branches;
next	1.10;

1.10
date	2010.01.30.17.37.54;	author jlee;	state Exp;
branches;
next	1.9;

1.9
date	2005.05.18.11.54.03;	author jballance;	state Exp;
branches;
next	1.8;

1.8
date	2005.02.24.14.02.55;	author jballance;	state Exp;
branches;
next	1.7;

1.7
date	2004.08.12.14.47.39;	author jballance;	state Exp;
branches;
next	1.6;

1.6
date	2004.06.30.14.50.35;	author kbracey;	state Exp;
branches;
next	1.5;

1.5
date	2004.01.21.20.49.16;	author bavison;	state Exp;
branches;
next	1.4;

1.4
date	2003.04.10.14.07.18;	author kbracey;	state Exp;
branches;
next	1.3;

1.3
date	2003.03.02.17.05.51;	author rsprowson;	state Exp;
branches;
next	1.2;

1.2
date	2003.01.28.10.25.51;	author dellis;	state Exp;
branches;
next	1.1;

1.1
date	2003.01.28.09.55.14;	author dellis;	state Exp;
branches;
next	;


desc
@@


1.15
log
@Remove OHCIDriver & EHCIDriver as targets
Detail:
  Makefile and !Mk* updated, and corresponding unused files put in the attic.
  Add an interim OHCIHALLib and EHCIHALLib target so that the HAL library variant still builds.
  Split messages into CmdHelp and Messages per a normal C component.
  Remove unused wsconsio/wsmousevar porting headers, no longer used.
Admin:
  Submission for USB bounty.
  Note, the version number of the resulting module will jump to match the top level VersionNum file.

Version 1.20. Tagged as 'USBDriver-1_20'
@
text
@; Copyright 2003 Tematic Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
#include "Global/Services.h"
#include "../Version"

initialisation-code:	module_init

finalisation-code:  	module_final

service-call-handler:	module_services	Service_ResourceFSStarting,
					Service_DeviceFSStarting,
					Service_DeviceFSDying,
					Service_USB,
					Service_PreReset
title-string:	    	USBDriver

help-string:	     	USBDriver  USBDriverModule_MajorVersion_CMHG

date-string:	    	USBDriverModule_Module_Date_CMHG

international-help-file: "Resources:$.Resources.USBDriver.Messages"

command-keyword-table:	module_commands

#ifdef USB_DEBUG
USBDebug(       min-args:1, max-args:3,
                help-text:     "*USBDebug sets the debug level for general usb, hub and mouse output.",
                invalid-syntax:"*USBDebug <usb> [<hub> [<mouse>]]"),
#endif

USBBuses(       min-args:0, max-args:0,
                international:,help-text:"HUSBBUS",invalid-syntax:"SUSBBUS"),

USBDevices(     min-args:0, max-args:0,
                international:,help-text:"HUSBDEV",invalid-syntax:"SUSBDEV"),

USBDevInfo(     min-args:1, max-args:1,
                international:,help-text:"HUSBDIN",invalid-syntax:"SUSBDIN"),

USBConfInfo(    min-args:1, max-args:1,
                international:,help-text:"HUSBCIN",invalid-syntax:"SUSBCIN"),

USBSetConfig(   min-args:2, max-args:2,
                international:,help-text:"HUSBCON",invalid-syntax:"SUSBCON"),

USBSetInterface(min-args:3, max-args:3,
                international:,help-text:"HUSBINT",invalid-syntax:"SUSBINT"),

#ifdef USB_DEBUG
USBDiscover(    min-args:0, max-args:0,
                help-text:     "*USBDiscover forces a search for new devices on all buses.",
                invalid-syntax:"Syntax: *USBDiscover"),
#endif

USBReset(       min-args:1, max-args:1,
                international:,help-text:"HUSBRES",invalid-syntax:"SUSBRES"),

USBQuirk(       min-args:1, max-args:5,
                international:,help-text:"HUSBQRK",invalid-syntax:"SUSBQRK")

swi-chunk-base-number:	0x54a40

swi-handler-code:   	module_swis

swi-decoding-table: 	USBDriver,
                        RegisterBus,
                        DeregisterBus,
                        InsertTransfer,
                        TransferComplete,
                        ScheduleSoftInterrupt,
                        Version


generic-veneers:        driver_entry/driver

vector-handlers:        pointerv_entry/pointerv,
			keyv_entry/keyv,
			softintr_entry/softintr
@


1.14
log
@Messages fixes, internationalisation, minor clean ups
Detail:
  USBDriver was performing unnecessary messages file reopening on Service_ResourceFSStarted (MessageTrans does this itself), remove this.
  Internationalised USBDriver, in particular its *Commands.
  Fixed standalone builds to output the messages file objects in the right place (Makefile mistake).
  Changed OHCIDriver and EHCIDriver to use allocated error bases rather than 0.
  Sync'd, where possible, the OHCIDriver and EHCIDriver sources which share a common heritage. Tentative shared interrupt support fixes for non-PCI attached controllers. Comment blocks & indentation improved.
  Export min() macro in usb_port.h.
  CMHG updated to not listen for unwanted services.
Admin:
  Submission for USB bounty.
  Tested on Pandaboard and Pi 2. OHCIDriver untested but low risk.

Version 1.18. Tagged as 'NetBSD-1_18'
@
text
@@


1.13
log
@Case change to match documentation
Detail:
  DeRegisterBus->DeregisterBus. Since clients calling this SWI are compiled C or assembler, this doesn't affect existing modules which remain binary compatible.
Admin:
  Submission for USB bounty.

Version 1.17. Tagged as 'NetBSD-1_17'
@
text
@d22 1
a22 2
service-call-handler:	module_services	Service_ResourceFSStarted,
					Service_ResourceFSStarting,
@


1.12
log
@Internationalisation, help, and syntax improvments
Assign a proper error number and translate "Incompatible USBDriver version".
Don't bother internationalising the *commands which are for debug builds only.
Rephrase the help for USBQuirk so it makes sense, and trim the unmatched '<' from the syntax example.
Bracket the USBDiscover help with the same switch that governs the code, which has been disabled for over a decade.

Version 1.04. Tagged as 'NetBSD-1_04'
@
text
@d80 1
a80 1
                        DeRegisterBus,
@


1.11
log
@Update EHCI driver to NetBSD latest (as of 10/07/2010), improve DeviceFS interface
Detail:
  EHCI driver update:
    dev/usb/c/ehci - Updated to latest NetBSD version, except for revisions 1.134 and 1.135 which are too invasive to merge in without updating the rest of the USB stack. This new version brings lots of bug fixes, and adds (untested on RISC OS) support for EHCI isochronous transfers.
    dev/usb/h/ehcivar - Updated to latest NetBSD version, except for the sc_bus splitting that was held back from the ehci.c update
    dev/usb/h/usb, dev/usb/h/usbdi, dev/usb/usbdivar - partial update to latest as required/possible
    dev/usb/c/usb_quirks, dev/usb/h/ehcireg, dev/usb/h/usb_mem, dev/usb/h/usb_quirks, dev/usb/h/usbhid, dev/usb/usbdevs, dev/usb/devlist2h.awk, dev/wscons/h/wsconsio, dev/wscons/h/wsmousevar - Updated to latest NetBSD versions
    dev/usb/c/usbroothub_subr, dev/usb/h/usbroothub_subr - New files brought in from NetBSD sources for use with new EHCI driver
    build/objehcidriver - Added usbroorhub_subr to EHCI driver
    dev/usb/h/usb_port - Added extra dummy functions as required by new EHCI driver
    dev/build/c/port - Added extra parameter to callout_init as required by new EHCI driver
  DeviceFS improvements:
    build/c/usbmodule - Added DeviceFSCallDevice_GetHandles2 as a replacement for Thomas Milius's backwards-incompatible GetHandles changes. Added DeviceFSCallDevice_GetSetOptions call to control RX padding and TX force-short-xfer features. These features can also be controlled at endpoint creation time by new fields in the filename. Also fixed packet padding to not fill the buffer with garbage or potentially crash when the padded area is more than one packet in length.
  New bus registration API:
    Changes made to the data structures that are shared between the modules means that new checks are needed to ensure USB modules with incompatible APIs are not used with one another.
    build/h/usbdivar - Since this seems to be the file containing the main structures that are shared, it now has a #define at the top indicating the first version of the USBDriver module that implemented the data structures within. This version number is used to check that the driver modules are compatible.
    build/cmhg/usbmodhead, build/h/usbdriver, build/c/usbmodule - Add a new SWI, USBDriver_Version, to return the version number of the USBDriver module. Used for both intra-stack API version checks and can be useful for external code that wants to query DeviceFS feature availability.
    build/c/usbmodule, build/c/ehcimodule, build/c/ohcimodule - Updated USBDriver_RegisterBus SWI and the code that calls it to pass the API version number (as defined in usbdivar.h) to USBDriver when attempting to reigster the bus. USBDriver then ensures the version matches that of itself, and if not refuses to allow the bus to register. EHCI & OHCI modules also check that USBDriver is new enough to implement this behaviour via the USBDriver_Version SWI.
  And finally:
    build/version - Incremented module version numbers.
    build/doc/usb - Updated with details of new features
Admin:
  Tested in ROM softload on Iyonix & beagleboard. Beagleboard hub issues seem to be resolved, and there are no new bugs that I can see.


Version 0.52. Tagged as 'NetBSD-0_52'
@
text
@d40 2
a41 1
                international:,help-text:"HUSBDBG",invalid-syntax:"SUSBDBG"),
d62 1
a62 1
;#ifdef USB_DEBUG
d64 3
a66 2
                international:,help-text:"HUSBDIS",invalid-syntax:"SUSBDIS"),
;#endif
@


1.10
log
@Rework USB driver makefile & cmhg files to avoid constant rebuilds of USBDriver.h
Detail:
  Limitations in the way CMHG was being told which message file to use meant that the makefile was constructed in a way that would automatically delete usbmodhead.h/.o after they were built, to protect against OHCIDriver or EHCIDriver causing the file to be built referencing the wrong messages file.
  However since each component uses a unique messages filename, and each component has its own CMHG file, there was absolutely no need for this - all that was needed was to update the CMHG files to reference the correct messages file directly.
  ROM builds are now a minute or two faster because of this, which is quite welcome since I can often find myself doing 30+ builds a day.
Admin:
  Tested by building Tungsten ROM and diffing new modules against old; no differences detected.
  Not tagged.


Version 0.49. Not tagged
@
text
@d81 2
a82 37
                        ScheduleSoftInterrupt
;                        IOCtl,
;                        OpenPipe,
;                        ClosePipe,
;                        Transfer,
;                        AllocXfer,
;                        FreeXfer,
;                        SetupXfer,
;                        SetupDefaultXfer,
;                        SetupIsocXfer,
;                        GetXferStatus,
;                        Interface2EndpointDescriptor,
;                        AbortPipe,
;                        ClearEndpointStall,
;                        ClearEndpointStallAsync,
;                        EndpointCount,
;                        Interface2DeviceHandle,
;                        Device2InterfaceHandle,
;                        Pipe2DeviceHandle,
;                        AllocBuffer,
;                        Freebuffer,
;                        GetBuffer,
;                        SyncTransfer,
;                        OpenPipeIntr,
;                        DoRequest,
;                        DoRequestAsync,
;                        DoRequestFlags,
;                        GetInterfaceDescriptor,
;                        GetConfigDescriptor,
;                        SetInterface,
;                        FillDeviceInfo,
;                        GetInterfaceAltindex,
;                        FindIdesc,
;                        FindEdesc,
;                        DevInfo,
;                        GetEndpointDescriptor,
;                        ReloadDeviceDesc
@


1.9
log
@	several changes and nullpointer bug fixes
Detail:
	Includes several bug fixes and null pointer traps.
	Rhenium version reviewed and reset should be improved.
Admin:
	Tested in rhenium desktop build and iyonix build at castle
   	Castle added IP


Version 0.40. Tagged as 'NetBSD-0_40'
@
text
@d34 1
a34 3
#define HELPFILE(M) "Resources:$." #M
#define XHELPFILE(M) HELPFILE(M)
international-help-file: XHELPFILE(MSGLOC)
@


1.8
log
@        2 specific changes to USBDriver module
        Added (and fixed code underlying) to give periodic
        explore of USB busses (cf NetBSD).
        Added USBDisover command to let user provoke this too.
        Reworked USB device number allocation to roll
        around at 999 to avoid field overflow in
        a number of places.
Detail:
Admin:  castle added IP. to be beta tested on beta test site


Version 0.37. Tagged as 'NetBSD-0_37'
@
text
@d26 2
a27 1
					Service_USB
@


1.7
log
@  Extensive changes and bug fixes to usb and ohci ..
  'blocked' several holes that could cause freezes with awkward
  usb devices.  Added latest changes from Dan Ellis too , especially for USB2
Detail:
 many
Admin:
 Tested in ROM at Castle, and beta tested with users


Version 0.28. Tagged as 'NetBSD-0_28'
@
text
@d62 1
a62 1
#ifdef USB_DEBUG
d65 1
a65 1
#endif
@


1.6
log
@Latest stuff from John - mainly Rhenium improvements.

Version 0.26. Tagged as 'NetBSD-0_26'
@
text
@d24 2
a25 1
					Service_PCI,
d68 1
a68 1
                international:,help-text:"HUSBRES",invalid-syntax:"SUSBRES")
d70 2
@


1.5
log
@Merge of Dan Ellis's USB2 sources.

Version 0.22. Tagged as 'NetBSD-0_22'
@
text
@a25 1

@


1.4
log
@Fix for erratic behaviour after having unplugged hubs: TAILQ was
being given an entry which wasn't on its list, and the behaviour was to
break the list and poke a zero into the reset vector!
Also, some extra IFDEF's so that debug builds will work again.
A few typos/spelling errors changed.

Version 0.11. Tagged as 'NetBSD-0_11'
@
text
@d79 2
a80 1
                        TransferComplete
d122 2
a123 1
			keyv_entry/keyv
@


1.3
log
@Found a "busses" lingering in the messages file,also removed a \n which
must have been copied from a printf somewhere.
Old service call detail removed from c.port as it's defined in another
file differently!
USBDiscover is now only available for debugging purposes.
Internationalised the mouse name (default is still "USB mouse").

Version 0.08. Tagged as 'NetBSD-0_08'
@
text
@d35 1
a35 1
international-help-file: XHELPFILE(MESSAGELOCATION)
@


1.2
log
@Fix to interrupt hole in mouse driver.
Version number now got from Version file,not hand tweaked CMHG file.
Timer was a factor 10 out in previous version due to typo.

Version 0.02. Tagged as 'NetBSD-0_02'
@
text
@d62 1
d65 1
@


1.1
log
@Import of USB driver suitable for generic PCI based OHCI controllers.
Correction of spelling of busses to buses (noun plural).
OHCIdriver only responds to PCI service call to lookup vendor name when
the device is of class OHCI controller.

Version 0.01. Tagged as 'NetBSD-0_01'
@
text
@d16 2
d29 1
a29 1
help-string:	     	USBDriver  0.14
d31 1
a31 1
date-string:	    	24 Jan 2003
@

